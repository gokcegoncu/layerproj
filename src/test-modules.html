<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
        }
        #map { width: 100%; height: 400px; background: #f0f0f0; margin: 20px 0; }
        .log { background: #2d2d2d; padding: 10px; margin: 5px 0; border-left: 3px solid #00ff00; }
        .error { border-left-color: #ff0000; color: #ff0000; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <h1>🧪 Module Loading Test</h1>
    <div id="logs"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4/2.9.2/proj4.js"></script>
    <script src="https://unpkg.com/proj4leaflet@1.0.2/dist/proj4leaflet.js"></script>

    <script type="module">
        const logsDiv = document.getElementById('logs');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'log error' : 'log';
            div.textContent = `[${new Date().toTimeString().split(' ')[0]}] ${message}`;
            logsDiv.appendChild(div);
            console.log(message);
        }

        async function testModuleLoading() {
            try {
                log('🚀 Starting module test...');

                // Test 1: Check external libraries
                log('✅ Test 1: Leaflet loaded: ' + (typeof L !== 'undefined'));
                log('✅ Test 1: Leaflet.Draw loaded: ' + (typeof L.Draw !== 'undefined'));
                log('✅ Test 1: proj4 loaded: ' + (typeof proj4 !== 'undefined'));

                // Test 2: Try importing config module
                log('🔄 Test 2: Importing config module...');
                try {
                    const { CONFIG } = await import('/modules/core/config.js');
                    log('✅ Test 2: Config module loaded successfully');
                } catch (e) {
                    log(`❌ Test 2: Config module failed: ${e.message}`, true);
                }

                // Test 3: Try importing map module
                log('🔄 Test 3: Importing map module...');
                try {
                    const { initializeMap } = await import('/modules/core/map.js');
                    log('✅ Test 3: Map module loaded successfully');

                    // Try initializing map
                    log('🗺️ Test 3: Initializing map...');
                    const map = initializeMap('map');
                    log('✅ Test 3: Map initialized!');
                } catch (e) {
                    log(`❌ Test 3: Map module failed: ${e.message}`, true);
                }

                // Test 4: Try importing database module (THE SUSPECTED CULPRIT)
                log('🔄 Test 4: Importing database module...');
                try {
                    const DB = await import('/modules/storage/database.js');
                    log('✅ Test 4: Database module imported successfully');

                    // Try initializing database
                    log('🗄️ Test 4: Initializing database...');
                    await DB.initDatabase();
                    log('✅ Test 4: Database initialized!');
                } catch (e) {
                    log(`❌ Test 4: Database failed: ${e.message}`, true);
                    log(`Stack: ${e.stack}`, true);
                }

                // Test 5: Try importing main.js
                log('🔄 Test 5: Importing main.js...');
                try {
                    await import('/main.js');
                    log('✅ Test 5: Main.js loaded successfully');
                } catch (e) {
                    log(`❌ Test 5: Main.js failed: ${e.message}`, true);
                }

                log('✅ All tests completed!');

            } catch (error) {
                log(`❌ Fatal error: ${error.message}`, true);
                console.error(error);
            }
        }

        // Wait for libraries then run tests
        function waitForLibraries() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.L && window.L.Draw && window.proj4) {
                        resolve();
                    } else {
                        setTimeout(check, 50);
                    }
                };
                check();
            });
        }

        waitForLibraries().then(() => {
            log('✅ External libraries ready');
            testModuleLoading();
        });
    </script>
</body>
</html>
