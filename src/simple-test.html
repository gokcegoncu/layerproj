<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple App Test</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/styles/main.css">

  <style>
    #console {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: #00ff00;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 10000;
      border: 2px solid #00ff00;
    }
    .log { margin: 2px 0; }
    .error { color: #ff0000; }
  </style>
</head>
<body>
    <div id="console"></div>
    <div class="main-container">
        <div class="layer-panel">
            <div class="panel-header">
                <h2>🗺️ Simple Test (No Database)</h2>
            </div>
            <div class="create-buttons">
                <button onclick="testMap()">Test Map</button>
                <button onclick="testDrawing()">Test Drawing</button>
                <button onclick="createDemoData()">🎲 Create Demo Data</button>
                <button onclick="createHeatmap()">🔥 Create Heatmap</button>
                <button onclick="removeHeatmap()">❌ Remove Heatmap</button>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-group">
                <button id="markerBtn" class="tool-btn" title="Nokta">📍</button>
                <button id="polylineBtn" class="tool-btn" title="Çizgi">📏</button>
                <button id="polygonBtn" class="tool-btn" title="Poligon">▭</button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4/2.9.2/proj4.js"></script>
    <script src="https://unpkg.com/proj4leaflet@1.0.2/dist/proj4leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script type="module">
        const consoleDiv = document.getElementById('console');

        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'log error' : 'log';
            div.textContent = `[${new Date().toTimeString().split(' ')[0]}] ${msg}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        async function initApp() {
            try {
                log('🚀 Starting simple test app...');

                // Wait for libraries
                await new Promise((resolve) => {
                    const check = () => {
                        if (window.L && window.L.Draw && window.proj4) {
                            resolve();
                        } else {
                            setTimeout(check, 50);
                        }
                    };
                    check();
                });
                log('✅ External libraries loaded');

                // Import core modules (without database)
                log('📦 Importing core modules...');
                const { initializeMap, createDrawnItemsLayer } = await import('/modules/core/map.js');
                log('✅ Core modules loaded');

                // Initialize map
                log('🗺️ Initializing map...');
                window.map = initializeMap('map');
                window.drawnItems = createDrawnItemsLayer(window.map);
                log('✅ Map initialized');

                // Setup draw control
                log('✏️ Setting up drawing controls...');
                window.drawControl = new L.Control.Draw({
                    draw: {
                        polyline: true,
                        polygon: true,
                        marker: true,
                        rectangle: true,
                        circle: true,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: window.drawnItems,
                        remove: true
                    }
                });
                window.map.addControl(window.drawControl);
                log('✅ Drawing controls ready');

                // Setup draw events
                window.map.on(L.Draw.Event.CREATED, function (event) {
                    const layer = event.layer;
                    window.drawnItems.addLayer(layer);
                    log(`✅ Feature created: ${event.layerType}`);
                });

                log('✅✅✅ Application initialized successfully! ✅✅✅');
                log('Map should be visible below');

            } catch (error) {
                log(`❌ ERROR: ${error.message}`, true);
                log(`Stack: ${error.stack}`, true);
                console.error(error);
            }
        }

        window.testMap = () => {
            if (window.map) {
                log('✅ Map exists!');
                log(`Zoom: ${window.map.getZoom()}, Center: ${window.map.getCenter()}`);
                window.map.setView([39.9334, 32.8597], 8);
            } else {
                log('❌ Map not initialized', true);
            }
        };

        window.testDrawing = () => {
            if (window.drawControl) {
                log('✅ Draw control exists!');
                const markerTool = window.drawControl._toolbars.draw._modes.marker;
                if (markerTool && markerTool.handler) {
                    markerTool.handler.enable();
                    log('✅ Marker drawing enabled');
                } else {
                    log('❌ Marker tool not found', true);
                }
            } else {
                log('❌ Draw control not initialized', true);
            }
        };

        // Demo data storage
        window.demoPoints = [];
        window.heatmapLayer = null;

        window.createDemoData = () => {
            log('🎲 Creating demo data...');

            // Clear existing demo points
            window.demoPoints = [];
            window.drawnItems.clearLayers();

            // Ankara center
            const center = [39.9334, 32.8597];
            const pointCount = 50;

            // Create random points around Ankara
            for (let i = 0; i < pointCount; i++) {
                // Random offset (about 0.1 degrees = ~11km)
                const lat = center[0] + (Math.random() - 0.5) * 0.2;
                const lng = center[1] + (Math.random() - 0.5) * 0.2;

                // Random value (1-100)
                const value = Math.floor(Math.random() * 100) + 1;

                // Create marker
                const marker = L.circleMarker([lat, lng], {
                    radius: 6,
                    fillColor: '#3388ff',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.6
                });

                // Add to map
                marker.addTo(window.drawnItems);

                // Bind popup with value
                marker.bindPopup(`Value: ${value}`);

                // Store point data
                window.demoPoints.push({
                    lat: lat,
                    lng: lng,
                    value: value,
                    marker: marker
                });
            }

            // Zoom to bounds
            if (window.drawnItems.getLayers().length > 0) {
                window.map.fitBounds(window.drawnItems.getBounds(), { padding: [50, 50] });
            }

            log(`✅ Created ${pointCount} demo points with random values (1-100)`);
            log('📊 Min value: ' + Math.min(...window.demoPoints.map(p => p.value)));
            log('📊 Max value: ' + Math.max(...window.demoPoints.map(p => p.value)));
        };

        window.createHeatmap = () => {
            if (window.demoPoints.length === 0) {
                log('❌ No demo data! Click "Create Demo Data" first.', true);
                return;
            }

            log('🔥 Creating heatmap...');

            // Remove old heatmap
            if (window.heatmapLayer) {
                window.map.removeLayer(window.heatmapLayer);
                log('🗑️ Removed old heatmap');
            }

            // Check if leaflet.heat is loaded
            if (typeof L.heatLayer === 'undefined') {
                log('❌ Leaflet.heat not loaded!', true);
                return;
            }

            // Prepare data: [lat, lng, intensity]
            const heatData = window.demoPoints.map(p => [p.lat, p.lng, p.value]);

            log(`📊 Heatmap data prepared: ${heatData.length} points`);

            // Create heatmap
            window.heatmapLayer = L.heatLayer(heatData, {
                radius: 40,
                blur: 30,
                maxZoom: 17,
                max: Math.max(...window.demoPoints.map(p => p.value)),
                gradient: {
                    0.0: 'blue',
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'
                }
            });

            // Add to map
            window.heatmapLayer.addTo(window.map);

            log('✅ Heatmap created successfully!');
            log('🔥 Radius: 40px, Blur: 30px');
            log('🌈 Gradient: Blue → Cyan → Lime → Yellow → Orange → Red');
        };

        window.removeHeatmap = () => {
            if (window.heatmapLayer) {
                window.map.removeLayer(window.heatmapLayer);
                window.heatmapLayer = null;
                log('✅ Heatmap removed');
            } else {
                log('⚠️ No heatmap to remove');
            }
        };

        // Start the app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
