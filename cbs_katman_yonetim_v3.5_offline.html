<!DOCTYPE html>
<!--
    CBS Katman Yönetim Sistemi - Production v3.5 (Offline Edition)

    Production-Ready Version - Standalone (No Internet Required)
    Build Date: 2025-10-25

    Offline Edition Features:
    📦 All dependencies embedded (Leaflet, Leaflet Draw, Proj4js)
    🚀 Works completely offline - no CDN required
    💾 Single file: 832KB (includes all libraries)
    ✅ Same functionality as online version

    Changelog v3.5:
    🧹 Code cleanup: Removed 211 lines of duplicate functions
    ✨ Eliminated duplicate: showToast (3→1), deleteLayer (3→1), toggleEditMode (2→1)
    ✨ Eliminated duplicate: toggleDeleteMode (2→1), clearAllSelections (2→1), toggleLayerFilter (2→1)
    ✨ Eliminated duplicate: startDrawing (2→1), applyStyle (2→1)
    🎯 Improved code maintainability and reduced file size by ~2%
    ⚡ Enhanced clearAllSelections with drawing mode protection
    ✅ Cleaner, more efficient codebase

    Changelog v3.4:
    🎨 Fixed demo data to use neutral colors initially
    🎯 Demo objects now start with blue (#3388ff) color
    ✨ Thematic coloring buttons now show visible color changes
    🔥 Improved user experience for testing thematic visualizations
    ✅ Ready for quantile, category, and heatmap testing

    Changelog v3.3:
    🆕 Demo data generation system (4 types)
    🆕 Thematic mapping features (quantile, category, heatmap)
    🆕 Interactive demo menu with purple styling
    🆕 Population, income, category, temperature demo datasets
    🎨 Automatic color schemes based on data values
    🎨 Category-based coloring system
    🔥 Heatmap style visualization
    ✅ Test and visualization ready

    Changelog v3.2:
    🆕 Smart label collision avoidance system
    🆕 Edge labels for polylines and polygons (distance markers)
    🆕 Improved label readability with better positioning
    🆕 Automatic label hiding when overlapping
    ✅ Enhanced visual clarity for complex geometries

    Changelog v3.1:
    ✅ Fixed CSS indentation errors (lines 2205, 2584)
    ✅ Added input sanitization to prevent XSS attacks
    ✅ Added input validation for layer/group names
    ✅ Enhanced security with validateName() and sanitizeInput()
    ✅ Improved code quality and error handling
    ✅ All critical bugs from investigation report resolved

    Features:
    - Full GIS layer management system
    - Dark theme support with CSS variables
    - Responsive design (desktop, tablet, mobile)
    - Proj4 coordinate transformation support
    - Measurement tools (distance, area)
    - Drawing tools (point, line, polygon, rectangle, circle)
    - Legend and message console
    - Drag & drop layer organization
    - Advanced accessibility (ARIA attributes)

    Security:
    - XSS protection via input sanitization
    - Input validation (max 100 chars, dangerous pattern detection)
    - Safe innerHTML usage with sanitized content

    Dependencies:
    - Leaflet 1.9.4 (mapping library)
    - Leaflet Draw 1.0.4 (drawing tools)
    - Proj4js 2.8.0 (coordinate transformations)
-->
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBS Katman Yönetim Sistemi - Production v3.5 (Offline)</title>
    <style>
        /* Leaflet CSS - Embedded */
/* required styles */

.leaflet-pane,
.leaflet-tile,
.leaflet-marker-icon,
.leaflet-marker-shadow,
.leaflet-tile-container,
.leaflet-pane > svg,
.leaflet-pane > canvas,
.leaflet-zoom-box,
.leaflet-image-layer,
.leaflet-layer {
	position: absolute;
	left: 0;
	top: 0;
	}
.leaflet-container {
	overflow: hidden;
	}
.leaflet-tile,
.leaflet-marker-icon,
.leaflet-marker-shadow {
	-webkit-user-select: none;
	   -moz-user-select: none;
	        user-select: none;
	  -webkit-user-drag: none;
	}
/* Prevents IE11 from highlighting tiles in blue */
.leaflet-tile::selection {
	background: transparent;
}
/* Safari renders non-retina tile on retina better with this, but Chrome is worse */
.leaflet-safari .leaflet-tile {
	image-rendering: -webkit-optimize-contrast;
	}
/* hack that prevents hw layers "stretching" when loading new tiles */
.leaflet-safari .leaflet-tile-container {
	width: 1600px;
	height: 1600px;
	-webkit-transform-origin: 0 0;
	}
.leaflet-marker-icon,
.leaflet-marker-shadow {
	display: block;
	}
/* .leaflet-container svg: reset svg max-width decleration shipped in Joomla! (joomla.org) 3.x */
/* .leaflet-container img: map is broken in FF if you have max-width: 100% on tiles */
.leaflet-container .leaflet-overlay-pane svg {
	max-width: none !important;
	max-height: none !important;
	}
.leaflet-container .leaflet-marker-pane img,
.leaflet-container .leaflet-shadow-pane img,
.leaflet-container .leaflet-tile-pane img,
.leaflet-container img.leaflet-image-layer,
.leaflet-container .leaflet-tile {
	max-width: none !important;
	max-height: none !important;
	width: auto;
	padding: 0;
	}

.leaflet-container img.leaflet-tile {
	/* See: https://bugs.chromium.org/p/chromium/issues/detail?id=600120 */
	mix-blend-mode: plus-lighter;
}

.leaflet-container.leaflet-touch-zoom {
	-ms-touch-action: pan-x pan-y;
	touch-action: pan-x pan-y;
	}
.leaflet-container.leaflet-touch-drag {
	-ms-touch-action: pinch-zoom;
	/* Fallback for FF which doesn't support pinch-zoom */
	touch-action: none;
	touch-action: pinch-zoom;
}
.leaflet-container.leaflet-touch-drag.leaflet-touch-zoom {
	-ms-touch-action: none;
	touch-action: none;
}
.leaflet-container {
	-webkit-tap-highlight-color: transparent;
}
.leaflet-container a {
	-webkit-tap-highlight-color: rgba(51, 181, 229, 0.4);
}
.leaflet-tile {
	filter: inherit;
	visibility: hidden;
	}
.leaflet-tile-loaded {
	visibility: inherit;
	}
.leaflet-zoom-box {
	width: 0;
	height: 0;
	-moz-box-sizing: border-box;
	     box-sizing: border-box;
	z-index: 800;
	}
/* workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=888319 */
.leaflet-overlay-pane svg {
	-moz-user-select: none;
	}

.leaflet-pane         { z-index: 400; }

.leaflet-tile-pane    { z-index: 200; }
.leaflet-overlay-pane { z-index: 400; }
.leaflet-shadow-pane  { z-index: 500; }
.leaflet-marker-pane  { z-index: 600; }
.leaflet-tooltip-pane   { z-index: 650; }
.leaflet-popup-pane   { z-index: 700; }

.leaflet-map-pane canvas { z-index: 100; }
.leaflet-map-pane svg    { z-index: 200; }

.leaflet-vml-shape {
	width: 1px;
	height: 1px;
	}
.lvml {
	behavior: url(#default#VML);
	display: inline-block;
	position: absolute;
	}


/* control positioning */

.leaflet-control {
	position: relative;
	z-index: 800;
	pointer-events: visiblePainted; /* IE 9-10 doesn't have auto */
	pointer-events: auto;
	}
.leaflet-top,
.leaflet-bottom {
	position: absolute;
	z-index: 1000;
	pointer-events: none;
	}
.leaflet-top {
	top: 0;
	}
.leaflet-right {
	right: 0;
	}
.leaflet-bottom {
	bottom: 0;
	}
.leaflet-left {
	left: 0;
	}
.leaflet-control {
	float: left;
	clear: both;
	}
.leaflet-right .leaflet-control {
	float: right;
	}
.leaflet-top .leaflet-control {
	margin-top: 10px;
	}
.leaflet-bottom .leaflet-control {
	margin-bottom: 10px;
	}
.leaflet-left .leaflet-control {
	margin-left: 10px;
	}
.leaflet-right .leaflet-control {
	margin-right: 10px;
	}


/* zoom and fade animations */

.leaflet-fade-anim .leaflet-popup {
	opacity: 0;
	-webkit-transition: opacity 0.2s linear;
	   -moz-transition: opacity 0.2s linear;
	        transition: opacity 0.2s linear;
	}
.leaflet-fade-anim .leaflet-map-pane .leaflet-popup {
	opacity: 1;
	}
.leaflet-zoom-animated {
	-webkit-transform-origin: 0 0;
	    -ms-transform-origin: 0 0;
	        transform-origin: 0 0;
	}
svg.leaflet-zoom-animated {
	will-change: transform;
}

.leaflet-zoom-anim .leaflet-zoom-animated {
	-webkit-transition: -webkit-transform 0.25s cubic-bezier(0,0,0.25,1);
	   -moz-transition:    -moz-transform 0.25s cubic-bezier(0,0,0.25,1);
	        transition:         transform 0.25s cubic-bezier(0,0,0.25,1);
	}
.leaflet-zoom-anim .leaflet-tile,
.leaflet-pan-anim .leaflet-tile {
	-webkit-transition: none;
	   -moz-transition: none;
	        transition: none;
	}

.leaflet-zoom-anim .leaflet-zoom-hide {
	visibility: hidden;
	}


/* cursors */

.leaflet-interactive {
	cursor: pointer;
	}
.leaflet-grab {
	cursor: -webkit-grab;
	cursor:    -moz-grab;
	cursor:         grab;
	}
.leaflet-crosshair,
.leaflet-crosshair .leaflet-interactive {
	cursor: crosshair;
	}
.leaflet-popup-pane,
.leaflet-control {
	cursor: auto;
	}
.leaflet-dragging .leaflet-grab,
.leaflet-dragging .leaflet-grab .leaflet-interactive,
.leaflet-dragging .leaflet-marker-draggable {
	cursor: move;
	cursor: -webkit-grabbing;
	cursor:    -moz-grabbing;
	cursor:         grabbing;
	}

/* marker & overlays interactivity */
.leaflet-marker-icon,
.leaflet-marker-shadow,
.leaflet-image-layer,
.leaflet-pane > svg path,
.leaflet-tile-container {
	pointer-events: none;
	}

.leaflet-marker-icon.leaflet-interactive,
.leaflet-image-layer.leaflet-interactive,
.leaflet-pane > svg path.leaflet-interactive,
svg.leaflet-image-layer.leaflet-interactive path {
	pointer-events: visiblePainted; /* IE 9-10 doesn't have auto */
	pointer-events: auto;
	}

/* visual tweaks */

.leaflet-container {
	background: #ddd;
	outline-offset: 1px;
	}
.leaflet-container a {
	color: #0078A8;
	}
.leaflet-zoom-box {
	border: 2px dotted #38f;
	background: rgba(255,255,255,0.5);
	}


/* general typography */
.leaflet-container {
	font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
	font-size: 12px;
	font-size: 0.75rem;
	line-height: 1.5;
	}


/* general toolbar styles */

.leaflet-bar {
	box-shadow: 0 1px 5px rgba(0,0,0,0.65);
	border-radius: 4px;
	}
.leaflet-bar a {
	background-color: #fff;
	border-bottom: 1px solid #ccc;
	width: 26px;
	height: 26px;
	line-height: 26px;
	display: block;
	text-align: center;
	text-decoration: none;
	color: black;
	}
.leaflet-bar a,
.leaflet-control-layers-toggle {
	background-position: 50% 50%;
	background-repeat: no-repeat;
	display: block;
	}
.leaflet-bar a:hover,
.leaflet-bar a:focus {
	background-color: #f4f4f4;
	}
.leaflet-bar a:first-child {
	border-top-left-radius: 4px;
	border-top-right-radius: 4px;
	}
.leaflet-bar a:last-child {
	border-bottom-left-radius: 4px;
	border-bottom-right-radius: 4px;
	border-bottom: none;
	}
.leaflet-bar a.leaflet-disabled {
	cursor: default;
	background-color: #f4f4f4;
	color: #bbb;
	}

.leaflet-touch .leaflet-bar a {
	width: 30px;
	height: 30px;
	line-height: 30px;
	}
.leaflet-touch .leaflet-bar a:first-child {
	border-top-left-radius: 2px;
	border-top-right-radius: 2px;
	}
.leaflet-touch .leaflet-bar a:last-child {
	border-bottom-left-radius: 2px;
	border-bottom-right-radius: 2px;
	}

/* zoom control */

.leaflet-control-zoom-in,
.leaflet-control-zoom-out {
	font: bold 18px 'Lucida Console', Monaco, monospace;
	text-indent: 1px;
	}

.leaflet-touch .leaflet-control-zoom-in, .leaflet-touch .leaflet-control-zoom-out  {
	font-size: 22px;
	}


/* layers control */

.leaflet-control-layers {
	box-shadow: 0 1px 5px rgba(0,0,0,0.4);
	background: #fff;
	border-radius: 5px;
	}
.leaflet-control-layers-toggle {
	background-image: url(images/layers.png);
	width: 36px;
	height: 36px;
	}
.leaflet-retina .leaflet-control-layers-toggle {
	background-image: url(images/layers-2x.png);
	background-size: 26px 26px;
	}
.leaflet-touch .leaflet-control-layers-toggle {
	width: 44px;
	height: 44px;
	}
.leaflet-control-layers .leaflet-control-layers-list,
.leaflet-control-layers-expanded .leaflet-control-layers-toggle {
	display: none;
	}
.leaflet-control-layers-expanded .leaflet-control-layers-list {
	display: block;
	position: relative;
	}
.leaflet-control-layers-expanded {
	padding: 6px 10px 6px 6px;
	color: #333;
	background: #fff;
	}
.leaflet-control-layers-scrollbar {
	overflow-y: scroll;
	overflow-x: hidden;
	padding-right: 5px;
	}
.leaflet-control-layers-selector {
	margin-top: 2px;
	position: relative;
	top: 1px;
	}
.leaflet-control-layers label {
	display: block;
	font-size: 13px;
	font-size: 1.08333em;
	}
.leaflet-control-layers-separator {
	height: 0;
	border-top: 1px solid #ddd;
	margin: 5px -10px 5px -6px;
	}

/* Default icon URLs */
.leaflet-default-icon-path { /* used only in path-guessing heuristic, see L.Icon.Default */
	background-image: url(images/marker-icon.png);
	}


/* attribution and scale controls */

.leaflet-container .leaflet-control-attribution {
	background: #fff;
	background: rgba(255, 255, 255, 0.8);
	margin: 0;
	}
.leaflet-control-attribution,
.leaflet-control-scale-line {
	padding: 0 5px;
	color: #333;
	line-height: 1.4;
	}
.leaflet-control-attribution a {
	text-decoration: none;
	}
.leaflet-control-attribution a:hover,
.leaflet-control-attribution a:focus {
	text-decoration: underline;
	}
.leaflet-attribution-flag {
	display: inline !important;
	vertical-align: baseline !important;
	width: 1em;
	height: 0.6669em;
	}
.leaflet-left .leaflet-control-scale {
	margin-left: 5px;
	}
.leaflet-bottom .leaflet-control-scale {
	margin-bottom: 5px;
	}
.leaflet-control-scale-line {
	border: 2px solid #777;
	border-top: none;
	line-height: 1.1;
	padding: 2px 5px 1px;
	white-space: nowrap;
	-moz-box-sizing: border-box;
	     box-sizing: border-box;
	background: rgba(255, 255, 255, 0.8);
	text-shadow: 1px 1px #fff;
	}
.leaflet-control-scale-line:not(:first-child) {
	border-top: 2px solid #777;
	border-bottom: none;
	margin-top: -2px;
	}
.leaflet-control-scale-line:not(:first-child):not(:last-child) {
	border-bottom: 2px solid #777;
	}

.leaflet-touch .leaflet-control-attribution,
.leaflet-touch .leaflet-control-layers,
.leaflet-touch .leaflet-bar {
	box-shadow: none;
	}
.leaflet-touch .leaflet-control-layers,
.leaflet-touch .leaflet-bar {
	border: 2px solid rgba(0,0,0,0.2);
	background-clip: padding-box;
	}


/* popup */

.leaflet-popup {
	position: absolute;
	text-align: center;
	margin-bottom: 20px;
	}
.leaflet-popup-content-wrapper {
	padding: 1px;
	text-align: left;
	border-radius: 12px;
	}
.leaflet-popup-content {
	margin: 13px 24px 13px 20px;
	line-height: 1.3;
	font-size: 13px;
	font-size: 1.08333em;
	min-height: 1px;
	}
.leaflet-popup-content p {
	margin: 17px 0;
	margin: 1.3em 0;
	}
.leaflet-popup-tip-container {
	width: 40px;
	height: 20px;
	position: absolute;
	left: 50%;
	margin-top: -1px;
	margin-left: -20px;
	overflow: hidden;
	pointer-events: none;
	}
.leaflet-popup-tip {
	width: 17px;
	height: 17px;
	padding: 1px;

	margin: -10px auto 0;
	pointer-events: auto;

	-webkit-transform: rotate(45deg);
	   -moz-transform: rotate(45deg);
	    -ms-transform: rotate(45deg);
	        transform: rotate(45deg);
	}
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
	background: white;
	color: #333;
	box-shadow: 0 3px 14px rgba(0,0,0,0.4);
	}
.leaflet-container a.leaflet-popup-close-button {
	position: absolute;
	top: 0;
	right: 0;
	border: none;
	text-align: center;
	width: 24px;
	height: 24px;
	font: 16px/24px Tahoma, Verdana, sans-serif;
	color: #757575;
	text-decoration: none;
	background: transparent;
	}
.leaflet-container a.leaflet-popup-close-button:hover,
.leaflet-container a.leaflet-popup-close-button:focus {
	color: #585858;
	}
.leaflet-popup-scrolled {
	overflow: auto;
	}

.leaflet-oldie .leaflet-popup-content-wrapper {
	-ms-zoom: 1;
	}
.leaflet-oldie .leaflet-popup-tip {
	width: 24px;
	margin: 0 auto;

	-ms-filter: "progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678)";
	filter: progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678);
	}

.leaflet-oldie .leaflet-control-zoom,
.leaflet-oldie .leaflet-control-layers,
.leaflet-oldie .leaflet-popup-content-wrapper,
.leaflet-oldie .leaflet-popup-tip {
	border: 1px solid #999;
	}


/* div icon */

.leaflet-div-icon {
	background: #fff;
	border: 1px solid #666;
	}


/* Tooltip */
/* Base styles for the element that has a tooltip */
.leaflet-tooltip {
	position: absolute;
	padding: 6px;
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 3px;
	color: #222;
	white-space: nowrap;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
	pointer-events: none;
	box-shadow: 0 1px 3px rgba(0,0,0,0.4);
	}
.leaflet-tooltip.leaflet-interactive {
	cursor: pointer;
	pointer-events: auto;
	}
.leaflet-tooltip-top:before,
.leaflet-tooltip-bottom:before,
.leaflet-tooltip-left:before,
.leaflet-tooltip-right:before {
	position: absolute;
	pointer-events: none;
	border: 6px solid transparent;
	background: transparent;
	content: "";
	}

/* Directions */

.leaflet-tooltip-bottom {
	margin-top: 6px;
}
.leaflet-tooltip-top {
	margin-top: -6px;
}
.leaflet-tooltip-bottom:before,
.leaflet-tooltip-top:before {
	left: 50%;
	margin-left: -6px;
	}
.leaflet-tooltip-top:before {
	bottom: 0;
	margin-bottom: -12px;
	border-top-color: #fff;
	}
.leaflet-tooltip-bottom:before {
	top: 0;
	margin-top: -12px;
	margin-left: -6px;
	border-bottom-color: #fff;
	}
.leaflet-tooltip-left {
	margin-left: -6px;
}
.leaflet-tooltip-right {
	margin-left: 6px;
}
.leaflet-tooltip-left:before,
.leaflet-tooltip-right:before {
	top: 50%;
	margin-top: -6px;
	}
.leaflet-tooltip-left:before {
	right: 0;
	margin-right: -12px;
	border-left-color: #fff;
	}
.leaflet-tooltip-right:before {
	left: 0;
	margin-left: -12px;
	border-right-color: #fff;
	}

/* Printing */

@media print {
	/* Prevent printers from removing background-images of controls. */
	.leaflet-control {
		-webkit-print-color-adjust: exact;
		print-color-adjust: exact;
		}
        /* Leaflet Draw CSS - Embedded */
.leaflet-draw-section{position:relative}.leaflet-draw-toolbar{margin-top:12px}.leaflet-draw-toolbar-top{margin-top:0}.leaflet-draw-toolbar-notop a:first-child{border-top-right-radius:0}.leaflet-draw-toolbar-nobottom a:last-child{border-bottom-right-radius:0}.leaflet-draw-toolbar a{background-image:url('images/spritesheet.png');background-image:linear-gradient(transparent,transparent),url('images/spritesheet.svg');background-repeat:no-repeat;background-size:300px 30px;background-clip:padding-box}.leaflet-retina .leaflet-draw-toolbar a{background-image:url('images/spritesheet-2x.png');background-image:linear-gradient(transparent,transparent),url('images/spritesheet.svg')}
.leaflet-draw a{display:block;text-align:center;text-decoration:none}.leaflet-draw a .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.leaflet-draw-actions{display:none;list-style:none;margin:0;padding:0;position:absolute;left:26px;top:0;white-space:nowrap}.leaflet-touch .leaflet-draw-actions{left:32px}.leaflet-right .leaflet-draw-actions{right:26px;left:auto}.leaflet-touch .leaflet-right .leaflet-draw-actions{right:32px;left:auto}.leaflet-draw-actions li{display:inline-block}
.leaflet-draw-actions li:first-child a{border-left:0}.leaflet-draw-actions li:last-child a{-webkit-border-radius:0 4px 4px 0;border-radius:0 4px 4px 0}.leaflet-right .leaflet-draw-actions li:last-child a{-webkit-border-radius:0;border-radius:0}.leaflet-right .leaflet-draw-actions li:first-child a{-webkit-border-radius:4px 0 0 4px;border-radius:4px 0 0 4px}.leaflet-draw-actions a{background-color:#919187;border-left:1px solid #AAA;color:#FFF;font:11px/19px "Helvetica Neue",Arial,Helvetica,sans-serif;line-height:28px;text-decoration:none;padding-left:10px;padding-right:10px;height:28px}
.leaflet-touch .leaflet-draw-actions a{font-size:12px;line-height:30px;height:30px}.leaflet-draw-actions-bottom{margin-top:0}.leaflet-draw-actions-top{margin-top:1px}.leaflet-draw-actions-top a,.leaflet-draw-actions-bottom a{height:27px;line-height:27px}.leaflet-draw-actions a:hover{background-color:#a0a098}.leaflet-draw-actions-top.leaflet-draw-actions-bottom a{height:26px;line-height:26px}.leaflet-draw-toolbar .leaflet-draw-draw-polyline{background-position:-2px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-polyline{background-position:0 -1px}
.leaflet-draw-toolbar .leaflet-draw-draw-polygon{background-position:-31px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-polygon{background-position:-29px -1px}.leaflet-draw-toolbar .leaflet-draw-draw-rectangle{background-position:-62px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-rectangle{background-position:-60px -1px}.leaflet-draw-toolbar .leaflet-draw-draw-circle{background-position:-92px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-circle{background-position:-90px -1px}
.leaflet-draw-toolbar .leaflet-draw-draw-marker{background-position:-122px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-marker{background-position:-120px -1px}.leaflet-draw-toolbar .leaflet-draw-draw-circlemarker{background-position:-273px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-draw-circlemarker{background-position:-271px -1px}.leaflet-draw-toolbar .leaflet-draw-edit-edit{background-position:-152px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-edit-edit{background-position:-150px -1px}
.leaflet-draw-toolbar .leaflet-draw-edit-remove{background-position:-182px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-edit-remove{background-position:-180px -1px}.leaflet-draw-toolbar .leaflet-draw-edit-edit.leaflet-disabled{background-position:-212px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-edit-edit.leaflet-disabled{background-position:-210px -1px}.leaflet-draw-toolbar .leaflet-draw-edit-remove.leaflet-disabled{background-position:-242px -2px}.leaflet-touch .leaflet-draw-toolbar .leaflet-draw-edit-remove.leaflet-disabled{background-position:-240px -2px}
.leaflet-mouse-marker{background-color:#fff;cursor:crosshair}.leaflet-draw-tooltip{background:#363636;background:rgba(0,0,0,0.5);border:1px solid transparent;-webkit-border-radius:4px;border-radius:4px;color:#fff;font:12px/18px "Helvetica Neue",Arial,Helvetica,sans-serif;margin-left:20px;margin-top:-21px;padding:4px 8px;position:absolute;visibility:hidden;white-space:nowrap;z-index:6}.leaflet-draw-tooltip:before{border-right:6px solid black;border-right-color:rgba(0,0,0,0.5);border-top:6px solid transparent;border-bottom:6px solid transparent;content:"";position:absolute;top:7px;left:-7px}
.leaflet-error-draw-tooltip{background-color:#f2dede;border:1px solid #e6b6bd;color:#b94a48}.leaflet-error-draw-tooltip:before{border-right-color:#e6b6bd}.leaflet-draw-tooltip-single{margin-top:-12px}.leaflet-draw-tooltip-subtext{color:#f8d5e4}.leaflet-draw-guide-dash{font-size:1%;opacity:.6;position:absolute;width:5px;height:5px}.leaflet-edit-marker-selected{background-color:rgba(254,87,161,0.1);border:4px dashed rgba(254,87,161,0.6);-webkit-border-radius:4px;border-radius:4px;box-sizing:content-box}
.leaflet-edit-move{cursor:move}.leaflet-edit-resize{cursor:pointer}.leaflet-oldie .leaflet-draw-toolbar{border:1px solid #999}
	}
        /* CSS Değişkenler - Tema Sistemi */
        :root {
            --primary-color: #2196f3;
            --secondary-color: #f5f5f5;
            --accent-color: #ff9800;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #6c757d;
            --text-inverse: #ffffff;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-dark: #495057;
            --bg-darker: #343a40;
            
            --border-color: #e0e0e0;
            --border-light: #dee2e6;
            --border-dark: #6c757d;
            
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 4px 16px rgba(0, 0, 0, 0.2);
            
            --radius-small: 4px;
            --radius-medium: 6px;
            --radius-large: 8px;
            --radius-xl: 12px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-xxl: 24px;
            
            --font-size-xs: 10px;
            --font-size-sm: 11px;
            --font-size-base: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            
            --transition-fast: 0.15s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.3s ease;
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --bg-primary: #2d3748;
            --bg-secondary: #1a202c;
            --bg-tertiary: #4a5568;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --border-light: #2d3748;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color var(--transition-base), 
                        border-color var(--transition-base), 
                        box-shadow var(--transition-base),
                        transform var(--transition-base),
                        color var(--transition-base);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sol Panel - Katman Yönetimi */
        .layer-panel {
            width: 380px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resize: horizontal;
            min-width: 250px;
            max-width: 600px;
        }

        /* Resize handle'ı daha belirgin yapalım */
        .layer-panel::-webkit-resizer {
            background: linear-gradient(135deg, var(--text-muted), var(--bg-dark));
            border-radius: var(--radius-small);
        }

        .panel-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-darker));
            color: var(--text-inverse);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium);
        }

        .panel-header h2 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .add-layer-btn, .filter-btn {
            background: var(--success-color);
            color: var(--text-inverse);
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: background-color var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .filter-btn {
            background: var(--info-color);
        }

        .add-layer-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .filter-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .layer-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        /* Katman Grubu */
        .layer-group {
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            background: var(--bg-primary);
            transition: all var(--transition-base);
        }

        .layer-group:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
        }

        .group-header {
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--bg-tertiary), #eeeeee);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-radius: var(--radius-medium) var(--radius-medium) 0 0;
            transition: all var(--transition-base);
        }

        .group-header:hover {
            background: linear-gradient(135deg, #e8f4fd, #d6eaf8);
            border-color: var(--primary-color);
        }

        .group-checkbox {
            margin-right: 5px;
        }

        .group-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .group-icon.collapsed {
            transform: rotate(-90deg);
        }

        .group-name {
            flex: 1;
        }

        .group-count {
            font-size: var(--font-size-xs);
            font-weight: 500;
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-muted);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            border: 1px solid rgba(108, 117, 125, 0.2);
            transition: all var(--transition-base);
        }

        .group-items {
            padding: var(--spacing-xs) 1px var(--spacing-xs) var(--spacing-xs);
            background: #fafbfc;
            border-left: 3px solid var(--bg-tertiary);
        }

        .group-items.collapsed {
            display: none;
        }

        /* Katman Elemanı */
        .layer-item {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-sm) var(--spacing-xs);
            border-bottom: 1px solid #f1f3f5;
            background: var(--bg-primary);
            transition: all var(--transition-base);
            border-radius: var(--radius-small);
            margin: 0px 0.5px 0px var(--spacing-lg);
            min-height: 40px;
            position: relative;
            border: 1px solid transparent;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        .layer-item + .layer-item {
            margin-top: var(--spacing-xs);
        }

        .layer-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(33, 150, 243, 0.2);
            transform: translateY(-1px);
        }

        /* Katman seçilebilir alanları */
        .layer-selectable-area {
            display: flex;
            align-items: flex-start;
            flex: 1;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
            gap: 4px;
        }

        .layer-selectable-area:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .layer-visibility {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .layer-name {
            flex: 1;
            font-size: 12px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            max-width: calc(100% - 100px);
            padding-top: 1px;
        }

        /* Katman stil modu göstergesi - Modern Tasarım */
        .layer-style-mode-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: auto;
            margin-right: var(--spacing-sm);
            border-radius: var(--radius-medium);
            flex-shrink: 0;
            cursor: pointer;
            transition: all var(--transition-base);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            font-size: 12px; /* Support for emoji icons */
        }

        .layer-style-mode-indicator:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .layer-style-mode-indicator svg {
            width: 12px;
            height: 12px;
            transition: all var(--transition-base);
        }

        /* Varsayılan Mod - Modal butonuyla aynı mavi tema */
        .layer-style-mode-indicator.default-mode {
            background: linear-gradient(135deg, var(--primary-color), #1976d2);
            color: var(--text-inverse);
            border: none;
            box-shadow: var(--shadow-light);
        }

        .layer-style-mode-indicator.default-mode:hover {
            background: linear-gradient(135deg, #1976d2, var(--primary-color));
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px) scale(1.1);
        }

        .layer-style-mode-indicator.default-mode svg {
            color: var(--text-inverse);
        }

        /* Özel Mod - Modal butonuyla aynı turuncu tema */
        .layer-style-mode-indicator.custom-mode {
            background: linear-gradient(135deg, var(--accent-color), #f57c00);
            color: var(--text-inverse);
            border: none;
            box-shadow: var(--shadow-light);
        }

        .layer-style-mode-indicator.custom-mode:hover {
            background: linear-gradient(135deg, #f57c00, var(--accent-color));
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px) scale(1.1);
        }

        .layer-style-mode-indicator.custom-mode svg {
            color: var(--text-inverse);
        }

        /* Aktif/Pasif durumlar için glow efektler */
        .layer-style-mode-indicator.default-mode::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, var(--primary-color), #1976d2);
            border-radius: var(--radius-medium);
            z-index: -1;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .layer-style-mode-indicator.custom-mode::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, var(--accent-color), #f57c00);
            border-radius: var(--radius-medium);
            z-index: -1;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .layer-style-mode-indicator:hover::after {
            opacity: 0.2;
        }

        .layer-actions {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
            align-items: flex-start;
            margin-top: 2px;
        }

        .layer-action-btn {
            background: none;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            color: #6c757d;
            border-radius: 3px;
            font-size: 11px;
        }

        .layer-action-btn:hover {
            background: #e9ecef;
            color: #343a40;
        }

        /* Harita Alanı */
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #map {
            width: 100%;
            flex: 1;
            z-index: 1;
        }

        /* Koordinat ve Ölçek Status Bar */
        .status-bar {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-top: 1px solid var(--border-light);
            padding: var(--spacing-sm) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            min-height: 32px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .coordinate-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: var(--font-size-xs);
        }

        .coordinate-item {
            background: var(--bg-primary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            min-width: 100px;
            text-align: center;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-weight: 500;
            align-items: center;
            gap: 20px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coordinate-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .coordinate-item {
            background: white;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            min-width: 120px;
            text-align: center;
        }

        .scale-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scale-bar {
            width: 100px;
            height: 4px;
            background: #333;
            position: relative;
            border: 1px solid #000;
        }

        .scale-text {
            font-weight: 500;
            color: #333;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .scale-text:hover {
            background-color: #e9ecef;
        }

        .scale-selector {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .scale-selector.show {
            display: block !important;
        }

        .scale-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .scale-option:hover {
            background-color: #f8f9fa;
        }

        .scale-option:last-child {
            border-bottom: none;
        }

        .scale-option.current {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .projection-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .projection-select {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            background: white;
            cursor: pointer;
        }

        .projection-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 1px rgba(0,123,255,0.25);
        }

        .status-label {
            font-weight: 500;
            color: #6c757d;
        }

        /* Stil Ayarları Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            width: 480px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: move;
            box-shadow: var(--shadow-heavy);
            border: none;
            animation: modalAppear 0.2s ease-out;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -55%) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-darker));
            color: var(--text-inverse);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            border-bottom: none;
        }

        .modal-header h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-inverse);
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-small);
            transition: all var(--transition-base);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Style Mode Toggle Button */
        .style-mode-toggle {
            background: linear-gradient(135deg, var(--primary-color), #1976d2);
            border: none;
            border-radius: var(--radius-medium);
            width: 42px;
            height: 42px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .style-mode-toggle:hover {
            background: linear-gradient(135deg, #1976d2, var(--primary-color));
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .style-mode-toggle:active {
            transform: translateY(0);
            box-shadow: var(--shadow-light);
        }

        .style-mode-toggle.custom-mode {
            background: linear-gradient(135deg, var(--accent-color), #f57c00);
        }

        .style-mode-toggle.custom-mode:hover {
            background: linear-gradient(135deg, #f57c00, var(--accent-color));
        }

        #styleModeIcon {
            font-size: 18px;
            transition: transform var(--transition-base);
        }

        .style-mode-toggle:hover #styleModeIcon {
            transform: scale(1.1);
        }

        .modal-body {
            padding: var(--spacing-xl);
            overflow-y: auto;
            max-height: 70vh;
        }

        .style-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .style-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
        }

        .style-tab.active {
            border-bottom-color: #0d6efd;
            color: #0d6efd;
            font-weight: 500;
        }

        .style-section {
            margin-bottom: 20px;
        }

        .style-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-row label {
            flex: 0 0 140px;
            font-size: 13px;
            color: #6c757d;
        }

        .control-row input[type="color"] {
            width: 40px;
            height: 25px;
            padding: 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .control-row input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }

        .control-row .value-display {
            min-width: 40px;
            text-align: right;
            font-size: 12px;
            color: #6c757d;
        }

        .control-row select {
            flex: 1;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }

        .modal-footer {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: var(--font-size-md);
            font-weight: 500;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            min-width: 80px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            background: #1976d2;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--text-muted);
            color: var(--text-inverse);
            box-shadow: var(--shadow-light);
        }

        .btn-secondary:hover {
            background: #5c636a;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Animasyonlar ve Hover Efektleri */
        .layer-item:hover,
        .group-header:hover,
        .tool-btn:hover {
            transform: translateY(-1px);
        }

        .layer-item:active,
        .group-header:active,
        .tool-btn:active {
            transform: translateY(0);
        }

        /* Loading Animasyonları */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            100% {
                left: 100%;
            }
        }

        /* Pulse Animasyonu */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Fade In Animasyonu */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide In Animasyonu */
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Ölçüm Tooltip'leri - Stabil Pozisyon */
        .measurement-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: var(--radius-small) !important;
            padding: 4px 8px !important;
            font-weight: bold !important;
            font-size: 12px !important;
            box-shadow: var(--shadow-medium) !important;
            white-space: nowrap !important;
            pointer-events: none !important;
            transform: none !important;
            position: relative !important;
        }

        .measurement-tooltip:before {
            display: none !important;
        }

        /* Feature Label Styles - Collision Avoidance */
        .feature-label {
            background: rgba(0, 0, 0, 0.75) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 4px !important;
            padding: 3px 6px !important;
            font-weight: bold !important;
            font-size: 11px !important;
            white-space: nowrap !important;
            pointer-events: none !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            z-index: 1000 !important;
            transition: opacity 0.2s ease !important;
        }

        .feature-label.hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Edge Labels for Lines and Polygons */
        .edge-label {
            background: rgba(255, 165, 0, 0.85) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            border-radius: 3px !important;
            padding: 2px 5px !important;
            font-weight: 600 !important;
            font-size: 10px !important;
            white-space: nowrap !important;
            pointer-events: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        /* Segment Labels for Lines */
        .segment-label {
            background: rgba(33, 150, 243, 0.85) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 3px !important;
            padding: 2px 4px !important;
            font-weight: 500 !important;
            font-size: 9px !important;
            white-space: nowrap !important;
            pointer-events: none !important;
        }

        /* Ölçüm Noktaları */
        .measurement-point {
            cursor: crosshair !important;
            z-index: 1000 !important;
        }

        /* Drag and Drop */
        .layer-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg) scale(1.05);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
        }

        .layer-item.drag-over {
            border-top: 2px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), transparent);
        }

        /* Active State Animations */
        .tool-btn.active {
            animation: activeGlow 2s infinite;
        }

        @keyframes activeGlow {
            0%, 100% {
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            50% {
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 0 10px rgba(33, 150, 243, 0.3);
            }
        }

        /* Notification Animations */
        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Error State Animation */
        .error-shake {
            animation: errorShake 0.5s ease-in-out;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Katman İkonları Container */
        .layer-icons {
            display: flex;
            gap: 1px;
            margin-right: 4px;
        }

        /* SVG İkonları */
        .layer-icon {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layer-icon svg {
            width: 100%;
            height: 100%;
        }

        /* === LEJANT STİLLERİ === */
        .legend-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            max-width: 300px;
            z-index: 1000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: none;
        }

        .legend-header {
            background: #343a40;
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
        }

        .legend-controls {
            display: flex;
            gap: 5px;
        }

        .legend-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .legend-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .legend-settings {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            font-size: 12px;
        }

        .legend-setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-setting-item:last-child {
            margin-bottom: 0;
        }

        .legend-setting-item input[type="checkbox"] {
            margin-right: 6px;
        }

        .legend-setting-item label {
            cursor: pointer;
            color: #666;
        }

        .legend-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .legend-content.collapsed {
            display: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px;
            border-radius: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-symbol {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 13px;
            color: #333;
            flex: 1;
        }

        .legend-group {
            margin-bottom: 12px;
        }

        .legend-group-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #ddd;
        }

        /* Lejant toggle butonu */
        .legend-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 999;
            font-size: 13px;
            color: #333;
        }

        .legend-toggle:hover {
            background: #f8f9fa;
        }

        /* İkon Stilleri */
        .icon-point {
            color: #ff0000;
        }

        .icon-line {
            color: #ff7800;
        }

        .icon-polygon {
            color: #3388ff;
        }

        /* SVG elemanları için varsayılan stiller */
        .layer-icon svg rect,
        .layer-icon svg polygon,
        .layer-icon svg path {
            transition: all 0.2s ease;
        }

        .layer-icon svg line,
        .layer-icon svg polyline {
            stroke-width: 3;
            fill: none;
            stroke: currentColor;
        }

        /* İkon Durumları */
        .layer-icon.inactive {
            opacity: 0.3;
        }

        .layer-icon.active {
            opacity: 1;
        }

        /* Özellik Tablosu */
        .attribute-table {
            margin-top: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .attribute-row {
            display: flex;
            border-bottom: 1px solid #f1f3f5;
        }

        .attribute-row:last-child {
            border-bottom: none;
        }

        .attribute-label {
            padding: 6px 10px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            width: 120px;
            font-size: 12px;
            font-weight: 500;
        }

        .attribute-value {
            padding: 6px 10px;
            flex: 1;
            font-size: 12px;
        }

        /* Filtre Paneli */
        .filter-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 500;
            width: 300px;
            display: none;
        }

        .filter-panel.active {
            display: block;
        }

        /* Renk lejanı */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* Desen Seçici */
        .pattern-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .pattern-option {
            width: 40px;
            height: 40px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pattern-option.selected {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

        /* Label Ayarları */
        .label-settings {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Arama ve Filtre Paneli */
        .search-filter-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        /* İçe/Dışa Aktarma Menüsü */
        .import-export-menu {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 500;
            min-width: 200px;
            display: none;
        }

        .import-export-menu.active {
            display: block;
        }

        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }



        /* Undo/Redo Butonları */
        .action-buttons {
            position: absolute;
            top: 120px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 400;
        }

        .action-btn {
            background: white;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(0,0,0,0.1);
            z-index: 2000;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Toast Notifications - Enhanced */
        .toast {
            position: fixed;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: 10000;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-medium);
            color: var(--text-inverse);
            font-size: var(--font-size-md);
            font-weight: 500;
            box-shadow: var(--shadow-heavy);
            transform: translateX(100%);
            opacity: 0;
            transition: all var(--transition-base);
            max-width: 300px;
            word-wrap: break-word;
            background: var(--success-color);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success,
        .toast {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
        }

        .toast.error {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: var(--text-primary);
        }

        .toast.info,
        .toast-info {
            background: linear-gradient(135deg, var(--info-color), #148a9a);
        }

        .toast-success {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
        }

        .toast-warning {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: var(--text-primary);
        }

        .toast-error {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

                    /* Ölçüm Tooltip'leri */
        .measurement-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        .measurement-tooltip::before {
            display: none !important;
        }

        /* Ölçüm Noktaları */
        .measurement-point {
            background: #ff4444 !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            width: 8px !important;
            height: 8px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
        }

        /* Araç Kontrolleri - Birleşik Tasarım */
        .map-tools-container {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-width: 60px;
        }

        .tool-group {
            background: var(--bg-primary);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .tool-group-title {
            background: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-light);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .tool-buttons {
            display: flex;
            flex-direction: column;
        }

        .tool-btn {
            background: var(--bg-primary);
            border: none;
            border-bottom: 1px solid var(--border-light);
            padding: var(--spacing-sm);
            cursor: pointer;
            font-size: var(--font-size-md);
            color: var(--text-primary);
            transition: all var(--transition-base);
            min-width: 44px;
            min-height: 44px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-btn:last-child {
            border-bottom: none;
        }

        .tool-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .tool-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tool-btn.active:hover {
            background: #1976d2;
        }

        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tool-btn:disabled:hover {
            background: var(--bg-primary);
            transform: none;
            box-shadow: none;
        }



        /* Modern Responsive Design */
        
        /* Genel container fix */
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .left-panel {
            flex-shrink: 0;
        }
        
        .map-section {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Tablet Responsive (769px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .main-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .left-panel {
                width: 100%;
                min-height: 180px;
                max-height: 200px;
                order: 2;
                overflow-y: auto;
                flex-shrink: 0;
                border-right: none;
                border-top: 1px solid var(--border-color);
            }
            
            .map-section {
                order: 1;
                flex: 1;
                height: auto;
                min-height: 0;
            }
            
            .right-toolbar {
                position: fixed !important;
                right: 10px;
                top: 10px;
                flex-direction: column;
                background: rgba(255, 255, 255, 0.95);
                padding: var(--spacing-sm);
                border-radius: var(--radius-large);
                box-shadow: var(--shadow-heavy);
                backdrop-filter: blur(10px);
                z-index: 1000;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .status-bar {
                order: 3;
                flex-shrink: 0;
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 13px;
            }
            
            .coordinate-display {
                gap: var(--spacing-sm);
            }
        }

        /* Mobil Responsive (481px - 768px) */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .left-panel {
                width: 100%;
                min-height: 120px;
                max-height: 150px;
                order: 2;
                overflow-y: auto;
                flex-shrink: 0;
                border-right: none;
                border-top: 1px solid var(--border-color);
            }
            
            .map-section {
                order: 1;
                flex: 1;
                height: auto;
                min-height: 0;
            }
            
            .right-toolbar {
                position: fixed !important;
                bottom: 160px;
                left: 50%;
                transform: translateX(-50%);
                flex-direction: row;
                flex-wrap: wrap;
                background: rgba(255, 255, 255, 0.95);
                padding: var(--spacing-sm);
                border-radius: var(--radius-xl);
                box-shadow: var(--shadow-heavy);
                backdrop-filter: blur(10px);
                z-index: 1000;
                max-width: 90vw;
                max-height: 200px;
                overflow: auto;
                justify-content: center;
                gap: var(--spacing-xs);
            }
            
            .toolbar-group {
                margin: 0 var(--spacing-xs);
                flex-shrink: 0;
                display: flex;
                flex-direction: row;
                gap: 2px;
                background: rgba(0,0,0,0.05);
                border-radius: var(--radius-medium);
                padding: 2px;
            }
            
            .toolbar-group .tool-btn {
                margin: 0;
                border-radius: var(--radius-small);
            }
            
            .status-bar {
                order: 3;
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 12px;
                flex-shrink: 0;
            }
            
            .coordinate-display {
                flex-direction: row;
                gap: var(--spacing-sm);
                font-size: 11px;
            }
            
            .layer-panel-header {
                padding: var(--spacing-sm);
            }
            
            .layer-panel-header h2 {
                font-size: 16px;
            }
            
            .layer-search {
                font-size: 14px;
                padding: var(--spacing-xs);
            }
            
            .layer-item {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 13px;
            }
            
            .tool-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                flex-shrink: 0;
            }
            
            .modal {
                width: 95%;
                max-width: none;
                margin: 2.5%;
                max-height: 90vh;
            }
        }

        /* Küçük Mobil (max 480px) */
        @media (max-width: 480px) {
            .left-panel {
                min-height: 100px;
                max-height: 120px;
            }
            
            .right-toolbar {
                bottom: 130px;
                padding: var(--spacing-xs);
                max-width: 95vw;
                max-height: 150px;
                overflow: auto;
                justify-content: center;
                gap: 2px;
            }
            
            .toolbar-group {
                margin: 0 1px;
                flex-shrink: 0;
                padding: 1px;
                gap: 1px;
            }
            
            .tool-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
                margin: 1px;
                flex-shrink: 0;
            }
            
            .status-bar {
                font-size: 11px;
                padding: var(--spacing-xs);
                flex-shrink: 0;
                overflow: hidden;
            }
            
            .coordinate-display {
                gap: var(--spacing-xs);
                flex-wrap: nowrap;
                overflow: hidden;
            }
            
            .coordinate-item {
                font-size: 10px;
                flex-shrink: 0;
            }
            
            .layer-panel-header h2 {
                font-size: 14px;
            }
            
            .layer-item {
                font-size: 12px;
                padding: 4px var(--spacing-xs);
            }
            
            .layer-icon {
                font-size: 12px;
            }
            
            .layer-actions .layer-action-btn {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
            
            .modal {
                margin: 5px;
                width: calc(100% - 10px);
                max-height: 95vh;
            }
            
            .modal-header {
                padding: var(--spacing-sm);
            }
            
            .modal-content {
                padding: var(--spacing-sm);
                font-size: 14px;
            }
            
            /* Bildirimler mobilde responsive */
            .notification {
                top: 10px !important;
                right: 10px !important;
                left: 10px !important;
                max-width: none !important;
                font-size: 13px !important;
            }
        }

        /* Erişilebilirlik İyileştirmeleri */
        
        /* Yüksek kontrast modu */
        @media (prefers-contrast: high) {
            .layer-panel {
                border: 2px solid #000;
                background: #fff;
            }
            
            .layer-item, .group-header {
                border: 1px solid #000;
            }
            
            .tool-btn {
                border: 1px solid #000;
            }
        }

        /* Hareket azaltma */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
            
            .layer-item:hover,
            .group-header:hover,
            .tool-btn:hover {
                transform: none !important;
            }
        }

        /* Focus göstergeleri */
        .layer-item:focus,
        .tool-btn:focus,
        .group-header:focus,
        .btn:focus,
        .add-layer-btn:focus,
        .filter-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.2);
        }

        /* Klavye navigasyonu */
        .layer-item:focus,
        .group-header:focus {
            background: rgba(33, 150, 243, 0.1);
            border-color: var(--primary-color);
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Skip link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: var(--text-inverse);
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-small);
            z-index: 10000;
            transition: top var(--transition-base);
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #2d3748;
            --bg-secondary: #1a202c;
            --bg-tertiary: #4a5568;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --border-light: #2d3748;
        }

        [data-theme="dark"] body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .layer-panel {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .panel-header {
            background: var(--bg-primary);
        }

        /* Katman Detay Modalı */
        .layer-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .layer-details-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .layer-details-header {
            padding: 15px;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-details-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .layer-details-footer {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .feature-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .feature-row:hover {
            background: #f8f9fa;
        }

        .feature-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .feature-name {
            flex: 1;
        }

        .feature-actions {
            display: flex;
            gap: 5px;
        }

        /* Modern Katman Yönetimi Butonları */
        .create-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-light);
        }

        /* Ana Aksiyon Butonları Grubu */
        .primary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
        }

        /* İkincil Aksiyon Butonları Grubu */
        .secondary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        /* Temel Buton Stilleri */
        .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            text-align: center;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            min-height: 32px;
        }

        .create-group-btn svg, .create-layer-btn svg, .expand-all-btn svg, .collapse-all-btn svg {
            width: 14px;
            height: 14px;
            transition: transform var(--transition-base);
        }

        /* Ana Butonlar */
        .create-group-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .create-layer-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #218838 100%);
            color: var(--text-inverse);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* İkincil Butonlar */
        .expand-all-btn {
            background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%);
            color: var(--text-inverse);
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            min-height: 28px;
        }

        .collapse-all-btn {
            background: linear-gradient(135deg, var(--text-secondary) 0%, #495057 100%);
            color: var(--text-inverse);
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            min-height: 28px;
        }

        /* Hover Efektleri */
        .create-group-btn:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .create-layer-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .expand-all-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-1px);
        }

        .collapse-all-btn:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-1px);
        }

        /* İkon Animasyonları */
        .create-group-btn:hover svg,
        .create-layer-btn:hover svg {
            transform: scale(1.1);
        }

        .expand-all-btn:hover svg {
            transform: rotate(90deg);
        }

        .collapse-all-btn:hover svg {
            transform: rotate(-90deg);
        }

        /* Active States */
        .create-group-btn:active, .create-layer-btn:active {
            transform: translateY(0);
        }

        .expand-all-btn:active, .collapse-all-btn:active {
            transform: translateY(0);
        }

        /* Demo Veri Butonları */
        .demo-actions {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-light);
        }

        .demo-btn {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            border: none;
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all var(--transition-base);
            box-shadow: 0 2px 4px rgba(156, 39, 176, 0.3);
        }

        .demo-btn svg {
            width: 16px;
            height: 16px;
        }

        .demo-btn:hover {
            background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(156, 39, 176, 0.4);
        }

        .demo-btn:active {
            transform: translateY(0);
        }

        /* Demo Menü */
        .demo-menu {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            margin: var(--spacing-sm);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .demo-menu-header {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .demo-menu-header h4 {
            margin: 0;
            font-size: var(--font-size-md);
            font-weight: 600;
        }

        .demo-menu-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: all var(--transition-base);
        }

        .demo-menu-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .demo-menu-content {
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
        }

        .demo-section {
            margin-bottom: var(--spacing-md);
        }

        .demo-section:last-child {
            margin-bottom: 0;
        }

        .demo-section h5 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .demo-option-btn {
            width: 100%;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: var(--font-size-sm);
            text-align: left;
            transition: all var(--transition-base);
            color: var(--text-primary);
        }

        .demo-option-btn:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
            transform: translateX(4px);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }

        .demo-option-btn.danger {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            border-color: #ef5350;
        }

        .demo-option-btn.danger:hover {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
            border-color: #c62828;
        }

        [data-theme="dark"] .demo-menu {
            background: var(--bg-secondary);
            border-color: var(--border-dark);
        }

        [data-theme="dark"] .demo-option-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-dark);
        }

         /* Responsive Tasarım */
         @media (max-width: 768px) {
             .create-buttons {
                 padding: var(--spacing-xs);
             }
             
             .primary-actions {
                 grid-template-columns: 1fr;
                 gap: var(--spacing-xs);
             }
             
             .secondary-actions {
                 grid-template-columns: 1fr;
                 gap: var(--spacing-xs);
             }
             
             .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
                 padding: var(--spacing-xs) var(--spacing-sm);
                 font-size: var(--font-size-xs);
                 min-height: 28px;
             }
             
             .create-group-btn svg, .create-layer-btn svg, .expand-all-btn svg, .collapse-all-btn svg {
                 width: 12px;
                 height: 12px;
             }
         }

         /* Küçük Ekranlar için */
         @media (max-width: 480px) {
             .create-buttons {
                 margin-bottom: var(--spacing-sm);
             }
             
             .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
                 font-size: var(--font-size-xs);
                 padding: 6px var(--spacing-xs);
                 min-height: 24px;
             }
         }

        /* Seçili Katman Vurguları - Yuvarlak Nokta */
        .layer-item.selected-highlight {
            background: rgba(255, 230, 230, 0.4) !important;
            color: #333 !important;
        }

        .layer-item.selected-highlight::after {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
        }
        
        .layer-item.selected-highlight .layer-name {
            font-weight: 500 !important;
        }
        
        /* Grup Header Yeniden Tasarım */
        .group-header {
            display: flex;
            align-items: center;
            background: #e9ecef;
            border-radius: 6px 6px 0 0;
        }

        /* Görünürlük Alanı - Sol */
        .group-visibility-area {
            padding: 2px 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            border-radius: 6px 0 0 0;
            border-right: 1px solid #dee2e6;
            background: #f1f3f5;
        }

        .group-visibility-area:hover {
            background: #e9ecef;
        }

        .group-visibility-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .group-visibility-checkbox:hover {
            transform: scale(1.3);
        }

        /* Seçim Alanı - Orta */
        .group-select-area {
            padding: 2px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            background: #e9ecef;
        }

        .group-select-area:hover {
            background: #dee2e6;
        }

        /* Toggle Alanı - Sağ */
        .group-toggle-area {
            padding: 2px 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            border-radius: 0 6px 0 0;
            border-left: 1px solid #dee2e6;
            background: #f1f3f5;
        }

        .group-toggle-area:hover {
            background: #e9ecef;
        }

        .group-icon {
            font-size: 14px;
            transition: transform 0.2s ease;
            font-weight: bold;
        }



        /* Modern Grup Seçimi - Yuvarlak Nokta */
        .group-header.selected {
            background: rgba(255, 235, 235, 0.6);
            position: relative;
        }

        .group-header.selected::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            z-index: 2;
        }

        .group-header.selected .group-name {
            font-weight: 500;
            color: #a91e2c;
        }

        .group-header.selected + .group-items {
            background: rgba(255, 245, 245, 0.4);
        }

        /* Grup Animasyonu */
        .group-header {
            transition: background-color 0.2s ease;
            border-radius: 6px 6px 0 0;
        }
        
        /* Seçili Bilgi Paneli - Kırmızı Tonlar */
        .selected-info-panel {
            border-bottom: 1px solid #dee2e6;
        }
        
        .selected-group-info {
            background: rgba(255, 240, 240, 0.6) !important;
            border: 1px solid rgba(220, 53, 69, 0.3) !important;
            border-radius: 8px;
            margin: 4px;
        }
        
        .selected-group-info > div {
            padding: 8px 10px !important;
            background: transparent !important;
            border: none !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            color: #721c24 !important;
        }
        
        .selected-layer-info {
            background: rgba(255, 240, 240, 0.6) !important;
            border: 1px solid rgba(255, 150, 150, 0.3) !important;
            border-radius: 8px;
            margin: 4px;
        }
        
        .selected-layer-info > div {
            padding: 8px 10px !important;
            background: transparent !important;
            border: none !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            color: #a91e2c !important;
        }
        
        .selected-group-info button,
        .selected-layer-info button {
            background: rgba(0,0,0,0.1) !important;
            border: 1px solid rgba(0,0,0,0.2) !important;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .selected-group-info button:hover,
        .selected-layer-info button:hover {
            background: rgba(0,0,0,0.2) !important;
            transform: scale(1.1);
        }

        /* İkon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
        }

        /* Responsive Tasarım */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                order: 2;
            }
            
            .map-container {
                width: 100%;
                height: 60vh;
                order: 1;
            }
            
            .map-tools-container {
                top: 10px;
                right: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .tool-group {
                min-width: auto;
                flex: 0 0 auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                max-height: 250px;
            }
            
            .map-container {
                height: 50vh;
            }
            
            .map-tools-container {
                top: 5px;
                right: 5px;
                gap: 4px;
            }
            
            .tool-group {
                margin-bottom: 0;
            }
            
            .tool-group-title {
                font-size: 10px;
                padding: 2px 4px;
            }
            
            .tool-btn {
                width: 32px;
                height: 32px;
                padding: 6px;
            }
            
            .tool-btn svg {
                width: 14px;
                height: 14px;
            }
            
            .legend-container {
                max-width: 90vw;
                max-height: 70vh;
                bottom: 10px;
                left: 10px;
            }
            
            .layer-panel {
                padding: 8px;
            }
            
            .layer-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .group-header {
                padding: 4px 6px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .map-container {
                height: 45vh;
            }
            
            .sidebar {
                max-height: 200px;
            }
            
            .tool-group-title {
                display: none; /* Küçük ekranlarda başlıkları gizle */
            }
            
            .tool-buttons {
                gap: 2px;
            }
            
            .tool-btn {
                width: 28px;
                height: 28px;
                padding: 4px;
            }
            
            .tool-btn svg {
                width: 12px;
                height: 12px;
            }
            
            .legend-container {
                max-width: 95vw;
                max-height: 60vh;
                font-size: 12px;
                bottom: 5px;
                left: 5px;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 4px;
                padding: 4px 8px;
                font-size: 11px;
            }

            .status-item {
                min-width: auto;
            }
        }

        .icon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .icon-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .icon-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .icon-option img {
            width: 24px;
            height: 24px;
        }

        /* Etiket Stilleri */
        .feature-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-weight: bold !important;
            white-space: nowrap !important;
            pointer-events: none !important;
        }

        .feature-label::before {
            display: none !important;
        }

        /* ===== MESAJ KONSOLU ===== */
        .message-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 280px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            font-family: var(--font-mono);
            display: none;
            cursor: move;
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 150px;
        }

        .message-console.docked-bottom {
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-height: 200px;
            border-radius: 0;
            border-left: none;
            border-right: none;
            border-bottom: none;
            cursor: default;
            resize: vertical;
        }

        .message-console.show {
            display: flex;
            flex-direction: column;
        }

        .console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            border-radius: var(--radius-large) var(--radius-large) 0 0;
            border-bottom: 1px solid var(--border-light);
            cursor: move;
            user-select: none;
        }
        
        .message-console.docked-bottom .console-header {
            cursor: default;
        }

        .console-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .message-counter {
            background: rgba(255,255,255,0.2);
            color: var(--text-inverse);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: var(--spacing-xs);
            min-width: 20px;
            text-align: center;
        }

        .console-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .console-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-inverse);
            padding: 4px;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .console-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .console-filters {
            display: flex;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
        }

        .filter-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .filter-label input[type="checkbox"] {
            display: none;
        }

        .filter-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all var(--transition-base);
            opacity: 0.5;
        }

        .filter-label input[type="checkbox"]:checked + .filter-badge {
            opacity: 1;
        }

        .filter-badge.info {
            background: var(--info-color);
            color: var(--text-inverse);
        }

        .filter-badge.success {
            background: var(--success-color);
            color: var(--text-inverse);
        }

        .filter-badge.warning {
            background: var(--warning-color);
            color: var(--text-dark);
        }

        .filter-badge.error {
            background: var(--error-color);
            color: var(--text-inverse);
        }

        .console-content {
            flex: 1;
            overflow: hidden;
            border-radius: 0 0 var(--radius-large) var(--radius-large);
        }

        .console-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: var(--spacing-xs);
        }

        .console-messages::-webkit-scrollbar {
            width: 6px;
        }

        .console-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .console-messages::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }

        .console-message {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs);
            border-radius: var(--radius-small);
            margin-bottom: 2px;
            font-size: var(--font-size-xs);
            line-height: 1.4;
            transition: all var(--transition-base);
        }

        .console-message:hover {
            background: var(--bg-secondary);
        }

        .console-message.hidden {
            display: none;
        }

        .message-time {
            color: var(--text-muted);
            font-size: 10px;
            min-width: 45px;
            font-family: var(--font-mono);
        }

        .message-type {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 1px;
            flex-shrink: 0;
        }

        .message-type.info {
            background: var(--info-color);
        }

        .message-type.success {
            background: var(--success-color);
        }

        .message-type.warning {
            background: var(--warning-color);
        }

        .message-type.error {
            background: var(--error-color);
        }

        .message-text {
            flex: 1;
            color: var(--text-primary);
            word-break: break-word;
        }

        .console-minimized .console-content,
        .console-minimized .console-filters {
            display: none;
        }

        /* Console Toggle Button (Bottom Right) */
        .console-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        /* Konsol açıkken buton konumunu değiştir */
        .message-console.show:not(.docked-bottom) ~ .console-toggle-btn {
            right: 420px;
        }
        
        /* Docked modda buton gizle */
        .message-console.docked-bottom ~ .console-toggle-btn {
            display: none;
        }

        .console-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.5);
        }

        .console-toggle-btn.has-messages {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.8); }
            100% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .message-console:not(.docked-bottom) {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
                max-height: 50vh;
            }
            
            .message-console.docked-bottom {
                max-height: 40vh;
            }
        }


    </style>
</head>
<body>
    <div class="main-container">
        <!-- Katman Paneli -->
        <div class="layer-panel">
            <div class="panel-header">
                <h2>
                    <span style="font-size: 18px; color: #ffc107;">🗂️</span>
                    Katmanlar
                </h2>
                <div class="header-actions">
                    <button class="filter-btn" onclick="toggleLayerFilter()" title="Filtrele">
                        <span style="font-size: 14px;">🔍</span>
                    </button>
                </div>
            </div>

            <!-- Arama ve Filtre -->
            <div class="search-filter-panel" id="searchFilterPanel" style="display: none;">
                <div style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                    <input type="text" id="layerSearch" placeholder="Katman ara..." style="width: 100%; padding: 5px; margin-bottom: 5px;">
                    <!-- Tip seçimi kaldırıldı -->
                </div>
            </div>
            <!-- Seçili Bilgi Paneli -->
            <div class="selected-info-panel" id="selectedInfoPanel" style="display: none; padding: 6px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-light);">
                <!-- Seçili grup/katman bilgisi buraya gelecek -->
            </div>

            <div class="create-buttons">
                <!-- Ana Aksiyon Butonları -->
                <div class="primary-actions">
                    <button class="create-group-btn" onclick="showCreateGroupModal()" title="Yeni Grup Oluştur">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            <path d="M12 11v6"/>
                            <path d="M9 14h6"/>
                        </svg>
                        Grup Ekle
                    </button>
                    <button class="create-layer-btn" onclick="showCreateLayerModal()" title="Yeni Katman Oluştur">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        Katman Ekle
                    </button>
                </div>
                
                <!-- İkincil Aksiyon Butonları -->
                <div class="secondary-actions">
                    <button class="expand-all-btn" onclick="expandAllGroups()" title="Tüm Grupları Aç">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="7,13 12,18 17,13"/>
                            <polyline points="7,6 12,11 17,6"/>
                        </svg>
                        Tümünü Aç
                    </button>
                    <button class="collapse-all-btn" onclick="collapseAllGroups()" title="Tüm Grupları Kapat">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="17,11 12,6 7,11"/>
                            <polyline points="17,18 12,13 7,18"/>
                        </svg>
                        Tümünü Kapat
                    </button>
                </div>

                <!-- Demo Veri ve Tematik Harita Butonları -->
                <div class="demo-actions">
                    <button class="demo-btn" onclick="toggleDemoMenu()" title="Demo Veri ve Tematik Haritalar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                        </svg>
                        Demo Veri
                    </button>
                </div>
            </div>

            <!-- Demo Veri Menüsü -->
            <div class="demo-menu" id="demoMenu" style="display: none;">
                <div class="demo-menu-header">
                    <h4>🎨 Demo Veri ve Tematik Haritalar</h4>
                    <button class="close-btn" onclick="toggleDemoMenu()">×</button>
                </div>
                <div class="demo-menu-content">
                    <div class="demo-section">
                        <h5>📍 Demo Veri Oluştur</h5>
                        <button class="demo-option-btn" onclick="createDemoData('nufus')">
                            👥 Nüfus Dağılımı (5 nokta)
                        </button>
                        <button class="demo-option-btn" onclick="createDemoData('gelir')">
                            💰 Gelir Düzeyi (5 bölge)
                        </button>
                        <button class="demo-option-btn" onclick="createDemoData('kategori')">
                            🏷️ Kategorik Veri (6 obje)
                        </button>
                        <button class="demo-option-btn" onclick="createDemoData('sicaklik')">
                            🌡️ Sıcaklık Haritası (7 nokta)
                        </button>
                    </div>
                    <div class="demo-section">
                        <h5>🎨 Tematik Harita Uygula</h5>
                        <button class="demo-option-btn" onclick="applyThematicMap('quantile')">
                            📊 Değer Aralıkları (Quantile)
                        </button>
                        <button class="demo-option-btn" onclick="applyThematicMap('category')">
                            🎯 Kategorik Renklendirme
                        </button>
                        <button class="demo-option-btn" onclick="applyThematicMap('heatmap')">
                            🔥 Isı Haritası Stili
                        </button>
                        <button class="demo-option-btn danger" onclick="clearDemoData()">
                            🗑️ Tümünü Temizle
                        </button>
                    </div>
                </div>
            </div>
            <div class="layer-list" id="layerList">
                <!-- Temel Harita Grubu -->
                <div class="layer-group" data-group-id="group-1">
                    <div class="group-header">
                        <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                            <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                        </div>
                        <div class="group-select-area" onclick="selectGroup(this)">
                            <span class="group-name">Temel Haritalar</span>
                            <span class="group-count">2</span>
                        </div>
                        <div class="group-toggle-area" onclick="toggleGroup(this)">
                            <span class="group-icon">▼</span>
                        </div>
                    </div>
                    <div class="group-items">
                        <div class="layer-item" draggable="true" data-layer-id="osm-layer">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Harita altlığı">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">OpenStreetMap</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="osm-layer" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Özellikler" onclick="showLayerProperties(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 8V12M12 16H12.01" stroke="white" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="satellite-layer">
                            <input type="checkbox" class="layer-visibility">
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Uydu görüntüsü">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Uydu Görüntüsü</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="satellite-layer" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Özellikler" onclick="showLayerProperties(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 8V12M12 16H12.01" stroke="white" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vektör Veri Grubu -->
                <div class="layer-group" data-group-id="group-2">
                    <div class="group-header">
                        <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                            <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                        </div>
                        <div class="group-select-area" onclick="selectGroup(this)">
                            <span class="group-name">Vektör Veriler</span>
                            <span class="group-count">3</span>
                        </div>
                        <div class="group-toggle-area" onclick="toggleGroup(this)">
                            <span class="group-icon">▼</span>
                        </div>
                    </div>
                    <div class="group-items">
                        <div class="layer-item" draggable="true" data-layer-id="province-boundaries">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Poligon verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">İl Sınırları</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="province-boundaries" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21L16.65 16.65"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('polygon')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21L16.65 16.65"/>
                                        <path d="M11 8V14M8 11H14"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="road-network">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-line" title="Çizgi verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M2 8L8 8L12 16L16 16L22 8"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda poligon veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Yol Ağı</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="road-network" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('line')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="city-centers">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon active icon-point" title="Nokta verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda poligon veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Şehir Merkezleri</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="city-centers" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('point')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nesne Tabanlı Veriler -->
                <div class="layer-group" data-group-id="group-3">
                    <div class="group-header">
                        <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                            <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                        </div>
                        <div class="group-select-area" onclick="selectGroup(this)">
                            <span class="group-name">Nesne Verileri</span>
                            <span class="group-count">2</span>
                        </div>
                        <div class="group-toggle-area" onclick="toggleGroup(this)">
                            <span class="group-icon">▼</span>
                        </div>
                    </div>
                    <div class="group-items">
                        <div class="layer-item" draggable="true" data-layer-id="buildings">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon active icon-point" title="Bina noktaları">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Bina poligonları">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Binalar</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="buildings" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="land-use">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Arazi kullanımı">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Arazi Kullanımı</span>
                                <span class="layer-style-mode-indicator custom-mode" data-layer-id="land-use" title="Stil Modu: Özelleştirilmiş">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Çim Alanları Katmanı -->
                        <div class="layer-item" draggable="true" data-layer-id="grass-layer">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Çim alanları" style="color: #77cc33;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Çim Alanları</span>
                                <span class="layer-style-mode-indicator custom-mode" data-layer-id="grass-layer" title="Stil Modu: Özelleştirilmiş">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Harita Alanı -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Status Bar - Koordinat ve Ölçek -->
            <div class="status-bar">
                <div class="status-left">
                    <div class="coordinate-display">
                        <span class="status-label">Koordinat:</span>
                        <div class="coordinate-item" id="coordinateX">X: -</div>
                        <div class="coordinate-item" id="coordinateY">Y: -</div>
                    </div>
                    <div class="scale-display">
                        <span class="status-label">Ölçek:</span>
                        <div class="scale-bar" id="scaleBar"></div>
                        <span class="scale-text" id="scaleText" onclick="toggleScaleSelector(event)" ondblclick="switchToDynamicScale()" title="Tek tık: ölçek seç, Çift tık: dinamik moda geç">1:1,000,000</span>
                        <div class="scale-selector" id="scaleSelector">
                            <div class="scale-option" onclick="setFixedScale(1000)">1:1,000</div>
                            <div class="scale-option" onclick="setFixedScale(2500)">1:2,500</div>
                            <div class="scale-option" onclick="setFixedScale(5000)">1:5,000</div>
                            <div class="scale-option" onclick="setFixedScale(10000)">1:10,000</div>
                            <div class="scale-option" onclick="setFixedScale(25000)">1:25,000</div>
                            <div class="scale-option" onclick="setFixedScale(50000)">1:50,000</div>
                            <div class="scale-option" onclick="setFixedScale(100000)">1:100,000</div>
                            <div class="scale-option" onclick="setFixedScale(250000)">1:250,000</div>
                            <div class="scale-option" onclick="setFixedScale(500000)">1:500,000</div>
                            <div class="scale-option" onclick="setFixedScale(1000000)">1:1,000,000</div>
                            <div class="scale-option" onclick="setDynamicScale()" style="border-top: 1px solid #dee2e6; margin-top: 4px; padding-top: 8px;">
                                <strong>Dinamik Ölçek</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-right">
                    <div class="active-layer-display" id="activeLayerDisplay" style="margin-right: 15px;">
                        <span class="status-label">Aktif Katman:</span>
                        <span id="activeLayerInfo" style="font-weight: 500; color: var(--primary-color);">-</span>
                    </div>
                    <div class="projection-selector">
                        <span class="status-label">Projeksiyon:</span>
                        <select class="projection-select" id="projectionSelect" onchange="changeProjection()">
                            <option value="EPSG:4326">WGS84 (EPSG:4326)</option>
                            <option value="EPSG:3857">Web Mercator (EPSG:3857)</option>
                            <option value="EPSG:5254">ITRF96 / UTM 35N (EPSG:5254)</option>
                            <option value="EPSG:2320">ED50 / TM30 (EPSG:2320)</option>
                            <option value="EPSG:32635">WGS84 / UTM 35N (EPSG:32635)</option>
                            <option value="EPSG:32636">WGS84 / UTM 36N (EPSG:32636)</option>
                        </select>
                    </div>
                </div>
            </div>



            <!-- Context Menu -->
            <div class="context-menu" id="contextMenu">
                <div class="menu-item" onclick="contextMenuAction('zoom')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                    </svg>
                    Zoom
                </div>
                <div class="menu-item" onclick="contextMenuAction('style')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    Stil
                </div>
                <div class="menu-item" onclick="contextMenuAction('properties')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Özellikler
                </div>
                <div class="menu-item" onclick="contextMenuAction('delete')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                    </svg>
                    Sil
                </div>
            </div>
            
            <!-- Lejant Toggle Butonu - Artık çizim araçları ile birlikte -->

            <!-- Lejant Container -->
            <div class="legend-container" id="legendContainer">
                <div class="legend-header" id="legendHeader">
                    <div class="legend-title">Katman Lejantı</div>
                    <div class="legend-controls">
                        <button class="legend-btn" onclick="toggleLegendSettings()" title="Ayarlar" id="legendSettingsBtn">⚙</button>
                        <button class="legend-btn" onclick="toggleLegendContent()" title="Daralt/Genişlet" id="legendCollapseBtn">−</button>
                        <button class="legend-btn" onclick="closeLegend()" title="Kapat">×</button>
                    </div>
                </div>
                <div class="legend-settings" id="legendSettings" style="display: none;">
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showEmptyLayers" onchange="updateLegendContent()">
                        <label for="showEmptyLayers">Boş katmanları göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showTypeLabels" onchange="updateLegendContent()">
                        <label for="showTypeLabels">Çizim tiplerini göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showOnlyVisible" checked onchange="updateLegendContent()">
                        <label for="showOnlyVisible">Sadece görünür katmanları göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showSelectedOnly" onchange="updateLegendContent()">
                        <label for="showSelectedOnly">Sadece seçili katmanı göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <label for="legendSymbolSize">Sembol boyutu:</label>
                        <input type="range" id="legendSymbolSize" min="0.5" max="2" step="0.1" value="1" onchange="updateLegendContent(); updateLegendSymbolSizeDisplay()">
                        <span class="value-display" id="legendSymbolSizeDisplay">1x</span>
                    </div>
                </div>
                <div class="legend-content" id="legendContent">
                    <div id="legendItems">
                        <!-- Lejant öğeleri buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Ölçüm Ayarları Modalı -->
            <div class="modal" id="measurementSettingsModal">
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>
                            <span style="font-size: 18px; margin-right: 8px;">📏</span>
                            Ölçüm Ayarları
                        </h3>
                        <button class="close-btn" onclick="closeMeasurementSettings()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Etiket Pozisyonu Ayarları -->
                        <div class="style-section">
                            <h4>📍 Etiket Pozisyonu</h4>
                            <div class="control-row">
                                <label>Mesafe Etiketleri:</label>
                                <select id="distanceLabelPosition" onchange="updateMeasurementSettings()">
                                    <option value="center">Çizginin Ortası</option>
                                    <option value="above">Çizginin Üstü</option>
                                    <option value="below">Çizginin Altı</option>
                                    <option value="segments">Her Segment Üzerinde</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Alan Etiketleri:</label>
                                <select id="areaLabelPosition" onchange="updateMeasurementSettings()">
                                    <option value="center">Poligonun Ortası</option>
                                    <option value="centroid">Ağırlık Merkezi</option>
                                    <option value="bounds">Sınır Ortası</option>
                                </select>
                            </div>
                        </div>

                        <!-- Etiket Sıklığı Ayarları -->
                        <div class="style-section">
                            <h4>📊 Etiket Sıklığı</h4>
                            <div class="control-row">
                                <label>Segment Etiket Sıklığı:</label>
                                <input type="range" id="segmentLabelFrequency" min="1" max="10" value="3" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="segmentFrequencyValue">3</span>
                            </div>
                            <div class="control-row">
                                <label>Minimum Segment Uzunluğu (m):</label>
                                <input type="range" id="minSegmentLength" min="10" max="1000" value="100" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="minSegmentValue">100</span>
                            </div>
                        </div>

                        <!-- Görünüm Ayarları -->
                        <div class="style-section">
                            <h4>🎨 Görünüm</h4>
                            <div class="control-row">
                                <label>Etiket Boyutu:</label>
                                <input type="range" id="labelSize" min="8" max="18" value="12" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="labelSizeValue">12px</span>
                            </div>
                            <div class="control-row">
                                <label>Etiket Arka Plan:</label>
                                <input type="checkbox" id="labelBackground" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Arka plan göster</span>
                            </div>
                            <div class="control-row">
                                <label>Etiket Rengi:</label>
                                <input type="color" id="labelColor" value="#ffffff" onchange="updateMeasurementSettings()">
                            </div>
                            <div class="control-row">
                                <label>Arka Plan Rengi:</label>
                                <input type="color" id="labelBackgroundColor" value="#000000" onchange="updateMeasurementSettings()">
                            </div>
                        </div>

                        <!-- Birim Ayarları -->
                        <div class="style-section">
                            <h4>📐 Birimler</h4>
                            <div class="control-row">
                                <label>Mesafe Birimi:</label>
                                <select id="distanceUnit" onchange="updateMeasurementSettings()">
                                    <option value="auto">Otomatik (m/km)</option>
                                    <option value="m">Metre (m)</option>
                                    <option value="km">Kilometre (km)</option>
                                    <option value="ft">Feet (ft)</option>
                                    <option value="mi">Mil (mi)</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Alan Birimi:</label>
                                <select id="areaUnit" onchange="updateMeasurementSettings()">
                                    <option value="auto">Otomatik (m²/ha)</option>
                                    <option value="m2">Metrekare (m²)</option>
                                    <option value="ha">Hektar (ha)</option>
                                    <option value="km2">Kilometrekare (km²)</option>
                                    <option value="ac">Acre (ac)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Özel Ayarlar -->
                        <div class="style-section">
                            <h4>⚡ Özel Ayarlar</h4>
                            <div class="control-row">
                                <label>Anlık Güncelleme:</label>
                                <input type="checkbox" id="liveUpdate" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Çizim sırasında etiketleri güncelle</span>
                            </div>
                            <div class="control-row">
                                <label>Toplam Mesafe:</label>
                                <input type="checkbox" id="showTotal" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Toplam mesafeyi göster</span>
                            </div>
                            <div class="control-row">
                                <label>Kısmi Mesafeler:</label>
                                <input type="checkbox" id="showPartial" onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Her segment mesafesini göster</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="resetMeasurementSettings()">Varsayılan</button>
                        <button class="btn btn-primary" onclick="closeMeasurementSettings()">Tamam</button>
                    </div>
                </div>
            </div>

            <!-- Mesaj Konsolu -->
            <div class="message-console" id="messageConsole">
                <div class="console-header">
                    <div class="console-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                            <path d="M19,3H5C3.9,3 3,3.9 3,5V9H5V5H19V19H5V15H3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.9 20.1,3 19,3Z"/>
                            <path d="M10.08,15.58L11.5,17L16.5,12L11.5,7L10.08,8.41L12.67,11H3V13H12.67L10.08,15.58Z"/>
                        </svg>
                        Mesaj Konsolu
                        <span class="message-counter" id="messageCounter">0</span>
                    </div>
                                         <div class="console-controls">
                         <button class="console-btn" onclick="toggleConsoleDock()" title="Alt bara kilitle/Serbest bırak" id="dockBtn">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M16,20H20V16H16M16,14H20V10H16M4,8V4H8V8M10,20H14V16H10M16,8V4H20V8M4,20H8V16H4M4,14H8V10H4M10,8V4H14V8M10,14H14V10H10V14Z"/>
                             </svg>
                         </button>
                         <button class="console-btn" onclick="clearMessageConsole()" title="Temizle">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                             </svg>
                         </button>
                         <button class="console-btn" onclick="toggleConsoleMinimize()" title="Daralt/Genişlet" id="consoleMinimizeBtn">−</button>
                         <button class="console-btn" onclick="toggleMessageConsole()" title="Kapat">×</button>
                     </div>
                </div>
                <div class="console-filters">
                    <label class="filter-label">
                        <input type="checkbox" id="showInfoMessages" checked onchange="filterMessages()">
                        <span class="filter-badge info">Info</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showSuccessMessages" checked onchange="filterMessages()">
                        <span class="filter-badge success">Success</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showWarningMessages" checked onchange="filterMessages()">
                        <span class="filter-badge warning">Warning</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showErrorMessages" checked onchange="filterMessages()">
                        <span class="filter-badge error">Error</span>
                    </label>
                </div>
                <div class="console-content" id="consoleContent">
                    <div class="console-messages" id="consoleMessages">
                        <!-- Mesajlar buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Birleşik Araç Kontrolleri -->
            <div class="map-tools-container">
                <!-- Ölçüm Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Ölçüm</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="startMeasurement('distance')" title="Mesafe Ölç" id="distanceBtn">
                            <span style="font-size: 16px; color: #2ecc71;">📏</span>
                        </button>
                        <button class="tool-btn" onclick="startMeasurement('area')" title="Alan Ölç" id="areaBtn">
                            <span style="font-size: 16px; color: #3498db;">⬟</span>
                        </button>
                        <button class="tool-btn" onclick="clearMeasurements()" title="Ölçümleri Temizle">
                            <span style="font-size: 16px; color: #e74c3c;">🗑️</span>
                        </button>
                        <button class="tool-btn" onclick="openMeasurementSettings()" title="Ölçüm Ayarları">
                            <span style="font-size: 16px; color: #9b59b6;">⚙️</span>
                        </button>
                    </div>
                </div>
                
                <!-- Çizim Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Çizim</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="startDrawing('marker')" title="Nokta Çiz" id="pointBtn">
                            <span style="font-size: 16px; color: #e74c3c;">📍</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('polyline')" title="Çizgi Çiz" id="lineBtn">
                            <span style="font-size: 16px; color: #f39c12;">📏</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('polygon')" title="Poligon Çiz" id="polygonBtn">
                            <span style="font-size: 16px; color: #3498db;">⬟</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('rectangle')" title="Dikdörtgen Çiz" id="rectangleBtn">
                            <span style="font-size: 16px; color: #9b59b6;">⬜</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('circle')" title="Daire Çiz" id="circleBtn">
                            <span style="font-size: 16px; color: #e67e22;">⭕</span>
                        </button>
                    </div>
                </div>
                
                <!-- Düzenleme Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Düzenleme</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="toggleEditMode()" title="Düzenle" id="editBtn">
                            <span style="font-size: 16px; color: #9b59b6;">✏️</span>
                        </button>
                        <button class="tool-btn" onclick="toggleDeleteMode()" title="Sil" id="deleteBtn">
                            <span style="font-size: 16px; color: #e74c3c;">🗑️</span>
                        </button>
                    </div>
                </div>
                
                <!-- Görünüm Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Görünüm</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="toggleLegend()" title="Lejant Aç/Kapat" id="legendBtn">
                            <span style="font-size: 16px; color: #7f8c8d;">📋</span>
                        </button>
                        <button class="tool-btn" onclick="zoomToExtent()" title="Tümüne Zoom" id="zoomExtentBtn">
                            <span style="font-size: 16px; color: #2ecc71;">🔍</span>
                        </button>
                        <button class="tool-btn" onclick="toggleFullscreen()" title="Tam Ekran" id="fullscreenBtn">
                            <span style="font-size: 16px; color: #34495e;">⛶</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <!-- Grup/Katman Oluşturma Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3 id="createModalTitle">Yeni Oluştur</h3>
                <button class="close-btn" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="style-section">
                    <h4 id="createModalSubtitle">Ad</h4>
                    <div class="control-row">
                        <input type="text" id="createNameInput" placeholder="Ad giriniz..." style="width: 100%; padding: 10px; border: 2px solid #2196f3; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div class="control-row" id="groupSelectRow" style="display: none; margin-top: 10px;">
                        <label>Hedef Grup:</label>
                        <select id="targetGroupSelect" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">İptal</button>
                <button class="btn btn-primary" id="createModalConfirm" onclick="confirmCreate()">Oluştur</button>
            </div>
        </div>
    </div>

    <!-- Stil Ayarları Modal -->
    <div class="modal" id="styleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Stil Ayarları</h3>
                <button class="close-btn" onclick="closeStyleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Ayar Modu Seçici -->
                <div class="style-section" style="border-bottom: 2px solid #dee2e6; margin-bottom: 15px; padding-bottom: 10px;">
                    <div class="control-row">
                        <label style="font-weight: 600; color: #495057;">Ayar Modu:</label>
                        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
                            <select id="styleMode" style="flex: 1; padding: 5px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="default">Varsayılan Değerler</option>
                                <option value="custom">Kullanıcı Özel Ayarları</option>
                            </select>
                            <button id="styleModeToggle" 
                                    class="style-mode-toggle" 
                                    onclick="toggleStyleMode()" 
                                    title="Stil Modunu Değiştir">
                                <span id="styleModeIcon">🏢</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="style-tabs">
                    <button class="style-tab active" onclick="switchTab('style')">Stil</button>
                    <button class="style-tab" onclick="switchTab('label')">Etiket</button>
                    <button class="style-tab" onclick="switchTab('theme')">Tema</button>
                </div>

                <div id="styleContent">
                    <!-- Nokta Stili -->
                    <div class="style-section" id="pointStyle">
                        <h4>Nokta Görünümü</h4>
                        <div class="control-row">
                            <label>Stil Tipi:</label>
                            <select id="pointStyleType">
                                <option value="custom">Özel Tasarım</option>
                                <option value="icon">Hazır İkon</option>
                            </select>
                        </div>
                        
                        <!-- Özel Tasarım Seçenekleri -->
                        <div id="customPointOptions">
                            <div class="control-row">
                                <label>Renk:</label>
                                <input type="color" id="pointColor" value="#ff0000">
                            </div>
                            <div class="control-row">
                                <label>Boyut:</label>
                                <input type="range" id="pointSize" min="4" max="20" value="8">
                                <span class="value-display">8px</span>
                            </div>
                            <div class="control-row">
                                <label>Şekil:</label>
                                <select id="pointShape">
                                    <option value="circle">Daire</option>
                                    <option value="square">Kare</option>
                                    <option value="triangle">Üçgen</option>
                                    <option value="star">Yıldız</option>
                                    <option value="diamond">Elmas</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Saydamlık:</label>
                                <input type="range" id="pointOpacity" min="0" max="100" value="100">
                                <span class="value-display">100%</span>
                            </div>
                        </div>
                        
                        <!-- Hazır İkon Seçenekleri -->
                        <div id="iconPointOptions" style="display: none;">
                            <div class="control-row">
                                <label>İkon Kategorisi:</label>
                                <select id="iconCategory">
                                    <option value="location">Konum</option>
                                    <option value="transport">Ulaşım</option>
                                    <option value="service">Hizmet</option>
                                    <option value="nature">Doğa</option>
                                    <option value="building">Yapı</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>İkon Seçimi:</label>
                                <div class="icon-grid" id="iconGrid">
                                    <!-- İkonlar dinamik olarak buraya eklenecek -->
                                </div>
                            </div>
                            <div class="control-row">
                                <label>İkon Boyutu:</label>
                                <input type="range" id="iconSize" min="16" max="48" value="24">
                                <span class="value-display">24px</span>
                            </div>
                        </div>
                    </div>

                    <!-- Çizgi Stili -->
                    <div class="style-section" id="lineStyle">
                        <h4>Çizgi Görünümü</h4>
                        <div class="control-row">
                            <label>Renk:</label>
                            <input type="color" id="lineColor" value="#ff7800">
                        </div>
                        <div class="control-row">
                            <label>Kalınlık:</label>
                            <input type="range" id="lineWidth" min="1" max="10" value="3">
                            <span class="value-display">3px</span>
                        </div>
                        <div class="control-row">
                            <label>Saydamlık:</label>
                            <input type="range" id="lineOpacity" min="0" max="100" value="100">
                            <span class="value-display">100%</span>
                        </div>
                        <div class="control-row">
                            <label>Çizgi Tipi:</label>
                            <select id="lineType">
                                <option value="solid">Düz</option>
                                <option value="dashed">Kesikli</option>
                                <option value="dotted">Noktalı</option>
                                <option value="dashDot">Kesik-Nokta</option>
                            </select>
                        </div>
                    </div>

                    <!-- Poligon Stili -->
                    <div class="style-section" id="polygonStyle">
                        <h4>Poligon Görünümü</h4>
                        <div class="control-row">
                            <label>Dolgu Rengi:</label>
                            <input type="color" id="fillColor" value="#3388ff">
                        </div>
                        <div class="control-row">
                            <label>Dolgu Saydamlık:</label>
                            <input type="range" id="fillOpacity" min="0" max="100" value="50">
                            <span class="value-display">50%</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Rengi:</label>
                            <input type="color" id="strokeColor" value="#000000">
                        </div>
                        <div class="control-row">
                            <label>Kenar Kalınlığı:</label>
                            <input type="range" id="strokeWidth" min="0" max="5" value="1">
                            <span class="value-display">1px</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Saydamlık:</label>
                            <input type="range" id="strokeOpacity" min="0" max="100" value="100">
                            <span class="value-display">100%</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Tipi:</label>
                            <select id="strokeType">
                                <option value="solid">Düz</option>
                                <option value="dashed">Kesikli</option>
                                <option value="dotted">Noktalı</option>
                            </select>
                        </div>
                    </div>
                    
                    
                </div>

                <div id="labelContent" style="display: none;">
                    <div class="style-section">
                        <h4>Etiket Ayarları</h4>
                        <div class="control-row">
                            <label>Etiket Göster:</label>
                            <input type="checkbox" id="showLabels" style="margin-left: 10px;">
                        </div>
                        <div class="control-row">
                            <label>Etiket Alanı:</label>
                            <select id="labelField">
                                <option value="">Seçiniz</option>
                                <option value="name">İsim</option>
                                <option value="id">ID</option>
                                <option value="type">Tip</option>
                                <option value="area">Alan (m²)</option>
                                <option value="length">Uzunluk (m)</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Font Boyutu:</label>
                            <input type="range" id="fontSize" min="8" max="24" value="12">
                            <span class="value-display">12px</span>
                        </div>
                        <div class="control-row">
                            <label>Font Rengi:</label>
                            <input type="color" id="fontColor" value="#000000">
                        </div>
                        <div class="control-row">
                            <label>Halo Rengi:</label>
                            <input type="color" id="haloColor" value="#ffffff">
                        </div>
                        <div class="control-row">
                            <label>Halo Kalınlığı:</label>
                            <input type="range" id="haloWidth" min="0" max="5" value="1">
                            <span class="value-display">1px</span>
                        </div>
                        <div class="control-row">
                            <label>Etiket Konumu:</label>
                            <select id="labelPosition">
                                <option value="center">Merkez</option>
                                <option value="top">Üst</option>
                                <option value="bottom">Alt</option>
                                <option value="left">Sol</option>
                                <option value="right">Sağ</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <button class="btn btn-secondary" onclick="generateRandomNames()" style="margin-top: 10px;">
                                🎲 Rastgele İsimler Ata
                            </button>
                        </div>
                    </div>
                </div>

                <div id="themeContent" style="display: none;">
                    <div class="style-section">
                        <h4>Tematik Harita Ayarları</h4>
                        <div class="control-row">
                            <label>Sınıflandırma Alanı:</label>
                            <select id="classField">
                                <option value="">Seçiniz</option>
                                <option value="population">Nüfus</option>
                                <option value="area">Alan</option>
                                <option value="density">Yoğunluk</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Sınıflandırma Metodu:</label>
                            <select id="classMethod">
                                <option value="equal">Eşit Aralık</option>
                                <option value="quantile">Kantil</option>
                                <option value="natural">Doğal Kırılımlar</option>
                                <option value="manual">Manuel</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Sınıf Sayısı:</label>
                            <input type="range" id="classCount" min="3" max="9" value="5">
                            <span class="value-display">5</span>
                        </div>
                        <div class="control-row">
                            <label>Renk Paleti:</label>
                            <select id="colorPalette">
                                <option value="sequential">Ardışık</option>
                                <option value="diverging">Ayrılan</option>
                                <option value="qualitative">Niteliksel</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStyleModal()">İptal</button>
                <button class="btn btn-primary" onclick="saveAndCloseStyle()">Kaydet & Kapat</button>
            </div>
        </div>
    </div>

    <!-- Sorgu Modal -->
    <div class="modal" id="queryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sorgu</h3>
                <button class="close-btn" onclick="closeQueryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="style-tabs">
                    <button class="style-tab active" onclick="switchQueryTab('basic')">Temel</button>
                    <button class="style-tab" onclick="switchQueryTab('advanced')">Gelişmiş</button>
                </div>
                
                <div id="basicQueryContent">
                    <div class="style-section">
                        <h4>Temel Sorgu</h4>
                        <div class="control-row">
                            <label>Alan:</label>
                            <select id="queryField">
                                <option value="">Seçiniz</option>
                                <option value="name">Ad</option>
                                <option value="type">Tip</option>
                                <option value="area">Alan</option>
                                <option value="population">Nüfus</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Operatör:</label>
                            <select id="queryOperator">
                                <option value="equals">Eşittir</option>
                                <option value="notEquals">Eşit Değildir</option>
                                <option value="contains">İçerir</option>
                                <option value="startsWith">İle Başlar</option>
                                <option value="endsWith">İle Biter</option>
                                <option value="greaterThan">Büyüktür</option>
                                <option value="lessThan">Küçüktür</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Değer:</label>
                            <input type="text" id="queryValue" placeholder="Değer giriniz">
                        </div>
                    </div>
                </div>
                
                <div id="advancedQueryContent" style="display: none;">
                    <div class="style-section">
                        <h4>Gelişmiş Sorgu</h4>
                        <div class="control-row">
                            <label>SQL İfadesi:</label>
                        </div>
                        <div class="control-row">
                            <textarea id="sqlQuery" rows="5" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace;" placeholder="Örnek: alan > 1000 AND tip = 'Konut'"></textarea>
                        </div>
                        <div class="control-row">
                            <small style="color: #6c757d;">Desteklenen operatörler: AND, OR, =, !=, >, <, >=, <=, LIKE</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQueryModal()">İptal</button>
                <button class="btn btn-primary" onclick="applyQuery()">Sorgula</button>
            </div>
        </div>
    </div>

    <!-- Katman Detayları Modal -->
    <div class="layer-details-modal" id="layerDetailsModal">
        <div class="layer-details-content">
            <div class="layer-details-header">
                <h3>Katman Detayları: <span id="layerDetailName"></span></h3>
                <button class="close-btn" onclick="closeLayerDetailsModal()">&times;</button>
            </div>
            <div class="layer-details-body">
                <div id="featuresContainer">
                    <!-- Çizim detayları burada listelenecek -->
                </div>
            </div>
            <div class="layer-details-footer">
                <button class="btn btn-secondary" onclick="closeLayerDetailsModal()">Kapat</button>
                <button class="btn btn-primary" onclick="addFeatureToLayer()">Yeni Çizim Ekle</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS - Embedded -->
/* @preserve
 * Leaflet 1.9.4, a JS library for interactive maps. https://leafletjs.com
 * (c) 2010-2023 Vladimir Agafonkin, (c) 2010-2011 CloudMade
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).leaflet={})}(this,function(t){"use strict";function l(t){for(var e,i,n=1,o=arguments.length;n<o;n++)for(e in i=arguments[n])t[e]=i[e];return t}var R=Object.create||function(t){return N.prototype=t,new N};function N(){}function a(t,e){var i,n=Array.prototype.slice;return t.bind?t.bind.apply(t,n.call(arguments,1)):(i=n.call(arguments,2),function(){return t.apply(e,i.length?i.concat(n.call(arguments)):arguments)})}var D=0;function h(t){return"_leaflet_id"in t||(t._leaflet_id=++D),t._leaflet_id}function j(t,e,i){var n,o,s=function(){n=!1,o&&(r.apply(i,o),o=!1)},r=function(){n?o=arguments:(t.apply(i,arguments),setTimeout(s,e),n=!0)};return r}function H(t,e,i){var n=e[1],e=e[0],o=n-e;return t===n&&i?t:((t-e)%o+o)%o+e}function u(){return!1}function i(t,e){return!1===e?t:(e=Math.pow(10,void 0===e?6:e),Math.round(t*e)/e)}function W(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function F(t){return W(t).split(/\s+/)}function c(t,e){for(var i in Object.prototype.hasOwnProperty.call(t,"options")||(t.options=t.options?R(t.options):{}),e)t.options[i]=e[i];return t.options}function U(t,e,i){var n,o=[];for(n in t)o.push(encodeURIComponent(i?n.toUpperCase():n)+"="+encodeURIComponent(t[n]));return(e&&-1!==e.indexOf("?")?"&":"?")+o.join("&")}var V=/\{ *([\w_ -]+) *\}/g;function q(t,i){return t.replace(V,function(t,e){e=i[e];if(void 0===e)throw new Error("No value provided for variable "+t);return e="function"==typeof e?e(i):e})}var d=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function G(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return i;return-1}var K="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";function Y(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}var X=0;function J(t){var e=+new Date,i=Math.max(0,16-(e-X));return X=e+i,window.setTimeout(t,i)}var $=window.requestAnimationFrame||Y("RequestAnimationFrame")||J,Q=window.cancelAnimationFrame||Y("CancelAnimationFrame")||Y("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)};function x(t,e,i){if(!i||$!==J)return $.call(window,a(t,e));t.call(e)}function r(t){t&&Q.call(window,t)}var tt={__proto__:null,extend:l,create:R,bind:a,get lastId(){return D},stamp:h,throttle:j,wrapNum:H,falseFn:u,formatNum:i,trim:W,splitWords:F,setOptions:c,getParamString:U,template:q,isArray:d,indexOf:G,emptyImageUrl:K,requestFn:$,cancelFn:Q,requestAnimFrame:x,cancelAnimFrame:r};function et(){}et.extend=function(t){function e(){c(this),this.initialize&&this.initialize.apply(this,arguments),this.callInitHooks()}var i,n=e.__super__=this.prototype,o=R(n);for(i in(o.constructor=e).prototype=o,this)Object.prototype.hasOwnProperty.call(this,i)&&"prototype"!==i&&"__super__"!==i&&(e[i]=this[i]);if(t.statics&&l(e,t.statics),t.includes){var s=t.includes;if("undefined"!=typeof L&&L&&L.Mixin){s=d(s)?s:[s];for(var r=0;r<s.length;r++)s[r]===L.Mixin.Events&&console.warn("Deprecated include of L.Mixin.Events: this property will be removed in future releases, please inherit from L.Evented instead.",(new Error).stack)}l.apply(null,[o].concat(t.includes))}return l(o,t),delete o.statics,delete o.includes,o.options&&(o.options=n.options?R(n.options):{},l(o.options,t.options)),o._initHooks=[],o.callInitHooks=function(){if(!this._initHooksCalled){n.callInitHooks&&n.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=o._initHooks.length;t<e;t++)o._initHooks[t].call(this)}},e},et.include=function(t){var e=this.prototype.options;return l(this.prototype,t),t.options&&(this.prototype.options=e,this.mergeOptions(t.options)),this},et.mergeOptions=function(t){return l(this.prototype.options,t),this},et.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i),this};var e={on:function(t,e,i){if("object"==typeof t)for(var n in t)this._on(n,t[n],e);else for(var o=0,s=(t=F(t)).length;o<s;o++)this._on(t[o],e,i);return this},off:function(t,e,i){if(arguments.length)if("object"==typeof t)for(var n in t)this._off(n,t[n],e);else{t=F(t);for(var o=1===arguments.length,s=0,r=t.length;s<r;s++)o?this._off(t[s]):this._off(t[s],e,i)}else delete this._events;return this},_on:function(t,e,i,n){"function"!=typeof e?console.warn("wrong listener type: "+typeof e):!1===this._listens(t,e,i)&&(e={fn:e,ctx:i=i===this?void 0:i},n&&(e.once=!0),this._events=this._events||{},this._events[t]=this._events[t]||[],this._events[t].push(e))},_off:function(t,e,i){var n,o,s;if(this._events&&(n=this._events[t]))if(1===arguments.length){if(this._firingCount)for(o=0,s=n.length;o<s;o++)n[o].fn=u;delete this._events[t]}else"function"!=typeof e?console.warn("wrong listener type: "+typeof e):!1!==(e=this._listens(t,e,i))&&(i=n[e],this._firingCount&&(i.fn=u,this._events[t]=n=n.slice()),n.splice(e,1))},fire:function(t,e,i){if(this.listens(t,i)){var n=l({},e,{type:t,target:this,sourceTarget:e&&e.sourceTarget||this});if(this._events){var o=this._events[t];if(o){this._firingCount=this._firingCount+1||1;for(var s=0,r=o.length;s<r;s++){var a=o[s],h=a.fn;a.once&&this.off(t,h,a.ctx),h.call(a.ctx||this,n)}this._firingCount--}}i&&this._propagateEvent(n)}return this},listens:function(t,e,i,n){"string"!=typeof t&&console.warn('"string" type argument expected');var o=e,s=("function"!=typeof e&&(n=!!e,i=o=void 0),this._events&&this._events[t]);if(s&&s.length&&!1!==this._listens(t,o,i))return!0;if(n)for(var r in this._eventParents)if(this._eventParents[r].listens(t,e,i,n))return!0;return!1},_listens:function(t,e,i){if(this._events){var n=this._events[t]||[];if(!e)return!!n.length;i===this&&(i=void 0);for(var o=0,s=n.length;o<s;o++)if(n[o].fn===e&&n[o].ctx===i)return o}return!1},once:function(t,e,i){if("object"==typeof t)for(var n in t)this._on(n,t[n],e,!0);else for(var o=0,s=(t=F(t)).length;o<s;o++)this._on(t[o],e,i,!0);return this},addEventParent:function(t){return this._eventParents=this._eventParents||{},this._eventParents[h(t)]=t,this},removeEventParent:function(t){return this._eventParents&&delete this._eventParents[h(t)],this},_propagateEvent:function(t){for(var e in this._eventParents)this._eventParents[e].fire(t.type,l({layer:t.target,propagatedFrom:t.target},t),!0)}},it=(e.addEventListener=e.on,e.removeEventListener=e.clearAllEventListeners=e.off,e.addOneTimeEventListener=e.once,e.fireEvent=e.fire,e.hasEventListeners=e.listens,et.extend(e));function p(t,e,i){this.x=i?Math.round(t):t,this.y=i?Math.round(e):e}var nt=Math.trunc||function(t){return 0<t?Math.floor(t):Math.ceil(t)};function m(t,e,i){return t instanceof p?t:d(t)?new p(t[0],t[1]):null==t?t:"object"==typeof t&&"x"in t&&"y"in t?new p(t.x,t.y):new p(t,e,i)}function f(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;n<o;n++)this.extend(i[n])}function _(t,e){return!t||t instanceof f?t:new f(t,e)}function s(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;n<o;n++)this.extend(i[n])}function g(t,e){return t instanceof s?t:new s(t,e)}function v(t,e,i){if(isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=+t,this.lng=+e,void 0!==i&&(this.alt=+i)}function w(t,e,i){return t instanceof v?t:d(t)&&"object"!=typeof t[0]?3===t.length?new v(t[0],t[1],t[2]):2===t.length?new v(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new v(t.lat,"lng"in t?t.lng:t.lon,t.alt):void 0===e?null:new v(t,e,i)}p.prototype={clone:function(){return new p(this.x,this.y)},add:function(t){return this.clone()._add(m(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(m(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},scaleBy:function(t){return new p(this.x*t.x,this.y*t.y)},unscaleBy:function(t){return new p(this.x/t.x,this.y/t.y)},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.clone()._ceil()},_ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},trunc:function(){return this.clone()._trunc()},_trunc:function(){return this.x=nt(this.x),this.y=nt(this.y),this},distanceTo:function(t){var e=(t=m(t)).x-this.x,t=t.y-this.y;return Math.sqrt(e*e+t*t)},equals:function(t){return(t=m(t)).x===this.x&&t.y===this.y},contains:function(t){return t=m(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+i(this.x)+", "+i(this.y)+")"}},f.prototype={extend:function(t){var e,i;if(t){if(t instanceof p||"number"==typeof t[0]||"x"in t)e=i=m(t);else if(e=(t=_(t)).min,i=t.max,!e||!i)return this;this.min||this.max?(this.min.x=Math.min(e.x,this.min.x),this.max.x=Math.max(i.x,this.max.x),this.min.y=Math.min(e.y,this.min.y),this.max.y=Math.max(i.y,this.max.y)):(this.min=e.clone(),this.max=i.clone())}return this},getCenter:function(t){return m((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return m(this.min.x,this.max.y)},getTopRight:function(){return m(this.max.x,this.min.y)},getTopLeft:function(){return this.min},getBottomRight:function(){return this.max},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,i;return(t=("number"==typeof t[0]||t instanceof p?m:_)(t))instanceof f?(e=t.min,i=t.max):e=i=t,e.x>=this.min.x&&i.x<=this.max.x&&e.y>=this.min.y&&i.y<=this.max.y},intersects:function(t){t=_(t);var e=this.min,i=this.max,n=t.min,t=t.max,o=t.x>=e.x&&n.x<=i.x,t=t.y>=e.y&&n.y<=i.y;return o&&t},overlaps:function(t){t=_(t);var e=this.min,i=this.max,n=t.min,t=t.max,o=t.x>e.x&&n.x<i.x,t=t.y>e.y&&n.y<i.y;return o&&t},isValid:function(){return!(!this.min||!this.max)},pad:function(t){var e=this.min,i=this.max,n=Math.abs(e.x-i.x)*t,t=Math.abs(e.y-i.y)*t;return _(m(e.x-n,e.y-t),m(i.x+n,i.y+t))},equals:function(t){return!!t&&(t=_(t),this.min.equals(t.getTopLeft())&&this.max.equals(t.getBottomRight()))}},s.prototype={extend:function(t){var e,i,n=this._southWest,o=this._northEast;if(t instanceof v)i=e=t;else{if(!(t instanceof s))return t?this.extend(w(t)||g(t)):this;if(e=t._southWest,i=t._northEast,!e||!i)return this}return n||o?(n.lat=Math.min(e.lat,n.lat),n.lng=Math.min(e.lng,n.lng),o.lat=Math.max(i.lat,o.lat),o.lng=Math.max(i.lng,o.lng)):(this._southWest=new v(e.lat,e.lng),this._northEast=new v(i.lat,i.lng)),this},pad:function(t){var e=this._southWest,i=this._northEast,n=Math.abs(e.lat-i.lat)*t,t=Math.abs(e.lng-i.lng)*t;return new s(new v(e.lat-n,e.lng-t),new v(i.lat+n,i.lng+t))},getCenter:function(){return new v((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new v(this.getNorth(),this.getWest())},getSouthEast:function(){return new v(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t=("number"==typeof t[0]||t instanceof v||"lat"in t?w:g)(t);var e,i,n=this._southWest,o=this._northEast;return t instanceof s?(e=t.getSouthWest(),i=t.getNorthEast()):e=i=t,e.lat>=n.lat&&i.lat<=o.lat&&e.lng>=n.lng&&i.lng<=o.lng},intersects:function(t){t=g(t);var e=this._southWest,i=this._northEast,n=t.getSouthWest(),t=t.getNorthEast(),o=t.lat>=e.lat&&n.lat<=i.lat,t=t.lng>=e.lng&&n.lng<=i.lng;return o&&t},overlaps:function(t){t=g(t);var e=this._southWest,i=this._northEast,n=t.getSouthWest(),t=t.getNorthEast(),o=t.lat>e.lat&&n.lat<i.lat,t=t.lng>e.lng&&n.lng<i.lng;return o&&t},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t,e){return!!t&&(t=g(t),this._southWest.equals(t.getSouthWest(),e)&&this._northEast.equals(t.getNorthEast(),e))},isValid:function(){return!(!this._southWest||!this._northEast)}};var ot={latLngToPoint:function(t,e){t=this.projection.project(t),e=this.scale(e);return this.transformation._transform(t,e)},pointToLatLng:function(t,e){e=this.scale(e),t=this.transformation.untransform(t,e);return this.projection.unproject(t)},project:function(t){return this.projection.project(t)},unproject:function(t){return this.projection.unproject(t)},scale:function(t){return 256*Math.pow(2,t)},zoom:function(t){return Math.log(t/256)/Math.LN2},getProjectedBounds:function(t){var e;return this.infinite?null:(e=this.projection.bounds,t=this.scale(t),new f(this.transformation.transform(e.min,t),this.transformation.transform(e.max,t)))},infinite:!(v.prototype={equals:function(t,e){return!!t&&(t=w(t),Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng))<=(void 0===e?1e-9:e))},toString:function(t){return"LatLng("+i(this.lat,t)+", "+i(this.lng,t)+")"},distanceTo:function(t){return st.distance(this,w(t))},wrap:function(){return st.wrapLatLng(this)},toBounds:function(t){var t=180*t/40075017,e=t/Math.cos(Math.PI/180*this.lat);return g([this.lat-t,this.lng-e],[this.lat+t,this.lng+e])},clone:function(){return new v(this.lat,this.lng,this.alt)}}),wrapLatLng:function(t){var e=this.wrapLng?H(t.lng,this.wrapLng,!0):t.lng;return new v(this.wrapLat?H(t.lat,this.wrapLat,!0):t.lat,e,t.alt)},wrapLatLngBounds:function(t){var e=t.getCenter(),i=this.wrapLatLng(e),n=e.lat-i.lat,e=e.lng-i.lng;return 0==n&&0==e?t:(i=t.getSouthWest(),t=t.getNorthEast(),new s(new v(i.lat-n,i.lng-e),new v(t.lat-n,t.lng-e)))}},st=l({},ot,{wrapLng:[-180,180],R:6371e3,distance:function(t,e){var i=Math.PI/180,n=t.lat*i,o=e.lat*i,s=Math.sin((e.lat-t.lat)*i/2),e=Math.sin((e.lng-t.lng)*i/2),t=s*s+Math.cos(n)*Math.cos(o)*e*e,i=2*Math.atan2(Math.sqrt(t),Math.sqrt(1-t));return this.R*i}}),rt=6378137,rt={R:rt,MAX_LATITUDE:85.0511287798,project:function(t){var e=Math.PI/180,i=this.MAX_LATITUDE,i=Math.max(Math.min(i,t.lat),-i),i=Math.sin(i*e);return new p(this.R*t.lng*e,this.R*Math.log((1+i)/(1-i))/2)},unproject:function(t){var e=180/Math.PI;return new v((2*Math.atan(Math.exp(t.y/this.R))-Math.PI/2)*e,t.x*e/this.R)},bounds:new f([-(rt=rt*Math.PI),-rt],[rt,rt])};function at(t,e,i,n){d(t)?(this._a=t[0],this._b=t[1],this._c=t[2],this._d=t[3]):(this._a=t,this._b=e,this._c=i,this._d=n)}function ht(t,e,i,n){return new at(t,e,i,n)}at.prototype={transform:function(t,e){return this._transform(t.clone(),e)},_transform:function(t,e){return t.x=(e=e||1)*(this._a*t.x+this._b),t.y=e*(this._c*t.y+this._d),t},untransform:function(t,e){return new p((t.x/(e=e||1)-this._b)/this._a,(t.y/e-this._d)/this._c)}};var lt=l({},st,{code:"EPSG:3857",projection:rt,transformation:ht(lt=.5/(Math.PI*rt.R),.5,-lt,.5)}),ut=l({},lt,{code:"EPSG:900913"});function ct(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function dt(t,e){for(var i,n,o,s,r="",a=0,h=t.length;a<h;a++){for(i=0,n=(o=t[a]).length;i<n;i++)r+=(i?"L":"M")+(s=o[i]).x+" "+s.y;r+=e?b.svg?"z":"x":""}return r||"M0 0"}var _t=document.documentElement.style,pt="ActiveXObject"in window,mt=pt&&!document.addEventListener,n="msLaunchUri"in navigator&&!("documentMode"in document),ft=y("webkit"),gt=y("android"),vt=y("android 2")||y("android 3"),yt=parseInt(/WebKit\/([0-9]+)|$/.exec(navigator.userAgent)[1],10),yt=gt&&y("Google")&&yt<537&&!("AudioNode"in window),xt=!!window.opera,wt=!n&&y("chrome"),bt=y("gecko")&&!ft&&!xt&&!pt,Pt=!wt&&y("safari"),Lt=y("phantom"),o="OTransition"in _t,Tt=0===navigator.platform.indexOf("Win"),Mt=pt&&"transition"in _t,zt="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!vt,_t="MozPerspective"in _t,Ct=!window.L_DISABLE_3D&&(Mt||zt||_t)&&!o&&!Lt,Zt="undefined"!=typeof orientation||y("mobile"),St=Zt&&ft,Et=Zt&&zt,kt=!window.PointerEvent&&window.MSPointerEvent,Ot=!(!window.PointerEvent&&!kt),At="ontouchstart"in window||!!window.TouchEvent,Bt=!window.L_NO_TOUCH&&(At||Ot),It=Zt&&xt,Rt=Zt&&bt,Nt=1<(window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI),Dt=function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("testPassiveEventSupport",u,e),window.removeEventListener("testPassiveEventSupport",u,e)}catch(t){}return t}(),jt=!!document.createElement("canvas").getContext,Ht=!(!document.createElementNS||!ct("svg").createSVGRect),Wt=!!Ht&&((Wt=document.createElement("div")).innerHTML="<svg/>","http://www.w3.org/2000/svg"===(Wt.firstChild&&Wt.firstChild.namespaceURI));function y(t){return 0<=navigator.userAgent.toLowerCase().indexOf(t)}var b={ie:pt,ielt9:mt,edge:n,webkit:ft,android:gt,android23:vt,androidStock:yt,opera:xt,chrome:wt,gecko:bt,safari:Pt,phantom:Lt,opera12:o,win:Tt,ie3d:Mt,webkit3d:zt,gecko3d:_t,any3d:Ct,mobile:Zt,mobileWebkit:St,mobileWebkit3d:Et,msPointer:kt,pointer:Ot,touch:Bt,touchNative:At,mobileOpera:It,mobileGecko:Rt,retina:Nt,passiveEvents:Dt,canvas:jt,svg:Ht,vml:!Ht&&function(){try{var t=document.createElement("div"),e=(t.innerHTML='<v:shape adj="1"/>',t.firstChild);return e.style.behavior="url(#default#VML)",e&&"object"==typeof e.adj}catch(t){return!1}}(),inlineSvg:Wt,mac:0===navigator.platform.indexOf("Mac"),linux:0===navigator.platform.indexOf("Linux")},Ft=b.msPointer?"MSPointerDown":"pointerdown",Ut=b.msPointer?"MSPointerMove":"pointermove",Vt=b.msPointer?"MSPointerUp":"pointerup",qt=b.msPointer?"MSPointerCancel":"pointercancel",Gt={touchstart:Ft,touchmove:Ut,touchend:Vt,touchcancel:qt},Kt={touchstart:function(t,e){e.MSPOINTER_TYPE_TOUCH&&e.pointerType===e.MSPOINTER_TYPE_TOUCH&&O(e);ee(t,e)},touchmove:ee,touchend:ee,touchcancel:ee},Yt={},Xt=!1;function Jt(t,e,i){return"touchstart"!==e||Xt||(document.addEventListener(Ft,$t,!0),document.addEventListener(Ut,Qt,!0),document.addEventListener(Vt,te,!0),document.addEventListener(qt,te,!0),Xt=!0),Kt[e]?(i=Kt[e].bind(this,i),t.addEventListener(Gt[e],i,!1),i):(console.warn("wrong event specified:",e),u)}function $t(t){Yt[t.pointerId]=t}function Qt(t){Yt[t.pointerId]&&(Yt[t.pointerId]=t)}function te(t){delete Yt[t.pointerId]}function ee(t,e){if(e.pointerType!==(e.MSPOINTER_TYPE_MOUSE||"mouse")){for(var i in e.touches=[],Yt)e.touches.push(Yt[i]);e.changedTouches=[e],t(e)}}var ie=200;function ne(t,i){t.addEventListener("dblclick",i);var n,o=0;function e(t){var e;1!==t.detail?n=t.detail:"mouse"===t.pointerType||t.sourceCapabilities&&!t.sourceCapabilities.firesTouchEvents||((e=Ne(t)).some(function(t){return t instanceof HTMLLabelElement&&t.attributes.for})&&!e.some(function(t){return t instanceof HTMLInputElement||t instanceof HTMLSelectElement})||((e=Date.now())-o<=ie?2===++n&&i(function(t){var e,i,n={};for(i in t)e=t[i],n[i]=e&&e.bind?e.bind(t):e;return(t=n).type="dblclick",n.detail=2,n.isTrusted=!1,n._simulated=!0,n}(t)):n=1,o=e))}return t.addEventListener("click",e),{dblclick:i,simDblclick:e}}var oe,se,re,ae,he,le,ue=we(["transform","webkitTransform","OTransform","MozTransform","msTransform"]),ce=we(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),de="webkitTransition"===ce||"OTransition"===ce?ce+"End":"transitionend";function _e(t){return"string"==typeof t?document.getElementById(t):t}function pe(t,e){var i=t.style[e]||t.currentStyle&&t.currentStyle[e];return"auto"===(i=i&&"auto"!==i||!document.defaultView?i:(t=document.defaultView.getComputedStyle(t,null))?t[e]:null)?null:i}function P(t,e,i){t=document.createElement(t);return t.className=e||"",i&&i.appendChild(t),t}function T(t){var e=t.parentNode;e&&e.removeChild(t)}function me(t){for(;t.firstChild;)t.removeChild(t.firstChild)}function fe(t){var e=t.parentNode;e&&e.lastChild!==t&&e.appendChild(t)}function ge(t){var e=t.parentNode;e&&e.firstChild!==t&&e.insertBefore(t,e.firstChild)}function ve(t,e){return void 0!==t.classList?t.classList.contains(e):0<(t=xe(t)).length&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(t)}function M(t,e){var i;if(void 0!==t.classList)for(var n=F(e),o=0,s=n.length;o<s;o++)t.classList.add(n[o]);else ve(t,e)||ye(t,((i=xe(t))?i+" ":"")+e)}function z(t,e){void 0!==t.classList?t.classList.remove(e):ye(t,W((" "+xe(t)+" ").replace(" "+e+" "," ")))}function ye(t,e){void 0===t.className.baseVal?t.className=e:t.className.baseVal=e}function xe(t){return void 0===(t=t.correspondingElement?t.correspondingElement:t).className.baseVal?t.className:t.className.baseVal}function C(t,e){if("opacity"in t.style)t.style.opacity=e;else if("filter"in t.style){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(t){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"}}function we(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1}function be(t,e,i){e=e||new p(0,0);t.style[ue]=(b.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(i?" scale("+i+")":"")}function Z(t,e){t._leaflet_pos=e,b.any3d?be(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px")}function Pe(t){return t._leaflet_pos||new p(0,0)}function Le(){S(window,"dragstart",O)}function Te(){k(window,"dragstart",O)}function Me(t){for(;-1===t.tabIndex;)t=t.parentNode;t.style&&(ze(),le=(he=t).style.outlineStyle,t.style.outlineStyle="none",S(window,"keydown",ze))}function ze(){he&&(he.style.outlineStyle=le,le=he=void 0,k(window,"keydown",ze))}function Ce(t){for(;!((t=t.parentNode).offsetWidth&&t.offsetHeight||t===document.body););return t}function Ze(t){var e=t.getBoundingClientRect();return{x:e.width/t.offsetWidth||1,y:e.height/t.offsetHeight||1,boundingClientRect:e}}ae="onselectstart"in document?(re=function(){S(window,"selectstart",O)},function(){k(window,"selectstart",O)}):(se=we(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]),re=function(){var t;se&&(t=document.documentElement.style,oe=t[se],t[se]="none")},function(){se&&(document.documentElement.style[se]=oe,oe=void 0)});pt={__proto__:null,TRANSFORM:ue,TRANSITION:ce,TRANSITION_END:de,get:_e,getStyle:pe,create:P,remove:T,empty:me,toFront:fe,toBack:ge,hasClass:ve,addClass:M,removeClass:z,setClass:ye,getClass:xe,setOpacity:C,testProp:we,setTransform:be,setPosition:Z,getPosition:Pe,get disableTextSelection(){return re},get enableTextSelection(){return ae},disableImageDrag:Le,enableImageDrag:Te,preventOutline:Me,restoreOutline:ze,getSizedParentNode:Ce,getScale:Ze};function S(t,e,i,n){if(e&&"object"==typeof e)for(var o in e)ke(t,o,e[o],i);else for(var s=0,r=(e=F(e)).length;s<r;s++)ke(t,e[s],i,n);return this}var E="_leaflet_events";function k(t,e,i,n){if(1===arguments.length)Se(t),delete t[E];else if(e&&"object"==typeof e)for(var o in e)Oe(t,o,e[o],i);else if(e=F(e),2===arguments.length)Se(t,function(t){return-1!==G(e,t)});else for(var s=0,r=e.length;s<r;s++)Oe(t,e[s],i,n);return this}function Se(t,e){for(var i in t[E]){var n=i.split(/\d/)[0];e&&!e(n)||Oe(t,n,null,null,i)}}var Ee={mouseenter:"mouseover",mouseleave:"mouseout",wheel:!("onwheel"in window)&&"mousewheel"};function ke(e,t,i,n){var o,s,r=t+h(i)+(n?"_"+h(n):"");e[E]&&e[E][r]||(s=o=function(t){return i.call(n||e,t||window.event)},!b.touchNative&&b.pointer&&0===t.indexOf("touch")?o=Jt(e,t,o):b.touch&&"dblclick"===t?o=ne(e,o):"addEventListener"in e?"touchstart"===t||"touchmove"===t||"wheel"===t||"mousewheel"===t?e.addEventListener(Ee[t]||t,o,!!b.passiveEvents&&{passive:!1}):"mouseenter"===t||"mouseleave"===t?e.addEventListener(Ee[t],o=function(t){t=t||window.event,We(e,t)&&s(t)},!1):e.addEventListener(t,s,!1):e.attachEvent("on"+t,o),e[E]=e[E]||{},e[E][r]=o)}function Oe(t,e,i,n,o){o=o||e+h(i)+(n?"_"+h(n):"");var s,r,i=t[E]&&t[E][o];i&&(!b.touchNative&&b.pointer&&0===e.indexOf("touch")?(n=t,r=i,Gt[s=e]?n.removeEventListener(Gt[s],r,!1):console.warn("wrong event specified:",s)):b.touch&&"dblclick"===e?(n=i,(r=t).removeEventListener("dblclick",n.dblclick),r.removeEventListener("click",n.simDblclick)):"removeEventListener"in t?t.removeEventListener(Ee[e]||e,i,!1):t.detachEvent("on"+e,i),t[E][o]=null)}function Ae(t){return t.stopPropagation?t.stopPropagation():t.originalEvent?t.originalEvent._stopped=!0:t.cancelBubble=!0,this}function Be(t){return ke(t,"wheel",Ae),this}function Ie(t){return S(t,"mousedown touchstart dblclick contextmenu",Ae),t._leaflet_disable_click=!0,this}function O(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function Re(t){return O(t),Ae(t),this}function Ne(t){if(t.composedPath)return t.composedPath();for(var e=[],i=t.target;i;)e.push(i),i=i.parentNode;return e}function De(t,e){var i,n;return e?(n=(i=Ze(e)).boundingClientRect,new p((t.clientX-n.left)/i.x-e.clientLeft,(t.clientY-n.top)/i.y-e.clientTop)):new p(t.clientX,t.clientY)}var je=b.linux&&b.chrome?window.devicePixelRatio:b.mac?3*window.devicePixelRatio:0<window.devicePixelRatio?2*window.devicePixelRatio:1;function He(t){return b.edge?t.wheelDeltaY/2:t.deltaY&&0===t.deltaMode?-t.deltaY/je:t.deltaY&&1===t.deltaMode?20*-t.deltaY:t.deltaY&&2===t.deltaMode?60*-t.deltaY:t.deltaX||t.deltaZ?0:t.wheelDelta?(t.wheelDeltaY||t.wheelDelta)/2:t.detail&&Math.abs(t.detail)<32765?20*-t.detail:t.detail?t.detail/-32765*60:0}function We(t,e){var i=e.relatedTarget;if(!i)return!0;try{for(;i&&i!==t;)i=i.parentNode}catch(t){return!1}return i!==t}var mt={__proto__:null,on:S,off:k,stopPropagation:Ae,disableScrollPropagation:Be,disableClickPropagation:Ie,preventDefault:O,stop:Re,getPropagationPath:Ne,getMousePosition:De,getWheelDelta:He,isExternalTarget:We,addListener:S,removeListener:k},Fe=it.extend({run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._duration=i||.25,this._easeOutPower=1/Math.max(n||.5,.2),this._startPos=Pe(t),this._offset=e.subtract(this._startPos),this._startTime=+new Date,this.fire("start"),this._animate()},stop:function(){this._inProgress&&(this._step(!0),this._complete())},_animate:function(){this._animId=x(this._animate,this),this._step()},_step:function(t){var e=+new Date-this._startTime,i=1e3*this._duration;e<i?this._runFrame(this._easeOut(e/i),t):(this._runFrame(1),this._complete())},_runFrame:function(t,e){t=this._startPos.add(this._offset.multiplyBy(t));e&&t._round(),Z(this._el,t),this.fire("step")},_complete:function(){r(this._animId),this._inProgress=!1,this.fire("end")},_easeOut:function(t){return 1-Math.pow(1-t,this._easeOutPower)}}),A=it.extend({options:{crs:lt,center:void 0,zoom:void 0,minZoom:void 0,maxZoom:void 0,layers:[],maxBounds:void 0,renderer:void 0,zoomAnimation:!0,zoomAnimationThreshold:4,fadeAnimation:!0,markerZoomAnimation:!0,transform3DLimit:8388608,zoomSnap:1,zoomDelta:1,trackResize:!0},initialize:function(t,e){e=c(this,e),this._handlers=[],this._layers={},this._zoomBoundLayers={},this._sizeChanged=!0,this._initContainer(t),this._initLayout(),this._onResize=a(this._onResize,this),this._initEvents(),e.maxBounds&&this.setMaxBounds(e.maxBounds),void 0!==e.zoom&&(this._zoom=this._limitZoom(e.zoom)),e.center&&void 0!==e.zoom&&this.setView(w(e.center),e.zoom,{reset:!0}),this.callInitHooks(),this._zoomAnimated=ce&&b.any3d&&!b.mobileOpera&&this.options.zoomAnimation,this._zoomAnimated&&(this._createAnimProxy(),S(this._proxy,de,this._catchTransitionEnd,this)),this._addLayers(this.options.layers)},setView:function(t,e,i){if((e=void 0===e?this._zoom:this._limitZoom(e),t=this._limitCenter(w(t),e,this.options.maxBounds),i=i||{},this._stop(),this._loaded&&!i.reset&&!0!==i)&&(void 0!==i.animate&&(i.zoom=l({animate:i.animate},i.zoom),i.pan=l({animate:i.animate,duration:i.duration},i.pan)),this._zoom!==e?this._tryAnimatedZoom&&this._tryAnimatedZoom(t,e,i.zoom):this._tryAnimatedPan(t,i.pan)))return clearTimeout(this._sizeTimer),this;return this._resetView(t,e,i.pan&&i.pan.noMoveStart),this},setZoom:function(t,e){return this._loaded?this.setView(this.getCenter(),t,{zoom:e}):(this._zoom=t,this)},zoomIn:function(t,e){return t=t||(b.any3d?this.options.zoomDelta:1),this.setZoom(this._zoom+t,e)},zoomOut:function(t,e){return t=t||(b.any3d?this.options.zoomDelta:1),this.setZoom(this._zoom-t,e)},setZoomAround:function(t,e,i){var n=this.getZoomScale(e),o=this.getSize().divideBy(2),t=(t instanceof p?t:this.latLngToContainerPoint(t)).subtract(o).multiplyBy(1-1/n),n=this.containerPointToLatLng(o.add(t));return this.setView(n,e,{zoom:i})},_getBoundsCenterZoom:function(t,e){e=e||{},t=t.getBounds?t.getBounds():g(t);var i=m(e.paddingTopLeft||e.padding||[0,0]),n=m(e.paddingBottomRight||e.padding||[0,0]),o=this.getBoundsZoom(t,!1,i.add(n));return(o="number"==typeof e.maxZoom?Math.min(e.maxZoom,o):o)===1/0?{center:t.getCenter(),zoom:o}:(e=n.subtract(i).divideBy(2),n=this.project(t.getSouthWest(),o),i=this.project(t.getNorthEast(),o),{center:this.unproject(n.add(i).divideBy(2).add(e),o),zoom:o})},fitBounds:function(t,e){if((t=g(t)).isValid())return t=this._getBoundsCenterZoom(t,e),this.setView(t.center,t.zoom,e);throw new Error("Bounds are not valid.")},fitWorld:function(t){return this.fitBounds([[-90,-180],[90,180]],t)},panTo:function(t,e){return this.setView(t,this._zoom,{pan:e})},panBy:function(t,e){var i;return e=e||{},(t=m(t).round()).x||t.y?(!0===e.animate||this.getSize().contains(t)?(this._panAnim||(this._panAnim=new Fe,this._panAnim.on({step:this._onPanTransitionStep,end:this._onPanTransitionEnd},this)),e.noMoveStart||this.fire("movestart"),!1!==e.animate?(M(this._mapPane,"leaflet-pan-anim"),i=this._getMapPanePos().subtract(t).round(),this._panAnim.run(this._mapPane,i,e.duration||.25,e.easeLinearity)):(this._rawPanBy(t),this.fire("move").fire("moveend"))):this._resetView(this.unproject(this.project(this.getCenter()).add(t)),this.getZoom()),this):this.fire("moveend")},flyTo:function(n,o,t){if(!1===(t=t||{}).animate||!b.any3d)return this.setView(n,o,t);this._stop();var s=this.project(this.getCenter()),r=this.project(n),e=this.getSize(),a=this._zoom,h=(n=w(n),o=void 0===o?a:o,Math.max(e.x,e.y)),i=h*this.getZoomScale(a,o),l=r.distanceTo(s)||1,u=1.42,c=u*u;function d(t){t=(i*i-h*h+(t?-1:1)*c*c*l*l)/(2*(t?i:h)*c*l),t=Math.sqrt(t*t+1)-t;return t<1e-9?-18:Math.log(t)}function _(t){return(Math.exp(t)-Math.exp(-t))/2}function p(t){return(Math.exp(t)+Math.exp(-t))/2}var m=d(0);function f(t){return h*(p(m)*(_(t=m+u*t)/p(t))-_(m))/c}var g=Date.now(),v=(d(1)-m)/u,y=t.duration?1e3*t.duration:1e3*v*.8;return this._moveStart(!0,t.noMoveStart),function t(){var e=(Date.now()-g)/y,i=(1-Math.pow(1-e,1.5))*v;e<=1?(this._flyToFrame=x(t,this),this._move(this.unproject(s.add(r.subtract(s).multiplyBy(f(i)/l)),a),this.getScaleZoom(h/(e=i,h*(p(m)/p(m+u*e))),a),{flyTo:!0})):this._move(n,o)._moveEnd(!0)}.call(this),this},flyToBounds:function(t,e){t=this._getBoundsCenterZoom(t,e);return this.flyTo(t.center,t.zoom,e)},setMaxBounds:function(t){return t=g(t),this.listens("moveend",this._panInsideMaxBounds)&&this.off("moveend",this._panInsideMaxBounds),t.isValid()?(this.options.maxBounds=t,this._loaded&&this._panInsideMaxBounds(),this.on("moveend",this._panInsideMaxBounds)):(this.options.maxBounds=null,this)},setMinZoom:function(t){var e=this.options.minZoom;return this.options.minZoom=t,this._loaded&&e!==t&&(this.fire("zoomlevelschange"),this.getZoom()<this.options.minZoom)?this.setZoom(t):this},setMaxZoom:function(t){var e=this.options.maxZoom;return this.options.maxZoom=t,this._loaded&&e!==t&&(this.fire("zoomlevelschange"),this.getZoom()>this.options.maxZoom)?this.setZoom(t):this},panInsideBounds:function(t,e){this._enforcingBounds=!0;var i=this.getCenter(),t=this._limitCenter(i,this._zoom,g(t));return i.equals(t)||this.panTo(t,e),this._enforcingBounds=!1,this},panInside:function(t,e){var i=m((e=e||{}).paddingTopLeft||e.padding||[0,0]),n=m(e.paddingBottomRight||e.padding||[0,0]),o=this.project(this.getCenter()),t=this.project(t),s=this.getPixelBounds(),i=_([s.min.add(i),s.max.subtract(n)]),s=i.getSize();return i.contains(t)||(this._enforcingBounds=!0,n=t.subtract(i.getCenter()),i=i.extend(t).getSize().subtract(s),o.x+=n.x<0?-i.x:i.x,o.y+=n.y<0?-i.y:i.y,this.panTo(this.unproject(o),e),this._enforcingBounds=!1),this},invalidateSize:function(t){if(!this._loaded)return this;t=l({animate:!1,pan:!0},!0===t?{animate:!0}:t);var e=this.getSize(),i=(this._sizeChanged=!0,this._lastCenter=null,this.getSize()),n=e.divideBy(2).round(),o=i.divideBy(2).round(),n=n.subtract(o);return n.x||n.y?(t.animate&&t.pan?this.panBy(n):(t.pan&&this._rawPanBy(n),this.fire("move"),t.debounceMoveend?(clearTimeout(this._sizeTimer),this._sizeTimer=setTimeout(a(this.fire,this,"moveend"),200)):this.fire("moveend")),this.fire("resize",{oldSize:e,newSize:i})):this},stop:function(){return this.setZoom(this._limitZoom(this._zoom)),this.options.zoomSnap||this.fire("viewreset"),this._stop()},locate:function(t){var e,i;return t=this._locateOptions=l({timeout:1e4,watch:!1},t),"geolocation"in navigator?(e=a(this._handleGeolocationResponse,this),i=a(this._handleGeolocationError,this),t.watch?this._locationWatchId=navigator.geolocation.watchPosition(e,i,t):navigator.geolocation.getCurrentPosition(e,i,t)):this._handleGeolocationError({code:0,message:"Geolocation not supported."}),this},stopLocate:function(){return navigator.geolocation&&navigator.geolocation.clearWatch&&navigator.geolocation.clearWatch(this._locationWatchId),this._locateOptions&&(this._locateOptions.setView=!1),this},_handleGeolocationError:function(t){var e;this._container._leaflet_id&&(e=t.code,t=t.message||(1===e?"permission denied":2===e?"position unavailable":"timeout"),this._locateOptions.setView&&!this._loaded&&this.fitWorld(),this.fire("locationerror",{code:e,message:"Geolocation error: "+t+"."}))},_handleGeolocationResponse:function(t){if(this._container._leaflet_id){var e,i,n=new v(t.coords.latitude,t.coords.longitude),o=n.toBounds(2*t.coords.accuracy),s=this._locateOptions,r=(s.setView&&(e=this.getBoundsZoom(o),this.setView(n,s.maxZoom?Math.min(e,s.maxZoom):e)),{latlng:n,bounds:o,timestamp:t.timestamp});for(i in t.coords)"number"==typeof t.coords[i]&&(r[i]=t.coords[i]);this.fire("locationfound",r)}},addHandler:function(t,e){return e&&(e=this[t]=new e(this),this._handlers.push(e),this.options[t]&&e.enable()),this},remove:function(){if(this._initEvents(!0),this.options.maxBounds&&this.off("moveend",this._panInsideMaxBounds),this._containerId!==this._container._leaflet_id)throw new Error("Map container is being reused by another instance");try{delete this._container._leaflet_id,delete this._containerId}catch(t){this._container._leaflet_id=void 0,this._containerId=void 0}for(var t in void 0!==this._locationWatchId&&this.stopLocate(),this._stop(),T(this._mapPane),this._clearControlPos&&this._clearControlPos(),this._resizeRequest&&(r(this._resizeRequest),this._resizeRequest=null),this._clearHandlers(),this._loaded&&this.fire("unload"),this._layers)this._layers[t].remove();for(t in this._panes)T(this._panes[t]);return this._layers=[],this._panes=[],delete this._mapPane,delete this._renderer,this},createPane:function(t,e){e=P("div","leaflet-pane"+(t?" leaflet-"+t.replace("Pane","")+"-pane":""),e||this._mapPane);return t&&(this._panes[t]=e),e},getCenter:function(){return this._checkIfLoaded(),this._lastCenter&&!this._moved()?this._lastCenter.clone():this.layerPointToLatLng(this._getCenterLayerPoint())},getZoom:function(){return this._zoom},getBounds:function(){var t=this.getPixelBounds();return new s(this.unproject(t.getBottomLeft()),this.unproject(t.getTopRight()))},getMinZoom:function(){return void 0===this.options.minZoom?this._layersMinZoom||0:this.options.minZoom},getMaxZoom:function(){return void 0===this.options.maxZoom?void 0===this._layersMaxZoom?1/0:this._layersMaxZoom:this.options.maxZoom},getBoundsZoom:function(t,e,i){t=g(t),i=m(i||[0,0]);var n=this.getZoom()||0,o=this.getMinZoom(),s=this.getMaxZoom(),r=t.getNorthWest(),t=t.getSouthEast(),i=this.getSize().subtract(i),t=_(this.project(t,n),this.project(r,n)).getSize(),r=b.any3d?this.options.zoomSnap:1,a=i.x/t.x,i=i.y/t.y,t=e?Math.max(a,i):Math.min(a,i),n=this.getScaleZoom(t,n);return r&&(n=Math.round(n/(r/100))*(r/100),n=e?Math.ceil(n/r)*r:Math.floor(n/r)*r),Math.max(o,Math.min(s,n))},getSize:function(){return this._size&&!this._sizeChanged||(this._size=new p(this._container.clientWidth||0,this._container.clientHeight||0),this._sizeChanged=!1),this._size.clone()},getPixelBounds:function(t,e){t=this._getTopLeftPoint(t,e);return new f(t,t.add(this.getSize()))},getPixelOrigin:function(){return this._checkIfLoaded(),this._pixelOrigin},getPixelWorldBounds:function(t){return this.options.crs.getProjectedBounds(void 0===t?this.getZoom():t)},getPane:function(t){return"string"==typeof t?this._panes[t]:t},getPanes:function(){return this._panes},getContainer:function(){return this._container},getZoomScale:function(t,e){var i=this.options.crs;return e=void 0===e?this._zoom:e,i.scale(t)/i.scale(e)},getScaleZoom:function(t,e){var i=this.options.crs,t=(e=void 0===e?this._zoom:e,i.zoom(t*i.scale(e)));return isNaN(t)?1/0:t},project:function(t,e){return e=void 0===e?this._zoom:e,this.options.crs.latLngToPoint(w(t),e)},unproject:function(t,e){return e=void 0===e?this._zoom:e,this.options.crs.pointToLatLng(m(t),e)},layerPointToLatLng:function(t){t=m(t).add(this.getPixelOrigin());return this.unproject(t)},latLngToLayerPoint:function(t){return this.project(w(t))._round()._subtract(this.getPixelOrigin())},wrapLatLng:function(t){return this.options.crs.wrapLatLng(w(t))},wrapLatLngBounds:function(t){return this.options.crs.wrapLatLngBounds(g(t))},distance:function(t,e){return this.options.crs.distance(w(t),w(e))},containerPointToLayerPoint:function(t){return m(t).subtract(this._getMapPanePos())},layerPointToContainerPoint:function(t){return m(t).add(this._getMapPanePos())},containerPointToLatLng:function(t){t=this.containerPointToLayerPoint(m(t));return this.layerPointToLatLng(t)},latLngToContainerPoint:function(t){return this.layerPointToContainerPoint(this.latLngToLayerPoint(w(t)))},mouseEventToContainerPoint:function(t){return De(t,this._container)},mouseEventToLayerPoint:function(t){return this.containerPointToLayerPoint(this.mouseEventToContainerPoint(t))},mouseEventToLatLng:function(t){return this.layerPointToLatLng(this.mouseEventToLayerPoint(t))},_initContainer:function(t){t=this._container=_e(t);if(!t)throw new Error("Map container not found.");if(t._leaflet_id)throw new Error("Map container is already initialized.");S(t,"scroll",this._onScroll,this),this._containerId=h(t)},_initLayout:function(){var t=this._container,e=(this._fadeAnimated=this.options.fadeAnimation&&b.any3d,M(t,"leaflet-container"+(b.touch?" leaflet-touch":"")+(b.retina?" leaflet-retina":"")+(b.ielt9?" leaflet-oldie":"")+(b.safari?" leaflet-safari":"")+(this._fadeAnimated?" leaflet-fade-anim":"")),pe(t,"position"));"absolute"!==e&&"relative"!==e&&"fixed"!==e&&"sticky"!==e&&(t.style.position="relative"),this._initPanes(),this._initControlPos&&this._initControlPos()},_initPanes:function(){var t=this._panes={};this._paneRenderers={},this._mapPane=this.createPane("mapPane",this._container),Z(this._mapPane,new p(0,0)),this.createPane("tilePane"),this.createPane("overlayPane"),this.createPane("shadowPane"),this.createPane("markerPane"),this.createPane("tooltipPane"),this.createPane("popupPane"),this.options.markerZoomAnimation||(M(t.markerPane,"leaflet-zoom-hide"),M(t.shadowPane,"leaflet-zoom-hide"))},_resetView:function(t,e,i){Z(this._mapPane,new p(0,0));var n=!this._loaded,o=(this._loaded=!0,e=this._limitZoom(e),this.fire("viewprereset"),this._zoom!==e);this._moveStart(o,i)._move(t,e)._moveEnd(o),this.fire("viewreset"),n&&this.fire("load")},_moveStart:function(t,e){return t&&this.fire("zoomstart"),e||this.fire("movestart"),this},_move:function(t,e,i,n){void 0===e&&(e=this._zoom);var o=this._zoom!==e;return this._zoom=e,this._lastCenter=t,this._pixelOrigin=this._getNewPixelOrigin(t),n?i&&i.pinch&&this.fire("zoom",i):((o||i&&i.pinch)&&this.fire("zoom",i),this.fire("move",i)),this},_moveEnd:function(t){return t&&this.fire("zoomend"),this.fire("moveend")},_stop:function(){return r(this._flyToFrame),this._panAnim&&this._panAnim.stop(),this},_rawPanBy:function(t){Z(this._mapPane,this._getMapPanePos().subtract(t))},_getZoomSpan:function(){return this.getMaxZoom()-this.getMinZoom()},_panInsideMaxBounds:function(){this._enforcingBounds||this.panInsideBounds(this.options.maxBounds)},_checkIfLoaded:function(){if(!this._loaded)throw new Error("Set map center and zoom first.")},_initEvents:function(t){this._targets={};var e=t?k:S;e((this._targets[h(this._container)]=this)._container,"click dblclick mousedown mouseup mouseover mouseout mousemove contextmenu keypress keydown keyup",this._handleDOMEvent,this),this.options.trackResize&&e(window,"resize",this._onResize,this),b.any3d&&this.options.transform3DLimit&&(t?this.off:this.on).call(this,"moveend",this._onMoveEnd)},_onResize:function(){r(this._resizeRequest),this._resizeRequest=x(function(){this.invalidateSize({debounceMoveend:!0})},this)},_onScroll:function(){this._container.scrollTop=0,this._container.scrollLeft=0},_onMoveEnd:function(){var t=this._getMapPanePos();Math.max(Math.abs(t.x),Math.abs(t.y))>=this.options.transform3DLimit&&this._resetView(this.getCenter(),this.getZoom())},_findEventTargets:function(t,e){for(var i,n=[],o="mouseout"===e||"mouseover"===e,s=t.target||t.srcElement,r=!1;s;){if((i=this._targets[h(s)])&&("click"===e||"preclick"===e)&&this._draggableMoved(i)){r=!0;break}if(i&&i.listens(e,!0)){if(o&&!We(s,t))break;if(n.push(i),o)break}if(s===this._container)break;s=s.parentNode}return n=n.length||r||o||!this.listens(e,!0)?n:[this]},_isClickDisabled:function(t){for(;t&&t!==this._container;){if(t._leaflet_disable_click)return!0;t=t.parentNode}},_handleDOMEvent:function(t){var e,i=t.target||t.srcElement;!this._loaded||i._leaflet_disable_events||"click"===t.type&&this._isClickDisabled(i)||("mousedown"===(e=t.type)&&Me(i),this._fireDOMEvent(t,e))},_mouseEvents:["click","dblclick","mouseover","mouseout","contextmenu"],_fireDOMEvent:function(t,e,i){"click"===t.type&&((a=l({},t)).type="preclick",this._fireDOMEvent(a,a.type,i));var n=this._findEventTargets(t,e);if(i){for(var o=[],s=0;s<i.length;s++)i[s].listens(e,!0)&&o.push(i[s]);n=o.concat(n)}if(n.length){"contextmenu"===e&&O(t);var r,a=n[0],h={originalEvent:t};for("keypress"!==t.type&&"keydown"!==t.type&&"keyup"!==t.type&&(r=a.getLatLng&&(!a._radius||a._radius<=10),h.containerPoint=r?this.latLngToContainerPoint(a.getLatLng()):this.mouseEventToContainerPoint(t),h.layerPoint=this.containerPointToLayerPoint(h.containerPoint),h.latlng=r?a.getLatLng():this.layerPointToLatLng(h.layerPoint)),s=0;s<n.length;s++)if(n[s].fire(e,h,!0),h.originalEvent._stopped||!1===n[s].options.bubblingMouseEvents&&-1!==G(this._mouseEvents,e))return}},_draggableMoved:function(t){return(t=t.dragging&&t.dragging.enabled()?t:this).dragging&&t.dragging.moved()||this.boxZoom&&this.boxZoom.moved()},_clearHandlers:function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].disable()},whenReady:function(t,e){return this._loaded?t.call(e||this,{target:this}):this.on("load",t,e),this},_getMapPanePos:function(){return Pe(this._mapPane)||new p(0,0)},_moved:function(){var t=this._getMapPanePos();return t&&!t.equals([0,0])},_getTopLeftPoint:function(t,e){return(t&&void 0!==e?this._getNewPixelOrigin(t,e):this.getPixelOrigin()).subtract(this._getMapPanePos())},_getNewPixelOrigin:function(t,e){var i=this.getSize()._divideBy(2);return this.project(t,e)._subtract(i)._add(this._getMapPanePos())._round()},_latLngToNewLayerPoint:function(t,e,i){i=this._getNewPixelOrigin(i,e);return this.project(t,e)._subtract(i)},_latLngBoundsToNewLayerBounds:function(t,e,i){i=this._getNewPixelOrigin(i,e);return _([this.project(t.getSouthWest(),e)._subtract(i),this.project(t.getNorthWest(),e)._subtract(i),this.project(t.getSouthEast(),e)._subtract(i),this.project(t.getNorthEast(),e)._subtract(i)])},_getCenterLayerPoint:function(){return this.containerPointToLayerPoint(this.getSize()._divideBy(2))},_getCenterOffset:function(t){return this.latLngToLayerPoint(t).subtract(this._getCenterLayerPoint())},_limitCenter:function(t,e,i){var n,o;return!i||(n=this.project(t,e),o=this.getSize().divideBy(2),o=new f(n.subtract(o),n.add(o)),o=this._getBoundsOffset(o,i,e),Math.abs(o.x)<=1&&Math.abs(o.y)<=1)?t:this.unproject(n.add(o),e)},_limitOffset:function(t,e){var i;return e?(i=new f((i=this.getPixelBounds()).min.add(t),i.max.add(t)),t.add(this._getBoundsOffset(i,e))):t},_getBoundsOffset:function(t,e,i){e=_(this.project(e.getNorthEast(),i),this.project(e.getSouthWest(),i)),i=e.min.subtract(t.min),e=e.max.subtract(t.max);return new p(this._rebound(i.x,-e.x),this._rebound(i.y,-e.y))},_rebound:function(t,e){return 0<t+e?Math.round(t-e)/2:Math.max(0,Math.ceil(t))-Math.max(0,Math.floor(e))},_limitZoom:function(t){var e=this.getMinZoom(),i=this.getMaxZoom(),n=b.any3d?this.options.zoomSnap:1;return n&&(t=Math.round(t/n)*n),Math.max(e,Math.min(i,t))},_onPanTransitionStep:function(){this.fire("move")},_onPanTransitionEnd:function(){z(this._mapPane,"leaflet-pan-anim"),this.fire("moveend")},_tryAnimatedPan:function(t,e){t=this._getCenterOffset(t)._trunc();return!(!0!==(e&&e.animate)&&!this.getSize().contains(t))&&(this.panBy(t,e),!0)},_createAnimProxy:function(){var t=this._proxy=P("div","leaflet-proxy leaflet-zoom-animated");this._panes.mapPane.appendChild(t),this.on("zoomanim",function(t){var e=ue,i=this._proxy.style[e];be(this._proxy,this.project(t.center,t.zoom),this.getZoomScale(t.zoom,1)),i===this._proxy.style[e]&&this._animatingZoom&&this._onZoomTransitionEnd()},this),this.on("load moveend",this._animMoveEnd,this),this._on("unload",this._destroyAnimProxy,this)},_destroyAnimProxy:function(){T(this._proxy),this.off("load moveend",this._animMoveEnd,this),delete this._proxy},_animMoveEnd:function(){var t=this.getCenter(),e=this.getZoom();be(this._proxy,this.project(t,e),this.getZoomScale(e,1))},_catchTransitionEnd:function(t){this._animatingZoom&&0<=t.propertyName.indexOf("transform")&&this._onZoomTransitionEnd()},_nothingToAnimate:function(){return!this._container.getElementsByClassName("leaflet-zoom-animated").length},_tryAnimatedZoom:function(t,e,i){if(!this._animatingZoom){if(i=i||{},!this._zoomAnimated||!1===i.animate||this._nothingToAnimate()||Math.abs(e-this._zoom)>this.options.zoomAnimationThreshold)return!1;var n=this.getZoomScale(e),n=this._getCenterOffset(t)._divideBy(1-1/n);if(!0!==i.animate&&!this.getSize().contains(n))return!1;x(function(){this._moveStart(!0,i.noMoveStart||!1)._animateZoom(t,e,!0)},this)}return!0},_animateZoom:function(t,e,i,n){this._mapPane&&(i&&(this._animatingZoom=!0,this._animateToCenter=t,this._animateToZoom=e,M(this._mapPane,"leaflet-zoom-anim")),this.fire("zoomanim",{center:t,zoom:e,noUpdate:n}),this._tempFireZoomEvent||(this._tempFireZoomEvent=this._zoom!==this._animateToZoom),this._move(this._animateToCenter,this._animateToZoom,void 0,!0),setTimeout(a(this._onZoomTransitionEnd,this),250))},_onZoomTransitionEnd:function(){this._animatingZoom&&(this._mapPane&&z(this._mapPane,"leaflet-zoom-anim"),this._animatingZoom=!1,this._move(this._animateToCenter,this._animateToZoom,void 0,!0),this._tempFireZoomEvent&&this.fire("zoom"),delete this._tempFireZoomEvent,this.fire("move"),this._moveEnd(!0))}});function Ue(t){return new B(t)}var B=et.extend({options:{position:"topright"},initialize:function(t){c(this,t)},getPosition:function(){return this.options.position},setPosition:function(t){var e=this._map;return e&&e.removeControl(this),this.options.position=t,e&&e.addControl(this),this},getContainer:function(){return this._container},addTo:function(t){this.remove(),this._map=t;var e=this._container=this.onAdd(t),i=this.getPosition(),t=t._controlCorners[i];return M(e,"leaflet-control"),-1!==i.indexOf("bottom")?t.insertBefore(e,t.firstChild):t.appendChild(e),this._map.on("unload",this.remove,this),this},remove:function(){return this._map&&(T(this._container),this.onRemove&&this.onRemove(this._map),this._map.off("unload",this.remove,this),this._map=null),this},_refocusOnMap:function(t){this._map&&t&&0<t.screenX&&0<t.screenY&&this._map.getContainer().focus()}}),Ve=(A.include({addControl:function(t){return t.addTo(this),this},removeControl:function(t){return t.remove(),this},_initControlPos:function(){var i=this._controlCorners={},n="leaflet-",o=this._controlContainer=P("div",n+"control-container",this._container);function t(t,e){i[t+e]=P("div",n+t+" "+n+e,o)}t("top","left"),t("top","right"),t("bottom","left"),t("bottom","right")},_clearControlPos:function(){for(var t in this._controlCorners)T(this._controlCorners[t]);T(this._controlContainer),delete this._controlCorners,delete this._controlContainer}}),B.extend({options:{collapsed:!0,position:"topright",autoZIndex:!0,hideSingleBase:!1,sortLayers:!1,sortFunction:function(t,e,i,n){return i<n?-1:n<i?1:0}},initialize:function(t,e,i){for(var n in c(this,i),this._layerControlInputs=[],this._layers=[],this._lastZIndex=0,this._handlingClick=!1,this._preventClick=!1,t)this._addLayer(t[n],n);for(n in e)this._addLayer(e[n],n,!0)},onAdd:function(t){this._initLayout(),this._update(),(this._map=t).on("zoomend",this._checkDisabledLayers,this);for(var e=0;e<this._layers.length;e++)this._layers[e].layer.on("add remove",this._onLayerChange,this);return this._container},addTo:function(t){return B.prototype.addTo.call(this,t),this._expandIfNotCollapsed()},onRemove:function(){this._map.off("zoomend",this._checkDisabledLayers,this);for(var t=0;t<this._layers.length;t++)this._layers[t].layer.off("add remove",this._onLayerChange,this)},addBaseLayer:function(t,e){return this._addLayer(t,e),this._map?this._update():this},addOverlay:function(t,e){return this._addLayer(t,e,!0),this._map?this._update():this},removeLayer:function(t){t.off("add remove",this._onLayerChange,this);t=this._getLayer(h(t));return t&&this._layers.splice(this._layers.indexOf(t),1),this._map?this._update():this},expand:function(){M(this._container,"leaflet-control-layers-expanded"),this._section.style.height=null;var t=this._map.getSize().y-(this._container.offsetTop+50);return t<this._section.clientHeight?(M(this._section,"leaflet-control-layers-scrollbar"),this._section.style.height=t+"px"):z(this._section,"leaflet-control-layers-scrollbar"),this._checkDisabledLayers(),this},collapse:function(){return z(this._container,"leaflet-control-layers-expanded"),this},_initLayout:function(){var t="leaflet-control-layers",e=this._container=P("div",t),i=this.options.collapsed,n=(e.setAttribute("aria-haspopup",!0),Ie(e),Be(e),this._section=P("section",t+"-list")),o=(i&&(this._map.on("click",this.collapse,this),S(e,{mouseenter:this._expandSafely,mouseleave:this.collapse},this)),this._layersLink=P("a",t+"-toggle",e));o.href="#",o.title="Layers",o.setAttribute("role","button"),S(o,{keydown:function(t){13===t.keyCode&&this._expandSafely()},click:function(t){O(t),this._expandSafely()}},this),i||this.expand(),this._baseLayersList=P("div",t+"-base",n),this._separator=P("div",t+"-separator",n),this._overlaysList=P("div",t+"-overlays",n),e.appendChild(n)},_getLayer:function(t){for(var e=0;e<this._layers.length;e++)if(this._layers[e]&&h(this._layers[e].layer)===t)return this._layers[e]},_addLayer:function(t,e,i){this._map&&t.on("add remove",this._onLayerChange,this),this._layers.push({layer:t,name:e,overlay:i}),this.options.sortLayers&&this._layers.sort(a(function(t,e){return this.options.sortFunction(t.layer,e.layer,t.name,e.name)},this)),this.options.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex)),this._expandIfNotCollapsed()},_update:function(){if(this._container){me(this._baseLayersList),me(this._overlaysList),this._layerControlInputs=[];for(var t,e,i,n=0,o=0;o<this._layers.length;o++)i=this._layers[o],this._addItem(i),e=e||i.overlay,t=t||!i.overlay,n+=i.overlay?0:1;this.options.hideSingleBase&&(this._baseLayersList.style.display=(t=t&&1<n)?"":"none"),this._separator.style.display=e&&t?"":"none"}return this},_onLayerChange:function(t){this._handlingClick||this._update();var e=this._getLayer(h(t.target)),t=e.overlay?"add"===t.type?"overlayadd":"overlayremove":"add"===t.type?"baselayerchange":null;t&&this._map.fire(t,e)},_createRadioElement:function(t,e){t='<input type="radio" class="leaflet-control-layers-selector" name="'+t+'"'+(e?' checked="checked"':"")+"/>",e=document.createElement("div");return e.innerHTML=t,e.firstChild},_addItem:function(t){var e,i=document.createElement("label"),n=this._map.hasLayer(t.layer),n=(t.overlay?((e=document.createElement("input")).type="checkbox",e.className="leaflet-control-layers-selector",e.defaultChecked=n):e=this._createRadioElement("leaflet-base-layers_"+h(this),n),this._layerControlInputs.push(e),e.layerId=h(t.layer),S(e,"click",this._onInputClick,this),document.createElement("span")),o=(n.innerHTML=" "+t.name,document.createElement("span"));return i.appendChild(o),o.appendChild(e),o.appendChild(n),(t.overlay?this._overlaysList:this._baseLayersList).appendChild(i),this._checkDisabledLayers(),i},_onInputClick:function(){if(!this._preventClick){var t,e,i=this._layerControlInputs,n=[],o=[];this._handlingClick=!0;for(var s=i.length-1;0<=s;s--)t=i[s],e=this._getLayer(t.layerId).layer,t.checked?n.push(e):t.checked||o.push(e);for(s=0;s<o.length;s++)this._map.hasLayer(o[s])&&this._map.removeLayer(o[s]);for(s=0;s<n.length;s++)this._map.hasLayer(n[s])||this._map.addLayer(n[s]);this._handlingClick=!1,this._refocusOnMap()}},_checkDisabledLayers:function(){for(var t,e,i=this._layerControlInputs,n=this._map.getZoom(),o=i.length-1;0<=o;o--)t=i[o],e=this._getLayer(t.layerId).layer,t.disabled=void 0!==e.options.minZoom&&n<e.options.minZoom||void 0!==e.options.maxZoom&&n>e.options.maxZoom},_expandIfNotCollapsed:function(){return this._map&&!this.options.collapsed&&this.expand(),this},_expandSafely:function(){var t=this._section,e=(this._preventClick=!0,S(t,"click",O),this.expand(),this);setTimeout(function(){k(t,"click",O),e._preventClick=!1})}})),qe=B.extend({options:{position:"topleft",zoomInText:'<span aria-hidden="true">+</span>',zoomInTitle:"Zoom in",zoomOutText:'<span aria-hidden="true">&#x2212;</span>',zoomOutTitle:"Zoom out"},onAdd:function(t){var e="leaflet-control-zoom",i=P("div",e+" leaflet-bar"),n=this.options;return this._zoomInButton=this._createButton(n.zoomInText,n.zoomInTitle,e+"-in",i,this._zoomIn),this._zoomOutButton=this._createButton(n.zoomOutText,n.zoomOutTitle,e+"-out",i,this._zoomOut),this._updateDisabled(),t.on("zoomend zoomlevelschange",this._updateDisabled,this),i},onRemove:function(t){t.off("zoomend zoomlevelschange",this._updateDisabled,this)},disable:function(){return this._disabled=!0,this._updateDisabled(),this},enable:function(){return this._disabled=!1,this._updateDisabled(),this},_zoomIn:function(t){!this._disabled&&this._map._zoom<this._map.getMaxZoom()&&this._map.zoomIn(this._map.options.zoomDelta*(t.shiftKey?3:1))},_zoomOut:function(t){!this._disabled&&this._map._zoom>this._map.getMinZoom()&&this._map.zoomOut(this._map.options.zoomDelta*(t.shiftKey?3:1))},_createButton:function(t,e,i,n,o){i=P("a",i,n);return i.innerHTML=t,i.href="#",i.title=e,i.setAttribute("role","button"),i.setAttribute("aria-label",e),Ie(i),S(i,"click",Re),S(i,"click",o,this),S(i,"click",this._refocusOnMap,this),i},_updateDisabled:function(){var t=this._map,e="leaflet-disabled";z(this._zoomInButton,e),z(this._zoomOutButton,e),this._zoomInButton.setAttribute("aria-disabled","false"),this._zoomOutButton.setAttribute("aria-disabled","false"),!this._disabled&&t._zoom!==t.getMinZoom()||(M(this._zoomOutButton,e),this._zoomOutButton.setAttribute("aria-disabled","true")),!this._disabled&&t._zoom!==t.getMaxZoom()||(M(this._zoomInButton,e),this._zoomInButton.setAttribute("aria-disabled","true"))}}),Ge=(A.mergeOptions({zoomControl:!0}),A.addInitHook(function(){this.options.zoomControl&&(this.zoomControl=new qe,this.addControl(this.zoomControl))}),B.extend({options:{position:"bottomleft",maxWidth:100,metric:!0,imperial:!0},onAdd:function(t){var e="leaflet-control-scale",i=P("div",e),n=this.options;return this._addScales(n,e+"-line",i),t.on(n.updateWhenIdle?"moveend":"move",this._update,this),t.whenReady(this._update,this),i},onRemove:function(t){t.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScales:function(t,e,i){t.metric&&(this._mScale=P("div",e,i)),t.imperial&&(this._iScale=P("div",e,i))},_update:function(){var t=this._map,e=t.getSize().y/2,t=t.distance(t.containerPointToLatLng([0,e]),t.containerPointToLatLng([this.options.maxWidth,e]));this._updateScales(t)},_updateScales:function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},_updateMetric:function(t){var e=this._getRoundNum(t);this._updateScale(this._mScale,e<1e3?e+" m":e/1e3+" km",e/t)},_updateImperial:function(t){var e,i,t=3.2808399*t;5280<t?(i=this._getRoundNum(e=t/5280),this._updateScale(this._iScale,i+" mi",i/e)):(i=this._getRoundNum(t),this._updateScale(this._iScale,i+" ft",i/t))},_updateScale:function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),t=t/e;return e*(t=10<=t?10:5<=t?5:3<=t?3:2<=t?2:1)}})),Ke=B.extend({options:{position:"bottomright",prefix:'<a href="https://leafletjs.com" title="A JavaScript library for interactive maps">'+(b.inlineSvg?'<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"/><path fill="#FFD500" d="M0 4h12v3H0z"/><path fill="#E0BC00" d="M0 7h12v1H0z"/></svg> ':"")+"Leaflet</a>"},initialize:function(t){c(this,t),this._attributions={}},onAdd:function(t){for(var e in(t.attributionControl=this)._container=P("div","leaflet-control-attribution"),Ie(this._container),t._layers)t._layers[e].getAttribution&&this.addAttribution(t._layers[e].getAttribution());return this._update(),t.on("layeradd",this._addAttribution,this),this._container},onRemove:function(t){t.off("layeradd",this._addAttribution,this)},_addAttribution:function(t){t.layer.getAttribution&&(this.addAttribution(t.layer.getAttribution()),t.layer.once("remove",function(){this.removeAttribution(t.layer.getAttribution())},this))},setPrefix:function(t){return this.options.prefix=t,this._update(),this},addAttribution:function(t){return t&&(this._attributions[t]||(this._attributions[t]=0),this._attributions[t]++,this._update()),this},removeAttribution:function(t){return t&&this._attributions[t]&&(this._attributions[t]--,this._update()),this},_update:function(){if(this._map){var t,e=[];for(t in this._attributions)this._attributions[t]&&e.push(t);var i=[];this.options.prefix&&i.push(this.options.prefix),e.length&&i.push(e.join(", ")),this._container.innerHTML=i.join(' <span aria-hidden="true">|</span> ')}}}),n=(A.mergeOptions({attributionControl:!0}),A.addInitHook(function(){this.options.attributionControl&&(new Ke).addTo(this)}),B.Layers=Ve,B.Zoom=qe,B.Scale=Ge,B.Attribution=Ke,Ue.layers=function(t,e,i){return new Ve(t,e,i)},Ue.zoom=function(t){return new qe(t)},Ue.scale=function(t){return new Ge(t)},Ue.attribution=function(t){return new Ke(t)},et.extend({initialize:function(t){this._map=t},enable:function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},disable:function(){return this._enabled&&(this._enabled=!1,this.removeHooks()),this},enabled:function(){return!!this._enabled}})),ft=(n.addTo=function(t,e){return t.addHandler(e,this),this},{Events:e}),Ye=b.touch?"touchstart mousedown":"mousedown",Xe=it.extend({options:{clickTolerance:3},initialize:function(t,e,i,n){c(this,n),this._element=t,this._dragStartTarget=e||t,this._preventOutline=i},enable:function(){this._enabled||(S(this._dragStartTarget,Ye,this._onDown,this),this._enabled=!0)},disable:function(){this._enabled&&(Xe._dragging===this&&this.finishDrag(!0),k(this._dragStartTarget,Ye,this._onDown,this),this._enabled=!1,this._moved=!1)},_onDown:function(t){var e,i;this._enabled&&(this._moved=!1,ve(this._element,"leaflet-zoom-anim")||(t.touches&&1!==t.touches.length?Xe._dragging===this&&this.finishDrag():Xe._dragging||t.shiftKey||1!==t.which&&1!==t.button&&!t.touches||((Xe._dragging=this)._preventOutline&&Me(this._element),Le(),re(),this._moving||(this.fire("down"),i=t.touches?t.touches[0]:t,e=Ce(this._element),this._startPoint=new p(i.clientX,i.clientY),this._startPos=Pe(this._element),this._parentScale=Ze(e),i="mousedown"===t.type,S(document,i?"mousemove":"touchmove",this._onMove,this),S(document,i?"mouseup":"touchend touchcancel",this._onUp,this)))))},_onMove:function(t){var e;this._enabled&&(t.touches&&1<t.touches.length?this._moved=!0:!(e=new p((e=t.touches&&1===t.touches.length?t.touches[0]:t).clientX,e.clientY)._subtract(this._startPoint)).x&&!e.y||Math.abs(e.x)+Math.abs(e.y)<this.options.clickTolerance||(e.x/=this._parentScale.x,e.y/=this._parentScale.y,O(t),this._moved||(this.fire("dragstart"),this._moved=!0,M(document.body,"leaflet-dragging"),this._lastTarget=t.target||t.srcElement,window.SVGElementInstance&&this._lastTarget instanceof window.SVGElementInstance&&(this._lastTarget=this._lastTarget.correspondingUseElement),M(this._lastTarget,"leaflet-drag-target")),this._newPos=this._startPos.add(e),this._moving=!0,this._lastEvent=t,this._updatePosition()))},_updatePosition:function(){var t={originalEvent:this._lastEvent};this.fire("predrag",t),Z(this._element,this._newPos),this.fire("drag",t)},_onUp:function(){this._enabled&&this.finishDrag()},finishDrag:function(t){z(document.body,"leaflet-dragging"),this._lastTarget&&(z(this._lastTarget,"leaflet-drag-target"),this._lastTarget=null),k(document,"mousemove touchmove",this._onMove,this),k(document,"mouseup touchend touchcancel",this._onUp,this),Te(),ae();var e=this._moved&&this._moving;this._moving=!1,Xe._dragging=!1,e&&this.fire("dragend",{noInertia:t,distance:this._newPos.distanceTo(this._startPos)})}});function Je(t,e,i){for(var n,o,s,r,a,h,l,u=[1,4,2,8],c=0,d=t.length;c<d;c++)t[c]._code=si(t[c],e);for(s=0;s<4;s++){for(h=u[s],n=[],c=0,o=(d=t.length)-1;c<d;o=c++)r=t[c],a=t[o],r._code&h?a._code&h||((l=oi(a,r,h,e,i))._code=si(l,e),n.push(l)):(a._code&h&&((l=oi(a,r,h,e,i))._code=si(l,e),n.push(l)),n.push(r));t=n}return t}function $e(t,e){var i,n,o,s,r,a,h;if(!t||0===t.length)throw new Error("latlngs not passed");I(t)||(console.warn("latlngs are not flat! Only the first ring will be used"),t=t[0]);for(var l=w([0,0]),u=g(t),c=(u.getNorthWest().distanceTo(u.getSouthWest())*u.getNorthEast().distanceTo(u.getNorthWest())<1700&&(l=Qe(t)),t.length),d=[],_=0;_<c;_++){var p=w(t[_]);d.push(e.project(w([p.lat-l.lat,p.lng-l.lng])))}for(_=r=a=h=0,i=c-1;_<c;i=_++)n=d[_],o=d[i],s=n.y*o.x-o.y*n.x,a+=(n.x+o.x)*s,h+=(n.y+o.y)*s,r+=3*s;u=0===r?d[0]:[a/r,h/r],u=e.unproject(m(u));return w([u.lat+l.lat,u.lng+l.lng])}function Qe(t){for(var e=0,i=0,n=0,o=0;o<t.length;o++){var s=w(t[o]);e+=s.lat,i+=s.lng,n++}return w([e/n,i/n])}var ti,gt={__proto__:null,clipPolygon:Je,polygonCenter:$e,centroid:Qe};function ei(t,e){if(e&&t.length){var i=t=function(t,e){for(var i=[t[0]],n=1,o=0,s=t.length;n<s;n++)(function(t,e){var i=e.x-t.x,e=e.y-t.y;return i*i+e*e})(t[n],t[o])>e&&(i.push(t[n]),o=n);o<s-1&&i.push(t[s-1]);return i}(t,e=e*e),n=i.length,o=new(typeof Uint8Array!=void 0+""?Uint8Array:Array)(n);o[0]=o[n-1]=1,function t(e,i,n,o,s){var r,a,h,l=0;for(a=o+1;a<=s-1;a++)h=ri(e[a],e[o],e[s],!0),l<h&&(r=a,l=h);n<l&&(i[r]=1,t(e,i,n,o,r),t(e,i,n,r,s))}(i,o,e,0,n-1);var s,r=[];for(s=0;s<n;s++)o[s]&&r.push(i[s]);return r}return t.slice()}function ii(t,e,i){return Math.sqrt(ri(t,e,i,!0))}function ni(t,e,i,n,o){var s,r,a,h=n?ti:si(t,i),l=si(e,i);for(ti=l;;){if(!(h|l))return[t,e];if(h&l)return!1;a=si(r=oi(t,e,s=h||l,i,o),i),s===h?(t=r,h=a):(e=r,l=a)}}function oi(t,e,i,n,o){var s,r,a=e.x-t.x,e=e.y-t.y,h=n.min,n=n.max;return 8&i?(s=t.x+a*(n.y-t.y)/e,r=n.y):4&i?(s=t.x+a*(h.y-t.y)/e,r=h.y):2&i?(s=n.x,r=t.y+e*(n.x-t.x)/a):1&i&&(s=h.x,r=t.y+e*(h.x-t.x)/a),new p(s,r,o)}function si(t,e){var i=0;return t.x<e.min.x?i|=1:t.x>e.max.x&&(i|=2),t.y<e.min.y?i|=4:t.y>e.max.y&&(i|=8),i}function ri(t,e,i,n){var o=e.x,e=e.y,s=i.x-o,r=i.y-e,a=s*s+r*r;return 0<a&&(1<(a=((t.x-o)*s+(t.y-e)*r)/a)?(o=i.x,e=i.y):0<a&&(o+=s*a,e+=r*a)),s=t.x-o,r=t.y-e,n?s*s+r*r:new p(o,e)}function I(t){return!d(t[0])||"object"!=typeof t[0][0]&&void 0!==t[0][0]}function ai(t){return console.warn("Deprecated use of _flat, please use L.LineUtil.isFlat instead."),I(t)}function hi(t,e){var i,n,o,s,r,a;if(!t||0===t.length)throw new Error("latlngs not passed");I(t)||(console.warn("latlngs are not flat! Only the first ring will be used"),t=t[0]);for(var h=w([0,0]),l=g(t),u=(l.getNorthWest().distanceTo(l.getSouthWest())*l.getNorthEast().distanceTo(l.getNorthWest())<1700&&(h=Qe(t)),t.length),c=[],d=0;d<u;d++){var _=w(t[d]);c.push(e.project(w([_.lat-h.lat,_.lng-h.lng])))}for(i=d=0;d<u-1;d++)i+=c[d].distanceTo(c[d+1])/2;if(0===i)a=c[0];else for(n=d=0;d<u-1;d++)if(o=c[d],s=c[d+1],i<(n+=r=o.distanceTo(s))){a=[s.x-(r=(n-i)/r)*(s.x-o.x),s.y-r*(s.y-o.y)];break}l=e.unproject(m(a));return w([l.lat+h.lat,l.lng+h.lng])}var vt={__proto__:null,simplify:ei,pointToSegmentDistance:ii,closestPointOnSegment:function(t,e,i){return ri(t,e,i)},clipSegment:ni,_getEdgeIntersection:oi,_getBitCode:si,_sqClosestPointOnSegment:ri,isFlat:I,_flat:ai,polylineCenter:hi},yt={project:function(t){return new p(t.lng,t.lat)},unproject:function(t){return new v(t.y,t.x)},bounds:new f([-180,-90],[180,90])},xt={R:6378137,R_MINOR:6356752.314245179,bounds:new f([-20037508.34279,-15496570.73972],[20037508.34279,18764656.23138]),project:function(t){var e=Math.PI/180,i=this.R,n=t.lat*e,o=this.R_MINOR/i,o=Math.sqrt(1-o*o),s=o*Math.sin(n),s=Math.tan(Math.PI/4-n/2)/Math.pow((1-s)/(1+s),o/2),n=-i*Math.log(Math.max(s,1e-10));return new p(t.lng*e*i,n)},unproject:function(t){for(var e,i=180/Math.PI,n=this.R,o=this.R_MINOR/n,s=Math.sqrt(1-o*o),r=Math.exp(-t.y/n),a=Math.PI/2-2*Math.atan(r),h=0,l=.1;h<15&&1e-7<Math.abs(l);h++)e=s*Math.sin(a),e=Math.pow((1-e)/(1+e),s/2),a+=l=Math.PI/2-2*Math.atan(r*e)-a;return new v(a*i,t.x*i/n)}},wt={__proto__:null,LonLat:yt,Mercator:xt,SphericalMercator:rt},Pt=l({},st,{code:"EPSG:3395",projection:xt,transformation:ht(bt=.5/(Math.PI*xt.R),.5,-bt,.5)}),li=l({},st,{code:"EPSG:4326",projection:yt,transformation:ht(1/180,1,-1/180,.5)}),Lt=l({},ot,{projection:yt,transformation:ht(1,0,-1,0),scale:function(t){return Math.pow(2,t)},zoom:function(t){return Math.log(t)/Math.LN2},distance:function(t,e){var i=e.lng-t.lng,e=e.lat-t.lat;return Math.sqrt(i*i+e*e)},infinite:!0}),o=(ot.Earth=st,ot.EPSG3395=Pt,ot.EPSG3857=lt,ot.EPSG900913=ut,ot.EPSG4326=li,ot.Simple=Lt,it.extend({options:{pane:"overlayPane",attribution:null,bubblingMouseEvents:!0},addTo:function(t){return t.addLayer(this),this},remove:function(){return this.removeFrom(this._map||this._mapToAdd)},removeFrom:function(t){return t&&t.removeLayer(this),this},getPane:function(t){return this._map.getPane(t?this.options[t]||t:this.options.pane)},addInteractiveTarget:function(t){return this._map._targets[h(t)]=this},removeInteractiveTarget:function(t){return delete this._map._targets[h(t)],this},getAttribution:function(){return this.options.attribution},_layerAdd:function(t){var e,i=t.target;i.hasLayer(this)&&(this._map=i,this._zoomAnimated=i._zoomAnimated,this.getEvents&&(e=this.getEvents(),i.on(e,this),this.once("remove",function(){i.off(e,this)},this)),this.onAdd(i),this.fire("add"),i.fire("layeradd",{layer:this}))}})),ui=(A.include({addLayer:function(t){var e;if(t._layerAdd)return e=h(t),this._layers[e]||((this._layers[e]=t)._mapToAdd=this,t.beforeAdd&&t.beforeAdd(this),this.whenReady(t._layerAdd,t)),this;throw new Error("The provided object is not a Layer.")},removeLayer:function(t){var e=h(t);return this._layers[e]&&(this._loaded&&t.onRemove(this),delete this._layers[e],this._loaded&&(this.fire("layerremove",{layer:t}),t.fire("remove")),t._map=t._mapToAdd=null),this},hasLayer:function(t){return h(t)in this._layers},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},_addLayers:function(t){for(var e=0,i=(t=t?d(t)?t:[t]:[]).length;e<i;e++)this.addLayer(t[e])},_addZoomLimit:function(t){isNaN(t.options.maxZoom)&&isNaN(t.options.minZoom)||(this._zoomBoundLayers[h(t)]=t,this._updateZoomLevels())},_removeZoomLimit:function(t){t=h(t);this._zoomBoundLayers[t]&&(delete this._zoomBoundLayers[t],this._updateZoomLevels())},_updateZoomLevels:function(){var t,e=1/0,i=-1/0,n=this._getZoomSpan();for(t in this._zoomBoundLayers)var o=this._zoomBoundLayers[t].options,e=void 0===o.minZoom?e:Math.min(e,o.minZoom),i=void 0===o.maxZoom?i:Math.max(i,o.maxZoom);this._layersMaxZoom=i===-1/0?void 0:i,this._layersMinZoom=e===1/0?void 0:e,n!==this._getZoomSpan()&&this.fire("zoomlevelschange"),void 0===this.options.maxZoom&&this._layersMaxZoom&&this.getZoom()>this._layersMaxZoom&&this.setZoom(this._layersMaxZoom),void 0===this.options.minZoom&&this._layersMinZoom&&this.getZoom()<this._layersMinZoom&&this.setZoom(this._layersMinZoom)}}),o.extend({initialize:function(t,e){var i,n;if(c(this,e),this._layers={},t)for(i=0,n=t.length;i<n;i++)this.addLayer(t[i])},addLayer:function(t){var e=this.getLayerId(t);return this._layers[e]=t,this._map&&this._map.addLayer(t),this},removeLayer:function(t){t=t in this._layers?t:this.getLayerId(t);return this._map&&this._layers[t]&&this._map.removeLayer(this._layers[t]),delete this._layers[t],this},hasLayer:function(t){return("number"==typeof t?t:this.getLayerId(t))in this._layers},clearLayers:function(){return this.eachLayer(this.removeLayer,this)},invoke:function(t){var e,i,n=Array.prototype.slice.call(arguments,1);for(e in this._layers)(i=this._layers[e])[t]&&i[t].apply(i,n);return this},onAdd:function(t){this.eachLayer(t.addLayer,t)},onRemove:function(t){this.eachLayer(t.removeLayer,t)},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getLayer:function(t){return this._layers[t]},getLayers:function(){var t=[];return this.eachLayer(t.push,t),t},setZIndex:function(t){return this.invoke("setZIndex",t)},getLayerId:h})),ci=ui.extend({addLayer:function(t){return this.hasLayer(t)?this:(t.addEventParent(this),ui.prototype.addLayer.call(this,t),this.fire("layeradd",{layer:t}))},removeLayer:function(t){return this.hasLayer(t)?((t=t in this._layers?this._layers[t]:t).removeEventParent(this),ui.prototype.removeLayer.call(this,t),this.fire("layerremove",{layer:t})):this},setStyle:function(t){return this.invoke("setStyle",t)},bringToFront:function(){return this.invoke("bringToFront")},bringToBack:function(){return this.invoke("bringToBack")},getBounds:function(){var t,e=new s;for(t in this._layers){var i=this._layers[t];e.extend(i.getBounds?i.getBounds():i.getLatLng())}return e}}),di=et.extend({options:{popupAnchor:[0,0],tooltipAnchor:[0,0],crossOrigin:!1},initialize:function(t){c(this,t)},createIcon:function(t){return this._createIcon("icon",t)},createShadow:function(t){return this._createIcon("shadow",t)},_createIcon:function(t,e){var i=this._getIconUrl(t);if(i)return i=this._createImg(i,e&&"IMG"===e.tagName?e:null),this._setIconStyles(i,t),!this.options.crossOrigin&&""!==this.options.crossOrigin||(i.crossOrigin=!0===this.options.crossOrigin?"":this.options.crossOrigin),i;if("icon"===t)throw new Error("iconUrl not set in Icon options (see the docs).");return null},_setIconStyles:function(t,e){var i=this.options,n=i[e+"Size"],n=m(n="number"==typeof n?[n,n]:n),o=m("shadow"===e&&i.shadowAnchor||i.iconAnchor||n&&n.divideBy(2,!0));t.className="leaflet-marker-"+e+" "+(i.className||""),o&&(t.style.marginLeft=-o.x+"px",t.style.marginTop=-o.y+"px"),n&&(t.style.width=n.x+"px",t.style.height=n.y+"px")},_createImg:function(t,e){return(e=e||document.createElement("img")).src=t,e},_getIconUrl:function(t){return b.retina&&this.options[t+"RetinaUrl"]||this.options[t+"Url"]}});var _i=di.extend({options:{iconUrl:"marker-icon.png",iconRetinaUrl:"marker-icon-2x.png",shadowUrl:"marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],tooltipAnchor:[16,-28],shadowSize:[41,41]},_getIconUrl:function(t){return"string"!=typeof _i.imagePath&&(_i.imagePath=this._detectIconPath()),(this.options.imagePath||_i.imagePath)+di.prototype._getIconUrl.call(this,t)},_stripUrl:function(t){function e(t,e,i){return(e=e.exec(t))&&e[i]}return(t=e(t,/^url\((['"])?(.+)\1\)$/,2))&&e(t,/^(.*)marker-icon\.png$/,1)},_detectIconPath:function(){var t=P("div","leaflet-default-icon-path",document.body),e=pe(t,"background-image")||pe(t,"backgroundImage");return document.body.removeChild(t),(e=this._stripUrl(e))?e:(t=document.querySelector('link[href$="leaflet.css"]'))?t.href.substring(0,t.href.length-"leaflet.css".length-1):""}}),pi=n.extend({initialize:function(t){this._marker=t},addHooks:function(){var t=this._marker._icon;this._draggable||(this._draggable=new Xe(t,t,!0)),this._draggable.on({dragstart:this._onDragStart,predrag:this._onPreDrag,drag:this._onDrag,dragend:this._onDragEnd},this).enable(),M(t,"leaflet-marker-draggable")},removeHooks:function(){this._draggable.off({dragstart:this._onDragStart,predrag:this._onPreDrag,drag:this._onDrag,dragend:this._onDragEnd},this).disable(),this._marker._icon&&z(this._marker._icon,"leaflet-marker-draggable")},moved:function(){return this._draggable&&this._draggable._moved},_adjustPan:function(t){var e=this._marker,i=e._map,n=this._marker.options.autoPanSpeed,o=this._marker.options.autoPanPadding,s=Pe(e._icon),r=i.getPixelBounds(),a=i.getPixelOrigin(),a=_(r.min._subtract(a).add(o),r.max._subtract(a).subtract(o));a.contains(s)||(o=m((Math.max(a.max.x,s.x)-a.max.x)/(r.max.x-a.max.x)-(Math.min(a.min.x,s.x)-a.min.x)/(r.min.x-a.min.x),(Math.max(a.max.y,s.y)-a.max.y)/(r.max.y-a.max.y)-(Math.min(a.min.y,s.y)-a.min.y)/(r.min.y-a.min.y)).multiplyBy(n),i.panBy(o,{animate:!1}),this._draggable._newPos._add(o),this._draggable._startPos._add(o),Z(e._icon,this._draggable._newPos),this._onDrag(t),this._panRequest=x(this._adjustPan.bind(this,t)))},_onDragStart:function(){this._oldLatLng=this._marker.getLatLng(),this._marker.closePopup&&this._marker.closePopup(),this._marker.fire("movestart").fire("dragstart")},_onPreDrag:function(t){this._marker.options.autoPan&&(r(this._panRequest),this._panRequest=x(this._adjustPan.bind(this,t)))},_onDrag:function(t){var e=this._marker,i=e._shadow,n=Pe(e._icon),o=e._map.layerPointToLatLng(n);i&&Z(i,n),e._latlng=o,t.latlng=o,t.oldLatLng=this._oldLatLng,e.fire("move",t).fire("drag",t)},_onDragEnd:function(t){r(this._panRequest),delete this._oldLatLng,this._marker.fire("moveend").fire("dragend",t)}}),mi=o.extend({options:{icon:new _i,interactive:!0,keyboard:!0,title:"",alt:"Marker",zIndexOffset:0,opacity:1,riseOnHover:!1,riseOffset:250,pane:"markerPane",shadowPane:"shadowPane",bubblingMouseEvents:!1,autoPanOnFocus:!0,draggable:!1,autoPan:!1,autoPanPadding:[50,50],autoPanSpeed:10},initialize:function(t,e){c(this,e),this._latlng=w(t)},onAdd:function(t){this._zoomAnimated=this._zoomAnimated&&t.options.markerZoomAnimation,this._zoomAnimated&&t.on("zoomanim",this._animateZoom,this),this._initIcon(),this.update()},onRemove:function(t){this.dragging&&this.dragging.enabled()&&(this.options.draggable=!0,this.dragging.removeHooks()),delete this.dragging,this._zoomAnimated&&t.off("zoomanim",this._animateZoom,this),this._removeIcon(),this._removeShadow()},getEvents:function(){return{zoom:this.update,viewreset:this.update}},getLatLng:function(){return this._latlng},setLatLng:function(t){var e=this._latlng;return this._latlng=w(t),this.update(),this.fire("move",{oldLatLng:e,latlng:this._latlng})},setZIndexOffset:function(t){return this.options.zIndexOffset=t,this.update()},getIcon:function(){return this.options.icon},setIcon:function(t){return this.options.icon=t,this._map&&(this._initIcon(),this.update()),this._popup&&this.bindPopup(this._popup,this._popup.options),this},getElement:function(){return this._icon},update:function(){var t;return this._icon&&this._map&&(t=this._map.latLngToLayerPoint(this._latlng).round(),this._setPos(t)),this},_initIcon:function(){var t=this.options,e="leaflet-zoom-"+(this._zoomAnimated?"animated":"hide"),i=t.icon.createIcon(this._icon),n=!1,i=(i!==this._icon&&(this._icon&&this._removeIcon(),n=!0,t.title&&(i.title=t.title),"IMG"===i.tagName&&(i.alt=t.alt||"")),M(i,e),t.keyboard&&(i.tabIndex="0",i.setAttribute("role","button")),this._icon=i,t.riseOnHover&&this.on({mouseover:this._bringToFront,mouseout:this._resetZIndex}),this.options.autoPanOnFocus&&S(i,"focus",this._panOnFocus,this),t.icon.createShadow(this._shadow)),o=!1;i!==this._shadow&&(this._removeShadow(),o=!0),i&&(M(i,e),i.alt=""),this._shadow=i,t.opacity<1&&this._updateOpacity(),n&&this.getPane().appendChild(this._icon),this._initInteraction(),i&&o&&this.getPane(t.shadowPane).appendChild(this._shadow)},_removeIcon:function(){this.options.riseOnHover&&this.off({mouseover:this._bringToFront,mouseout:this._resetZIndex}),this.options.autoPanOnFocus&&k(this._icon,"focus",this._panOnFocus,this),T(this._icon),this.removeInteractiveTarget(this._icon),this._icon=null},_removeShadow:function(){this._shadow&&T(this._shadow),this._shadow=null},_setPos:function(t){this._icon&&Z(this._icon,t),this._shadow&&Z(this._shadow,t),this._zIndex=t.y+this.options.zIndexOffset,this._resetZIndex()},_updateZIndex:function(t){this._icon&&(this._icon.style.zIndex=this._zIndex+t)},_animateZoom:function(t){t=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center).round();this._setPos(t)},_initInteraction:function(){var t;this.options.interactive&&(M(this._icon,"leaflet-interactive"),this.addInteractiveTarget(this._icon),pi&&(t=this.options.draggable,this.dragging&&(t=this.dragging.enabled(),this.dragging.disable()),this.dragging=new pi(this),t&&this.dragging.enable()))},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},_updateOpacity:function(){var t=this.options.opacity;this._icon&&C(this._icon,t),this._shadow&&C(this._shadow,t)},_bringToFront:function(){this._updateZIndex(this.options.riseOffset)},_resetZIndex:function(){this._updateZIndex(0)},_panOnFocus:function(){var t,e,i=this._map;i&&(t=(e=this.options.icon.options).iconSize?m(e.iconSize):m(0,0),e=e.iconAnchor?m(e.iconAnchor):m(0,0),i.panInside(this._latlng,{paddingTopLeft:e,paddingBottomRight:t.subtract(e)}))},_getPopupAnchor:function(){return this.options.icon.options.popupAnchor},_getTooltipAnchor:function(){return this.options.icon.options.tooltipAnchor}});var fi=o.extend({options:{stroke:!0,color:"#3388ff",weight:3,opacity:1,lineCap:"round",lineJoin:"round",dashArray:null,dashOffset:null,fill:!1,fillColor:null,fillOpacity:.2,fillRule:"evenodd",interactive:!0,bubblingMouseEvents:!0},beforeAdd:function(t){this._renderer=t.getRenderer(this)},onAdd:function(){this._renderer._initPath(this),this._reset(),this._renderer._addPath(this)},onRemove:function(){this._renderer._removePath(this)},redraw:function(){return this._map&&this._renderer._updatePath(this),this},setStyle:function(t){return c(this,t),this._renderer&&(this._renderer._updateStyle(this),this.options.stroke&&t&&Object.prototype.hasOwnProperty.call(t,"weight")&&this._updateBounds()),this},bringToFront:function(){return this._renderer&&this._renderer._bringToFront(this),this},bringToBack:function(){return this._renderer&&this._renderer._bringToBack(this),this},getElement:function(){return this._path},_reset:function(){this._project(),this._update()},_clickTolerance:function(){return(this.options.stroke?this.options.weight/2:0)+(this._renderer.options.tolerance||0)}}),gi=fi.extend({options:{fill:!0,radius:10},initialize:function(t,e){c(this,e),this._latlng=w(t),this._radius=this.options.radius},setLatLng:function(t){var e=this._latlng;return this._latlng=w(t),this.redraw(),this.fire("move",{oldLatLng:e,latlng:this._latlng})},getLatLng:function(){return this._latlng},setRadius:function(t){return this.options.radius=this._radius=t,this.redraw()},getRadius:function(){return this._radius},setStyle:function(t){var e=t&&t.radius||this._radius;return fi.prototype.setStyle.call(this,t),this.setRadius(e),this},_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng),this._updateBounds()},_updateBounds:function(){var t=this._radius,e=this._radiusY||t,i=this._clickTolerance(),t=[t+i,e+i];this._pxBounds=new f(this._point.subtract(t),this._point.add(t))},_update:function(){this._map&&this._updatePath()},_updatePath:function(){this._renderer._updateCircle(this)},_empty:function(){return this._radius&&!this._renderer._bounds.intersects(this._pxBounds)},_containsPoint:function(t){return t.distanceTo(this._point)<=this._radius+this._clickTolerance()}});var vi=gi.extend({initialize:function(t,e,i){if(c(this,e="number"==typeof e?l({},i,{radius:e}):e),this._latlng=w(t),isNaN(this.options.radius))throw new Error("Circle radius cannot be NaN");this._mRadius=this.options.radius},setRadius:function(t){return this._mRadius=t,this.redraw()},getRadius:function(){return this._mRadius},getBounds:function(){var t=[this._radius,this._radiusY||this._radius];return new s(this._map.layerPointToLatLng(this._point.subtract(t)),this._map.layerPointToLatLng(this._point.add(t)))},setStyle:fi.prototype.setStyle,_project:function(){var t,e,i,n,o,s=this._latlng.lng,r=this._latlng.lat,a=this._map,h=a.options.crs;h.distance===st.distance?(n=Math.PI/180,o=this._mRadius/st.R/n,t=a.project([r+o,s]),e=a.project([r-o,s]),e=t.add(e).divideBy(2),i=a.unproject(e).lat,n=Math.acos((Math.cos(o*n)-Math.sin(r*n)*Math.sin(i*n))/(Math.cos(r*n)*Math.cos(i*n)))/n,!isNaN(n)&&0!==n||(n=o/Math.cos(Math.PI/180*r)),this._point=e.subtract(a.getPixelOrigin()),this._radius=isNaN(n)?0:e.x-a.project([i,s-n]).x,this._radiusY=e.y-t.y):(o=h.unproject(h.project(this._latlng).subtract([this._mRadius,0])),this._point=a.latLngToLayerPoint(this._latlng),this._radius=this._point.x-a.latLngToLayerPoint(o).x),this._updateBounds()}});var yi=fi.extend({options:{smoothFactor:1,noClip:!1},initialize:function(t,e){c(this,e),this._setLatLngs(t)},getLatLngs:function(){return this._latlngs},setLatLngs:function(t){return this._setLatLngs(t),this.redraw()},isEmpty:function(){return!this._latlngs.length},closestLayerPoint:function(t){for(var e=1/0,i=null,n=ri,o=0,s=this._parts.length;o<s;o++)for(var r=this._parts[o],a=1,h=r.length;a<h;a++){var l,u,c=n(t,l=r[a-1],u=r[a],!0);c<e&&(e=c,i=n(t,l,u))}return i&&(i.distance=Math.sqrt(e)),i},getCenter:function(){if(this._map)return hi(this._defaultShape(),this._map.options.crs);throw new Error("Must add layer to map before using getCenter()")},getBounds:function(){return this._bounds},addLatLng:function(t,e){return e=e||this._defaultShape(),t=w(t),e.push(t),this._bounds.extend(t),this.redraw()},_setLatLngs:function(t){this._bounds=new s,this._latlngs=this._convertLatLngs(t)},_defaultShape:function(){return I(this._latlngs)?this._latlngs:this._latlngs[0]},_convertLatLngs:function(t){for(var e=[],i=I(t),n=0,o=t.length;n<o;n++)i?(e[n]=w(t[n]),this._bounds.extend(e[n])):e[n]=this._convertLatLngs(t[n]);return e},_project:function(){var t=new f;this._rings=[],this._projectLatlngs(this._latlngs,this._rings,t),this._bounds.isValid()&&t.isValid()&&(this._rawPxBounds=t,this._updateBounds())},_updateBounds:function(){var t=this._clickTolerance(),t=new p(t,t);this._rawPxBounds&&(this._pxBounds=new f([this._rawPxBounds.min.subtract(t),this._rawPxBounds.max.add(t)]))},_projectLatlngs:function(t,e,i){var n,o,s=t[0]instanceof v,r=t.length;if(s){for(o=[],n=0;n<r;n++)o[n]=this._map.latLngToLayerPoint(t[n]),i.extend(o[n]);e.push(o)}else for(n=0;n<r;n++)this._projectLatlngs(t[n],e,i)},_clipPoints:function(){var t=this._renderer._bounds;if(this._parts=[],this._pxBounds&&this._pxBounds.intersects(t))if(this.options.noClip)this._parts=this._rings;else for(var e,i,n,o,s=this._parts,r=0,a=0,h=this._rings.length;r<h;r++)for(e=0,i=(o=this._rings[r]).length;e<i-1;e++)(n=ni(o[e],o[e+1],t,e,!0))&&(s[a]=s[a]||[],s[a].push(n[0]),n[1]===o[e+1]&&e!==i-2||(s[a].push(n[1]),a++))},_simplifyPoints:function(){for(var t=this._parts,e=this.options.smoothFactor,i=0,n=t.length;i<n;i++)t[i]=ei(t[i],e)},_update:function(){this._map&&(this._clipPoints(),this._simplifyPoints(),this._updatePath())},_updatePath:function(){this._renderer._updatePoly(this)},_containsPoint:function(t,e){var i,n,o,s,r,a,h=this._clickTolerance();if(this._pxBounds&&this._pxBounds.contains(t))for(i=0,s=this._parts.length;i<s;i++)for(n=0,o=(r=(a=this._parts[i]).length)-1;n<r;o=n++)if((e||0!==n)&&ii(t,a[o],a[n])<=h)return!0;return!1}});yi._flat=ai;var xi=yi.extend({options:{fill:!0},isEmpty:function(){return!this._latlngs.length||!this._latlngs[0].length},getCenter:function(){if(this._map)return $e(this._defaultShape(),this._map.options.crs);throw new Error("Must add layer to map before using getCenter()")},_convertLatLngs:function(t){var t=yi.prototype._convertLatLngs.call(this,t),e=t.length;return 2<=e&&t[0]instanceof v&&t[0].equals(t[e-1])&&t.pop(),t},_setLatLngs:function(t){yi.prototype._setLatLngs.call(this,t),I(this._latlngs)&&(this._latlngs=[this._latlngs])},_defaultShape:function(){return(I(this._latlngs[0])?this._latlngs:this._latlngs[0])[0]},_clipPoints:function(){var t=this._renderer._bounds,e=this.options.weight,e=new p(e,e),t=new f(t.min.subtract(e),t.max.add(e));if(this._parts=[],this._pxBounds&&this._pxBounds.intersects(t))if(this.options.noClip)this._parts=this._rings;else for(var i,n=0,o=this._rings.length;n<o;n++)(i=Je(this._rings[n],t,!0)).length&&this._parts.push(i)},_updatePath:function(){this._renderer._updatePoly(this,!0)},_containsPoint:function(t){var e,i,n,o,s,r,a,h,l=!1;if(!this._pxBounds||!this._pxBounds.contains(t))return!1;for(o=0,a=this._parts.length;o<a;o++)for(s=0,r=(h=(e=this._parts[o]).length)-1;s<h;r=s++)i=e[s],n=e[r],i.y>t.y!=n.y>t.y&&t.x<(n.x-i.x)*(t.y-i.y)/(n.y-i.y)+i.x&&(l=!l);return l||yi.prototype._containsPoint.call(this,t,!0)}});var wi=ci.extend({initialize:function(t,e){c(this,e),this._layers={},t&&this.addData(t)},addData:function(t){var e,i,n,o=d(t)?t:t.features;if(o){for(e=0,i=o.length;e<i;e++)((n=o[e]).geometries||n.geometry||n.features||n.coordinates)&&this.addData(n);return this}var s,r=this.options;return(!r.filter||r.filter(t))&&(s=bi(t,r))?(s.feature=Zi(t),s.defaultOptions=s.options,this.resetStyle(s),r.onEachFeature&&r.onEachFeature(t,s),this.addLayer(s)):this},resetStyle:function(t){return void 0===t?this.eachLayer(this.resetStyle,this):(t.options=l({},t.defaultOptions),this._setLayerStyle(t,this.options.style),this)},setStyle:function(e){return this.eachLayer(function(t){this._setLayerStyle(t,e)},this)},_setLayerStyle:function(t,e){t.setStyle&&("function"==typeof e&&(e=e(t.feature)),t.setStyle(e))}});function bi(t,e){var i,n,o,s,r="Feature"===t.type?t.geometry:t,a=r?r.coordinates:null,h=[],l=e&&e.pointToLayer,u=e&&e.coordsToLatLng||Li;if(!a&&!r)return null;switch(r.type){case"Point":return Pi(l,t,i=u(a),e);case"MultiPoint":for(o=0,s=a.length;o<s;o++)i=u(a[o]),h.push(Pi(l,t,i,e));return new ci(h);case"LineString":case"MultiLineString":return n=Ti(a,"LineString"===r.type?0:1,u),new yi(n,e);case"Polygon":case"MultiPolygon":return n=Ti(a,"Polygon"===r.type?1:2,u),new xi(n,e);case"GeometryCollection":for(o=0,s=r.geometries.length;o<s;o++){var c=bi({geometry:r.geometries[o],type:"Feature",properties:t.properties},e);c&&h.push(c)}return new ci(h);case"FeatureCollection":for(o=0,s=r.features.length;o<s;o++){var d=bi(r.features[o],e);d&&h.push(d)}return new ci(h);default:throw new Error("Invalid GeoJSON object.")}}function Pi(t,e,i,n){return t?t(e,i):new mi(i,n&&n.markersInheritOptions&&n)}function Li(t){return new v(t[1],t[0],t[2])}function Ti(t,e,i){for(var n,o=[],s=0,r=t.length;s<r;s++)n=e?Ti(t[s],e-1,i):(i||Li)(t[s]),o.push(n);return o}function Mi(t,e){return void 0!==(t=w(t)).alt?[i(t.lng,e),i(t.lat,e),i(t.alt,e)]:[i(t.lng,e),i(t.lat,e)]}function zi(t,e,i,n){for(var o=[],s=0,r=t.length;s<r;s++)o.push(e?zi(t[s],I(t[s])?0:e-1,i,n):Mi(t[s],n));return!e&&i&&0<o.length&&o.push(o[0].slice()),o}function Ci(t,e){return t.feature?l({},t.feature,{geometry:e}):Zi(e)}function Zi(t){return"Feature"===t.type||"FeatureCollection"===t.type?t:{type:"Feature",properties:{},geometry:t}}Tt={toGeoJSON:function(t){return Ci(this,{type:"Point",coordinates:Mi(this.getLatLng(),t)})}};function Si(t,e){return new wi(t,e)}mi.include(Tt),vi.include(Tt),gi.include(Tt),yi.include({toGeoJSON:function(t){var e=!I(this._latlngs);return Ci(this,{type:(e?"Multi":"")+"LineString",coordinates:zi(this._latlngs,e?1:0,!1,t)})}}),xi.include({toGeoJSON:function(t){var e=!I(this._latlngs),i=e&&!I(this._latlngs[0]),t=zi(this._latlngs,i?2:e?1:0,!0,t);return Ci(this,{type:(i?"Multi":"")+"Polygon",coordinates:t=e?t:[t]})}}),ui.include({toMultiPoint:function(e){var i=[];return this.eachLayer(function(t){i.push(t.toGeoJSON(e).geometry.coordinates)}),Ci(this,{type:"MultiPoint",coordinates:i})},toGeoJSON:function(e){var i,n,t=this.feature&&this.feature.geometry&&this.feature.geometry.type;return"MultiPoint"===t?this.toMultiPoint(e):(i="GeometryCollection"===t,n=[],this.eachLayer(function(t){t.toGeoJSON&&(t=t.toGeoJSON(e),i?n.push(t.geometry):"FeatureCollection"===(t=Zi(t)).type?n.push.apply(n,t.features):n.push(t))}),i?Ci(this,{geometries:n,type:"GeometryCollection"}):{type:"FeatureCollection",features:n})}});var Mt=Si,Ei=o.extend({options:{opacity:1,alt:"",interactive:!1,crossOrigin:!1,errorOverlayUrl:"",zIndex:1,className:""},initialize:function(t,e,i){this._url=t,this._bounds=g(e),c(this,i)},onAdd:function(){this._image||(this._initImage(),this.options.opacity<1&&this._updateOpacity()),this.options.interactive&&(M(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this.getPane().appendChild(this._image),this._reset()},onRemove:function(){T(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},setOpacity:function(t){return this.options.opacity=t,this._image&&this._updateOpacity(),this},setStyle:function(t){return t.opacity&&this.setOpacity(t.opacity),this},bringToFront:function(){return this._map&&fe(this._image),this},bringToBack:function(){return this._map&&ge(this._image),this},setUrl:function(t){return this._url=t,this._image&&(this._image.src=t),this},setBounds:function(t){return this._bounds=g(t),this._map&&this._reset(),this},getEvents:function(){var t={zoom:this._reset,viewreset:this._reset};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},getBounds:function(){return this._bounds},getElement:function(){return this._image},_initImage:function(){var t="IMG"===this._url.tagName,e=this._image=t?this._url:P("img");M(e,"leaflet-image-layer"),this._zoomAnimated&&M(e,"leaflet-zoom-animated"),this.options.className&&M(e,this.options.className),e.onselectstart=u,e.onmousemove=u,e.onload=a(this.fire,this,"load"),e.onerror=a(this._overlayOnError,this,"error"),!this.options.crossOrigin&&""!==this.options.crossOrigin||(e.crossOrigin=!0===this.options.crossOrigin?"":this.options.crossOrigin),this.options.zIndex&&this._updateZIndex(),t?this._url=e.src:(e.src=this._url,e.alt=this.options.alt)},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),t=this._map._latLngBoundsToNewLayerBounds(this._bounds,t.zoom,t.center).min;be(this._image,t,e)},_reset:function(){var t=this._image,e=new f(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),i=e.getSize();Z(t,e.min),t.style.width=i.x+"px",t.style.height=i.y+"px"},_updateOpacity:function(){C(this._image,this.options.opacity)},_updateZIndex:function(){this._image&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._image.style.zIndex=this.options.zIndex)},_overlayOnError:function(){this.fire("error");var t=this.options.errorOverlayUrl;t&&this._url!==t&&(this._url=t,this._image.src=t)},getCenter:function(){return this._bounds.getCenter()}}),ki=Ei.extend({options:{autoplay:!0,loop:!0,keepAspectRatio:!0,muted:!1,playsInline:!0},_initImage:function(){var t="VIDEO"===this._url.tagName,e=this._image=t?this._url:P("video");if(M(e,"leaflet-image-layer"),this._zoomAnimated&&M(e,"leaflet-zoom-animated"),this.options.className&&M(e,this.options.className),e.onselectstart=u,e.onmousemove=u,e.onloadeddata=a(this.fire,this,"load"),t){for(var i=e.getElementsByTagName("source"),n=[],o=0;o<i.length;o++)n.push(i[o].src);this._url=0<i.length?n:[e.src]}else{d(this._url)||(this._url=[this._url]),!this.options.keepAspectRatio&&Object.prototype.hasOwnProperty.call(e.style,"objectFit")&&(e.style.objectFit="fill"),e.autoplay=!!this.options.autoplay,e.loop=!!this.options.loop,e.muted=!!this.options.muted,e.playsInline=!!this.options.playsInline;for(var s=0;s<this._url.length;s++){var r=P("source");r.src=this._url[s],e.appendChild(r)}}}});var Oi=Ei.extend({_initImage:function(){var t=this._image=this._url;M(t,"leaflet-image-layer"),this._zoomAnimated&&M(t,"leaflet-zoom-animated"),this.options.className&&M(t,this.options.className),t.onselectstart=u,t.onmousemove=u}});var Ai=o.extend({options:{interactive:!1,offset:[0,0],className:"",pane:void 0,content:""},initialize:function(t,e){t&&(t instanceof v||d(t))?(this._latlng=w(t),c(this,e)):(c(this,t),this._source=e),this.options.content&&(this._content=this.options.content)},openOn:function(t){return(t=arguments.length?t:this._source._map).hasLayer(this)||t.addLayer(this),this},close:function(){return this._map&&this._map.removeLayer(this),this},toggle:function(t){return this._map?this.close():(arguments.length?this._source=t:t=this._source,this._prepareOpen(),this.openOn(t._map)),this},onAdd:function(t){this._zoomAnimated=t._zoomAnimated,this._container||this._initLayout(),t._fadeAnimated&&C(this._container,0),clearTimeout(this._removeTimeout),this.getPane().appendChild(this._container),this.update(),t._fadeAnimated&&C(this._container,1),this.bringToFront(),this.options.interactive&&(M(this._container,"leaflet-interactive"),this.addInteractiveTarget(this._container))},onRemove:function(t){t._fadeAnimated?(C(this._container,0),this._removeTimeout=setTimeout(a(T,void 0,this._container),200)):T(this._container),this.options.interactive&&(z(this._container,"leaflet-interactive"),this.removeInteractiveTarget(this._container))},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=w(t),this._map&&(this._updatePosition(),this._adjustPan()),this},getContent:function(){return this._content},setContent:function(t){return this._content=t,this.update(),this},getElement:function(){return this._container},update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this._adjustPan())},getEvents:function(){var t={zoom:this._updatePosition,viewreset:this._updatePosition};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},isOpen:function(){return!!this._map&&this._map.hasLayer(this)},bringToFront:function(){return this._map&&fe(this._container),this},bringToBack:function(){return this._map&&ge(this._container),this},_prepareOpen:function(t){if(!(i=this._source)._map)return!1;if(i instanceof ci){var e,i=null,n=this._source._layers;for(e in n)if(n[e]._map){i=n[e];break}if(!i)return!1;this._source=i}if(!t)if(i.getCenter)t=i.getCenter();else if(i.getLatLng)t=i.getLatLng();else{if(!i.getBounds)throw new Error("Unable to get source layer LatLng.");t=i.getBounds().getCenter()}return this.setLatLng(t),this._map&&this.update(),!0},_updateContent:function(){if(this._content){var t=this._contentNode,e="function"==typeof this._content?this._content(this._source||this):this._content;if("string"==typeof e)t.innerHTML=e;else{for(;t.hasChildNodes();)t.removeChild(t.firstChild);t.appendChild(e)}this.fire("contentupdate")}},_updatePosition:function(){var t,e,i;this._map&&(e=this._map.latLngToLayerPoint(this._latlng),t=m(this.options.offset),i=this._getAnchor(),this._zoomAnimated?Z(this._container,e.add(i)):t=t.add(e).add(i),e=this._containerBottom=-t.y,i=this._containerLeft=-Math.round(this._containerWidth/2)+t.x,this._container.style.bottom=e+"px",this._container.style.left=i+"px")},_getAnchor:function(){return[0,0]}}),Bi=(A.include({_initOverlay:function(t,e,i,n){var o=e;return o instanceof t||(o=new t(n).setContent(e)),i&&o.setLatLng(i),o}}),o.include({_initOverlay:function(t,e,i,n){var o=i;return o instanceof t?(c(o,n),o._source=this):(o=e&&!n?e:new t(n,this)).setContent(i),o}}),Ai.extend({options:{pane:"popupPane",offset:[0,7],maxWidth:300,minWidth:50,maxHeight:null,autoPan:!0,autoPanPaddingTopLeft:null,autoPanPaddingBottomRight:null,autoPanPadding:[5,5],keepInView:!1,closeButton:!0,autoClose:!0,closeOnEscapeKey:!0,className:""},openOn:function(t){return!(t=arguments.length?t:this._source._map).hasLayer(this)&&t._popup&&t._popup.options.autoClose&&t.removeLayer(t._popup),t._popup=this,Ai.prototype.openOn.call(this,t)},onAdd:function(t){Ai.prototype.onAdd.call(this,t),t.fire("popupopen",{popup:this}),this._source&&(this._source.fire("popupopen",{popup:this},!0),this._source instanceof fi||this._source.on("preclick",Ae))},onRemove:function(t){Ai.prototype.onRemove.call(this,t),t.fire("popupclose",{popup:this}),this._source&&(this._source.fire("popupclose",{popup:this},!0),this._source instanceof fi||this._source.off("preclick",Ae))},getEvents:function(){var t=Ai.prototype.getEvents.call(this);return(void 0!==this.options.closeOnClick?this.options.closeOnClick:this._map.options.closePopupOnClick)&&(t.preclick=this.close),this.options.keepInView&&(t.moveend=this._adjustPan),t},_initLayout:function(){var t="leaflet-popup",e=this._container=P("div",t+" "+(this.options.className||"")+" leaflet-zoom-animated"),i=this._wrapper=P("div",t+"-content-wrapper",e);this._contentNode=P("div",t+"-content",i),Ie(e),Be(this._contentNode),S(e,"contextmenu",Ae),this._tipContainer=P("div",t+"-tip-container",e),this._tip=P("div",t+"-tip",this._tipContainer),this.options.closeButton&&((i=this._closeButton=P("a",t+"-close-button",e)).setAttribute("role","button"),i.setAttribute("aria-label","Close popup"),i.href="#close",i.innerHTML='<span aria-hidden="true">&#215;</span>',S(i,"click",function(t){O(t),this.close()},this))},_updateLayout:function(){var t=this._contentNode,e=t.style,i=(e.width="",e.whiteSpace="nowrap",t.offsetWidth),i=Math.min(i,this.options.maxWidth),i=(i=Math.max(i,this.options.minWidth),e.width=i+1+"px",e.whiteSpace="",e.height="",t.offsetHeight),n=this.options.maxHeight,o="leaflet-popup-scrolled";(n&&n<i?(e.height=n+"px",M):z)(t,o),this._containerWidth=this._container.offsetWidth},_animateZoom:function(t){var t=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center),e=this._getAnchor();Z(this._container,t.add(e))},_adjustPan:function(){var t,e,i,n,o,s,r,a;this.options.autoPan&&(this._map._panAnim&&this._map._panAnim.stop(),this._autopanning?this._autopanning=!1:(t=this._map,e=parseInt(pe(this._container,"marginBottom"),10)||0,e=this._container.offsetHeight+e,a=this._containerWidth,(i=new p(this._containerLeft,-e-this._containerBottom))._add(Pe(this._container)),i=t.layerPointToContainerPoint(i),o=m(this.options.autoPanPadding),n=m(this.options.autoPanPaddingTopLeft||o),o=m(this.options.autoPanPaddingBottomRight||o),s=t.getSize(),r=0,i.x+a+o.x>s.x&&(r=i.x+a-s.x+o.x),i.x-r-n.x<(a=0)&&(r=i.x-n.x),i.y+e+o.y>s.y&&(a=i.y+e-s.y+o.y),i.y-a-n.y<0&&(a=i.y-n.y),(r||a)&&(this.options.keepInView&&(this._autopanning=!0),t.fire("autopanstart").panBy([r,a]))))},_getAnchor:function(){return m(this._source&&this._source._getPopupAnchor?this._source._getPopupAnchor():[0,0])}})),Ii=(A.mergeOptions({closePopupOnClick:!0}),A.include({openPopup:function(t,e,i){return this._initOverlay(Bi,t,e,i).openOn(this),this},closePopup:function(t){return(t=arguments.length?t:this._popup)&&t.close(),this}}),o.include({bindPopup:function(t,e){return this._popup=this._initOverlay(Bi,this._popup,t,e),this._popupHandlersAdded||(this.on({click:this._openPopup,keypress:this._onKeyPress,remove:this.closePopup,move:this._movePopup}),this._popupHandlersAdded=!0),this},unbindPopup:function(){return this._popup&&(this.off({click:this._openPopup,keypress:this._onKeyPress,remove:this.closePopup,move:this._movePopup}),this._popupHandlersAdded=!1,this._popup=null),this},openPopup:function(t){return this._popup&&(this instanceof ci||(this._popup._source=this),this._popup._prepareOpen(t||this._latlng)&&this._popup.openOn(this._map)),this},closePopup:function(){return this._popup&&this._popup.close(),this},togglePopup:function(){return this._popup&&this._popup.toggle(this),this},isPopupOpen:function(){return!!this._popup&&this._popup.isOpen()},setPopupContent:function(t){return this._popup&&this._popup.setContent(t),this},getPopup:function(){return this._popup},_openPopup:function(t){var e;this._popup&&this._map&&(Re(t),e=t.layer||t.target,this._popup._source!==e||e instanceof fi?(this._popup._source=e,this.openPopup(t.latlng)):this._map.hasLayer(this._popup)?this.closePopup():this.openPopup(t.latlng))},_movePopup:function(t){this._popup.setLatLng(t.latlng)},_onKeyPress:function(t){13===t.originalEvent.keyCode&&this._openPopup(t)}}),Ai.extend({options:{pane:"tooltipPane",offset:[0,0],direction:"auto",permanent:!1,sticky:!1,opacity:.9},onAdd:function(t){Ai.prototype.onAdd.call(this,t),this.setOpacity(this.options.opacity),t.fire("tooltipopen",{tooltip:this}),this._source&&(this.addEventParent(this._source),this._source.fire("tooltipopen",{tooltip:this},!0))},onRemove:function(t){Ai.prototype.onRemove.call(this,t),t.fire("tooltipclose",{tooltip:this}),this._source&&(this.removeEventParent(this._source),this._source.fire("tooltipclose",{tooltip:this},!0))},getEvents:function(){var t=Ai.prototype.getEvents.call(this);return this.options.permanent||(t.preclick=this.close),t},_initLayout:function(){var t="leaflet-tooltip "+(this.options.className||"")+" leaflet-zoom-"+(this._zoomAnimated?"animated":"hide");this._contentNode=this._container=P("div",t),this._container.setAttribute("role","tooltip"),this._container.setAttribute("id","leaflet-tooltip-"+h(this))},_updateLayout:function(){},_adjustPan:function(){},_setPosition:function(t){var e,i=this._map,n=this._container,o=i.latLngToContainerPoint(i.getCenter()),i=i.layerPointToContainerPoint(t),s=this.options.direction,r=n.offsetWidth,a=n.offsetHeight,h=m(this.options.offset),l=this._getAnchor(),i="top"===s?(e=r/2,a):"bottom"===s?(e=r/2,0):(e="center"===s?r/2:"right"===s?0:"left"===s?r:i.x<o.x?(s="right",0):(s="left",r+2*(h.x+l.x)),a/2);t=t.subtract(m(e,i,!0)).add(h).add(l),z(n,"leaflet-tooltip-right"),z(n,"leaflet-tooltip-left"),z(n,"leaflet-tooltip-top"),z(n,"leaflet-tooltip-bottom"),M(n,"leaflet-tooltip-"+s),Z(n,t)},_updatePosition:function(){var t=this._map.latLngToLayerPoint(this._latlng);this._setPosition(t)},setOpacity:function(t){this.options.opacity=t,this._container&&C(this._container,t)},_animateZoom:function(t){t=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center);this._setPosition(t)},_getAnchor:function(){return m(this._source&&this._source._getTooltipAnchor&&!this.options.sticky?this._source._getTooltipAnchor():[0,0])}})),Ri=(A.include({openTooltip:function(t,e,i){return this._initOverlay(Ii,t,e,i).openOn(this),this},closeTooltip:function(t){return t.close(),this}}),o.include({bindTooltip:function(t,e){return this._tooltip&&this.isTooltipOpen()&&this.unbindTooltip(),this._tooltip=this._initOverlay(Ii,this._tooltip,t,e),this._initTooltipInteractions(),this._tooltip.options.permanent&&this._map&&this._map.hasLayer(this)&&this.openTooltip(),this},unbindTooltip:function(){return this._tooltip&&(this._initTooltipInteractions(!0),this.closeTooltip(),this._tooltip=null),this},_initTooltipInteractions:function(t){var e,i;!t&&this._tooltipHandlersAdded||(e=t?"off":"on",i={remove:this.closeTooltip,move:this._moveTooltip},this._tooltip.options.permanent?i.add=this._openTooltip:(i.mouseover=this._openTooltip,i.mouseout=this.closeTooltip,i.click=this._openTooltip,this._map?this._addFocusListeners():i.add=this._addFocusListeners),this._tooltip.options.sticky&&(i.mousemove=this._moveTooltip),this[e](i),this._tooltipHandlersAdded=!t)},openTooltip:function(t){return this._tooltip&&(this instanceof ci||(this._tooltip._source=this),this._tooltip._prepareOpen(t)&&(this._tooltip.openOn(this._map),this.getElement?this._setAriaDescribedByOnLayer(this):this.eachLayer&&this.eachLayer(this._setAriaDescribedByOnLayer,this))),this},closeTooltip:function(){if(this._tooltip)return this._tooltip.close()},toggleTooltip:function(){return this._tooltip&&this._tooltip.toggle(this),this},isTooltipOpen:function(){return this._tooltip.isOpen()},setTooltipContent:function(t){return this._tooltip&&this._tooltip.setContent(t),this},getTooltip:function(){return this._tooltip},_addFocusListeners:function(){this.getElement?this._addFocusListenersOnLayer(this):this.eachLayer&&this.eachLayer(this._addFocusListenersOnLayer,this)},_addFocusListenersOnLayer:function(t){var e="function"==typeof t.getElement&&t.getElement();e&&(S(e,"focus",function(){this._tooltip._source=t,this.openTooltip()},this),S(e,"blur",this.closeTooltip,this))},_setAriaDescribedByOnLayer:function(t){t="function"==typeof t.getElement&&t.getElement();t&&t.setAttribute("aria-describedby",this._tooltip._container.id)},_openTooltip:function(t){var e;this._tooltip&&this._map&&(this._map.dragging&&this._map.dragging.moving()&&!this._openOnceFlag?(this._openOnceFlag=!0,(e=this)._map.once("moveend",function(){e._openOnceFlag=!1,e._openTooltip(t)})):(this._tooltip._source=t.layer||t.target,this.openTooltip(this._tooltip.options.sticky?t.latlng:void 0)))},_moveTooltip:function(t){var e=t.latlng;this._tooltip.options.sticky&&t.originalEvent&&(t=this._map.mouseEventToContainerPoint(t.originalEvent),t=this._map.containerPointToLayerPoint(t),e=this._map.layerPointToLatLng(t)),this._tooltip.setLatLng(e)}}),di.extend({options:{iconSize:[12,12],html:!1,bgPos:null,className:"leaflet-div-icon"},createIcon:function(t){var t=t&&"DIV"===t.tagName?t:document.createElement("div"),e=this.options;return e.html instanceof Element?(me(t),t.appendChild(e.html)):t.innerHTML=!1!==e.html?e.html:"",e.bgPos&&(e=m(e.bgPos),t.style.backgroundPosition=-e.x+"px "+-e.y+"px"),this._setIconStyles(t,"icon"),t},createShadow:function(){return null}}));di.Default=_i;var Ni=o.extend({options:{tileSize:256,opacity:1,updateWhenIdle:b.mobile,updateWhenZooming:!0,updateInterval:200,zIndex:1,bounds:null,minZoom:0,maxZoom:void 0,maxNativeZoom:void 0,minNativeZoom:void 0,noWrap:!1,pane:"tilePane",className:"",keepBuffer:2},initialize:function(t){c(this,t)},onAdd:function(){this._initContainer(),this._levels={},this._tiles={},this._resetView()},beforeAdd:function(t){t._addZoomLimit(this)},onRemove:function(t){this._removeAllTiles(),T(this._container),t._removeZoomLimit(this),this._container=null,this._tileZoom=void 0},bringToFront:function(){return this._map&&(fe(this._container),this._setAutoZIndex(Math.max)),this},bringToBack:function(){return this._map&&(ge(this._container),this._setAutoZIndex(Math.min)),this},getContainer:function(){return this._container},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},isLoading:function(){return this._loading},redraw:function(){var t;return this._map&&(this._removeAllTiles(),(t=this._clampZoom(this._map.getZoom()))!==this._tileZoom&&(this._tileZoom=t,this._updateLevels()),this._update()),this},getEvents:function(){var t={viewprereset:this._invalidateAll,viewreset:this._resetView,zoom:this._resetView,moveend:this._onMoveEnd};return this.options.updateWhenIdle||(this._onMove||(this._onMove=j(this._onMoveEnd,this.options.updateInterval,this)),t.move=this._onMove),this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},createTile:function(){return document.createElement("div")},getTileSize:function(){var t=this.options.tileSize;return t instanceof p?t:new p(t,t)},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_setAutoZIndex:function(t){for(var e,i=this.getPane().children,n=-t(-1/0,1/0),o=0,s=i.length;o<s;o++)e=i[o].style.zIndex,i[o]!==this._container&&e&&(n=t(n,+e));isFinite(n)&&(this.options.zIndex=n+t(-1,1),this._updateZIndex())},_updateOpacity:function(){if(this._map&&!b.ielt9){C(this._container,this.options.opacity);var t,e=+new Date,i=!1,n=!1;for(t in this._tiles){var o,s=this._tiles[t];s.current&&s.loaded&&(o=Math.min(1,(e-s.loaded)/200),C(s.el,o),o<1?i=!0:(s.active?n=!0:this._onOpaqueTile(s),s.active=!0))}n&&!this._noPrune&&this._pruneTiles(),i&&(r(this._fadeFrame),this._fadeFrame=x(this._updateOpacity,this))}},_onOpaqueTile:u,_initContainer:function(){this._container||(this._container=P("div","leaflet-layer "+(this.options.className||"")),this._updateZIndex(),this.options.opacity<1&&this._updateOpacity(),this.getPane().appendChild(this._container))},_updateLevels:function(){var t=this._tileZoom,e=this.options.maxZoom;if(void 0!==t){for(var i in this._levels)i=Number(i),this._levels[i].el.children.length||i===t?(this._levels[i].el.style.zIndex=e-Math.abs(t-i),this._onUpdateLevel(i)):(T(this._levels[i].el),this._removeTilesAtZoom(i),this._onRemoveLevel(i),delete this._levels[i]);var n=this._levels[t],o=this._map;return n||((n=this._levels[t]={}).el=P("div","leaflet-tile-container leaflet-zoom-animated",this._container),n.el.style.zIndex=e,n.origin=o.project(o.unproject(o.getPixelOrigin()),t).round(),n.zoom=t,this._setZoomTransform(n,o.getCenter(),o.getZoom()),u(n.el.offsetWidth),this._onCreateLevel(n)),this._level=n}},_onUpdateLevel:u,_onRemoveLevel:u,_onCreateLevel:u,_pruneTiles:function(){if(this._map){var t,e,i,n=this._map.getZoom();if(n>this.options.maxZoom||n<this.options.minZoom)this._removeAllTiles();else{for(t in this._tiles)(i=this._tiles[t]).retain=i.current;for(t in this._tiles)(i=this._tiles[t]).current&&!i.active&&(e=i.coords,this._retainParent(e.x,e.y,e.z,e.z-5)||this._retainChildren(e.x,e.y,e.z,e.z+2));for(t in this._tiles)this._tiles[t].retain||this._removeTile(t)}}},_removeTilesAtZoom:function(t){for(var e in this._tiles)this._tiles[e].coords.z===t&&this._removeTile(e)},_removeAllTiles:function(){for(var t in this._tiles)this._removeTile(t)},_invalidateAll:function(){for(var t in this._levels)T(this._levels[t].el),this._onRemoveLevel(Number(t)),delete this._levels[t];this._removeAllTiles(),this._tileZoom=void 0},_retainParent:function(t,e,i,n){var t=Math.floor(t/2),e=Math.floor(e/2),i=i-1,o=new p(+t,+e),o=(o.z=i,this._tileCoordsToKey(o)),o=this._tiles[o];return o&&o.active?o.retain=!0:(o&&o.loaded&&(o.retain=!0),n<i&&this._retainParent(t,e,i,n))},_retainChildren:function(t,e,i,n){for(var o=2*t;o<2*t+2;o++)for(var s=2*e;s<2*e+2;s++){var r=new p(o,s),r=(r.z=i+1,this._tileCoordsToKey(r)),r=this._tiles[r];r&&r.active?r.retain=!0:(r&&r.loaded&&(r.retain=!0),i+1<n&&this._retainChildren(o,s,i+1,n))}},_resetView:function(t){t=t&&(t.pinch||t.flyTo);this._setView(this._map.getCenter(),this._map.getZoom(),t,t)},_animateZoom:function(t){this._setView(t.center,t.zoom,!0,t.noUpdate)},_clampZoom:function(t){var e=this.options;return void 0!==e.minNativeZoom&&t<e.minNativeZoom?e.minNativeZoom:void 0!==e.maxNativeZoom&&e.maxNativeZoom<t?e.maxNativeZoom:t},_setView:function(t,e,i,n){var o=Math.round(e),o=void 0!==this.options.maxZoom&&o>this.options.maxZoom||void 0!==this.options.minZoom&&o<this.options.minZoom?void 0:this._clampZoom(o),s=this.options.updateWhenZooming&&o!==this._tileZoom;n&&!s||(this._tileZoom=o,this._abortLoading&&this._abortLoading(),this._updateLevels(),this._resetGrid(),void 0!==o&&this._update(t),i||this._pruneTiles(),this._noPrune=!!i),this._setZoomTransforms(t,e)},_setZoomTransforms:function(t,e){for(var i in this._levels)this._setZoomTransform(this._levels[i],t,e)},_setZoomTransform:function(t,e,i){var n=this._map.getZoomScale(i,t.zoom),e=t.origin.multiplyBy(n).subtract(this._map._getNewPixelOrigin(e,i)).round();b.any3d?be(t.el,e,n):Z(t.el,e)},_resetGrid:function(){var t=this._map,e=t.options.crs,i=this._tileSize=this.getTileSize(),n=this._tileZoom,o=this._map.getPixelWorldBounds(this._tileZoom);o&&(this._globalTileRange=this._pxBoundsToTileRange(o)),this._wrapX=e.wrapLng&&!this.options.noWrap&&[Math.floor(t.project([0,e.wrapLng[0]],n).x/i.x),Math.ceil(t.project([0,e.wrapLng[1]],n).x/i.y)],this._wrapY=e.wrapLat&&!this.options.noWrap&&[Math.floor(t.project([e.wrapLat[0],0],n).y/i.x),Math.ceil(t.project([e.wrapLat[1],0],n).y/i.y)]},_onMoveEnd:function(){this._map&&!this._map._animatingZoom&&this._update()},_getTiledPixelBounds:function(t){var e=this._map,i=e._animatingZoom?Math.max(e._animateToZoom,e.getZoom()):e.getZoom(),i=e.getZoomScale(i,this._tileZoom),t=e.project(t,this._tileZoom).floor(),e=e.getSize().divideBy(2*i);return new f(t.subtract(e),t.add(e))},_update:function(t){var e=this._map;if(e){var i=this._clampZoom(e.getZoom());if(void 0===t&&(t=e.getCenter()),void 0!==this._tileZoom){var n,e=this._getTiledPixelBounds(t),o=this._pxBoundsToTileRange(e),s=o.getCenter(),r=[],e=this.options.keepBuffer,a=new f(o.getBottomLeft().subtract([e,-e]),o.getTopRight().add([e,-e]));if(!(isFinite(o.min.x)&&isFinite(o.min.y)&&isFinite(o.max.x)&&isFinite(o.max.y)))throw new Error("Attempted to load an infinite number of tiles");for(n in this._tiles){var h=this._tiles[n].coords;h.z===this._tileZoom&&a.contains(new p(h.x,h.y))||(this._tiles[n].current=!1)}if(1<Math.abs(i-this._tileZoom))this._setView(t,i);else{for(var l=o.min.y;l<=o.max.y;l++)for(var u=o.min.x;u<=o.max.x;u++){var c,d=new p(u,l);d.z=this._tileZoom,this._isValidTile(d)&&((c=this._tiles[this._tileCoordsToKey(d)])?c.current=!0:r.push(d))}if(r.sort(function(t,e){return t.distanceTo(s)-e.distanceTo(s)}),0!==r.length){this._loading||(this._loading=!0,this.fire("loading"));for(var _=document.createDocumentFragment(),u=0;u<r.length;u++)this._addTile(r[u],_);this._level.el.appendChild(_)}}}}},_isValidTile:function(t){var e=this._map.options.crs;if(!e.infinite){var i=this._globalTileRange;if(!e.wrapLng&&(t.x<i.min.x||t.x>i.max.x)||!e.wrapLat&&(t.y<i.min.y||t.y>i.max.y))return!1}return!this.options.bounds||(e=this._tileCoordsToBounds(t),g(this.options.bounds).overlaps(e))},_keyToBounds:function(t){return this._tileCoordsToBounds(this._keyToTileCoords(t))},_tileCoordsToNwSe:function(t){var e=this._map,i=this.getTileSize(),n=t.scaleBy(i),i=n.add(i);return[e.unproject(n,t.z),e.unproject(i,t.z)]},_tileCoordsToBounds:function(t){t=this._tileCoordsToNwSe(t),t=new s(t[0],t[1]);return t=this.options.noWrap?t:this._map.wrapLatLngBounds(t)},_tileCoordsToKey:function(t){return t.x+":"+t.y+":"+t.z},_keyToTileCoords:function(t){var t=t.split(":"),e=new p(+t[0],+t[1]);return e.z=+t[2],e},_removeTile:function(t){var e=this._tiles[t];e&&(T(e.el),delete this._tiles[t],this.fire("tileunload",{tile:e.el,coords:this._keyToTileCoords(t)}))},_initTile:function(t){M(t,"leaflet-tile");var e=this.getTileSize();t.style.width=e.x+"px",t.style.height=e.y+"px",t.onselectstart=u,t.onmousemove=u,b.ielt9&&this.options.opacity<1&&C(t,this.options.opacity)},_addTile:function(t,e){var i=this._getTilePos(t),n=this._tileCoordsToKey(t),o=this.createTile(this._wrapCoords(t),a(this._tileReady,this,t));this._initTile(o),this.createTile.length<2&&x(a(this._tileReady,this,t,null,o)),Z(o,i),this._tiles[n]={el:o,coords:t,current:!0},e.appendChild(o),this.fire("tileloadstart",{tile:o,coords:t})},_tileReady:function(t,e,i){e&&this.fire("tileerror",{error:e,tile:i,coords:t});var n=this._tileCoordsToKey(t);(i=this._tiles[n])&&(i.loaded=+new Date,this._map._fadeAnimated?(C(i.el,0),r(this._fadeFrame),this._fadeFrame=x(this._updateOpacity,this)):(i.active=!0,this._pruneTiles()),e||(M(i.el,"leaflet-tile-loaded"),this.fire("tileload",{tile:i.el,coords:t})),this._noTilesToLoad()&&(this._loading=!1,this.fire("load"),b.ielt9||!this._map._fadeAnimated?x(this._pruneTiles,this):setTimeout(a(this._pruneTiles,this),250)))},_getTilePos:function(t){return t.scaleBy(this.getTileSize()).subtract(this._level.origin)},_wrapCoords:function(t){var e=new p(this._wrapX?H(t.x,this._wrapX):t.x,this._wrapY?H(t.y,this._wrapY):t.y);return e.z=t.z,e},_pxBoundsToTileRange:function(t){var e=this.getTileSize();return new f(t.min.unscaleBy(e).floor(),t.max.unscaleBy(e).ceil().subtract([1,1]))},_noTilesToLoad:function(){for(var t in this._tiles)if(!this._tiles[t].loaded)return!1;return!0}});var Di=Ni.extend({options:{minZoom:0,maxZoom:18,subdomains:"abc",errorTileUrl:"",zoomOffset:0,tms:!1,zoomReverse:!1,detectRetina:!1,crossOrigin:!1,referrerPolicy:!1},initialize:function(t,e){this._url=t,(e=c(this,e)).detectRetina&&b.retina&&0<e.maxZoom?(e.tileSize=Math.floor(e.tileSize/2),e.zoomReverse?(e.zoomOffset--,e.minZoom=Math.min(e.maxZoom,e.minZoom+1)):(e.zoomOffset++,e.maxZoom=Math.max(e.minZoom,e.maxZoom-1)),e.minZoom=Math.max(0,e.minZoom)):e.zoomReverse?e.minZoom=Math.min(e.maxZoom,e.minZoom):e.maxZoom=Math.max(e.minZoom,e.maxZoom),"string"==typeof e.subdomains&&(e.subdomains=e.subdomains.split("")),this.on("tileunload",this._onTileRemove)},setUrl:function(t,e){return this._url===t&&void 0===e&&(e=!0),this._url=t,e||this.redraw(),this},createTile:function(t,e){var i=document.createElement("img");return S(i,"load",a(this._tileOnLoad,this,e,i)),S(i,"error",a(this._tileOnError,this,e,i)),!this.options.crossOrigin&&""!==this.options.crossOrigin||(i.crossOrigin=!0===this.options.crossOrigin?"":this.options.crossOrigin),"string"==typeof this.options.referrerPolicy&&(i.referrerPolicy=this.options.referrerPolicy),i.alt="",i.src=this.getTileUrl(t),i},getTileUrl:function(t){var e={r:b.retina?"@2x":"",s:this._getSubdomain(t),x:t.x,y:t.y,z:this._getZoomForUrl()};return this._map&&!this._map.options.crs.infinite&&(t=this._globalTileRange.max.y-t.y,this.options.tms&&(e.y=t),e["-y"]=t),q(this._url,l(e,this.options))},_tileOnLoad:function(t,e){b.ielt9?setTimeout(a(t,this,null,e),0):t(null,e)},_tileOnError:function(t,e,i){var n=this.options.errorTileUrl;n&&e.getAttribute("src")!==n&&(e.src=n),t(i,e)},_onTileRemove:function(t){t.tile.onload=null},_getZoomForUrl:function(){var t=this._tileZoom,e=this.options.maxZoom;return(t=this.options.zoomReverse?e-t:t)+this.options.zoomOffset},_getSubdomain:function(t){t=Math.abs(t.x+t.y)%this.options.subdomains.length;return this.options.subdomains[t]},_abortLoading:function(){var t,e,i;for(t in this._tiles)this._tiles[t].coords.z!==this._tileZoom&&((i=this._tiles[t].el).onload=u,i.onerror=u,i.complete||(i.src=K,e=this._tiles[t].coords,T(i),delete this._tiles[t],this.fire("tileabort",{tile:i,coords:e})))},_removeTile:function(t){var e=this._tiles[t];if(e)return e.el.setAttribute("src",K),Ni.prototype._removeTile.call(this,t)},_tileReady:function(t,e,i){if(this._map&&(!i||i.getAttribute("src")!==K))return Ni.prototype._tileReady.call(this,t,e,i)}});function ji(t,e){return new Di(t,e)}var Hi=Di.extend({defaultWmsParams:{service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},options:{crs:null,uppercase:!1},initialize:function(t,e){this._url=t;var i,n=l({},this.defaultWmsParams);for(i in e)i in this.options||(n[i]=e[i]);var t=(e=c(this,e)).detectRetina&&b.retina?2:1,o=this.getTileSize();n.width=o.x*t,n.height=o.y*t,this.wmsParams=n},onAdd:function(t){this._crs=this.options.crs||t.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version);var e=1.3<=this._wmsVersion?"crs":"srs";this.wmsParams[e]=this._crs.code,Di.prototype.onAdd.call(this,t)},getTileUrl:function(t){var e=this._tileCoordsToNwSe(t),i=this._crs,i=_(i.project(e[0]),i.project(e[1])),e=i.min,i=i.max,e=(1.3<=this._wmsVersion&&this._crs===li?[e.y,e.x,i.y,i.x]:[e.x,e.y,i.x,i.y]).join(","),i=Di.prototype.getTileUrl.call(this,t);return i+U(this.wmsParams,i,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+e},setParams:function(t,e){return l(this.wmsParams,t),e||this.redraw(),this}});Di.WMS=Hi,ji.wms=function(t,e){return new Hi(t,e)};var Wi=o.extend({options:{padding:.1},initialize:function(t){c(this,t),h(this),this._layers=this._layers||{}},onAdd:function(){this._container||(this._initContainer(),M(this._container,"leaflet-zoom-animated")),this.getPane().appendChild(this._container),this._update(),this.on("update",this._updatePaths,this)},onRemove:function(){this.off("update",this._updatePaths,this),this._destroyContainer()},getEvents:function(){var t={viewreset:this._reset,zoom:this._onZoom,moveend:this._update,zoomend:this._onZoomEnd};return this._zoomAnimated&&(t.zoomanim=this._onAnimZoom),t},_onAnimZoom:function(t){this._updateTransform(t.center,t.zoom)},_onZoom:function(){this._updateTransform(this._map.getCenter(),this._map.getZoom())},_updateTransform:function(t,e){var i=this._map.getZoomScale(e,this._zoom),n=this._map.getSize().multiplyBy(.5+this.options.padding),o=this._map.project(this._center,e),n=n.multiplyBy(-i).add(o).subtract(this._map._getNewPixelOrigin(t,e));b.any3d?be(this._container,n,i):Z(this._container,n)},_reset:function(){for(var t in this._update(),this._updateTransform(this._center,this._zoom),this._layers)this._layers[t]._reset()},_onZoomEnd:function(){for(var t in this._layers)this._layers[t]._project()},_updatePaths:function(){for(var t in this._layers)this._layers[t]._update()},_update:function(){var t=this.options.padding,e=this._map.getSize(),i=this._map.containerPointToLayerPoint(e.multiplyBy(-t)).round();this._bounds=new f(i,i.add(e.multiplyBy(1+2*t)).round()),this._center=this._map.getCenter(),this._zoom=this._map.getZoom()}}),Fi=Wi.extend({options:{tolerance:0},getEvents:function(){var t=Wi.prototype.getEvents.call(this);return t.viewprereset=this._onViewPreReset,t},_onViewPreReset:function(){this._postponeUpdatePaths=!0},onAdd:function(){Wi.prototype.onAdd.call(this),this._draw()},_initContainer:function(){var t=this._container=document.createElement("canvas");S(t,"mousemove",this._onMouseMove,this),S(t,"click dblclick mousedown mouseup contextmenu",this._onClick,this),S(t,"mouseout",this._handleMouseOut,this),t._leaflet_disable_events=!0,this._ctx=t.getContext("2d")},_destroyContainer:function(){r(this._redrawRequest),delete this._ctx,T(this._container),k(this._container),delete this._container},_updatePaths:function(){if(!this._postponeUpdatePaths){for(var t in this._redrawBounds=null,this._layers)this._layers[t]._update();this._redraw()}},_update:function(){var t,e,i,n;this._map._animatingZoom&&this._bounds||(Wi.prototype._update.call(this),t=this._bounds,e=this._container,i=t.getSize(),n=b.retina?2:1,Z(e,t.min),e.width=n*i.x,e.height=n*i.y,e.style.width=i.x+"px",e.style.height=i.y+"px",b.retina&&this._ctx.scale(2,2),this._ctx.translate(-t.min.x,-t.min.y),this.fire("update"))},_reset:function(){Wi.prototype._reset.call(this),this._postponeUpdatePaths&&(this._postponeUpdatePaths=!1,this._updatePaths())},_initPath:function(t){this._updateDashArray(t);t=(this._layers[h(t)]=t)._order={layer:t,prev:this._drawLast,next:null};this._drawLast&&(this._drawLast.next=t),this._drawLast=t,this._drawFirst=this._drawFirst||this._drawLast},_addPath:function(t){this._requestRedraw(t)},_removePath:function(t){var e=t._order,i=e.next,e=e.prev;i?i.prev=e:this._drawLast=e,e?e.next=i:this._drawFirst=i,delete t._order,delete this._layers[h(t)],this._requestRedraw(t)},_updatePath:function(t){this._extendRedrawBounds(t),t._project(),t._update(),this._requestRedraw(t)},_updateStyle:function(t){this._updateDashArray(t),this._requestRedraw(t)},_updateDashArray:function(t){if("string"==typeof t.options.dashArray){for(var e,i=t.options.dashArray.split(/[, ]+/),n=[],o=0;o<i.length;o++){if(e=Number(i[o]),isNaN(e))return;n.push(e)}t.options._dashArray=n}else t.options._dashArray=t.options.dashArray},_requestRedraw:function(t){this._map&&(this._extendRedrawBounds(t),this._redrawRequest=this._redrawRequest||x(this._redraw,this))},_extendRedrawBounds:function(t){var e;t._pxBounds&&(e=(t.options.weight||0)+1,this._redrawBounds=this._redrawBounds||new f,this._redrawBounds.extend(t._pxBounds.min.subtract([e,e])),this._redrawBounds.extend(t._pxBounds.max.add([e,e])))},_redraw:function(){this._redrawRequest=null,this._redrawBounds&&(this._redrawBounds.min._floor(),this._redrawBounds.max._ceil()),this._clear(),this._draw(),this._redrawBounds=null},_clear:function(){var t,e=this._redrawBounds;e?(t=e.getSize(),this._ctx.clearRect(e.min.x,e.min.y,t.x,t.y)):(this._ctx.save(),this._ctx.setTransform(1,0,0,1,0,0),this._ctx.clearRect(0,0,this._container.width,this._container.height),this._ctx.restore())},_draw:function(){var t,e,i=this._redrawBounds;this._ctx.save(),i&&(e=i.getSize(),this._ctx.beginPath(),this._ctx.rect(i.min.x,i.min.y,e.x,e.y),this._ctx.clip()),this._drawing=!0;for(var n=this._drawFirst;n;n=n.next)t=n.layer,(!i||t._pxBounds&&t._pxBounds.intersects(i))&&t._updatePath();this._drawing=!1,this._ctx.restore()},_updatePoly:function(t,e){if(this._drawing){var i,n,o,s,r=t._parts,a=r.length,h=this._ctx;if(a){for(h.beginPath(),i=0;i<a;i++){for(n=0,o=r[i].length;n<o;n++)s=r[i][n],h[n?"lineTo":"moveTo"](s.x,s.y);e&&h.closePath()}this._fillStroke(h,t)}}},_updateCircle:function(t){var e,i,n,o;this._drawing&&!t._empty()&&(e=t._point,i=this._ctx,n=Math.max(Math.round(t._radius),1),1!=(o=(Math.max(Math.round(t._radiusY),1)||n)/n)&&(i.save(),i.scale(1,o)),i.beginPath(),i.arc(e.x,e.y/o,n,0,2*Math.PI,!1),1!=o&&i.restore(),this._fillStroke(i,t))},_fillStroke:function(t,e){var i=e.options;i.fill&&(t.globalAlpha=i.fillOpacity,t.fillStyle=i.fillColor||i.color,t.fill(i.fillRule||"evenodd")),i.stroke&&0!==i.weight&&(t.setLineDash&&t.setLineDash(e.options&&e.options._dashArray||[]),t.globalAlpha=i.opacity,t.lineWidth=i.weight,t.strokeStyle=i.color,t.lineCap=i.lineCap,t.lineJoin=i.lineJoin,t.stroke())},_onClick:function(t){for(var e,i,n=this._map.mouseEventToLayerPoint(t),o=this._drawFirst;o;o=o.next)(e=o.layer).options.interactive&&e._containsPoint(n)&&(("click"===t.type||"preclick"===t.type)&&this._map._draggableMoved(e)||(i=e));this._fireEvent(!!i&&[i],t)},_onMouseMove:function(t){var e;!this._map||this._map.dragging.moving()||this._map._animatingZoom||(e=this._map.mouseEventToLayerPoint(t),this._handleMouseHover(t,e))},_handleMouseOut:function(t){var e=this._hoveredLayer;e&&(z(this._container,"leaflet-interactive"),this._fireEvent([e],t,"mouseout"),this._hoveredLayer=null,this._mouseHoverThrottled=!1)},_handleMouseHover:function(t,e){if(!this._mouseHoverThrottled){for(var i,n,o=this._drawFirst;o;o=o.next)(i=o.layer).options.interactive&&i._containsPoint(e)&&(n=i);n!==this._hoveredLayer&&(this._handleMouseOut(t),n&&(M(this._container,"leaflet-interactive"),this._fireEvent([n],t,"mouseover"),this._hoveredLayer=n)),this._fireEvent(!!this._hoveredLayer&&[this._hoveredLayer],t),this._mouseHoverThrottled=!0,setTimeout(a(function(){this._mouseHoverThrottled=!1},this),32)}},_fireEvent:function(t,e,i){this._map._fireDOMEvent(e,i||e.type,t)},_bringToFront:function(t){var e,i,n=t._order;n&&(e=n.next,i=n.prev,e&&((e.prev=i)?i.next=e:e&&(this._drawFirst=e),n.prev=this._drawLast,(this._drawLast.next=n).next=null,this._drawLast=n,this._requestRedraw(t)))},_bringToBack:function(t){var e,i,n=t._order;n&&(e=n.next,(i=n.prev)&&((i.next=e)?e.prev=i:i&&(this._drawLast=i),n.prev=null,n.next=this._drawFirst,this._drawFirst.prev=n,this._drawFirst=n,this._requestRedraw(t)))}});function Ui(t){return b.canvas?new Fi(t):null}var Vi=function(){try{return document.namespaces.add("lvml","urn:schemas-microsoft-com:vml"),function(t){return document.createElement("<lvml:"+t+' class="lvml">')}}catch(t){}return function(t){return document.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="lvml">')}}(),zt={_initContainer:function(){this._container=P("div","leaflet-vml-container")},_update:function(){this._map._animatingZoom||(Wi.prototype._update.call(this),this.fire("update"))},_initPath:function(t){var e=t._container=Vi("shape");M(e,"leaflet-vml-shape "+(this.options.className||"")),e.coordsize="1 1",t._path=Vi("path"),e.appendChild(t._path),this._updateStyle(t),this._layers[h(t)]=t},_addPath:function(t){var e=t._container;this._container.appendChild(e),t.options.interactive&&t.addInteractiveTarget(e)},_removePath:function(t){var e=t._container;T(e),t.removeInteractiveTarget(e),delete this._layers[h(t)]},_updateStyle:function(t){var e=t._stroke,i=t._fill,n=t.options,o=t._container;o.stroked=!!n.stroke,o.filled=!!n.fill,n.stroke?(e=e||(t._stroke=Vi("stroke")),o.appendChild(e),e.weight=n.weight+"px",e.color=n.color,e.opacity=n.opacity,n.dashArray?e.dashStyle=d(n.dashArray)?n.dashArray.join(" "):n.dashArray.replace(/( *, *)/g," "):e.dashStyle="",e.endcap=n.lineCap.replace("butt","flat"),e.joinstyle=n.lineJoin):e&&(o.removeChild(e),t._stroke=null),n.fill?(i=i||(t._fill=Vi("fill")),o.appendChild(i),i.color=n.fillColor||n.color,i.opacity=n.fillOpacity):i&&(o.removeChild(i),t._fill=null)},_updateCircle:function(t){var e=t._point.round(),i=Math.round(t._radius),n=Math.round(t._radiusY||i);this._setPath(t,t._empty()?"M0 0":"AL "+e.x+","+e.y+" "+i+","+n+" 0,23592600")},_setPath:function(t,e){t._path.v=e},_bringToFront:function(t){fe(t._container)},_bringToBack:function(t){ge(t._container)}},qi=b.vml?Vi:ct,Gi=Wi.extend({_initContainer:function(){this._container=qi("svg"),this._container.setAttribute("pointer-events","none"),this._rootGroup=qi("g"),this._container.appendChild(this._rootGroup)},_destroyContainer:function(){T(this._container),k(this._container),delete this._container,delete this._rootGroup,delete this._svgSize},_update:function(){var t,e,i;this._map._animatingZoom&&this._bounds||(Wi.prototype._update.call(this),e=(t=this._bounds).getSize(),i=this._container,this._svgSize&&this._svgSize.equals(e)||(this._svgSize=e,i.setAttribute("width",e.x),i.setAttribute("height",e.y)),Z(i,t.min),i.setAttribute("viewBox",[t.min.x,t.min.y,e.x,e.y].join(" ")),this.fire("update"))},_initPath:function(t){var e=t._path=qi("path");t.options.className&&M(e,t.options.className),t.options.interactive&&M(e,"leaflet-interactive"),this._updateStyle(t),this._layers[h(t)]=t},_addPath:function(t){this._rootGroup||this._initContainer(),this._rootGroup.appendChild(t._path),t.addInteractiveTarget(t._path)},_removePath:function(t){T(t._path),t.removeInteractiveTarget(t._path),delete this._layers[h(t)]},_updatePath:function(t){t._project(),t._update()},_updateStyle:function(t){var e=t._path,t=t.options;e&&(t.stroke?(e.setAttribute("stroke",t.color),e.setAttribute("stroke-opacity",t.opacity),e.setAttribute("stroke-width",t.weight),e.setAttribute("stroke-linecap",t.lineCap),e.setAttribute("stroke-linejoin",t.lineJoin),t.dashArray?e.setAttribute("stroke-dasharray",t.dashArray):e.removeAttribute("stroke-dasharray"),t.dashOffset?e.setAttribute("stroke-dashoffset",t.dashOffset):e.removeAttribute("stroke-dashoffset")):e.setAttribute("stroke","none"),t.fill?(e.setAttribute("fill",t.fillColor||t.color),e.setAttribute("fill-opacity",t.fillOpacity),e.setAttribute("fill-rule",t.fillRule||"evenodd")):e.setAttribute("fill","none"))},_updatePoly:function(t,e){this._setPath(t,dt(t._parts,e))},_updateCircle:function(t){var e=t._point,i=Math.max(Math.round(t._radius),1),n="a"+i+","+(Math.max(Math.round(t._radiusY),1)||i)+" 0 1,0 ",e=t._empty()?"M0 0":"M"+(e.x-i)+","+e.y+n+2*i+",0 "+n+2*-i+",0 ";this._setPath(t,e)},_setPath:function(t,e){t._path.setAttribute("d",e)},_bringToFront:function(t){fe(t._path)},_bringToBack:function(t){ge(t._path)}});function Ki(t){return b.svg||b.vml?new Gi(t):null}b.vml&&Gi.include(zt),A.include({getRenderer:function(t){t=(t=t.options.renderer||this._getPaneRenderer(t.options.pane)||this.options.renderer||this._renderer)||(this._renderer=this._createRenderer());return this.hasLayer(t)||this.addLayer(t),t},_getPaneRenderer:function(t){var e;return"overlayPane"!==t&&void 0!==t&&(void 0===(e=this._paneRenderers[t])&&(e=this._createRenderer({pane:t}),this._paneRenderers[t]=e),e)},_createRenderer:function(t){return this.options.preferCanvas&&Ui(t)||Ki(t)}});var Yi=xi.extend({initialize:function(t,e){xi.prototype.initialize.call(this,this._boundsToLatLngs(t),e)},setBounds:function(t){return this.setLatLngs(this._boundsToLatLngs(t))},_boundsToLatLngs:function(t){return[(t=g(t)).getSouthWest(),t.getNorthWest(),t.getNorthEast(),t.getSouthEast()]}});Gi.create=qi,Gi.pointsToPath=dt,wi.geometryToLayer=bi,wi.coordsToLatLng=Li,wi.coordsToLatLngs=Ti,wi.latLngToCoords=Mi,wi.latLngsToCoords=zi,wi.getFeature=Ci,wi.asFeature=Zi,A.mergeOptions({boxZoom:!0});var _t=n.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane,this._resetStateTimeout=0,t.on("unload",this._destroy,this)},addHooks:function(){S(this._container,"mousedown",this._onMouseDown,this)},removeHooks:function(){k(this._container,"mousedown",this._onMouseDown,this)},moved:function(){return this._moved},_destroy:function(){T(this._pane),delete this._pane},_resetState:function(){this._resetStateTimeout=0,this._moved=!1},_clearDeferredResetState:function(){0!==this._resetStateTimeout&&(clearTimeout(this._resetStateTimeout),this._resetStateTimeout=0)},_onMouseDown:function(t){if(!t.shiftKey||1!==t.which&&1!==t.button)return!1;this._clearDeferredResetState(),this._resetState(),re(),Le(),this._startPoint=this._map.mouseEventToContainerPoint(t),S(document,{contextmenu:Re,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this)},_onMouseMove:function(t){this._moved||(this._moved=!0,this._box=P("div","leaflet-zoom-box",this._container),M(this._container,"leaflet-crosshair"),this._map.fire("boxzoomstart")),this._point=this._map.mouseEventToContainerPoint(t);var t=new f(this._point,this._startPoint),e=t.getSize();Z(this._box,t.min),this._box.style.width=e.x+"px",this._box.style.height=e.y+"px"},_finish:function(){this._moved&&(T(this._box),z(this._container,"leaflet-crosshair")),ae(),Te(),k(document,{contextmenu:Re,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this)},_onMouseUp:function(t){1!==t.which&&1!==t.button||(this._finish(),this._moved&&(this._clearDeferredResetState(),this._resetStateTimeout=setTimeout(a(this._resetState,this),0),t=new s(this._map.containerPointToLatLng(this._startPoint),this._map.containerPointToLatLng(this._point)),this._map.fitBounds(t).fire("boxzoomend",{boxZoomBounds:t})))},_onKeyDown:function(t){27===t.keyCode&&(this._finish(),this._clearDeferredResetState(),this._resetState())}}),Ct=(A.addInitHook("addHandler","boxZoom",_t),A.mergeOptions({doubleClickZoom:!0}),n.extend({addHooks:function(){this._map.on("dblclick",this._onDoubleClick,this)},removeHooks:function(){this._map.off("dblclick",this._onDoubleClick,this)},_onDoubleClick:function(t){var e=this._map,i=e.getZoom(),n=e.options.zoomDelta,i=t.originalEvent.shiftKey?i-n:i+n;"center"===e.options.doubleClickZoom?e.setZoom(i):e.setZoomAround(t.containerPoint,i)}})),Zt=(A.addInitHook("addHandler","doubleClickZoom",Ct),A.mergeOptions({dragging:!0,inertia:!0,inertiaDeceleration:3400,inertiaMaxSpeed:1/0,easeLinearity:.2,worldCopyJump:!1,maxBoundsViscosity:0}),n.extend({addHooks:function(){var t;this._draggable||(t=this._map,this._draggable=new Xe(t._mapPane,t._container),this._draggable.on({dragstart:this._onDragStart,drag:this._onDrag,dragend:this._onDragEnd},this),this._draggable.on("predrag",this._onPreDragLimit,this),t.options.worldCopyJump&&(this._draggable.on("predrag",this._onPreDragWrap,this),t.on("zoomend",this._onZoomEnd,this),t.whenReady(this._onZoomEnd,this))),M(this._map._container,"leaflet-grab leaflet-touch-drag"),this._draggable.enable(),this._positions=[],this._times=[]},removeHooks:function(){z(this._map._container,"leaflet-grab"),z(this._map._container,"leaflet-touch-drag"),this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},moving:function(){return this._draggable&&this._draggable._moving},_onDragStart:function(){var t,e=this._map;e._stop(),this._map.options.maxBounds&&this._map.options.maxBoundsViscosity?(t=g(this._map.options.maxBounds),this._offsetLimit=_(this._map.latLngToContainerPoint(t.getNorthWest()).multiplyBy(-1),this._map.latLngToContainerPoint(t.getSouthEast()).multiplyBy(-1).add(this._map.getSize())),this._viscosity=Math.min(1,Math.max(0,this._map.options.maxBoundsViscosity))):this._offsetLimit=null,e.fire("movestart").fire("dragstart"),e.options.inertia&&(this._positions=[],this._times=[])},_onDrag:function(t){var e,i;this._map.options.inertia&&(e=this._lastTime=+new Date,i=this._lastPos=this._draggable._absPos||this._draggable._newPos,this._positions.push(i),this._times.push(e),this._prunePositions(e)),this._map.fire("move",t).fire("drag",t)},_prunePositions:function(t){for(;1<this._positions.length&&50<t-this._times[0];)this._positions.shift(),this._times.shift()},_onZoomEnd:function(){var t=this._map.getSize().divideBy(2),e=this._map.latLngToLayerPoint([0,0]);this._initialWorldOffset=e.subtract(t).x,this._worldWidth=this._map.getPixelWorldBounds().getSize().x},_viscousLimit:function(t,e){return t-(t-e)*this._viscosity},_onPreDragLimit:function(){var t,e;this._viscosity&&this._offsetLimit&&(t=this._draggable._newPos.subtract(this._draggable._startPos),e=this._offsetLimit,t.x<e.min.x&&(t.x=this._viscousLimit(t.x,e.min.x)),t.y<e.min.y&&(t.y=this._viscousLimit(t.y,e.min.y)),t.x>e.max.x&&(t.x=this._viscousLimit(t.x,e.max.x)),t.y>e.max.y&&(t.y=this._viscousLimit(t.y,e.max.y)),this._draggable._newPos=this._draggable._startPos.add(t))},_onPreDragWrap:function(){var t=this._worldWidth,e=Math.round(t/2),i=this._initialWorldOffset,n=this._draggable._newPos.x,o=(n-e+i)%t+e-i,n=(n+e+i)%t-e-i,t=Math.abs(o+i)<Math.abs(n+i)?o:n;this._draggable._absPos=this._draggable._newPos.clone(),this._draggable._newPos.x=t},_onDragEnd:function(t){var e,i,n,o,s=this._map,r=s.options,a=!r.inertia||t.noInertia||this._times.length<2;s.fire("dragend",t),!a&&(this._prunePositions(+new Date),t=this._lastPos.subtract(this._positions[0]),a=(this._lastTime-this._times[0])/1e3,e=r.easeLinearity,a=(t=t.multiplyBy(e/a)).distanceTo([0,0]),i=Math.min(r.inertiaMaxSpeed,a),t=t.multiplyBy(i/a),n=i/(r.inertiaDeceleration*e),(o=t.multiplyBy(-n/2).round()).x||o.y)?(o=s._limitOffset(o,s.options.maxBounds),x(function(){s.panBy(o,{duration:n,easeLinearity:e,noMoveStart:!0,animate:!0})})):s.fire("moveend")}})),St=(A.addInitHook("addHandler","dragging",Zt),A.mergeOptions({keyboard:!0,keyboardPanDelta:80}),n.extend({keyCodes:{left:[37],right:[39],down:[40],up:[38],zoomIn:[187,107,61,171],zoomOut:[189,109,54,173]},initialize:function(t){this._map=t,this._setPanDelta(t.options.keyboardPanDelta),this._setZoomDelta(t.options.zoomDelta)},addHooks:function(){var t=this._map._container;t.tabIndex<=0&&(t.tabIndex="0"),S(t,{focus:this._onFocus,blur:this._onBlur,mousedown:this._onMouseDown},this),this._map.on({focus:this._addHooks,blur:this._removeHooks},this)},removeHooks:function(){this._removeHooks(),k(this._map._container,{focus:this._onFocus,blur:this._onBlur,mousedown:this._onMouseDown},this),this._map.off({focus:this._addHooks,blur:this._removeHooks},this)},_onMouseDown:function(){var t,e,i;this._focused||(i=document.body,t=document.documentElement,e=i.scrollTop||t.scrollTop,i=i.scrollLeft||t.scrollLeft,this._map._container.focus(),window.scrollTo(i,e))},_onFocus:function(){this._focused=!0,this._map.fire("focus")},_onBlur:function(){this._focused=!1,this._map.fire("blur")},_setPanDelta:function(t){for(var e=this._panKeys={},i=this.keyCodes,n=0,o=i.left.length;n<o;n++)e[i.left[n]]=[-1*t,0];for(n=0,o=i.right.length;n<o;n++)e[i.right[n]]=[t,0];for(n=0,o=i.down.length;n<o;n++)e[i.down[n]]=[0,t];for(n=0,o=i.up.length;n<o;n++)e[i.up[n]]=[0,-1*t]},_setZoomDelta:function(t){for(var e=this._zoomKeys={},i=this.keyCodes,n=0,o=i.zoomIn.length;n<o;n++)e[i.zoomIn[n]]=t;for(n=0,o=i.zoomOut.length;n<o;n++)e[i.zoomOut[n]]=-t},_addHooks:function(){S(document,"keydown",this._onKeyDown,this)},_removeHooks:function(){k(document,"keydown",this._onKeyDown,this)},_onKeyDown:function(t){if(!(t.altKey||t.ctrlKey||t.metaKey)){var e,i,n=t.keyCode,o=this._map;if(n in this._panKeys)o._panAnim&&o._panAnim._inProgress||(i=this._panKeys[n],t.shiftKey&&(i=m(i).multiplyBy(3)),o.options.maxBounds&&(i=o._limitOffset(m(i),o.options.maxBounds)),o.options.worldCopyJump?(e=o.wrapLatLng(o.unproject(o.project(o.getCenter()).add(i))),o.panTo(e)):o.panBy(i));else if(n in this._zoomKeys)o.setZoom(o.getZoom()+(t.shiftKey?3:1)*this._zoomKeys[n]);else{if(27!==n||!o._popup||!o._popup.options.closeOnEscapeKey)return;o.closePopup()}Re(t)}}})),Et=(A.addInitHook("addHandler","keyboard",St),A.mergeOptions({scrollWheelZoom:!0,wheelDebounceTime:40,wheelPxPerZoomLevel:60}),n.extend({addHooks:function(){S(this._map._container,"wheel",this._onWheelScroll,this),this._delta=0},removeHooks:function(){k(this._map._container,"wheel",this._onWheelScroll,this)},_onWheelScroll:function(t){var e=He(t),i=this._map.options.wheelDebounceTime,e=(this._delta+=e,this._lastMousePos=this._map.mouseEventToContainerPoint(t),this._startTime||(this._startTime=+new Date),Math.max(i-(+new Date-this._startTime),0));clearTimeout(this._timer),this._timer=setTimeout(a(this._performZoom,this),e),Re(t)},_performZoom:function(){var t=this._map,e=t.getZoom(),i=this._map.options.zoomSnap||0,n=(t._stop(),this._delta/(4*this._map.options.wheelPxPerZoomLevel)),n=4*Math.log(2/(1+Math.exp(-Math.abs(n))))/Math.LN2,i=i?Math.ceil(n/i)*i:n,n=t._limitZoom(e+(0<this._delta?i:-i))-e;this._delta=0,this._startTime=null,n&&("center"===t.options.scrollWheelZoom?t.setZoom(e+n):t.setZoomAround(this._lastMousePos,e+n))}})),kt=(A.addInitHook("addHandler","scrollWheelZoom",Et),A.mergeOptions({tapHold:b.touchNative&&b.safari&&b.mobile,tapTolerance:15}),n.extend({addHooks:function(){S(this._map._container,"touchstart",this._onDown,this)},removeHooks:function(){k(this._map._container,"touchstart",this._onDown,this)},_onDown:function(t){var e;clearTimeout(this._holdTimeout),1===t.touches.length&&(e=t.touches[0],this._startPos=this._newPos=new p(e.clientX,e.clientY),this._holdTimeout=setTimeout(a(function(){this._cancel(),this._isTapValid()&&(S(document,"touchend",O),S(document,"touchend touchcancel",this._cancelClickPrevent),this._simulateEvent("contextmenu",e))},this),600),S(document,"touchend touchcancel contextmenu",this._cancel,this),S(document,"touchmove",this._onMove,this))},_cancelClickPrevent:function t(){k(document,"touchend",O),k(document,"touchend touchcancel",t)},_cancel:function(){clearTimeout(this._holdTimeout),k(document,"touchend touchcancel contextmenu",this._cancel,this),k(document,"touchmove",this._onMove,this)},_onMove:function(t){t=t.touches[0];this._newPos=new p(t.clientX,t.clientY)},_isTapValid:function(){return this._newPos.distanceTo(this._startPos)<=this._map.options.tapTolerance},_simulateEvent:function(t,e){t=new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window,screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY});t._simulated=!0,e.target.dispatchEvent(t)}})),Ot=(A.addInitHook("addHandler","tapHold",kt),A.mergeOptions({touchZoom:b.touch,bounceAtZoomLimits:!0}),n.extend({addHooks:function(){M(this._map._container,"leaflet-touch-zoom"),S(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){z(this._map._container,"leaflet-touch-zoom"),k(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(t){var e,i,n=this._map;!t.touches||2!==t.touches.length||n._animatingZoom||this._zooming||(e=n.mouseEventToContainerPoint(t.touches[0]),i=n.mouseEventToContainerPoint(t.touches[1]),this._centerPoint=n.getSize()._divideBy(2),this._startLatLng=n.containerPointToLatLng(this._centerPoint),"center"!==n.options.touchZoom&&(this._pinchStartLatLng=n.containerPointToLatLng(e.add(i)._divideBy(2))),this._startDist=e.distanceTo(i),this._startZoom=n.getZoom(),this._moved=!1,this._zooming=!0,n._stop(),S(document,"touchmove",this._onTouchMove,this),S(document,"touchend touchcancel",this._onTouchEnd,this),O(t))},_onTouchMove:function(t){if(t.touches&&2===t.touches.length&&this._zooming){var e=this._map,i=e.mouseEventToContainerPoint(t.touches[0]),n=e.mouseEventToContainerPoint(t.touches[1]),o=i.distanceTo(n)/this._startDist;if(this._zoom=e.getScaleZoom(o,this._startZoom),!e.options.bounceAtZoomLimits&&(this._zoom<e.getMinZoom()&&o<1||this._zoom>e.getMaxZoom()&&1<o)&&(this._zoom=e._limitZoom(this._zoom)),"center"===e.options.touchZoom){if(this._center=this._startLatLng,1==o)return}else{i=i._add(n)._divideBy(2)._subtract(this._centerPoint);if(1==o&&0===i.x&&0===i.y)return;this._center=e.unproject(e.project(this._pinchStartLatLng,this._zoom).subtract(i),this._zoom)}this._moved||(e._moveStart(!0,!1),this._moved=!0),r(this._animRequest);n=a(e._move,e,this._center,this._zoom,{pinch:!0,round:!1},void 0);this._animRequest=x(n,this,!0),O(t)}},_onTouchEnd:function(){this._moved&&this._zooming?(this._zooming=!1,r(this._animRequest),k(document,"touchmove",this._onTouchMove,this),k(document,"touchend touchcancel",this._onTouchEnd,this),this._map.options.zoomAnimation?this._map._animateZoom(this._center,this._map._limitZoom(this._zoom),!0,this._map.options.zoomSnap):this._map._resetView(this._center,this._map._limitZoom(this._zoom))):this._zooming=!1}})),Xi=(A.addInitHook("addHandler","touchZoom",Ot),A.BoxZoom=_t,A.DoubleClickZoom=Ct,A.Drag=Zt,A.Keyboard=St,A.ScrollWheelZoom=Et,A.TapHold=kt,A.TouchZoom=Ot,t.Bounds=f,t.Browser=b,t.CRS=ot,t.Canvas=Fi,t.Circle=vi,t.CircleMarker=gi,t.Class=et,t.Control=B,t.DivIcon=Ri,t.DivOverlay=Ai,t.DomEvent=mt,t.DomUtil=pt,t.Draggable=Xe,t.Evented=it,t.FeatureGroup=ci,t.GeoJSON=wi,t.GridLayer=Ni,t.Handler=n,t.Icon=di,t.ImageOverlay=Ei,t.LatLng=v,t.LatLngBounds=s,t.Layer=o,t.LayerGroup=ui,t.LineUtil=vt,t.Map=A,t.Marker=mi,t.Mixin=ft,t.Path=fi,t.Point=p,t.PolyUtil=gt,t.Polygon=xi,t.Polyline=yi,t.Popup=Bi,t.PosAnimation=Fe,t.Projection=wt,t.Rectangle=Yi,t.Renderer=Wi,t.SVG=Gi,t.SVGOverlay=Oi,t.TileLayer=Di,t.Tooltip=Ii,t.Transformation=at,t.Util=tt,t.VideoOverlay=ki,t.bind=a,t.bounds=_,t.canvas=Ui,t.circle=function(t,e,i){return new vi(t,e,i)},t.circleMarker=function(t,e){return new gi(t,e)},t.control=Ue,t.divIcon=function(t){return new Ri(t)},t.extend=l,t.featureGroup=function(t,e){return new ci(t,e)},t.geoJSON=Si,t.geoJson=Mt,t.gridLayer=function(t){return new Ni(t)},t.icon=function(t){return new di(t)},t.imageOverlay=function(t,e,i){return new Ei(t,e,i)},t.latLng=w,t.latLngBounds=g,t.layerGroup=function(t,e){return new ui(t,e)},t.map=function(t,e){return new A(t,e)},t.marker=function(t,e){return new mi(t,e)},t.point=m,t.polygon=function(t,e){return new xi(t,e)},t.polyline=function(t,e){return new yi(t,e)},t.popup=function(t,e){return new Bi(t,e)},t.rectangle=function(t,e){return new Yi(t,e)},t.setOptions=c,t.stamp=h,t.svg=Ki,t.svgOverlay=function(t,e,i){return new Oi(t,e,i)},t.tileLayer=ji,t.tooltip=function(t,e){return new Ii(t,e)},t.transformation=ht,t.version="1.9.4",t.videoOverlay=function(t,e,i){return new ki(t,e,i)},window.L);t.noConflict=function(){return window.L=Xi,this},window.L=t});
//# sourceMappingURL=leaflet.js.map
    <!-- Leaflet Draw JS - Embedded -->
/*
 Leaflet.draw 1.0.4, a plugin that adds drawing and editing tools to Leaflet powered maps.
 (c) 2012-2017, Jacob Toye, Jon West, Smartrak, Leaflet

 https://github.com/Leaflet/Leaflet.draw
 http://leafletjs.com
 */
!function(t,e,i){function o(t,e){for(;(t=t.parentElement)&&!t.classList.contains(e););return t}L.drawVersion="1.0.4",L.Draw={},L.drawLocal={draw:{toolbar:{actions:{title:"Cancel drawing",text:"Cancel"},finish:{title:"Finish drawing",text:"Finish"},undo:{title:"Delete last point drawn",text:"Delete last point"},buttons:{polyline:"Draw a polyline",polygon:"Draw a polygon",rectangle:"Draw a rectangle",circle:"Draw a circle",marker:"Draw a marker",circlemarker:"Draw a circlemarker"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."},radius:"Radius"},circlemarker:{tooltip:{start:"Click map to place circle marker."}},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Click to start drawing shape.",cont:"Click to continue drawing shape.",end:"Click first point to close this shape."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Save changes",text:"Save"},cancel:{title:"Cancel editing, discards all changes",text:"Cancel"},clearAll:{title:"Clear all layers",text:"Clear All"}},buttons:{edit:"Edit layers",editDisabled:"No layers to edit",remove:"Delete layers",removeDisabled:"No layers to delete"}},handlers:{edit:{tooltip:{text:"Drag handles or markers to edit features.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove."}}}}},L.Draw.Event={},L.Draw.Event.CREATED="draw:created",L.Draw.Event.EDITED="draw:edited",L.Draw.Event.DELETED="draw:deleted",L.Draw.Event.DRAWSTART="draw:drawstart",L.Draw.Event.DRAWSTOP="draw:drawstop",L.Draw.Event.DRAWVERTEX="draw:drawvertex",L.Draw.Event.EDITSTART="draw:editstart",L.Draw.Event.EDITMOVE="draw:editmove",L.Draw.Event.EDITRESIZE="draw:editresize",L.Draw.Event.EDITVERTEX="draw:editvertex",L.Draw.Event.EDITSTOP="draw:editstop",L.Draw.Event.DELETESTART="draw:deletestart",L.Draw.Event.DELETESTOP="draw:deletestop",L.Draw.Event.TOOLBAROPENED="draw:toolbaropened",L.Draw.Event.TOOLBARCLOSED="draw:toolbarclosed",L.Draw.Event.MARKERCONTEXT="draw:markercontext",L.Draw=L.Draw||{},L.Draw.Feature=L.Handler.extend({initialize:function(t,e){this._map=t,this._container=t._container,this._overlayPane=t._panes.overlayPane,this._popupPane=t._panes.popupPane,e&&e.shapeOptions&&(e.shapeOptions=L.Util.extend({},this.options.shapeOptions,e.shapeOptions)),L.setOptions(this,e);var i=L.version.split(".");1===parseInt(i[0],10)&&parseInt(i[1],10)>=2?L.Draw.Feature.include(L.Evented.prototype):L.Draw.Feature.include(L.Mixin.Events)},enable:function(){this._enabled||(L.Handler.prototype.enable.call(this),this.fire("enabled",{handler:this.type}),this._map.fire(L.Draw.Event.DRAWSTART,{layerType:this.type}))},disable:function(){this._enabled&&(L.Handler.prototype.disable.call(this),this._map.fire(L.Draw.Event.DRAWSTOP,{layerType:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var t=this._map;t&&(L.DomUtil.disableTextSelection(),t.getContainer().focus(),this._tooltip=new L.Draw.Tooltip(this._map),L.DomEvent.on(this._container,"keyup",this._cancelDrawing,this))},removeHooks:function(){this._map&&(L.DomUtil.enableTextSelection(),this._tooltip.dispose(),this._tooltip=null,L.DomEvent.off(this._container,"keyup",this._cancelDrawing,this))},setOptions:function(t){L.setOptions(this,t)},_fireCreatedEvent:function(t){this._map.fire(L.Draw.Event.CREATED,{layer:t,layerType:this.type})},_cancelDrawing:function(t){27===t.keyCode&&(this._map.fire("draw:canceled",{layerType:this.type}),this.disable())}}),L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!1,clickable:!0},metric:!0,feet:!0,nautic:!1,showLength:!0,zIndexOffset:2e3,factor:1,maxPoints:0},initialize:function(t,e){L.Browser.touch&&(this.options.icon=this.options.touchIcon),this.options.drawError.message=L.drawLocal.draw.handlers.polyline.error,e&&e.drawError&&(e.drawError=L.Util.extend({},this.options.drawError,e.drawError)),this.type=L.Draw.Polyline.TYPE,L.Draw.Feature.prototype.initialize.call(this,t,e)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("mouseout",this._onMouseOut,this).on("mousemove",this._onMouseMove,this).on("mousedown",this._onMouseDown,this).on("mouseup",this._onMouseUp,this).addTo(this._map),this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("touchstart",this._onTouch,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("touchstart",this._onTouch,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(!(this._markers.length<=1)){var t=this._markers.pop(),e=this._poly,i=e.getLatLngs(),o=i.splice(-1,1)[0];this._poly.setLatLngs(i),this._markerGroup.removeLayer(t),e.getLatLngs().length<2&&this._map.removeLayer(e),this._vertexChanged(o,!1)}},addVertex:function(t){if(this._markers.length>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(t))return void this._showErrorTooltip();this._errorShown&&this._hideErrorTooltip(),this._markers.push(this._createMarker(t)),this._poly.addLatLng(t),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(t,!0)},completeShape:function(){this._markers.length<=1||!this._shapeIsValid()||(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_finishShape:function(){var t=this._poly._defaultShape?this._poly._defaultShape():this._poly.getLatLngs(),e=this._poly.newLatLngIntersects(t[t.length-1]);if(!this.options.allowIntersection&&e||!this._shapeIsValid())return void this._showErrorTooltip();this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable()},_shapeIsValid:function(){return!0},_onZoomEnd:function(){null!==this._markers&&this._updateGuide()},_onMouseMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent),i=this._map.layerPointToLatLng(e);this._currentLatLng=i,this._updateTooltip(i),this._updateGuide(e),this._mouseMarker.setLatLng(i),L.DomEvent.preventDefault(t.originalEvent)},_vertexChanged:function(t,e){this._map.fire(L.Draw.Event.DRAWVERTEX,{layers:this._markerGroup}),this._updateFinishHandler(),this._updateRunningMeasure(t,e),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(t){if(!this._clickHandled&&!this._touchHandled&&!this._disableMarkers){this._onMouseMove(t),this._clickHandled=!0,this._disableNewMarkers();var e=t.originalEvent,i=e.clientX,o=e.clientY;this._startPoint.call(this,i,o)}},_startPoint:function(t,e){this._mouseDownOrigin=L.point(t,e)},_onMouseUp:function(t){var e=t.originalEvent,i=e.clientX,o=e.clientY;this._endPoint.call(this,i,o,t),this._clickHandled=null},_endPoint:function(e,i,o){if(this._mouseDownOrigin){var a=L.point(e,i).distanceTo(this._mouseDownOrigin),n=this._calculateFinishDistance(o.latlng);this.options.maxPoints>1&&this.options.maxPoints==this._markers.length+1?(this.addVertex(o.latlng),this._finishShape()):n<10&&L.Browser.touch?this._finishShape():Math.abs(a)<9*(t.devicePixelRatio||1)&&this.addVertex(o.latlng),this._enableNewMarkers()}this._mouseDownOrigin=null},_onTouch:function(t){var e,i,o=t.originalEvent;!o.touches||!o.touches[0]||this._clickHandled||this._touchHandled||this._disableMarkers||(e=o.touches[0].clientX,i=o.touches[0].clientY,this._disableNewMarkers(),this._touchHandled=!0,this._startPoint.call(this,e,i),this._endPoint.call(this,e,i,t),this._touchHandled=null),this._clickHandled=null},_onMouseOut:function(){this._tooltip&&this._tooltip._onMouseOut.call(this._tooltip)},_calculateFinishDistance:function(t){var e;if(this._markers.length>0){var i;if(this.type===L.Draw.Polyline.TYPE)i=this._markers[this._markers.length-1];else{if(this.type!==L.Draw.Polygon.TYPE)return 1/0;i=this._markers[0]}var o=this._map.latLngToContainerPoint(i.getLatLng()),a=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}),n=this._map.latLngToContainerPoint(a.getLatLng());e=o.distanceTo(n)}else e=1/0;return e},_updateFinishHandler:function(){var t=this._markers.length;t>1&&this._markers[t-1].on("click",this._finishShape,this),t>2&&this._markers[t-2].off("click",this._finishShape,this)},_createMarker:function(t){var e=new L.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(e),e},_updateGuide:function(t){var e=this._markers?this._markers.length:0;e>0&&(t=t||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[e-1].getLatLng()),t))},_updateTooltip:function(t){var e=this._getTooltipText();t&&this._tooltip.updatePosition(t),this._errorShown||this._tooltip.updateContent(e)},_drawGuide:function(t,e){var i,o,a,n=Math.floor(Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))),s=this.options.guidelineDistance,r=this.options.maxGuideLineLength,l=n>r?n-r:s;for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));l<n;l+=this.options.guidelineDistance)i=l/n,o={x:Math.floor(t.x*(1-i)+i*e.x),y:Math.floor(t.y*(1-i)+i*e.y)},a=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer),a.style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(a,o)},_updateGuideColor:function(t){if(this._guidesContainer)for(var e=0,i=this._guidesContainer.childNodes.length;e<i;e++)this._guidesContainer.childNodes[e].style.backgroundColor=t},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var t,e,i=this.options.showLength;return 0===this._markers.length?t={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(e=i?this._getMeasurementString():"",t=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:e}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:e}),t},_updateRunningMeasure:function(t,e){var i,o,a=this._markers.length;1===this._markers.length?this._measurementRunningTotal=0:(i=a-(e?2:1),o=L.GeometryUtil.isVersion07x()?t.distanceTo(this._markers[i].getLatLng())*(this.options.factor||1):this._map.distance(t,this._markers[i].getLatLng())*(this.options.factor||1),this._measurementRunningTotal+=o*(e?1:-1))},_getMeasurementString:function(){var t,e=this._currentLatLng,i=this._markers[this._markers.length-1].getLatLng();return t=L.GeometryUtil.isVersion07x()?i&&e&&e.distanceTo?this._measurementRunningTotal+e.distanceTo(i)*(this.options.factor||1):this._measurementRunningTotal||0:i&&e?this._measurementRunningTotal+this._map.distance(e,i)*(this.options.factor||1):this._measurementRunningTotal||0,L.GeometryUtil.readableDistance(t,this.options.metric,this.options.feet,this.options.nautic,this.options.precision)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_disableNewMarkers:function(){this._disableMarkers=!0},_enableNewMarkers:function(){setTimeout(function(){this._disableMarkers=!1}.bind(this),50)},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var t=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,t)}}),L.Draw.Polygon=L.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:L.Polygon,options:{showArea:!1,showLength:!1,shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0},metric:!0,feet:!0,nautic:!1,precision:{}},initialize:function(t,e){L.Draw.Polyline.prototype.initialize.call(this,t,e),this.type=L.Draw.Polygon.TYPE},_updateFinishHandler:function(){var t=this._markers.length;1===t&&this._markers[0].on("click",this._finishShape,this),t>2&&(this._markers[t-1].on("dblclick",this._finishShape,this),t>3&&this._markers[t-2].off("dblclick",this._finishShape,this))},_getTooltipText:function(){var t,e;return 0===this._markers.length?t=L.drawLocal.draw.handlers.polygon.tooltip.start:this._markers.length<3?(t=L.drawLocal.draw.handlers.polygon.tooltip.cont,e=this._getMeasurementString()):(t=L.drawLocal.draw.handlers.polygon.tooltip.end,e=this._getMeasurementString()),{text:t,subtext:e}},_getMeasurementString:function(){var t=this._area,e="";return t||this.options.showLength?(this.options.showLength&&(e=L.Draw.Polyline.prototype._getMeasurementString.call(this)),t&&(e+="<br>"+L.GeometryUtil.readableArea(t,this.options.metric,this.options.precision)),e):null},_shapeIsValid:function(){return this._markers.length>=3},_vertexChanged:function(t,e){var i;!this.options.allowIntersection&&this.options.showArea&&(i=this._poly.getLatLngs(),this._area=L.GeometryUtil.geodesicArea(i)),L.Draw.Polyline.prototype._vertexChanged.call(this,t,e)},_cleanUpShape:function(){var t=this._markers.length;t>0&&(this._markers[0].off("click",this._finishShape,this),t>2&&this._markers[t-1].off("dblclick",this._finishShape,this))}}),L.SimpleShape={},L.Draw.SimpleShape=L.Draw.Feature.extend({options:{repeatMode:!1},initialize:function(t,e){this._endLabelText=L.drawLocal.draw.handlers.simpleshape.tooltip.end,L.Draw.Feature.prototype.initialize.call(this,t,e)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._mapDraggable=this._map.dragging.enabled(),this._mapDraggable&&this._map.dragging.disable(),this._container.style.cursor="crosshair",this._tooltip.updateContent({text:this._initialLabelText}),this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this).on("touchstart",this._onMouseDown,this).on("touchmove",this._onMouseMove,this),e.addEventListener("touchstart",L.DomEvent.preventDefault,{passive:!1}))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._mapDraggable&&this._map.dragging.enable(),this._container.style.cursor="",this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this).off("touchstart",this._onMouseDown,this).off("touchmove",this._onMouseMove,this),L.DomEvent.off(e,"mouseup",this._onMouseUp,this),L.DomEvent.off(e,"touchend",this._onMouseUp,this),e.removeEventListener("touchstart",L.DomEvent.preventDefault),this._shape&&(this._map.removeLayer(this._shape),delete this._shape)),this._isDrawing=!1},_getTooltipText:function(){return{text:this._endLabelText}},_onMouseDown:function(t){this._isDrawing=!0,this._startLatLng=t.latlng,L.DomEvent.on(e,"mouseup",this._onMouseUp,this).on(e,"touchend",this._onMouseUp,this).preventDefault(t.originalEvent)},_onMouseMove:function(t){var e=t.latlng;this._tooltip.updatePosition(e),this._isDrawing&&(this._tooltip.updateContent(this._getTooltipText()),this._drawShape(e))},_onMouseUp:function(){this._shape&&this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable()}}),L.Draw.Rectangle=L.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0},showArea:!0,metric:!0},initialize:function(t,e){this.type=L.Draw.Rectangle.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.rectangle.tooltip.start,L.Draw.SimpleShape.prototype.initialize.call(this,t,e)},disable:function(){this._enabled&&(this._isCurrentlyTwoClickDrawing=!1,L.Draw.SimpleShape.prototype.disable.call(this))},_onMouseUp:function(t){if(!this._shape&&!this._isCurrentlyTwoClickDrawing)return void(this._isCurrentlyTwoClickDrawing=!0);this._isCurrentlyTwoClickDrawing&&!o(t.target,"leaflet-pane")||L.Draw.SimpleShape.prototype._onMouseUp.call(this)},_drawShape:function(t){this._shape?this._shape.setBounds(new L.LatLngBounds(this._startLatLng,t)):(this._shape=new L.Rectangle(new L.LatLngBounds(this._startLatLng,t),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var t=new L.Rectangle(this._shape.getBounds(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,t)},_getTooltipText:function(){var t,e,i,o=L.Draw.SimpleShape.prototype._getTooltipText.call(this),a=this._shape,n=this.options.showArea;return a&&(t=this._shape._defaultShape?this._shape._defaultShape():this._shape.getLatLngs(),e=L.GeometryUtil.geodesicArea(t),i=n?L.GeometryUtil.readableArea(e,this.options.metric):""),{text:o.text,subtext:i}}}),L.Draw.Marker=L.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,repeatMode:!1,zIndexOffset:2e3},initialize:function(t,e){this.type=L.Draw.Marker.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.marker.tooltip.start,L.Draw.Feature.prototype.initialize.call(this,t,e)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._tooltip.updateContent({text:this._initialLabelText}),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this),this._map.on("click",this._onTouch,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._map.off("click",this._onClick,this).off("click",this._onTouch,this),this._marker&&(this._marker.off("click",this._onClick,this),this._map.removeLayer(this._marker),delete this._marker),this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._map.off("mousemove",this._onMouseMove,this))},_onMouseMove:function(t){var e=t.latlng;this._tooltip.updatePosition(e),this._mouseMarker.setLatLng(e),this._marker?(e=this._mouseMarker.getLatLng(),this._marker.setLatLng(e)):(this._marker=this._createMarker(e),this._marker.on("click",this._onClick,this),this._map.on("click",this._onClick,this).addLayer(this._marker))},_createMarker:function(t){return new L.Marker(t,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset})},_onClick:function(){this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable()},_onTouch:function(t){this._onMouseMove(t),this._onClick()},_fireCreatedEvent:function(){var t=new L.Marker.Touch(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,t)}}),L.Draw.CircleMarker=L.Draw.Marker.extend({statics:{TYPE:"circlemarker"},options:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0,zIndexOffset:2e3},initialize:function(t,e){this.type=L.Draw.CircleMarker.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.circlemarker.tooltip.start,L.Draw.Feature.prototype.initialize.call(this,t,e)},_fireCreatedEvent:function(){var t=new L.CircleMarker(this._marker.getLatLng(),this.options);L.Draw.Feature.prototype._fireCreatedEvent.call(this,t)},_createMarker:function(t){return new L.CircleMarker(t,this.options)}}),L.Draw.Circle=L.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0},showRadius:!0,metric:!0,feet:!0,nautic:!1},initialize:function(t,e){this.type=L.Draw.Circle.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.circle.tooltip.start,L.Draw.SimpleShape.prototype.initialize.call(this,t,e)},_drawShape:function(t){if(L.GeometryUtil.isVersion07x())var e=this._startLatLng.distanceTo(t);else var e=this._map.distance(this._startLatLng,t);this._shape?this._shape.setRadius(e):(this._shape=new L.Circle(this._startLatLng,e,this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var t=new L.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,t)},_onMouseMove:function(t){var e,i=t.latlng,o=this.options.showRadius,a=this.options.metric;if(this._tooltip.updatePosition(i),this._isDrawing){this._drawShape(i),e=this._shape.getRadius().toFixed(1);var n="";o&&(n=L.drawLocal.draw.handlers.circle.radius+": "+L.GeometryUtil.readableDistance(e,a,this.options.feet,this.options.nautic)),this._tooltip.updateContent({text:this._endLabelText,subtext:n})}}}),L.Edit=L.Edit||{},L.Edit.Marker=L.Handler.extend({initialize:function(t,e){this._marker=t,L.setOptions(this,e)},addHooks:function(){var t=this._marker;t.dragging.enable(),t.on("dragend",this._onDragEnd,t),this._toggleMarkerHighlight()},removeHooks:function(){var t=this._marker;t.dragging.disable(),t.off("dragend",this._onDragEnd,t),this._toggleMarkerHighlight()},_onDragEnd:function(t){var e=t.target;e.edited=!0,this._map.fire(L.Draw.Event.EDITMOVE,{layer:e})},_toggleMarkerHighlight:function(){var t=this._marker._icon;t&&(t.style.display="none",L.DomUtil.hasClass(t,"leaflet-edit-marker-selected")?(L.DomUtil.removeClass(t,"leaflet-edit-marker-selected"),this._offsetMarker(t,-4)):(L.DomUtil.addClass(t,"leaflet-edit-marker-selected"),this._offsetMarker(t,4)),t.style.display="")},_offsetMarker:function(t,e){var i=parseInt(t.style.marginTop,10)-e,o=parseInt(t.style.marginLeft,10)-e;t.style.marginTop=i+"px",t.style.marginLeft=o+"px"}}),L.Marker.addInitHook(function(){L.Edit.Marker&&(this.editing=new L.Edit.Marker(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.Poly=L.Handler.extend({initialize:function(t){this.latlngs=[t._latlngs],t._holes&&(this.latlngs=this.latlngs.concat(t._holes)),this._poly=t,this._poly.on("revert-edited",this._updateLatLngs,this)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._poly._latlngs)?this._poly._latlngs:this._poly._latlngs[0]:this._poly._latlngs},_eachVertexHandler:function(t){for(var e=0;e<this._verticesHandlers.length;e++)t(this._verticesHandlers[e])},addHooks:function(){this._initHandlers(),this._eachVertexHandler(function(t){t.addHooks()})},removeHooks:function(){this._eachVertexHandler(function(t){t.removeHooks()})},updateMarkers:function(){this._eachVertexHandler(function(t){t.updateMarkers()})},_initHandlers:function(){this._verticesHandlers=[];for(var t=0;t<this.latlngs.length;t++)this._verticesHandlers.push(new L.Edit.PolyVerticesEdit(this._poly,this.latlngs[t],this._poly.options.poly))},_updateLatLngs:function(t){this.latlngs=[t.layer._latlngs],t.layer._holes&&(this.latlngs=this.latlngs.concat(t.layer._holes))}}),L.Edit.PolyVerticesEdit=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),drawError:{color:"#b00b00",timeout:1e3}},initialize:function(t,e,i){L.Browser.touch&&(this.options.icon=this.options.touchIcon),this._poly=t,i&&i.drawError&&(i.drawError=L.Util.extend({},this.options.drawError,i.drawError)),this._latlngs=e,L.setOptions(this,i)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._latlngs)?this._latlngs:this._latlngs[0]:this._latlngs},addHooks:function(){var t=this._poly,e=t._path;t instanceof L.Polygon||(t.options.fill=!1,t.options.editing&&(t.options.editing.fill=!1)),e&&t.options.editing&&t.options.editing.className&&(t.options.original.className&&t.options.original.className.split(" ").forEach(function(t){L.DomUtil.removeClass(e,t)}),t.options.editing.className.split(" ").forEach(function(t){L.DomUtil.addClass(e,t)})),t.setStyle(t.options.editing),this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){var t=this._poly,e=t._path;e&&t.options.editing&&t.options.editing.className&&(t.options.editing.className.split(" ").forEach(function(t){L.DomUtil.removeClass(e,t)}),t.options.original.className&&t.options.original.className.split(" ").forEach(function(t){L.DomUtil.addClass(e,t)})),t.setStyle(t.options.original),t._map&&(t._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var t,e,i,o,a=this._defaultShape();for(t=0,i=a.length;t<i;t++)o=this._createMarker(a[t],t),o.on("click",this._onMarkerClick,this),o.on("contextmenu",this._onContextMenu,this),this._markers.push(o);var n,s;for(t=0,e=i-1;t<i;e=t++)(0!==t||L.Polygon&&this._poly instanceof L.Polygon)&&(n=this._markers[e],s=this._markers[t],this._createMiddleMarker(n,s),this._updatePrevNext(n,s))},_createMarker:function(t,e){var i=new L.Marker.Touch(t,{draggable:!0,icon:this.options.icon});return i._origLatLng=t,i._index=e,i.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._fireEdit,this),this._markerGroup.addLayer(i),i},_onMarkerDragStart:function(){this._poly.fire("editstart")},_spliceLatLngs:function(){var t=this._defaultShape(),e=[].splice.apply(t,arguments);return this._poly._convertLatLngs(t,!0),this._poly.redraw(),e},_removeMarker:function(t){var e=t._index;this._markerGroup.removeLayer(t),this._markers.splice(e,1),this._spliceLatLngs(e,1),this._updateIndexes(e,-1),t.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit"),this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly})},_onMarkerDrag:function(t){var e=t.target,i=this._poly,o=L.LatLngUtil.cloneLatLng(e._origLatLng);if(L.extend(e._origLatLng,e._latlng),i.options.poly){var a=i._map._editTooltip;if(!i.options.poly.allowIntersection&&i.intersects()){L.extend(e._origLatLng,o),e.setLatLng(o);var n=i.options.color;i.setStyle({color:this.options.drawError.color}),a&&a.updateContent({text:L.drawLocal.draw.handlers.polyline.error}),setTimeout(function(){i.setStyle({color:n}),a&&a.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext})},1e3)}}e._middleLeft&&e._middleLeft.setLatLng(this._getMiddleLatLng(e._prev,e)),e._middleRight&&e._middleRight.setLatLng(this._getMiddleLatLng(e,e._next)),this._poly._bounds._southWest=L.latLng(1/0,1/0),this._poly._bounds._northEast=L.latLng(-1/0,-1/0);var s=this._poly.getLatLngs();this._poly._convertLatLngs(s,!0),this._poly.redraw(),this._poly.fire("editdrag")},_onMarkerClick:function(t){var e=L.Polygon&&this._poly instanceof L.Polygon?4:3,i=t.target;this._defaultShape().length<e||(this._removeMarker(i),this._updatePrevNext(i._prev,i._next),i._middleLeft&&this._markerGroup.removeLayer(i._middleLeft),i._middleRight&&this._markerGroup.removeLayer(i._middleRight),i._prev&&i._next?this._createMiddleMarker(i._prev,i._next):i._prev?i._next||(i._prev._middleRight=null):i._next._middleLeft=null,this._fireEdit())},_onContextMenu:function(t){var e=t.target;this._poly;this._poly._map.fire(L.Draw.Event.MARKERCONTEXT,{marker:e,layers:this._markerGroup,poly:this._poly}),L.DomEvent.stopPropagation},_onTouchMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent.touches[0]),i=this._map.layerPointToLatLng(e),o=t.target;L.extend(o._origLatLng,i),o._middleLeft&&o._middleLeft.setLatLng(this._getMiddleLatLng(o._prev,o)),o._middleRight&&o._middleRight.setLatLng(this._getMiddleLatLng(o,o._next)),this._poly.redraw(),this.updateMarkers()},_updateIndexes:function(t,e){this._markerGroup.eachLayer(function(i){i._index>t&&(i._index+=e)})},_createMiddleMarker:function(t,e){var i,o,a,n=this._getMiddleLatLng(t,e),s=this._createMarker(n);s.setOpacity(.6),t._middleRight=e._middleLeft=s,o=function(){s.off("touchmove",o,this);var a=e._index;s._index=a,s.off("click",i,this).on("click",this._onMarkerClick,this),n.lat=s.getLatLng().lat,n.lng=s.getLatLng().lng,this._spliceLatLngs(a,0,n),this._markers.splice(a,0,s),s.setOpacity(1),this._updateIndexes(a,1),e._index++,this._updatePrevNext(t,s),this._updatePrevNext(s,e),this._poly.fire("editstart")},a=function(){s.off("dragstart",o,this),s.off("dragend",a,this),s.off("touchmove",o,this),this._createMiddleMarker(t,s),this._createMiddleMarker(s,e)},i=function(){o.call(this),a.call(this),this._fireEdit()},s.on("click",i,this).on("dragstart",o,this).on("dragend",a,this).on("touchmove",o,this),this._markerGroup.addLayer(s)},_updatePrevNext:function(t,e){t&&(t._next=e),e&&(e._prev=t)},_getMiddleLatLng:function(t,e){var i=this._poly._map,o=i.project(t.getLatLng()),a=i.project(e.getLatLng());return i.unproject(o._add(a)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))}),L.Edit=L.Edit||{},L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),
className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"}),touchMoveIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move leaflet-touch-icon"}),touchResizeIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize leaflet-touch-icon"})},initialize:function(t,e){L.Browser.touch&&(this.options.moveIcon=this.options.touchMoveIcon,this.options.resizeIcon=this.options.touchResizeIcon),this._shape=t,L.Util.setOptions(this,e)},addHooks:function(){var t=this._shape;this._shape._map&&(this._map=this._shape._map,t.setStyle(t.options.editing),t._map&&(this._map=t._map,this._markerGroup||this._initMarkers(),this._map.addLayer(this._markerGroup)))},removeHooks:function(){var t=this._shape;if(t.setStyle(t.options.original),t._map){this._unbindMarker(this._moveMarker);for(var e=0,i=this._resizeMarkers.length;e<i;e++)this._unbindMarker(this._resizeMarkers[e]);this._resizeMarkers=null,this._map.removeLayer(this._markerGroup),delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._createMoveMarker(),this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(t,e){var i=new L.Marker.Touch(t,{draggable:!0,icon:e,zIndexOffset:10});return this._bindMarker(i),this._markerGroup.addLayer(i),i},_bindMarker:function(t){t.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this).on("touchstart",this._onTouchStart,this).on("touchmove",this._onTouchMove,this).on("MSPointerMove",this._onTouchMove,this).on("touchend",this._onTouchEnd,this).on("MSPointerUp",this._onTouchEnd,this)},_unbindMarker:function(t){t.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this).off("touchstart",this._onTouchStart,this).off("touchmove",this._onTouchMove,this).off("MSPointerMove",this._onTouchMove,this).off("touchend",this._onTouchEnd,this).off("MSPointerUp",this._onTouchEnd,this)},_onMarkerDragStart:function(t){t.target.setOpacity(0),this._shape.fire("editstart")},_fireEdit:function(){this._shape.edited=!0,this._shape.fire("edit")},_onMarkerDrag:function(t){var e=t.target,i=e.getLatLng();e===this._moveMarker?this._move(i):this._resize(i),this._shape.redraw(),this._shape.fire("editdrag")},_onMarkerDragEnd:function(t){t.target.setOpacity(1),this._fireEdit()},_onTouchStart:function(t){if(L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,t),"function"==typeof this._getCorners){var e=this._getCorners(),i=t.target,o=i._cornerIndex;i.setOpacity(0),this._oppositeCorner=e[(o+2)%4],this._toggleCornerMarkers(0,o)}this._shape.fire("editstart")},_onTouchMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent.touches[0]),i=this._map.layerPointToLatLng(e);return t.target===this._moveMarker?this._move(i):this._resize(i),this._shape.redraw(),!1},_onTouchEnd:function(t){t.target.setOpacity(1),this.updateMarkers(),this._fireEdit()},_move:function(){},_resize:function(){}}),L.Edit=L.Edit||{},L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var t=this._shape.getBounds(),e=t.getCenter();this._moveMarker=this._createMarker(e,this.options.moveIcon)},_createResizeMarker:function(){var t=this._getCorners();this._resizeMarkers=[];for(var e=0,i=t.length;e<i;e++)this._resizeMarkers.push(this._createMarker(t[e],this.options.resizeIcon)),this._resizeMarkers[e]._cornerIndex=e},_onMarkerDragStart:function(t){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,t);var e=this._getCorners(),i=t.target,o=i._cornerIndex;this._oppositeCorner=e[(o+2)%4],this._toggleCornerMarkers(0,o)},_onMarkerDragEnd:function(t){var e,i,o=t.target;o===this._moveMarker&&(e=this._shape.getBounds(),i=e.getCenter(),o.setLatLng(i)),this._toggleCornerMarkers(1),this._repositionCornerMarkers(),L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,t)},_move:function(t){for(var e,i=this._shape._defaultShape?this._shape._defaultShape():this._shape.getLatLngs(),o=this._shape.getBounds(),a=o.getCenter(),n=[],s=0,r=i.length;s<r;s++)e=[i[s].lat-a.lat,i[s].lng-a.lng],n.push([t.lat+e[0],t.lng+e[1]]);this._shape.setLatLngs(n),this._repositionCornerMarkers(),this._map.fire(L.Draw.Event.EDITMOVE,{layer:this._shape})},_resize:function(t){var e;this._shape.setBounds(L.latLngBounds(t,this._oppositeCorner)),e=this._shape.getBounds(),this._moveMarker.setLatLng(e.getCenter()),this._map.fire(L.Draw.Event.EDITRESIZE,{layer:this._shape})},_getCorners:function(){var t=this._shape.getBounds();return[t.getNorthWest(),t.getNorthEast(),t.getSouthEast(),t.getSouthWest()]},_toggleCornerMarkers:function(t){for(var e=0,i=this._resizeMarkers.length;e<i;e++)this._resizeMarkers[e].setOpacity(t)},_repositionCornerMarkers:function(){for(var t=this._getCorners(),e=0,i=this._resizeMarkers.length;e<i;e++)this._resizeMarkers[e].setLatLng(t[e])}}),L.Rectangle.addInitHook(function(){L.Edit.Rectangle&&(this.editing=new L.Edit.Rectangle(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.CircleMarker=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var t=this._shape.getLatLng();this._moveMarker=this._createMarker(t,this.options.moveIcon)},_createResizeMarker:function(){this._resizeMarkers=[]},_move:function(t){if(this._resizeMarkers.length){var e=this._getResizeMarkerPoint(t);this._resizeMarkers[0].setLatLng(e)}this._shape.setLatLng(t),this._map.fire(L.Draw.Event.EDITMOVE,{layer:this._shape})}}),L.CircleMarker.addInitHook(function(){L.Edit.CircleMarker&&(this.editing=new L.Edit.CircleMarker(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()})}),L.Edit=L.Edit||{},L.Edit.Circle=L.Edit.CircleMarker.extend({_createResizeMarker:function(){var t=this._shape.getLatLng(),e=this._getResizeMarkerPoint(t);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(e,this.options.resizeIcon))},_getResizeMarkerPoint:function(t){var e=this._shape._radius*Math.cos(Math.PI/4),i=this._map.project(t);return this._map.unproject([i.x+e,i.y-e])},_resize:function(t){var e=this._moveMarker.getLatLng();L.GeometryUtil.isVersion07x()?radius=e.distanceTo(t):radius=this._map.distance(e,t),this._shape.setRadius(radius),this._map.editTooltip&&this._map._editTooltip.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.subtext+"<br />"+L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.draw.handlers.circle.radius+": "+L.GeometryUtil.readableDistance(radius,!0,this.options.feet,this.options.nautic)}),this._shape.setRadius(radius),this._map.fire(L.Draw.Event.EDITRESIZE,{layer:this._shape})}}),L.Circle.addInitHook(function(){L.Edit.Circle&&(this.editing=new L.Edit.Circle(this),this.options.editable&&this.editing.enable())}),L.Map.mergeOptions({touchExtend:!0}),L.Map.TouchExtend=L.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane},addHooks:function(){L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this),L.DomEvent.on(this._container,"touchend",this._onTouchEnd,this),L.DomEvent.on(this._container,"touchmove",this._onTouchMove,this),this._detectIE()?(L.DomEvent.on(this._container,"MSPointerDown",this._onTouchStart,this),L.DomEvent.on(this._container,"MSPointerUp",this._onTouchEnd,this),L.DomEvent.on(this._container,"MSPointerMove",this._onTouchMove,this),L.DomEvent.on(this._container,"MSPointerCancel",this._onTouchCancel,this)):(L.DomEvent.on(this._container,"touchcancel",this._onTouchCancel,this),L.DomEvent.on(this._container,"touchleave",this._onTouchLeave,this))},removeHooks:function(){L.DomEvent.off(this._container,"touchstart",this._onTouchStart,this),L.DomEvent.off(this._container,"touchend",this._onTouchEnd,this),L.DomEvent.off(this._container,"touchmove",this._onTouchMove,this),this._detectIE()?(L.DomEvent.off(this._container,"MSPointerDown",this._onTouchStart,this),L.DomEvent.off(this._container,"MSPointerUp",this._onTouchEnd,this),L.DomEvent.off(this._container,"MSPointerMove",this._onTouchMove,this),L.DomEvent.off(this._container,"MSPointerCancel",this._onTouchCancel,this)):(L.DomEvent.off(this._container,"touchcancel",this._onTouchCancel,this),L.DomEvent.off(this._container,"touchleave",this._onTouchLeave,this))},_touchEvent:function(t,e){var i={};if(void 0!==t.touches){if(!t.touches.length)return;i=t.touches[0]}else{if("touch"!==t.pointerType)return;if(i=t,!this._filterClick(t))return}var o=this._map.mouseEventToContainerPoint(i),a=this._map.mouseEventToLayerPoint(i),n=this._map.layerPointToLatLng(a);this._map.fire(e,{latlng:n,layerPoint:a,containerPoint:o,pageX:i.pageX,pageY:i.pageY,originalEvent:t})},_filterClick:function(t){var e=t.timeStamp||t.originalEvent.timeStamp,i=L.DomEvent._lastClick&&e-L.DomEvent._lastClick;return i&&i>100&&i<500||t.target._simulatedClick&&!t._simulated?(L.DomEvent.stop(t),!1):(L.DomEvent._lastClick=e,!0)},_onTouchStart:function(t){if(this._map._loaded){this._touchEvent(t,"touchstart")}},_onTouchEnd:function(t){if(this._map._loaded){this._touchEvent(t,"touchend")}},_onTouchCancel:function(t){if(this._map._loaded){var e="touchcancel";this._detectIE()&&(e="pointercancel"),this._touchEvent(t,e)}},_onTouchLeave:function(t){if(this._map._loaded){this._touchEvent(t,"touchleave")}},_onTouchMove:function(t){if(this._map._loaded){this._touchEvent(t,"touchmove")}},_detectIE:function(){var e=t.navigator.userAgent,i=e.indexOf("MSIE ");if(i>0)return parseInt(e.substring(i+5,e.indexOf(".",i)),10);if(e.indexOf("Trident/")>0){var o=e.indexOf("rv:");return parseInt(e.substring(o+3,e.indexOf(".",o)),10)}var a=e.indexOf("Edge/");return a>0&&parseInt(e.substring(a+5,e.indexOf(".",a)),10)}}),L.Map.addInitHook("addHandler","touchExtend",L.Map.TouchExtend),L.Marker.Touch=L.Marker.extend({_initInteraction:function(){return this.addInteractiveTarget?L.Marker.prototype._initInteraction.apply(this):this._initInteractionLegacy()},_initInteractionLegacy:function(){if(this.options.clickable){var t=this._icon,e=["dblclick","mousedown","mouseover","mouseout","contextmenu","touchstart","touchend","touchmove"];this._detectIE?e.concat(["MSPointerDown","MSPointerUp","MSPointerMove","MSPointerCancel"]):e.concat(["touchcancel"]),L.DomUtil.addClass(t,"leaflet-clickable"),L.DomEvent.on(t,"click",this._onMouseClick,this),L.DomEvent.on(t,"keypress",this._onKeyPress,this);for(var i=0;i<e.length;i++)L.DomEvent.on(t,e[i],this._fireMouseEvent,this);L.Handler.MarkerDrag&&(this.dragging=new L.Handler.MarkerDrag(this),this.options.draggable&&this.dragging.enable())}},_detectIE:function(){var e=t.navigator.userAgent,i=e.indexOf("MSIE ");if(i>0)return parseInt(e.substring(i+5,e.indexOf(".",i)),10);if(e.indexOf("Trident/")>0){var o=e.indexOf("rv:");return parseInt(e.substring(o+3,e.indexOf(".",o)),10)}var a=e.indexOf("Edge/");return a>0&&parseInt(e.substring(a+5,e.indexOf(".",a)),10)}}),L.LatLngUtil={cloneLatLngs:function(t){for(var e=[],i=0,o=t.length;i<o;i++)Array.isArray(t[i])?e.push(L.LatLngUtil.cloneLatLngs(t[i])):e.push(this.cloneLatLng(t[i]));return e},cloneLatLng:function(t){return L.latLng(t.lat,t.lng)}},function(){var t={km:2,ha:2,m:0,mi:2,ac:2,yd:0,ft:0,nm:2};L.GeometryUtil=L.extend(L.GeometryUtil||{},{geodesicArea:function(t){var e,i,o=t.length,a=0,n=Math.PI/180;if(o>2){for(var s=0;s<o;s++)e=t[s],i=t[(s+1)%o],a+=(i.lng-e.lng)*n*(2+Math.sin(e.lat*n)+Math.sin(i.lat*n));a=6378137*a*6378137/2}return Math.abs(a)},formattedNumber:function(t,e){var i=parseFloat(t).toFixed(e),o=L.drawLocal.format&&L.drawLocal.format.numeric,a=o&&o.delimiters,n=a&&a.thousands,s=a&&a.decimal;if(n||s){var r=i.split(".");i=n?r[0].replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+n):r[0],s=s||".",r.length>1&&(i=i+s+r[1])}return i},readableArea:function(e,i,o){var a,n,o=L.Util.extend({},t,o);return i?(n=["ha","m"],type=typeof i,"string"===type?n=[i]:"boolean"!==type&&(n=i),a=e>=1e6&&-1!==n.indexOf("km")?L.GeometryUtil.formattedNumber(1e-6*e,o.km)+" km²":e>=1e4&&-1!==n.indexOf("ha")?L.GeometryUtil.formattedNumber(1e-4*e,o.ha)+" ha":L.GeometryUtil.formattedNumber(e,o.m)+" m²"):(e/=.836127,a=e>=3097600?L.GeometryUtil.formattedNumber(e/3097600,o.mi)+" mi²":e>=4840?L.GeometryUtil.formattedNumber(e/4840,o.ac)+" acres":L.GeometryUtil.formattedNumber(e,o.yd)+" yd²"),a},readableDistance:function(e,i,o,a,n){var s,n=L.Util.extend({},t,n);switch(i?"string"==typeof i?i:"metric":o?"feet":a?"nauticalMile":"yards"){case"metric":s=e>1e3?L.GeometryUtil.formattedNumber(e/1e3,n.km)+" km":L.GeometryUtil.formattedNumber(e,n.m)+" m";break;case"feet":e*=3.28083,s=L.GeometryUtil.formattedNumber(e,n.ft)+" ft";break;case"nauticalMile":e*=.53996,s=L.GeometryUtil.formattedNumber(e/1e3,n.nm)+" nm";break;case"yards":default:e*=1.09361,s=e>1760?L.GeometryUtil.formattedNumber(e/1760,n.mi)+" miles":L.GeometryUtil.formattedNumber(e,n.yd)+" yd"}return s},isVersion07x:function(){var t=L.version.split(".");return 0===parseInt(t[0],10)&&7===parseInt(t[1],10)}})}(),L.Util.extend(L.LineUtil,{segmentsIntersect:function(t,e,i,o){return this._checkCounterclockwise(t,i,o)!==this._checkCounterclockwise(e,i,o)&&this._checkCounterclockwise(t,e,i)!==this._checkCounterclockwise(t,e,o)},_checkCounterclockwise:function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)}}),L.Polyline.include({intersects:function(){var t,e,i,o=this._getProjectedPoints(),a=o?o.length:0;if(this._tooFewPointsForIntersection())return!1;for(t=a-1;t>=3;t--)if(e=o[t-1],i=o[t],this._lineSegmentsIntersectsRange(e,i,t-2))return!0;return!1},newLatLngIntersects:function(t,e){return!!this._map&&this.newPointIntersects(this._map.latLngToLayerPoint(t),e)},newPointIntersects:function(t,e){var i=this._getProjectedPoints(),o=i?i.length:0,a=i?i[o-1]:null,n=o-2;return!this._tooFewPointsForIntersection(1)&&this._lineSegmentsIntersectsRange(a,t,n,e?1:0)},_tooFewPointsForIntersection:function(t){var e=this._getProjectedPoints(),i=e?e.length:0;return i+=t||0,!e||i<=3},_lineSegmentsIntersectsRange:function(t,e,i,o){var a,n,s=this._getProjectedPoints();o=o||0;for(var r=i;r>o;r--)if(a=s[r-1],n=s[r],L.LineUtil.segmentsIntersect(t,e,a,n))return!0;return!1},_getProjectedPoints:function(){if(!this._defaultShape)return this._originalPoints;for(var t=[],e=this._defaultShape(),i=0;i<e.length;i++)t.push(this._map.latLngToLayerPoint(e[i]));return t}}),L.Polygon.include({intersects:function(){var t,e,i,o,a=this._getProjectedPoints();return!this._tooFewPointsForIntersection()&&(!!L.Polyline.prototype.intersects.call(this)||(t=a.length,e=a[0],i=a[t-1],o=t-2,this._lineSegmentsIntersectsRange(i,e,o,1)))}}),L.Control.Draw=L.Control.extend({options:{position:"topleft",draw:{},edit:!1},initialize:function(t){if(L.version<"0.7")throw new Error("Leaflet.draw 0.2.3+ requires Leaflet 0.7.0+. Download latest from https://github.com/Leaflet/Leaflet/");L.Control.prototype.initialize.call(this,t);var e;this._toolbars={},L.DrawToolbar&&this.options.draw&&(e=new L.DrawToolbar(this.options.draw),this._toolbars[L.DrawToolbar.TYPE]=e,this._toolbars[L.DrawToolbar.TYPE].on("enable",this._toolbarEnabled,this)),L.EditToolbar&&this.options.edit&&(e=new L.EditToolbar(this.options.edit),this._toolbars[L.EditToolbar.TYPE]=e,this._toolbars[L.EditToolbar.TYPE].on("enable",this._toolbarEnabled,this)),L.toolbar=this},onAdd:function(t){var e,i=L.DomUtil.create("div","leaflet-draw"),o=!1;for(var a in this._toolbars)this._toolbars.hasOwnProperty(a)&&(e=this._toolbars[a].addToolbar(t))&&(o||(L.DomUtil.hasClass(e,"leaflet-draw-toolbar-top")||L.DomUtil.addClass(e.childNodes[0],"leaflet-draw-toolbar-top"),o=!0),i.appendChild(e));return i},onRemove:function(){for(var t in this._toolbars)this._toolbars.hasOwnProperty(t)&&this._toolbars[t].removeToolbar()},setDrawingOptions:function(t){for(var e in this._toolbars)this._toolbars[e]instanceof L.DrawToolbar&&this._toolbars[e].setOptions(t)},_toolbarEnabled:function(t){var e=t.target;for(var i in this._toolbars)this._toolbars[i]!==e&&this._toolbars[i].disable()}}),L.Map.mergeOptions({drawControlTooltips:!0,drawControl:!1}),L.Map.addInitHook(function(){this.options.drawControl&&(this.drawControl=new L.Control.Draw,this.addControl(this.drawControl))}),L.Toolbar=L.Class.extend({initialize:function(t){L.setOptions(this,t),this._modes={},this._actionButtons=[],this._activeMode=null;var e=L.version.split(".");1===parseInt(e[0],10)&&parseInt(e[1],10)>=2?L.Toolbar.include(L.Evented.prototype):L.Toolbar.include(L.Mixin.Events)},enabled:function(){return null!==this._activeMode},disable:function(){this.enabled()&&this._activeMode.handler.disable()},addToolbar:function(t){var e,i=L.DomUtil.create("div","leaflet-draw-section"),o=0,a=this._toolbarClass||"",n=this.getModeHandlers(t);for(this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar"),this._map=t,e=0;e<n.length;e++)n[e].enabled&&this._initModeHandler(n[e].handler,this._toolbarContainer,o++,a,n[e].title);if(o)return this._lastButtonIndex=--o,this._actionsContainer=L.DomUtil.create("ul","leaflet-draw-actions"),i.appendChild(this._toolbarContainer),i.appendChild(this._actionsContainer),i},removeToolbar:function(){for(var t in this._modes)this._modes.hasOwnProperty(t)&&(this._disposeButton(this._modes[t].button,this._modes[t].handler.enable,this._modes[t].handler),this._modes[t].handler.disable(),this._modes[t].handler.off("enabled",this._handlerActivated,this).off("disabled",this._handlerDeactivated,this));this._modes={};for(var e=0,i=this._actionButtons.length;e<i;e++)this._disposeButton(this._actionButtons[e].button,this._actionButtons[e].callback,this);this._actionButtons=[],this._actionsContainer=null},_initModeHandler:function(t,e,i,o,a){var n=t.type;this._modes[n]={},this._modes[n].handler=t,this._modes[n].button=this._createButton({type:n,title:a,className:o+"-"+n,container:e,callback:this._modes[n].handler.enable,context:this._modes[n].handler}),this._modes[n].buttonIndex=i,this._modes[n].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_detectIOS:function(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!t.MSStream},_createButton:function(t){var e=L.DomUtil.create("a",t.className||"",t.container),i=L.DomUtil.create("span","sr-only",t.container);e.href="#",e.appendChild(i),t.title&&(e.title=t.title,i.innerHTML=t.title),t.text&&(e.innerHTML=t.text,i.innerHTML=t.text);var o=this._detectIOS()?"touchstart":"click";return L.DomEvent.on(e,"click",L.DomEvent.stopPropagation).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"touchstart",L.DomEvent.stopPropagation).on(e,"click",L.DomEvent.preventDefault).on(e,o,t.callback,t.context),e},_disposeButton:function(t,e){var i=this._detectIOS()?"touchstart":"click";L.DomEvent.off(t,"click",L.DomEvent.stopPropagation).off(t,"mousedown",L.DomEvent.stopPropagation).off(t,"dblclick",L.DomEvent.stopPropagation).off(t,"touchstart",L.DomEvent.stopPropagation).off(t,"click",L.DomEvent.preventDefault).off(t,i,e)},_handlerActivated:function(t){this.disable(),this._activeMode=this._modes[t.handler],L.DomUtil.addClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._showActionsToolbar(),this.fire("enable")},_handlerDeactivated:function(){this._hideActionsToolbar(),L.DomUtil.removeClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._activeMode=null,this.fire("disable")},_createActions:function(t){var e,i,o,a,n=this._actionsContainer,s=this.getActions(t),r=s.length;for(i=0,o=this._actionButtons.length;i<o;i++)this._disposeButton(this._actionButtons[i].button,this._actionButtons[i].callback);for(this._actionButtons=[];n.firstChild;)n.removeChild(n.firstChild);for(var l=0;l<r;l++)"enabled"in s[l]&&!s[l].enabled||(e=L.DomUtil.create("li","",n),a=this._createButton({title:s[l].title,text:s[l].text,container:e,callback:s[l].callback,context:s[l].context}),this._actionButtons.push({button:a,callback:s[l].callback}))},_showActionsToolbar:function(){var t=this._activeMode.buttonIndex,e=this._lastButtonIndex,i=this._activeMode.button.offsetTop-1;this._createActions(this._activeMode.handler),this._actionsContainer.style.top=i+"px",0===t&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-top")),t===e&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-bottom")),this._actionsContainer.style.display="block",this._map.fire(L.Draw.Event.TOOLBAROPENED)},_hideActionsToolbar:function(){this._actionsContainer.style.display="none",L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-top"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-bottom"),this._map.fire(L.Draw.Event.TOOLBARCLOSED)}}),L.Draw=L.Draw||{},L.Draw.Tooltip=L.Class.extend({initialize:function(t){this._map=t,this._popupPane=t._panes.popupPane,this._visible=!1,this._container=t.options.drawControlTooltips?L.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane):null,this._singleLineLabel=!1,this._map.on("mouseout",this._onMouseOut,this)},dispose:function(){this._map.off("mouseout",this._onMouseOut,this),this._container&&(this._popupPane.removeChild(this._container),this._container=null)},updateContent:function(t){return this._container?(t.subtext=t.subtext||"",0!==t.subtext.length||this._singleLineLabel?t.subtext.length>0&&this._singleLineLabel&&(L.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!1):(L.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!0),this._container.innerHTML=(t.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+t.subtext+"</span><br />":"")+"<span>"+t.text+"</span>",t.text||t.subtext?(this._visible=!0,this._container.style.visibility="inherit"):(this._visible=!1,this._container.style.visibility="hidden"),this):this},updatePosition:function(t){var e=this._map.latLngToLayerPoint(t),i=this._container;return this._container&&(this._visible&&(i.style.visibility="inherit"),L.DomUtil.setPosition(i,e)),this},showAsError:function(){return this._container&&L.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip"),this},removeError:function(){return this._container&&L.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip"),this},_onMouseOut:function(){this._container&&(this._container.style.visibility="hidden")}}),L.DrawToolbar=L.Toolbar.extend({statics:{TYPE:"draw"},options:{polyline:{},polygon:{},rectangle:{},circle:{},marker:{},circlemarker:{}},initialize:function(t){for(var e in this.options)this.options.hasOwnProperty(e)&&t[e]&&(t[e]=L.extend({},this.options[e],t[e]));this._toolbarClass="leaflet-draw-draw",L.Toolbar.prototype.initialize.call(this,t)},getModeHandlers:function(t){return[{enabled:this.options.polyline,handler:new L.Draw.Polyline(t,this.options.polyline),title:L.drawLocal.draw.toolbar.buttons.polyline},{enabled:this.options.polygon,handler:new L.Draw.Polygon(t,this.options.polygon),title:L.drawLocal.draw.toolbar.buttons.polygon},{enabled:this.options.rectangle,handler:new L.Draw.Rectangle(t,this.options.rectangle),title:L.drawLocal.draw.toolbar.buttons.rectangle},{enabled:this.options.circle,handler:new L.Draw.Circle(t,this.options.circle),title:L.drawLocal.draw.toolbar.buttons.circle},{enabled:this.options.marker,handler:new L.Draw.Marker(t,this.options.marker),title:L.drawLocal.draw.toolbar.buttons.marker},{enabled:this.options.circlemarker,handler:new L.Draw.CircleMarker(t,this.options.circlemarker),title:L.drawLocal.draw.toolbar.buttons.circlemarker}]},getActions:function(t){return[{enabled:t.completeShape,title:L.drawLocal.draw.toolbar.finish.title,text:L.drawLocal.draw.toolbar.finish.text,callback:t.completeShape,context:t},{enabled:t.deleteLastVertex,title:L.drawLocal.draw.toolbar.undo.title,text:L.drawLocal.draw.toolbar.undo.text,callback:t.deleteLastVertex,context:t},{title:L.drawLocal.draw.toolbar.actions.title,text:L.drawLocal.draw.toolbar.actions.text,callback:this.disable,context:this}]},setOptions:function(t){L.setOptions(this,t);for(var e in this._modes)this._modes.hasOwnProperty(e)&&t.hasOwnProperty(e)&&this._modes[e].handler.setOptions(t[e])}}),L.EditToolbar=L.Toolbar.extend({statics:{TYPE:"edit"},options:{edit:{selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1}},remove:{},poly:null,featureGroup:null},initialize:function(t){t.edit&&(void 0===t.edit.selectedPathOptions&&(t.edit.selectedPathOptions=this.options.edit.selectedPathOptions),t.edit.selectedPathOptions=L.extend({},this.options.edit.selectedPathOptions,t.edit.selectedPathOptions)),t.remove&&(t.remove=L.extend({},this.options.remove,t.remove)),t.poly&&(t.poly=L.extend({},this.options.poly,t.poly)),this._toolbarClass="leaflet-draw-edit",L.Toolbar.prototype.initialize.call(this,t),this._selectedFeatureCount=0},getModeHandlers:function(t){var e=this.options.featureGroup;return[{enabled:this.options.edit,handler:new L.EditToolbar.Edit(t,{featureGroup:e,selectedPathOptions:this.options.edit.selectedPathOptions,poly:this.options.poly}),title:L.drawLocal.edit.toolbar.buttons.edit},{enabled:this.options.remove,handler:new L.EditToolbar.Delete(t,{featureGroup:e}),title:L.drawLocal.edit.toolbar.buttons.remove}]},getActions:function(t){var e=[{title:L.drawLocal.edit.toolbar.actions.save.title,text:L.drawLocal.edit.toolbar.actions.save.text,callback:this._save,context:this},{title:L.drawLocal.edit.toolbar.actions.cancel.title,text:L.drawLocal.edit.toolbar.actions.cancel.text,callback:this.disable,context:this}];return t.removeAllLayers&&e.push({title:L.drawLocal.edit.toolbar.actions.clearAll.title,text:L.drawLocal.edit.toolbar.actions.clearAll.text,callback:this._clearAllLayers,context:this}),e},addToolbar:function(t){var e=L.Toolbar.prototype.addToolbar.call(this,t);return this._checkDisabled(),this.options.featureGroup.on("layeradd layerremove",this._checkDisabled,this),e},removeToolbar:function(){this.options.featureGroup.off("layeradd layerremove",this._checkDisabled,this),L.Toolbar.prototype.removeToolbar.call(this)},disable:function(){this.enabled()&&(this._activeMode.handler.revertLayers(),L.Toolbar.prototype.disable.call(this))},_save:function(){this._activeMode.handler.save(),this._activeMode&&this._activeMode.handler.disable()},_clearAllLayers:function(){this._activeMode.handler.removeAllLayers(),this._activeMode&&this._activeMode.handler.disable()},_checkDisabled:function(){var t,e=this.options.featureGroup,i=0!==e.getLayers().length;this.options.edit&&(t=this._modes[L.EditToolbar.Edit.TYPE].button,i?L.DomUtil.removeClass(t,"leaflet-disabled"):L.DomUtil.addClass(t,"leaflet-disabled"),t.setAttribute("title",i?L.drawLocal.edit.toolbar.buttons.edit:L.drawLocal.edit.toolbar.buttons.editDisabled)),this.options.remove&&(t=this._modes[L.EditToolbar.Delete.TYPE].button,i?L.DomUtil.removeClass(t,"leaflet-disabled"):L.DomUtil.addClass(t,"leaflet-disabled"),t.setAttribute("title",i?L.drawLocal.edit.toolbar.buttons.remove:L.drawLocal.edit.toolbar.buttons.removeDisabled))}}),L.EditToolbar.Edit=L.Handler.extend({statics:{TYPE:"edit"},initialize:function(t,e){if(L.Handler.prototype.initialize.call(this,t),L.setOptions(this,e),this._featureGroup=e.featureGroup,!(this._featureGroup instanceof L.FeatureGroup))throw new Error("options.featureGroup must be a L.FeatureGroup");this._uneditedLayerProps={},this.type=L.EditToolbar.Edit.TYPE;var i=L.version.split(".");1===parseInt(i[0],10)&&parseInt(i[1],10)>=2?L.EditToolbar.Edit.include(L.Evented.prototype):L.EditToolbar.Edit.include(L.Mixin.Events)},enable:function(){!this._enabled&&this._hasAvailableLayers()&&(this.fire("enabled",{handler:this.type}),this._map.fire(L.Draw.Event.EDITSTART,{handler:this.type}),L.Handler.prototype.enable.call(this),this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this))},disable:function(){this._enabled&&(this._featureGroup.off("layeradd",this._enableLayerEdit,this).off("layerremove",this._disableLayerEdit,this),L.Handler.prototype.disable.call(this),this._map.fire(L.Draw.Event.EDITSTOP,{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var t=this._map;t&&(t.getContainer().focus(),this._featureGroup.eachLayer(this._enableLayerEdit,this),this._tooltip=new L.Draw.Tooltip(this._map),this._tooltip.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext}),t._editTooltip=this._tooltip,this._updateTooltip(),this._map.on("mousemove",this._onMouseMove,this).on("touchmove",this._onMouseMove,this).on("MSPointerMove",this._onMouseMove,this).on(L.Draw.Event.EDITVERTEX,this._updateTooltip,this))},removeHooks:function(){this._map&&(this._featureGroup.eachLayer(this._disableLayerEdit,this),this._uneditedLayerProps={},this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove,this).off("touchmove",this._onMouseMove,this).off("MSPointerMove",this._onMouseMove,this).off(L.Draw.Event.EDITVERTEX,this._updateTooltip,this))},revertLayers:function(){this._featureGroup.eachLayer(function(t){this._revertLayer(t)},this)},save:function(){var t=new L.LayerGroup;this._featureGroup.eachLayer(function(e){e.edited&&(t.addLayer(e),e.edited=!1)}),this._map.fire(L.Draw.Event.EDITED,{layers:t})},_backupLayer:function(t){var e=L.Util.stamp(t);this._uneditedLayerProps[e]||(t instanceof L.Polyline||t instanceof L.Polygon||t instanceof L.Rectangle?this._uneditedLayerProps[e]={latlngs:L.LatLngUtil.cloneLatLngs(t.getLatLngs())}:t instanceof L.Circle?this._uneditedLayerProps[e]={latlng:L.LatLngUtil.cloneLatLng(t.getLatLng()),radius:t.getRadius()}:(t instanceof L.Marker||t instanceof L.CircleMarker)&&(this._uneditedLayerProps[e]={latlng:L.LatLngUtil.cloneLatLng(t.getLatLng())}))},_getTooltipText:function(){return{text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext}},_updateTooltip:function(){this._tooltip.updateContent(this._getTooltipText())},_revertLayer:function(t){var e=L.Util.stamp(t);t.edited=!1,this._uneditedLayerProps.hasOwnProperty(e)&&(t instanceof L.Polyline||t instanceof L.Polygon||t instanceof L.Rectangle?t.setLatLngs(this._uneditedLayerProps[e].latlngs):t instanceof L.Circle?(t.setLatLng(this._uneditedLayerProps[e].latlng),t.setRadius(this._uneditedLayerProps[e].radius)):(t instanceof L.Marker||t instanceof L.CircleMarker)&&t.setLatLng(this._uneditedLayerProps[e].latlng),t.fire("revert-edited",{layer:t}))},_enableLayerEdit:function(t){var e,i,o=t.layer||t.target||t;this._backupLayer(o),this.options.poly&&(i=L.Util.extend({},this.options.poly),o.options.poly=i),this.options.selectedPathOptions&&(e=L.Util.extend({},this.options.selectedPathOptions),e.maintainColor&&(e.color=o.options.color,e.fillColor=o.options.fillColor),o.options.original=L.extend({},o.options),o.options.editing=e),o instanceof L.Marker?(o.editing&&o.editing.enable(),o.dragging.enable(),o.on("dragend",this._onMarkerDragEnd).on("touchmove",this._onTouchMove,this).on("MSPointerMove",this._onTouchMove,this).on("touchend",this._onMarkerDragEnd,this).on("MSPointerUp",this._onMarkerDragEnd,this)):o.editing.enable()},_disableLayerEdit:function(t){var e=t.layer||t.target||t;e.edited=!1,e.editing&&e.editing.disable(),delete e.options.editing,delete e.options.original,
this._selectedPathOptions&&(e instanceof L.Marker?this._toggleMarkerHighlight(e):(e.setStyle(e.options.previousOptions),delete e.options.previousOptions)),e instanceof L.Marker?(e.dragging.disable(),e.off("dragend",this._onMarkerDragEnd,this).off("touchmove",this._onTouchMove,this).off("MSPointerMove",this._onTouchMove,this).off("touchend",this._onMarkerDragEnd,this).off("MSPointerUp",this._onMarkerDragEnd,this)):e.editing.disable()},_onMouseMove:function(t){this._tooltip.updatePosition(t.latlng)},_onMarkerDragEnd:function(t){var e=t.target;e.edited=!0,this._map.fire(L.Draw.Event.EDITMOVE,{layer:e})},_onTouchMove:function(t){var e=t.originalEvent.changedTouches[0],i=this._map.mouseEventToLayerPoint(e),o=this._map.layerPointToLatLng(i);t.target.setLatLng(o)},_hasAvailableLayers:function(){return 0!==this._featureGroup.getLayers().length}}),L.EditToolbar.Delete=L.Handler.extend({statics:{TYPE:"remove"},initialize:function(t,e){if(L.Handler.prototype.initialize.call(this,t),L.Util.setOptions(this,e),this._deletableLayers=this.options.featureGroup,!(this._deletableLayers instanceof L.FeatureGroup))throw new Error("options.featureGroup must be a L.FeatureGroup");this.type=L.EditToolbar.Delete.TYPE;var i=L.version.split(".");1===parseInt(i[0],10)&&parseInt(i[1],10)>=2?L.EditToolbar.Delete.include(L.Evented.prototype):L.EditToolbar.Delete.include(L.Mixin.Events)},enable:function(){!this._enabled&&this._hasAvailableLayers()&&(this.fire("enabled",{handler:this.type}),this._map.fire(L.Draw.Event.DELETESTART,{handler:this.type}),L.Handler.prototype.enable.call(this),this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this))},disable:function(){this._enabled&&(this._deletableLayers.off("layeradd",this._enableLayerDelete,this).off("layerremove",this._disableLayerDelete,this),L.Handler.prototype.disable.call(this),this._map.fire(L.Draw.Event.DELETESTOP,{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var t=this._map;t&&(t.getContainer().focus(),this._deletableLayers.eachLayer(this._enableLayerDelete,this),this._deletedLayers=new L.LayerGroup,this._tooltip=new L.Draw.Tooltip(this._map),this._tooltip.updateContent({text:L.drawLocal.edit.handlers.remove.tooltip.text}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._deletableLayers.eachLayer(this._disableLayerDelete,this),this._deletedLayers=null,this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove,this))},revertLayers:function(){this._deletedLayers.eachLayer(function(t){this._deletableLayers.addLayer(t),t.fire("revert-deleted",{layer:t})},this)},save:function(){this._map.fire(L.Draw.Event.DELETED,{layers:this._deletedLayers})},removeAllLayers:function(){this._deletableLayers.eachLayer(function(t){this._removeLayer({layer:t})},this),this.save()},_enableLayerDelete:function(t){(t.layer||t.target||t).on("click",this._removeLayer,this)},_disableLayerDelete:function(t){var e=t.layer||t.target||t;e.off("click",this._removeLayer,this),this._deletedLayers.removeLayer(e)},_removeLayer:function(t){var e=t.layer||t.target||t;this._deletableLayers.removeLayer(e),this._deletedLayers.addLayer(e),e.fire("deleted")},_onMouseMove:function(t){this._tooltip.updatePosition(t.latlng)},_hasAvailableLayers:function(){return 0!==this._deletableLayers.getLayers().length}})}(window,document);
    <script>
        // =================================
        // 1. CONSTANTS & CONFIGURATION
        // =================================
        const CONFIG = {
            MAP_CENTER: [41.0082, 28.9784],
            DEFAULT_ZOOM: 10,
            MAX_ZOOM: 19,
            DEBOUNCE_DELAY: 150,
            THROTTLE_DELAY: 100,
            TOAST_DURATION: 3000,
            AUTOSAVE_INTERVAL: 30000
        };

        const SYSTEM_DEFAULTS = {
            point: { color: "#ff0000", size: 8, shape: "circle", opacity: 100 },
            line: { color: "#ff7800", width: 3, opacity: 100, type: "solid" },
            polygon: { fillColor: "#3388ff", fillOpacity: 50, strokeColor: "#000000", strokeWidth: 1 }
        };

        // =================================
        // 3. ICON LIBRARY SYSTEM
        // =================================
        const ICON_LIBRARY = {
            // Geometri tipleri
            point: { unicode: "📍", name: "Nokta", color: "#e74c3c" },
            line: { unicode: "📏", name: "Çizgi", color: "#f39c12" },
            polygon: { unicode: "⬟", name: "Poligon", color: "#3498db" },
            rectangle: { unicode: "⬜", name: "Dikdörtgen", color: "#9b59b6" },
            circle: { unicode: "⭕", name: "Daire", color: "#e67e22" },
            
            // Araçlar - Ölçüm
            measureDistance: { unicode: "📏", name: "Mesafe Ölç", color: "#2ecc71" },
            measureArea: { unicode: "⬟", name: "Alan Ölç", color: "#3498db" },
            clearMeasurements: { unicode: "🗑️", name: "Ölçümleri Temizle", color: "#e74c3c" },
            
            // Araçlar - Düzenleme
            edit: { unicode: "✏️", name: "Düzenle", color: "#9b59b6" },
            delete: { unicode: "🗑️", name: "Sil", color: "#e74c3c" },
            settings: { unicode: "⚙️", name: "Ayarlar", color: "#34495e" },
            
            // Araçlar - Görünüm
            zoom: { unicode: "🔍", name: "Zoom", color: "#2ecc71" },
            zoomExtent: { unicode: "🔍", name: "Tümüne Zoom", color: "#2ecc71" },
            fullscreen: { unicode: "⛶", name: "Tam Ekran", color: "#34495e" },
            legend: { unicode: "📋", name: "Lejant", color: "#7f8c8d" },
            
            // Durum göstergeleri
            visible: { unicode: "👁️", name: "Görünür", color: "#2ecc71" },
            hidden: { unicode: "👁️‍🗨️", name: "Gizli", color: "#95a5a6" },
            locked: { unicode: "🔒", name: "Kilitli", color: "#e67e22" },
            unlocked: { unicode: "🔓", name: "Açık", color: "#2ecc71" },
            
            // Panel ve yönetim
            layers: { unicode: "🗂️", name: "Katmanlar", color: "#7f8c8d" },
            group: { unicode: "📁", name: "Grup", color: "#f39c12" },
            layer: { unicode: "📋", name: "Katman", color: "#3498db" },
            save: { unicode: "💾", name: "Kaydet", color: "#2ecc71" },
            download: { unicode: "📥", name: "İndir", color: "#3498db" },
            upload: { unicode: "📤", name: "Yükle", color: "#e67e22" },
            close: { unicode: "✕", name: "Kapat", color: "#e74c3c" },
            
            // Kategoriler
            mixed: { unicode: "🗂️", name: "Karma", color: "#7f8c8d" }
        };

        // Icon helper functions
        const IconUtils = {
            getIcon(type) {
                return ICON_LIBRARY[type] || ICON_LIBRARY.mixed;
            },

            createIconElement(type, size = '14px', extraClass = '') {
                const iconData = this.getIcon(type);
                const span = document.createElement('span');
                span.textContent = iconData.unicode;
                span.style.fontSize = size;
                span.style.color = iconData.color;
                span.title = iconData.name;
                if (extraClass) span.className = extraClass;
                return span;
            },

            createIconHtml(type, size = '14px') {
                const iconData = this.getIcon(type);
                return `<span style="font-size: ${size}; color: ${iconData.color};" title="${iconData.name}">${iconData.unicode}</span>`;
            }
        };

        // =================================
        // 2. UTILITY FUNCTIONS
        // =================================
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            },

            safeExecute(fn, errorContext = 'Operation') {
                try {
                    return fn();
                } catch (error) {
                    ErrorManager.handle(error, errorContext);
                    return null;
                }
            },

            generateId(prefix = 'item') {
                return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            },

            validateInput: {
                layerName(name) {
                    if (!name || typeof name !== 'string') {
                        throw new Error('Katman adı geçersiz');
                    }
                    const trimmed = name.trim();
                    if (trimmed.length < 1 || trimmed.length > 50) {
                        throw new Error('Katman adı 1-50 karakter arasında olmalı');
                    }
                    return trimmed;
                },
                
                color(color) {
                    const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                    if (!colorRegex.test(color)) {
                        throw new Error('Geçersiz renk formatı');
                    }
                    return color;
                }
            },

            formatCoordinate(value, decimals = 6) {
                return parseFloat(value).toFixed(decimals);
            }
        };

        // =================================
        // 3. ERROR MANAGEMENT
        // =================================
        const ErrorManager = {
            handle(error, context = '') {
                console.error(`[${context}]`, error);
                const userMessage = this.getUserFriendlyMessage(error);
                showToast(userMessage, 'error');
            },

            getUserFriendlyMessage(error) {
                const errorMap = {
                    'Katman adı geçersiz': 'Katman adı geçersiz',
                    'Katman bulunamadı': 'Seçili katman bulunamadı',
                    'Stil yüklenirken hata': 'Stil ayarları yüklenirken hata oluştu',
                    'Çizim hatası': 'Çizim işlemi başarısız'
                };
                
                const message = error.message || error.toString();
                return errorMap[message] || 'Beklenmeyen bir hata oluştu. Lütfen tekrar deneyin.';
            }
        };

        // =================================
        // 4. STATE MANAGEMENT
        // =================================
        const AppState = {
            data: {
                activeLayerId: null,
                activeGroupId: null,
                isDrawingMode: false,
                layerFeatures: {},
                drawnLayers: [],
                measurementMode: null
            },

            get(key) {
                return this.data[key];
            },

            set(key, value) {
                const oldValue = this.data[key];
                this.data[key] = value;
                this.notifyChange(key, value, oldValue);
            },

            update(updates) {
                Object.keys(updates).forEach(key => {
                    this.set(key, updates[key]);
                });
            },

            notifyChange(key, newValue, oldValue) {
                document.dispatchEvent(new CustomEvent('state:changed', {
                    detail: { key, newValue, oldValue }
                }));
            }
        };

        // =================================
        // 5. MEASUREMENT UTILITIES (Enhanced)
        // =================================
        
        // Ölçüm Ayarları Objesi
        const MeasurementSettings = {
            distance: {
                labelPosition: 'center', // center, above, below, segments
                showTotal: true,
                showPartial: false,
                unit: 'auto' // auto, m, km, ft, mi
            },
            area: {
                labelPosition: 'center', // center, centroid, bounds
                unit: 'auto' // auto, m2, ha, km2, ac
            },
            labels: {
                size: 12,
                color: '#ffffff',
                backgroundColor: '#000000',
                showBackground: true,
                frequency: 3, // segment etiket sıklığı
                minSegmentLength: 100 // minimum segment uzunluğu (metre)
            },
            general: {
                liveUpdate: true // çizim sırasında etiketleri güncelle
            }
        };

        class MeasurementTools {
            constructor(map) {
                this.map = map;
                this.measurementLayers = L.layerGroup().addTo(map);
                this.currentTool = null;
                this.isActive = false;
                this.pointMarkers = []; // Ölçüm noktalarını saklamak için
                this.segmentLabels = []; // Segment etiketlerini saklamak için
            }
            
            startDistance() {
                console.log('startDistance method çağrıldı');
                this.stopMeasurement(); // Önceki ölçümü durdur
                this.currentTool = 'distance';
                this.isActive = true;
                this.map.getContainer().style.cursor = 'crosshair';
                
                console.log('Harita event listener\'ları ekleniyor...');
                // Event listener'ları en yüksek öncelikle ekle
                this.map.off('click', this.onMapClick, this); // Önce kaldır
                this.map.off('dblclick', this.onMapDoubleClick, this); // Önce kaldır
                this.map.on('click', this.onMapClick, this);
                this.map.on('dblclick', this.onMapDoubleClick, this);
                
                // Diğer event listener'ları devre dışı bırak
                this.disableMapInteraction();
                
                this.currentPoints = [];
                this.currentLine = null;
                this.pointMarkers = [];
                
                console.log('Mesafe ölçümü aktif, haritaya tıklayabilirsiniz');
                // Kullanıcıya bilgi ver
                showNotification('Mesafe ölçümü başladı - Çift tıklayın veya ESC ile çıkın', 'info');
            }
            
            startArea() {
                console.log('startArea method çağrıldı');
                this.stopMeasurement(); // Önceki ölçümü durdur
                this.currentTool = 'area';
                this.isActive = true;
                this.map.getContainer().style.cursor = 'crosshair';
                
                console.log('Harita event listener\'ları ekleniyor...');
                // Event listener'ları en yüksek öncelikle ekle
                this.map.off('click', this.onMapClick, this); // Önce kaldır
                this.map.off('dblclick', this.onMapDoubleClick, this); // Önce kaldır
                this.map.on('click', this.onMapClick, this);
                this.map.on('dblclick', this.onMapDoubleClick, this);
                
                // Diğer event listener'ları devre dışı bırak
                this.disableMapInteraction();
                
                this.currentPoints = [];
                this.currentPolygon = null;
                this.pointMarkers = [];
                
                console.log('Alan ölçümü aktif, haritaya tıklayabilirsiniz');
                // Kullanıcıya bilgi ver
                showNotification('Alan ölçümü başladı - Çift tıklayın veya ESC ile çıkın', 'info');
            }
            
            onMapClick(e) {
                console.log('MeasurementTools onMapClick çağrıldı:', e.latlng);
                console.log('isActive:', this.isActive);
                console.log('currentTool:', this.currentTool);
                
                // Event'i durdur ki diğer listener'lar çalışmasın
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                    e.originalEvent.preventDefault();
                }
                
                if (!this.isActive) {
                    console.log('Ölçüm aktif değil, çıkılıyor...');
                    return;
                }
                
                this.currentPoints.push(e.latlng);
                console.log('Toplam nokta sayısı:', this.currentPoints.length);
                
                // Tıklanan noktayı işaretle
                this.addPointMarker(e.latlng);
                
                if (this.currentTool === 'distance') {
                    console.log('Mesafe ölçümü güncelleniyor...');
                    this.updateDistanceMeasurement();
                } else if (this.currentTool === 'area') {
                    console.log('Alan ölçümü güncelleniyor...');
                    this.updateAreaMeasurement();
                }
            }
            
            addPointMarker(latlng) {
                const pointMarker = L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: '#ff4444',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1,
                    className: 'measurement-point'
                });
                
                this.pointMarkers.push(pointMarker);
                this.measurementLayers.addLayer(pointMarker);
            }
            
            onMapDoubleClick(e) {
                if (!this.isActive) return;
                
                // Çift tıklama ile ölçümü sonlandır
                this.stopMeasurement();
            }
            
            updateDistanceMeasurement() {
                if (this.currentPoints.length >= 2) {
                    // Önceki çizgiyi ve etiketleri temizle
                    if (this.currentLine) {
                        this.measurementLayers.removeLayer(this.currentLine);
                    }
                    this.clearSegmentLabels();
                    
                    this.currentLine = L.polyline(this.currentPoints, {
                        color: '#ff4444',
                        weight: 3,
                        dashArray: '5, 5',
                        opacity: 0.8
                    });
                    
                    // Toplam mesafeyi hesapla
                    const totalDistance = this.calculateDistance(this.currentPoints);
                    const formattedDistance = this.formatDistance(totalDistance);
                    
                    // Ayarlara göre etiketleri ekle
                    this.addDistanceLabels(this.currentLine, totalDistance, formattedDistance);
                    
                    this.measurementLayers.addLayer(this.currentLine);
                } else if (this.currentPoints.length === 1) {
                    console.log('İlk nokta eklendi, ikinci nokta bekleniyor...');
                }
            }
            
            updateAreaMeasurement() {
                if (this.currentPoints.length >= 3) {
                    // Önceki poligonu temizle
                    if (this.currentPolygon) {
                        this.measurementLayers.removeLayer(this.currentPolygon);
                    }
                    
                    this.currentPolygon = L.polygon(this.currentPoints, {
                        color: '#4444ff',
                        weight: 2,
                        fillColor: '#4444ff',
                        fillOpacity: 0.2,
                        opacity: 0.8
                    });
                    
                    // Alanı hesapla
                    const area = this.calculateArea(this.currentPoints);
                    const formattedArea = this.formatArea(area);
                    
                    // Ayarlara göre etiket ekle
                    this.addAreaLabel(this.currentPolygon, area, formattedArea);
                    
                    this.measurementLayers.addLayer(this.currentPolygon);
                } else if (this.currentPoints.length >= 1) {
                    console.log(`Alan ölçümü için ${this.currentPoints.length} nokta eklendi, en az 3 nokta gerekli`);
                }
            }
            
            calculateDistance(latlngs) {
                let totalDistance = 0;
                for (let i = 0; i < latlngs.length - 1; i++) {
                    totalDistance += latlngs[i].distanceTo(latlngs[i + 1]);
                }
                return totalDistance;
            }
            
            calculateArea(latlngs) {
                // Basit alan hesaplama (yaklaşık)
                if (latlngs.length < 3) return 0;
                
                let area = 0;
                const n = latlngs.length;
                
                for (let i = 0; i < n; i++) {
                    const j = (i + 1) % n;
                    area += latlngs[i].lat * latlngs[j].lng;
                    area -= latlngs[j].lat * latlngs[i].lng;
                }
                
                area = Math.abs(area) / 2;
                // Derece cinsinden alanı metrekareye çevir (yaklaşık)
                return area * 111320 * 111320 * Math.cos(latlngs[0].lat * Math.PI / 180);
            }
            
            disableMapInteraction() {
                // Harita drag ve zoom'u geçici olarak devre dışı bırak
                this.map.dragging.disable();
                this.map.doubleClickZoom.disable();
                this.map.scrollWheelZoom.disable();
                this.map.touchZoom.disable();
                this.map.keyboard.disable();
                console.log('Harita interaksiyonları devre dışı bırakıldı');
            }
            
            enableMapInteraction() {
                // Harita drag ve zoom'u tekrar etkinleştir
                this.map.dragging.enable();
                this.map.doubleClickZoom.enable();
                this.map.scrollWheelZoom.enable();
                this.map.touchZoom.enable();
                this.map.keyboard.enable();
                console.log('Harita interaksiyonları etkinleştirildi');
            }

            stopMeasurement() {
                console.log('Ölçüm aracı durduruluyor...');
                this.isActive = false;
                this.currentTool = null;
                
                // Remove all event listeners
                this.map.off('click', this.onMapClick, this);
                this.map.off('dblclick', this.onMapDoubleClick, this);
                this.map.off('mousemove', this.onMapMouseMove, this);
                this.map.getContainer().style.cursor = '';
                
                // Harita interaksiyonlarını yeniden etkinleştir
                this.enableMapInteraction();
                
                // Clear measurement data
                this.currentPoints = [];
                this.currentLine = null;
                this.currentPolygon = null;
                this.pointMarkers = [];
                this.clearSegmentLabels();
                
                // Buton durumlarını sıfırla
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                console.log('Ölçüm aracı başarıyla durduruldu');
            }
            
            // Segment etiketlerini temizle
            clearSegmentLabels() {
                this.segmentLabels.forEach(label => {
                    if (this.measurementLayers.hasLayer(label)) {
                        this.measurementLayers.removeLayer(label);
                    }
                });
                this.segmentLabels = [];
            }
            
            // Mesafe etiketlerini ekle
            addDistanceLabels(polyline, totalDistance, formattedDistance) {
                const settings = MeasurementSettings;
                
                if (settings.distance.showTotal) {
                    // Toplam mesafe etiketi
                    const labelPosition = this.getDistanceLabelPosition(polyline);
                    const tooltip = this.createCustomTooltip(
                        `Toplam: ${formattedDistance}`,
                        labelPosition,
                        'distance-total'
                    );
                    this.segmentLabels.push(tooltip);
                    this.measurementLayers.addLayer(tooltip);
                }
                
                // Segment etiketleri (eğer ayar açıksa)
                if (settings.distance.labelPosition === 'segments' || settings.distance.showPartial) {
                    this.addSegmentLabels();
                }
            }
            
            // Alan etiketi ekle
            addAreaLabel(polygon, area, formattedArea) {
                const labelPosition = this.getAreaLabelPosition(polygon);
                const tooltip = this.createCustomTooltip(
                    `Alan: ${formattedArea}`,
                    labelPosition,
                    'area-label'
                );
                this.segmentLabels.push(tooltip);
                this.measurementLayers.addLayer(tooltip);
            }
            
            // Mesafe label pozisyonunu belirle
            getDistanceLabelPosition(polyline) {
                const points = polyline.getLatLngs();
                const settings = MeasurementSettings.distance;
                
                switch (settings.labelPosition) {
                    case 'center':
                        return this.getLineCenter(points);
                    case 'above':
                        return this.getLineCenterWithOffset(points, 'above');
                    case 'below':
                        return this.getLineCenterWithOffset(points, 'below');
                    default:
                        return this.getLineCenter(points);
                }
            }
            
            // Alan label pozisyonunu belirle
            getAreaLabelPosition(polygon) {
                const settings = MeasurementSettings.area;
                const bounds = polygon.getBounds();
                
                switch (settings.labelPosition) {
                    case 'center':
                    case 'centroid':
                        return bounds.getCenter();
                    case 'bounds':
                        return bounds.getCenter();
                    default:
                        return bounds.getCenter();
                }
            }
            
            // Segment etiketlerini ekle
            addSegmentLabels() {
                const settings = MeasurementSettings;
                if (this.currentPoints.length < 2) return;
                
                for (let i = 0; i < this.currentPoints.length - 1; i++) {
                    const start = this.currentPoints[i];
                    const end = this.currentPoints[i + 1];
                    const segmentDistance = start.distanceTo(end);
                    
                    // Minimum segment uzunluğu kontrolü
                    if (segmentDistance < settings.labels.minSegmentLength) continue;
                    
                    // Sıklık kontrolü
                    if ((i + 1) % settings.labels.frequency !== 0) continue;
                    
                    const segmentCenter = L.latLng(
                        (start.lat + end.lat) / 2,
                        (start.lng + end.lng) / 2
                    );
                    
                    const formattedSegmentDistance = this.formatDistance(segmentDistance);
                    const tooltip = this.createCustomTooltip(
                        formattedSegmentDistance,
                        segmentCenter,
                        'distance-segment'
                    );
                    
                    this.segmentLabels.push(tooltip);
                    this.measurementLayers.addLayer(tooltip);
                }
            }
            
            // Özel tooltip oluştur
            createCustomTooltip(text, position, className) {
                const settings = MeasurementSettings.labels;
                const style = `
                    background: ${settings.showBackground ? settings.backgroundColor : 'transparent'} !important;
                    color: ${settings.color} !important;
                    border: none !important;
                    border-radius: 4px !important;
                    padding: 4px 8px !important;
                    font-weight: bold !important;
                    font-size: ${settings.size}px !important;
                    box-shadow: ${settings.showBackground ? '0 2px 4px rgba(0,0,0,0.3)' : 'none'} !important;
                    white-space: nowrap !important;
                    pointer-events: none !important;
                `;
                
                return L.marker(position, {
                    icon: L.divIcon({
                        html: `<div style="${style}">${text}</div>`,
                        className: `measurement-tooltip ${className}`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                });
            }
            
            // Çizgi merkezi hesapla
            getLineCenter(points) {
                if (points.length === 0) return null;
                if (points.length === 1) return points[0];
                
                let totalDistance = 0;
                const distances = [];
                
                for (let i = 0; i < points.length - 1; i++) {
                    const dist = points[i].distanceTo(points[i + 1]);
                    distances.push(dist);
                    totalDistance += dist;
                }
                
                const halfDistance = totalDistance / 2;
                let currentDistance = 0;
                
                for (let i = 0; i < distances.length; i++) {
                    if (currentDistance + distances[i] >= halfDistance) {
                        const ratio = (halfDistance - currentDistance) / distances[i];
                        return L.latLng(
                            points[i].lat + (points[i + 1].lat - points[i].lat) * ratio,
                            points[i].lng + (points[i + 1].lng - points[i].lng) * ratio
                        );
                    }
                    currentDistance += distances[i];
                }
                
                return points[Math.floor(points.length / 2)];
            }
            
            // Offset ile çizgi merkezi
            getLineCenterWithOffset(points, direction) {
                const center = this.getLineCenter(points);
                if (!center) return center;
                
                const offsetLat = direction === 'above' ? 0.0001 : -0.0001;
                return L.latLng(center.lat + offsetLat, center.lng);
            }
            
            // Mesafe formatla
            formatDistance(distance) {
                const unit = MeasurementSettings.distance.unit;
                
                switch (unit) {
                    case 'm':
                        return `${distance.toFixed(0)} m`;
                    case 'km':
                        return `${(distance / 1000).toFixed(2)} km`;
                    case 'ft':
                        return `${(distance * 3.28084).toFixed(0)} ft`;
                    case 'mi':
                        return `${(distance / 1609.34).toFixed(2)} mi`;
                    case 'auto':
                    default:
                        return distance > 1000 ? 
                            `${(distance / 1000).toFixed(2)} km` : 
                            `${distance.toFixed(0)} m`;
                }
            }
            
            // Alan formatla
            formatArea(area) {
                const unit = MeasurementSettings.area.unit;
                
                switch (unit) {
                    case 'm2':
                        return `${area.toFixed(0)} m²`;
                    case 'ha':
                        return `${(area / 10000).toFixed(2)} ha`;
                    case 'km2':
                        return `${(area / 1000000).toFixed(4)} km²`;
                    case 'ac':
                        return `${(area / 4047).toFixed(2)} ac`;
                    case 'auto':
                    default:
                        return area > 10000 ? 
                            `${(area / 10000).toFixed(2)} ha` : 
                            `${area.toFixed(0)} m²`;
                }
            }

            clearAll() {
                this.measurementLayers.clearLayers();
                this.stopMeasurement();
            }
        }
        
        // ===== MESAJ KONSOLU SİSTEMİ =====
        const MessageConsole = {
            messages: [],
            maxMessages: 100,
            isVisible: false,
            isDocked: false,
            dragData: { isDragging: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 },
            
            init() {
                // Konsol varsayılan açık gelsin
                const console = document.getElementById('messageConsole');
                const toggleBtn = document.getElementById('consoleToggleBtn');
                
                this.isVisible = true;
                if (console) {
                    console.classList.add('show');
                }
                
                // Drag & drop sistemi kurulumu
                this.setupDragAndDrop();
                
                // İlk mesajları ekle
                this.addMessage('Mesaj konsolu hazır! 🎉', 'info');
                this.addMessage('Sistem mesajları burada görüntülenir', 'info');
                this.addMessage('Konsol taşınabilir - sürükleyerek konumlandırabilirsiniz', 'info');
            },
            
            addMessage(message, type = 'info') {
                const timestamp = new Date();
                const messageObj = {
                    id: Date.now() + Math.random(),
                    message,
                    type,
                    timestamp,
                    time: timestamp.toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    })
                };
                
                this.messages.unshift(messageObj);
                
                // Maksimum mesaj sayısını aş
                if (this.messages.length > this.maxMessages) {
                    this.messages = this.messages.slice(0, this.maxMessages);
                }
                
                this.updateConsole();
                this.updateToggleButton();
                
                // Console.log için de çıktı ver
                console.log(`[${type.toUpperCase()}] ${message}`);
            },
            
            updateConsole() {
                const messagesContainer = document.getElementById('consoleMessages');
                const messageCounter = document.getElementById('messageCounter');
                
                if (!messagesContainer) return;
                
                // Mesaj sayısını güncelle
                if (messageCounter) {
                    messageCounter.textContent = this.messages.length;
                }
                
                // Mesajları render et
                messagesContainer.innerHTML = this.messages
                    .map(msg => this.renderMessage(msg))
                    .join('');
                
                // Filtre uygula
                this.applyFilters();
                
                // En son mesaja scroll
                if (messagesContainer.scrollTop === 0) {
                    messagesContainer.scrollTop = 0;
                }
            },
            
            renderMessage(messageObj) {
                return `
                    <div class="console-message" data-type="${messageObj.type}" data-id="${messageObj.id}">
                        <span class="message-time">${messageObj.time}</span>
                        <div class="message-type ${messageObj.type}"></div>
                        <span class="message-text">${this.escapeHtml(messageObj.message)}</span>
                    </div>
                `;
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            applyFilters() {
                const showInfo = document.getElementById('showInfoMessages')?.checked ?? true;
                const showSuccess = document.getElementById('showSuccessMessages')?.checked ?? true;
                const showWarning = document.getElementById('showWarningMessages')?.checked ?? true;
                const showError = document.getElementById('showErrorMessages')?.checked ?? true;
                
                const messages = document.querySelectorAll('.console-message');
                messages.forEach(msg => {
                    const type = msg.getAttribute('data-type');
                    const shouldShow = (
                        (type === 'info' && showInfo) ||
                        (type === 'success' && showSuccess) ||
                        (type === 'warning' && showWarning) ||
                        (type === 'error' && showError)
                    );
                    
                    msg.classList.toggle('hidden', !shouldShow);
                });
            },
            
            updateToggleButton() {
                const toggleBtn = document.getElementById('consoleToggleBtn');
                if (toggleBtn) {
                    toggleBtn.classList.toggle('has-messages', this.messages.length > 0);
                }
            },
            
            clear() {
                this.messages = [];
                this.updateConsole();
                this.updateToggleButton();
                this.addMessage('Mesaj konsolu temizlendi', 'info');
            },
            
            toggle() {
                const console = document.getElementById('messageConsole');
                if (!console) return;
                
                this.isVisible = !this.isVisible;
                console.classList.toggle('show', this.isVisible);
                
                if (this.isVisible) {
                    this.updateConsole();
                }
            },
            
            minimize() {
                const console = document.getElementById('messageConsole');
                const toggleBtn = document.getElementById('consoleMinimizeBtn');
                
                if (console) {
                    console.classList.toggle('console-minimized');
                    const isMinimized = console.classList.contains('console-minimized');
                    
                    if (toggleBtn) {
                        toggleBtn.textContent = isMinimized ? '+' : '−';
                    }
                }
            },
            
            setupDragAndDrop() {
                const console = document.getElementById('messageConsole');
                const header = console?.querySelector('.console-header');
                
                if (!console || !header) return;
                
                header.addEventListener('mousedown', (e) => {
                    if (this.isDocked) return; // Docked iken taşınmaz
                    
                    this.dragData.isDragging = true;
                    this.dragData.startX = e.clientX;
                    this.dragData.startY = e.clientY;
                    
                    const rect = console.getBoundingClientRect();
                    this.dragData.startLeft = rect.left;
                    this.dragData.startTop = rect.top;
                    
                    header.style.cursor = 'grabbing';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!this.dragData.isDragging || this.isDocked) return;
                    
                    const deltaX = e.clientX - this.dragData.startX;
                    const deltaY = e.clientY - this.dragData.startY;
                    
                    const newLeft = Math.max(0, Math.min(window.innerWidth - console.offsetWidth, this.dragData.startLeft + deltaX));
                    const newTop = Math.max(0, Math.min(window.innerHeight - console.offsetHeight, this.dragData.startTop + deltaY));
                    
                    console.style.left = newLeft + 'px';
                    console.style.top = newTop + 'px';
                    console.style.right = 'auto';
                    console.style.bottom = 'auto';
                });
                
                document.addEventListener('mouseup', () => {
                    if (this.dragData.isDragging) {
                        this.dragData.isDragging = false;
                        header.style.cursor = 'move';
                    }
                });
            },
            
            toggleDock() {
                const console = document.getElementById('messageConsole');
                const dockBtn = document.getElementById('dockBtn');
                
                if (!console) return;
                
                this.isDocked = !this.isDocked;
                console.classList.toggle('docked-bottom', this.isDocked);
                
                if (this.isDocked) {
                    // Alt bara kilitle
                    console.style.left = '';
                    console.style.top = '';
                    console.style.right = '';
                    console.style.bottom = '';
                    
                    if (dockBtn) {
                        dockBtn.title = 'Serbest bırak';
                        dockBtn.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16,4V2H8V4H2V6H22V4H16M20,8H4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8Z"/>
                            </svg>
                        `;
                    }
                    
                    this.addMessage('Konsol alt bara kilitlendi', 'info');
                } else {
                    // Serbest konuma al
                    console.style.bottom = '20px';
                    console.style.right = '20px';
                    console.style.left = 'auto';
                    console.style.top = 'auto';
                    
                    if (dockBtn) {
                        dockBtn.title = 'Alt bara kilitle';
                        dockBtn.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16,20H20V16H16M16,14H20V10H16M4,8V4H8V8M10,20H14V16H10M16,8V4H20V8M4,20H8V16H4M4,14H8V10H4M10,8V4H14V8M10,14H14V10H10V14Z"/>
                            </svg>
                        `;
                    }
                    
                    this.addMessage('Konsol serbest konuma alındı', 'info');
                }
            }
        };
        
        // Sadece konsol sistemi - notification'lar kaldırıldı
        function showNotification(message, type = 'info', duration = 0) {
            // Sadece mesaj konsoluna ekle
            MessageConsole.addMessage(message, type);
        }
        

        
        // Konsol fonksiyonları
        function toggleMessageConsole() {
            MessageConsole.toggle();
        }
        
        function clearMessageConsole() {
            MessageConsole.clear();
        }
        
        function toggleConsoleMinimize() {
            MessageConsole.minimize();
        }
        
        function filterMessages() {
            MessageConsole.applyFilters();
        }
        
        function toggleConsoleDock() {
            MessageConsole.toggleDock();
        }
        
        // showToast fonksiyonu - artık sadece konsola mesaj gönderiyor
        // Tüm seçimleri temizle
        function clearAllSelections() {
            // Çizim modundayken seçimleri temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, seçimler korunuyor - clearAllSelections iptal edildi');
                return;
            }
            console.log('clearAllSelections çağrıldı');

            // Katman seçimlerini temizle
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });

            // Grup seçimlerini temizle
            document.querySelectorAll('.group-header').forEach(header => {
                header.classList.remove('selected');
            });

            // Global değişkenleri temizle
            activeLayerId = null;
            activeGroupId = null;
            window.activeLayerId = null;
            window.activeGroupId = null;

            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }

        // Seçili bilgi panelini güncelle
        function updateSelectedInfo() {
            // Bu fonksiyon şu an için boş, gelecekte seçim bilgilerini gösterecek
            console.log('updateSelectedInfo çağrıldı - activeLayerId:', activeLayerId, 'activeGroupId:', activeGroupId);
        }

        // Katman seçimini temizle
        function clearLayerSelection() {
            console.log('clearLayerSelection çağrıldı');
            
            // Çizim modundayken katman seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, katman seçimi korunuyor - clearLayerSelection iptal edildi');
                return;
            }
            
            // Tüm katman seçimlerini kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Aktif katmanı temizle
            activeLayerId = null;
            window.activeLayerId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }

        // Tüm modalları kapat
        function closeAllModals() {
            console.log('closeAllModals çağrıldı');
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Sürekli nokta çizim modunu durdur
        function stopContinuousPointMode() {
            if (window.continuousPointMode) {
                console.log('Sürekli nokta çizim modu durduruluyor...');
                window.continuousPointMode = false;
                
                // Aktif çizim araçlarını durdur
                if (window.drawControl && window.drawControl._toolbars.draw._modes.marker) {
                    const markerHandler = window.drawControl._toolbars.draw._modes.marker;
                    if (markerHandler.handler && markerHandler.handler.enabled && markerHandler.handler.enabled()) {
                        markerHandler.handler.disable();
                    }
                }
                
                // Tool butonlarının active class'ını temizle
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                showNotification('Nokta ekleme modu durduruldu', 'success');
            }
        }

        // Çizim fonksiyonları
        function startDrawing(type) {
            try {
                console.log('startDrawing çağrıldı:', type);
                
                // CRITICAL FIX: Stop measurement tools to prevent conflicts
                if (measurementTools && measurementTools.isActive) {
                    console.log('startDrawing: Ölçüm aracı durdurulıyor...');
                    measurementTools.stopMeasurement();
                }
                
                // Sürekli nokta çizim modu flag'ini set et
                if (type === 'marker') {
                    window.continuousPointMode = true;
                    console.log('Sürekli nokta çizim modu etkinleştirildi');
                } else {
                    window.continuousPointMode = false;
                }
                
                // Clear any active tools
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                // Activate current tool
                const toolBtn = document.getElementById(type + 'Btn') || 
                               document.querySelector(`[onclick*="${type}"]`);
                if (toolBtn) {
                    toolBtn.classList.add('active');
                }
                
                // Check if there's a selected layer - daha esnek kontrol
                if (!window.activeLayerId) {
                    const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                    if (selectedLayer) {
                        window.activeLayerId = selectedLayer.getAttribute('data-layer-id');
                        activeLayerId = window.activeLayerId;
                    } else {
                        // Eğer hiç katman yoksa otomatik katman oluştur
                        const hasLayers = document.querySelectorAll('.layer-item').length > 0;
                        if (!hasLayers) {
                            createDefaultGroup();
                            showNotification(`${ICON_LIBRARY[type]?.name || type} çizimi için otomatik katman oluşturuldu`, 'info');
                        } else {
                            showNotification('Çizim için bir katman seçin veya yeni katman oluşturun', 'warning');
                            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                            return;
                        }
                    }
                }
                
                // Double check that we have a valid layer
                const targetLayer = document.querySelector(`[data-layer-id="${window.activeLayerId}"]`);
                if (!targetLayer) {
                    showNotification('Seçili katman bulunamadı! Lütfen tekrar bir katman seçin.', 'error');
                    window.activeLayerId = null;
                    activeLayerId = null;
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    return;
                }
                
                // Store the active layer ID for drawing
                window.drawingActiveLayerId = window.activeLayerId;
                
                // Map the type to Leaflet Draw actions
                const drawHandlers = {
                    'marker': window.drawControl._toolbars.draw._modes.marker,
                    'polyline': window.drawControl._toolbars.draw._modes.polyline,
                    'polygon': window.drawControl._toolbars.draw._modes.polygon,
                    'rectangle': window.drawControl._toolbars.draw._modes.rectangle,
                    'circle': window.drawControl._toolbars.draw._modes.circle
                };
                
                // Get the appropriate handler
                const handler = drawHandlers[type];
                if (handler && handler.handler) {
                    // Stop any currently active drawing
                    Object.values(drawHandlers).forEach(mode => {
                        if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                            mode.handler.disable();
                        }
                    });
                    
                    // Ensure map interactions are enabled for polygon double-click finishing
                    if (type === 'polygon') {
                        console.log('Poligon çizimi - harita interaksiyonları kontrol ediliyor...');
                        // Make sure double-click is enabled for polygon finishing
                        if (map.doubleClickZoom && !map.doubleClickZoom.enabled()) {
                            map.doubleClickZoom.enable();
                            console.log('Double-click zoom etkinleştirildi');
                        }
                    }
                    
                    // Start the new drawing mode
                    handler.handler.enable();
                    
                    // Add visual feedback
                    const iconData = ICON_LIBRARY[type] || { name: type };
                    const layerName = targetLayer.querySelector('.layer-name')?.textContent || window.drawingActiveLayerId;
                    
                    if (type === 'marker') {
                        showNotification(`${iconData.name} sürekli ekleme modu - "${layerName}" katmanına çizilecek (ESC veya sağ tık ile durdurun)`, 'info');
                    } else {
                        showNotification(`${iconData.name} çizim modu aktif - "${layerName}" katmanına çizilecek${type === 'polygon' ? ' (Çift tıklayarak bitirebilirsiniz)' : ''}`, 'info');
                    }
                    
                    console.log(`Drawing started: ${type} on layer: ${window.drawingActiveLayerId}`);
                } else {
                    throw new Error(`Drawing handler not found for type: ${type}`);
                }
                
            } catch (error) {
                console.error('startDrawing error:', error);
                showNotification('Çizim başlatılamadı: ' + error.message, 'error');
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            }
        }

        // Lejant toggle
        function toggleLegend() {
            console.log('toggleLegend çağrıldı');
            const legend = document.getElementById('legend');
            if (legend) {
                if (legend.style.display === 'none' || legend.style.display === '') {
                    legend.style.display = 'block';
                    showNotification('Lejant açıldı', 'info');
                } else {
                    legend.style.display = 'none';
                    showNotification('Lejant kapatıldı', 'info');
                }
            }
        }

        // Zoom to extent
        function zoomToExtent() {
            console.log('zoomToExtent çağrıldı');
            try {
                if (drawnItems.getLayers().length > 0) {
                    map.fitBounds(drawnItems.getBounds());
                    showNotification('Tüm çizimlere zoom yapıldı', 'success');
                } else {
                    showNotification('Zoom yapılacak çizim bulunamadı', 'warning');
                }
            } catch (error) {
                console.error('zoomToExtent error:', error);
                showNotification('Zoom hatası: ' + error.message, 'error');
            }
        }

        // Tam ekran
        function toggleFullscreen() {
            console.log('toggleFullscreen çağrıldı');
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    showNotification('Tam ekran modu açıldı', 'info');
                } else {
                    document.exitFullscreen();
                    showNotification('Tam ekran modundan çıkıldı', 'info');
                }
            } catch (error) {
                console.error('toggleFullscreen error:', error);
                showNotification('Tam ekran hatası: ' + error.message, 'error');
            }
        }

        // Modal ve Layer yönetim fonksiyonları
        function showCreateGroupModal() {
            console.log('showCreateGroupModal çağrıldı');
            showNotification('Grup oluşturma modal fonksiyonu henüz tamamlanmadı', 'info');
        }

        function showCreateLayerModal() {
            console.log('showCreateLayerModal çağrıldı');
            showNotification('Katman oluşturma modal fonksiyonu henüz tamamlanmadı', 'info');
        }

        function toggleLayerFilter() {
            console.log('toggleLayerFilter çağrıldı');
            const panel = document.getElementById('searchFilterPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } else {
                showNotification('Filtre paneli bulunamadı', 'warning');
            }
        }

        function expandAllGroups() {
            console.log('expandAllGroups çağrıldı');
            document.querySelectorAll('.group-items').forEach(group => {
                group.style.display = 'block';
            });
            document.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.textContent = '▼';
            });
            showNotification('Tüm gruplar açıldı', 'info');
        }

        function collapseAllGroups() {
            console.log('collapseAllGroups çağrıldı');
            document.querySelectorAll('.group-items').forEach(group => {
                group.style.display = 'none';
            });
            document.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.textContent = '▶';
            });
            showNotification('Tüm gruplar kapatıldı', 'info');
        }

        function toggleGroup(groupId) {
            console.log('toggleGroup çağrıldı:', groupId);
            const groupItems = document.getElementById(`group-${groupId}`);
            const groupToggle = document.querySelector(`[onclick="toggleGroup('${groupId}')"]`);
            
            if (groupItems) {
                if (groupItems.style.display === 'none') {
                    groupItems.style.display = 'block';
                    if (groupToggle) groupToggle.textContent = '▼';
                } else {
                    groupItems.style.display = 'none';
                    if (groupToggle) groupToggle.textContent = '▶';
                }
            }
        }

        function toggleAllLayersInGroup(event, checkbox) {
            console.log('toggleAllLayersInGroup çağrıldı');
            event.stopPropagation();
            const group = checkbox.closest('.layer-group');
            const layerCheckboxes = group.querySelectorAll('.layer-item input[type="checkbox"]');
            
            layerCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                // Trigger visibility change
                cb.dispatchEvent(new Event('change'));
            });
            
            showNotification(`Grup katmanları ${checkbox.checked ? 'gösterildi' : 'gizlendi'}`, 'info');
        }

        function showLayerProperties(button) {
            console.log('showLayerProperties çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katman özellikleri: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function openStyleModal(type) {
            console.log('openStyleModal çağrıldı:', type);
            const modal = document.getElementById('styleModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                showNotification('Stil modal bulunamadı', 'warning');
            }
        }

        function openLayerDetails(button) {
            console.log('openLayerDetails çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katman detayları: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function zoomToLayer(button) {
            console.log('zoomToLayer çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katmana zoom: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function openQueryModal(button) {
            console.log('openQueryModal çağrıldı');
            const modal = document.getElementById('queryModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                showNotification('Sorgu modal bulunamadı', 'warning');
            }
        }

        // Ölçek fonksiyonları
        function toggleScaleSelector(event) {
            console.log('toggleScaleSelector çağrıldı');
            event.stopPropagation();
            const selector = document.querySelector('.scale-selector');
            if (selector) {
                selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
            }
        }

        function setFixedScale(scale) {
            console.log('setFixedScale çağrıldı:', scale);
            const scaleText = document.getElementById('scaleText');
            if (scaleText) {
                scaleText.textContent = `1:${scale.toLocaleString()}`;
            }
            // Hide selector
            const selector = document.querySelector('.scale-selector');
            if (selector) selector.style.display = 'none';
            showNotification(`Ölçek 1:${scale.toLocaleString()} olarak ayarlandı`, 'info');
        }

        function setDynamicScale() {
            console.log('setDynamicScale çağrıldı');
            const selector = document.querySelector('.scale-selector');
            if (selector) selector.style.display = 'none';
            showNotification('Dinamik ölçek moduna geçildi', 'info');
        }

        function switchToDynamicScale() {
            console.log('switchToDynamicScale çağrıldı');
            setDynamicScale();
        }

        // Lejant fonksiyonları
        function toggleLegendSettings() {
            console.log('toggleLegendSettings çağrıldı');
            showNotification('Lejant ayarları henüz tamamlanmadı', 'info');
        }

        function toggleLegendContent() {
            console.log('toggleLegendContent çağrıldı');
            const legend = document.getElementById('legend');
            const content = legend?.querySelector('.legend-content');
            if (content) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            }
        }

        function closeLegend() {
            console.log('closeLegend çağrıldı');
            const legend = document.getElementById('legend');
            if (legend) {
                legend.style.display = 'none';
            }
        }

        // Context menu
        function contextMenuAction(action) {
            console.log('contextMenuAction çağrıldı:', action);
            showNotification(`Context menu action: ${action}`, 'info');
        }

        // Otomatik grup ve katman oluştur
        function createDefaultGroup() {
            try {
                // Varsayılan grup oluştur
                const groupId = 'group-' + Date.now();
                const groupName = 'Yeni Grup';
                
                // Grup container'ı bul
                const layerListContainer = document.getElementById('layerList');
                if (!layerListContainer) {
                    throw new Error('Layer list container bulunamadı');
                }
                
                // Grup HTML'ini oluştur
                const groupHTML = `
                    <div class="layer-group" data-group-id="${groupId}">
                        <div class="group-header">
                            <div class="group-toggle-area">
                                <span class="group-toggle" onclick="toggleGroup('${groupId}')">▼</span>
                            </div>
                            <div class="group-select-area" style="flex: 1; display: flex; align-items: center;">
                                <span class="group-icon">🗂️</span>
                                <span class="group-name">${groupName}</span>
                                <span class="group-count">0</span>
                            </div>
                            <div class="group-actions">
                                <label class="group-visibility-checkbox">
                                    <input type="checkbox" checked onchange="toggleGroupVisibility('${groupId}')">
                                    <span class="visibility-icon">👁️</span>
                                </label>
                            </div>
                        </div>
                        <div class="group-items" id="group-${groupId}"></div>
                    </div>
                `;
                
                layerListContainer.insertAdjacentHTML('beforeend', groupHTML);
                
                // Grup oluşturulduktan sonra varsayılan katman oluştur
                const layerId = 'layer-' + Date.now();
                const layerName = 'Çizim Katmanı';
                
                const layerHTML = `
                    <div class="layer-item" data-layer-id="${layerId}">
                        <div class="layer-selectable-area">
                            <span class="layer-icon">📍</span>
                            <div class="layer-details">
                                <span class="layer-name">${layerName}</span>
                                <span class="layer-info">0 öğe</span>
                            </div>
                            <span class="layer-style-mode-indicator default-mode" data-layer-id="${layerId}" title="Varsayılan Kurumsal Ayarlar" onclick="toggleLayerStyleMode('${layerId}', event)">
                                🏢
                            </span>
                        </div>
                        <div class="layer-actions">
                            <button class="layer-action-btn" onclick="showStyleModal('${layerId}')" title="Stil">🎨</button>
                            <button class="layer-action-btn" onclick="showLayerDetails('${layerId}')" title="Detaylar">ℹ️</button>
                            <label class="layer-visibility">
                                <input type="checkbox" checked onchange="toggleLayerVisibility('${layerId}')">
                                <span class="visibility-icon">👁️</span>
                            </label>
                        </div>
                    </div>
                `;
                
                const groupItemsContainer = document.getElementById(`group-${groupId}`);
                groupItemsContainer.insertAdjacentHTML('beforeend', layerHTML);
                
                // Katmanı otomatik seç
                const layerElement = document.querySelector(`[data-layer-id="${layerId}"]`);
                if (layerElement) {
                    selectLayer(layerElement);
                }
                
                // Grup sayısını güncelle
                updateGroupLayerCount(document.querySelector(`[data-group-id="${groupId}"]`));
                
                return { groupId, layerId };
                
            } catch (error) {
                console.error('Otomatik grup oluşturma hatası:', error);
                showNotification('Otomatik grup oluşturulamadı', 'error');
                return null;
            }
        }

        // Utility Functions

        // Input sanitization to prevent XSS attacks
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';

            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Validate layer/group name
        function validateName(name) {
            if (!name || typeof name !== 'string') {
                return { valid: false, error: 'Ad boş olamaz' };
            }

            const trimmed = name.trim();

            if (trimmed.length === 0) {
                return { valid: false, error: 'Ad boş olamaz' };
            }

            if (trimmed.length > 100) {
                return { valid: false, error: 'Ad çok uzun (max 100 karakter)' };
            }

            // Check for potentially dangerous characters
            const dangerousPattern = /<script|javascript:|onerror=|onclick=/i;
            if (dangerousPattern.test(trimmed)) {
                return { valid: false, error: 'Geçersiz karakterler içeriyor' };
            }

            return { valid: true, sanitized: sanitizeInput(trimmed) };
        }

        // === ESKI KODLAR ===
        
        // Harita başlatma
        var map;
        // Çizim katmanları
        var drawnItems = new L.FeatureGroup();
        // Çizim katmanlarının referanslarını saklamak için
        var drawnLayers = [];
        // Aktif katman seçimi
        var activeLayerId = null; // Aktif katman ID'si
        window.activeLayerId = activeLayerId; // Global erişim için
        var isDrawingMode = false; // Çizim modu aktif mi?
        var activeGroupId = null; // Aktif grup ID'si
        var layerFeatures = {}; // Katmanlara ait çizimler
        
        var measurementTools = null;
        

        
        document.addEventListener('DOMContentLoaded', function() {
            // Modal taşıma işlevselliğini başlat
            initModalDragging();
            
            // Nokta stil tipi değişikliğini dinle
            initPointStyleTypeToggle();
            
            // Haritayı başlat
            map = L.map('map').setView([41.0082, 28.9784], 10);
            
            // Temel harita katmanını ekle
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Çizim katmanını haritaya ekle
            map.addLayer(drawnItems);
            
            // Measurement tools'u başlat
            measurementTools = new MeasurementTools(map);
            
            // Mesaj konsolunu başlat
            MessageConsole.init();
            
            // Context menu event listener
            setupContextMenu();
            
            // Keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Search functionality
            setupSearchAndFilter();
            
            // Koordinat ve ölçek işlevselliğini başlat
            setupCoordinateDisplay();
            setupScaleDisplay();
            setupProjectionSystem();
            
            // Çizim araçlarını tanımla ve mevcut stil ayarlarına göre yapılandır
            function getDrawControl() {
                // Mevcut stil ayarlarını al
                const pointColor = document.getElementById('pointColor').value || "#ff0000";
                const lineColor = document.getElementById('lineColor').value || "#ff7800";
                const lineWidth = parseInt(document.getElementById('lineWidth').value || 3);
                const fillColor = document.getElementById('fillColor').value || "#3388ff";
                const fillOpacity = (document.getElementById('fillOpacity').value || 50) / 100;
                const strokeColor = document.getElementById('strokeColor').value || "#000000";
                const strokeWidth = parseInt(document.getElementById('strokeWidth').value || 1);
                
                // Çizgi stili için dashArray tanımla
                const lineType = document.getElementById('lineType').value || "solid";
                const lineDashArray = calculateDashArray(lineType, lineWidth);
                
                // Poligon stili için dashArray tanımla
                const strokeType = document.getElementById('strokeType').value || "solid";
                const strokeDashArray = calculateDashArray(strokeType, strokeWidth);
                
                return new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polyline: {
                            shapeOptions: {
                                color: lineColor,
                                weight: lineWidth,
                                dashArray: lineDashArray
                            }
                        },
                        polygon: {
                            allowIntersection: false,
                            showArea: true,
                            metric: true,
                            feet: false,
                            nautic: false,
                            precision: 2,
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        circle: {
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        rectangle: {
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        marker: true
                    },
                    edit: {
                        featureGroup: drawnItems,
                        remove: true
                    }
                });
            }
            
            // Çizim araçlarını oluştur ve haritaya ekle
            window.drawControl = getDrawControl();
            map.addControl(window.drawControl);
            
            // Çizim kontrolünü özel konuma taşı
            setTimeout(() => {
                const drawControl = document.querySelector('.leaflet-draw');
                const placeholder = document.getElementById('drawing-tools-placeholder');
                if (drawControl && placeholder) {
                    // Leaflet Draw kontrolünü özel tasarıma uyarla
                    drawControl.style.position = 'static';
                    drawControl.style.margin = '0';
                    
                    // Temel Geometri grubu oluştur
                    const geometryGroup = document.createElement('div');
                    geometryGroup.className = 'tool-group';
                    
                    const geometryTitle = document.createElement('div');
                    geometryTitle.className = 'tool-group-title';
                    geometryTitle.textContent = 'Temel Geometri';
                    
                    const geometryButtons = document.createElement('div');
                    geometryButtons.className = 'tool-buttons';
                    
                    // Şekil Çizimi grubu oluştur
                    const shapeGroup = document.createElement('div');
                    shapeGroup.className = 'tool-group';
                    
                    const shapeTitle = document.createElement('div');
                    shapeTitle.className = 'tool-group-title';
                    shapeTitle.textContent = 'Şekil Çizimi';
                    
                    const shapeButtons = document.createElement('div');
                    shapeButtons.className = 'tool-buttons';
                    
                    // Leaflet Draw butonlarını kategorilere ayır
                    const drawButtons = drawControl.querySelectorAll('a');
                    drawButtons.forEach(btn => {
                        const newBtn = document.createElement('button');
                        newBtn.className = 'tool-btn';
                        newBtn.title = btn.title;
                        newBtn.innerHTML = getDrawButtonIcon(btn.title);
                        newBtn.onclick = () => {
                            console.log('Çizim butonu tıklandı');
                            console.log('Buton tıklandığında aktif katman:', activeLayerId);
                            console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                            
                            // Seçili katman kontrolü
                            const activeLayer = getActiveLayer();
                            if (!activeLayer) {
                                alert('Çizim yapmak için önce bir katman seçmelisiniz!');
                                return;
                            }
                            
                            // Aktif katman ID'sini kaydet (çizim sırasında korunması için)
                            window.drawingActiveLayerId = activeLayerId;
                            console.log('Çizim başlatılıyor, aktif katman kaydedildi:', window.drawingActiveLayerId);
                            
                            // Leaflet Draw butonuna tıklamadan önce son kontrol
                            console.log('Leaflet Draw butonuna tıklamadan önce seçili katman:', document.querySelector('.layer-item.selected-highlight'));
                            
                            btn.click();
                            
                            // Leaflet Draw butonuna tıkladıktan sonra kontrol
                            setTimeout(() => {
                                console.log('Leaflet Draw butonuna tıkladıktan sonra seçili katman:', document.querySelector('.layer-item.selected-highlight'));
                            }, 100);
                        };
                        
                        // Butonları kategorilere göre ayır
                        if (btn.title.includes('marker') || btn.title.includes('Marker') || 
                            btn.title.includes('polyline') || btn.title.includes('line') || 
                            btn.title.includes('polygon')) {
                            geometryButtons.appendChild(newBtn);
                        } else if (btn.title.includes('circle') || btn.title.includes('Circle') ||
                                  btn.title.includes('rectangle') || btn.title.includes('Rectangle')) {
                            // Circle ve Rectangle butonlarını şekil grubuna ekle (eğer varsa)
                            shapeButtons.appendChild(newBtn);
                        } else {
                            // Edit ve Delete butonları için ayrı bir grup oluşturabiliriz
                            geometryButtons.appendChild(newBtn);
                        }
                    });
                    

                    
                    geometryGroup.appendChild(geometryTitle);
                    geometryGroup.appendChild(geometryButtons);
                    
                    shapeGroup.appendChild(shapeTitle);
                    shapeGroup.appendChild(shapeButtons);
                    
                    placeholder.appendChild(geometryGroup);
                    placeholder.appendChild(shapeGroup);
                    
                    // Orijinal kontrolü gizle
                    drawControl.style.display = 'none';
                }
            }, 100);
            
            // Stil değiştiğinde çizim kontrolünü güncelle
            function updateDrawControl() {
                // Eski kontrol kaldır
                if (window.drawControl) {
                    try {
                        map.removeControl(window.drawControl);
                    } catch(e) {
                        // Control yoksa hata vermesin
                    }
                }
                // Yeni kontrol oluştur ve haritaya ekle
                window.drawControl = getDrawControl();
                map.addControl(window.drawControl);
                
                // Çizim kontrolünü özel konuma taşı
                setTimeout(() => {
                    const drawControl = document.querySelector('.leaflet-draw');
                    const placeholder = document.getElementById('drawing-tools-placeholder');
                    if (drawControl && placeholder) {
                        // Leaflet Draw kontrolünü gizle (özel butonlar kullanıyoruz)
                        drawControl.style.display = 'none';
                    }
                }, 100);
            }
            
            // Çizim başladığında
            map.on('draw:drawstart', function(e) {
                isDrawingMode = true;
                window.drawingCompleted = false; // Flag'i sıfırla
                console.log('Çizim modu başladı, seçimler korunacak');
                console.log('Çizim başladığında aktif katman:', activeLayerId);
                console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                
                // CRITICAL FIX: Stop measurement tools to prevent event conflicts
                if (measurementTools && measurementTools.isActive) {
                    console.log('Ölçüm aracı aktif - devre dışı bırakılıyor...');
                    measurementTools.stopMeasurement();
                    showNotification('Çizim başlatıldı - ölçüm aracı durduruldu', 'info');
                }
                
                // Seçimleri backup'la
                window.backupActiveLayerId = activeLayerId;
                window.backupActiveGroupId = activeGroupId;
                
                // Seçili katman ve grup elementlerini backup'la
                const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                const selectedGroup = document.querySelector('.group-header.selected');
                window.backupSelectedLayer = selectedLayer;
                window.backupSelectedGroup = selectedGroup;
                
                console.log('Seçimler backup\'landı:', {
                    layerId: window.backupActiveLayerId,
                    groupId: window.backupActiveGroupId,
                    layerElement: window.backupSelectedLayer,
                    groupElement: window.backupSelectedGroup
                });
                
                // Çizim sırasında seçimleri koruma timer'ı başlat
                window.selectionProtectionTimer = setInterval(function() {
                    if (isDrawingMode && window.backupSelectedLayer && window.backupSelectedGroup) {
                        // Seçili katman kaybolmuşsa geri yükle
                        if (!window.backupSelectedLayer.classList.contains('selected-highlight')) {
                            console.log('Seçili katman kaybedildi, geri yükleniyor...');
                            // Önce tüm seçimleri kaldır
                            document.querySelectorAll('.layer-item').forEach(item => {
                                item.classList.remove('selected-highlight', 'selected');
                            });
                            // Backup'tan geri yükle
                            window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                            activeLayerId = window.backupActiveLayerId;
                        }
                        
                        // Seçili grup kaybolmuşsa geri yükle
                        if (!window.backupSelectedGroup.classList.contains('selected')) {
                            console.log('Seçili grup kaybedildi, geri yükleniyor...');
                            // Önce tüm grup seçimlerini kaldır
                            document.querySelectorAll('.group-header').forEach(h => {
                                h.classList.remove('selected');
                            });
                            // Backup'tan geri yükle
                            window.backupSelectedGroup.classList.add('selected');
                            activeGroupId = window.backupActiveGroupId;
                        }
                    }
                }, 50); // Her 50ms'de kontrol et (daha hızlı)
            });
            
            // Çizim iptal edildiğinde veya bittiğinde
            map.on('draw:drawstop', function(e) {
                // Çizim tamamlandıysa (draw:created event'i çalıştıysa) seçimi koruma işlemi orada yapılacak
                // Burada sadece timer'ı durdur, seçimi koruma
                console.log('Çizim durdu - timer durduruluyor, seçim korunuyor');
                
                // Clear active drawing tool buttons
                setTimeout(() => {
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Show cancellation message only if drawing was actually cancelled (not completed)
                    if (!window.drawingCompleted) {
                        showNotification('Çizim iptal edildi', 'info');
                    }
                }, 50);
                
                // Seçim koruma timer'ını durdur
                if (window.selectionProtectionTimer) {
                    clearInterval(window.selectionProtectionTimer);
                    window.selectionProtectionTimer = null;
                }
                
                // isDrawingMode'u biraz gecikme ile false yap ki draw:created event'i önce çalışsın
                setTimeout(() => {
                    isDrawingMode = false;
                    console.log('isDrawingMode false yapıldı');
                }, 100);
                
                // Eğer çizim tamamlanmadıysa (sadece iptal edildiyse) seçimi geri yükle
                setTimeout(() => {
                    if (!window.drawingCompleted && window.backupSelectedLayer && window.backupSelectedGroup) {
                        // Çizim iptal edildi, seçimi geri yükle
                        window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                        window.backupSelectedGroup.classList.add('selected');
                        activeLayerId = window.backupActiveLayerId;
                        activeGroupId = window.backupActiveGroupId;
                        console.log('Çizim iptal edildi, seçim geri yüklendi:', activeLayerId);
                        
                        // Backup'ları temizle
                        delete window.backupActiveLayerId;
                        delete window.backupActiveGroupId;
                        delete window.backupSelectedLayer;
                        delete window.backupSelectedGroup;
                    }
                    
                    // Flag'i sıfırla
                    window.drawingCompleted = false;
                }, 150);
            });
            
            // Çizim yapıldığında olayı dinle
            map.on('draw:created', function(e) {
                window.drawingCompleted = true; // Çizim tamamlandı flag'i
                console.log('Çizim tamamlandı, seçimler normale döndü');
                console.log('Çizim tamamlandığında aktif katman:', activeLayerId);
                console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                console.log('Kaydedilen çizim katmanı:', window.drawingActiveLayerId);
                
                var type = e.layerType;
                var layer = e.layer;
                
                // Sürekli nokta çizim modu kontrolü
                const isContinuousPointMode = window.continuousPointMode && type === 'marker';
                
                if (!isContinuousPointMode) {
                    // Normal mod: çizim araçlarını temizle
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                }
                
                // Show completion notification
                const typeNames = {
                    'marker': 'Nokta',
                    'polyline': 'Çizgi', 
                    'polygon': 'Poligon',
                    'rectangle': 'Dikdörtgen',
                    'circle': 'Daire'
                };
                const typeName = typeNames[type] || type;
                
                // Stil ayarlarını uygula
                if (type === 'marker') {
                    // Nokta stilini uygula
                    const pointColor = document.getElementById('pointColor').value || "#ff0000";
                    const pointSize = parseInt(document.getElementById('pointSize').value || 8);
                    const pointOpacity = (document.getElementById('pointOpacity').value || 100) / 100;
                    const pointShape = document.getElementById('pointShape').value || "circle";
                    const pointStyleType = document.getElementById('pointStyleType').value || "custom";
                    
                    // Custom icon oluştur
                    let iconHtml = '';
                    const rgbaColor = hexToRgba(pointColor, pointOpacity);
                    
                    if (pointStyleType === 'custom') {
                        if (pointShape === 'circle') {
                            iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                        } else if (pointShape === 'square') {
                            iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                        } else if (pointShape === 'triangle') {
                            iconHtml = `<div style="width: 0; height: 0; border-left: ${pointSize/2}px solid transparent; border-right: ${pointSize/2}px solid transparent; border-bottom: ${pointSize}px solid ${rgbaColor};"></div>`;
                        } else if (pointShape === 'star') {
                            iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>`;
                        } else if (pointShape === 'diamond') {
                            iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 22,12 12,22 2,12"/></svg>`;
                        }
                    } else {
                        // İkon modunda varsayılan bir ikon kullan - bu daha sonra geliştirilebilir
                        iconHtml = `<div style="color: ${rgbaColor}; font-size: ${pointSize}px;">📍</div>`;
                    }
                    
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-div-icon',
                        iconSize: [pointSize, pointSize],
                        iconAnchor: [pointSize/2, pointSize/2]
                    });
                    
                    layer.setIcon(customIcon);
                    
                    // Stil bilgilerini sakla
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'point',
                        color: pointColor,
                        size: pointSize,
                        opacity: pointOpacity,
                        shape: pointShape,
                        styleType: pointStyleType
                    };
                    
                    layer.bindPopup(`<div style="color:${pointColor}"><strong>Nokta</strong><br>Şekil: ${pointShape}<br>Boyut: ${pointSize}px<br>Saydamlık: ${Math.round(pointOpacity * 100)}%</div>`);
                } else if (type === 'polyline') {
                    // Çizgi stilini uygula
                    const lineColor = document.getElementById('lineColor').value || "#ff7800";
                    const lineWidth = parseInt(document.getElementById('lineWidth').value || 3);
                    const lineOpacity = (document.getElementById('lineOpacity').value || 100) / 100;
                    const lineType = document.getElementById('lineType').value || "solid";
                    
                    const dashArray = calculateDashArray(lineType, lineWidth);
                    
                    layer.setStyle({
                        color: lineColor,
                        weight: lineWidth,
                        opacity: lineOpacity,
                        dashArray: dashArray
                    });
                    
                    // Stil bilgilerini sakla
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'line',
                        color: lineColor,
                        width: lineWidth,
                        opacity: lineOpacity,
                        lineType: lineType
                    };
                    
                    layer.bindPopup(`<div style="color:${lineColor}"><strong>Çizgi</strong><br>Kalınlık: ${lineWidth}px<br>Saydamlık: ${Math.round(lineOpacity * 100)}%<br>Tip: ${lineType}</div>`);
                } else if (type === 'polygon' || type === 'rectangle' || type === 'circle') {
                    // Poligon, dikdörtgen ve daire için aynı stil ayarlarını uygula
                    const fillColor = document.getElementById('fillColor').value || "#3388ff";
                    const fillOpacity = (document.getElementById('fillOpacity').value || 50) / 100;
                    const strokeColor = document.getElementById('strokeColor').value || "#000000";
                    const strokeWidth = parseInt(document.getElementById('strokeWidth').value || 1);
                    const strokeOpacity = (document.getElementById('strokeOpacity').value || 100) / 100;
                    const strokeType = document.getElementById('strokeType').value || "solid";
                    
                    const dashArray = calculateDashArray(strokeType, strokeWidth);
                    
                    layer.setStyle({
                        fillColor: fillColor,
                        fillOpacity: fillOpacity,
                        color: strokeColor,
                        weight: strokeWidth,
                        opacity: strokeOpacity,
                        dashArray: dashArray
                    });
                    
                    // Stil bilgilerini sakla - hepsini 'polygon' olarak kaydet
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'polygon', // Hepsini polygon olarak kaydet
                        originalType: type, // Orijinal tipi de sakla
                        fillColor: fillColor,
                        fillOpacity: fillOpacity,
                        strokeColor: strokeColor,
                        strokeWidth: strokeWidth,
                        strokeOpacity: strokeOpacity,
                        strokeType: strokeType
                    };
                    
                    // Popup'ta orijinal tip adını göster
                    let shapeDisplayName = 'Poligon';
                    if (type === 'rectangle') shapeDisplayName = 'Dikdörtgen';
                    else if (type === 'circle') shapeDisplayName = 'Daire';
                    
                    layer.bindPopup(`<div style="color:${fillColor}"><strong>${shapeDisplayName}</strong><br>Dolgu Saydamlık: ${Math.round(fillOpacity * 100)}%<br>Kenar Kalınlık: ${strokeWidth}px<br>Kenar Saydamlık: ${Math.round(strokeOpacity * 100)}%</div>`);
                }
                
                // Katmanı çizim katmanına ekle
                drawnItems.addLayer(layer);
                

                
                // Çizimi seçili katmana ekle
                addFeatureToActiveLayer(type, layer, typeName);
                
                // Sürekli nokta çizim modu: nokta eklendikten sonra tekrar başlat
                if (isContinuousPointMode) {
                    setTimeout(() => {
                        console.log('Sürekli nokta modu: tekrar başlatılıyor...');
                        // Marker çizim modunu tekrar başlat
                        const markerHandler = window.drawControl._toolbars.draw._modes.marker;
                        if (markerHandler && markerHandler.handler) {
                            markerHandler.handler.enable();
                            showNotification('Nokta eklendi, sürekli mod devam ediyor... (ESC veya sağ tık ile durdurun)', 'info');
                        }
                    }, 100);
                }
                
                // Seçimi koru - çizim tamamlandıktan sonra da seçim kalsın
                if (window.backupSelectedLayer && window.backupSelectedGroup) {
                    // Son kez seçimi geri yükle
                    window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                    window.backupSelectedGroup.classList.add('selected');
                    activeLayerId = window.backupActiveLayerId;
                    activeGroupId = window.backupActiveGroupId;
                    console.log('Çizim tamamlandı, seçim korundu:', activeLayerId);
                    
                    // Backup'ları temizle (draw:drawstop'tan önce)
                    setTimeout(() => {
                        delete window.backupActiveLayerId;
                        delete window.backupActiveGroupId;
                        delete window.backupSelectedLayer;
                        delete window.backupSelectedGroup;
                        console.log('Çizim tamamlandı - backup\'lar temizlendi');
                    }, 50);
                }
            });
            
            // Event delegation ile katman seçimi - düzeltilmiş versiyon
            document.addEventListener('click', function(e) {
                // Katman butonlarına tıklandığında
                if (e.target.closest('.layer-action-btn')) {
                    e.stopPropagation();
                    // Buton işlevini çalıştır ama katman seçimini engelle
                    return;
                }
                
                // Checkbox'a tıklandığında sadece checkbox işlevi çalışsın
                if (e.target.closest('.layer-visibility')) {
                    e.stopPropagation();
                    return;
                }
                
                // Grup checkbox'ına tıklandığında sadece checkbox işlevi çalışsın
                if (e.target.closest('.group-visibility-checkbox')) {
                    e.stopPropagation();
                    return;
                }
                
                // Grup toggle alanına tıklandığında
                if (e.target.closest('.group-toggle-area')) {
                    e.stopPropagation();
                    return;
                }
                
                // Katman seçimi - seçilebilir alana tıklandığında
                const selectableArea = e.target.closest('.layer-selectable-area');
                if (selectableArea) {
                    e.stopPropagation();
                    const layerItem = selectableArea.closest('.layer-item');
                    if (layerItem) {
                        selectLayer(layerItem);
                    }
                    return;
                }
                
                // Grup seçimi - seçilebilir alana tıklandığında
                const groupSelectArea = e.target.closest('.group-select-area');
                if (groupSelectArea) {
                    e.stopPropagation();
                    selectGroup(groupSelectArea);
                    return;
                }
                
                // Başka bir yere tıklandığında seçimleri kaldır (ama çizim yaparken değil)
                if (!e.target.closest('.layer-panel') && !e.target.closest('.leaflet-container') && !isDrawingMode) {
                    clearAllSelections();
                }
            });
            
            // Harita yeniden boyutlandırma - daha uzun bir gecikme ile
            setTimeout(function() {
                map.invalidateSize(true);
            }, 500);
            
            // Pencere boyutu değiştiğinde haritayı yeniden boyutlandır
            window.addEventListener('resize', function() {
                map.invalidateSize(true);
            });

            // Lejant sembol boyutu display'ini başlat
            updateLegendSymbolSizeDisplay();
            
            // Sayfa yüklendiğinde grup sayılarını güncelle
            updateAllGroupCounts();
            
            // Grup görünürlük butonlarını güncelle
            updateAllGroupVisibilityButtons();
            
            // Katman stil modu göstergelerini güncelle
            updateAllLayerStyleModeIndicators();
            
            // Lejant sürükleme işlevselliğini başlat
            initLegendDragging();

        });
        
        // Katman seçici oluşturma
        function createLayerSelector() {
            // Çizim kontrol paneli oluştur
            var drawingControl = document.createElement('div');
            drawingControl.className = 'drawing-control';
            drawingControl.style.cssText = 'position: absolute; top: 10px; right: 50px; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.3); z-index: 400; max-width: 250px; font-size: 12px;';
            
            // Başlık
            var title = document.createElement('h5');
            title.textContent = 'Çizim Ayarları';
            title.style.cssText = 'margin: 0 0 8px 0;';
            drawingControl.appendChild(title);
            
            // Açıklama
            var description = document.createElement('p');
            description.textContent = 'Çizimlerin ekleneceği katman grubunu seçin:';
            description.style.cssText = 'margin-bottom: 8px;';
            drawingControl.appendChild(description);
            
            // Seçici dropdown
            var selector = document.createElement('select');
            selector.id = 'layerGroupSelector';
            selector.style.cssText = 'width: 100%; padding: 5px; margin-bottom: 10px;';
            
            // Grupları ekle
            const groups = document.querySelectorAll('.layer-group');
            groups.forEach(group => {
                const groupName = group.querySelector('.group-name').textContent;
                var option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                if (groupName === activeLayerGroup) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            // Değişiklik olayını dinle
            selector.addEventListener('change', function() {
                activeLayerGroup = this.value;
            });
            
            drawingControl.appendChild(selector);
            
            // Harita container'ına ekle
            document.querySelector('.map-container').appendChild(drawingControl);
        }
        
        // =================================
        // 6. ENHANCED LAYER MANAGEMENT
        // =================================
        const LayerManager = {
            // Grup oluşturma modal'ını aç (enhanced)
            showCreateGroupModal() {
                return Utils.safeExecute(() => {
                    const groupName = prompt('Yeni grup adı:');
                    if (groupName && groupName.trim()) {
                        this.createGroup(groupName.trim());
                    }
                }, 'Group Modal Creation');
            },
            
            // Katman oluşturma modal'ını aç (enhanced)
            showCreateLayerModal() {
                return Utils.safeExecute(() => {
                    const layerName = prompt('Yeni katman adı:');
                    if (!layerName || !layerName.trim()) {
                        return;
                    }
                    
                    // Grup seçimi için basit prompt
                    const groups = Array.from(document.querySelectorAll('.layer-group')).map(group => {
                        return {
                            id: group.getAttribute('data-group-id'),
                            name: group.querySelector('.group-name').textContent
                        };
                    });
                    
                    if (groups.length === 0) {
                        showToast('Önce bir grup oluşturun!', 'error');
                        return;
                    }
                    
                    let targetGroupId = activeGroupId;
                    if (groups.length > 1) {
                        const groupList = groups.map((g, i) => `${i + 1}. ${g.name}`).join('\n');
                        const selection = prompt(`Hangi gruba eklensin?\n${groupList}\n\nNumara girin:`);
                        const index = parseInt(selection) - 1;
                        if (index >= 0 && index < groups.length) {
                            targetGroupId = groups[index].id;
                        } else {
                            targetGroupId = groups[0].id;
                        }
                    } else {
                        targetGroupId = groups[0].id;
                    }
                    
                    this.createLayer(layerName.trim(), targetGroupId);
                }, 'Layer Modal Creation');
            },

            createGroup(groupName) {
                return Utils.safeExecute(() => {
                    const validName = Utils.validateInput.layerName(groupName);
                    return createGroup(validName);
                }, 'Group Creation');
            },

            createLayer(layerName, targetGroupId) {
                return Utils.safeExecute(() => {
                    const validName = Utils.validateInput.layerName(layerName);
                    return createLayer(validName, targetGroupId);
                }, 'Layer Creation');
            }
        };

        // =================================
        // 7. ENHANCED STYLE MANAGEMENT
        // =================================
        const StyleManager = {
            applyStyle() {
                return Utils.safeExecute(() => {
                    return applyStyle();
                }, 'Style Application');
            },

            applyToLayer(layerElement, layerId, layerType) {
                return Utils.safeExecute(() => {
                    return applyStyleToLayer(layerElement, layerId, layerType);
                }, 'Layer Style Application');
            }
        };

        // =================================
        // 8. ENHANCED EVENT MANAGEMENT
        // =================================
        const EventManager = {
            setupDebouncedStyleUpdates() {
                const debouncedStyleUpdate = Utils.debounce(() => {
                    StyleManager.applyStyle();
                }, CONFIG.DEBOUNCE_DELAY);

                const styleInputs = [
                    'pointColor', 'pointSize', 'pointShape', 'pointOpacity',
                    'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                    'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType'
                ];

                styleInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', debouncedStyleUpdate);
                        input.addEventListener('change', debouncedStyleUpdate);
                    }
                });
            },

            setupThrottledCoordinateUpdates() {
                const throttledCoordUpdate = Utils.throttle((e) => {
                    updateCoordinateDisplay(e.latlng);
                }, CONFIG.THROTTLE_DELAY);

                if (map) {
                    map.on('mousemove', throttledCoordUpdate);
                }
            }
        };

        // =================================
        // 9. BACKWARD COMPATIBILITY WRAPPERS
        // =================================
        
        // Grup oluşturma modal'ını aç (basitleştirilmiş)
        function showCreateGroupModal() {
            return LayerManager.showCreateGroupModal();
        }
        
        // Katman oluşturma modal'ını aç (basitleştirilmiş)
        function showCreateLayerModal() {
            return LayerManager.showCreateLayerModal();
        }

        // Enhanced toast function
        function showToast(message, type = 'success') {
            return Utils.safeExecute(() => {
                const toast = document.getElementById('toast');
                if (!toast) return;
                
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, CONFIG.TOAST_DURATION);
            }, 'Toast Display');
        }

        // =================================
        // 10. INITIALIZATION & SETUP
        // =================================
        const CBSApp = {
            init() {
                try {
                    // Setup enhanced event management
                    EventManager.setupDebouncedStyleUpdates();
                    EventManager.setupThrottledCoordinateUpdates();
                    
                    // =================================
        // 14. PERFORMANCE OPTIMIZATIONS
        // =================================
        
        // Virtual scrolling for large layer lists
        const VirtualScroll = {
            itemHeight: 40,
            buffer: 5,
            renderVisibleOnly: true,
            
            init(container, items) {
                if (items.length < 50) return; // Only for large lists
                
                const viewport = container.querySelector('.layer-list');
                const scrollableHeight = items.length * this.itemHeight;
                viewport.style.height = scrollableHeight + 'px';
                
                const renderVisibleItems = Utils.throttle(() => {
                    const scrollTop = viewport.scrollTop;
                    const visibleStart = Math.floor(scrollTop / this.itemHeight);
                    const visibleEnd = Math.min(visibleStart + Math.ceil(viewport.clientHeight / this.itemHeight) + this.buffer, items.length);
                    
                    // Render only visible items
                    this.renderItems(viewport, items, visibleStart, visibleEnd);
                }, CONFIG.THROTTLE_DELAY);
                
                viewport.addEventListener('scroll', renderVisibleItems);
                renderVisibleItems();
            },
            
            renderItems(viewport, items, start, end) {
                // Implementation would go here for virtual scrolling
                // This is a placeholder for the concept
            }
        };
        
        // Debounced search and filter
        const LayerSearch = {
            debounceTimer: null,
            
            init() {
                const searchInput = document.getElementById('layerSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', this.debouncedSearch.bind(this));
                }
            },
            
            debouncedSearch: Utils.debounce(function(event) {
                const searchTerm = event.target.value.toLowerCase();
                this.filterLayers(searchTerm);
            }, 300),
            
            filterLayers(searchTerm) {
                const layerItems = document.querySelectorAll('.layer-item, .group-header');
                
                layerItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const shouldShow = searchTerm === '' || text.includes(searchTerm);
                    
                    if (shouldShow) {
                        item.style.display = '';
                        item.classList.remove('hidden-by-search');
                    } else {
                        item.style.display = 'none';
                        item.classList.add('hidden-by-search');
                    }
                });
            }
        };
        
        // Memory management
        const MemoryManager = {
            eventListeners: new Map(),
            timers: new Set(),
            
            addEventListener(element, event, handler, options = {}) {
                element.addEventListener(event, handler, options);
                
                if (!this.eventListeners.has(element)) {
                    this.eventListeners.set(element, []);
                }
                this.eventListeners.get(element).push({ event, handler, options });
            },
            
            removeAllEventListeners(element) {
                const listeners = this.eventListeners.get(element);
                if (listeners) {
                    listeners.forEach(({ event, handler, options }) => {
                        element.removeEventListener(event, handler, options);
                    });
                    this.eventListeners.delete(element);
                }
            },
            
            addTimer(timerId) {
                this.timers.add(timerId);
            },
            
            clearAllTimers() {
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                    clearInterval(timerId);
                });
                this.timers.clear();
            },
            
            cleanup() {
                this.eventListeners.forEach((listeners, element) => {
                    this.removeAllEventListeners(element);
                });
                this.clearAllTimers();
            }
        };
        
        // Geometry simplification for complex geometries
        const GeometryOptimizer = {
            simplifyOnZoomOut: true,
            levelOfDetail: true,
            maxFeatures: 1000,
            
            shouldSimplify(zoomLevel, featureCount) {
                return this.simplifyOnZoomOut && 
                       zoomLevel < 10 && 
                       featureCount > this.maxFeatures;
            },
            
            simplifyGeometry(geometry, tolerance = 0.001) {
                // Placeholder for geometry simplification
                // Would implement Douglas-Peucker or similar algorithm
                return geometry;
            }
        };
        
        // =================================
        // 15. UI ENHANCEMENT FUNCTIONS
        // =================================
        
        // Enhanced drawing functions - SECOND IMPLEMENTATION
        // Enhanced edit mode toggle
        function toggleEditMode() {
            try {
                const editBtn = document.getElementById('editBtn');
                const isActive = editBtn.classList.contains('active');
                
                if (isActive) {
                    // Disable edit mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.edit.handler) {
                        window.drawControl._toolbars.edit._modes.edit.handler.disable();
                    }
                    editBtn.classList.remove('active');
                    showNotification('Düzenleme modu kapatıldı', 'info');
                } else {
                    // Clear other active tools
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Stop any drawing modes
                    if (window.drawControl && window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Enable edit mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.edit.handler) {
                        window.drawControl._toolbars.edit._modes.edit.handler.enable();
                        editBtn.classList.add('active');
                        showNotification('Düzenleme modu aktif - çizimleri sürükleyerek düzenleyin', 'info');
                    } else {
                        throw new Error('Edit handler not found');
                    }
                }
            } catch (error) {
                console.error('Edit mode toggle error:', error);
                showNotification('Düzenleme modu değiştirilemedi', 'error');
            }
        }
        
        // Enhanced delete mode toggle
        function toggleDeleteMode() {
            try {
                const deleteBtn = document.getElementById('deleteBtn');
                const isActive = deleteBtn.classList.contains('active');
                
                if (isActive) {
                    // Disable delete mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.remove.handler) {
                        window.drawControl._toolbars.edit._modes.remove.handler.disable();
                    }
                    deleteBtn.classList.remove('active');
                    showNotification('Silme modu kapatıldı', 'info');
                } else {
                    // Clear other active tools
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Stop any drawing modes
                    if (window.drawControl && window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Enable delete mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.remove.handler) {
                        window.drawControl._toolbars.edit._modes.remove.handler.enable();
                        deleteBtn.classList.add('active');
                        showNotification('Silme modu aktif - çizimlere tıklayarak silin', 'warning');
                    } else {
                        throw new Error('Remove handler not found');
                    }
                }
            } catch (error) {
                console.error('Delete mode toggle error:', error);
                showNotification('Silme modu değiştirilemedi', 'error');
            }
        }
        
        // Zoom to extent function
        function zoomToExtent() {
            if (window.map && window.allLayersGroup) {
                try {
                    const bounds = window.allLayersGroup.getBounds();
                    if (bounds.isValid()) {
                        window.map.fitBounds(bounds, { padding: [20, 20] });
                        showNotification('Tüm katmanlara zoom yapıldı', 'success');
                    } else {
                        showNotification('Zoom yapılacak katman bulunamadı', 'warning');
                    }
                } catch (error) {
                    console.error('Zoom to extent error:', error);
                    showNotification('Zoom işleminde hata oluştu', 'error');
                }
            }
        }
        
        // Fullscreen toggle
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenBtn.classList.add('active');
                    showNotification('Tam ekran modu aktif', 'info');
                }).catch(() => {
                    showNotification('Tam ekran modu desteklenmiyor', 'error');
                });
            } else {
                document.exitFullscreen().then(() => {
                    fullscreenBtn.classList.remove('active');
                    showNotification('Tam ekran modundan çıkıldı', 'info');
                });
            }
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
            const toast = document.getElementById('toast') || createToastElement();
            
            // Set content and style
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            // Auto hide
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function createToastElement() {
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            document.body.appendChild(toast);
            return toast;
        }
        
        // Update selected info panel
        function updateSelectedInfo() {
            const infoPanel = document.getElementById('selectedInfoPanel');
            if (!infoPanel) return;
            
            const selectedLayer = document.querySelector('.layer-item.selected-highlight');
            const selectedGroup = document.querySelector('.group-header.selected');
            
            // Update status bar active layer info
            updateActiveLayerDisplay();
            
            if (selectedLayer || selectedGroup) {
                let infoHtml = '';
                
                if (selectedLayer) {
                    const layerName = selectedLayer.querySelector('.layer-name').textContent;
                    const layerId = selectedLayer.getAttribute('data-layer-id');
                    
                    infoHtml += `
                        <div class="selected-layer-info">
                            <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #a91e2c; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 12px;">📋</span>
                                Seçili Katman: ${layerName} (${layerId})
                                <button onclick="clearLayerSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                            </div>
                        </div>
                    `;
                }
                
                if (selectedGroup) {
                    const groupName = selectedGroup.querySelector('.group-name').textContent;
                    const groupId = selectedGroup.closest('.layer-group').getAttribute('data-group-id');
                    
                    infoHtml += `
                        <div class="selected-group-info">
                            <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #721c24; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 12px;">📁</span>
                                Seçili Grup: ${groupName} (${groupId})
                                <button onclick="clearGroupSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                            </div>
                        </div>
                    `;
                }
                
                infoPanel.innerHTML = infoHtml;
                infoPanel.style.display = 'block';
            } else {
                infoPanel.style.display = 'none';
            }
        }

        // Update active layer display in status bar
        function updateActiveLayerDisplay() {
            const activeLayerInfo = document.getElementById('activeLayerInfo');
            if (!activeLayerInfo) return;
            
            if (window.activeLayerId) {
                const layerElement = document.querySelector(`[data-layer-id="${window.activeLayerId}"]`);
                if (layerElement) {
                    const layerName = layerElement.querySelector('.layer-name')?.textContent || window.activeLayerId;
                    activeLayerInfo.textContent = layerName;
                    activeLayerInfo.style.color = 'var(--success-color)';
                } else {
                    activeLayerInfo.textContent = 'Hatalı Katman';
                    activeLayerInfo.style.color = 'var(--danger-color)';
                }
            } else {
                activeLayerInfo.textContent = 'Seçili Değil';
                activeLayerInfo.style.color = 'var(--text-muted)';
            }
        }

        // Initialize UI enhancements
        function initializeUIEnhancements() {
            // Initialize search
            LayerSearch.init();
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Add accessibility attributes
            addAccessibilityAttributes();
            
            // Add skip link
            addSkipLink();
            
            // Initialize selected info panel
            updateSelectedInfo();
            
            console.log('✅ UI Enhancements initialized');
        }
        
        function handleKeyboardNavigation(event) {
            // ESC key - close modals and cancel drawing
            if (event.key === 'Escape') {
                // Close modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                
                // Cancel measurement tools first (highest priority)
                if (measurementTools && measurementTools.isActive) {
                    console.log('ESC - Ölçüm aracı durduruluyor...');
                    measurementTools.stopMeasurement();
                    showNotification('Ölçüm iptal edildi', 'info');
                    return; // ESC ile ölçüm iptal edildiğinde diğer işlemleri yapma
                }
                
                // Cancel any active drawing/editing modes
                if (window.drawControl) {
                    // Cancel drawing modes
                    if (window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Cancel editing modes
                    if (window.drawControl._toolbars.edit) {
                        Object.values(window.drawControl._toolbars.edit._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                }
                
                // Clear active tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                showNotification('İşlem iptal edildi', 'info');
            }
            
            // Enter key on focused elements
            if (event.key === 'Enter') {
                const focused = document.activeElement;
                if (focused.classList.contains('layer-item') || focused.classList.contains('group-header')) {
                    focused.click();
                }
            }
        }
        
        function addAccessibilityAttributes() {
            // Add ARIA labels and roles
            const layerPanel = document.querySelector('.layer-panel');
            if (layerPanel) {
                layerPanel.setAttribute('role', 'navigation');
                layerPanel.setAttribute('aria-label', 'Katman yönetimi paneli');
            }
            
            const toolContainer = document.querySelector('.map-tools-container');
            if (toolContainer) {
                toolContainer.setAttribute('role', 'toolbar');
                toolContainer.setAttribute('aria-label', 'Harita araçları');
            }
            
            // Make tool buttons focusable
            document.querySelectorAll('.tool-btn').forEach((btn, index) => {
                btn.setAttribute('tabindex', '0');
                btn.setAttribute('role', 'button');
            });
            
            // Make layer items focusable
            document.querySelectorAll('.layer-item, .group-header').forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'treeitem');
            });
        }
        
        function addSkipLink() {
            const skipLink = document.createElement('a');
            skipLink.href = '#map';
            skipLink.className = 'skip-link';
            skipLink.textContent = 'Haritaya atla';
            document.body.insertBefore(skipLink, document.body.firstChild);
        }
        
        // Window cleanup
        window.addEventListener('beforeunload', () => {
            MemoryManager.cleanup();
        });
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initializeUIEnhancements();
        });
        
        console.log('✅ CBS System enhanced with modern JavaScript patterns and UI improvements v3.0');
                } catch (error) {
                    ErrorManager.handle(error, 'System Enhancement');
                }
            }
        };

        // Initialize enhanced features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                CBSApp.init();
            }, 1000); // Wait for original initialization
        });

        // Enhanced global functions for backwards compatibility
        window.LayerManager = LayerManager;
        window.StyleManager = StyleManager;
        window.EventManager = EventManager;
        window.Utils = Utils;
        window.ErrorManager = ErrorManager;
        window.AppState = AppState;
        window.CBSApp = CBSApp;

        // Continue with original code below...
        
        // Modal'ı kapat
        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createNameInput').value = '';
        }
        
        // Oluşturma işlemini onayla
        function confirmCreate() {
            const name = document.getElementById('createNameInput').value.trim();
            const type = document.getElementById('createModal').dataset.type;
            
            if (!name) {
                showToast('Ad boş bırakılamaz!', 'error');
                return;
            }
            
            if (type === 'group') {
                createGroup(name);
            } else if (type === 'layer') {
                const targetGroupId = document.getElementById('targetGroupSelect').value;
                createLayer(name, targetGroupId);
            }
            
            closeCreateModal();
        }
        
        // Grup oluştur (yeni modal ile)
        function createGroup(groupName) {
            // Input validation
            const validation = validateName(groupName);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                return;
            }

            const safeName = validation.sanitized;

            // Grup oluştur
            const groupContainer = document.querySelector('#layerList');

            const layerGroup = document.createElement('div');
            layerGroup.className = 'layer-group';

            const groupId = 'group-' + Date.now();
            layerGroup.setAttribute('data-group-id', groupId);

            layerGroup.innerHTML = `
                <div class="group-header">
                    <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                        <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                    </div>
                    <div class="group-select-area" onclick="selectGroup(this)">
                        <span class="group-name">${safeName}</span>
                        <span class="group-count">0</span>
                    </div>
                    <div class="group-toggle-area" onclick="toggleGroup(this)">
                        <span class="group-icon">▼</span>
                    </div>
                </div>
                <div class="group-items">
                    <!-- Katmanlar buraya eklenecek -->
                </div>
            `;

            groupContainer.appendChild(layerGroup);

            // Yeni oluşturulan grubu seç
            selectGroup(layerGroup.querySelector('.group-select-area'));

            // Toast bildirimi göster
            showToast(`"${safeName}" grubu oluşturuldu`, 'success');
        }
        
        // Grup seçme (sadece seçim, açma/kapama değil)
        function selectGroup(selectArea) {
            // event.stopPropagation(); // Checkbox tıklamasını engelle
            
            // Tüm grup seçimlerini kaldır
            document.querySelectorAll('.group-header').forEach(h => {
                h.classList.remove('selected');
            });
            
            // Katman seçimini kaldır
            clearLayerSelection();
            
            // Bu grubu seç
            const header = selectArea.closest('.group-header');
            header.classList.add('selected');
            
            // Aktif grup ID'sini güncelle
            activeGroupId = header.closest('.layer-group').getAttribute('data-group-id');
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }
        
        // Seçili grup bilgisini güncelle - kaldırıldı
        
        // Grup seçimini temizle
        function clearGroupSelection() {
            // Çizim modundayken grup seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, grup seçimi korunuyor - clearGroupSelection iptal edildi');
                return;
            }
            
            console.log('clearGroupSelection çalışıyor');
            // Tüm grup seçimlerini kaldır
            document.querySelectorAll('.group-header').forEach(h => {
                h.classList.remove('selected');
            });
            
            // Aktif grubu temizle
            activeGroupId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }
        
        // Katman oluştur (yeni modal ile)
        function createLayer(layerName, targetGroupId) {
            // Input validation
            const validation = validateName(layerName);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                return;
            }

            const safeName = validation.sanitized;

            // Katmanı ekleyeceğimiz grubu belirle
            let targetGroup = null;

            // Modal'dan gelen targetGroupId'yi kullan
            if (targetGroupId) {
                targetGroup = document.querySelector(`[data-group-id="${targetGroupId}"]`);
            }

            // Hedef grup bulunamazsa hata ver
            if (!targetGroup) {
                showToast('Hedef grup bulunamadı!', 'error');
                return;
            }

            // Katman oluştur
            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            layerItem.draggable = true;

            // Katman ID'si oluştur
            const layerId = 'layer-' + Date.now();
            layerItem.setAttribute('data-layer-id', layerId);

            // Katman içeriğini oluştur
            layerItem.innerHTML = `
                <input type="checkbox" class="layer-visibility" checked>
                <div class="layer-selectable-area">
                    <div class="layer-icons">
                        <div class="layer-icon inactive" title="Nokta verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="8"/>
                            </svg>
                        </div>
                        <div class="layer-icon inactive" title="Çizgi verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M2 8 L8 8 L12 16 L16 16 L22 8" fill="none" stroke="currentColor" stroke-width="3"/>
                            </svg>
                        </div>
                        <div class="layer-icon inactive" title="Poligon verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor" stroke="#000000" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <span class="layer-name">${safeName}</span>
                    <span class="layer-style-mode-indicator default-mode" data-layer-id="${layerId}" title="Varsayılan Kurumsal Ayarlar" onclick="toggleLayerStyleMode('${layerId}', event)">
                        🏢
                    </span>
                </div>
                <div class="layer-actions">
                    <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13,7H11V5H13M13,17H11V9H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Katmanı gruba ekle
            const groupItems = targetGroup.querySelector('.group-items');
            groupItems.appendChild(layerItem);
            
            // Grup sayısını güncelle
            updateGroupLayerCount(targetGroup);
            
            // Drag and drop işlevselliğini ekle (sadece düzenleme modundaysa)
            setupDragAndDrop(layerItem);
            

            
            // Katman seçme işlemini ekle - event delegation ile hallediliyor artık
            
            // Bu katmana ait çizim listesini oluştur
            layerFeatures[layerId] = [];
            
            // Yeni oluşturulan katmanı seç
            selectLayer(layerItem);
            
            // Toast bildirimi göster
            showToast(`"${layerName}" katmanı oluşturuldu`, 'success');
        }
        
        // Katman seçme
        function selectLayer(layerItem) {
            console.log('selectLayer çağrıldı:', layerItem);
            
            // Tüm seçimleri kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Bu katmanı seç (hem görsel hem de mantıksal seçim için)
            layerItem.classList.add('selected-highlight', 'selected');
            
            // Aktif katmanı güncelle
            activeLayerId = layerItem.getAttribute('data-layer-id');
            window.activeLayerId = activeLayerId; // Global erişim için güncelle
            console.log(`Katman seçildi: ${activeLayerId}`);
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
            
            // Katmanın grubunu da otomatik seç
            const parentGroup = layerItem.closest('.layer-group');
            if (parentGroup) {
                // Tüm grup seçimlerini kaldır
                document.querySelectorAll('.group-header').forEach(h => {
                    h.classList.remove('selected');
                });
                
                // Bu grubu seç
                const groupHeader = parentGroup.querySelector('.group-header');
                groupHeader.classList.add('selected');
                activeGroupId = parentGroup.getAttribute('data-group-id');
                console.log(`Grup da seçildi: ${activeGroupId}`);
            }
        }
        
        // Katman seçimini temizle
        function clearLayerSelection() {
            // Çizim modundayken katman seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, katman seçimi korunuyor - clearLayerSelection iptal edildi');
                return;
            }
            
            console.log('clearLayerSelection çalışıyor');
            // Tüm seçimleri kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Aktif katmanı temizle
            activeLayerId = null;
            window.activeLayerId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }

        // Aktif katmanı al
        function getActiveLayer() {
            if (!activeLayerId) {
                console.log('getActiveLayer: activeLayerId yok');
                return null;
            }
            
            const layerElement = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
            if (!layerElement) {
                console.log('getActiveLayer: katman elementi bulunamadı:', activeLayerId);
                return null;
            }
            
            // Katmanın seçili olup olmadığını kontrol et
            const isSelected = layerElement.classList.contains('selected-highlight');
            console.log('getActiveLayer:', {
                layerId: activeLayerId,
                element: layerElement,
                isSelected: isSelected
            });
            
            return isSelected ? layerElement : null;
        }
        

        
        // Grup katman sayısını güncelle
        function updateGroupLayerCount(groupElement) {
            const groupItems = groupElement.querySelector('.group-items');
            const count = groupItems.querySelectorAll('.layer-item').length;
            const countElement = groupElement.querySelector('.group-count');
            countElement.textContent = count;
            
            // Grup görünürlük butonunu da güncelle
            updateGroupVisibilityButton(groupElement);
        }
        
        // Tüm grup sayılarını güncelle
        function updateAllGroupCounts() {
            document.querySelectorAll('.layer-group').forEach(group => {
                updateGroupLayerCount(group);
            });
        }
        
        // Tüm grup görünürlük butonlarını güncelle
        function updateAllGroupVisibilityButtons() {
            document.querySelectorAll('.layer-group').forEach(group => {
                updateGroupVisibilityButton(group);
            });
        }
        
        // Tek grup görünürlük checkbox'ını güncelle
        function updateGroupVisibilityButton(group) {
            const layerCheckboxes = group.querySelectorAll('.layer-visibility');
            const visibilityCheckbox = group.querySelector('.group-visibility-checkbox');
            
            if (visibilityCheckbox && layerCheckboxes.length > 0) {
                const anyVisible = Array.from(layerCheckboxes).some(cb => cb.checked);
                visibilityCheckbox.checked = anyVisible;
            }
        }
        
        // Katman detaylarını açma
        function openLayerDetails(button) {
            console.log('openLayerDetails fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem.getAttribute('data-layer-id');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            // Modal başlığını güncelle
            document.getElementById('layerDetailName').textContent = layerName;
            
            // Çizim listesini temizle
            const featuresContainer = document.getElementById('featuresContainer');
            featuresContainer.innerHTML = '';
            
            // Katmana ait çizimleri liste
            if (layerFeatures[layerId] && layerFeatures[layerId].length > 0) {
                layerFeatures[layerId].forEach((feature, index) => {
                    const featureRow = document.createElement('div');
                    featureRow.className = 'feature-row';
                    featureRow.setAttribute('data-feature-id', feature.id);
                    
                    let iconType = '';
                    let featureTypeName = '';
                    
                    if (feature.type === 'point') {
                        iconType = 'icon-point';
                        featureTypeName = 'Nokta';
                    } else if (feature.type === 'line') {
                        iconType = 'icon-line';
                        featureTypeName = 'Çizgi';
                    } else if (feature.type === 'polygon') {
                        iconType = 'icon-polygon';
                        featureTypeName = 'Poligon';
                    }
                    
                    featureRow.innerHTML = `
                        <div class="feature-icon layer-icon ${iconType}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                ${feature.type === 'point' ? '<circle cx="12" cy="12" r="6"/>' : 
                                  feature.type === 'line' ? '<path d="M2 8L8 8L12 16L16 16L22 8" fill="none" stroke="currentColor" stroke-width="2"/>' : 
                                  '<polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor"/>'}
                            </svg>
                        </div>
                        <div class="feature-name">${featureTypeName} ${index + 1}</div>
                        <div class="feature-actions">
                            <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('${feature.type}', '${feature.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                </svg>
                            </button>
                            <button class="layer-action-btn" title="Zoom" onclick="zoomToFeature('${feature.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                </svg>
                            </button>
                            <button class="layer-action-btn" title="Sil" onclick="deleteFeature('${feature.id}', '${layerId}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    featuresContainer.appendChild(featureRow);
                });
            } else {
                featuresContainer.innerHTML = '<p>Bu katmanda henüz çizim bulunmuyor.</p>';
            }
            
            // Modal'ı açılan katmanı belirle
            const modal = document.getElementById('layerDetailsModal');
            modal.setAttribute('data-layer-id', layerId);
            
            // Modal'ı aç
            modal.style.display = 'block';
        }
        
        // Katman detayları modal'ını kapatma
        function closeLayerDetailsModal() {
            document.getElementById('layerDetailsModal').style.display = 'none';
        }
        
        // Yeni bir çizim ekle
        function addFeatureToLayer() {
            const modal = document.getElementById('layerDetailsModal');
            const layerId = modal.getAttribute('data-layer-id');
            
            // Modal'ı kapat
            closeLayerDetailsModal();
            
            // Bu katmanı aktif yap
            activeLayerId = layerId;
            
            // Katmanı vurgula
            const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
            selectLayer(layerItem);
        }
        
        // Çizimi aktif katmana ekle
        function addFeatureToActiveLayer(type, layer, typeName) {
            console.log(`addFeatureToActiveLayer çağrıldı: type=${type}, mevcut activeLayerId=${activeLayerId}`);
            
            // TypeName fallback
            if (!typeName) {
                const typeNames = {
                    'marker': 'Nokta',
                    'polyline': 'Çizgi', 
                    'polygon': 'Poligon',
                    'rectangle': 'Dikdörtgen',
                    'circle': 'Daire'
                };
                typeName = typeNames[type] || type;
            }
            
            // Çizim sırasında kaydedilen aktif katman ID'sini kullan
            if (window.drawingActiveLayerId) {
                activeLayerId = window.drawingActiveLayerId;
                console.log(`Çizim için kaydedilen aktif katman kullanılıyor: ${activeLayerId}`);
                
                // Kaydedilen ID'yi temizle
                delete window.drawingActiveLayerId;
            }
            
            // Eğer hala aktif katman yoksa veya seçili katman görsel olarak seçili değilse
            if (!activeLayerId || !document.querySelector('.layer-item.selected-highlight')) {
                console.log('Aktif katman yok veya seçim kaybedilmiş, son seçili katmanı geri yüklüyor...');
                
                // Önce son seçili katmanı bulmaya çalış
                const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                if (selectedLayer) {
                    activeLayerId = selectedLayer.getAttribute('data-layer-id');
                    console.log(`Seçili katman bulundu: ${activeLayerId}`);
                } else {
                    // Hiç seçili katman yoksa ilk katmanı seç
                    const firstLayer = document.querySelector('.layer-item[data-layer-id]');
                    if (firstLayer) {
                        selectLayer(firstLayer);
                        console.log(`İlk katman seçildi: ${activeLayerId}`);
                    } else {
                        // Hiç katman yoksa yeni bir katman oluştur
                        console.log('Hiç katman yok, yeni katman oluşturuluyor...');
                        createLayer('Yeni Katman', 'group-1');
                        const newLayer = document.querySelector('.layer-item[data-layer-id]:last-child');
                        if (newLayer) {
                            selectLayer(newLayer);
                            console.log(`Yeni katman oluşturuldu ve seçildi: ${activeLayerId}`);
                        }
                    }
                }
            }
            
            if (!layerFeatures[activeLayerId]) {
                layerFeatures[activeLayerId] = [];
            }
            
            console.log(`Çizim aktif katmana ekleniyor: type=${type}, katman=${activeLayerId}`);
            
            let iconType;
            
            // Katman tipine göre ayarlar - dikdörtgen ve daire de poligon olarak işle
            if (type === 'marker') {
                iconType = 'point';
            } else if (type === 'polyline') {
                iconType = 'line';
            } else if (type === 'polygon' || type === 'rectangle' || type === 'circle') {
                iconType = 'polygon';
            }
            
            // Çizim için benzersiz ID oluştur
            const featureId = 'feature-' + Date.now();
            
            // Çizimi katmana ekle
            layerFeatures[activeLayerId].push({
                id: featureId,
                type: iconType,
                layer: layer
            });
            
            // Çizimi referans listesine ekle
            drawnLayers.push({
                id: featureId,
                layer: layer,
                type: iconType,
                layerId: activeLayerId
            });
            
            console.log(`Çizim eklendi: id=${featureId}, type=${iconType}, katman=${activeLayerId}`);
            
            // Katman ikonlarını güncelle
            updateLayerIcons(activeLayerId);
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
            
            // Başarı mesajı göster
            const layerName = document.querySelector(`[data-layer-id="${activeLayerId}"] .layer-name`).textContent;
            showToast(`${typeName} "${layerName}" katmanına başarıyla eklendi`, 'success');
            
            // Yeni çizim eklendiğinde stil modu göstergesini güncelle (custom moda geç)
            updateLayerStyleModeIndicator(activeLayerId, 'custom');
            
            return featureId; // Oluşturulan ID'yi döndür
        }
        
        // Katman ikonlarını güncelle
        function updateLayerIcons(layerId) {
            const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
            if (!layerItem) return;
            
            const features = layerFeatures[layerId] || [];
            
            // Her bir ikon tipini kontrol et
            const hasPoint = features.some(f => f.type === 'point');
            const hasLine = features.some(f => f.type === 'line');
            const hasPolygon = features.some(f => f.type === 'polygon');
            
            // İkonları güncelle
            const pointIcon = layerItem.querySelector('.layer-icon:nth-child(1)');
            const lineIcon = layerItem.querySelector('.layer-icon:nth-child(2)');
            const polygonIcon = layerItem.querySelector('.layer-icon:nth-child(3)');
            
            if (hasPoint) {
                pointIcon.classList.remove('inactive');
                pointIcon.classList.add('active', 'icon-point');
            } else {
                pointIcon.classList.remove('active', 'icon-point');
                pointIcon.classList.add('inactive');
            }
            
            if (hasLine) {
                lineIcon.classList.remove('inactive');
                lineIcon.classList.add('active', 'icon-line');
            } else {
                lineIcon.classList.remove('active', 'icon-line');
                lineIcon.classList.add('inactive');
            }
            
            if (hasPolygon) {
                polygonIcon.classList.remove('inactive');
                polygonIcon.classList.add('active', 'icon-polygon');
            } else {
                polygonIcon.classList.remove('active', 'icon-polygon');
                polygonIcon.classList.add('inactive');
            }
        }
        
        // Çizimi silme
        function deleteFeature(featureId, layerId) {
            if (confirm('Bu çizimi silmek istediğinizden emin misiniz?')) {
                // Çizimi referans listesinden bul ve sil
                const featureIndex = drawnLayers.findIndex(l => l.id === featureId);
                if (featureIndex !== -1) {
                    // Haritadan kaldır
                    drawnItems.removeLayer(drawnLayers[featureIndex].layer);
                    // Listeden kaldır
                    drawnLayers.splice(featureIndex, 1);
                }
                
                // Katmandan kaldır
                if (layerFeatures[layerId]) {
                    layerFeatures[layerId] = layerFeatures[layerId].filter(f => f.id !== featureId);
                    
                    // Katman ikonlarını güncelle
                    updateLayerIcons(layerId);
                    
                    // Lejant açıksa güncelle
                    if (legendVisible) {
                        updateLegendContent();
                    }
                }
                
                // Detay modalını güncelle
                openLayerDetails(document.querySelector(`[data-layer-id="${layerId}"]`).querySelector('.layer-action-btn[title="Ayarlar"]'));
            }
        }
        
        // Çizime zoom yap
        function zoomToFeature(featureId) {
            const layerInfo = drawnLayers.find(l => l.id === featureId);
            if (layerInfo) {
                const layer = layerInfo.layer;
                // Poligon veya çizgi ise sınırlarına zoom
                if (layer.getBounds) {
                    map.fitBounds(layer.getBounds());
                } 
                // Nokta ise konumuna zoom
                else if (layer.getLatLng) {
                    map.setView(layer.getLatLng(), 15);
                }
            }
        }
        
        // Katmana zoom yap - tüm çizimlere birden
        function zoomToLayer(button) {
            console.log('zoomToLayer fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem.getAttribute('data-layer-id');
            
            if (!layerFeatures[layerId] || layerFeatures[layerId].length === 0) {
                return;
            }
            
            // Tüm çizimleri içeren sınırları hesapla
            const bounds = L.latLngBounds([]);
            
            layerFeatures[layerId].forEach(feature => {
                const layer = feature.layer;
                
                if (layer.getBounds) {
                    // Poligon veya çizgi
                    bounds.extend(layer.getBounds());
                } else if (layer.getLatLng) {
                    // Nokta
                    bounds.extend(layer.getLatLng());
                }
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds);
            } else {
                console.log('Zoom yapılacak geçerli sınır bulunamadı');
            }
        }
        
        // Katman görünürlüğü değiştirme
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('layer-visibility')) {
                const layerItem = e.target.closest('.layer-item');
                const layerId = layerItem.getAttribute('data-layer-id');
                const isVisible = e.target.checked;
                
                toggleLayerFeatures(layerId, isVisible);
                
                // Grup görünürlük butonunu güncelle
                const group = layerItem.closest('.layer-group');
                updateGroupVisibilityButton(group);
            }
        });
        
        // Katman içindeki çizimlerin görünürlüğünü ayarla
        function toggleLayerFeatures(layerId, isVisible) {
            if (!layerFeatures[layerId]) return;
            
            layerFeatures[layerId].forEach(feature => {
                // Çizim referansını bul
                const layerInfo = drawnLayers.find(l => l.id === feature.id);
                if (layerInfo) {
                    if (isVisible) {
                        if (!map.hasLayer(layerInfo.layer)) {
                            drawnItems.addLayer(layerInfo.layer);
                        }
                    } else {
                        if (map.hasLayer(layerInfo.layer)) {
                            drawnItems.removeLayer(layerInfo.layer);
                        }
                    }
                }
            });
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
        }
        
        // Grup içindeki tüm katmanları toplu aç/kapat
        function toggleAllLayersInGroup(event, checkbox) {
            event.stopPropagation();
            
            const group = checkbox.closest('.layer-group');
            const items = group.querySelector('.group-items');
            const layerCheckboxes = items.querySelectorAll('.layer-visibility');
            
            // Checkbox'ın durumunu kullan
            const newVisibility = checkbox.checked;
            
            layerCheckboxes.forEach(cb => {
                cb.checked = newVisibility;
                // Katman ID'sini al
                const layerId = cb.closest('.layer-item').getAttribute('data-layer-id');
                // Katman içeriğinin görünürlüğünü ayarla
                toggleLayerFeatures(layerId, newVisibility);
            });
            
            // Toast mesajı
            const groupName = group.querySelector('.group-name').textContent;
            const action = newVisibility ? 'açıldı' : 'kapatıldı';
            showToast(`"${groupName}" grubundaki tüm katmanlar ${action}`, 'success');
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
        }
        
        // Çizim katmanlarını sakla (orijinal açık kalsın)
        var originalAddNewLayerToGroup = addNewLayerToGroup;
        // Bu fonksiyonun tanımını kaldır, artık kullanmıyoruz
        function addNewLayerToGroup() {}

        // Bu fonksiyon artık kullanılmıyor - createNewLayer() kullanılıyor

        // Grup açma/kapama (sadece açma/kapama)
        function toggleGroup(toggleArea) {
            const header = toggleArea.closest('.group-header');
            const icon = toggleArea.querySelector('.group-icon');
            const items = header.nextElementSibling;
            
            if (items.classList.contains('collapsed')) {
                items.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                items.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            }
        }
        
        // Tüm grupları aç
        function expandAllGroups() {
            document.querySelectorAll('.layer-group').forEach(group => {
                const items = group.querySelector('.group-items');
                const icon = group.querySelector('.group-icon');
                
                items.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            });
            showToast('Tüm gruplar açıldı', 'success');
        }
        
        // Tüm grupları kapat
        function collapseAllGroups() {
            document.querySelectorAll('.layer-group').forEach(group => {
                const items = group.querySelector('.group-items');
                const icon = group.querySelector('.group-icon');
                
                items.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            });
            showToast('Tüm gruplar kapatıldı', 'success');
        }

        // Sorgu modalı açma
        function openQueryModal(button) {
            console.log('openQueryModal fonksiyonu çağrıldı', button);
            const modal = document.getElementById('queryModal');
            const layerItem = button.closest('.layer-item');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            modal.dataset.layerName = layerName;
            modal.style.display = 'block';
        }

        // Sorgu modalı kapama
        function closeQueryModal() {
            const modal = document.getElementById('queryModal');
            modal.style.display = 'none';
        }

        // Sorgu tab değiştirme
        function switchQueryTab(tabName) {
            const tabs = document.querySelectorAll('#queryModal .style-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('basicQueryContent').style.display = tabName === 'basic' ? 'block' : 'none';
            document.getElementById('advancedQueryContent').style.display = tabName === 'advanced' ? 'block' : 'none';
        }

        // Sorgu uygulama
        function applyQuery() {
            const modal = document.getElementById('queryModal');
            const layerName = modal.dataset.layerName;
            const activeTab = document.querySelector('#queryModal .style-tab.active').textContent;
            
            if (activeTab === 'Temel') {
                const field = document.getElementById('queryField').value;
                const operator = document.getElementById('queryOperator').value;
                const value = document.getElementById('queryValue').value;
                
                console.log(`Temel sorgu: ${field} ${operator} ${value}`);
            } else {
                const sqlQuery = document.getElementById('sqlQuery').value;
                console.log(`SQL sorgu: ${sqlQuery}`);
            }
            
            closeQueryModal();
        }

        // Tab değiştirme
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.style-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('styleContent').style.display = tabName === 'style' ? 'block' : 'none';
            document.getElementById('labelContent').style.display = tabName === 'label' ? 'block' : 'none';
            document.getElementById('themeContent').style.display = tabName === 'theme' ? 'block' : 'none';
        }

        // RGB'den HEX'e dönüşüm fonksiyonu
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            
            const result = rgb.match(/\d+/g);
            if (!result) return '#000000';
            
            const r = parseInt(result[0]);
            const g = parseInt(result[1]);
            const b = parseInt(result[2]);
            
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // HEX'den RGBA'ya dönüşüm fonksiyonu
        function hexToRgba(hex, opacity) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return `rgba(0, 0, 0, ${opacity})`;
            
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        
        // Modal dışına tıklama kontrolü
        window.onclick = function(event) {
            const styleModal = document.getElementById('styleModal');
            const queryModal = document.getElementById('queryModal');
            
            if (event.target == styleModal) {
                styleModal.style.display = 'none';
            }
            if (event.target == queryModal) {
                queryModal.style.display = 'none';
            }
        }

        // Katman özellikleri gösterme
        function showLayerProperties(button) {
            console.log('Katman özellikleri gösteriliyor');
        }

        // Stil modalı kapama
        function closeStyleModal() {
            const modal = document.getElementById('styleModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Modal'ı gizle
            modal.style.display = 'none';
            
            // Modal pozisyonunu sıfırla (sürükleme sonrası eski konumuna dönmesi için)
            if (modalContent) {
                modalContent.style.transform = 'translate(-50%, -50%)';
            }
            
            // Pending timeout'ları temizle
            if (window.styleUpdateTimeout) {
                clearTimeout(window.styleUpdateTimeout);
                window.styleUpdateTimeout = null;
            }
            if (window.labelUpdateTimeout) {
                clearTimeout(window.labelUpdateTimeout);
                window.labelUpdateTimeout = null;
            }
        }

        // Katman silme - normal katmanlar için
        function deleteLayer(button) {
            console.log('deleteLayer fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            if (confirm(`"${layerName}" katmanını silmek istediğinizden emin misiniz?`)) {
                const layerId = layerItem.getAttribute('data-layer-id');
                
                // Eğer seçili katman siliniyorsa seçimi temizle
                if (activeLayerId === layerId) {
                    clearLayerSelection();
                }
                
                // Katmanı DOM'dan kaldır
                layerItem.remove();
                
                // Katmana ait çizimleri temizle
                if (layerFeatures[layerId]) {
                    layerFeatures[layerId].forEach(feature => {
                        const layerInfo = drawnLayers.find(l => l.id === feature.id);
                        if (layerInfo) {
                            drawnItems.removeLayer(layerInfo.layer);
                        }
                    });
                    delete layerFeatures[layerId];
                }
                
                // Çizim listesinden kaldır
                drawnLayers = drawnLayers.filter(l => l.layerId !== layerId);
                
                // Grup sayısını güncelle
                const group = button.closest('.layer-group');
                updateGroupLayerCount(group);
                
                // Toast bildirimi göster
                showToast(`"${layerName}" katmanı silindi`, 'success');
            }
        }

        // Range input değer güncellemeleri
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', function() {
                const valueDisplay = this.nextElementSibling;
                if (valueDisplay && valueDisplay.classList.contains('value-display')) {
                    let value = this.value;
                    if (this.id.includes('Opacity')) {
                        value += '%';
                    } else {
                        value += 'px';
                    }
                    valueDisplay.textContent = value;
                }
            });
        });

        // Yeni katman için drag and drop işlevselliği
        function setupDragAndDrop(item) {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                // Tüm grup sayılarını güncelle (katman taşındıktan sonra)
                updateAllGroupCounts();
                draggedItem = null;
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedItem !== this) {
                    this.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedItem !== this) {
                    const parent = this.parentNode;
                    const dropIndex = Array.from(parent.children).indexOf(this);
                    const dragIndex = Array.from(parent.children).indexOf(draggedItem);
                    
                    if (dragIndex < dropIndex) {
                        this.after(draggedItem);
                    } else {
                        this.before(draggedItem);
                    }
                    
                    // Taşıma işlemi sonrası grup sayılarını güncelle
                    updateAllGroupCounts();
                }
            });
        }

        // Drag and Drop işlemleri - mevcut katmanlar için
        let draggedItem = null;

        document.querySelectorAll('.layer-item').forEach(item => {
            setupDragAndDrop(item);
        });

        // Stil modalı açma - layerId parametresi ekledik
        function openStyleModal(type, featureId) {
            const modal = document.getElementById('styleModal');
            
            // Tab'ı sıfırla
            switchTab('style');
            
            // Stil bölümlerini her zaman göster
            document.getElementById('pointStyle').style.display = 'block';
            document.getElementById('lineStyle').style.display = 'block';
            document.getElementById('polygonStyle').style.display = 'block';
            
            // Daha önce seçilen stil modunu yükle
            let layerId = featureId;
            
            // Eğer featureId yoksa, event target'dan veya aktif katmandan al
            if (!layerId && event && event.target) {
                const layerItem = event.target.closest('.layer-item');
                if (layerItem) {
                    layerId = layerItem.getAttribute('data-layer-id');
                }
            }
            
            // Son çare olarak aktif katmanı kullan
            if (!layerId) {
                layerId = activeLayerId;
            }
            
            console.log('OpenStyleModal - Belirlenen layerId:', layerId);
            
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            const savedMode = savedStyleModes[layerId] || 'custom';
            
            console.log('OpenStyleModal - Kayıtlı mod:', savedMode);
            
            // Stil modunu kayıtlı değere ayarla
            document.getElementById('styleMode').value = savedMode;
            
            // Kayıtlı modu başlat
            handleStyleModeChange(savedMode);
            
            // Etiket event listener'larını başlat
            initLabelEventListeners();
            
            // Anında güncelleme event listener'larını başlat
            initRealTimeStyleUpdates();
            
            // Kullanıcıya anında güncelleme özelliği hakkında bilgi ver
            setTimeout(() => {
                showToast('💡 Stil değişiklikleri anında haritaya yansıtılacak', 'info');
            }, 300);
            
            // Katman türüne göre başlığı ayarla
            let title = 'Stil Ayarları';
            if (type === 'point') title = 'Nokta Stil Ayarları';
            else if (type === 'line') title = 'Çizgi Stil Ayarları';
            else if (type === 'polygon') title = 'Poligon Stil Ayarları';
            else if (type === 'landuse') title = 'Arazi Kullanım Stil Ayarları';
            
            document.querySelector('#styleModal .modal-header h3').textContent = title;
            
            // Tip ve diğer verileri temizle (önceki değerlerden etkilenmemesi için)
            modal.dataset.layerType = '';
            modal.dataset.layerId = '';
            modal.dataset.layerName = '';
            
            console.log(`Stil modal açılıyor: type=${type}, featureId=${featureId}`);
            
            // Stil modal'ına veri kaydet
            if (type) {
                modal.dataset.layerType = type;
            }
            
            // LayerId'yi modal'a kaydet
            modal.dataset.layerId = layerId;
            
            console.log('Modal layerId ayarlandı:', layerId);
            
            // Layer name'i de kaydet (varsa)
            if (layerId && !featureId) {
                const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
                if (layerItem) {
                    const layerName = layerItem.querySelector('.layer-name')?.textContent || '';
                    modal.dataset.layerName = layerName;
                    console.log(`Katman için stil modal açıldı: ${layerId} (${layerName})`);
                }
            } else if (featureId) {
                console.log(`Çizim için stil modal açıldı: ${featureId}`);
            }
            
            console.log('Modal dataset değerleri:', {
                layerId: modal.dataset.layerId,
                layerType: modal.dataset.layerType,
                layerName: modal.dataset.layerName
            });
            
            // Mevcut stilleri yükle
            loadCurrentStyles(type, featureId);
            
            // Modal'ı aç
            modal.style.display = 'block';
        }
        
        // Mevcut stilleri yükle
        function loadCurrentStyles(type, featureId) {
            // Stil modalı açıldığında stillerle ilgili işlemler yapalım
            const modal = document.getElementById('styleModal');
            
            // Seçili modu kontrol et
            const selectedMode = document.getElementById('styleMode').value;
            
            if (selectedMode === 'default') {
                // Varsayılan mod: sistem varsayılanlarını yükle
                resetDefaultStyles();
                return;
            } else if (selectedMode === 'custom') {
                // Kullanıcı özel mod: önce varsayılanları yükle, sonra özel ayarları
                resetDefaultStyles();
                
                // Eğer kayıtlı kullanıcı özel ayarları varsa yükle
                const savedUserStyles = JSON.parse(localStorage.getItem('userCustomStyles') || '{}');
                if (Object.keys(savedUserStyles).length > 0) {
                    loadUserCustomValues();
                    return;
                }
            }
            
            // Kayıtlı stilleri localStorage'dan yükle (eski sistem için backward compatibility)
            const savedStyles = JSON.parse(localStorage.getItem('mapStyles') || '{}');
            let styles = null;
            
            // Eğer featureId varsa, ilgili çizimin stilini yükle
            if (featureId) {
                const layerInfo = drawnLayers.find(l => l.id === featureId);
                if (layerInfo && layerInfo.layer && layerInfo.layer.options && layerInfo.layer.options.styleInfo) {
                    const styleInfo = layerInfo.layer.options.styleInfo;
                    
                    if (type === 'point' && styleInfo.type === 'point') {
                        document.getElementById('pointColor').value = styleInfo.color || "#ff0000";
                        document.getElementById('pointSize').value = styleInfo.size || 8;
                        document.getElementById('pointShape').value = styleInfo.shape || "circle";
                    }
                    else if (type === 'line' && styleInfo.type === 'line') {
                        document.getElementById('lineColor').value = styleInfo.color || "#ff7800";
                        document.getElementById('lineWidth').value = styleInfo.width || 3;
                        document.getElementById('lineType').value = styleInfo.lineType || "solid";
                    }
                    else if (type === 'polygon' && styleInfo.type === 'polygon') {
                        document.getElementById('fillColor').value = styleInfo.fillColor || "#3388ff";
                        document.getElementById('fillOpacity').value = parseInt((styleInfo.fillOpacity || 0.5) * 100);
                        document.getElementById('strokeColor').value = styleInfo.strokeColor || "#000000";
                        document.getElementById('strokeWidth').value = styleInfo.strokeWidth || 1;
                        document.getElementById('strokeType').value = styleInfo.strokeType || "solid";
                    }
                } else if (layerInfo && layerInfo.layer && layerInfo.layer.options) {
                    // Doğrudan katman özelliklerinden stil al
                    if (type === 'line') {
                        document.getElementById('lineColor').value = layerInfo.layer.options.color || '#ff7800';
                        document.getElementById('lineWidth').value = layerInfo.layer.options.weight || 3;
                        
                        const lineType = detectLineTypeFromDashArray(layerInfo.layer.options.dashArray);
                        document.getElementById('lineType').value = lineType;
                    }
                    else if (type === 'polygon') {
                        document.getElementById('fillColor').value = layerInfo.layer.options.fillColor || '#3388ff';
                        document.getElementById('fillOpacity').value = parseInt((layerInfo.layer.options.fillOpacity || 0.5) * 100);
                        document.getElementById('strokeColor').value = layerInfo.layer.options.color || '#000000';
                        document.getElementById('strokeWidth').value = layerInfo.layer.options.weight || 1;
                        
                        const strokeType = detectLineTypeFromDashArray(layerInfo.layer.options.dashArray);
                        document.getElementById('strokeType').value = strokeType;
                    }
                }
                
                // localStorage'dan stil kontrolü yapılabilir
                if (savedStyles[featureId] && savedStyles[featureId][type]) {
                    styles = savedStyles[featureId][type];
                }
            } 
            // Katman seçilmişse, katmanın stillerini kontrol et
            else if (modal.dataset.layerId) {
                const layerId = modal.dataset.layerId;
                if (savedStyles[layerId] && savedStyles[layerId][type]) {
                    styles = savedStyles[layerId][type];
                }
            }
            
            // Eğer kayıtlı stiller bulunduysa, input alanlarını güncelle
            if (styles) {
                if (type === 'point') {
                    document.getElementById('pointColor').value = styles.pointColor || "#ff0000";
                    document.getElementById('pointSize').value = styles.pointSize || 8;
                    document.getElementById('pointShape').value = styles.pointShape || "circle";
                } 
                else if (type === 'line') {
                    document.getElementById('lineColor').value = styles.lineColor || "#ff7800";
                    document.getElementById('lineWidth').value = styles.lineWidth || 3;
                    document.getElementById('lineType').value = styles.lineType || "solid";
                }
                else if (type === 'polygon') {
                    document.getElementById('fillColor').value = styles.fillColor || "#3388ff";
                    document.getElementById('fillOpacity').value = styles.fillOpacity || 50;
                    document.getElementById('strokeColor').value = styles.strokeColor || "#000000";
                    document.getElementById('strokeWidth').value = styles.strokeWidth || 1;
                    document.getElementById('strokeType').value = styles.strokeType || "solid";
                }
            }
            
            // Range input değerlerini güncelle
            updateRangeDisplays();
        }
        
        // Sistem varsayılan stilleri
        const systemDefaultStyles = {
            point: { color: "#ff0000", size: 8, shape: "circle", opacity: 100, styleType: "custom" },
            line: { color: "#ff7800", width: 3, opacity: 100, lineType: "solid" },
            polygon: { fillColor: "#3388ff", fillOpacity: 50, strokeColor: "#000000", strokeWidth: 1, strokeOpacity: 100, strokeType: "solid" }
        };

        // Rastgele isim listeleri
        const randomNames = {
            points: [
                "İstanbul Üniversitesi", "Galata Kulesi", "Topkapı Sarayı", "Ayasofya", "Kapalıçarşı",
                "Dolmabahçe Sarayı", "Beyazıt Kulesi", "Şişli Merkez", "Kadıköy İskelesi", "Üsküdar Meydanı",
                "Beşiktaş Merkezi", "Taksim Meydanı", "Eminönü İskelesi", "Bakırköy Merkez", "Kartal Meydanı"
            ],
            lines: [
                "Boğaziçi Köprüsü", "Fatih Sultan Mehmet Köprüsü", "Yavuz Sultan Selim Köprüsü", 
                "D-100 Karayolu", "TEM Otoyolu", "Sahil Yolu", "İstiklal Caddesi", "Bağdat Caddesi",
                "Barbaros Bulvarı", "Atatürk Bulvarı", "Kennedy Caddesi", "Büyükdere Caddesi",
                "Maslak Yolu", "E-5 Karayolu", "Çevre Yolu"
            ],
            polygons: [
                "Gülhane Parkı", "Emirgan Korusu", "Yıldız Parkı", "Maçka Parkı", "Fenerbahçe Parkı",
                "Sultanahmet Meydanı", "Taksim Gezi Parkı", "Büyükada", "Heybeliada", "Kınalıada",
                "Florya Sahili", "Caddebostan Sahili", "Yeşilköy Sahili", "Kilyos Sahili", "Şile Sahili"
            ]
        };

        // Stil alanlarını varsayılan değerlerine ayarla
        function resetDefaultStyles() {
            // Sistem varsayılan değerlerini uygula
            applySystemDefaults();
        }

        // Sistem varsayılan değerlerini uygula
        function applySystemDefaults() {
            // Nokta stil değerleri
            document.getElementById('pointColor').value = systemDefaultStyles.point.color;
            document.getElementById('pointSize').value = systemDefaultStyles.point.size;
            document.getElementById('pointShape').value = systemDefaultStyles.point.shape;
            document.getElementById('pointOpacity').value = systemDefaultStyles.point.opacity;
            document.getElementById('pointStyleType').value = systemDefaultStyles.point.styleType;
            
            // Çizgi stil değerleri
            document.getElementById('lineColor').value = systemDefaultStyles.line.color;
            document.getElementById('lineWidth').value = systemDefaultStyles.line.width;
            document.getElementById('lineOpacity').value = systemDefaultStyles.line.opacity;
            document.getElementById('lineType').value = systemDefaultStyles.line.lineType;
            
            // Poligon stil değerleri
            document.getElementById('fillColor').value = systemDefaultStyles.polygon.fillColor;
            document.getElementById('fillOpacity').value = systemDefaultStyles.polygon.fillOpacity;
            document.getElementById('strokeColor').value = systemDefaultStyles.polygon.strokeColor;
            document.getElementById('strokeWidth').value = systemDefaultStyles.polygon.strokeWidth;
            document.getElementById('strokeOpacity').value = systemDefaultStyles.polygon.strokeOpacity;
            document.getElementById('strokeType').value = systemDefaultStyles.polygon.strokeType;
            
            // Range display'leri güncelle
            updateRangeDisplays();
        }

        // Label collision detection and management
        const labelManager = {
            labels: [],

            addLabel: function(bounds, element) {
                this.labels.push({ bounds, element });
            },

            checkCollision: function(newBounds) {
                return this.labels.some(label => this.boundsIntersect(label.bounds, newBounds));
            },

            boundsIntersect: function(a, b) {
                return !(a.right < b.left ||
                        a.left > b.right ||
                        a.bottom < b.top ||
                        a.top > b.bottom);
            },

            clear: function() {
                this.labels = [];
            },

            getBounds: function(element) {
                if (!element) return null;
                const rect = element.getBoundingClientRect();
                return {
                    left: rect.left,
                    right: rect.right,
                    top: rect.top,
                    bottom: rect.bottom
                };
            }
        };

        // Tüm çizimlere etiket uygula (Geliştirilmiş - Çakışma Önleme + Çevre Etiketleri)
        function applyLabelsToAllFeatures() {
            const showLabels = document.getElementById('showLabels') ? document.getElementById('showLabels').checked : false;
            const labelField = document.getElementById('labelField') ? document.getElementById('labelField').value : 'name';
            const fontSize = document.getElementById('fontSize') ? document.getElementById('fontSize').value : 11;
            const fontColor = document.getElementById('fontColor') ? document.getElementById('fontColor').value : '#ffffff';
            const haloColor = document.getElementById('haloColor') ? document.getElementById('haloColor').value : '#000000';
            const haloWidth = document.getElementById('haloWidth') ? document.getElementById('haloWidth').value : 2;
            const labelPosition = document.getElementById('labelPosition') ? document.getElementById('labelPosition').value : 'center';

            // Label manager'ı temizle
            labelManager.clear();

            if (!showLabels || !labelField) {
                // Etiketleri gizle
                drawnLayers.forEach(layerInfo => {
                    const layer = layerInfo.layer;
                    if (layer.closeTooltip) layer.closeTooltip();
                    if (layer.unbindTooltip) layer.unbindTooltip();
                    // Edge labels'ı da temizle
                    if (layer._edgeLabels) {
                        layer._edgeLabels.forEach(marker => map.removeLayer(marker));
                        layer._edgeLabels = [];
                    }
                });
                return;
            }

            // Tüm çizimlere etiket ekle
            drawnLayers.forEach((layerInfo, index) => {
                const layer = layerInfo.layer;
                const properties = layer.feature ? layer.feature.properties : {};

                let labelText = '';
                if (labelField === 'name' && properties.name) {
                    labelText = properties.name;
                } else if (labelField === 'type' && properties.type) {
                    labelText = properties.type === 'point' ? 'Nokta' :
                               properties.type === 'line' ? 'Çizgi' : 'Poligon';
                } else if (labelField === 'id' && properties.id) {
                    labelText = properties.id;
                } else if (labelField === 'area' && properties.area) {
                    labelText = `${properties.area} m²`;
                } else if (labelField === 'length' && properties.length) {
                    labelText = `${properties.length} m`;
                } else {
                    labelText = `Obje ${index + 1}`;
                }

                if (labelText) {
                    // Merkez etiket ekle
                    const tooltipOptions = {
                        permanent: true,
                        direction: labelPosition === 'center' ? 'center' : labelPosition,
                        className: 'feature-label',
                        offset: labelPosition === 'center' ? [0, 0] : [0, -10]
                    };

                    // Önceki tooltip'i kaldır
                    if (layer.getTooltip) layer.closeTooltip();
                    if (layer.unbindTooltip) layer.unbindTooltip();

                    // Yeni tooltip ekle
                    layer.bindTooltip(labelText, tooltipOptions);

                    // CSS stilini uygula ve çakışma kontrolü yap
                    setTimeout(() => {
                        const tooltipElement = layer.getTooltip() ? layer.getTooltip()._container : null;
                        if (tooltipElement) {
                            tooltipElement.style.fontSize = fontSize + 'px';
                            tooltipElement.style.color = fontColor;
                            tooltipElement.style.textShadow = `1px 1px ${haloWidth}px ${haloColor}, -1px -1px ${haloWidth}px ${haloColor}, 1px -1px ${haloWidth}px ${haloColor}, -1px 1px ${haloWidth}px ${haloColor}`;
                            tooltipElement.style.fontWeight = 'bold';

                            // Çakışma kontrolü
                            const bounds = labelManager.getBounds(tooltipElement);
                            if (bounds && labelManager.checkCollision(bounds)) {
                                // Çakışma var - etiketi gizle veya konumunu değiştir
                                tooltipElement.classList.add('hidden');
                            } else if (bounds) {
                                labelManager.addLabel(bounds, tooltipElement);
                            }
                        }
                    }, 150);

                    // Çizgi ve poligonlar için çevre etiketleri ekle
                    if (layer instanceof L.Polyline || layer instanceof L.Polygon) {
                        addEdgeLabels(layer, labelText, fontSize, fontColor);
                    }
                }
            });
        }

        // Çizgi ve poligonlar için çevre etiketleri ekle
        function addEdgeLabels(layer, baseText, fontSize, fontColor) {
            // Önceki edge labels'ı temizle
            if (layer._edgeLabels) {
                layer._edgeLabels.forEach(marker => map.removeLayer(marker));
            }
            layer._edgeLabels = [];

            const latlngs = layer.getLatLngs();
            let points = [];

            // Poligon için
            if (layer instanceof L.Polygon) {
                points = Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;
            }
            // Polyline için
            else if (layer instanceof L.Polyline) {
                points = latlngs;
            }

            if (points.length < 2) return;

            // Her segment için etiket ekle (her 2. segment'te veya uzun çizgilerde)
            for (let i = 0; i < points.length - 1; i++) {
                // Sadece belirli aralıklarla etiket ekle (her 2. segment)
                if (i % 2 !== 0 && points.length > 4) continue;

                const p1 = points[i];
                const p2 = points[i + 1];

                // Segment ortası
                const midLat = (p1.lat + p2.lat) / 2;
                const midLng = (p1.lng + p2.lng) / 2;
                const midPoint = L.latLng(midLat, midLng);

                // Segment uzunluğu
                const distance = map.distance(p1, p2);

                // Çok kısa segmentleri atla
                if (distance < 10) continue;

                // Etiket metni
                const edgeText = `${(distance).toFixed(1)}m`;

                // DivIcon ile marker oluştur
                const icon = L.divIcon({
                    className: 'edge-label',
                    html: edgeText,
                    iconSize: [null, null],
                    iconAnchor: [0, 0]
                });

                const marker = L.marker(midPoint, {
                    icon: icon,
                    interactive: false
                }).addTo(map);

                layer._edgeLabels.push(marker);

                // Stil uygula
                setTimeout(() => {
                    const el = marker.getElement();
                    if (el) {
                        el.style.fontSize = (parseInt(fontSize) - 1) + 'px';
                        el.style.color = fontColor;
                    }
                }, 50);
            }

            // Poligon için son noktayı da ekle
            if (layer instanceof L.Polygon && points.length > 2) {
                const p1 = points[points.length - 1];
                const p2 = points[0];
                const distance = map.distance(p1, p2);

                if (distance >= 10) {
                    const midLat = (p1.lat + p2.lat) / 2;
                    const midLng = (p1.lng + p2.lng) / 2;
                    const midPoint = L.latLng(midLat, midLng);

                    const edgeText = `${(distance).toFixed(1)}m`;

                    const icon = L.divIcon({
                        className: 'edge-label',
                        html: edgeText,
                        iconSize: [null, null]
                    });

                    const marker = L.marker(midPoint, {
                        icon: icon,
                        interactive: false
                    }).addTo(map);

                    layer._edgeLabels.push(marker);

                    setTimeout(() => {
                        const el = marker.getElement();
                        if (el) {
                            el.style.fontSize = (parseInt(fontSize) - 1) + 'px';
                            el.style.color = fontColor;
                        }
                    }, 50);
                }
            }
        }

        // Anında stil güncellemesi için event listener'ları başlat
        function initRealTimeStyleUpdates() {
            // Tüm stil input'larına event listener ekle
            const styleInputs = [
                // Nokta stil input'ları
                'pointColor', 'pointSize', 'pointShape', 'pointOpacity', 'pointStyleType',
                // Çizgi stil input'ları
                'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                // Poligon stil input'ları
                'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType',
                // İkon input'ları
                'iconSize'
            ];

            styleInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Hem input hem de change eventlerini dinle
                    input.addEventListener('input', handleRealTimeStyleUpdate);
                    input.addEventListener('change', handleRealTimeStyleUpdate);
                }
            });

            // Stil modu değişikliğini dinle
            const styleModeSelect = document.getElementById('styleMode');
            if (styleModeSelect) {
                styleModeSelect.addEventListener('change', function() {
                    // Önce modu değiştir, sonra anında güncelle
                    handleStyleModeChange(this.value);
                });
            }

            // İkon grid seçimlerini dinle
            setupIconGridListener();
        }

        // Gerçek zamanlı stil güncellemesi
        function handleRealTimeStyleUpdate() {
            // Kısa bir gecikme ekleyerek performansı artır
            if (window.styleUpdateTimeout) {
                clearTimeout(window.styleUpdateTimeout);
            }
            
            window.styleUpdateTimeout = setTimeout(() => {
                try {
                    // Range display'leri güncelle
                    updateRangeDisplays();
                    
                    // Modal açıksa normal applyStyle kullan
                    const modal = document.getElementById('styleModal');
                    if (modal && modal.style.display !== 'none' && modal.dataset.layerId) {
                        applyStyle();
                    } else {
                        // Modal açık değilse aktif katmana stil uygula
                        if (activeLayerId) {
                            applyStyleToActiveLayer();
                        }
                    }
                    
                    // Etiket ayarları aktifse onları da güncelle
                    if (document.querySelector('#labelContent') && document.querySelector('#labelContent').style.display !== 'none') {
                        if (typeof applyLabelsToAllFeatures === 'function') {
                            applyLabelsToAllFeatures();
                        }
                    }
                    
                    // Custom modda ise ayarları otomatik kaydet (debounced)
                    const currentMode = document.getElementById('styleMode')?.value;
                    if (currentMode === 'custom') {
                        if (window.saveUserStylesTimeout) {
                            clearTimeout(window.saveUserStylesTimeout);
                        }
                        window.saveUserStylesTimeout = setTimeout(() => {
                            saveUserCustomStyles();
                        }, 500); // 500ms sonra kaydet
                    }
                } catch (error) {
                    console.warn('Gerçek zamanlı stil güncellemesi sırasında hata:', error);
                }
            }, 50); // 50ms gecikme (daha hızlı)
        }

        // İkon grid listener'ı kurma
        function setupIconGridListener() {
            const iconGrid = document.getElementById('iconGrid');
            if (iconGrid) {
                iconGrid.addEventListener('click', function(e) {
                    const iconOption = e.target.closest('.icon-option');
                    if (iconOption) {
                        // İkon seçiminden sonra stil güncelle
                        setTimeout(handleRealTimeStyleUpdate, 25);
                    }
                });
            }
        }

        // Katman stil modu göstergesini güncelle
        function updateLayerStyleModeIndicator(layerId, mode) {
            if (!layerId) {
                console.warn('updateLayerStyleModeIndicator: layerId bulunamadı');
                return;
            }
            
            const indicator = document.querySelector(`[data-layer-id="${layerId}"].layer-style-mode-indicator`);
            console.log('Gösterge güncellemesi:', { layerId, mode, indicator: !!indicator });
            
            if (indicator) {
                // CSS sınıflarını temizle
                indicator.classList.remove('default-mode', 'custom-mode');
                
                if (mode === 'default') {
                    indicator.textContent = '🏢';
                    indicator.title = 'Varsayılan Kurumsal Ayarlar (Kişiselleştir)';
                    indicator.classList.add('default-mode');
                    console.log(`Gösterge güncellendi: ${layerId} -> varsayılan mod`);
                } else if (mode === 'custom') {
                    indicator.textContent = '👤';
                    indicator.title = 'Kullanıcıya Özel Ayarlar (Varsayılana Geç)';
                    indicator.classList.add('custom-mode');
                    console.log(`Gösterge güncellendi: ${layerId} -> özel mod`);
                }
            } else {
                console.warn(`Gösterge bulunamadı: [data-layer-id="${layerId}"].layer-style-mode-indicator`);
            }
        }

        // Tüm katman stil modu göstergelerini güncelle
        function updateAllLayerStyleModeIndicators() {
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            
            document.querySelectorAll('.layer-style-mode-indicator').forEach(indicator => {
                const layerId = indicator.getAttribute('data-layer-id');
                if (layerId) {
                    const mode = savedStyleModes[layerId] || 'default';
                    updateLayerStyleModeIndicator(layerId, mode);
                    
                    // Tıklama event'ini ekle (eğer yoksa)
                    if (!indicator.hasAttribute('onclick')) {
                        indicator.setAttribute('onclick', `toggleLayerStyleMode('${layerId}', event)`);
                    }
                }
            });
        }

        // Yeni kaydet ve kapat fonksiyonu
        function saveAndCloseStyle() {
            try {
                console.log('saveAndCloseStyle başlatıldı');
                
                // Modal'dan katman bilgilerini al
                const modal = document.getElementById('styleModal');
                const layerId = modal.dataset.layerId;
                const layerType = modal.dataset.layerType;
                
                console.log('Modal verileri:', { layerId, layerType });
                
                if (!layerId) {
                    console.error('LayerId bulunamadı, modal veri kontrolü yapılıyor...');
                    showToast('Katman bilgisi bulunamadı', 'error');
                    return;
                }
                
                // Seçili stil modunu kontrol et ve gerekli ayarları kaydet
                const styleMode = document.getElementById('styleMode').value;
                console.log('Seçili stil modu:', styleMode);
                
                if (styleMode === 'custom') {
                    // Kullanıcı özel modunda: özel ayarları global olarak kaydet
                    console.log('Kullanıcı özel ayarları kaydediliyor...');
                    saveUserCustomStyles();
                } else if (styleMode === 'default') {
                    // Varsayılan modunda: sistem varsayılan değerlerini kullan
                    console.log('Varsayılan mod kullanılıyor - özel kayıt yapılmıyor');
                }
                
                // Her iki durumda da stil değişikliklerini uygula
                console.log('Stil değişiklikleri uygulanıyor...');
                applyStyle();
                
                // Etiket ayarlarını da uygula
                if (document.querySelector('#labelContent').style.display !== 'none') {
                    if (typeof applyLabelsToAllFeatures === 'function') {
                        console.log('Etiket ayarları uygulanıyor...');
                        applyLabelsToAllFeatures();
                    }
                }
                
                // Katman göstergesini güncelle
                console.log('Katman göstergesi güncelleniyor...', layerId, styleMode);
                updateLayerStyleModeIndicator(layerId, styleMode);
                
                // Başarı mesajı
                const modeText = styleMode === 'custom' ? 'Özel ayarlar' : 'Varsayılan ayarlar';
                showToast(`${modeText} kaydedildi ve uygulandı`, 'success');
                console.log('saveAndCloseStyle başarıyla tamamlandı');
                
            } catch (error) {
                console.error('Stil kaydedilirken hata oluştu:', error);
                console.error('Hata detayları:', error.stack);
                showToast(`Stil ayarları kaydedilirken hata: ${error.message}`, 'error');
            } finally {
                // Her durumda modal'ı kapat
                console.log('Modal kapatılıyor...');
                closeStyleModal();
            }
        }
        
        // Kalınlığa göre dash array hesapla
        function calculateDashArray(type, width) {
            if (!type || type === 'solid') return null;
            
            // Minimum kalınlık 1, maksimum ölçekleme faktörü
            const scaleFactor = Math.max(1, width / 2);
            
            if (type === 'dashed') {
                const dash = Math.round(8 * scaleFactor);
                const gap = Math.round(4 * scaleFactor);
                return `${dash}, ${gap}`;
            } else if (type === 'dotted') {
                const dot = Math.round(2 * scaleFactor);
                const gap = Math.round(4 * scaleFactor);
                return `${dot}, ${gap}`;
            } else if (type === 'dashDot') {
                const dash = Math.round(8 * scaleFactor);
                const gap1 = Math.round(4 * scaleFactor);
                const dot = Math.round(2 * scaleFactor);
                const gap2 = Math.round(4 * scaleFactor);
                return `${dash}, ${gap1}, ${dot}, ${gap2}`;
            }
            
            return null;
        }

        // Dash array'den line type'ı tespit et
        function detectLineTypeFromDashArray(dashArray) {
            if (!dashArray) return 'solid';
            
            // Dash array'i parse et
            const parts = dashArray.split(',').map(p => parseInt(p.trim()));
            if (parts.length < 2) return 'solid';
            
            // Oranları kontrol et (kalınlık bağımsız)
            const ratio1 = parts[0] / parts[1]; // İlk dash/gap oranı
            
            if (parts.length === 2) {
                // İki parça: dash, gap
                if (ratio1 >= 1.5 && ratio1 <= 2.5) return 'dashed'; // ~2:1 oranı
                if (ratio1 >= 0.3 && ratio1 <= 0.7) return 'dotted'; // ~1:2 oranı
            } else if (parts.length === 4) {
                // Dört parça: dash, gap, dot, gap - dashDot pattern
                const ratio2 = parts[2] / parts[3]; // Dot/gap oranı
                if (ratio1 >= 1.5 && ratio2 >= 0.3 && ratio2 <= 0.7) return 'dashDot';
            }
            
            return 'solid';
        }

        // Kullanıcı özel stillerini kaydet
        function saveUserCustomStyles() {
            try {
                const userStyles = {
                    point: {
                        color: document.getElementById('pointColor')?.value || "#ff0000",
                        size: parseInt(document.getElementById('pointSize')?.value || 8),
                        shape: document.getElementById('pointShape')?.value || "circle",
                        opacity: parseInt(document.getElementById('pointOpacity')?.value || 100),
                        styleType: document.getElementById('pointStyleType')?.value || "custom"
                    },
                    line: {
                        color: document.getElementById('lineColor')?.value || "#ff7800",
                        width: parseInt(document.getElementById('lineWidth')?.value || 3),
                        opacity: parseInt(document.getElementById('lineOpacity')?.value || 100),
                        lineType: document.getElementById('lineType')?.value || "solid"
                    },
                    polygon: {
                        fillColor: document.getElementById('fillColor')?.value || "#3388ff",
                        fillOpacity: parseInt(document.getElementById('fillOpacity')?.value || 50),
                        strokeColor: document.getElementById('strokeColor')?.value || "#000000",
                        strokeWidth: parseInt(document.getElementById('strokeWidth')?.value || 1),
                        strokeOpacity: parseInt(document.getElementById('strokeOpacity')?.value || 100),
                        strokeType: document.getElementById('strokeType')?.value || "solid"
                    }
                };
                
                localStorage.setItem('userCustomStyles', JSON.stringify(userStyles));
                console.log('Kullanıcı özel ayarları kaydedildi:', userStyles);
            } catch (error) {
                console.error('Kullanıcı ayarları kaydedilemedi:', error);
            }
        }

        // Aktif katmana stil uygula (modal olmadan)
        function applyStyleToActiveLayer() {
            if (!activeLayerId) {
                console.warn("Aktif katman bulunamadı");
                return;
            }
            
            console.log("=== Aktif katmana stil uygulanıyor ===");
            console.log("Aktif katman ID:", activeLayerId);
            
            const targetLayer = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
            if (!targetLayer) {
                console.error("Aktif katman DOM'da bulunamadı:", activeLayerId);
                return;
            }
            
            // Katmandaki çizim tiplerini kontrol et ve hepsine stil uygula
            const features = layerFeatures[activeLayerId] || [];
            console.log("layerFeatures[activeLayerId]:", features);
            console.log("Tüm layerFeatures:", layerFeatures);
            
            const hasPoint = features.some(f => f.type === 'point');
            const hasLine = features.some(f => f.type === 'line');
            const hasPolygon = features.some(f => f.type === 'polygon');
            
            console.log("Katman çizim tipleri kontrolü:", { 
                hasPoint, 
                hasLine, 
                hasPolygon, 
                featureCount: features.length,
                features: features.map(f => ({ id: f.id, type: f.type }))
            });
            
            // Alternatif olarak drawnLayers'dan da kontrol edelim
            const drawnLayersForThisLayer = drawnLayers.filter(dl => {
                // drawnLayers'daki her item'in katman bilgisini kontrol et
                return dl.layerId === activeLayerId;
            });
            
            console.log("drawnLayers'dan bulunan çizimler:", drawnLayersForThisLayer.map(dl => ({ 
                id: dl.id, 
                type: dl.type, 
                layerId: dl.layerId 
            })));
            
            if (hasPoint) {
                console.log("✅ Point stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'point');
            }
            if (hasLine) {
                console.log("✅ Line stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'line');
            }
            if (hasPolygon) {
                console.log("✅ Polygon stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'polygon');
            }
            
            // Eğer hiçbir tip bulunamazsa, drawnLayers'dan dene
            if (!hasPoint && !hasLine && !hasPolygon && drawnLayersForThisLayer.length > 0) {
                console.log("⚠️ layerFeatures'da bulunamadı, drawnLayers'dan uyguluyorum...");
                drawnLayersForThisLayer.forEach(dl => {
                    console.log(`${dl.type} stilini uyguluyorum (drawnLayers'dan):`, dl.id);
                    applyStyleToFeature(dl.id, dl.type);
                });
            }
            
            console.log("=== Aktif katman stili güncelleme tamamlandı ===");
            
            // Stil modu göstergesini güncelle (kullanıcı değişiklik yaptığında custom moda geç)
            const currentMode = document.getElementById('styleMode')?.value || 'custom';
            updateLayerStyleModeIndicator(activeLayerId, currentMode);
        }

        // Stil uygulama
        function applyStyle() {
            try {
                const modal = document.getElementById('styleModal');
                const layerType = modal.dataset.layerType;
                const layerId = modal.dataset.layerId;
                
                console.log("Stil uygulanıyor:", { layerType, layerId });
                
                if (!layerId) {
                    console.error("LayerId bulunamadı, stil uygulanamıyor");
                    throw new Error("Katman ID'si bulunamadı");
                }
            
            // Sayfa üzerindeki stil ayarlarını oku
            const styleSettings = {
                point: {
                    color: document.getElementById('pointColor').value,
                    size: parseInt(document.getElementById('pointSize').value),
                    shape: document.getElementById('pointShape').value,
                    opacity: parseInt(document.getElementById('pointOpacity').value) / 100,
                    styleType: document.getElementById('pointStyleType').value
                },
                line: {
                    color: document.getElementById('lineColor').value,
                    width: parseInt(document.getElementById('lineWidth').value),
                    opacity: parseInt(document.getElementById('lineOpacity').value) / 100,
                    lineType: document.getElementById('lineType').value
                },
                polygon: {
                    fillColor: document.getElementById('fillColor').value,
                    fillOpacity: parseInt(document.getElementById('fillOpacity').value) / 100,
                    strokeColor: document.getElementById('strokeColor').value,
                    strokeWidth: parseInt(document.getElementById('strokeWidth').value),
                    strokeOpacity: parseInt(document.getElementById('strokeOpacity').value) / 100,
                    strokeType: document.getElementById('strokeType').value
                }
            };
            
            // Stil uygulanacak hedefi belirle
            if (layerId) {
                if (layerId.startsWith('feature-')) {
                    // Tek bir çizim öğesine stil uygula
                    if (layerType) {
                        applyStyleToFeature(layerId, layerType);
                        console.log(`${layerType} stilini çizim öğesine uygulandı: ${layerId}`);
                    } else {
                        // Çizim tipine göre stil uygula
                        const layerInfo = drawnLayers.find(l => l.id === layerId);
                        if (layerInfo) {
                            const type = layerInfo.type;
                            applyStyleToFeature(layerId, type);
                            console.log(`${type} stilini çizim öğesine uygulandı: ${layerId}`);
                        } else {
                            console.error("Çizim bulunamadı:", layerId);
                        }
                    }
                } else {
                    // Bir katmana ait tüm çizimlere stil uygula
                    const targetLayer = document.querySelector(`[data-layer-id="${layerId}"]`);
                    if (targetLayer) {
                        console.log("Katman bulundu, stil uygulanıyor:", layerId);
                        // Geçerli olan her stil tipini uygula
                        if (layerType) {
                            // Belirli bir stil tipi seçilmişse sadece onu uygula
                            applyStyleToLayer(targetLayer, layerId, layerType);
                        } else {
                            // Tüm stil tiplerini kontrol et ve katmanda kullanılanları uygula
                            const features = layerFeatures[layerId] || [];
                            const hasPoint = features.some(f => f.type === 'point');
                            const hasLine = features.some(f => f.type === 'line');
                            const hasPolygon = features.some(f => f.type === 'polygon');
                            
                            if (hasPoint) applyStyleToLayer(targetLayer, layerId, 'point');
                            if (hasLine) applyStyleToLayer(targetLayer, layerId, 'line');
                            if (hasPolygon) applyStyleToLayer(targetLayer, layerId, 'polygon');
                        }
                    } else {
                        console.error("Katman bulunamadı:", layerId);
                    }
                }
            } else {
                console.error("Stil uygulanacak katman veya çizim belirtilmemiş");
                // Aktif katmanı kullanmayı dene
                if (activeLayerId) {
                    const targetLayer = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
                    if (targetLayer) {
                        if (layerType) {
                            applyStyleToLayer(targetLayer, activeLayerId, layerType);
                            console.log(`${layerType} stilini aktif katmana uygulandı: ${activeLayerId}`);
                        } else {
                            // Aktif katmanda varolan tüm geometri tiplerine uygula
                            const features = layerFeatures[activeLayerId] || [];
                            const hasPoint = features.some(f => f.type === 'point');
                            const hasLine = features.some(f => f.type === 'line');
                            const hasPolygon = features.some(f => f.type === 'polygon');
                            
                            if (hasPoint) applyStyleToLayer(targetLayer, activeLayerId, 'point');
                            if (hasLine) applyStyleToLayer(targetLayer, activeLayerId, 'line');
                            if (hasPolygon) applyStyleToLayer(targetLayer, activeLayerId, 'polygon');
                        }
                    }
                }
            }
            
                // Stil ayarlarını kaydet
                saveStyles(layerId || activeLayerId, layerType);
                
                // Çizim kontrolünü güncelle
                if (typeof updateDrawControl === 'function') {
                    updateDrawControl();
                }
                
                console.log("Stil başarıyla uygulandı");
                
                // Stil modu göstergesini güncelle
                const targetLayerId = layerId || activeLayerId;
                if (targetLayerId) {
                    const currentMode = document.getElementById('styleMode')?.value || 'custom';
                    updateLayerStyleModeIndicator(targetLayerId, currentMode);
                }
                
            } catch (error) {
                console.error("Stil uygulama hatası:", error);
                throw error; // Hatayı üst seviyeye geçir
            }
        }
        
        
        
        // Stilleri kaydet
        function saveStyles(layerId, layerType) {
            if (!layerId) {
                console.warn("saveStyles: Kaydedilecek katman ID'si bulunamadı");
                return;
            }
            
            console.log(`Stiller kaydediliyor: layerId=${layerId}, layerType=${layerType}`);
            
            // Seçili stil modunu al
            const selectedMode = document.getElementById('styleMode').value;
            
            // Ayarları yerel depolama alanına kaydet
            const styleSettings = {
                pointColor: document.getElementById('pointColor').value,
                pointSize: document.getElementById('pointSize').value,
                pointShape: document.getElementById('pointShape').value,
                
                lineColor: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value, 
                lineType: document.getElementById('lineType').value,
                
                fillColor: document.getElementById('fillColor').value,
                fillOpacity: document.getElementById('fillOpacity').value,
                strokeColor: document.getElementById('strokeColor').value,
                strokeWidth: document.getElementById('strokeWidth').value,
                strokeType: document.getElementById('strokeType').value
            };
            
            // Katman-stil ilişkisini kaydet
            const savedStyles = JSON.parse(localStorage.getItem('mapStyles') || '{}');
            
            if (layerId) {
                savedStyles[layerId] = {
                    ...savedStyles[layerId],
                    [layerType]: styleSettings
                };
            }
            
            localStorage.setItem('mapStyles', JSON.stringify(savedStyles));
            
            // Katman için seçilen stil modunu da kaydet
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            savedStyleModes[layerId] = selectedMode;
            localStorage.setItem('layerStyleModes', JSON.stringify(savedStyleModes));
            
            // Kullanıcıya stil değişikliklerinin kaydedildiğini bildir
            console.log('Stil değişiklikleri kaydedildi - Mod:', selectedMode);
        }

        // Range inputların görüntüsünü güncelle
        function updateRangeDisplays() {
            document.querySelectorAll('input[type="range"]').forEach(input => {
                const valueDisplay = input.nextElementSibling;
                if (valueDisplay && valueDisplay.classList.contains('value-display')) {
                    let value = input.value;
                    if (input.id.includes('Opacity')) {
                        value += '%';
                    } else if (input.id.includes('Density') || input.id.includes('Height')) {
                        value = value; // Birim eklemeden göster
                    } else {
                        value += 'px';
                    }
                    valueDisplay.textContent = value;
                }
            });
        }

        // Tek bir çizime stil uygula
        function applyStyleToFeature(featureId, type) {
            const layerInfo = drawnLayers.find(l => l.id === featureId);
            if (!layerInfo) return;
            
            const layer = layerInfo.layer;
            
            if (type === 'point') {
                const pointColor = document.getElementById('pointColor').value;
                const pointSize = parseInt(document.getElementById('pointSize').value);
                const pointOpacity = parseInt(document.getElementById('pointOpacity').value) / 100;
                const pointShape = document.getElementById('pointShape').value;
                const pointStyleType = document.getElementById('pointStyleType').value;
                
                // Marker stili için custom icon oluştur
                let iconHtml = '';
                const rgbaColor = hexToRgba(pointColor, pointOpacity);
                
                if (pointStyleType === 'custom') {
                    if (pointShape === 'circle') {
                        iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                    } else if (pointShape === 'square') {
                        iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                    } else if (pointShape === 'triangle') {
                        iconHtml = `<div style="width: 0; height: 0; border-left: ${pointSize/2}px solid transparent; border-right: ${pointSize/2}px solid transparent; border-bottom: ${pointSize}px solid ${rgbaColor};"></div>`;
                    } else if (pointShape === 'star') {
                        iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>`;
                    } else if (pointShape === 'diamond') {
                        iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 22,12 12,22 2,12"/></svg>`;
                    }
                } else {
                    // İkon modunda seçilen ikonu kullan
                    const iconGrid = document.getElementById('iconGrid');
                    const selectedIcon = iconGrid ? iconGrid.dataset.selectedIcon : '📍';
                    iconHtml = `<div style="font-size: ${pointSize}px; opacity: ${pointOpacity};">${selectedIcon || '📍'}</div>`;
                }
                
                // DivIcon oluştur
                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-div-icon',
                    iconSize: [pointSize, pointSize],
                    iconAnchor: [pointSize/2, pointSize/2]
                });
                
                // Icon'u uygula
                if (layer.setIcon) {
                    layer.setIcon(customIcon);
                }
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${pointColor}"><strong>Nokta</strong><br>Şekil: ${pointShape}<br>Boyut: ${pointSize}px<br>Saydamlık: ${Math.round(pointOpacity * 100)}%</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            else if (type === 'line') {
                const lineColor = document.getElementById('lineColor').value;
                const lineWidth = parseInt(document.getElementById('lineWidth').value);
                const lineOpacity = parseInt(document.getElementById('lineOpacity').value) / 100;
                const lineType = document.getElementById('lineType').value;
                
                // Çizgi stili için dashArray tanımla
                const dashArray = calculateDashArray(lineType, lineWidth);
                
                // Stili uygula
                layer.setStyle({
                    color: lineColor,
                    weight: lineWidth,
                    opacity: lineOpacity,
                    dashArray: dashArray
                });
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${lineColor}"><strong>Çizgi</strong><br>Kalınlık: ${lineWidth}px<br>Saydamlık: ${Math.round(lineOpacity * 100)}%<br>Tip: ${lineType}</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            else if (type === 'polygon') {
                const fillColor = document.getElementById('fillColor').value;
                const fillOpacity = document.getElementById('fillOpacity').value / 100;
                const strokeColor = document.getElementById('strokeColor').value;
                const strokeWidth = parseInt(document.getElementById('strokeWidth').value);
                const strokeOpacity = parseInt(document.getElementById('strokeOpacity').value) / 100;
                const strokeType = document.getElementById('strokeType').value;
                
                // Kenar stili için dashArray tanımla
                const dashArray = calculateDashArray(strokeType, strokeWidth);
                
                // Stili uygula
                layer.setStyle({
                    fillColor: fillColor,
                    fillOpacity: fillOpacity,
                    color: strokeColor,
                    weight: strokeWidth,
                    opacity: strokeOpacity,
                    dashArray: dashArray
                });
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${fillColor}"><strong>Poligon</strong><br>Dolgu Saydamlık: ${Math.round(fillOpacity * 100)}%<br>Kenar Kalınlık: ${strokeWidth}px<br>Kenar Saydamlık: ${Math.round(strokeOpacity * 100)}%</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            
            // Stil özelliklerini katmanda sakla
            if (!layer.options) layer.options = {};
            layer.options.styleInfo = {
                type: type,
                timestamp: new Date().getTime()
            };
            
            if (type === 'point') {
                layer.options.styleInfo.color = document.getElementById('pointColor').value;
                layer.options.styleInfo.size = document.getElementById('pointSize').value;
                layer.options.styleInfo.opacity = document.getElementById('pointOpacity').value / 100;
                layer.options.styleInfo.shape = document.getElementById('pointShape').value;
                layer.options.styleInfo.styleType = document.getElementById('pointStyleType').value;
            } else if (type === 'line') {
                layer.options.styleInfo.color = document.getElementById('lineColor').value;
                layer.options.styleInfo.width = document.getElementById('lineWidth').value;
                layer.options.styleInfo.opacity = document.getElementById('lineOpacity').value / 100;
                layer.options.styleInfo.lineType = document.getElementById('lineType').value;
            } else if (type === 'polygon') {
                layer.options.styleInfo.fillColor = document.getElementById('fillColor').value;
                layer.options.styleInfo.fillOpacity = document.getElementById('fillOpacity').value / 100;
                layer.options.styleInfo.strokeColor = document.getElementById('strokeColor').value;
                layer.options.styleInfo.strokeWidth = document.getElementById('strokeWidth').value;
                layer.options.styleInfo.strokeOpacity = document.getElementById('strokeOpacity').value / 100;
                layer.options.styleInfo.strokeType = document.getElementById('strokeType').value;
            }
        }
        
        // Katmandaki tüm çizimlere stil uygula
        function applyStyleToLayer(layerItem, layerId, layerType) {
            if (!layerItem || !layerId) {
                console.error("applyStyleToLayer: Katman öğesi veya ID'si eksik");
                return;
            }
            
            console.log(`Katman stilini uygulama başladı: layerId=${layerId}, layerType=${layerType}`);
            
            // SVG ikonları güncelle
            if (layerType === 'point') {
                const pointColor = document.getElementById('pointColor').value;
                const pointSize = document.getElementById('pointSize').value;
                const pointShape = document.getElementById('pointShape').value;
                const pointIcons = layerItem.querySelectorAll('.layer-icon:nth-child(1)');
                
                pointIcons.forEach(icon => {
                    // Rengi güncelle
                    icon.style.color = pointColor;
                    
                    // Şekil tipini de yansıtabiliriz
                    const svgEl = icon.querySelector('svg');
                    if (svgEl) {
                        let pathContent = '';
                        if (pointShape === 'circle') {
                            pathContent = '<circle cx="12" cy="12" r="6" fill="currentColor"/>';
                        } else if (pointShape === 'square') {
                            pathContent = '<rect x="4" y="4" width="16" height="16" fill="currentColor"/>';
                        } else if (pointShape === 'triangle') {
                            pathContent = '<polygon points="12,4 4,20 20,20" fill="currentColor"/>';
                        } else if (pointShape === 'star') {
                            pathContent = '<polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" fill="currentColor"/>';
                        }
                        svgEl.innerHTML = pathContent;
                    }
                });
                
                // İkon durumunu aktif yap
                pointIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-point');
                });
            }
            else if (layerType === 'line') {
                const lineColor = document.getElementById('lineColor').value;
                const lineWidth = document.getElementById('lineWidth').value;
                const lineType = document.getElementById('lineType').value;
                const lineIcons = layerItem.querySelectorAll('.layer-icon:nth-child(2)');
                
                lineIcons.forEach(icon => {
                    icon.style.color = lineColor;
                    
                    // Çizgi tipi görsel olarak yansıtılıyor
                    const paths = icon.querySelectorAll('path');
                    paths.forEach(path => {
                        path.setAttribute('stroke-width', lineWidth);
                        
                        const svgDashArray = calculateDashArray(lineType, lineWidth);
                        if (svgDashArray) {
                            path.setAttribute('stroke-dasharray', svgDashArray);
                        } else {
                            path.removeAttribute('stroke-dasharray');
                        }
                    });
                });
                
                // İkon durumunu aktif yap
                lineIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-line');
                });
            }
            else if (layerType === 'polygon') {
                const fillColor = document.getElementById('fillColor').value;
                const fillOpacity = document.getElementById('fillOpacity').value / 100;
                const strokeColor = document.getElementById('strokeColor').value;
                const strokeWidth = document.getElementById('strokeWidth').value;
                const strokeType = document.getElementById('strokeType').value;
                
                const polygonIcons = layerItem.querySelectorAll('.layer-icon:nth-child(3)');
                
                polygonIcons.forEach(icon => {
                    // Poligon rengini değiştir
                    icon.style.color = fillColor;
                    
                    // Poligon rengini ve kenar stilini güncelle
                    const shapes = icon.querySelectorAll('rect, polygon, path');
                    shapes.forEach(shape => {
                        shape.setAttribute('fill', fillColor);
                        shape.setAttribute('fill-opacity', fillOpacity);
                        shape.setAttribute('stroke', strokeColor);
                        shape.setAttribute('stroke-width', strokeWidth);
                        
                        // Kenar tipi
                        const svgStrokeDashArray = calculateDashArray(strokeType, strokeWidth);
                        if (svgStrokeDashArray) {
                            shape.setAttribute('stroke-dasharray', svgStrokeDashArray);
                        } else {
                            shape.removeAttribute('stroke-dasharray');
                        }
                    });
                });
                
                // İkon durumunu aktif yap
                polygonIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-polygon');
                });
            }
            
            // Katmandaki çizimleri güncelle
            if (layerFeatures[layerId]) {
                console.log(`Katmandaki ${layerFeatures[layerId].length} çizim güncelleniyor`);
                
                // Seçilen tipe göre filtrele
                const filteredFeatures = layerType 
                    ? layerFeatures[layerId].filter(f => f.type === layerType)
                    : layerFeatures[layerId];
                
                filteredFeatures.forEach(feature => {
                    applyStyleToFeature(feature.id, feature.type);
                });
                
                console.log(`${filteredFeatures.length} çizim güncellendi`);
            } else {
                console.log(`Katmanda (${layerId}) çizim bulunamadı`);
            }
        }

        // Stil modalını kapat
        function closeStyleModal() {
            document.getElementById('styleModal').style.display = 'none';
        }
        
        // === YENİ FONKSİYONLAR ===
        
        // Context Menu Setup
        function setupContextMenu() {
            let contextTarget = null;
            
            // Katman üzerinde sağ tık
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.layer-item')) {
                    e.preventDefault();
                    contextTarget = e.target.closest('.layer-item');
                    showContextMenu(e.pageX, e.pageY);
                } else if (window.continuousPointMode && e.target.closest('#map')) {
                    // Harita üzerinde sağ tık - sürekli nokta modunu durdur
                    e.preventDefault();
                    stopContinuousPointMode();
                }
            });
            
            // Context menu'yu gizle
            document.addEventListener('click', function() {
                hideContextMenu();
            });
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }
        
        function contextMenuAction(action) {
            const contextTarget = document.querySelector('.layer-item'); // Bu düzeltilmeli
            // Context menu actions here
            hideContextMenu();
        }
        
        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                    closeAllModals();
                    clearAllSelections();
                }
            });
        }
        
        // Search and Filter
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('layerSearch');
            // typeFilter kaldırıldı
            searchInput.addEventListener('input', function() {
                filterLayers();
            });
        }
        
        function filterLayers() {
            const searchTerm = document.getElementById('layerSearch').value.toLowerCase();
            document.querySelectorAll('.layer-item').forEach(item => {
                const layerName = item.querySelector('.layer-name').textContent.toLowerCase();
                const matchesSearch = searchTerm === '' || layerName.includes(searchTerm);
                item.style.display = matchesSearch ? 'flex' : 'none';
            });
            // Grup sayılarını güncelle
            document.querySelectorAll('.layer-group').forEach(group => {
                const groupItems = group.querySelector('.group-items');
                const visibleCount = groupItems.querySelectorAll('.layer-item:not([style*="display: none"])').length;
                const countElement = group.querySelector('.group-count');
                countElement.textContent = visibleCount;
            });
        }
        
        // Çizim buton ikonları
        function getDrawButtonIcon(title) {
            if (title.includes('marker') || title.includes('Marker')) return '📍';
            if (title.includes('polyline') || title.includes('line')) return '📏';
            if (title.includes('polygon')) return '⬟';
            if (title.includes('circle') || title.includes('Circle')) return '⭕';
            if (title.includes('rectangle') || title.includes('Rectangle')) return '⬜';
            if (title.includes('Edit')) return '✏️';
            if (title.includes('Delete')) return '🗑️';
            return '🔧';
        }

        // Dikdörtgen çizim fonksiyonu
        function startRectangleDrawing() {
            console.log('Dikdörtgen çizimi başlatılıyor...');
            window.drawingActiveLayerId = activeLayerId;
            
            // Leaflet Draw'ın rectangle özelliğini kullan
            if (window.drawControl && window.drawControl._toolbars && window.drawControl._toolbars.draw) {
                const rectangleTool = window.drawControl._toolbars.draw._modes.rectangle;
                if (rectangleTool && rectangleTool.handler) {
                    rectangleTool.handler.enable();
                } else {
                    console.error('Rectangle tool bulunamadı');
                }
            } else {
                console.error('Draw control bulunamadı');
            }
        }

        // Daire çizim fonksiyonu
        function startCircleDrawing() {
            console.log('Daire çizimi başlatılıyor...');
            window.drawingActiveLayerId = activeLayerId;
            
            // Leaflet Draw'ın circle özelliğini kullan
            if (window.drawControl && window.drawControl._toolbars && window.drawControl._toolbars.draw) {
                const circleTool = window.drawControl._toolbars.draw._modes.circle;
                if (circleTool && circleTool.handler) {
                    circleTool.handler.enable();
                } else {
                    console.error('Circle tool bulunamadı');
                }
            } else {
                console.error('Draw control bulunamadı');
            }
        }

        // Measurement Functions
        function startMeasurement(type) {
            console.log('startMeasurement çağrıldı:', type);
            console.log('measurementTools:', measurementTools);
            
            if (measurementTools) {
                // Tüm ölçüm butonlarını normal duruma çevir
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (type === 'distance') {
                    console.log('Mesafe ölçümü başlatılıyor...');
                    measurementTools.startDistance();
                    // Mesafe butonunu aktif yap
                    const distanceBtn = document.getElementById('distanceBtn');
                    if (distanceBtn) {
                        distanceBtn.classList.add('active');
                        console.log('Mesafe butonu aktif edildi');
                    }
                } else if (type === 'area') {
                    console.log('Alan ölçümü başlatılıyor...');
                    measurementTools.startArea();
                    // Alan butonunu aktif yap
                    const areaBtn = document.getElementById('areaBtn');
                    if (areaBtn) {
                        areaBtn.classList.add('active');
                        console.log('Alan butonu aktif edildi');
                    }
                }
            } else {
                console.error('measurementTools tanımlanmamış!');
                showNotification('Ölçüm sistemi yüklenemedi', 'error');
            }
        }
        
        function clearMeasurements() {
            if (measurementTools) {
                measurementTools.clearAll();
                
                // Tüm ölçüm butonlarını normal duruma çevir
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        }
        
        // Modal taşıma işlevselliği
        function initModalDragging() {
            const modal = document.getElementById('styleModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalHeader = modal.querySelector('.modal-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            modalHeader.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('close-btn')) return;
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === modalHeader || modalHeader.contains(e.target)) {
                    isDragging = true;
                    modalContent.style.transform = `translate(calc(-50% + ${xOffset}px), calc(-50% + ${yOffset}px))`;
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    modalContent.style.transform = `translate(calc(-50% + ${xOffset}px), calc(-50% + ${yOffset}px))`;
                }
            });
            
            document.addEventListener('mouseup', function() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            });
            
            // Modal kapandığında pozisyonu sıfırla
            modal.addEventListener('hide', function() {
                xOffset = 0;
                yOffset = 0;
                modalContent.style.transform = 'translate(-50%, -50%)';
            });
        }
        
        // Nokta stil tipi değişikliği
        function initPointStyleTypeToggle() {
            const pointStyleType = document.getElementById('pointStyleType');
            const customOptions = document.getElementById('customPointOptions');
            const iconOptions = document.getElementById('iconPointOptions');
            const iconCategory = document.getElementById('iconCategory');
            const styleMode = document.getElementById('styleMode');
            
            if (pointStyleType) {
                pointStyleType.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customOptions.style.display = 'block';
                        iconOptions.style.display = 'none';
                    } else {
                        customOptions.style.display = 'none';
                        iconOptions.style.display = 'block';
                        loadIconGrid();
                    }
                });
            }
            
            // İkon kategorisi değişikliğini dinle
            if (iconCategory) {
                iconCategory.addEventListener('change', function() {
                    loadIconGrid();
                });
            }
            
            // Stil modu değişikliğini dinle
            if (styleMode) {
                styleMode.addEventListener('change', function() {
                    handleStyleModeChange(this.value);
                });
            }
            
            // Stil modu toggle butonunu başlat
            initStyleModeToggle();
        }
        
        // Stil modu değişikliği handler'ı
        function handleStyleModeChange(mode) {
            console.log("=== Stil modu değişikliği başlıyor ===");
            console.log("Yeni mod:", mode);
            console.log("Aktif katman:", activeLayerId);
            
            if (mode === 'default') {
                // Varsayılan değerleri yükle ve kontrolları devre dışı bırak
                console.log("Varsayılan mod yükleniyor...");
                loadDefaultValues();
                setStyleControlsEnabled(false);
            } else {
                // Kullanıcı özel ayarları - kontrolları etkinleştir
                console.log("Kullanıcı özel mod yükleniyor...");
                setStyleControlsEnabled(true);
                console.log("Kontroller enable edildi");
                loadUserCustomValues();
                console.log("Kullanıcı özel değerler yüklendi");
                
                // Custom moda geçildiğinde mevcut değerleri kaydet
                setTimeout(() => {
                    saveUserCustomStyles();
                }, 100);
            }
            
            // Toggle butonunun görünümünü güncelle
            updateStyleModeToggleButton(mode);
            
            // Mod değişikliğinden sonra anında stil güncellemesi
            setTimeout(() => {
                try {
                    console.log("Stil modu değişikliği sonrası güncelleme başlıyor...");
                    
                    // Range display'leri güncelle
                    updateRangeDisplays();
                    
                    // Modal açıksa normal applyStyle kullan
                    const modal = document.getElementById('styleModal');
                    const isModalOpen = modal && modal.style.display !== 'none';
                    const hasModalLayerId = modal && modal.dataset.layerId;
                    
                    console.log("Modal durumu:", { isModalOpen, hasModalLayerId, activeLayerId });
                    
                    if (isModalOpen && hasModalLayerId) {
                        console.log("Modal açık, applyStyle kullanılıyor...");
                        applyStyle();
                    } else {
                        // Modal açık değilse aktif katmana stil uygula
                        if (activeLayerId) {
                            console.log("Modal açık değil, aktif katmana stil uygulanıyor...");
                            applyStyleToActiveLayer();
                        } else {
                            console.warn("Aktif katman bulunamadı, stil uygulanamıyor");
                        }
                    }
                    
                    // Etiket ayarları aktifse onları da güncelle
                    if (document.querySelector('#labelContent') && document.querySelector('#labelContent').style.display !== 'none') {
                        if (typeof applyLabelsToAllFeatures === 'function') {
                            applyLabelsToAllFeatures();
                        }
                    }
                    
                    // CRITICAL: Stil ayar modu göstergesini güncelle
                    if (activeLayerId) {
                        console.log(`Stil ayar modu göstergesi güncelleniyor: ${activeLayerId} -> ${mode}`);
                        updateLayerStyleModeIndicator(activeLayerId, mode);
                        showToast(`Stil ayar modu: ${mode === 'default' ? 'Sistem Varsayılanları' : 'Özelleştirilmiş'}`, 'info');
                    }
                } catch (error) {
                    console.error('Stil modu değişikliği sırasında hata:', error);
                }
            }, 100);
        }

        // Stil modu toggle butonu fonksiyonu
        function toggleStyleMode() {
            const styleModeSelect = document.getElementById('styleMode');
            if (!styleModeSelect) return;
            
            const currentMode = styleModeSelect.value;
            const newMode = currentMode === 'default' ? 'custom' : 'default';
            
            // Dropdown'ı güncelle
            styleModeSelect.value = newMode;
            
            // Mode değişikliğini işle
            handleStyleModeChange(newMode);
            
            // Animasyon efekti ekle
            const toggleButton = document.getElementById('styleModeToggle');
            if (toggleButton) {
                toggleButton.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    toggleButton.style.transform = 'scale(1)';
                }, 150);
            }
        }

        // Toggle butonunun görünümünü güncelleme fonksiyonu
        function updateStyleModeToggleButton(mode) {
            const toggleButton = document.getElementById('styleModeToggle');
            const iconElement = document.getElementById('styleModeIcon');
            
            if (!toggleButton || !iconElement) return;
            
            if (mode === 'custom') {
                // Kullanıcıya özel mod - personal ikonu
                iconElement.textContent = '👤';
                toggleButton.classList.add('custom-mode');
                toggleButton.title = 'Kullanıcıya Özel Ayarlar (Varsayılana Geç)';
            } else {
                // Varsayılan mod - kurumsal ikonu
                iconElement.textContent = '🏢';
                toggleButton.classList.remove('custom-mode');
                toggleButton.title = 'Varsayılan Kurumsal Ayarlar (Kişiselleştir)';
            }
        }

        // Sayfa yüklendiğinde toggle butonunu başlat
        function initStyleModeToggle() {
            const styleModeSelect = document.getElementById('styleMode');
            if (styleModeSelect) {
                // Başlangıç durumunu ayarla
                updateStyleModeToggleButton(styleModeSelect.value);
            }
        }

        // Katman stil modu göstergesine tıklama işlevi
        function toggleLayerStyleMode(layerId, event) {
            if (event) {
                event.stopPropagation(); // Katman seçimini engelle
            }
            
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            const currentMode = savedStyleModes[layerId] || 'default';
            const newMode = currentMode === 'default' ? 'custom' : 'default';
            
            // Yeni modu kaydet
            savedStyleModes[layerId] = newMode;
            localStorage.setItem('layerStyleModes', JSON.stringify(savedStyleModes));
            
            // Göstergeyi güncelle
            updateLayerStyleModeIndicator(layerId, newMode);
            
            // Modal açıksa ve bu katman aktifse, modal'daki dropdown'ı da güncelle
            const modal = document.getElementById('styleModal');
            if (modal && modal.style.display !== 'none' && modal.dataset.layerId === layerId) {
                const styleModeSelect = document.getElementById('styleMode');
                if (styleModeSelect) {
                    styleModeSelect.value = newMode;
                    updateStyleModeToggleButton(newMode);
                    handleStyleModeChange(newMode);
                }
            }
            
            // Bildirim göster
            showNotification(`Stil modu: ${newMode === 'default' ? 'Kurumsal Ayarlar' : 'Kişisel Ayarlar'}`, 'info');
        }
        
                 // Varsayılan değerleri yükle
         function loadDefaultValues() {
             // Sistem varsayılan değerlerini uygula
             applySystemDefaults();
             showToast('Sistem varsayılan değerleri yüklendi', 'info');
         }
        
        // Kullanıcı özel değerlerini yükle
        function loadUserCustomValues() {
            console.log("=== loadUserCustomValues çağrıldı ===");
            
            // Kayıtlı kullanıcı ayarları varsa yükle, yoksa varsayılanları kullan
            const savedUserStyles = JSON.parse(localStorage.getItem('userCustomStyles') || '{}');
            
            console.log("Kayıtlı kullanıcı stilleri:", savedUserStyles);
            console.log("localStorage'da userCustomStyles:", localStorage.getItem('userCustomStyles'));
            
            if (Object.keys(savedUserStyles).length > 0) {
                // Kayıtlı ayarları yükle
                if (savedUserStyles.point) {
                    document.getElementById('pointColor').value = savedUserStyles.point.color || "#ff0000";
                    document.getElementById('pointSize').value = savedUserStyles.point.size || 8;
                    document.getElementById('pointShape').value = savedUserStyles.point.shape || "circle";
                    document.getElementById('pointOpacity').value = savedUserStyles.point.opacity || 100;
                    document.getElementById('pointStyleType').value = savedUserStyles.point.styleType || "custom";
                }
                
                if (savedUserStyles.line) {
                    document.getElementById('lineColor').value = savedUserStyles.line.color || "#ff7800";
                    document.getElementById('lineWidth').value = savedUserStyles.line.width || 3;
                    document.getElementById('lineOpacity').value = savedUserStyles.line.opacity || 100;
                    document.getElementById('lineType').value = savedUserStyles.line.lineType || "solid";
                }
                
                if (savedUserStyles.polygon) {
                    document.getElementById('fillColor').value = savedUserStyles.polygon.fillColor || "#3388ff";
                    document.getElementById('fillOpacity').value = savedUserStyles.polygon.fillOpacity || 50;
                    document.getElementById('strokeColor').value = savedUserStyles.polygon.strokeColor || "#000000";
                    document.getElementById('strokeWidth').value = savedUserStyles.polygon.strokeWidth || 1;
                    document.getElementById('strokeOpacity').value = savedUserStyles.polygon.strokeOpacity || 100;
                    document.getElementById('strokeType').value = savedUserStyles.polygon.strokeType || "solid";
                }
                
                updateRangeDisplays();
                showToast('Kayıtlı özel ayarlarınız yüklendi', 'success');
            } else {
                // İlk kez kullanıyorsa varsayılan değerleri yükle
                applySystemDefaults();
                showToast('Özel ayar modu etkinleştirildi', 'info');
            }
            
            // Değerler yüklendikten sonra stil güncellemesi yap
            setTimeout(() => {
                updateRangeDisplays();
            }, 50);
        }
        
        // Stil kontrollerini etkin/devre dışı bırak
        function setStyleControlsEnabled(enabled) {
            console.log("=== setStyleControlsEnabled çağrıldı ===");
            console.log("Enabled:", enabled);
            
            const controls = [
                'pointColor', 'pointSize', 'pointShape', 'pointOpacity', 'pointStyleType',
                'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType'
            ];
            
            let foundControls = 0;
            let missingControls = [];
            
            controls.forEach(controlId => {
                const control = document.getElementById(controlId);
                if (control) {
                    control.disabled = !enabled;
                    control.style.opacity = enabled ? '1' : '0.6';
                    foundControls++;
                } else {
                    missingControls.push(controlId);
                }
            });
            
            console.log(`Bulunan kontroller: ${foundControls}/${controls.length}`);
            if (missingControls.length > 0) {
                console.warn("Eksik kontroller:", missingControls);
            }
            
            // Icon grid kontrollerini de dahil et
            const iconControls = document.querySelectorAll('#iconPointOptions input, #iconPointOptions select');
            iconControls.forEach(control => {
                control.disabled = !enabled;
                control.style.opacity = enabled ? '1' : '0.6';
            });
        }
        
        // Rastgele isimler ata
        function generateRandomNames() {
            let assignedCount = 0;
            
            // Tüm çizilmiş öğelere rastgele isimler ata
            drawnLayers.forEach(layerInfo => {
                const layer = layerInfo.layer;
                const type = layerInfo.type;
                
                let randomName = '';
                if (type === 'point') {
                    randomName = randomNames.points[Math.floor(Math.random() * randomNames.points.length)];
                } else if (type === 'line') {
                    randomName = randomNames.lines[Math.floor(Math.random() * randomNames.lines.length)];
                } else if (type === 'polygon') {
                    randomName = randomNames.polygons[Math.floor(Math.random() * randomNames.polygons.length)];
                }
                
                // Özellik olarak sakla
                if (!layer.feature) layer.feature = {};
                if (!layer.feature.properties) layer.feature.properties = {};
                
                layer.feature.properties.name = randomName;
                layer.feature.properties.type = type;
                layer.feature.properties.id = layerInfo.id;
                
                // Alan ve uzunluk hesapla
                if (type === 'polygon' && layer.getLatLngs) {
                    const area = L.GeometryUtil ? L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) : 0;
                    layer.feature.properties.area = Math.round(area);
                } else if (type === 'line' && layer.getLatLngs) {
                    let length = 0;
                    const points = layer.getLatLngs();
                    for (let i = 0; i < points.length - 1; i++) {
                        length += points[i].distanceTo(points[i + 1]);
                    }
                    layer.feature.properties.length = Math.round(length);
                }
                
                assignedCount++;
            });
            
            showToast(`${assignedCount} çizime rastgele isim atandı`, 'success');
            
            // Etiket alanını "name" olarak ayarla
            document.getElementById('labelField').value = 'name';
            
            // Etiketleri göster
            if (document.getElementById('showLabels').checked) {
                applyLabelsToAllFeatures();
            }
        }
        
        // İkon gridi yükleme
        function loadIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            const category = document.getElementById('iconCategory').value;
            
            // Basit emoji ikonları kategoriler halinde
            const icons = {
                location: ['📍', '📌', '🗺️', '🎯', '🏠', '🏢'],
                transport: ['🚗', '🚌', '🚂', '✈️', '🚲', '⛵'],
                service: ['🏥', '🏪', '🏫', '🏛️', '⛽', '🏦'],
                nature: ['🌳', '🌲', '🏔️', '🏞️', '🌊', '🏜️'],
                building: ['🏠', '🏢', '🏭', '🏗️', '🏰', '⛪']
            };
            
            iconGrid.innerHTML = '';
            
            if (icons[category]) {
                icons[category].forEach(icon => {
                    const iconOption = document.createElement('div');
                    iconOption.className = 'icon-option';
                    iconOption.innerHTML = `<span style="font-size: 20px;">${icon}</span>`;
                    iconOption.addEventListener('click', function() {
                        // Tüm seçimleri kaldır
                        document.querySelectorAll('.icon-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Bu ikonu seç
                        this.classList.add('selected');
                        // Seçilen ikonu sakla
                        iconGrid.dataset.selectedIcon = icon;
                    });
                    iconGrid.appendChild(iconOption);
                });
                         }
         }
         
         // Etiket event listener'larını başlat
         function initLabelEventListeners() {
             const showLabels = document.getElementById('showLabels');
             const labelField = document.getElementById('labelField');
             const fontSize = document.getElementById('fontSize');
             const fontColor = document.getElementById('fontColor');
             const haloColor = document.getElementById('haloColor');
             const haloWidth = document.getElementById('haloWidth');
             const labelPosition = document.getElementById('labelPosition');
             
             // Event listener'ları sadece bir kez ekle
             if (!showLabels.hasAttribute('data-listeners-added')) {
                 // Anında güncelleme için wrapper fonksiyon
                 function handleLabelUpdate() {
                     if (window.labelUpdateTimeout) {
                         clearTimeout(window.labelUpdateTimeout);
                     }
                     window.labelUpdateTimeout = setTimeout(() => {
                         if (typeof applyLabelsToAllFeatures === 'function') {
                             applyLabelsToAllFeatures();
                         }
                     }, 100);
                 }
                 
                 showLabels.addEventListener('change', handleLabelUpdate);
                 labelField.addEventListener('change', handleLabelUpdate);
                 fontSize.addEventListener('input', handleLabelUpdate);
                 fontColor.addEventListener('change', handleLabelUpdate);
                 haloColor.addEventListener('change', handleLabelUpdate);
                 haloWidth.addEventListener('input', handleLabelUpdate);
                 labelPosition.addEventListener('change', handleLabelUpdate);
                 
                 // İşaretleme
                 showLabels.setAttribute('data-listeners-added', 'true');
             }
         }
         
 

         
 

                 

        
        function closeAllModals() {
            document.getElementById('styleModal').style.display = 'none';
            document.getElementById('queryModal').style.display = 'none';
            document.getElementById('layerDetailsModal').style.display = 'none';
            document.getElementById('createModal').style.display = 'none';
        }
        
        // Keyboard event handlers
        document.addEventListener('keydown', function(e) {
            // Enter tuşu ile modal onaylama
            if (e.key === 'Enter' && document.getElementById('createModal').style.display === 'block') {
                e.preventDefault();
                confirmCreate();
            }
            
            // ESC tuşu ile sürekli nokta çizim modunu durdur
            if (e.key === 'Escape' && window.continuousPointMode) {
                e.preventDefault();
                stopContinuousPointMode();
            }
        });
        
        // === KOORDİNAT VE ÖLÇEK SİSTEMİ ===
        
        // Mevcut projeksiyon sistemi
        let currentProjection = 'EPSG:4326';
        
        // Ölçek her zaman dinamik olarak hesaplanır
        
        // Koordinat gösterimi
        function setupCoordinateDisplay() {
            map.on('mousemove', function(e) {
                updateCoordinateDisplay(e.latlng);
            });
            
            map.on('click', function(e) {
                // Ölçüm modu aktifse koordinat güncellemesini yapma
                if (measurementTools && measurementTools.isActive) {
                    console.log('Ölçüm modu aktif, koordinat güncellemesi atlandı');
                    return;
                }
                updateCoordinateDisplay(e.latlng);
            });
        }
        
        // Koordinatları güncelle
        function updateCoordinateDisplay(latlng) {
            const coords = convertCoordinates(latlng, currentProjection);
            
            document.getElementById('coordinateX').textContent = `X: ${coords.x}`;
            document.getElementById('coordinateY').textContent = `Y: ${coords.y}`;
        }
        
        // Koordinat dönüştürme
        function convertCoordinates(latlng, targetProjection) {
            let x, y;
            
            switch(targetProjection) {
                case 'EPSG:4326': // WGS84
                    x = latlng.lng.toFixed(6);
                    y = latlng.lat.toFixed(6);
                    break;
                    
                case 'EPSG:3857': // Web Mercator
                    const webMercator = proj4('EPSG:4326', 'EPSG:3857', [latlng.lng, latlng.lat]);
                    x = webMercator[0].toFixed(2);
                    y = webMercator[1].toFixed(2);
                    break;
                    
                case 'EPSG:5254': // ITRF96 / UTM 35N
                    const itrf96 = proj4('EPSG:4326', 'EPSG:5254', [latlng.lng, latlng.lat]);
                    x = itrf96[0].toFixed(2);
                    y = itrf96[1].toFixed(2);
                    break;
                    
                case 'EPSG:2320': // ED50 / TM30
                    const ed50 = proj4('EPSG:4326', 'EPSG:2320', [latlng.lng, latlng.lat]);
                    x = ed50[0].toFixed(2);
                    y = ed50[1].toFixed(2);
                    break;
                    
                case 'EPSG:32635': // WGS84 / UTM 35N
                    const utm35n = proj4('EPSG:4326', 'EPSG:32635', [latlng.lng, latlng.lat]);
                    x = utm35n[0].toFixed(2);
                    y = utm35n[1].toFixed(2);
                    break;
                    
                case 'EPSG:32636': // WGS84 / UTM 36N
                    const utm36n = proj4('EPSG:4326', 'EPSG:32636', [latlng.lng, latlng.lat]);
                    x = utm36n[0].toFixed(2);
                    y = utm36n[1].toFixed(2);
                    break;
                    
                default:
                    x = latlng.lng.toFixed(6);
                    y = latlng.lat.toFixed(6);
            }
            
            return { x, y };
        }
        
        // Ölçek gösterimi
        function setupScaleDisplay() {
            map.on('zoomend', function() {
                // Her zoom değişikliğinde ölçeği güncelle
                updateScaleDisplay();
            });
            
            map.on('moveend', updateScaleDisplay);
            
            // İlk yükleme
            updateScaleDisplay();
        }
        
        // Ölçeği güncelle
        function updateScaleDisplay() {
            const zoom = map.getZoom();
            const center = map.getCenter();
            const scale = getScaleFromZoom(zoom, center.lat);
            
            document.getElementById('scaleText').textContent = `1:${Math.round(scale).toLocaleString()}`;
            updateScaleBar(Math.round(scale));
        }
        
        // Zoom seviyesinden ölçek hesaplama
        function getScaleFromZoom(zoom, latitude) {
            // Leaflet'in kullandığı gerçek formül
            const earthCircumference = 40075016.686; // metre
            const latRad = latitude * Math.PI / 180;
            
            // Zoom seviyesinde 1 pikselin karşılık geldiği metre
            const metersPerPixel = earthCircumference * Math.cos(latRad) / Math.pow(2, zoom + 8);
            
            // Ölçek hesaplama (96 DPI)
            const scale = metersPerPixel * 96 / 0.0254;
            
            return scale;
        }
        
        // Ölçek çubuğunu güncelle
        function updateScaleBar(scale) {
            const scaleBar = document.getElementById('scaleBar');
            
            // Ölçek çubuğu için uygun mesafe hesapla
            let distance, unit;
            
            if (scale > 1000000) {
                distance = Math.round(scale / 1000000);
                unit = 'km';
            } else if (scale > 1000) {
                distance = Math.round(scale / 1000);
                unit = 'km';
            } else {
                distance = Math.round(scale);
                unit = 'm';
            }
            
            // Çubuğun genişliğini ayarla (100px sabit)
            scaleBar.style.width = '100px';
            
            // Çubuk üzerine mesafe bilgisini ekle
            scaleBar.title = `${distance} ${unit}`;
        }
        
        // Projeksiyon sistemi kurulumu
        function setupProjectionSystem() {
            // Proj4 tanımlamaları
            if (typeof proj4 !== 'undefined') {
                // Türkiye için yaygın projeksiyon sistemleri
                proj4.defs('EPSG:5254', '+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
                proj4.defs('EPSG:2320', '+proj=tmerc +lat_0=0 +lon_0=30 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs');
                proj4.defs('EPSG:32635', '+proj=utm +zone=35 +datum=WGS84 +units=m +no_defs');
                proj4.defs('EPSG:32636', '+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs');
            }
            
            // Varsayılan projeksiyon seç
            document.getElementById('projectionSelect').value = currentProjection;
        }
        
        // Projeksiyon değiştirme
        function changeProjection() {
            const newProjection = document.getElementById('projectionSelect').value;
            currentProjection = newProjection;
            
            // Mevcut mouse pozisyonunu güncelle
            const center = map.getCenter();
            updateCoordinateDisplay(center);
            
            showToast(`Projeksiyon sistemi ${newProjection} olarak değiştirildi`, 'info');
        }
        
        // Çift tıklama (artık gereksiz)
        function switchToDynamicScale() {
            showToast('Ölçek zaten dinamik olarak hesaplanıyor', 'info');
        }
        
        // === ÖLÇEK SEÇİCİ FONKSİYONLARI ===
        
        // Ölçek seçiciyi aç/kapat
        function toggleScaleSelector(event) {
            const selector = document.getElementById('scaleSelector');
            const scaleText = document.getElementById('scaleText');
            
            if (selector.classList.contains('show')) {
                selector.classList.remove('show');
            } else {
                // Önce menüyü göster ki boyutlarını alabilelim
                selector.style.display = 'block';
                selector.style.visibility = 'hidden';
                
                // Tıklanan elementin pozisyonunu al
                const rect = scaleText.getBoundingClientRect();
                
                // Menü boyutlarını al
                const selectorWidth = selector.offsetWidth;
                const selectorHeight = selector.offsetHeight;
                
                // Başlangıç pozisyonu: tıklanan yerin altı
                let left = rect.left;
                let top = rect.bottom + 5;
                
                // Ekran sınırlarını kontrol et
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // Sağ taraftan taşıyorsa sola kaydır
                if (left + selectorWidth > windowWidth) {
                    left = windowWidth - selectorWidth - 10;
                }
                
                // Sol taraftan taşıyorsa sağa kaydır
                if (left < 10) {
                    left = 10;
                }
                
                // Alt taraftan taşıyorsa üste aç
                if (top + selectorHeight > windowHeight) {
                    top = rect.top - selectorHeight - 5;
                }
                
                // Üst taraftan da taşıyorsa en üstte aç
                if (top < 10) {
                    top = 10;
                }
                
                // Pozisyonu ayarla
                selector.style.left = left + 'px';
                selector.style.top = top + 'px';
                
                // Görünür yap
                selector.style.visibility = 'visible';
                selector.classList.add('show');
                
                // Mevcut ölçeği işaretle
                updateCurrentScaleOption();
            }
            
            // Event'in yayılmasını engelle
            if (event) {
                event.stopPropagation();
            }
        }
        
        // Mevcut ölçek seçeneğini işaretle
        function updateCurrentScaleOption() {
            const options = document.querySelectorAll('.scale-option');
            options.forEach(option => option.classList.remove('current'));
            
            // Dinamik ölçek seçeneğini işaretle
            const dynamicOption = document.querySelector('.scale-option strong');
            if (dynamicOption) {
                dynamicOption.parentElement.classList.add('current');
            }
        }
        
        // Sabit ölçek ayarla
        function setFixedScale(scaleValue) {
            const center = map.getCenter();
            
            // Hedef ölçeğe tam karşılık gelen ondalık zoom seviyesini hesapla
            const exactZoom = getZoomFromScale(scaleValue, center.lat);
            
            console.log(`Hedef ölçek: 1:${scaleValue.toLocaleString()}`);
            console.log(`Hesaplanan zoom: ${exactZoom.toFixed(3)}`);
            console.log(`Enlem: ${center.lat.toFixed(4)}`);
            
            // Leaflet ondalık zoom destekliyor, direkt kullan
            map.setZoom(exactZoom);
            
            // Zoom ayarlandıktan sonra gerçek ölçeği kontrol et
            setTimeout(() => {
                const actualZoom = map.getZoom();
                const actualScale = getScaleFromZoom(actualZoom, center.lat);
                const difference = Math.abs(actualScale - scaleValue);
                const percentDiff = ((difference / scaleValue) * 100).toFixed(1);
                
                console.log(`Gerçek zoom: ${actualZoom.toFixed(3)}`);
                console.log(`Gerçek ölçek: 1:${Math.round(actualScale).toLocaleString()}`);
                console.log(`Fark: %${percentDiff}`);
                
                if (percentDiff > 5) {
                    showToast(`Ölçek ayarlandı: 1:${Math.round(actualScale).toLocaleString()} (hedef: 1:${scaleValue.toLocaleString()})`, 'warning');
                } else {
                    showToast(`Ölçek başarıyla ayarlandı: 1:${Math.round(actualScale).toLocaleString()}`, 'success');
                }
            }, 200);
            
            // Seçiciyi kapat
            const selector = document.getElementById('scaleSelector');
            selector.classList.remove('show');
            selector.style.display = 'none';
        }
        
        // Dinamik ölçek (artık her zaman dinamik)
        function setDynamicScale() {
            // Seçiciyi kapat
            const selector = document.getElementById('scaleSelector');
            selector.classList.remove('show');
            selector.style.display = 'none';
            
            // Toast mesajı
            showToast('Ölçek dinamik olarak hesaplanıyor', 'info');
        }
        
        // Ölçekten zoom seviyesi hesapla
        function getZoomFromScale(targetScale, latitude) {
            // Hedef ölçekten metre/piksel hesaplama
            const targetMetersPerPixel = targetScale * 0.0254 / 96;
            
            // Leaflet'in kullandığı formül
            const earthCircumference = 40075016.686; // metre
            const latRad = latitude * Math.PI / 180;
            
            // Zoom = log2(earthCircumference * cos(lat) / metre/piksel) - 8
            const zoom = Math.log2(earthCircumference * Math.cos(latRad) / targetMetersPerPixel) - 8;
            
            // Zoom seviyesini Leaflet'in desteklediği aralığa sınırla
            return Math.max(1, Math.min(18, zoom));
        }
        
        // Dışarı tıklandığında ölçek seçiciyi kapat
        document.addEventListener('click', function(e) {
            const scaleSelector = document.getElementById('scaleSelector');
            const scaleText = document.getElementById('scaleText');
            
            if (scaleSelector && !scaleSelector.contains(e.target) && e.target !== scaleText) {
                scaleSelector.classList.remove('show');
                scaleSelector.style.display = 'none';
            }
        });

        // === LEJANT FONKSİYONLARI ===
        
        let legendVisible = false;
        let legendCollapsed = false;
        let legendDragData = null;

        // Lejantı aç/kapat
        function toggleLegend() {
            const legendContainer = document.getElementById('legendContainer');
            const legendBtn = document.getElementById('legendBtn');
            
            legendVisible = !legendVisible;
            
            if (legendVisible) {
                legendContainer.style.display = 'block';
                legendBtn.classList.add('active');
                legendBtn.title = 'Lejant Kapat';
                updateLegendContent();
            } else {
                legendContainer.style.display = 'none';
                legendBtn.classList.remove('active');
                legendBtn.title = 'Lejant Aç';
            }
        }

        // Lejantı kapat
        function closeLegend() {
            legendVisible = false;
            document.getElementById('legendContainer').style.display = 'none';
            const legendBtn = document.getElementById('legendBtn');
            if (legendBtn) {
                legendBtn.classList.remove('active');
                legendBtn.title = 'Lejant Aç';
            }
        }

        // Lejant içeriğini daralt/genişlet
        function toggleLegendContent() {
            const legendContent = document.getElementById('legendContent');
            const collapseBtn = document.getElementById('legendCollapseBtn');
            
            legendCollapsed = !legendCollapsed;
            
            if (legendCollapsed) {
                legendContent.classList.add('collapsed');
                collapseBtn.textContent = '+';
            } else {
                legendContent.classList.remove('collapsed');
                collapseBtn.textContent = '−';
            }
        }

        // Lejant ayarlarını aç/kapat
        function toggleLegendSettings() {
            const legendSettings = document.getElementById('legendSettings');
            const settingsBtn = document.getElementById('legendSettingsBtn');
            
            if (legendSettings.style.display === 'none') {
                legendSettings.style.display = 'block';
                settingsBtn.style.background = 'rgba(255,255,255,0.3)';
            } else {
                legendSettings.style.display = 'none';
                settingsBtn.style.background = 'none';
            }
        }

        // Lejant sembol boyutu display'ini güncelle
        function updateLegendSymbolSizeDisplay() {
            const sizeInput = document.getElementById('legendSymbolSize');
            const sizeDisplay = document.getElementById('legendSymbolSizeDisplay');
            if (sizeInput && sizeDisplay) {
                sizeDisplay.textContent = sizeInput.value + 'x';
            }
        }

        // Katmandaki gerçek stilleri al
        function getLayerActualStyles(layerId) {
            const features = layerFeatures[layerId] || [];
            const styles = {
                point: { color: '#3388ff', size: 8, shape: 'circle', opacity: 1 },
                line: { color: '#ff7800', width: 3, opacity: 1, type: 'solid' },
                polygon: { fillColor: '#3388ff', fillOpacity: 0.5, strokeColor: '#000000', strokeWidth: 1, strokeOpacity: 1, strokeType: 'solid' }
            };
            
            // İlk çizimden stil bilgilerini al
            features.forEach(feature => {
                if (feature.layer && feature.layer.options && feature.layer.options.styleInfo) {
                    const styleInfo = feature.layer.options.styleInfo;
                    
                    if (feature.type === 'point' && styleInfo.type === 'point') {
                        styles.point = {
                            color: styleInfo.color || styles.point.color,
                            size: styleInfo.size || styles.point.size,
                            shape: styleInfo.shape || styles.point.shape,
                            opacity: styleInfo.opacity || styles.point.opacity
                        };
                    } else if (feature.type === 'line' && styleInfo.type === 'line') {
                        styles.line = {
                            color: styleInfo.color || styles.line.color,
                            width: styleInfo.width || styles.line.width,
                            opacity: styleInfo.opacity || styles.line.opacity,
                            type: styleInfo.lineType || styles.line.type
                        };
                    } else if (feature.type === 'polygon' && styleInfo.type === 'polygon') {
                        styles.polygon = {
                            fillColor: styleInfo.fillColor || styles.polygon.fillColor,
                            fillOpacity: styleInfo.fillOpacity || styles.polygon.fillOpacity,
                            strokeColor: styleInfo.strokeColor || styles.polygon.strokeColor,
                            strokeWidth: styleInfo.strokeWidth || styles.polygon.strokeWidth,
                            strokeOpacity: styleInfo.strokeOpacity || styles.polygon.strokeOpacity,
                            strokeType: styleInfo.strokeType || styles.polygon.strokeType
                        };
                    }
                } else if (feature.layer) {
                    // Doğrudan layer özelliklerinden al
                    if (feature.type === 'line' && feature.layer.options) {
                        styles.line = {
                            color: feature.layer.options.color || styles.line.color,
                            width: feature.layer.options.weight || styles.line.width,
                            opacity: feature.layer.options.opacity || styles.line.opacity,
                            type: detectLineTypeFromDashArray(feature.layer.options.dashArray)
                        };
                    } else if (feature.type === 'polygon' && feature.layer.options) {
                        styles.polygon = {
                            fillColor: feature.layer.options.fillColor || styles.polygon.fillColor,
                            fillOpacity: feature.layer.options.fillOpacity || styles.polygon.fillOpacity,
                            strokeColor: feature.layer.options.color || styles.polygon.strokeColor,
                            strokeWidth: feature.layer.options.weight || styles.polygon.strokeWidth,
                            strokeOpacity: feature.layer.options.opacity || styles.polygon.strokeOpacity,
                            strokeType: detectLineTypeFromDashArray(feature.layer.options.dashArray)
                        };
                    }
                }
            });
            
            return styles;
        }

        // Lejant içeriğini güncelle
        function updateLegendContent() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            // Ayarları al
            const showEmptyLayers = document.getElementById('showEmptyLayers').checked;
            const showTypeLabels = document.getElementById('showTypeLabels').checked;
            const showOnlyVisible = document.getElementById('showOnlyVisible').checked;
            const showSelectedOnly = document.getElementById('showSelectedOnly').checked;
            const symbolScale = parseFloat(document.getElementById('legendSymbolSize').value);

            // Görünür katmanları topla
            const visibleLayers = [];
            
            // DOM'dan katmanları al
            const layerItems = document.querySelectorAll('.layer-item');
            layerItems.forEach(layerItem => {
                const checkbox = layerItem.querySelector('.layer-visibility');
                const groupElement = layerItem.closest('.layer-group');
                const isSelected = layerItem.classList.contains('selected-highlight');
                
                // Filtre koşulları
                let shouldShow = true;
                
                // Sadece seçili katmanı göster ayarı
                if (showSelectedOnly && !isSelected) {
                    shouldShow = false;
                }
                
                // Sadece görünür katmanları göster ayarı
                if (showOnlyVisible && (!checkbox || !checkbox.checked)) {
                    shouldShow = false;
                }
                
                if (shouldShow) {
                    const layerId = layerItem.getAttribute('data-layer-id');
                    const layerName = layerItem.querySelector('.layer-name').textContent;
                    const groupName = groupElement.querySelector('.group-name').textContent;
                    
                    // Katmandaki çizim tiplerini kontrol et
                    const features = layerFeatures[layerId] || [];
                    const hasPoint = features.some(f => f.type === 'point');
                    const hasLine = features.some(f => f.type === 'line');
                    const hasPolygon = features.some(f => f.type === 'polygon');
                    const isEmpty = features.length === 0;
                    
                    // Boş katmanları gösterme ayarına göre filtrele
                    if (!isEmpty || showEmptyLayers) {
                        const actualStyles = getLayerActualStyles(layerId);
                        visibleLayers.push({
                            name: layerName,
                            group: groupName,
                            hasPoint,
                            hasLine,
                            hasPolygon,
                            features: features,
                            isEmpty: isEmpty,
                            isVisible: checkbox && checkbox.checked,
                            isSelected: isSelected,
                            layerId: layerId,
                            styles: actualStyles
                        });
                    }
                }
            });

            if (visibleLayers.length === 0) {
                legendItems.innerHTML = '<div style="text-align: center; color: #666; font-style: italic; padding: 20px;">Görünür katman yok</div>';
                return;
            }

            // Gruplara göre organize et
            const groupedLayers = {};
            visibleLayers.forEach(layer => {
                if (!groupedLayers[layer.group]) {
                    groupedLayers[layer.group] = [];
                }
                groupedLayers[layer.group].push(layer);
            });

            // Lejant öğelerini oluştur
            Object.keys(groupedLayers).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'legend-group';
                
                const groupTitle = document.createElement('div');
                groupTitle.className = 'legend-group-title';
                groupTitle.textContent = groupName;
                groupDiv.appendChild(groupTitle);

                groupedLayers[groupName].forEach(layer => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'legend-item';
                    
                    // Seçili katman vurgusu
                    if (layer.isSelected) {
                        itemDiv.style.backgroundColor = '#e3f2fd';
                        itemDiv.style.border = '1px solid #2196f3';
                        itemDiv.style.borderRadius = '4px';
                        itemDiv.style.padding = '4px';
                    }
                    
                    // Görünür olmayan katman için soluk görünüm
                    if (!layer.isVisible) {
                        itemDiv.style.opacity = '0.5';
                    }
                    
                    // Katman adı ve semboller
                    const headerDiv = document.createElement('div');
                    headerDiv.style.display = 'flex';
                    headerDiv.style.alignItems = 'center';
                    headerDiv.style.marginBottom = showTypeLabels ? '4px' : '0';
                    
                    // Semboller (sadece görsel, yazı yok)
                    if (!layer.isEmpty) {
                        const symbolsDiv = document.createElement('div');
                        symbolsDiv.style.display = 'flex';
                        symbolsDiv.style.gap = '4px';
                        symbolsDiv.style.marginRight = '8px';
                        
                        if (layer.hasPoint) {
                            const pointStyle = layer.styles.point;
                            const pointSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const pointColor = pointStyle.color;
                            const pointSize = Math.round(pointStyle.size * symbolScale * 0.8); // Lejant için biraz küçült
                            const pointOpacity = pointStyle.opacity;
                            
                            pointSymbol.style.backgroundColor = pointColor;
                            pointSymbol.style.opacity = pointOpacity;
                            pointSymbol.style.width = pointSize + 'px';
                            pointSymbol.style.height = pointSize + 'px';
                            
                            // Şekle göre stil
                            if (pointStyle.shape === 'circle') {
                                pointSymbol.style.borderRadius = '50%';
                            } else if (pointStyle.shape === 'square') {
                                pointSymbol.style.borderRadius = '0';
                            } else if (pointStyle.shape === 'triangle') {
                                // Üçgen için özel CSS
                                pointSymbol.style.width = '0';
                                pointSymbol.style.height = '0';
                                pointSymbol.style.backgroundColor = 'transparent';
                                pointSymbol.style.borderLeft = `${pointSize/2}px solid transparent`;
                                pointSymbol.style.borderRight = `${pointSize/2}px solid transparent`;
                                pointSymbol.style.borderBottom = `${pointSize}px solid ${pointColor}`;
                            }
                            
                            symbolsDiv.appendChild(pointSymbol);
                        }
                        
                        if (layer.hasLine) {
                            const lineStyle = layer.styles.line;
                            const lineSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const lineColor = lineStyle.color;
                            const lineWidth = Math.max(1, Math.round(lineStyle.width * symbolScale * 0.5)); // Lejant için küçült
                            const lineOpacity = lineStyle.opacity;
                            const lineType = lineStyle.type;
                            
                            lineSymbol.style.backgroundColor = lineColor;
                            lineSymbol.style.opacity = lineOpacity;
                            lineSymbol.style.height = lineWidth + 'px';
                            lineSymbol.style.width = Math.round(12 * symbolScale) + 'px';
                            lineSymbol.style.marginTop = '3px';
                            
                            // Çizgi tipine göre border pattern
                            if (lineType === 'dashed') {
                                lineSymbol.style.background = `repeating-linear-gradient(to right, ${lineColor} 0px, ${lineColor} 4px, transparent 4px, transparent 6px)`;
                            } else if (lineType === 'dotted') {
                                lineSymbol.style.background = `repeating-linear-gradient(to right, ${lineColor} 0px, ${lineColor} 2px, transparent 2px, transparent 4px)`;
                            }
                            
                            symbolsDiv.appendChild(lineSymbol);
                        }
                        
                        if (layer.hasPolygon) {
                            const polygonStyle = layer.styles.polygon;
                            const polygonSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const fillColor = polygonStyle.fillColor;
                            const fillOpacity = polygonStyle.fillOpacity;
                            const strokeColor = polygonStyle.strokeColor;
                            const strokeWidth = Math.max(1, Math.round(polygonStyle.strokeWidth * symbolScale));
                            const strokeOpacity = polygonStyle.strokeOpacity;
                            const strokeType = polygonStyle.strokeType;
                            
                            const rgba = hexToRgba(fillColor, fillOpacity);
                            polygonSymbol.style.backgroundColor = rgba;
                            polygonSymbol.style.border = `${strokeWidth}px solid ${strokeColor}`;
                            polygonSymbol.style.width = Math.round(10 * symbolScale) + 'px';
                            polygonSymbol.style.height = Math.round(8 * symbolScale) + 'px';
                            
                            // Kenar tipine göre border style
                            if (strokeType === 'dashed') {
                                polygonSymbol.style.borderStyle = 'dashed';
                            } else if (strokeType === 'dotted') {
                                polygonSymbol.style.borderStyle = 'dotted';
                            }
                            
                            symbolsDiv.appendChild(polygonSymbol);
                        }
                        
                        headerDiv.appendChild(symbolsDiv);
                    }
                    
                    // Katman adı
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'legend-label';
                    labelDiv.textContent = layer.name;
                    labelDiv.style.fontWeight = '400';
                    labelDiv.style.fontSize = '12px';
                    labelDiv.style.flex = '1';
                    headerDiv.appendChild(labelDiv);
                    
                    itemDiv.appendChild(headerDiv);
                    
                    // Boş katman kontrolü
                    if (layer.isEmpty) {
                        const emptyItem = document.createElement('div');
                        emptyItem.style.marginLeft = '10px';
                        emptyItem.style.fontSize = '11px';
                        emptyItem.style.color = '#999';
                        emptyItem.style.fontStyle = 'italic';
                        emptyItem.textContent = 'Henüz çizim yok';
                        itemDiv.appendChild(emptyItem);
                    } else if (showTypeLabels) {
                        // Çizim tiplerini yazı ile göster (sadece ayar açıksa)
                        if (layer.hasPoint) {
                            const pointItem = document.createElement('div');
                            pointItem.style.display = 'flex';
                            pointItem.style.alignItems = 'center';
                            pointItem.style.marginBottom = '2px';
                            pointItem.style.marginLeft = '10px';
                            
                            const pointSymbol = document.createElement('div');
                            pointSymbol.style.backgroundColor = '#3388ff';
                            pointSymbol.style.borderRadius = '50%';
                            pointSymbol.style.width = '8px';
                            pointSymbol.style.height = '8px';
                            pointSymbol.style.marginRight = '6px';
                            
                            const pointLabel = document.createElement('span');
                            pointLabel.textContent = 'Nokta';
                            pointLabel.style.fontSize = '11px';
                            pointLabel.style.color = '#666';
                            
                            pointItem.appendChild(pointSymbol);
                            pointItem.appendChild(pointLabel);
                            itemDiv.appendChild(pointItem);
                        }
                        
                        if (layer.hasLine) {
                            const lineItem = document.createElement('div');
                            lineItem.style.display = 'flex';
                            lineItem.style.alignItems = 'center';
                            lineItem.style.marginBottom = '2px';
                            lineItem.style.marginLeft = '10px';
                            
                            const lineSymbol = document.createElement('div');
                            lineSymbol.style.backgroundColor = '#ff7800';
                            lineSymbol.style.height = '2px';
                            lineSymbol.style.width = '12px';
                            lineSymbol.style.marginRight = '6px';
                            lineSymbol.style.marginTop = '0';
                            
                            const lineLabel = document.createElement('span');
                            lineLabel.textContent = 'Çizgi';
                            lineLabel.style.fontSize = '11px';
                            lineLabel.style.color = '#666';
                            
                            lineItem.appendChild(lineSymbol);
                            lineItem.appendChild(lineLabel);
                            itemDiv.appendChild(lineItem);
                        }
                        
                        if (layer.hasPolygon) {
                            const polygonItem = document.createElement('div');
                            polygonItem.style.display = 'flex';
                            polygonItem.style.alignItems = 'center';
                            polygonItem.style.marginBottom = '2px';
                            polygonItem.style.marginLeft = '10px';
                            
                            const polygonSymbol = document.createElement('div');
                            polygonSymbol.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                            polygonSymbol.style.border = '1px solid #ff0000';
                            polygonSymbol.style.width = '12px';
                            polygonSymbol.style.height = '8px';
                            polygonSymbol.style.marginRight = '6px';
                            
                            const polygonLabel = document.createElement('span');
                            polygonLabel.textContent = 'Alan';
                            polygonLabel.style.fontSize = '11px';
                            polygonLabel.style.color = '#666';
                            
                            polygonItem.appendChild(polygonSymbol);
                            polygonItem.appendChild(polygonLabel);
                            itemDiv.appendChild(polygonItem);
                        }
                    }

                    groupDiv.appendChild(itemDiv);
                });

                legendItems.appendChild(groupDiv);
            });
        }

        // Varsayılan stil al
        function getDefaultStyle(layerType) {
            const defaultStyles = {
                point: { color: '#3388ff', fillColor: '#3388ff' },
                line: { color: '#3388ff' },
                polygon: { color: '#3388ff', fillColor: '#3388ff' }
            };
            return defaultStyles[layerType] || defaultStyles.point;
        }

        // Lejant sürükleme işlevselliği
        function initLegendDragging() {
            const legendHeader = document.getElementById('legendHeader');
            const legendContainer = document.getElementById('legendContainer');
            
            legendHeader.addEventListener('mousedown', function(e) {
                legendDragData = {
                    isDragging: true,
                    startX: e.clientX,
                    startY: e.clientY,
                    startLeft: legendContainer.offsetLeft,
                    startTop: legendContainer.offsetTop
                };
                
                document.addEventListener('mousemove', handleLegendDrag);
                document.addEventListener('mouseup', handleLegendDragEnd);
                
                e.preventDefault();
            });
        }

        function handleLegendDrag(e) {
            if (!legendDragData || !legendDragData.isDragging) return;
            
            const deltaX = e.clientX - legendDragData.startX;
            const deltaY = e.clientY - legendDragData.startY;
            
            const newLeft = legendDragData.startLeft + deltaX;
            const newTop = legendDragData.startTop + deltaY;
            
            const legendContainer = document.getElementById('legendContainer');
            const maxLeft = window.innerWidth - legendContainer.offsetWidth;
            const maxTop = window.innerHeight - legendContainer.offsetHeight;
            
            legendContainer.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + 'px';
            legendContainer.style.top = Math.max(0, Math.min(maxTop, newTop)) + 'px';
        }

        function handleLegendDragEnd() {
            legendDragData = null;
            document.removeEventListener('mousemove', handleLegendDrag);
            document.removeEventListener('mouseup', handleLegendDragEnd);
        }

        // ===== ÖLÇÜM AYARLARI FONKSİYONLARI =====
        
        // Ölçüm ayarları modalını aç
        function openMeasurementSettings() {
            const modal = document.getElementById('measurementSettingsModal');
            if (modal) {
                modal.style.display = 'block';
                // Mevcut ayarları modal elementlerine yükle
                loadMeasurementSettingsToModal();
                showNotification('Ölçüm ayarları açıldı', 'info');
            }
        }
        
        // Ölçüm ayarları modalını kapat
        function closeMeasurementSettings() {
            const modal = document.getElementById('measurementSettingsModal');
            if (modal) {
                modal.style.display = 'none';
                showNotification('Ölçüm ayarları kaydedildi', 'success');
            }
        }
        
        // Mevcut ayarları modal'a yükle
        function loadMeasurementSettingsToModal() {
            // Mesafe etiket pozisyonu
            const distancePosSelect = document.getElementById('distanceLabelPosition');
            if (distancePosSelect) {
                distancePosSelect.value = MeasurementSettings.distance.labelPosition;
            }
            
            // Alan etiket pozisyonu
            const areaPosSelect = document.getElementById('areaLabelPosition');
            if (areaPosSelect) {
                areaPosSelect.value = MeasurementSettings.area.labelPosition;
            }
            
            // Segment sıklığı
            const segmentFreq = document.getElementById('segmentLabelFrequency');
            const segmentFreqValue = document.getElementById('segmentFrequencyValue');
            if (segmentFreq && segmentFreqValue) {
                segmentFreq.value = MeasurementSettings.labels.frequency;
                segmentFreqValue.textContent = MeasurementSettings.labels.frequency;
            }
            
            // Minimum segment uzunluğu
            const minSegment = document.getElementById('minSegmentLength');
            const minSegmentValue = document.getElementById('minSegmentValue');
            if (minSegment && minSegmentValue) {
                minSegment.value = MeasurementSettings.labels.minSegmentLength;
                minSegmentValue.textContent = MeasurementSettings.labels.minSegmentLength;
            }
            
            // Etiket boyutu
            const labelSize = document.getElementById('labelSize');
            const labelSizeValue = document.getElementById('labelSizeValue');
            if (labelSize && labelSizeValue) {
                labelSize.value = MeasurementSettings.labels.size;
                labelSizeValue.textContent = MeasurementSettings.labels.size + 'px';
            }
            
            // Arka plan göster
            const labelBg = document.getElementById('labelBackground');
            if (labelBg) {
                labelBg.checked = MeasurementSettings.labels.showBackground;
            }
            
            // Etiket rengi
            const labelColor = document.getElementById('labelColor');
            if (labelColor) {
                labelColor.value = MeasurementSettings.labels.color;
            }
            
            // Arka plan rengi
            const labelBgColor = document.getElementById('labelBackgroundColor');
            if (labelBgColor) {
                labelBgColor.value = MeasurementSettings.labels.backgroundColor;
            }
            
            // Mesafe birimi
            const distanceUnit = document.getElementById('distanceUnit');
            if (distanceUnit) {
                distanceUnit.value = MeasurementSettings.distance.unit;
            }
            
            // Alan birimi
            const areaUnit = document.getElementById('areaUnit');
            if (areaUnit) {
                areaUnit.value = MeasurementSettings.area.unit;
            }
            
            // Anlık güncelleme
            const liveUpdate = document.getElementById('liveUpdate');
            if (liveUpdate) {
                liveUpdate.checked = MeasurementSettings.general.liveUpdate;
            }
            
            // Toplam mesafe göster
            const showTotal = document.getElementById('showTotal');
            if (showTotal) {
                showTotal.checked = MeasurementSettings.distance.showTotal;
            }
            
            // Kısmi mesafeler göster
            const showPartial = document.getElementById('showPartial');
            if (showPartial) {
                showPartial.checked = MeasurementSettings.distance.showPartial;
            }
        }
        
        // Ölçüm ayarlarını güncelle
        function updateMeasurementSettings() {
            // Mesafe etiket pozisyonu
            const distancePosSelect = document.getElementById('distanceLabelPosition');
            if (distancePosSelect) {
                MeasurementSettings.distance.labelPosition = distancePosSelect.value;
            }
            
            // Alan etiket pozisyonu
            const areaPosSelect = document.getElementById('areaLabelPosition');
            if (areaPosSelect) {
                MeasurementSettings.area.labelPosition = areaPosSelect.value;
            }
            
            // Segment sıklığı
            const segmentFreq = document.getElementById('segmentLabelFrequency');
            const segmentFreqValue = document.getElementById('segmentFrequencyValue');
            if (segmentFreq && segmentFreqValue) {
                MeasurementSettings.labels.frequency = parseInt(segmentFreq.value);
                segmentFreqValue.textContent = segmentFreq.value;
            }
            
            // Minimum segment uzunluğu
            const minSegment = document.getElementById('minSegmentLength');
            const minSegmentValue = document.getElementById('minSegmentValue');
            if (minSegment && minSegmentValue) {
                MeasurementSettings.labels.minSegmentLength = parseInt(minSegment.value);
                minSegmentValue.textContent = minSegment.value;
            }
            
            // Etiket boyutu
            const labelSize = document.getElementById('labelSize');
            const labelSizeValue = document.getElementById('labelSizeValue');
            if (labelSize && labelSizeValue) {
                MeasurementSettings.labels.size = parseInt(labelSize.value);
                labelSizeValue.textContent = labelSize.value + 'px';
            }
            
            // Arka plan göster
            const labelBg = document.getElementById('labelBackground');
            if (labelBg) {
                MeasurementSettings.labels.showBackground = labelBg.checked;
            }
            
            // Etiket rengi
            const labelColor = document.getElementById('labelColor');
            if (labelColor) {
                MeasurementSettings.labels.color = labelColor.value;
            }
            
            // Arka plan rengi
            const labelBgColor = document.getElementById('labelBackgroundColor');
            if (labelBgColor) {
                MeasurementSettings.labels.backgroundColor = labelBgColor.value;
            }
            
            // Mesafe birimi
            const distanceUnit = document.getElementById('distanceUnit');
            if (distanceUnit) {
                MeasurementSettings.distance.unit = distanceUnit.value;
            }
            
            // Alan birimi
            const areaUnit = document.getElementById('areaUnit');
            if (areaUnit) {
                MeasurementSettings.area.unit = areaUnit.value;
            }
            
            // Anlık güncelleme
            const liveUpdate = document.getElementById('liveUpdate');
            if (liveUpdate) {
                MeasurementSettings.general.liveUpdate = liveUpdate.checked;
            }
            
            // Toplam mesafe göster
            const showTotal = document.getElementById('showTotal');
            if (showTotal) {
                MeasurementSettings.distance.showTotal = showTotal.checked;
            }
            
            // Kısmi mesafeler göster
            const showPartial = document.getElementById('showPartial');
            if (showPartial) {
                MeasurementSettings.distance.showPartial = showPartial.checked;
            }
            
            // Eğer aktif bir ölçüm varsa yeniden çiz
            if (measurementTool && measurementTool.isActive) {
                if (measurementTool.currentTool === 'distance' && measurementTool.currentPoints.length >= 2) {
                    measurementTool.updateDistanceMeasurement();
                } else if (measurementTool.currentTool === 'area' && measurementTool.currentPoints.length >= 3) {
                    measurementTool.updateAreaMeasurement();
                }
                showNotification('Ölçüm etiketleri güncellendi', 'info');
            }
        }
        
        // Varsayılan ayarlara döndür
        function resetMeasurementSettings() {
            // Varsayılan değerleri ayarla
            MeasurementSettings.distance.labelPosition = 'center';
            MeasurementSettings.distance.showTotal = true;
            MeasurementSettings.distance.showPartial = false;
            MeasurementSettings.distance.unit = 'auto';
            
            MeasurementSettings.area.labelPosition = 'center';
            MeasurementSettings.area.unit = 'auto';
            
            MeasurementSettings.labels.size = 12;
            MeasurementSettings.labels.color = '#ffffff';
            MeasurementSettings.labels.backgroundColor = '#000000';
            MeasurementSettings.labels.showBackground = true;
            MeasurementSettings.labels.frequency = 3;
            MeasurementSettings.labels.minSegmentLength = 100;
            
            MeasurementSettings.general.liveUpdate = true;
            
            // Modal'ı güncelle
            loadMeasurementSettingsToModal();
            
            // Aktif ölçümü güncelle
            updateMeasurementSettings();
            
            showNotification('Ayarlar varsayılan değerlere döndürüldü', 'success');
        }

        // Modal kapama - ESC tuşu
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const measurementModal = document.getElementById('measurementSettingsModal');
                if (measurementModal && measurementModal.style.display === 'block') {
                    closeMeasurementSettings();
                }
            }
        });

        // Modal dışına tıklama ile kapama
        document.addEventListener('click', function(e) {
            const measurementModal = document.getElementById('measurementSettingsModal');
            if (measurementModal && e.target === measurementModal) {
                closeMeasurementSettings();
            }
        });

        // ====================================
        // DEMO VERİ VE TEMATİK HARİTA SİSTEMİ
        // ====================================

        // Demo menüyü aç/kapa
        function toggleDemoMenu() {
            const menu = document.getElementById('demoMenu');
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
            }
        }

        // Demo veri oluştur
        function createDemoData(type) {
            const validation = validateName("Demo " + type);
            if (!validation.valid) return;

            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} demo verisi oluşturuluyor...`, 'info');

            // Demo Grup Oluştur
            const groupId = 'demo-group-' + Date.now();
            createDemoGroup(groupId, `📊 Demo: ${type.toUpperCase()}`);

            setTimeout(() => {
                switch(type) {
                    case 'nufus':
                        createNufusDemoData(groupId);
                        break;
                    case 'gelir':
                        createGelirDemoData(groupId);
                        break;
                    case 'kategori':
                        createKategoriDemoData(groupId);
                        break;
                    case 'sicaklik':
                        createSicaklikDemoData(groupId);
                        break;
                }

                showNotification(`${type.toUpperCase()} demo verisi oluşturuldu!`, 'success');
                toggleDemoMenu();
            }, 300);
        }

        // Demo grup oluştur
        function createDemoGroup(groupId, groupName) {
            const groupContainer = document.querySelector('#layerList');
            const layerGroup = document.createElement('div');
            layerGroup.className = 'layer-group';
            layerGroup.setAttribute('data-group-id', groupId);

            layerGroup.innerHTML = `
                <div class="group-header">
                    <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                        <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                    </div>
                    <div class="group-select-area" onclick="selectGroup(this)">
                        <span class="group-name">${groupName}</span>
                        <span class="group-count">0</span>
                    </div>
                    <div class="group-toggle-area" onclick="toggleGroup(this)">
                        <span class="group-icon">▼</span>
                    </div>
                </div>
                <div class="group-items"></div>
            `;

            groupContainer.appendChild(layerGroup);
        }

        // Nüfus dağılımı demo verisi
        function createNufusDemoData(groupId) {
            const center = map.getCenter();
            const data = [
                { name: 'Merkez İlçe', value: 125000, offset: [0, 0] },
                { name: 'Kuzey Bölge', value: 85000, offset: [0.02, 0.02] },
                { name: 'Güney Bölge', value: 95000, offset: [0, -0.02] },
                { name: 'Doğu Bölge', value: 62000, offset: [0.02, 0] },
                { name: 'Batı Bölge', value: 48000, offset: [-0.02, 0] }
            ];

            data.forEach(item => {
                const lat = center.lat + item.offset[0];
                const lng = center.lng + item.offset[1];

                const circle = L.circleMarker([lat, lng], {
                    radius: Math.sqrt(item.value) / 30,
                    fillColor: '#3388ff',
                    fillOpacity: 0.6,
                    color: '#fff',
                    weight: 2
                }).addTo(drawnItems);

                circle.bindPopup(`<b>${item.name}</b><br>Nüfus: ${item.value.toLocaleString()}`);

                addDemoLayerToGroup(groupId, item.name, circle, {
                    type: 'point',
                    value: item.value,
                    category: 'nüfus'
                });
            });

            map.fitBounds(drawnItems.getBounds());
        }

        // Gelir düzeyi demo verisi
        function createGelirDemoData(groupId) {
            const center = map.getCenter();
            const data = [
                { name: 'Yüksek Gelir', value: 8500, coords: [[0.01, 0.01], [0.02, 0.01], [0.02, 0.02], [0.01, 0.02]] },
                { name: 'Orta-Üst Gelir', value: 6200, coords: [[-0.01, 0.01], [0, 0.01], [0, 0.02], [-0.01, 0.02]] },
                { name: 'Orta Gelir', value: 4800, coords: [[0.01, -0.01], [0.02, -0.01], [0.02, 0], [0.01, 0]] },
                { name: 'Orta-Alt Gelir', value: 3400, coords: [[-0.01, -0.01], [0, -0.01], [0, 0], [-0.01, 0]] },
                { name: 'Düşük Gelir', value: 2100, coords: [[-0.02, -0.01], [-0.01, -0.01], [-0.01, 0], [-0.02, 0]] }
            ];

            data.forEach(item => {
                const latlngs = item.coords.map(c => [center.lat + c[0], center.lng + c[1]]);

                const polygon = L.polygon(latlngs, {
                    fillColor: '#3388ff',
                    fillOpacity: 0.5,
                    color: '#333',
                    weight: 2
                }).addTo(drawnItems);

                polygon.bindPopup(`<b>${item.name}</b><br>Ortalama: ${item.value.toLocaleString()} TL`);

                addDemoLayerToGroup(groupId, item.name, polygon, {
                    type: 'polygon',
                    value: item.value,
                    category: 'gelir'
                });
            });

            map.fitBounds(drawnItems.getBounds());
        }

        // Kategorik veri demo verisi
        function createKategoriDemoData(groupId) {
            const center = map.getCenter();
            const categories = [
                { name: 'Park', color: '#2ecc71', icon: '🌳', offset: [0.015, 0.015] },
                { name: 'Okul', color: '#3498db', icon: '🏫', offset: [-0.015, 0.015] },
                { name: 'Hastane', color: '#e74c3c', icon: '🏥', offset: [0.015, -0.015] },
                { name: 'Alışveriş', color: '#f39c12', icon: '🛍️', offset: [-0.015, -0.015] },
                { name: 'Spor Tesisi', color: '#9b59b6', icon: '⚽', offset: [0, 0.02] },
                { name: 'Kültür Merkezi', color: '#16a085', icon: '🎭', offset: [0, -0.02] }
            ];

            categories.forEach(cat => {
                const lat = center.lat + cat.offset[0];
                const lng = center.lng + cat.offset[1];

                const marker = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: cat.color,
                    fillOpacity: 0.8,
                    color: '#fff',
                    weight: 3
                }).addTo(drawnItems);

                marker.bindPopup(`<b>${cat.icon} ${cat.name}</b><br>Kategori: ${cat.name}`);

                addDemoLayerToGroup(groupId, cat.name, marker, {
                    type: 'point',
                    category: cat.name,
                    color: cat.color
                });
            });

            map.fitBounds(drawnItems.getBounds());
        }

        // Sıcaklık haritası demo verisi
        function createSicaklikDemoData(groupId) {
            const center = map.getCenter();
            const temps = [
                { temp: 32, offset: [0.02, 0] },
                { temp: 28, offset: [0.015, 0.015] },
                { temp: 24, offset: [0, 0.02] },
                { temp: 20, offset: [-0.015, 0.015] },
                { temp: 16, offset: [-0.02, 0] },
                { temp: 12, offset: [-0.015, -0.015] },
                { temp: 8, offset: [0, -0.02] }
            ];

            temps.forEach(item => {
                const lat = center.lat + item.offset[0];
                const lng = center.lng + item.offset[1];

                const circle = L.circleMarker([lat, lng], {
                    radius: 12,
                    fillColor: '#3388ff',
                    fillOpacity: 0.6,
                    color: '#fff',
                    weight: 2
                }).addTo(drawnItems);

                circle.bindPopup(`<b>Sıcaklık</b><br>${item.temp}°C`);

                addDemoLayerToGroup(groupId, `${item.temp}°C`, circle, {
                    type: 'point',
                    value: item.temp,
                    category: 'sıcaklık'
                });
            });

            map.fitBounds(drawnItems.getBounds());
        }

        // Demo katman oluştur ve gruba ekle
        function addDemoLayerToGroup(groupId, layerName, layer, properties) {
            const targetGroup = document.querySelector(`[data-group-id="${groupId}"]`);
            if (!targetGroup) return;

            const layerId = 'demo-layer-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            layerItem.setAttribute('data-layer-id', layerId);

            layerItem.innerHTML = `
                <input type="checkbox" class="layer-visibility" checked>
                <div class="layer-selectable-area">
                    <div class="layer-icons">
                        <div class="layer-icon ${properties.type === 'point' ? 'active' : 'inactive'}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="8"/>
                            </svg>
                        </div>
                        <div class="layer-icon inactive">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M2 8 L8 8 L12 16 L16 16 L22 8" fill="none" stroke="currentColor" stroke-width="3"/>
                            </svg>
                        </div>
                        <div class="layer-icon ${properties.type === 'polygon' ? 'active' : 'inactive'}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                    <span class="layer-name">${layerName}</span>
                </div>
            `;

            targetGroup.querySelector('.group-items').appendChild(layerItem);

            // Layer'ı kaydet
            drawnLayers.push({
                layerId: layerId,
                groupId: groupId,
                layer: layer,
                properties: properties
            });

            // Grup sayacını güncelle
            updateGroupLayerCount(targetGroup);
        }

        // Tematik harita uygula
        function applyThematicMap(type) {
            showNotification(`${type} tematik harita uygulanıyor...`, 'info');

            setTimeout(() => {
                switch(type) {
                    case 'quantile':
                        applyQuantileColors();
                        break;
                    case 'category':
                        applyCategoryColors();
                        break;
                    case 'heatmap':
                        applyHeatmapStyle();
                        break;
                }

                showNotification(`Tematik harita uygulandı!`, 'success');
                toggleDemoMenu();
            }, 300);
        }

        // Değer aralıklarına göre renklendirme
        function applyQuantileColors() {
            const layersWithValues = drawnLayers.filter(l => l.properties && l.properties.value !== undefined);

            if (layersWithValues.length === 0) {
                showNotification('Değer içeren katman bulunamadı!', 'warning');
                return;
            }

            const values = layersWithValues.map(l => l.properties.value).sort((a, b) => a - b);
            const colors = ['#313695', '#4575b4', '#91cf60', '#fee08b', '#fc8d59', '#d73027'];

            layersWithValues.forEach(layerInfo => {
                const value = layerInfo.properties.value;
                const index = Math.floor((values.indexOf(value) / values.length) * colors.length);
                const color = colors[Math.min(index, colors.length - 1)];

                if (layerInfo.layer.setStyle) {
                    layerInfo.layer.setStyle({
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.7
                    });
                }
            });
        }

        // Kategorik renklendirme
        function applyCategoryColors() {
            const categoryColors = {
                'Park': '#2ecc71',
                'Okul': '#3498db',
                'Hastane': '#e74c3c',
                'Alışveriş': '#f39c12',
                'Spor Tesisi': '#9b59b6',
                'Kültür Merkezi': '#16a085',
                'default': '#95a5a6'
            };

            drawnLayers.forEach(layerInfo => {
                if (layerInfo.properties && layerInfo.properties.category) {
                    const color = categoryColors[layerInfo.properties.category] || categoryColors.default;

                    if (layerInfo.layer.setStyle) {
                        layerInfo.layer.setStyle({
                            fillColor: color,
                            color: '#fff',
                            weight: 2,
                            fillOpacity: 0.8
                        });
                    }
                }
            });
        }

        // Isı haritası stili
        function applyHeatmapStyle() {
            const layersWithValues = drawnLayers.filter(l => l.properties && l.properties.value !== undefined);

            if (layersWithValues.length === 0) {
                showNotification('Değer içeren katman bulunamadı!', 'warning');
                return;
            }

            const values = layersWithValues.map(l => l.properties.value);
            const min = Math.min(...values);
            const max = Math.max(...values);

            layersWithValues.forEach(layerInfo => {
                const value = layerInfo.properties.value;
                const normalized = (value - min) / (max - min);

                // Soğuktan sıcağa gradient
                const r = Math.floor(255 * normalized);
                const b = Math.floor(255 * (1 - normalized));
                const color = `rgb(${r}, 100, ${b})`;

                if (layerInfo.layer.setStyle) {
                    layerInfo.layer.setStyle({
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.6,
                        radius: 8 + normalized * 8 // Boyut da değere göre
                    });
                }
            });
        }

        // Demo veriyi temizle
        function clearDemoData() {
            if (!confirm('Tüm demo verileri silinecek. Emin misiniz?')) {
                return;
            }

            // Demo gruplarını ve katmanlarını bul
            const demoGroups = document.querySelectorAll('[data-group-id^="demo-group-"]');

            demoGroups.forEach(group => {
                const groupId = group.getAttribute('data-group-id');

                // Bu gruptaki katmanları haritadan kaldır
                drawnLayers = drawnLayers.filter(layerInfo => {
                    if (layerInfo.groupId === groupId) {
                        map.removeLayer(layerInfo.layer);
                        return false;
                    }
                    return true;
                });

                // Grubu DOM'dan kaldır
                group.remove();
            });

            showNotification('Tüm demo verileri temizlendi', 'success');
            toggleDemoMenu();
        }

    </script>
    
    <!-- Proj4 kütüphanesi koordinat dönüşümleri için - Embedded -->
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):t.proj4=s()}(this,function(){"use strict";function t(t,s){if(t[s])return t[s];for(var i,a=Object.keys(t),h=s.toLowerCase().replace(Ot,""),e=-1;++e<a.length;)if(i=a[e],i.toLowerCase().replace(Ot,"")===h)return t[i]}function s(t){if("string"!=typeof t)throw new Error("not a string");this.text=t.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=qt}function i(t){return new s(t).output()}function a(t,s,i){Array.isArray(s)&&(i.unshift(s),s=null);var a=s?{}:t,e=i.reduce(function(t,s){return h(s,t),t},a);s&&(t[s]=e)}function h(t,s){if(Array.isArray(t)){var i=t.shift();if("PARAMETER"===i&&(i=t.shift()),1===t.length)return Array.isArray(t[0])?(s[i]={},void h(t[0],s[i])):void(s[i]=t[0]);if(t.length)if("TOWGS84"!==i){if("AXIS"===i)return i in s||(s[i]=[]),void s[i].push(t);Array.isArray(i)||(s[i]={});var e;switch(i){case"UNIT":case"PRIMEM":case"VERT_DATUM":return s[i]={name:t[0].toLowerCase(),convert:t[1]},void(3===t.length&&h(t[2],s[i]));case"SPHEROID":case"ELLIPSOID":return s[i]={name:t[0],a:t[1],rf:t[2]},void(4===t.length&&h(t[3],s[i]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return t[0]=["name",t[0]],void a(s,i,t);default:for(e=-1;++e<t.length;)if(!Array.isArray(t[e]))return h(t,s[i]);return a(s,i,t)}}else s[i]=t;else s[i]=!0}else s[t]=!0}function e(t,s){var i=s[0],a=s[1];!(i in t)&&a in t&&(t[i]=t[a],3===s.length&&(t[i]=s[2](t[i])))}function n(t){return t*Bt}function r(t){function s(s){return s*(t.to_meter||1)}if("GEOGCS"===t.type?t.projName="longlat":"LOCAL_CS"===t.type?(t.projName="identity",t.local=!0):"object"==typeof t.PROJECTION?t.projName=Object.keys(t.PROJECTION)[0]:t.projName=t.PROJECTION,t.AXIS){for(var i="",a=0,h=t.AXIS.length;a<h;++a){var r=[t.AXIS[a][0].toLowerCase(),t.AXIS[a][1].toLowerCase()];-1!==r[0].indexOf("north")||("y"===r[0]||"lat"===r[0])&&"north"===r[1]?i+="n":-1!==r[0].indexOf("south")||("y"===r[0]||"lat"===r[0])&&"south"===r[1]?i+="s":-1!==r[0].indexOf("east")||("x"===r[0]||"lon"===r[0])&&"east"===r[1]?i+="e":-1===r[0].indexOf("west")&&("x"!==r[0]&&"lon"!==r[0]||"west"!==r[1])||(i+="w")}2===i.length&&(i+="u"),3===i.length&&(t.axis=i)}t.UNIT&&(t.units=t.UNIT.name.toLowerCase(),"metre"===t.units&&(t.units="meter"),t.UNIT.convert&&("GEOGCS"===t.type?t.DATUM&&t.DATUM.SPHEROID&&(t.to_meter=t.UNIT.convert*t.DATUM.SPHEROID.a):t.to_meter=t.UNIT.convert));var o=t.GEOGCS;"GEOGCS"===t.type&&(o=t),o&&(o.DATUM?t.datumCode=o.DATUM.name.toLowerCase():t.datumCode=o.name.toLowerCase(),"d_"===t.datumCode.slice(0,2)&&(t.datumCode=t.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==t.datumCode&&"new_zealand_1949"!==t.datumCode||(t.datumCode="nzgd49"),"wgs_1984"!==t.datumCode&&"world_geodetic_system_1984"!==t.datumCode||("Mercator_Auxiliary_Sphere"===t.PROJECTION&&(t.sphere=!0),t.datumCode="wgs84"),"_ferro"===t.datumCode.slice(-6)&&(t.datumCode=t.datumCode.slice(0,-6)),"_jakarta"===t.datumCode.slice(-8)&&(t.datumCode=t.datumCode.slice(0,-8)),~t.datumCode.indexOf("belge")&&(t.datumCode="rnb72"),o.DATUM&&o.DATUM.SPHEROID&&(t.ellps=o.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===t.ellps.toLowerCase().slice(0,13)&&(t.ellps="intl"),t.a=o.DATUM.SPHEROID.a,t.rf=parseFloat(o.DATUM.SPHEROID.rf,10)),o.DATUM&&o.DATUM.TOWGS84&&(t.datum_params=o.DATUM.TOWGS84),~t.datumCode.indexOf("osgb_1936")&&(t.datumCode="osgb36"),~t.datumCode.indexOf("osni_1952")&&(t.datumCode="osni52"),(~t.datumCode.indexOf("tm65")||~t.datumCode.indexOf("geodetic_datum_of_1965"))&&(t.datumCode="ire65"),"ch1903+"===t.datumCode&&(t.datumCode="ch1903"),~t.datumCode.indexOf("israel")&&(t.datumCode="isr93")),t.b&&!isFinite(t.b)&&(t.b=t.a);[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",n],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",n],["x0","false_easting",s],["y0","false_northing",s],["long0","central_meridian",n],["lat0","latitude_of_origin",n],["lat0","standard_parallel_1",n],["lat1","standard_parallel_1",n],["lat2","standard_parallel_2",n],["azimuth","Azimuth"],["alpha","azimuth",n],["srsCode","name"]].forEach(function(s){return e(t,s)}),t.long0||!t.longc||"Albers_Conic_Equal_Area"!==t.projName&&"Lambert_Azimuthal_Equal_Area"!==t.projName||(t.long0=t.longc),t.lat_ts||!t.lat1||"Stereographic_South_Pole"!==t.projName&&"Polar Stereographic (variant B)"!==t.projName||(t.lat0=n(t.lat1>0?90:-90),t.lat_ts=t.lat1)}function o(t){var s=this;if(2===arguments.length){var i=arguments[1];"string"==typeof i?"+"===i.charAt(0)?o[t]=kt(arguments[1]):o[t]=zt(arguments[1]):o[t]=i}else if(1===arguments.length){if(Array.isArray(t))return t.map(function(t){Array.isArray(t)?o.apply(s,t):o(t)});if("string"==typeof t){if(t in o)return o[t]}else"EPSG"in t?o["EPSG:"+t.EPSG]=t:"ESRI"in t?o["ESRI:"+t.ESRI]=t:"IAU2000"in t?o["IAU2000:"+t.IAU2000]=t:console.log(t);return}}function l(t){return"string"==typeof t}function u(t){return t in o}function c(t){return Ft.some(function(s){return t.indexOf(s)>-1})}function M(s){var i=t(s,"authority");if(i){var a=t(i,"epsg");return a&&Dt.indexOf(a)>-1}}function f(s){var i=t(s,"extension");if(i)return t(i,"proj4")}function d(t){return"+"===t[0]}function p(t){if(!l(t))return t;if(u(t))return o[t];if(c(t)){var s=zt(t);if(M(s))return o["EPSG:3857"];var i=f(s);return i?kt(i):s}return d(t)?kt(t):void 0}function m(t){return t}function _(t,s){var i=Zt.length;return t.names?(Zt[i]=t,t.names.forEach(function(t){Vt[t.toLowerCase()]=i}),this):(console.log(s),!0)}function y(t,s,i,a){var h=t*t,e=s*s,n=(h-e)/h,r=0;return a?(h=(t*=1-n*(gt+n*(vt+n*bt)))*t,n=0):r=Math.sqrt(n),{es:n,e:r,ep2:(h-e)/e}}function x(s,i,a,h,e){if(!s){var n=t($t,h);n||(n=ts),s=n.a,i=n.b,a=n.rf}return a&&!i&&(i=(1-1/a)*s),(0===a||Math.abs(s-i)<wt)&&(e=!0,i=s),{a:s,b:i,rf:a,sphere:e}}function g(t,s,i,a,h,e,n){var r={};return r.datum_type=void 0===t||"none"===t?_t:mt,s&&(r.datum_params=s.map(parseFloat),0===r.datum_params[0]&&0===r.datum_params[1]&&0===r.datum_params[2]||(r.datum_type=ft),r.datum_params.length>3&&(0===r.datum_params[3]&&0===r.datum_params[4]&&0===r.datum_params[5]&&0===r.datum_params[6]||(r.datum_type=dt,r.datum_params[3]*=yt,r.datum_params[4]*=yt,r.datum_params[5]*=yt,r.datum_params[6]=r.datum_params[6]/1e6+1))),n&&(r.datum_type=pt,r.grids=n),r.a=i,r.b=a,r.es=h,r.ep2=e,r}function v(t){return void 0===t?null:t.split(",").map(b)}function b(t){if(0===t.length)return null;var s="@"===t[0];return s&&(t=t.slice(1)),"null"===t?{name:"null",mandatory:!s,grid:null,isNull:!0}:{name:t,mandatory:!s,grid:is[t]||null,isNull:!1}}function w(t){return t/3600*Math.PI/180}function N(t){var s=t.getInt32(8,!1);return 11!==s&&(11!==(s=t.getInt32(8,!0))&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian"),!0)}function A(t,s){return{nFields:t.getInt32(8,s),nSubgridFields:t.getInt32(24,s),nSubgrids:t.getInt32(40,s),shiftType:E(t,56,64).trim(),fromSemiMajorAxis:t.getFloat64(120,s),fromSemiMinorAxis:t.getFloat64(136,s),toSemiMajorAxis:t.getFloat64(152,s),toSemiMinorAxis:t.getFloat64(168,s)}}function E(t,s,i){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(s,i)))}function C(t,s,i){for(var a=[],h=0;h<s.nSubgrids;h++){var e=S(t,176,i),n=I(t,176,e,i),r=Math.round(1+(e.upperLongitude-e.lowerLongitude)/e.longitudeInterval),o=Math.round(1+(e.upperLatitude-e.lowerLatitude)/e.latitudeInterval);a.push({ll:[w(e.lowerLongitude),w(e.lowerLatitude)],del:[w(e.longitudeInterval),w(e.latitudeInterval)],lim:[r,o],count:e.gridNodeCount,cvs:P(n)})}return a}function P(t){return t.map(function(t){return[w(t.longitudeShift),w(t.latitudeShift)]})}function S(t,s,i){return{name:E(t,s+8,s+16).trim(),parent:E(t,s+24,s+24+8).trim(),lowerLatitude:t.getFloat64(s+72,i),upperLatitude:t.getFloat64(s+88,i),lowerLongitude:t.getFloat64(s+104,i),upperLongitude:t.getFloat64(s+120,i),latitudeInterval:t.getFloat64(s+136,i),longitudeInterval:t.getFloat64(s+152,i),gridNodeCount:t.getInt32(s+168,i)}}function I(t,s,i,a){for(var h=s+176,e=[],n=0;n<i.gridNodeCount;n++){var r={latitudeShift:t.getFloat32(h+16*n,a),longitudeShift:t.getFloat32(h+16*n+4,a),latitudeAccuracy:t.getFloat32(h+16*n+8,a),longitudeAccuracy:t.getFloat32(h+16*n+12,a)};e.push(r)}return e}function Projection(s,i){if(!(this instanceof Projection))return new Projection(s);i=i||function(t){if(t)throw t};var a=p(s);if("object"==typeof a){var h=Projection.projections.get(a.projName);if(h){if(a.datumCode&&"none"!==a.datumCode){var e=t(ss,a.datumCode);e&&(a.datum_params=a.datum_params||(e.towgs84?e.towgs84.split(","):null),a.ellps=e.ellipse,a.datumName=e.datumName?e.datumName:a.datumCode)}a.k0=a.k0||1,a.axis=a.axis||"enu",a.ellps=a.ellps||"wgs84",a.lat1=a.lat1||a.lat0;var n=x(a.a,a.b,a.rf,a.ellps,a.sphere),r=y(n.a,n.b,n.rf,a.R_A),o=v(a.nadgrids),l=a.datum||g(a.datumCode,a.datum_params,n.a,n.b,r.es,r.ep2,o);Ut(this,a),Ut(this,h),this.a=n.a,this.b=n.b,this.rf=n.rf,this.sphere=n.sphere,this.es=r.es,this.e=r.e,this.ep2=r.ep2,this.datum=l,this.init(),i(null,this)}else i(s)}else i(s)}function O(t,s){return t.datum_type===s.datum_type&&(!(t.a!==s.a||Math.abs(t.es-s.es)>5e-11)&&(t.datum_type===ft?t.datum_params[0]===s.datum_params[0]&&t.datum_params[1]===s.datum_params[1]&&t.datum_params[2]===s.datum_params[2]:t.datum_type!==dt||t.datum_params[0]===s.datum_params[0]&&t.datum_params[1]===s.datum_params[1]&&t.datum_params[2]===s.datum_params[2]&&t.datum_params[3]===s.datum_params[3]&&t.datum_params[4]===s.datum_params[4]&&t.datum_params[5]===s.datum_params[5]&&t.datum_params[6]===s.datum_params[6]))}function k(t,s,i){var a,h,e,n,r=t.x,o=t.y,l=t.z?t.z:0;if(o<-xt&&o>-1.001*xt)o=-xt;else if(o>xt&&o<1.001*xt)o=xt;else{if(o<-xt)return{x:-1/0,y:-1/0,z:t.z};if(o>xt)return{x:1/0,y:1/0,z:t.z}}return r>Math.PI&&(r-=2*Math.PI),h=Math.sin(o),n=Math.cos(o),e=h*h,a=i/Math.sqrt(1-s*e),{x:(a+l)*n*Math.cos(r),y:(a+l)*n*Math.sin(r),z:(a*(1-s)+l)*h}}function q(t,s,i,a){var h,e,n,r,o,l,u,c,M,f,d,p,m,_,y,x,g=t.x,v=t.y,b=t.z?t.z:0;if(h=Math.sqrt(g*g+v*v),e=Math.sqrt(g*g+v*v+b*b),h/i<1e-12){if(_=0,e/i<1e-12)return y=xt,x=-a,{x:t.x,y:t.y,z:t.z}}else _=Math.atan2(v,g);n=b/e,c=(r=h/e)*(1-s)*(o=1/Math.sqrt(1-s*(2-s)*r*r)),M=n*o,m=0;do{m++,l=s*(u=i/Math.sqrt(1-s*M*M))/(u+(x=h*c+b*M-u*(1-s*M*M))),p=(d=n*(o=1/Math.sqrt(1-l*(2-l)*r*r)))*c-(f=r*(1-l)*o)*M,c=f,M=d}while(p*p>1e-24&&m<30);return y=Math.atan(d/Math.abs(f)),{x:_,y:y,z:x}}function R(t,s,i){if(s===ft)return{x:t.x+i[0],y:t.y+i[1],z:t.z+i[2]};if(s===dt){var a=i[0],h=i[1],e=i[2],n=i[3],r=i[4],o=i[5],l=i[6];return{x:l*(t.x-o*t.y+r*t.z)+a,y:l*(o*t.x+t.y-n*t.z)+h,z:l*(-r*t.x+n*t.y+t.z)+e}}}function L(t,s,i){if(s===ft)return{x:t.x-i[0],y:t.y-i[1],z:t.z-i[2]};if(s===dt){var a=i[0],h=i[1],e=i[2],n=i[3],r=i[4],o=i[5],l=i[6],u=(t.x-a)/l,c=(t.y-h)/l,M=(t.z-e)/l;return{x:u+o*c-r*M,y:-o*u+c+n*M,z:r*u-n*c+M}}}function T(t){return t===ft||t===dt}function G(t,s,i){if(null===t.grids||0===t.grids.length)return console.log("Grid shift grids not found"),-1;for(var a={x:-i.x,y:i.y},h={x:Number.NaN,y:Number.NaN},e=[],n=0;n<t.grids.length;n++){var r=t.grids[n];if(e.push(r.name),r.isNull){h=a;break}if(null!==r.grid){var o=r.grid.subgrids[0],l=(Math.abs(o.del[1])+Math.abs(o.del[0]))/1e4,u=o.ll[0]-l,c=o.ll[1]-l,M=o.ll[0]+(o.lim[0]-1)*o.del[0]+l,f=o.ll[1]+(o.lim[1]-1)*o.del[1]+l;if(!(c>a.y||u>a.x||f<a.y||M<a.x||(h=j(a,s,o),isNaN(h.x))))break}else if(r.mandatory)return console.log("Unable to find mandatory grid '"+r.name+"'"),-1}return isNaN(h.x)?(console.log("Failed to find a grid shift table for location '"+-a.x*At+" "+a.y*At+" tried: '"+e+"'"),-1):(i.x=-h.x,i.y=h.y,0)}function j(t,s,i){var a={x:Number.NaN,y:Number.NaN};if(isNaN(t.x))return a;var h={x:t.x,y:t.y};h.x-=i.ll[0],h.y-=i.ll[1],h.x=Ht(h.x-Math.PI)+Math.PI;var e=B(h,i);if(s){if(isNaN(e.x))return a;e.x=h.x-e.x,e.y=h.y-e.y;var n,r,o=9;do{if(r=B(e,i),isNaN(r.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}n={x:h.x-(r.x+e.x),y:h.y-(r.y+e.y)},e.x+=n.x,e.y+=n.y}while(o--&&Math.abs(n.x)>1e-12&&Math.abs(n.y)>1e-12);if(o<0)return console.log("Inverse grid shift iterator failed to converge."),a;a.x=Ht(e.x+i.ll[0]),a.y=e.y+i.ll[1]}else isNaN(e.x)||(a.x=t.x+e.x,a.y=t.y+e.y);return a}function B(t,s){var i,a={x:t.x/s.del[0],y:t.y/s.del[1]},h={x:Math.floor(a.x),y:Math.floor(a.y)},e={x:a.x-1*h.x,y:a.y-1*h.y},n={x:Number.NaN,y:Number.NaN};if(h.x<0||h.x>=s.lim[0])return n;if(h.y<0||h.y>=s.lim[1])return n;i=h.y*s.lim[0]+h.x;var r={x:s.cvs[i][0],y:s.cvs[i][1]};i++;var o={x:s.cvs[i][0],y:s.cvs[i][1]};i+=s.lim[0];var l={x:s.cvs[i][0],y:s.cvs[i][1]};i--;var u={x:s.cvs[i][0],y:s.cvs[i][1]},c=e.x*e.y,M=e.x*(1-e.y),f=(1-e.x)*(1-e.y),d=(1-e.x)*e.y;return n.x=f*r.x+M*o.x+d*u.x+c*l.x,n.y=f*r.y+M*o.y+d*u.y+c*l.y,n}function z(t){if("function"==typeof Number.isFinite){if(Number.isFinite(t))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof t||t!==t||!isFinite(t))throw new TypeError("coordinates must be finite numbers")}function F(t,s){return(t.datum.datum_type===ft||t.datum.datum_type===dt)&&"WGS84"!==s.datumCode||(s.datum.datum_type===ft||s.datum.datum_type===dt)&&"WGS84"!==t.datumCode}function D(t,s,i,a){var h;if(Array.isArray(i)&&(i=es(i)),ns(i),t.datum&&s.datum&&F(t,s)&&(i=D(t,h=new Projection("WGS84"),i,a),t=h),a&&"enu"!==t.axis&&(i=hs(t,!1,i)),"longlat"===t.projName)i={x:i.x*Nt,y:i.y*Nt,z:i.z||0};else if(t.to_meter&&(i={x:i.x*t.to_meter,y:i.y*t.to_meter,z:i.z||0}),!(i=t.inverse(i)))return;if(t.from_greenwich&&(i.x+=t.from_greenwich),i=as(t.datum,s.datum,i))return s.from_greenwich&&(i={x:i.x-s.from_greenwich,y:i.y,z:i.z||0}),"longlat"===s.projName?i={x:i.x*At,y:i.y*At,z:i.z||0}:(i=s.forward(i),s.to_meter&&(i={x:i.x/s.to_meter,y:i.y/s.to_meter,z:i.z||0})),a&&"enu"!==s.axis?hs(s,!0,i):i}function U(t,s,i,a){var h,e,n;return Array.isArray(i)?(h=D(t,s,i,a)||{x:NaN,y:NaN},i.length>2?void 0!==t.name&&"geocent"===t.name||void 0!==s.name&&"geocent"===s.name?"number"==typeof h.z?[h.x,h.y,h.z].concat(i.splice(3)):[h.x,h.y,i[2]].concat(i.splice(3)):[h.x,h.y].concat(i.splice(2)):[h.x,h.y]):(e=D(t,s,i,a),2===(n=Object.keys(i)).length?e:(n.forEach(function(a){if(void 0!==t.name&&"geocent"===t.name||void 0!==s.name&&"geocent"===s.name){if("x"===a||"y"===a||"z"===a)return}else if("x"===a||"y"===a)return;e[a]=i[a]}),e))}function Q(t){return t instanceof Projection?t:t.oProj?t.oProj:Projection(t)}function W(t,s,i){t=Q(t);var a,h=!1;return void 0===s?(s=t,t=rs,h=!0):(void 0!==s.x||Array.isArray(s))&&(i=s,s=t,t=rs,h=!0),s=Q(s),i?U(t,s,i):(a={forward:function(i,a){return U(t,s,i,a)},inverse:function(i,a){return U(s,t,i,a)}},h&&(a.oProj=s),a)}function H(t,s){return s=s||5,$(V({lat:t[1],lon:t[0]}),s)}function X(t){var s=Z(at(t.toUpperCase()));return s.lat&&s.lon?[s.lon,s.lat]:[(s.left+s.right)/2,(s.top+s.bottom)/2]}function J(t){return t*(Math.PI/180)}function K(t){return t/Math.PI*180}function V(t){var s,i,a,h,e,n,r,o=t.lat,l=t.lon,u=6378137,c=J(o),M=J(l);r=Math.floor((l+180)/6)+1,180===l&&(r=60),o>=56&&o<64&&l>=3&&l<12&&(r=32),o>=72&&o<84&&(l>=0&&l<9?r=31:l>=9&&l<21?r=33:l>=21&&l<33?r=35:l>=33&&l<42&&(r=37)),n=J(6*(r-1)-180+3),s=u/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),i=Math.tan(c)*Math.tan(c),a=.006739496752268451*Math.cos(c)*Math.cos(c);var f=.9996*s*((h=Math.cos(c)*(M-n))+(1-i+a)*h*h*h/6+(5-18*i+i*i+72*a-.39089081163157013)*h*h*h*h*h/120)+5e5,d=.9996*((e=u*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3.418046101696858e-9*Math.sin(6*c)))+s*Math.tan(c)*(h*h/2+(5-i+9*a+4*a*a)*h*h*h*h/24+(61-58*i+i*i+600*a-2.2240339282485886)*h*h*h*h*h*h/720));return o<0&&(d+=1e7),{northing:Math.round(d),easting:Math.round(f),zoneNumber:r,zoneLetter:Y(o)}}function Z(t){var s=t.northing,i=t.easting,a=t.zoneLetter,h=t.zoneNumber;if(h<0||h>60)return null;var e,n,r,o,l,u,c,M,f=6378137,d=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),p=i-5e5,m=s;a<"N"&&(m-=1e7),u=6*(h-1)-180+3,M=(c=m/.9996/6367449.145945056)+(3*d/2-27*d*d*d/32)*Math.sin(2*c)+(21*d*d/16-55*d*d*d*d/32)*Math.sin(4*c)+151*d*d*d/96*Math.sin(6*c),e=f/Math.sqrt(1-.00669438*Math.sin(M)*Math.sin(M)),n=Math.tan(M)*Math.tan(M),r=.006739496752268451*Math.cos(M)*Math.cos(M),o=.99330562*f/Math.pow(1-.00669438*Math.sin(M)*Math.sin(M),1.5),l=p/(.9996*e);var _=M-e*Math.tan(M)/o*(l*l/2-(5+3*n+10*r-4*r*r-.06065547077041606)*l*l*l*l/24+(61+90*n+298*r+45*n*n-1.6983531815716497-3*r*r)*l*l*l*l*l*l/720);_=K(_);var y=(l-(1+2*n+r)*l*l*l/6+(5-2*r+28*n-3*r*r+.05391597401814761+24*n*n)*l*l*l*l*l/120)/Math.cos(M);y=u+K(y);var x;if(t.accuracy){var g=Z({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});x={top:g.lat,right:g.lon,bottom:_,left:y}}else x={lat:_,lon:y};return x}function Y(t){var s="Z";return 84>=t&&t>=72?s="X":72>t&&t>=64?s="W":64>t&&t>=56?s="V":56>t&&t>=48?s="U":48>t&&t>=40?s="T":40>t&&t>=32?s="S":32>t&&t>=24?s="R":24>t&&t>=16?s="Q":16>t&&t>=8?s="P":8>t&&t>=0?s="N":0>t&&t>=-8?s="M":-8>t&&t>=-16?s="L":-16>t&&t>=-24?s="K":-24>t&&t>=-32?s="J":-32>t&&t>=-40?s="H":-40>t&&t>=-48?s="G":-48>t&&t>=-56?s="F":-56>t&&t>=-64?s="E":-64>t&&t>=-72?s="D":-72>t&&t>=-80&&(s="C"),s}function $(t,s){var i="00000"+t.easting,a="00000"+t.northing;return t.zoneNumber+t.zoneLetter+tt(t.easting,t.northing,t.zoneNumber)+i.substr(i.length-5,s)+a.substr(a.length-5,s)}function tt(t,s,i){var a=st(i);return it(Math.floor(t/1e5),Math.floor(s/1e5)%20,a)}function st(t){var s=t%os;return 0===s&&(s=os),s}function it(t,s,i){var a=i-1,h=ls.charCodeAt(a),e=us.charCodeAt(a),n=h+t-1,r=e+s,o=!1;return n>ps&&(n=n-ps+cs-1,o=!0),(n===Ms||h<Ms&&n>Ms||(n>Ms||h<Ms)&&o)&&n++,(n===fs||h<fs&&n>fs||(n>fs||h<fs)&&o)&&++n===Ms&&n++,n>ps&&(n=n-ps+cs-1),r>ds?(r=r-ds+cs-1,o=!0):o=!1,(r===Ms||e<Ms&&r>Ms||(r>Ms||e<Ms)&&o)&&r++,(r===fs||e<fs&&r>fs||(r>fs||e<fs)&&o)&&++r===Ms&&r++,r>ds&&(r=r-ds+cs-1),String.fromCharCode(n)+String.fromCharCode(r)}function at(t){if(t&&0===t.length)throw"MGRSPoint coverting from nothing";for(var s,i=t.length,a=null,h="",e=0;!/[A-Z]/.test(s=t.charAt(e));){if(e>=2)throw"MGRSPoint bad conversion from: "+t;h+=s,e++}var n=parseInt(h,10);if(0===e||e+3>i)throw"MGRSPoint bad conversion from: "+t;var r=t.charAt(e++);if(r<="A"||"B"===r||"Y"===r||r>="Z"||"I"===r||"O"===r)throw"MGRSPoint zone letter "+r+" not handled: "+t;a=t.substring(e,e+=2);for(var o=st(n),l=ht(a.charAt(0),o),u=et(a.charAt(1),o);u<nt(r);)u+=2e6;var c=i-e;if(c%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+t;var M,f,d,p,m,_=c/2,y=0,x=0;return _>0&&(M=1e5/Math.pow(10,_),f=t.substring(e,e+_),y=parseFloat(f)*M,d=t.substring(e+_),x=parseFloat(d)*M),p=y+l,m=x+u,{easting:p,northing:m,zoneLetter:r,zoneNumber:n,accuracy:M}}function ht(t,s){for(var i=ls.charCodeAt(s-1),a=1e5,h=!1;i!==t.charCodeAt(0);){if(++i===Ms&&i++,i===fs&&i++,i>ps){if(h)throw"Bad character: "+t;i=cs,h=!0}a+=1e5}return a}function et(t,s){if(t>"V")throw"MGRSPoint given invalid Northing "+t;for(var i=us.charCodeAt(s-1),a=0,h=!1;i!==t.charCodeAt(0);){if(++i===Ms&&i++,i===fs&&i++,i>ds){if(h)throw"Bad character: "+t;i=cs,h=!0}a+=1e5}return a}function nt(t){var s;switch(t){case"C":s=11e5;break;case"D":s=2e6;break;case"E":s=28e5;break;case"F":s=37e5;break;case"G":s=46e5;break;case"H":s=55e5;break;case"J":s=64e5;break;case"K":s=73e5;break;case"L":s=82e5;break;case"M":s=91e5;break;case"N":s=0;break;case"P":s=8e5;break;case"Q":s=17e5;break;case"R":s=26e5;break;case"S":s=35e5;break;case"T":s=44e5;break;case"U":s=53e5;break;case"V":s=62e5;break;case"W":s=7e6;break;case"X":s=79e5;break;default:s=-1}if(s>=0)return s;throw"Invalid zone letter: "+t}function Point(t,s,i){if(!(this instanceof Point))return new Point(t,s,i);if(Array.isArray(t))this.x=t[0],this.y=t[1],this.z=t[2]||0;else if("object"==typeof t)this.x=t.x,this.y=t.y,this.z=t.z||0;else if("string"==typeof t&&void 0===s){var a=t.split(",");this.x=parseFloat(a[0],10),this.y=parseFloat(a[1],10),this.z=parseFloat(a[2],10)||0}else this.x=t,this.y=s,this.z=i||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}function rt(t){var s=["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"],i="object"==typeof t.PROJECTION?Object.keys(t.PROJECTION)[0]:t.PROJECTION;return"no_uoff"in t||"no_off"in t||-1!==s.indexOf(i)}function ot(t){var s,i=[];return i[0]=t*$s,s=t*t,i[0]+=s*ti,i[1]=s*ii,s*=t,i[0]+=s*si,i[1]+=s*ai,i[2]=s*hi,i}function lt(t,s){var i=t+t;return t+s[0]*Math.sin(i)+s[1]*Math.sin(i+i)+s[2]*Math.sin(i+i+i)}function ut(t,s,i,a){var h;return t<wt?(a.value=Ni.AREA_0,h=0):(h=Math.atan2(s,i),Math.abs(h)<=Et?a.value=Ni.AREA_0:h>Et&&h<=xt+Et?(a.value=Ni.AREA_1,h-=xt):h>xt+Et||h<=-(xt+Et)?(a.value=Ni.AREA_2,h=h>=0?h-Pt:h+Pt):(a.value=Ni.AREA_3,h+=xt)),h}function ct(t,s){var i=t+s;return i<-Pt?i+=Ct:i>+Pt&&(i-=Ct),i}function Mt(t,s,i,a){for(var h=s;a;--a){var e=t(h);if(h-=e,Math.abs(e)<i)break}return h}var ft=1,dt=2,pt=3,mt=4,_t=5,yt=484813681109536e-20,xt=Math.PI/2,gt=.16666666666666666,vt=.04722222222222222,bt=.022156084656084655,wt=1e-10,Nt=.017453292519943295,At=57.29577951308232,Et=Math.PI/4,Ct=2*Math.PI,Pt=3.14159265359,St={};St.greenwich=0,St.lisbon=-9.131906111111,St.paris=2.337229166667,St.bogota=-74.080916666667,St.madrid=-3.687938888889,St.rome=12.452333333333,St.bern=7.439583333333,St.jakarta=106.807719444444,St.ferro=-17.666666666667,St.brussels=4.367975,St.stockholm=18.058277777778,St.athens=23.7163375,St.oslo=10.722916666667;var It={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},Ot=/[\s_\-\/\(\)]/g,kt=function(s){var i,a,h,e={},n=s.split("+").map(function(t){return t.trim()}).filter(function(t){return t}).reduce(function(t,s){var i=s.split("=");return i.push(!0),t[i[0].toLowerCase()]=i[1],t},{}),r={proj:"projName",datum:"datumCode",rf:function(t){e.rf=parseFloat(t)},lat_0:function(t){e.lat0=t*Nt},lat_1:function(t){e.lat1=t*Nt},lat_2:function(t){e.lat2=t*Nt},lat_ts:function(t){e.lat_ts=t*Nt},lon_0:function(t){e.long0=t*Nt},lon_1:function(t){e.long1=t*Nt},lon_2:function(t){e.long2=t*Nt},alpha:function(t){e.alpha=parseFloat(t)*Nt},gamma:function(t){e.rectified_grid_angle=parseFloat(t)},lonc:function(t){e.longc=t*Nt},x_0:function(t){e.x0=parseFloat(t)},y_0:function(t){e.y0=parseFloat(t)},k_0:function(t){e.k0=parseFloat(t)},k:function(t){e.k0=parseFloat(t)},a:function(t){e.a=parseFloat(t)},b:function(t){e.b=parseFloat(t)},r_a:function(){e.R_A=!0},zone:function(t){e.zone=parseInt(t,10)},south:function(){e.utmSouth=!0},towgs84:function(t){e.datum_params=t.split(",").map(function(t){return parseFloat(t)})},to_meter:function(t){e.to_meter=parseFloat(t)},units:function(s){e.units=s;var i=t(It,s);i&&(e.to_meter=i.to_meter)},from_greenwich:function(t){e.from_greenwich=t*Nt},pm:function(s){var i=t(St,s);e.from_greenwich=(i||parseFloat(s))*Nt},nadgrids:function(t){"@null"===t?e.datumCode="none":e.nadgrids=t},axis:function(t){3===t.length&&-1!=="ewnsud".indexOf(t.substr(0,1))&&-1!=="ewnsud".indexOf(t.substr(1,1))&&-1!=="ewnsud".indexOf(t.substr(2,1))&&(e.axis=t)},approx:function(){e.approx=!0}};for(i in n)a=n[i],i in r?"function"==typeof(h=r[i])?h(a):e[h]=a:e[i]=a;return"string"==typeof e.datumCode&&"WGS84"!==e.datumCode&&(e.datumCode=e.datumCode.toLowerCase()),e},qt=1,Rt=/\s/,Lt=/[A-Za-z]/,Tt=/[A-Za-z84]/,Gt=/[,\]]/,jt=/[\d\.E\-\+]/;s.prototype.readCharicter=function(){var t=this.text[this.place++];if(4!==this.state)for(;Rt.test(t);){if(this.place>=this.text.length)return;t=this.text[this.place++]}switch(this.state){case qt:return this.neutral(t);case 2:return this.keyword(t);case 4:return this.quoted(t);case 5:return this.afterquote(t);case 3:return this.number(t);case-1:return}},s.prototype.afterquote=function(t){if('"'===t)return this.word+='"',void(this.state=4);if(Gt.test(t))return this.word=this.word.trim(),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in afterquote yet, index '+this.place)},s.prototype.afterItem=function(t){return","===t?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=qt)):"]"===t?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=qt,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},s.prototype.number=function(t){if(!jt.test(t)){if(Gt.test(t))return this.word=parseFloat(this.word),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in number yet, index '+this.place)}this.word+=t},s.prototype.quoted=function(t){'"'!==t?this.word+=t:this.state=5},s.prototype.keyword=function(t){if(Tt.test(t))this.word+=t;else{if("["===t){var s=[];return s.push(this.word),this.level++,null===this.root?this.root=s:this.currentObject.push(s),this.stack.push(this.currentObject),this.currentObject=s,void(this.state=qt)}if(!Gt.test(t))throw new Error("havn't handled \""+t+'" in keyword yet, index '+this.place);this.afterItem(t)}},s.prototype.neutral=function(t){if(Lt.test(t))return this.word=t,void(this.state=2);if('"'===t)return this.word="",void(this.state=4);if(jt.test(t))return this.word=t,void(this.state=3);{if(!Gt.test(t))throw new Error("havn't handled \""+t+'" in neutral yet, index '+this.place);this.afterItem(t)}},s.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};var Bt=.017453292519943295,zt=function(t){var s=i(t),a=s.shift(),e=s.shift();s.unshift(["name",e]),s.unshift(["type",a]);var n={};return h(s,n),r(n),n};!function(t){t("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),t("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),t("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),t.WGS84=t["EPSG:4326"],t["EPSG:3785"]=t["EPSG:3857"],t.GOOGLE=t["EPSG:3857"],t["EPSG:900913"]=t["EPSG:3857"],t["EPSG:102113"]=t["EPSG:3857"]}(o);var Ft=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"],Dt=["3857","900913","3785","102113"],Ut=function(t,s){t=t||{};var i,a;if(!s)return t;for(a in s)void 0!==(i=s[a])&&(t[a]=i);return t},Qt=function(t,s,i){var a=t*s;return i/Math.sqrt(1-a*a)},Wt=function(t){return t<0?-1:1},Ht=function(t){return Math.abs(t)<=Pt?t:t-Wt(t)*Ct},Xt=function(t,s,i){var a=t*i,h=.5*t;return a=Math.pow((1-a)/(1+a),h),Math.tan(.5*(xt-s))/a},Jt=function(t,s){for(var i,a,h=.5*t,e=xt-2*Math.atan(s),n=0;n<=15;n++)if(i=t*Math.sin(e),a=xt-2*Math.atan(s*Math.pow((1-i)/(1+i),h))-e,e+=a,Math.abs(a)<=1e-10)return e;return-9999},Kt=[{init:function(){var t=this.b/this.a;this.es=1-t*t,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=Qt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(t){var s=t.x,i=t.y;if(i*At>90&&i*At<-90&&s*At>180&&s*At<-180)return null;var a,h;if(Math.abs(Math.abs(i)-xt)<=wt)return null;if(this.sphere)a=this.x0+this.a*this.k0*Ht(s-this.long0),h=this.y0+this.a*this.k0*Math.log(Math.tan(Et+.5*i));else{var e=Math.sin(i),n=Xt(this.e,i,e);a=this.x0+this.a*this.k0*Ht(s-this.long0),h=this.y0-this.a*this.k0*Math.log(n)}return t.x=a,t.y=h,t},inverse:function(t){var s,i,a=t.x-this.x0,h=t.y-this.y0;if(this.sphere)i=xt-2*Math.atan(Math.exp(-h/(this.a*this.k0)));else{var e=Math.exp(-h/(this.a*this.k0));if(-9999===(i=Jt(this.e,e)))return null}return s=Ht(this.long0+a/(this.a*this.k0)),t.x=s,t.y=i,t},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:m,inverse:m,names:["longlat","identity"]}],Vt={},Zt=[],Yt={start:function(){Kt.forEach(_)},add:_,get:function(t){if(!t)return!1;var s=t.toLowerCase();return void 0!==Vt[s]&&Zt[Vt[s]]?Zt[Vt[s]]:void 0}},$t={};$t.MERIT={a:6378137,rf:298.257,ellipseName:"MERIT 1983"},$t.SGS85={a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},$t.GRS80={a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},$t.IAU76={a:6378140,rf:298.257,ellipseName:"IAU 1976"},$t.airy={a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},$t.APL4={a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},$t.NWL9D={a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},$t.mod_airy={a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},$t.andrae={a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},$t.aust_SA={a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},$t.GRS67={a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},$t.bessel={a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},$t.bess_nam={a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},$t.clrk66={a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},$t.clrk80={a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},$t.clrk58={a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},$t.CPM={a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},$t.delmbr={a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},$t.engelis={a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},$t.evrst30={a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},$t.evrst48={a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},$t.evrst56={a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},$t.evrst69={a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},$t.evrstSS={a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},$t.fschr60={a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},$t.fschr60m={a:6378155,rf:298.3,ellipseName:"Fischer 1960"},$t.fschr68={a:6378150,rf:298.3,ellipseName:"Fischer 1968"},$t.helmert={a:6378200,rf:298.3,ellipseName:"Helmert 1906"},$t.hough={a:6378270,rf:297,ellipseName:"Hough"},$t.intl={a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},$t.kaula={a:6378163,rf:298.24,ellipseName:"Kaula 1961"},$t.lerch={a:6378139,rf:298.257,ellipseName:"Lerch 1979"},$t.mprts={a:6397300,rf:191,ellipseName:"Maupertius 1738"},$t.new_intl={a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},$t.plessis={a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},$t.krass={a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},$t.SEasia={a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},$t.walbeck={a:6376896,b:6355834.8467,ellipseName:"Walbeck"},$t.WGS60={a:6378165,rf:298.3,ellipseName:"WGS 60"},$t.WGS66={a:6378145,rf:298.25,ellipseName:"WGS 66"},$t.WGS7={a:6378135,rf:298.26,ellipseName:"WGS 72"};var ts=$t.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};$t.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var ss={};ss.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},ss.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},ss.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},ss.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},ss.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},ss.potsdam={towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},ss.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},ss.hermannskogel={towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},ss.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},ss.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},ss.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},ss.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},ss.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},ss.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},ss.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},ss.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},ss.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var is={};Projection.projections=Yt,Projection.projections.start();var as=function(t,s,i){if(O(t,s))return i;if(t.datum_type===_t||s.datum_type===_t)return i;var a=t.a,h=t.es;if(t.datum_type===pt){if(0!==G(t,!1,i))return;a=6378137,h=.0066943799901413165}var e=s.a,n=s.b,r=s.es;return s.datum_type===pt&&(e=6378137,n=6356752.314,r=.0066943799901413165),h!==r||a!==e||T(t.datum_type)||T(s.datum_type)?(i=k(i,h,a),T(t.datum_type)&&(i=R(i,t.datum_type,t.datum_params)),T(s.datum_type)&&(i=L(i,s.datum_type,s.datum_params)),i=q(i,r,e,n),s.datum_type!==pt||0===G(s,!0,i)?i:void 0):i},hs=function(t,s,i){var a,h,e,n=i.x,r=i.y,o=i.z||0,l={};for(e=0;e<3;e++)if(!s||2!==e||void 0!==i.z)switch(0===e?(a=n,h=-1!=="ew".indexOf(t.axis[e])?"x":"y"):1===e?(a=r,h=-1!=="ns".indexOf(t.axis[e])?"y":"x"):(a=o,h="z"),t.axis[e]){case"e":l[h]=a;break;case"w":l[h]=-a;break;case"n":l[h]=a;break;case"s":l[h]=-a;break;case"u":void 0!==i[h]&&(l.z=a);break;case"d":void 0!==i[h]&&(l.z=-a);break;default:return null}return l},es=function(t){var s={x:t[0],y:t[1]};return t.length>2&&(s.z=t[2]),t.length>3&&(s.m=t[3]),s},ns=function(t){z(t.x),z(t.y)},rs=Projection("WGS84"),os=6,ls="AJSAJS",us="AFAFAF",cs=65,Ms=73,fs=79,ds=86,ps=90,ms={forward:H,inverse:function(t){var s=Z(at(t.toUpperCase()));return s.lat&&s.lon?[s.lon,s.lat,s.lon,s.lat]:[s.left,s.bottom,s.right,s.top]},toPoint:X};Point.fromMGRS=function(t){return new Point(X(t))},Point.prototype.toMGRS=function(t){return H([this.x,this.y],t)};var _s=.01068115234375,ys=function(t){var s=[];s[0]=1-t*(.25+t*(.046875+t*(.01953125+t*_s))),s[1]=t*(.75-t*(.046875+t*(.01953125+t*_s)));var i=t*t;return s[2]=i*(.46875-t*(.013020833333333334+.007120768229166667*t)),i*=t,s[3]=i*(.3645833333333333-.005696614583333333*t),s[4]=i*t*.3076171875,s},xs=function(t,s,i,a){return i*=s,s*=s,a[0]*t-i*(a[1]+s*(a[2]+s*(a[3]+s*a[4])))},gs=function(t,s,i){for(var a=1/(1-s),h=t,e=20;e;--e){var n=Math.sin(h),r=1-s*n*n;if(r=(xs(h,n,Math.cos(h),i)-t)*(r*Math.sqrt(r))*a,h-=r,Math.abs(r)<wt)return h}return h},vs={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=ys(this.es),this.ml0=xs(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(t){var s,i,a,h=t.x,e=t.y,n=Ht(h-this.long0),r=Math.sin(e),o=Math.cos(e);if(this.es){var l=o*n,u=Math.pow(l,2),c=this.ep2*Math.pow(o,2),M=Math.pow(c,2),f=Math.abs(o)>wt?Math.tan(e):0,d=Math.pow(f,2),p=Math.pow(d,2);s=1-this.es*Math.pow(r,2),l/=Math.sqrt(s);var m=xs(e,r,o,this.en);i=this.a*(this.k0*l*(1+u/6*(1-d+c+u/20*(5-18*d+p+14*c-58*d*c+u/42*(61+179*p-p*d-479*d)))))+this.x0,a=this.a*(this.k0*(m-this.ml0+r*n*l/2*(1+u/12*(5-d+9*c+4*M+u/30*(61+p-58*d+270*c-330*d*c+u/56*(1385+543*p-p*d-3111*d))))))+this.y0}else{var _=o*Math.sin(n);if(Math.abs(Math.abs(_)-1)<wt)return 93;if(i=.5*this.a*this.k0*Math.log((1+_)/(1-_))+this.x0,a=o*Math.cos(n)/Math.sqrt(1-Math.pow(_,2)),(_=Math.abs(a))>=1){if(_-1>wt)return 93;a=0}else a=Math.acos(a);e<0&&(a=-a),a=this.a*this.k0*(a-this.lat0)+this.y0}return t.x=i,t.y=a,t},inverse:function(t){var s,i,a,h,e=(t.x-this.x0)*(1/this.a),n=(t.y-this.y0)*(1/this.a);if(this.es)if(s=this.ml0+n/this.k0,i=gs(s,this.es,this.en),Math.abs(i)<xt){var r=Math.sin(i),o=Math.cos(i),l=Math.abs(o)>wt?Math.tan(i):0,u=this.ep2*Math.pow(o,2),c=Math.pow(u,2),M=Math.pow(l,2),f=Math.pow(M,2);s=1-this.es*Math.pow(r,2);var d=e*Math.sqrt(s)/this.k0,p=Math.pow(d,2);a=i-(s*=l)*p/(1-this.es)*.5*(1-p/12*(5+3*M-9*u*M+u-4*c-p/30*(61+90*M-252*u*M+45*f+46*u-p/56*(1385+3633*M+4095*f+1574*f*M)))),h=Ht(this.long0+d*(1-p/6*(1+2*M+u-p/20*(5+28*M+24*f+8*u*M+6*u-p/42*(61+662*M+1320*f+720*f*M))))/o)}else a=xt*Wt(n),h=0;else{var m=Math.exp(e/this.k0),_=.5*(m-1/m),y=this.lat0+n/this.k0,x=Math.cos(y);s=Math.sqrt((1-Math.pow(x,2))/(1+Math.pow(_,2))),a=Math.asin(s),n<0&&(a=-a),h=0===_&&0===x?0:Ht(Math.atan2(_,x)+this.long0)}return t.x=h,t.y=a,t},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]},bs=function(t){var s=Math.exp(t);return s=(s-1/s)/2},ws=function(t,s){t=Math.abs(t),s=Math.abs(s);var i=Math.max(t,s),a=Math.min(t,s)/(i||1);return i*Math.sqrt(1+Math.pow(a,2))},Ns=function(t){var s=1+t,i=s-1;return 0===i?t:t*Math.log(s)/i},As=function(t){var s=Math.abs(t);return s=Ns(s*(1+s/(ws(1,s)+1))),t<0?-s:s},Es=function(t,s){for(var i,a=2*Math.cos(2*s),h=t.length-1,e=t[h],n=0;--h>=0;)i=a*e-n+t[h],n=e,e=i;return s+i*Math.sin(2*s)},Cs=function(t,s){for(var i,a=2*Math.cos(s),h=t.length-1,e=t[h],n=0;--h>=0;)i=a*e-n+t[h],n=e,e=i;return Math.sin(s)*i},Ps=function(t){var s=Math.exp(t);return s=(s+1/s)/2},Ss=function(t,s,i){for(var a,h,e=Math.sin(s),n=Math.cos(s),r=bs(i),o=Ps(i),l=2*n*o,u=-2*e*r,c=t.length-1,M=t[c],f=0,d=0,p=0;--c>=0;)a=d,h=f,M=l*(d=M)-a-u*(f=p)+t[c],p=u*d-h+l*f;return l=e*o,u=n*r,[l*M-u*p,l*p+u*M]},Is={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(vs.init.apply(this),this.forward=vs.forward,this.inverse=vs.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var t=this.es/(1+Math.sqrt(1-this.es)),s=t/(2-t),i=s;this.cgb[0]=s*(2+s*(-2/3+s*(s*(116/45+s*(26/45+s*(-2854/675)))-2))),this.cbg[0]=s*(s*(2/3+s*(4/3+s*(-82/45+s*(32/45+s*(4642/4725)))))-2),i*=s,this.cgb[1]=i*(7/3+s*(s*(-227/45+s*(2704/315+s*(2323/945)))-1.6)),this.cbg[1]=i*(5/3+s*(-16/15+s*(-13/9+s*(904/315+s*(-1522/945))))),i*=s,this.cgb[2]=i*(56/15+s*(-136/35+s*(-1262/105+s*(73814/2835)))),this.cbg[2]=i*(-26/15+s*(34/21+s*(1.6+s*(-12686/2835)))),i*=s,this.cgb[3]=i*(4279/630+s*(-332/35+s*(-399572/14175))),this.cbg[3]=i*(1237/630+s*(s*(-24832/14175)-2.4)),i*=s,this.cgb[4]=i*(4174/315+s*(-144838/6237)),this.cbg[4]=i*(-734/315+s*(109598/31185)),i*=s,this.cgb[5]=i*(601676/22275),this.cbg[5]=i*(444337/155925),i=Math.pow(s,2),this.Qn=this.k0/(1+s)*(1+i*(.25+i*(1/64+i/256))),this.utg[0]=s*(s*(2/3+s*(-37/96+s*(1/360+s*(81/512+s*(-96199/604800)))))-.5),this.gtu[0]=s*(.5+s*(-2/3+s*(5/16+s*(41/180+s*(-127/288+s*(7891/37800)))))),this.utg[1]=i*(-1/48+s*(-1/15+s*(437/1440+s*(-46/105+s*(1118711/3870720))))),this.gtu[1]=i*(13/48+s*(s*(557/1440+s*(281/630+s*(-1983433/1935360)))-.6)),i*=s,this.utg[2]=i*(-17/480+s*(37/840+s*(209/4480+s*(-5569/90720)))),this.gtu[2]=i*(61/240+s*(-103/140+s*(15061/26880+s*(167603/181440)))),i*=s,this.utg[3]=i*(-4397/161280+s*(11/504+s*(830251/7257600))),this.gtu[3]=i*(49561/161280+s*(-179/168+s*(6601661/7257600))),i*=s,this.utg[4]=i*(-4583/161280+s*(108847/3991680)),this.gtu[4]=i*(34729/80640+s*(-3418889/1995840)),i*=s,this.utg[5]=-.03233083094085698*i,this.gtu[5]=.6650675310896665*i;var a=Es(this.cbg,this.lat0);this.Zb=-this.Qn*(a+Cs(this.gtu,2*a))},forward:function(t){var s=Ht(t.x-this.long0),i=t.y;i=Es(this.cbg,i);var a=Math.sin(i),h=Math.cos(i),e=Math.sin(s),n=Math.cos(s);i=Math.atan2(a,n*h),s=Math.atan2(e*h,ws(a,h*n)),s=As(Math.tan(s));var r=Ss(this.gtu,2*i,2*s);i+=r[0],s+=r[1];var o,l;return Math.abs(s)<=2.623395162778?(o=this.a*(this.Qn*s)+this.x0,l=this.a*(this.Qn*i+this.Zb)+this.y0):(o=1/0,l=1/0),t.x=o,t.y=l,t},inverse:function(t){var s=(t.x-this.x0)*(1/this.a),i=(t.y-this.y0)*(1/this.a);i=(i-this.Zb)/this.Qn,s/=this.Qn;var a,h;if(Math.abs(s)<=2.623395162778){var e=Ss(this.utg,2*i,2*s);i+=e[0],s+=e[1],s=Math.atan(bs(s));var n=Math.sin(i),r=Math.cos(i),o=Math.sin(s),l=Math.cos(s);i=Math.atan2(n*l,ws(o,l*r)),s=Math.atan2(o,l*r),a=Ht(s+this.long0),h=Es(this.cgb,i)}else a=1/0,h=1/0;return t.x=a,t.y=h,t},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","tmerc"]},Os=function(t,s){if(void 0===t){if((t=Math.floor(30*(Ht(s)+Math.PI)/Math.PI)+1)<0)return 0;if(t>60)return 60}return t},ks={init:function(){var t=Os(this.zone,this.long0);if(void 0===t)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(t)-183)*Nt,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Is.init.apply(this),this.forward=Is.forward,this.inverse=Is.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"},qs=function(t,s){return Math.pow((1-t)/(1+t),s)},Rs=20,Ls={init:function(){var t=Math.sin(this.lat0),s=Math.cos(this.lat0);s*=s,this.rc=Math.sqrt(1-this.es)/(1-this.es*t*t),this.C=Math.sqrt(1+this.es*s*s/(1-this.es)),this.phic0=Math.asin(t/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Et)/(Math.pow(Math.tan(.5*this.lat0+Et),this.C)*qs(this.e*t,this.ratexp))},forward:function(t){var s=t.x,i=t.y;return t.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+Et),this.C)*qs(this.e*Math.sin(i),this.ratexp))-xt,t.x=this.C*s,t},inverse:function(t){for(var s=t.x/this.C,i=t.y,a=Math.pow(Math.tan(.5*i+Et)/this.K,1/this.C),h=Rs;h>0&&(i=2*Math.atan(a*qs(this.e*Math.sin(t.y),-.5*this.e))-xt,!(Math.abs(i-t.y)<1e-14));--h)t.y=i;return h?(t.x=s,t.y=i,t):null},names:["gauss"]},Ts={init:function(){Ls.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(t){var s,i,a,h;return t.x=Ht(t.x-this.long0),Ls.forward.apply(this,[t]),s=Math.sin(t.y),i=Math.cos(t.y),a=Math.cos(t.x),h=this.k0*this.R2/(1+this.sinc0*s+this.cosc0*i*a),t.x=h*i*Math.sin(t.x),t.y=h*(this.cosc0*s-this.sinc0*i*a),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t},inverse:function(t){var s,i,a,h,e;if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,e=Math.sqrt(t.x*t.x+t.y*t.y)){var n=2*Math.atan2(e,this.R2);s=Math.sin(n),i=Math.cos(n),h=Math.asin(i*this.sinc0+t.y*s*this.cosc0/e),a=Math.atan2(t.x*s,e*this.cosc0*i-t.y*this.sinc0*s)}else h=this.phic0,a=0;return t.x=a,t.y=h,Ls.inverse.apply(this,[t]),t.x=Ht(t.x+this.long0),t},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]},Gs={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=wt&&(this.k0=.5*(1+Wt(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=wt&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=wt&&(this.k0=.5*this.cons*Qt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/Xt(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=Qt(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-xt,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(t){var s,i,a,h,e,n,r=t.x,o=t.y,l=Math.sin(o),u=Math.cos(o),c=Ht(r-this.long0);return Math.abs(Math.abs(r-this.long0)-Math.PI)<=wt&&Math.abs(o+this.lat0)<=wt?(t.x=NaN,t.y=NaN,t):this.sphere?(s=2*this.k0/(1+this.sinlat0*l+this.coslat0*u*Math.cos(c)),t.x=this.a*s*u*Math.sin(c)+this.x0,t.y=this.a*s*(this.coslat0*l-this.sinlat0*u*Math.cos(c))+this.y0,t):(i=2*Math.atan(this.ssfn_(o,l,this.e))-xt,h=Math.cos(i),a=Math.sin(i),Math.abs(this.coslat0)<=wt?(e=Xt(this.e,o*this.con,this.con*l),n=2*this.a*this.k0*e/this.cons,t.x=this.x0+n*Math.sin(r-this.long0),t.y=this.y0-this.con*n*Math.cos(r-this.long0),t):(Math.abs(this.sinlat0)<wt?(s=2*this.a*this.k0/(1+h*Math.cos(c)),t.y=s*a):(s=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*a+this.cosX0*h*Math.cos(c))),t.y=s*(this.cosX0*a-this.sinX0*h*Math.cos(c))+this.y0),t.x=s*h*Math.sin(c)+this.x0,t))},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s,i,a,h,e,n=Math.sqrt(t.x*t.x+t.y*t.y);if(this.sphere){var r=2*Math.atan(n/(2*this.a*this.k0));return s=this.long0,i=this.lat0,n<=wt?(t.x=s,t.y=i,t):(i=Math.asin(Math.cos(r)*this.sinlat0+t.y*Math.sin(r)*this.coslat0/n),s=Ht(Math.abs(this.coslat0)<wt?this.lat0>0?this.long0+Math.atan2(t.x,-1*t.y):this.long0+Math.atan2(t.x,t.y):this.long0+Math.atan2(t.x*Math.sin(r),n*this.coslat0*Math.cos(r)-t.y*this.sinlat0*Math.sin(r))),t.x=s,t.y=i,t)}if(Math.abs(this.coslat0)<=wt){if(n<=wt)return i=this.lat0,s=this.long0,t.x=s,t.y=i,t;t.x*=this.con,t.y*=this.con,a=n*this.cons/(2*this.a*this.k0),i=this.con*Jt(this.e,a),s=this.con*Ht(this.con*this.long0+Math.atan2(t.x,-1*t.y))}else h=2*Math.atan(n*this.cosX0/(2*this.a*this.k0*this.ms1)),s=this.long0,n<=wt?e=this.X0:(e=Math.asin(Math.cos(h)*this.sinX0+t.y*Math.sin(h)*this.cosX0/n),s=Ht(this.long0+Math.atan2(t.x*Math.sin(h),n*this.cosX0*Math.cos(h)-t.y*this.sinX0*Math.sin(h)))),i=-1*Jt(this.e,Math.tan(.5*(xt+e)));return t.x=s,t.y=i,t},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(t,s,i){return s*=i,Math.tan(.5*(xt+t))*Math.pow((1-s)/(1+s),.5*i)}},js={init:function(){var t=this.lat0;this.lambda0=this.long0;var s=Math.sin(t),i=this.a,a=1/this.rf,h=2*a-Math.pow(a,2),e=this.e=Math.sqrt(h);this.R=this.k0*i*Math.sqrt(1-h)/(1-h*Math.pow(s,2)),this.alpha=Math.sqrt(1+h/(1-h)*Math.pow(Math.cos(t),4)),this.b0=Math.asin(s/this.alpha);var n=Math.log(Math.tan(Math.PI/4+this.b0/2)),r=Math.log(Math.tan(Math.PI/4+t/2)),o=Math.log((1+e*s)/(1-e*s));this.K=n-this.alpha*r+this.alpha*e/2*o},forward:function(t){var s=Math.log(Math.tan(Math.PI/4-t.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y))),a=-this.alpha*(s+i)+this.K,h=2*(Math.atan(Math.exp(a))-Math.PI/4),e=this.alpha*(t.x-this.lambda0),n=Math.atan(Math.sin(e)/(Math.sin(this.b0)*Math.tan(h)+Math.cos(this.b0)*Math.cos(e))),r=Math.asin(Math.cos(this.b0)*Math.sin(h)-Math.sin(this.b0)*Math.cos(h)*Math.cos(e));return t.y=this.R/2*Math.log((1+Math.sin(r))/(1-Math.sin(r)))+this.y0,t.x=this.R*n+this.x0,t},inverse:function(t){for(var s=t.x-this.x0,i=t.y-this.y0,a=s/this.R,h=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),e=Math.asin(Math.cos(this.b0)*Math.sin(h)+Math.sin(this.b0)*Math.cos(h)*Math.cos(a)),n=Math.atan(Math.sin(a)/(Math.cos(this.b0)*Math.cos(a)-Math.sin(this.b0)*Math.tan(h))),r=this.lambda0+n/this.alpha,o=0,l=e,u=-1e3,c=0;Math.abs(l-u)>1e-7;){if(++c>20)return;o=1/this.alpha*(Math.log(Math.tan(Math.PI/4+e/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(l))/2)),u=l,l=2*Math.atan(Math.exp(o))-Math.PI/2}return t.x=r,t.y=l,t},names:["somerc"]},Bs=1e-7,zs={init:function(){var t,s,i,a,h,e,n,r,o,l,u,c=0,M=0,f=0,d=0,p=0,m=0,_=0;this.no_off=rt(this),this.no_rot="no_rot"in this;var y=!1;"alpha"in this&&(y=!0);var x=!1;if("rectified_grid_angle"in this&&(x=!0),y&&(_=this.alpha),x&&(c=this.rectified_grid_angle*Nt),y||x)M=this.longc;else if(f=this.long1,p=this.lat1,d=this.long2,m=this.lat2,Math.abs(p-m)<=Bs||(t=Math.abs(p))<=Bs||Math.abs(t-xt)<=Bs||Math.abs(Math.abs(this.lat0)-xt)<=Bs||Math.abs(Math.abs(m)-xt)<=Bs)throw new Error;var g=1-this.es;s=Math.sqrt(g),Math.abs(this.lat0)>wt?(r=Math.sin(this.lat0),i=Math.cos(this.lat0),t=1-this.es*r*r,this.B=i*i,this.B=Math.sqrt(1+this.es*this.B*this.B/g),this.A=this.B*this.k0*s/t,(h=(a=this.B*s/(i*Math.sqrt(t)))*a-1)<=0?h=0:(h=Math.sqrt(h),this.lat0<0&&(h=-h)),this.E=h+=a,this.E*=Math.pow(Xt(this.e,this.lat0,r),this.B)):(this.B=1/s,this.A=this.k0,this.E=a=h=1),y||x?(y?(u=Math.asin(Math.sin(_)/a),x||(c=_)):(u=c,_=Math.asin(a*Math.sin(u))),this.lam0=M-Math.asin(.5*(h-1/h)*Math.tan(u))/this.B):(e=Math.pow(Xt(this.e,p,Math.sin(p)),this.B),n=Math.pow(Xt(this.e,m,Math.sin(m)),this.B),h=this.E/e,o=(n-e)/(n+e),l=((l=this.E*this.E)-n*e)/(l+n*e),(t=f-d)<-Math.pi?d-=Ct:t>Math.pi&&(d+=Ct),this.lam0=Ht(.5*(f+d)-Math.atan(l*Math.tan(.5*this.B*(f-d))/o)/this.B),u=Math.atan(2*Math.sin(this.B*Ht(f-this.lam0))/(h-1/h)),c=_=Math.asin(a*Math.sin(u))),this.singam=Math.sin(u),this.cosgam=Math.cos(u),this.sinrot=Math.sin(c),this.cosrot=Math.cos(c),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(a*a-1)/Math.cos(_))),this.lat0<0&&(this.u_0=-this.u_0)),h=.5*u,this.v_pole_n=this.ArB*Math.log(Math.tan(Et-h)),this.v_pole_s=this.ArB*Math.log(Math.tan(Et+h))},forward:function(t){var s,i,a,h,e,n,r,o,l={};if(t.x=t.x-this.lam0,Math.abs(Math.abs(t.y)-xt)>wt){if(e=this.E/Math.pow(Xt(this.e,t.y,Math.sin(t.y)),this.B),n=1/e,s=.5*(e-n),i=.5*(e+n),h=Math.sin(this.B*t.x),a=(s*this.singam-h*this.cosgam)/i,Math.abs(Math.abs(a)-1)<wt)throw new Error;o=.5*this.ArB*Math.log((1-a)/(1+a)),n=Math.cos(this.B*t.x),r=Math.abs(n)<Bs?this.A*t.x:this.ArB*Math.atan2(s*this.cosgam+h*this.singam,n)}else o=t.y>0?this.v_pole_n:this.v_pole_s,r=this.ArB*t.y;return this.no_rot?(l.x=r,l.y=o):(r-=this.u_0,l.x=o*this.cosrot+r*this.sinrot,l.y=r*this.cosrot-o*this.sinrot),l.x=this.a*l.x+this.x0,l.y=this.a*l.y+this.y0,l},inverse:function(t){var s,i,a,h,e,n,r,o={};if(t.x=(t.x-this.x0)*(1/this.a),t.y=(t.y-this.y0)*(1/this.a),this.no_rot?(i=t.y,s=t.x):(i=t.x*this.cosrot-t.y*this.sinrot,s=t.y*this.cosrot+t.x*this.sinrot+this.u_0),a=Math.exp(-this.BrA*i),h=.5*(a-1/a),e=.5*(a+1/a),n=Math.sin(this.BrA*s),r=(n*this.cosgam+h*this.singam)/e,Math.abs(Math.abs(r)-1)<wt)o.x=0,o.y=r<0?-xt:xt;else{if(o.y=this.E/Math.sqrt((1+r)/(1-r)),o.y=Jt(this.e,Math.pow(o.y,1/this.B)),o.y===1/0)throw new Error;o.x=-this.rB*Math.atan2(h*this.cosgam-n*this.singam,Math.cos(this.BrA*s))}return o.x+=this.lam0,o},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"]},Fs={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<wt)){var t=this.b/this.a;this.e=Math.sqrt(1-t*t);var s=Math.sin(this.lat1),i=Math.cos(this.lat1),a=Qt(this.e,s,i),h=Xt(this.e,this.lat1,s),e=Math.sin(this.lat2),n=Math.cos(this.lat2),r=Qt(this.e,e,n),o=Xt(this.e,this.lat2,e),l=Xt(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>wt?this.ns=Math.log(a/r)/Math.log(h/o):this.ns=s,isNaN(this.ns)&&(this.ns=s),this.f0=a/(this.ns*Math.pow(h,this.ns)),this.rh=this.a*this.f0*Math.pow(l,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(t){var s=t.x,i=t.y;Math.abs(2*Math.abs(i)-Math.PI)<=wt&&(i=Wt(i)*(xt-2*wt));var a,h,e=Math.abs(Math.abs(i)-xt);if(e>wt)a=Xt(this.e,i,Math.sin(i)),h=this.a*this.f0*Math.pow(a,this.ns);else{if((e=i*this.ns)<=0)return null;h=0}var n=this.ns*Ht(s-this.long0);return t.x=this.k0*(h*Math.sin(n))+this.x0,t.y=this.k0*(this.rh-h*Math.cos(n))+this.y0,t},inverse:function(t){var s,i,a,h,e,n=(t.x-this.x0)/this.k0,r=this.rh-(t.y-this.y0)/this.k0;this.ns>0?(s=Math.sqrt(n*n+r*r),i=1):(s=-Math.sqrt(n*n+r*r),i=-1);var o=0;if(0!==s&&(o=Math.atan2(i*n,i*r)),0!==s||this.ns>0){if(i=1/this.ns,a=Math.pow(s/(this.a*this.f0),i),-9999===(h=Jt(this.e,a)))return null}else h=-xt;return e=Ht(o/this.ns+this.long0),t.x=e,t.y=h,t},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc","Lambert Conic Conformal (1SP)","Lambert Conic Conformal (2SP)"]},Ds={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(t){var s,i,a,h,e,n,r,o=t.x,l=t.y,u=Ht(o-this.long0);return s=Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.alfa*this.e/2),i=2*(Math.atan(this.k*Math.pow(Math.tan(l/2+this.s45),this.alfa)/s)-this.s45),a=-u*this.alfa,h=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(a)),e=Math.asin(Math.cos(i)*Math.sin(a)/Math.cos(h)),n=this.n*e,r=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(h/2+this.s45),this.n),t.y=r*Math.cos(n)/1,t.x=r*Math.sin(n)/1,this.czech||(t.y*=-1,t.x*=-1),t},inverse:function(t){var s,i,a,h,e,n,r,o=t.x;t.x=t.y,t.y=o,this.czech||(t.y*=-1,t.x*=-1),e=Math.sqrt(t.x*t.x+t.y*t.y),h=Math.atan2(t.y,t.x)/Math.sin(this.s0),a=2*(Math.atan(Math.pow(this.ro0/e,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),s=Math.asin(Math.cos(this.ad)*Math.sin(a)-Math.sin(this.ad)*Math.cos(a)*Math.cos(h)),i=Math.asin(Math.cos(a)*Math.sin(h)/Math.cos(s)),t.x=this.long0-i/this.alfa,n=s,r=0;var l=0;do{t.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(s/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(n))/(1-this.e*Math.sin(n)),this.e/2))-this.s45),Math.abs(n-t.y)<1e-10&&(r=1),n=t.y,l+=1}while(0===r&&l<15);return l>=15?null:t},names:["Krovak","krovak"]},Us=function(t,s,i,a,h){return t*h-s*Math.sin(2*h)+i*Math.sin(4*h)-a*Math.sin(6*h)},Qs=function(t){return 1-.25*t*(1+t/16*(3+1.25*t))},Ws=function(t){return.375*t*(1+.25*t*(1+.46875*t))},Hs=function(t){return.05859375*t*t*(1+.75*t)},Xs=function(t){return t*t*t*(35/3072)},Js=function(t,s,i){var a=s*i;return t/Math.sqrt(1-a*a)},Ks=function(t){return Math.abs(t)<xt?t:t-Wt(t)*Math.PI},Vs=function(t,s,i,a,h){var e,n;e=t/s;for(var r=0;r<15;r++)if(n=(t-(s*e-i*Math.sin(2*e)+a*Math.sin(4*e)-h*Math.sin(6*e)))/(s-2*i*Math.cos(2*e)+4*a*Math.cos(4*e)-6*h*Math.cos(6*e)),e+=n,Math.abs(n)<=1e-10)return e;return NaN},Zs={init:function(){this.sphere||(this.e0=Qs(this.es),this.e1=Ws(this.es),this.e2=Hs(this.es),this.e3=Xs(this.es),this.ml0=this.a*Us(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(t){var s,i,a=t.x,h=t.y;if(a=Ht(a-this.long0),this.sphere)s=this.a*Math.asin(Math.cos(h)*Math.sin(a)),i=this.a*(Math.atan2(Math.tan(h),Math.cos(a))-this.lat0);else{var e=Math.sin(h),n=Math.cos(h),r=Js(this.a,this.e,e),o=Math.tan(h)*Math.tan(h),l=a*Math.cos(h),u=l*l,c=this.es*n*n/(1-this.es);s=r*l*(1-u*o*(1/6-(8-o+8*c)*u/120)),i=this.a*Us(this.e0,this.e1,this.e2,this.e3,h)-this.ml0+r*e/n*u*(.5+(5-o+6*c)*u/24)}return t.x=s+this.x0,t.y=i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s,i,a=t.x/this.a,h=t.y/this.a;if(this.sphere){var e=h+this.lat0;s=Math.asin(Math.sin(e)*Math.cos(a)),i=Math.atan2(Math.tan(a),Math.cos(e))}else{var n=this.ml0/this.a+h,r=Vs(n,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(r)-xt)<=wt)return t.x=this.long0,t.y=xt,h<0&&(t.y*=-1),t;var o=Js(this.a,this.e,Math.sin(r)),l=o*o*o/this.a/this.a*(1-this.es),u=Math.pow(Math.tan(r),2),c=a*this.a/o,M=c*c;s=r-o*Math.tan(r)/l*c*c*(.5-(1+3*u)*c*c/24),i=c*(1-M*(u/3+(1+3*u)*u*M/15))/Math.cos(r)}return t.x=Ht(i+this.long0),t.y=Ks(s),t},names:["Cassini","Cassini_Soldner","cass"]},Ys=function(t,s){var i;return t>1e-7?(i=t*s,(1-t*t)*(s/(1-i*i)-.5/t*Math.log((1-i)/(1+i)))):2*s},$s=.3333333333333333,ti=.17222222222222222,si=.10257936507936508,ii=.06388888888888888,ai=.0664021164021164,hi=.016415012942191543,ei={init:function(){var t=Math.abs(this.lat0);if(Math.abs(t-xt)<wt?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(t)<wt?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0){var s;switch(this.qp=Ys(this.e,1),this.mmf=.5/(1-this.es),this.apa=ot(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),s=Math.sin(this.lat0),this.sinb1=Ys(this.e,s)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*s*s)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(t){var s,i,a,h,e,n,r,o,l,u,c=t.x,M=t.y;if(c=Ht(c-this.long0),this.sphere){if(e=Math.sin(M),u=Math.cos(M),a=Math.cos(c),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((i=this.mode===this.EQUIT?1+u*a:1+this.sinph0*e+this.cosph0*u*a)<=wt)return null;s=(i=Math.sqrt(2/i))*u*Math.sin(c),i*=this.mode===this.EQUIT?e:this.cosph0*e-this.sinph0*u*a}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(a=-a),Math.abs(M+this.lat0)<wt)return null;i=Et-.5*M,s=(i=2*(this.mode===this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(c),i*=a}}else{switch(r=0,o=0,l=0,a=Math.cos(c),h=Math.sin(c),e=Math.sin(M),n=Ys(this.e,e),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(r=n/this.qp,o=Math.sqrt(1-r*r)),this.mode){case this.OBLIQ:l=1+this.sinb1*r+this.cosb1*o*a;break;case this.EQUIT:l=1+o*a;break;case this.N_POLE:l=xt+M,n=this.qp-n;break;case this.S_POLE:l=M-xt,n=this.qp+n}if(Math.abs(l)<wt)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:l=Math.sqrt(2/l),i=this.mode===this.OBLIQ?this.ymf*l*(this.cosb1*r-this.sinb1*o*a):(l=Math.sqrt(2/(1+o*a)))*r*this.ymf,s=this.xmf*l*o*h;break;case this.N_POLE:case this.S_POLE:n>=0?(s=(l=Math.sqrt(n))*h,i=a*(this.mode===this.S_POLE?l:-l)):s=i=0}}return t.x=this.a*s+this.x0,t.y=this.a*i+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s,i,a,h,e,n,r,o=t.x/this.a,l=t.y/this.a;if(this.sphere){var u,c=0,M=0;if(u=Math.sqrt(o*o+l*l),(i=.5*u)>1)return null;switch(i=2*Math.asin(i),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(M=Math.sin(i),c=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(u)<=wt?0:Math.asin(l*M/u),o*=M,l=c*u;break;case this.OBLIQ:i=Math.abs(u)<=wt?this.lat0:Math.asin(c*this.sinph0+l*M*this.cosph0/u),o*=M*this.cosph0,l=(c-Math.sin(i)*this.sinph0)*u;break;case this.N_POLE:l=-l,i=xt-i;break;case this.S_POLE:i-=xt}s=0!==l||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(o,l):0}else{if(r=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(o/=this.dd,l*=this.dd,(n=Math.sqrt(o*o+l*l))<wt)return t.x=this.long0,t.y=this.lat0,t;h=2*Math.asin(.5*n/this.rq),a=Math.cos(h),o*=h=Math.sin(h),this.mode===this.OBLIQ?(r=a*this.sinb1+l*h*this.cosb1/n,e=this.qp*r,l=n*this.cosb1*a-l*this.sinb1*h):(r=l*h/n,e=this.qp*r,l=n*a)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(l=-l),!(e=o*o+l*l))return t.x=this.long0,t.y=this.lat0,t;r=1-e/this.qp,this.mode===this.S_POLE&&(r=-r)}s=Math.atan2(o,l),i=lt(Math.asin(r),this.apa)}return t.x=Ht(this.long0+s),t.y=i,t},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4},ni=function(t){return Math.abs(t)>1&&(t=t>1?1:-1),Math.asin(t)},ri={init:function(){Math.abs(this.lat1+this.lat2)<wt||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=Qt(this.e3,this.sin_po,this.cos_po),this.qs1=Ys(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Qt(this.e3,this.sin_po,this.cos_po),this.qs2=Ys(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Ys(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>wt?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(t){var s=t.x,i=t.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var a=Ys(this.e3,this.sin_phi,this.cos_phi),h=this.a*Math.sqrt(this.c-this.ns0*a)/this.ns0,e=this.ns0*Ht(s-this.long0),n=h*Math.sin(e)+this.x0,r=this.rh-h*Math.cos(e)+this.y0;return t.x=n,t.y=r,t},inverse:function(t){var s,i,a,h,e,n;return t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns0>=0?(s=Math.sqrt(t.x*t.x+t.y*t.y),a=1):(s=-Math.sqrt(t.x*t.x+t.y*t.y),a=-1),h=0,0!==s&&(h=Math.atan2(a*t.x,a*t.y)),a=s*this.ns0/this.a,this.sphere?n=Math.asin((this.c-a*a)/(2*this.ns0)):(i=(this.c-a*a)/this.ns0,n=this.phi1z(this.e3,i)),e=Ht(h/this.ns0+this.long0),t.x=e,t.y=n,t},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(t,s){var i,a,h,e,n,r=ni(.5*s);if(t<wt)return r;for(var o=t*t,l=1;l<=25;l++)if(i=Math.sin(r),a=Math.cos(r),h=t*i,e=1-h*h,n=.5*e*e/a*(s/(1-o)-i/e+.5/t*Math.log((1-h)/(1+h))),r+=n,Math.abs(n)<=1e-7)return r;return null}},oi={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(t){var s,i,a,h,e,n,r,o=t.x,l=t.y;return a=Ht(o-this.long0),s=Math.sin(l),i=Math.cos(l),h=Math.cos(a),(e=this.sin_p14*s+this.cos_p14*i*h)>0||Math.abs(e)<=wt?(n=this.x0+1*this.a*i*Math.sin(a)/e,r=this.y0+1*this.a*(this.cos_p14*s-this.sin_p14*i*h)/e):(n=this.x0+this.infinity_dist*i*Math.sin(a),r=this.y0+this.infinity_dist*(this.cos_p14*s-this.sin_p14*i*h)),t.x=n,t.y=r,t},inverse:function(t){var s,i,a,h,e,n;return t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,(s=Math.sqrt(t.x*t.x+t.y*t.y))?(h=Math.atan2(s,this.rc),i=Math.sin(h),a=Math.cos(h),n=ni(a*this.sin_p14+t.y*i*this.cos_p14/s),e=Math.atan2(t.x*i,s*this.cos_p14*a-t.y*this.sin_p14*i),e=Ht(this.long0+e)):(n=this.phic0,e=0),t.x=e,t.y=n,t},names:["gnom"]},li=function(t,s){var i=1-(1-t*t)/(2*t)*Math.log((1-t)/(1+t));if(Math.abs(Math.abs(s)-i)<1e-6)return s<0?-1*xt:xt;for(var a,h,e,n,r=Math.asin(.5*s),o=0;o<30;o++)if(h=Math.sin(r),e=Math.cos(r),n=t*h,a=Math.pow(1-n*n,2)/(2*e)*(s/(1-t*t)-h/(1-n*n)+.5/t*Math.log((1-n)/(1+n))),r+=a,Math.abs(a)<=1e-10)return r;return NaN},ui={init:function(){this.sphere||(this.k0=Qt(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(t){var s,i,a=t.x,h=t.y,e=Ht(a-this.long0);if(this.sphere)s=this.x0+this.a*e*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(h)/Math.cos(this.lat_ts);else{var n=Ys(this.e,Math.sin(h));s=this.x0+this.a*this.k0*e,i=this.y0+this.a*n*.5/this.k0}return t.x=s,t.y=i,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s,i;return this.sphere?(s=Ht(this.long0+t.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(t.y/this.a*Math.cos(this.lat_ts))):(i=li(this.e,2*t.y*this.k0/this.a),s=Ht(this.long0+t.x/(this.a*this.k0))),t.x=s,t.y=i,t},names:["cea"]},ci={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(t){var s=t.x,i=t.y,a=Ht(s-this.long0),h=Ks(i-this.lat0);return t.x=this.x0+this.a*a*this.rc,t.y=this.y0+this.a*h,t},inverse:function(t){var s=t.x,i=t.y;return t.x=Ht(this.long0+(s-this.x0)/(this.a*this.rc)),t.y=Ks(this.lat0+(i-this.y0)/this.a),t},names:["Equirectangular","Equidistant_Cylindrical","eqc"]},Mi=20,fi={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Qs(this.es),this.e1=Ws(this.es),this.e2=Hs(this.es),this.e3=Xs(this.es),this.ml0=this.a*Us(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(t){var s,i,a,h=t.x,e=t.y,n=Ht(h-this.long0);if(a=n*Math.sin(e),this.sphere)Math.abs(e)<=wt?(s=this.a*n,i=-1*this.a*this.lat0):(s=this.a*Math.sin(a)/Math.tan(e),i=this.a*(Ks(e-this.lat0)+(1-Math.cos(a))/Math.tan(e)));else if(Math.abs(e)<=wt)s=this.a*n,i=-1*this.ml0;else{var r=Js(this.a,this.e,Math.sin(e))/Math.tan(e);s=r*Math.sin(a),i=this.a*Us(this.e0,this.e1,this.e2,this.e3,e)-this.ml0+r*(1-Math.cos(a))}return t.x=s+this.x0,t.y=i+this.y0,t},inverse:function(t){var s,i,a,h,e,n,r,o,l;if(a=t.x-this.x0,h=t.y-this.y0,this.sphere)if(Math.abs(h+this.a*this.lat0)<=wt)s=Ht(a/this.a+this.long0),i=0;else{n=this.lat0+h/this.a,r=a*a/this.a/this.a+n*n,o=n;var u;for(e=Mi;e;--e)if(u=Math.tan(o),l=-1*(n*(o*u+1)-o-.5*(o*o+r)*u)/((o-n)/u-1),o+=l,Math.abs(l)<=wt){i=o;break}s=Ht(this.long0+Math.asin(a*Math.tan(o)/this.a)/Math.sin(i))}else if(Math.abs(h+this.ml0)<=wt)i=0,s=Ht(this.long0+a/this.a);else{n=(this.ml0+h)/this.a,r=a*a/this.a/this.a+n*n,o=n;var c,M,f,d,p;for(e=Mi;e;--e)if(p=this.e*Math.sin(o),c=Math.sqrt(1-p*p)*Math.tan(o),M=this.a*Us(this.e0,this.e1,this.e2,this.e3,o),f=this.e0-2*this.e1*Math.cos(2*o)+4*this.e2*Math.cos(4*o)-6*this.e3*Math.cos(6*o),d=M/this.a,l=(n*(c*d+1)-d-.5*c*(d*d+r))/(this.es*Math.sin(2*o)*(d*d+r-2*n*d)/(4*c)+(n-d)*(c*f-2/Math.sin(2*o))-f),o-=l,Math.abs(l)<=wt){i=o;break}c=Math.sqrt(1-this.es*Math.pow(Math.sin(i),2))*Math.tan(i),s=Ht(this.long0+Math.asin(a*c/this.a)/Math.sin(i))}return t.x=s,t.y=i,t},names:["Polyconic","poly"]},di={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(t){var s,i=t.x,a=t.y-this.lat0,h=i-this.long0,e=a/yt*1e-5,n=h,r=1,o=0;for(s=1;s<=10;s++)r*=e,o+=this.A[s]*r;var l,u=o,c=n,M=1,f=0,d=0,p=0;for(s=1;s<=6;s++)l=f*u+M*c,M=M*u-f*c,f=l,d=d+this.B_re[s]*M-this.B_im[s]*f,p=p+this.B_im[s]*M+this.B_re[s]*f;return t.x=p*this.a+this.x0,t.y=d*this.a+this.y0,t},inverse:function(t){var s,i,a=t.x,h=t.y,e=a-this.x0,n=(h-this.y0)/this.a,r=e/this.a,o=1,l=0,u=0,c=0;for(s=1;s<=6;s++)i=l*n+o*r,o=o*n-l*r,l=i,u=u+this.C_re[s]*o-this.C_im[s]*l,c=c+this.C_im[s]*o+this.C_re[s]*l;for(var M=0;M<this.iterations;M++){var f,d=u,p=c,m=n,_=r;for(s=2;s<=6;s++)f=p*u+d*c,d=d*u-p*c,p=f,m+=(s-1)*(this.B_re[s]*d-this.B_im[s]*p),_+=(s-1)*(this.B_im[s]*d+this.B_re[s]*p);d=1,p=0;var y=this.B_re[1],x=this.B_im[1];for(s=2;s<=6;s++)f=p*u+d*c,d=d*u-p*c,p=f,y+=s*(this.B_re[s]*d-this.B_im[s]*p),x+=s*(this.B_im[s]*d+this.B_re[s]*p);var g=y*y+x*x;u=(m*y+_*x)/g,c=(_*y-m*x)/g}var v=u,b=c,w=1,N=0;for(s=1;s<=9;s++)w*=v,N+=this.D[s]*w;var A=this.lat0+N*yt*1e5,E=this.long0+b;return t.x=E,t.y=A,t},names:["New_Zealand_Map_Grid","nzmg"]},pi={init:function(){},forward:function(t){var s=t.x,i=t.y,a=Ht(s-this.long0),h=this.x0+this.a*a,e=this.y0+this.a*Math.log(Math.tan(Math.PI/4+i/2.5))*1.25;return t.x=h,t.y=e,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s=Ht(this.long0+t.x/this.a),i=2.5*(Math.atan(Math.exp(.8*t.y/this.a))-Math.PI/4);return t.x=s,t.y=i,t},names:["Miller_Cylindrical","mill"]},mi=20,_i={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=ys(this.es)},forward:function(t){var s,i,a=t.x,h=t.y;if(a=Ht(a-this.long0),this.sphere){if(this.m)for(var e=this.n*Math.sin(h),n=mi;n;--n){var r=(this.m*h+Math.sin(h)-e)/(this.m+Math.cos(h));if(h-=r,Math.abs(r)<wt)break}else h=1!==this.n?Math.asin(this.n*Math.sin(h)):h;s=this.a*this.C_x*a*(this.m+Math.cos(h)),i=this.a*this.C_y*h}else{var o=Math.sin(h),l=Math.cos(h);i=this.a*xs(h,o,l,this.en),s=this.a*a*l/Math.sqrt(1-this.es*o*o)}return t.x=s,t.y=i,t},inverse:function(t){var s,i,a,h;return t.x-=this.x0,a=t.x/this.a,t.y-=this.y0,s=t.y/this.a,this.sphere?(s/=this.C_y,a/=this.C_x*(this.m+Math.cos(s)),this.m?s=ni((this.m*s+Math.sin(s))/this.n):1!==this.n&&(s=ni(Math.sin(s)/this.n)),a=Ht(a+this.long0),s=Ks(s)):(s=gs(t.y/this.a,this.es,this.en),(h=Math.abs(s))<xt?(h=Math.sin(s),i=this.long0+t.x*Math.sqrt(1-this.es*h*h)/(this.a*Math.cos(s)),a=Ht(i)):h-wt<xt&&(a=this.long0)),t.x=a,t.y=s,t},names:["Sinusoidal","sinu"]},yi={init:function(){},forward:function(t){for(var s=t.x,i=t.y,a=Ht(s-this.long0),h=i,e=Math.PI*Math.sin(i);;){var n=-(h+Math.sin(h)-e)/(1+Math.cos(h));if(h+=n,Math.abs(n)<wt)break}h/=2,Math.PI/2-Math.abs(i)<wt&&(a=0);var r=.900316316158*this.a*a*Math.cos(h)+this.x0,o=1.4142135623731*this.a*Math.sin(h)+this.y0;return t.x=r,t.y=o,t},inverse:function(t){var s,i;t.x-=this.x0,t.y-=this.y0,i=t.y/(1.4142135623731*this.a),Math.abs(i)>.999999999999&&(i=.999999999999),s=Math.asin(i);var a=Ht(this.long0+t.x/(.900316316158*this.a*Math.cos(s)));a<-Math.PI&&(a=-Math.PI),a>Math.PI&&(a=Math.PI),i=(2*s+Math.sin(2*s))/Math.PI,Math.abs(i)>1&&(i=1);var h=Math.asin(i);return t.x=a,t.y=h,t},names:["Mollweide","moll"]},xi={init:function(){Math.abs(this.lat1+this.lat2)<wt||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Qs(this.es),this.e1=Ws(this.es),this.e2=Hs(this.es),this.e3=Xs(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Qt(this.e,this.sinphi,this.cosphi),this.ml1=Us(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<wt?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Qt(this.e,this.sinphi,this.cosphi),this.ml2=Us(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Us(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(t){var s,i=t.x,a=t.y;if(this.sphere)s=this.a*(this.g-a);else{var h=Us(this.e0,this.e1,this.e2,this.e3,a);s=this.a*(this.g-h)}var e=this.ns*Ht(i-this.long0),n=this.x0+s*Math.sin(e),r=this.y0+this.rh-s*Math.cos(e);return t.x=n,t.y=r,t},inverse:function(t){t.x-=this.x0,t.y=this.rh-t.y+this.y0;var s,i,a,h;this.ns>=0?(i=Math.sqrt(t.x*t.x+t.y*t.y),s=1):(i=-Math.sqrt(t.x*t.x+t.y*t.y),s=-1);var e=0;if(0!==i&&(e=Math.atan2(s*t.x,s*t.y)),this.sphere)return h=Ht(this.long0+e/this.ns),a=Ks(this.g-i/this.a),t.x=h,t.y=a,t;var n=this.g-i/this.a;return a=Vs(n,this.e0,this.e1,this.e2,this.e3),h=Ht(this.long0+e/this.ns),t.x=h,t.y=a,t},names:["Equidistant_Conic","eqdc"]},gi={init:function(){this.R=this.a},forward:function(t){var s,i,a=t.x,h=t.y,e=Ht(a-this.long0);Math.abs(h)<=wt&&(s=this.x0+this.R*e,i=this.y0);var n=ni(2*Math.abs(h/Math.PI));(Math.abs(e)<=wt||Math.abs(Math.abs(h)-xt)<=wt)&&(s=this.x0,i=h>=0?this.y0+Math.PI*this.R*Math.tan(.5*n):this.y0+Math.PI*this.R*-Math.tan(.5*n));var r=.5*Math.abs(Math.PI/e-e/Math.PI),o=r*r,l=Math.sin(n),u=Math.cos(n),c=u/(l+u-1),M=c*c,f=c*(2/l-1),d=f*f,p=Math.PI*this.R*(r*(c-d)+Math.sqrt(o*(c-d)*(c-d)-(d+o)*(M-d)))/(d+o);e<0&&(p=-p),s=this.x0+p;var m=o+c;return p=Math.PI*this.R*(f*m-r*Math.sqrt((d+o)*(o+1)-m*m))/(d+o),i=h>=0?this.y0+p:this.y0-p,t.x=s,t.y=i,t},inverse:function(t){var s,i,a,h,e,n,r,o,l,u,c,M,f;return t.x-=this.x0,t.y-=this.y0,c=Math.PI*this.R,a=t.x/c,h=t.y/c,e=a*a+h*h,n=-Math.abs(h)*(1+e),r=n-2*h*h+a*a,o=-2*n+1+2*h*h+e*e,f=h*h/o+(2*r*r*r/o/o/o-9*n*r/o/o)/27,l=(n-r*r/3/o)/o,u=2*Math.sqrt(-l/3),c=3*f/l/u,Math.abs(c)>1&&(c=c>=0?1:-1),M=Math.acos(c)/3,i=t.y>=0?(-u*Math.cos(M+Math.PI/3)-r/3/o)*Math.PI:-(-u*Math.cos(M+Math.PI/3)-r/3/o)*Math.PI,s=Math.abs(a)<wt?this.long0:Ht(this.long0+Math.PI*(e-1+Math.sqrt(1+2*(a*a-h*h)+e*e))/2/a),t.x=s,t.y=i,t},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]},vi={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(t){var s,i,a,h,e,n,r,o,l,u,c,M,f,d,p,m,_,y,x,g,v,b,w,N=t.x,A=t.y,E=Math.sin(t.y),C=Math.cos(t.y),P=Ht(N-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=wt?(t.x=this.x0+this.a*(xt-A)*Math.sin(P),t.y=this.y0-this.a*(xt-A)*Math.cos(P),t):Math.abs(this.sin_p12+1)<=wt?(t.x=this.x0+this.a*(xt+A)*Math.sin(P),t.y=this.y0+this.a*(xt+A)*Math.cos(P),t):(y=this.sin_p12*E+this.cos_p12*C*Math.cos(P),m=Math.acos(y),_=m?m/Math.sin(m):1,t.x=this.x0+this.a*_*C*Math.sin(P),t.y=this.y0+this.a*_*(this.cos_p12*E-this.sin_p12*C*Math.cos(P)),t):(s=Qs(this.es),i=Ws(this.es),a=Hs(this.es),h=Xs(this.es),Math.abs(this.sin_p12-1)<=wt?(e=this.a*Us(s,i,a,h,xt),n=this.a*Us(s,i,a,h,A),t.x=this.x0+(e-n)*Math.sin(P),t.y=this.y0-(e-n)*Math.cos(P),t):Math.abs(this.sin_p12+1)<=wt?(e=this.a*Us(s,i,a,h,xt),n=this.a*Us(s,i,a,h,A),t.x=this.x0+(e+n)*Math.sin(P),t.y=this.y0+(e+n)*Math.cos(P),t):(r=E/C,o=Js(this.a,this.e,this.sin_p12),l=Js(this.a,this.e,E),u=Math.atan((1-this.es)*r+this.es*o*this.sin_p12/(l*C)),c=Math.atan2(Math.sin(P),this.cos_p12*Math.tan(u)-this.sin_p12*Math.cos(P)),x=0===c?Math.asin(this.cos_p12*Math.sin(u)-this.sin_p12*Math.cos(u)):Math.abs(Math.abs(c)-Math.PI)<=wt?-Math.asin(this.cos_p12*Math.sin(u)-this.sin_p12*Math.cos(u)):Math.asin(Math.sin(P)*Math.cos(u)/Math.sin(c)),M=this.e*this.sin_p12/Math.sqrt(1-this.es),f=this.e*this.cos_p12*Math.cos(c)/Math.sqrt(1-this.es),d=M*f,p=f*f,g=x*x,v=g*x,b=v*x,w=b*x,m=o*x*(1-g*p*(1-p)/6+v/8*d*(1-2*p)+b/120*(p*(4-7*p)-3*M*M*(1-7*p))-w/48*d),t.x=this.x0+m*Math.sin(c),t.y=this.y0+m*Math.cos(c),t))},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var s,i,a,h,e,n,r,o,l,u,c,M,f,d,p,m,_,y,x,g,v,b,w,N;if(this.sphere){if((s=Math.sqrt(t.x*t.x+t.y*t.y))>2*xt*this.a)return;return i=s/this.a,a=Math.sin(i),h=Math.cos(i),e=this.long0,Math.abs(s)<=wt?n=this.lat0:(n=ni(h*this.sin_p12+t.y*a*this.cos_p12/s),r=Math.abs(this.lat0)-xt,e=Ht(Math.abs(r)<=wt?this.lat0>=0?this.long0+Math.atan2(t.x,-t.y):this.long0-Math.atan2(-t.x,t.y):this.long0+Math.atan2(t.x*a,s*this.cos_p12*h-t.y*this.sin_p12*a))),t.x=e,t.y=n,t}return o=Qs(this.es),l=Ws(this.es),u=Hs(this.es),c=Xs(this.es),Math.abs(this.sin_p12-1)<=wt?(M=this.a*Us(o,l,u,c,xt),s=Math.sqrt(t.x*t.x+t.y*t.y),f=M-s,n=Vs(f/this.a,o,l,u,c),e=Ht(this.long0+Math.atan2(t.x,-1*t.y)),t.x=e,t.y=n,t):Math.abs(this.sin_p12+1)<=wt?(M=this.a*Us(o,l,u,c,xt),s=Math.sqrt(t.x*t.x+t.y*t.y),f=s-M,n=Vs(f/this.a,o,l,u,c),e=Ht(this.long0+Math.atan2(t.x,t.y)),t.x=e,t.y=n,t):(s=Math.sqrt(t.x*t.x+t.y*t.y),m=Math.atan2(t.x,t.y),d=Js(this.a,this.e,this.sin_p12),_=Math.cos(m),y=this.e*this.cos_p12*_,x=-y*y/(1-this.es),g=3*this.es*(1-x)*this.sin_p12*this.cos_p12*_/(1-this.es),v=s/d,b=v-x*(1+x)*Math.pow(v,3)/6-g*(1+3*x)*Math.pow(v,4)/24,w=1-x*b*b/2-v*b*b*b/6,p=Math.asin(this.sin_p12*Math.cos(b)+this.cos_p12*Math.sin(b)*_),e=Ht(this.long0+Math.asin(Math.sin(m)*Math.sin(b)/Math.cos(p))),N=Math.sin(p),n=Math.atan2((N-this.es*w*this.sin_p12)*Math.tan(p),N*(1-this.es)),t.x=e,t.y=n,t)},names:["Azimuthal_Equidistant","aeqd"]},bi={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(t){var s,i,a,h,e,n,r,o=t.x,l=t.y;return a=Ht(o-this.long0),s=Math.sin(l),i=Math.cos(l),h=Math.cos(a),((e=this.sin_p14*s+this.cos_p14*i*h)>0||Math.abs(e)<=wt)&&(n=1*this.a*i*Math.sin(a),r=this.y0+1*this.a*(this.cos_p14*s-this.sin_p14*i*h)),t.x=n,t.y=r,t},inverse:function(t){var s,i,a,h,e,n,r;return t.x-=this.x0,t.y-=this.y0,s=Math.sqrt(t.x*t.x+t.y*t.y),i=ni(s/this.a),a=Math.sin(i),h=Math.cos(i),n=this.long0,Math.abs(s)<=wt?(r=this.lat0,t.x=n,t.y=r,t):(r=ni(h*this.sin_p14+t.y*a*this.cos_p14/s),e=Math.abs(this.lat0)-xt,Math.abs(e)<=wt?(n=Ht(this.lat0>=0?this.long0+Math.atan2(t.x,-t.y):this.long0-Math.atan2(-t.x,t.y)),t.x=n,t.y=r,t):(n=Ht(this.long0+Math.atan2(t.x*a,s*this.cos_p14*h-t.y*this.sin_p14*a)),t.x=n,t.y=r,t))},names:["ortho"]},wi={FRONT:1,RIGHT:2,BACK:3,LEFT:4,TOP:5,BOTTOM:6},Ni={AREA_0:1,AREA_1:2,AREA_2:3,AREA_3:4},Ai={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=xt-Et/2?this.face=wi.TOP:this.lat0<=-(xt-Et/2)?this.face=wi.BOTTOM:Math.abs(this.long0)<=Et?this.face=wi.FRONT:Math.abs(this.long0)<=xt+Et?this.face=this.long0>0?wi.RIGHT:wi.LEFT:this.face=wi.BACK,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(t){var s,i,a,h,e,n,r={x:0,y:0},o={value:0};if(t.x-=this.long0,s=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(t.y)):t.y,i=t.x,this.face===wi.TOP)h=xt-s,i>=Et&&i<=xt+Et?(o.value=Ni.AREA_0,a=i-xt):i>xt+Et||i<=-(xt+Et)?(o.value=Ni.AREA_1,a=i>0?i-Pt:i+Pt):i>-(xt+Et)&&i<=-Et?(o.value=Ni.AREA_2,a=i+xt):(o.value=Ni.AREA_3,a=i);else if(this.face===wi.BOTTOM)h=xt+s,i>=Et&&i<=xt+Et?(o.value=Ni.AREA_0,a=-i+xt):i<Et&&i>=-Et?(o.value=Ni.AREA_1,a=-i):i<-Et&&i>=-(xt+Et)?(o.value=Ni.AREA_2,a=-i-xt):(o.value=Ni.AREA_3,a=i>0?-i+Pt:-i-Pt);else{var l,u,c,M,f,d;this.face===wi.RIGHT?i=ct(i,+xt):this.face===wi.BACK?i=ct(i,+Pt):this.face===wi.LEFT&&(i=ct(i,-xt)),M=Math.sin(s),f=Math.cos(s),d=Math.sin(i),l=f*Math.cos(i),u=f*d,c=M,this.face===wi.FRONT?a=ut(h=Math.acos(l),c,u,o):this.face===wi.RIGHT?a=ut(h=Math.acos(u),c,-l,o):this.face===wi.BACK?a=ut(h=Math.acos(-l),c,-u,o):this.face===wi.LEFT?a=ut(h=Math.acos(-u),c,l,o):(h=a=0,o.value=Ni.AREA_0)}return n=Math.atan(12/Pt*(a+Math.acos(Math.sin(a)*Math.cos(Et))-xt)),e=Math.sqrt((1-Math.cos(h))/(Math.cos(n)*Math.cos(n))/(1-Math.cos(Math.atan(1/Math.cos(a))))),o.value===Ni.AREA_1?n+=xt:o.value===Ni.AREA_2?n+=Pt:o.value===Ni.AREA_3&&(n+=1.5*Pt),r.x=e*Math.cos(n),r.y=e*Math.sin(n),r.x=r.x*this.a+this.x0,r.y=r.y*this.a+this.y0,t.x=r.x,t.y=r.y,t},inverse:function(t){var s,i,a,h,e,n,r,o,l,u={lam:0,phi:0},c={value:0};if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,i=Math.atan(Math.sqrt(t.x*t.x+t.y*t.y)),s=Math.atan2(t.y,t.x),t.x>=0&&t.x>=Math.abs(t.y)?c.value=Ni.AREA_0:t.y>=0&&t.y>=Math.abs(t.x)?(c.value=Ni.AREA_1,s-=xt):t.x<0&&-t.x>=Math.abs(t.y)?(c.value=Ni.AREA_2,s=s<0?s+Pt:s-Pt):(c.value=Ni.AREA_3,s+=xt),l=Pt/12*Math.tan(s),e=Math.sin(l)/(Math.cos(l)-1/Math.sqrt(2)),n=Math.atan(e),a=Math.cos(s),h=Math.tan(i),(r=1-a*a*h*h*(1-Math.cos(Math.atan(1/Math.cos(n)))))<-1?r=-1:r>1&&(r=1),this.face===wi.TOP)o=Math.acos(r),u.phi=xt-o,c.value===Ni.AREA_0?u.lam=n+xt:c.value===Ni.AREA_1?u.lam=n<0?n+Pt:n-Pt:c.value===Ni.AREA_2?u.lam=n-xt:u.lam=n;else if(this.face===wi.BOTTOM)o=Math.acos(r),u.phi=o-xt,c.value===Ni.AREA_0?u.lam=-n+xt:c.value===Ni.AREA_1?u.lam=-n:c.value===Ni.AREA_2?u.lam=-n-xt:u.lam=n<0?-n-Pt:-n+Pt;else{var M,f,d;l=(M=r)*M,f=(l+=(d=l>=1?0:Math.sqrt(1-l)*Math.sin(n))*d)>=1?0:Math.sqrt(1-l),c.value===Ni.AREA_1?(l=f,f=-d,d=l):c.value===Ni.AREA_2?(f=-f,d=-d):c.value===Ni.AREA_3&&(l=f,f=d,d=-l),this.face===wi.RIGHT?(l=M,M=-f,f=l):this.face===wi.BACK?(M=-M,f=-f):this.face===wi.LEFT&&(l=M,M=f,f=-l),u.phi=Math.acos(-d)-xt,u.lam=Math.atan2(f,M),this.face===wi.RIGHT?u.lam=ct(u.lam,-xt):this.face===wi.BACK?u.lam=ct(u.lam,-Pt):this.face===wi.LEFT&&(u.lam=ct(u.lam,+xt))}if(0!==this.es){var p,m,_;p=u.phi<0?1:0,m=Math.tan(u.phi),_=this.b/Math.sqrt(m*m+this.one_minus_f_squared),u.phi=Math.atan(Math.sqrt(this.a*this.a-_*_)/(this.one_minus_f*_)),p&&(u.phi=-u.phi)}return u.lam+=this.long0,t.x=u.lam,t.y=u.phi,t},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]},Ei=[[1,2.2199e-17,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],Ci=[[-5.20417e-18,.0124,1.21431e-18,-8.45284e-11],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Pi=.8487,Si=1.3523,Ii=At/5,Oi=1/Ii,ki=18,qi=function(t,s){return t[0]+s*(t[1]+s*(t[2]+s*t[3]))},Ri=function(t,s){return t[1]+s*(2*t[2]+3*s*t[3])},Li={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(t){var s=Ht(t.x-this.long0),i=Math.abs(t.y),a=Math.floor(i*Ii);a<0?a=0:a>=ki&&(a=ki-1),i=At*(i-Oi*a);var h={x:qi(Ei[a],i)*s,y:qi(Ci[a],i)};return t.y<0&&(h.y=-h.y),h.x=h.x*this.a*Pi+this.x0,h.y=h.y*this.a*Si+this.y0,h},inverse:function(t){var s={x:(t.x-this.x0)/(this.a*Pi),y:Math.abs(t.y-this.y0)/(this.a*Si)};if(s.y>=1)s.x/=Ei[ki][0],s.y=t.y<0?-xt:xt;else{var i=Math.floor(s.y*ki);for(i<0?i=0:i>=ki&&(i=ki-1);;)if(Ci[i][0]>s.y)--i;else{if(!(Ci[i+1][0]<=s.y))break;++i}var a=Ci[i],h=5*(s.y-a[0])/(Ci[i+1][0]-a[0]);h=Mt(function(t){return(qi(a,t)-s.y)/Ri(a,t)},h,wt,100),s.x/=qi(Ei[i],h),s.y=(5*i+h)*Nt,t.y<0&&(s.y=-s.y)}return s.x=Ht(s.x+this.long0),s},names:["Robinson","robin"]},Ti={init:function(){this.name="geocent"},forward:function(t){return k(t,this.es,this.a)},inverse:function(t){return q(t,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]},Gi={N_POLE:0,S_POLE:1,EQUIT:2,OBLIQ:3},ji={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}},Bi={init:function(){if(Object.keys(ji).forEach(function(t){if(void 0===this[t])this[t]=ji[t].def;else{if(ji[t].num&&isNaN(this[t]))throw new Error("Invalid parameter value, must be numeric "+t+" = "+this[t]);ji[t].num&&(this[t]=parseFloat(this[t]))}ji[t].degrees&&(this[t]=this[t]*Nt)}.bind(this)),Math.abs(Math.abs(this.lat0)-xt)<wt?this.mode=this.lat0<0?Gi.S_POLE:Gi.N_POLE:Math.abs(this.lat0)<wt?this.mode=Gi.EQUIT:(this.mode=Gi.OBLIQ,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var t=this.tilt,s=this.azi;this.cg=Math.cos(s),this.sg=Math.sin(s),this.cw=Math.cos(t),this.sw=Math.sin(t)},forward:function(t){t.x-=this.long0;var s,i,a=Math.sin(t.y),h=Math.cos(t.y),e=Math.cos(t.x);switch(this.mode){case Gi.OBLIQ:i=this.sinph0*a+this.cosph0*h*e;break;case Gi.EQUIT:i=h*e;break;case Gi.S_POLE:i=-a;break;case Gi.N_POLE:i=a}switch(i=this.pn1/(this.p-i),s=i*h*Math.sin(t.x),this.mode){case Gi.OBLIQ:i*=this.cosph0*a-this.sinph0*h*e;break;case Gi.EQUIT:i*=a;break;case Gi.N_POLE:i*=-h*e;break;case Gi.S_POLE:i*=h*e}var n,r;return n=i*this.cg+s*this.sg,r=1/(n*this.sw*this.h1+this.cw),s=(s*this.cg-i*this.sg)*this.cw*r,i=n*r,t.x=s*this.a,t.y=i*this.a,t},inverse:function(t){t.x/=this.a,t.y/=this.a;var s,i,a,h={x:t.x,y:t.y};a=1/(this.pn1-t.y*this.sw),s=this.pn1*t.x*a,i=this.pn1*t.y*this.cw*a,t.x=s*this.cg+i*this.sg,t.y=i*this.cg-s*this.sg;var e=ws(t.x,t.y);if(Math.abs(e)<wt)h.x=0,h.y=t.y;else{var n,r;switch(r=1-e*e*this.pfact,r=(this.p-Math.sqrt(r))/(this.pn1/e+e/this.pn1),n=Math.sqrt(1-r*r),this.mode){case Gi.OBLIQ:h.y=Math.asin(n*this.sinph0+t.y*r*this.cosph0/e),t.y=(n-this.sinph0*Math.sin(h.y))*e,t.x*=r*this.cosph0;break;case Gi.EQUIT:h.y=Math.asin(t.y*r/e),t.y=n*e,t.x*=r;break;case Gi.N_POLE:h.y=Math.asin(n),t.y=-t.y;break;case Gi.S_POLE:h.y=-Math.asin(n)}h.x=Math.atan2(t.x,t.y)}return t.x=h.x+this.long0,t.y=h.y,t},names:["Tilted_Perspective","tpers"]},zi={init:function(){if(this.flip_axis="x"===this.sweep?1:0,this.h=Number(this.h),this.radius_g_1=this.h/this.a,this.radius_g_1<=0||this.radius_g_1>1e10)throw new Error;if(this.radius_g=1+this.radius_g_1,this.C=this.radius_g*this.radius_g-1,0!==this.es){var t=1-this.es,s=1/t;this.radius_p=Math.sqrt(t),this.radius_p2=t,this.radius_p_inv2=s,this.shape="ellipse"}else this.radius_p=1,this.radius_p2=1,this.radius_p_inv2=1,this.shape="sphere";this.title||(this.title="Geostationary Satellite View")},forward:function(t){var s,i,a,h,e=t.x,n=t.y;if(e-=this.long0,"ellipse"===this.shape){n=Math.atan(this.radius_p2*Math.tan(n));var r=this.radius_p/ws(this.radius_p*Math.cos(n),Math.sin(n));if(i=r*Math.cos(e)*Math.cos(n),a=r*Math.sin(e)*Math.cos(n),h=r*Math.sin(n),(this.radius_g-i)*i-a*a-h*h*this.radius_p_inv2<0)return t.x=Number.NaN,t.y=Number.NaN,t;s=this.radius_g-i,this.flip_axis?(t.x=this.radius_g_1*Math.atan(a/ws(h,s)),t.y=this.radius_g_1*Math.atan(h/s)):(t.x=this.radius_g_1*Math.atan(a/s),t.y=this.radius_g_1*Math.atan(h/ws(a,s)))}else"sphere"===this.shape&&(s=Math.cos(n),i=Math.cos(e)*s,a=Math.sin(e)*s,h=Math.sin(n),s=this.radius_g-i,this.flip_axis?(t.x=this.radius_g_1*Math.atan(a/ws(h,s)),t.y=this.radius_g_1*Math.atan(h/s)):(t.x=this.radius_g_1*Math.atan(a/s),t.y=this.radius_g_1*Math.atan(h/ws(a,s))));return t.x=t.x*this.a,t.y=t.y*this.a,t},inverse:function(t){var s,i,a,h,e=-1,n=0,r=0;if(t.x=t.x/this.a,t.y=t.y/this.a,"ellipse"===this.shape){this.flip_axis?(r=Math.tan(t.y/this.radius_g_1),n=Math.tan(t.x/this.radius_g_1)*ws(1,r)):(n=Math.tan(t.x/this.radius_g_1),r=Math.tan(t.y/this.radius_g_1)*ws(1,n));var o=r/this.radius_p;if(s=n*n+o*o+e*e,i=2*this.radius_g*e,(a=i*i-4*s*this.C)<0)return t.x=Number.NaN,t.y=Number.NaN,t;h=(-i-Math.sqrt(a))/(2*s),e=this.radius_g+h*e,n*=h,r*=h,t.x=Math.atan2(n,e),t.y=Math.atan(r*Math.cos(t.x)/e),t.y=Math.atan(this.radius_p_inv2*Math.tan(t.y))}else if("sphere"===this.shape){if(this.flip_axis?(r=Math.tan(t.y/this.radius_g_1),n=Math.tan(t.x/this.radius_g_1)*Math.sqrt(1+r*r)):(n=Math.tan(t.x/this.radius_g_1),r=Math.tan(t.y/this.radius_g_1)*Math.sqrt(1+n*n)),s=n*n+r*r+e*e,i=2*this.radius_g*e,(a=i*i-4*s*this.C)<0)return t.x=Number.NaN,t.y=Number.NaN,t;h=(-i-Math.sqrt(a))/(2*s),e=this.radius_g+h*e,n*=h,r*=h,t.x=Math.atan2(n,e),t.y=Math.atan(r*Math.cos(t.x)/e)}return t.x=t.x+this.long0,t},names:["Geostationary Satellite View","Geostationary_Satellite","geos"]};return W.defaultDatum="WGS84",W.Proj=Projection,W.WGS84=new W.Proj("WGS84"),W.Point=Point,W.toPoint=es,W.defs=o,W.nadgrid=function(t,s){var i=new DataView(s),a=N(i),h=A(i,a);h.nSubgrids>1&&console.log("Only single NTv2 subgrids are currently supported, subsequent sub grids are ignored");var e={header:h,subgrids:C(i,h,a)};return is[t]=e,e},W.transform=D,W.mgrs=ms,W.version="2.8.0",function(proj4){proj4.Proj.projections.add(vs),proj4.Proj.projections.add(Is),proj4.Proj.projections.add(ks),proj4.Proj.projections.add(Ts),proj4.Proj.projections.add(Gs),proj4.Proj.projections.add(js),proj4.Proj.projections.add(zs),proj4.Proj.projections.add(Fs),proj4.Proj.projections.add(Ds),proj4.Proj.projections.add(Zs),proj4.Proj.projections.add(ei),proj4.Proj.projections.add(ri),proj4.Proj.projections.add(oi),proj4.Proj.projections.add(ui),proj4.Proj.projections.add(ci),proj4.Proj.projections.add(fi),proj4.Proj.projections.add(di),proj4.Proj.projections.add(pi),proj4.Proj.projections.add(_i),proj4.Proj.projections.add(yi),proj4.Proj.projections.add(xi),proj4.Proj.projections.add(gi),proj4.Proj.projections.add(vi),proj4.Proj.projections.add(bi),proj4.Proj.projections.add(Ai),proj4.Proj.projections.add(Li),proj4.Proj.projections.add(Ti),proj4.Proj.projections.add(Bi),proj4.Proj.projections.add(zi)}(W),W});
    <!-- Mesaj Konsolu Toggle Butonu -->
    <button class="console-toggle-btn" id="consoleToggleBtn" onclick="toggleMessageConsole()" title="Mesaj Konsolu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,3H5C3.9,3 3,3.9 3,5V9H5V5H19V19H5V15H3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.9 20.1,3 19,3Z"/>
            <path d="M10.08,15.58L11.5,17L16.5,12L11.5,7L10.08,8.41L12.67,11H3V13H12.67L10.08,15.58Z"/>
        </svg>
    </button>
</body>
</html>
