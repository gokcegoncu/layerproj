<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBS Katman Yönetim Sistemi - Modern UI Enhanced v3.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sol Panel - Katman Yönetimi */
        .layer-panel {
            width: 380px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resize: horizontal;
            min-width: 250px;
            max-width: 600px;
        }

        /* Resize handle'ı daha belirgin yapalım */
        .layer-panel::-webkit-resizer {
            background: linear-gradient(135deg, #6c757d, #495057);
            border-radius: 2px;
        }

        .panel-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-layer-btn, .filter-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn {
            background: #17a2b8;
        }

        .add-layer-btn:hover {
            background: #218838;
        }

        .filter-btn:hover {
            background: #138496;
        }

        .layer-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        /* Katman Grubu */
        .layer-group {
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }

        .group-header {
            padding: 6px 10px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 6px 6px 0 0;
        }

        .group-header:hover {
            background: #dee2e6;
        }

        .group-checkbox {
            margin-right: 5px;
        }

        .group-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .group-icon.collapsed {
            transform: rotate(-90deg);
        }

        .group-name {
            flex: 1;
        }

        .group-count {
            font-size: 10px;
            font-weight: 400;
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            border: 1px solid rgba(108, 117, 125, 0.2);
        }

        .group-items {
            padding: 3px 1px 3px 4px;
            background: #fafbfc;
            border-left: 3px solid #e9ecef;
        }

        .group-items.collapsed {
            display: none;
        }

        /* Katman Elemanı */
        .layer-item {
            display: flex;
            align-items: flex-start;
            padding: 8px 4px;
            border-bottom: 1px solid #f1f3f5;
            background: white;
            transition: background-color 0.2s ease;
            border-radius: 4px;
            margin: 0px 0.5px 0px 16px;
            min-height: 40px;
            position: relative;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        .layer-item + .layer-item {
            margin-top: -1px;
        }

        .layer-item:hover {
            background: #f8f9fa;
        }

        /* Katman seçilebilir alanları */
        .layer-selectable-area {
            display: flex;
            align-items: flex-start;
            flex: 1;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
            gap: 4px;
        }

        .layer-selectable-area:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        .layer-visibility {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .layer-name {
            flex: 1;
            font-size: 12px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: normal;
            hyphens: auto;
            max-width: calc(100% - 100px);
            padding-top: 1px;
            white-space: normal;
        }

        /* Katman stil modu göstergesi */
        .layer-style-mode-indicator {
            margin-top: 2px;
            margin-left: 4px;
            margin-right: 4px;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            min-width: 16px;
            text-align: center;
            opacity: 0.7;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            flex-shrink: 0;
            color: #6c757d;
        }

        .layer-style-mode-indicator.default-mode {
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
        }

        .layer-style-mode-indicator.custom-mode {
            background: #28a745;
            color: white;
            border: 1px solid #28a745;
        }



        .layer-actions {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
            align-items: flex-start;
            margin-top: 2px;
        }

        .layer-action-btn {
            background: none;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            color: #6c757d;
            border-radius: 3px;
            font-size: 11px;
        }

        .layer-action-btn:hover {
            background: #e9ecef;
            color: #343a40;
        }

        /* Harita Alanı */
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #map {
            width: 100%;
            flex: 1;
            z-index: 1;
        }

        /* Koordinat ve Ölçek Status Bar */
        .status-bar {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #495057;
            min-height: 40px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coordinate-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .coordinate-item {
            background: white;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            min-width: 120px;
            text-align: center;
        }

        .scale-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scale-bar {
            width: 100px;
            height: 4px;
            background: #333;
            position: relative;
            border: 1px solid #000;
        }

        .scale-text {
            font-weight: 500;
            color: #333;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .scale-text:hover {
            background-color: #e9ecef;
        }

        .scale-selector {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .scale-selector.show {
            display: block !important;
        }

        .scale-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .scale-option:hover {
            background-color: #f8f9fa;
        }

        .scale-option:last-child {
            border-bottom: none;
        }

        .scale-option.current {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .projection-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .projection-select {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            background: white;
            cursor: pointer;
        }

        .projection-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 1px rgba(0,123,255,0.25);
        }

        .status-label {
            font-weight: 500;
            color: #6c757d;
        }

        /* Stil Ayarları Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            width: 480px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: move;
        }



        .modal-header {
            padding: 15px;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }



        /* Style Mode Toggle Button */
        .style-mode-toggle {
            background: linear-gradient(135deg, var(--primary-color), #1976d2);
            border: none;
            border-radius: var(--radius-medium);
            width: 42px;
            height: 42px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .style-mode-toggle:hover {
            background: linear-gradient(135deg, #1976d2, var(--primary-color));
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .style-mode-toggle:active {
            transform: translateY(0);
            box-shadow: var(--shadow-light);
        }

        .style-mode-toggle.custom-mode {
            background: linear-gradient(135deg, var(--accent-color), #f57c00);
        }

        .style-mode-toggle.custom-mode:hover {
            background: linear-gradient(135deg, #f57c00, var(--accent-color));
        }

        #styleModeIcon {
            font-size: 18px;
            transition: transform var(--transition-base);
        }

        .style-mode-toggle:hover #styleModeIcon {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .style-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .style-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
        }

        .style-tab.active {
            border-bottom-color: #0d6efd;
            color: #0d6efd;
            font-weight: 500;
        }

        .style-section {
            margin-bottom: 20px;
        }

        .style-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-row label {
            flex: 0 0 140px;
            font-size: 13px;
            color: #6c757d;
        }

        .control-row input[type="color"] {
            width: 40px;
            height: 25px;
            padding: 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .control-row input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }

        .control-row .value-display {
            min-width: 40px;
            text-align: right;
            font-size: 12px;
            color: #6c757d;
        }

        .control-row select {
            flex: 1;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }

        .modal-footer {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: var(--font-size-md);
            font-weight: 500;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            min-width: 80px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            background: #1976d2;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--text-muted);
            color: var(--text-inverse);
            box-shadow: var(--shadow-light);
        }

        .btn-secondary:hover {
            background: #5c636a;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Animasyonlar ve Hover Efektleri */
        .layer-item:hover,
        .group-header:hover,
        .tool-btn:hover {
            transform: translateY(-1px);
        }

        .layer-item:active,
        .group-header:active,
        .tool-btn:active {
            transform: translateY(0);
        }

        /* Loading Animasyonları */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            100% {
                left: 100%;
            }
        }

        /* Pulse Animasyonu */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Fade In Animasyonu */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide In Animasyonu */
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Ölçüm Tooltip'leri - Stabil Pozisyon */
        .measurement-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: var(--radius-small) !important;
            padding: 4px 8px !important;
            font-weight: bold !important;
            font-size: 12px !important;
            box-shadow: var(--shadow-medium) !important;
            white-space: nowrap !important;
            pointer-events: none !important;
            transform: none !important;
            position: relative !important;
        }

        .measurement-tooltip:before {
            display: none !important;
        }

        /* Ölçüm Noktaları */
        .measurement-point {
            cursor: crosshair !important;
            z-index: 1000 !important;
        }

        /* Drag and Drop */
        .layer-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg) scale(1.05);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
        }

        .layer-item.drag-over {
            border-top: 2px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), transparent);
        }

        /* Active State Animations */
        .tool-btn.active {
            animation: activeGlow 2s infinite;
        }

        @keyframes activeGlow {
            0%, 100% {
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            50% {
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 0 10px rgba(33, 150, 243, 0.3);
            }
        }

        /* Notification Animations */
        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Error State Animation */
        .error-shake {
            animation: errorShake 0.5s ease-in-out;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Katman İkonları Container */
        .layer-icons {
            display: flex;
            gap: 1px;
            margin-right: 4px;
        }

        /* SVG İkonları */
        .layer-icon {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layer-icon svg {
            width: 100%;
            height: 100%;
        }

        /* === LEJANT STİLLERİ === */
        .legend-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            max-width: 300px;
            z-index: 1000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: none;
        }

        .legend-header {
            background: #343a40;
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
        }

        .legend-controls {
            display: flex;
            gap: 5px;
        }

        .legend-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .legend-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .legend-settings {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            font-size: 12px;
        }

        .legend-setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-setting-item:last-child {
            margin-bottom: 0;
        }

        .legend-setting-item input[type="checkbox"] {
            margin-right: 6px;
        }

        .legend-setting-item label {
            cursor: pointer;
            color: #666;
        }

        .legend-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .legend-content.collapsed {
            display: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px;
            border-radius: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-symbol {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 13px;
            color: #333;
            flex: 1;
        }

        .legend-group {
            margin-bottom: 12px;
        }

        .legend-group-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #ddd;
        }

        /* Lejant toggle butonu */
        .legend-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 999;
            font-size: 13px;
            color: #333;
        }

        .legend-toggle:hover {
            background: #f8f9fa;
        }

        /* İkon Stilleri */
        .icon-point {
            color: #ff0000;
        }

        .icon-line {
            color: #ff7800;
        }

        .icon-polygon {
            color: #3388ff;
        }

        /* SVG elemanları için varsayılan stiller */
        .layer-icon svg rect,
        .layer-icon svg polygon,
        .layer-icon svg path {
            transition: all 0.2s ease;
        }

        .layer-icon svg line,
        .layer-icon svg polyline {
            stroke-width: 3;
            fill: none;
            stroke: currentColor;
        }

        /* İkon Durumları */
        .layer-icon.inactive {
            opacity: 0.3;
        }

        .layer-icon.active {
            opacity: 1;
        }

        /* Özellik Tablosu */
        .attribute-table {
            margin-top: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .attribute-row {
            display: flex;
            border-bottom: 1px solid #f1f3f5;
        }

        .attribute-row:last-child {
            border-bottom: none;
        }

        .attribute-label {
            padding: 6px 10px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            width: 120px;
            font-size: 12px;
            font-weight: 500;
        }

        .attribute-value {
            padding: 6px 10px;
            flex: 1;
            font-size: 12px;
        }

        /* Filtre Paneli */
        .filter-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 500;
            width: 300px;
            display: none;
        }

        .filter-panel.active {
            display: block;
        }

        /* Renk lejanı */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* Desen Seçici */
        .pattern-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .pattern-option {
            width: 40px;
            height: 40px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pattern-option.selected {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

        /* Label Ayarları */
        .label-settings {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Arama ve Filtre Paneli */
        .search-filter-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        /* İçe/Dışa Aktarma Menüsü */
        .import-export-menu {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 500;
            min-width: 200px;
            display: none;
        }

        .import-export-menu.active {
            display: block;
        }

        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }



        /* Undo/Redo Butonları */
        .action-buttons {
            position: absolute;
            top: 120px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 400;
        }

        .action-btn {
            background: white;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(0,0,0,0.1);
            z-index: 2000;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Toast Notifications - Enhanced */
        .toast {
            position: fixed;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: 10000;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-medium);
            color: var(--text-inverse);
            font-size: var(--font-size-md);
            font-weight: 500;
            box-shadow: var(--shadow-heavy);
            transform: translateX(100%);
            opacity: 0;
            transition: all var(--transition-base);
            max-width: 300px;
            word-wrap: break-word;
            background: var(--success-color);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success,
        .toast {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
        }

        .toast.error {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: var(--text-primary);
        }

        .toast.info,
        .toast-info {
            background: linear-gradient(135deg, var(--info-color), #148a9a);
        }

        .toast-success {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
        }

        .toast-warning {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: var(--text-primary);
        }

        .toast-error {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

                    /* Ölçüm Tooltip'leri */
        .measurement-tooltip {
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        .measurement-tooltip::before {
            display: none !important;
        }

        /* Ölçüm Noktaları */
        .measurement-point {
            background: #ff4444 !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            width: 8px !important;
            height: 8px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
        }

        /* Araç Kontrolleri - Birleşik Tasarım */
        .map-tools-container {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-width: 60px;
        }

        .tool-group {
            background: var(--bg-primary);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .tool-group-title {
            background: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-light);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .tool-buttons {
            display: flex;
            flex-direction: column;
        }

        .tool-btn {
            background: var(--bg-primary);
            border: none;
            border-bottom: 1px solid var(--border-light);
            padding: var(--spacing-sm);
            cursor: pointer;
            font-size: var(--font-size-md);
            color: var(--text-primary);
            transition: all var(--transition-base);
            min-width: 44px;
            min-height: 44px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-btn:last-child {
            border-bottom: none;
        }

        .tool-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .tool-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tool-btn.active:hover {
            background: #1976d2;
        }

        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tool-btn:disabled:hover {
            background: var(--bg-primary);
            transform: none;
            box-shadow: none;
        }



        /* Modern Responsive Design */
        
        /* Genel container fix */
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .left-panel {
            flex-shrink: 0;
        }
        
        .map-section {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Tablet Responsive (769px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .main-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .layer-panel {
                width: 100%;
                min-height: 200px;
                max-height: 250px;
                order: 2;
                overflow-y: auto;
                flex-shrink: 0;
                border-right: none;
                border-top: 1px solid var(--border-color);
                resize: none;
            }
            
            .map-container {
                order: 1;
                flex: 1;
                height: auto;
                min-height: 0;
            }
            
            .status-bar {
                order: 3;
                flex-shrink: 0;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: var(--font-size-sm);
            }
            
            .coordinate-display {
                gap: var(--spacing-md);
            }
            
            .coordinate-item {
                min-width: 120px;
                font-size: var(--font-size-sm);
            }
        }

        /* Mobil Responsive (481px - 768px) */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .layer-panel {
                width: 100%;
                min-height: 180px;
                max-height: 220px;
                order: 2;
                overflow-y: auto;
                flex-shrink: 0;
                border-right: none;
                border-top: 1px solid var(--border-color);
                resize: none;
            }
            
            .map-container {
                order: 1;
                flex: 1;
                height: auto;
                min-height: 0;
            }
            
            .status-bar {
                order: 3;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: var(--font-size-sm);
                flex-shrink: 0;
                min-height: 40px;
            }
            
            .coordinate-display {
                flex-direction: row;
                gap: var(--spacing-sm);
                font-size: var(--font-size-sm);
                flex-wrap: wrap;
            }
            
            .coordinate-item {
                min-width: 100px;
                font-size: var(--font-size-sm);
                padding: var(--spacing-sm);
            }
            
            .panel-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .panel-header h2 {
                font-size: var(--font-size-md);
            }
            
            .layer-item {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: var(--font-size-sm);
                min-height: 44px;
            }
            
            .layer-name {
                font-size: var(--font-size-sm);
                line-height: 1.3;
            }
            
            .create-buttons {
                padding: var(--spacing-sm);
                margin-bottom: var(--spacing-sm);
            }
            
            .create-group-btn, .create-layer-btn {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: var(--font-size-sm);
                min-height: 36px;
            }
            
            .expand-all-btn, .collapse-all-btn {
                padding: var(--spacing-sm);
                font-size: var(--font-size-sm);
                min-height: 32px;
            }
        }

        /* Küçük Mobil (max 480px) */
        @media (max-width: 480px) {
            .layer-panel {
                min-height: 160px;
                max-height: 200px;
            }
            
            .status-bar {
                font-size: var(--font-size-xs);
                padding: var(--spacing-sm);
                min-height: 36px;
            }
            
            .coordinate-display {
                gap: var(--spacing-xs);
                flex-wrap: wrap;
            }
            
            .coordinate-item {
                min-width: 80px;
                font-size: var(--font-size-xs);
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .panel-header {
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .panel-header h2 {
                font-size: var(--font-size-sm);
            }
            
            .layer-item {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--font-size-xs);
                min-height: 40px;
            }
            
            .layer-name {
                font-size: var(--font-size-xs);
                line-height: 1.2;
            }
            
            .create-buttons {
                padding: var(--spacing-xs);
                margin-bottom: var(--spacing-xs);
            }
            
            .primary-actions {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }
            
            .secondary-actions {
                grid-template-columns: 1fr 1fr;
                gap: var(--spacing-xs);
            }
            
            .create-group-btn, .create-layer-btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--font-size-xs);
                min-height: 32px;
            }
            
            .expand-all-btn, .collapse-all-btn {
                padding: var(--spacing-xs);
                font-size: var(--font-size-xs);
                min-height: 28px;
            }
        }

        /* === LAYOUT VE HİZALAMA DÜZELTMELERİ === */
        
        /* CSS Çakışmalarını Düzelt */
        .status-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-weight: 500;
        }

        .coordinate-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .coordinate-item {
            background: var(--bg-primary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            min-width: 100px;
            text-align: center;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        /* === GÖRSEL TUTARLILIK İYİLEŞTİRMELERİ === */
        
        /* Renk Tutarlılığı */
        .layer-group {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            background: var(--bg-primary);
            box-shadow: var(--shadow-light);
        }

        .group-header {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border-radius: var(--radius-medium) var(--radius-medium) 0 0;
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .group-items {
            background: var(--bg-secondary);
            border-left: 3px solid var(--border-light);
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        /* Font Tutarlılığı */
        .group-name {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .layer-name {
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--text-primary);
            line-height: 1.4;
        }

        /* === KULLANICI DENEYİMİ İYİLEŞTİRMELERİ === */
        
        /* Buton Boyutları ve Hover Efektleri */
        .layer-action-btn {
            background: none;
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            color: var(--text-muted);
            border-radius: var(--radius-small);
            font-size: var(--font-size-xs);
            transition: all var(--transition-base);
            min-width: 28px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layer-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .layer-action-btn:active {
            transform: translateY(0);
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error States */
        .error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: var(--danger-color);
        }

        .error-message {
            background: var(--danger-color);
            color: var(--text-inverse);
            padding: var(--spacing-sm);
            border-radius: var(--radius-small);
            margin: var(--spacing-sm) 0;
            font-size: var(--font-size-sm);
        }

        /* === ACCESSIBILITY İYİLEŞTİRMELERİ === */
        
        /* Focus States */
        .layer-action-btn:focus,
        .create-group-btn:focus,
        .create-layer-btn:focus,
        .expand-all-btn:focus,
        .collapse-all-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Keyboard Navigation */
        .layer-item:focus-within {
            box-shadow: 0 0 0 2px var(--primary-color);
            border-color: var(--primary-color);
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-primary: #000000;
                --bg-primary: #ffffff;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }

        /* === PERFORMANCE İYİLEŞTİRMELERİ === */
        
        /* Transition Optimizasyonu */
        .layer-item,
        .group-header,
        .layer-action-btn {
            transition: background-color var(--transition-base),
                        border-color var(--transition-base),
                        box-shadow var(--transition-base);
        }

        /* Box-shadow Optimizasyonu */
        .layer-group {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .layer-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* === EK İYİLEŞTİRMELER === */
        
        /* Scrollbar Styling */
        .layer-list::-webkit-scrollbar {
            width: 6px;
        }

        .layer-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .layer-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .layer-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Print Styles */
        @media print {
            .layer-panel,
            .status-bar,
            .layer-action-btn {
                display: none !important;
            }
            
            .map-container {
                width: 100% !important;
                height: 100% !important;
            }
        }

        /* Erişilebilirlik İyileştirmeleri */
        
        /* Yüksek kontrast modu */
        @media (prefers-contrast: high) {
            .layer-panel {
                border: 2px solid #000;
                background: #fff;
            }
            
            .layer-item, .group-header {
                border: 1px solid #000;
            }
            
            .tool-btn {
                border: 1px solid #000;
            }
        }

        /* Hareket azaltma */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
            
            .layer-item:hover,
            .group-header:hover,
            .tool-btn:hover {
                transform: none !important;
            }
        }

        /* Focus göstergeleri */
        .layer-item:focus,
        .tool-btn:focus,
        .group-header:focus,
        .btn:focus,
        .add-layer-btn:focus,
        .filter-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.2);
        }

        /* Klavye navigasyonu */
        .layer-item:focus,
        .group-header:focus {
            background: rgba(33, 150, 243, 0.1);
            border-color: var(--primary-color);
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Skip link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: var(--text-inverse);
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-small);
            z-index: 10000;
            transition: top var(--transition-base);
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #2d3748;
            --bg-secondary: #1a202c;
            --bg-tertiary: #4a5568;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --border-light: #2d3748;
        }

        [data-theme="dark"] body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .layer-panel {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .panel-header {
            background: var(--bg-primary);
        }

        /* Katman Detay Modalı */
        .layer-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .layer-details-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .layer-details-header {
            padding: 15px;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-details-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .layer-details-footer {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .feature-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .feature-row:hover {
            background: #f8f9fa;
        }

        .feature-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .feature-name {
            flex: 1;
        }

        .feature-actions {
            display: flex;
            gap: 5px;
        }

        /* Modern Katman Yönetimi Butonları */
        .create-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-large);
            border: 1px solid var(--border-light);
        }

        /* Ana Aksiyon Butonları Grubu */
        .primary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
        }

        /* İkincil Aksiyon Butonları Grubu */
        .secondary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        /* Temel Buton Stilleri */
        .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            text-align: center;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            min-height: 32px;
        }

        .create-group-btn svg, .create-layer-btn svg, .expand-all-btn svg, .collapse-all-btn svg {
            width: 14px;
            height: 14px;
            transition: transform var(--transition-base);
        }

        /* Ana Butonlar */
        .create-group-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .create-layer-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #218838 100%);
            color: var(--text-inverse);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* Özel Buton Stilleri */
        .save-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #218838 100%) !important;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3) !important;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%) !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4) !important;
        }

        .reset-btn {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%) !important;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3) !important;
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%) !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4) !important;
        }

        /* İkincil Butonlar */
        .expand-all-btn {
            background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%);
            color: var(--text-inverse);
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            min-height: 28px;
        }

        .collapse-all-btn {
            background: linear-gradient(135deg, var(--text-secondary) 0%, #495057 100%);
            color: var(--text-inverse);
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            min-height: 28px;
        }

        /* Hover Efektleri */
        .create-group-btn:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .create-layer-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .expand-all-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-1px);
        }

        .collapse-all-btn:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-1px);
        }

        /* İkon Animasyonları */
        .create-group-btn:hover svg,
        .create-layer-btn:hover svg {
            transform: scale(1.1);
        }

        .expand-all-btn:hover svg {
            transform: rotate(90deg);
        }

        .collapse-all-btn:hover svg {
            transform: rotate(-90deg);
        }

        /* Active States */
        .create-group-btn:active, .create-layer-btn:active {
            transform: translateY(0);
        }

                 .expand-all-btn:active, .collapse-all-btn:active {
             transform: translateY(0);
         }

         /* Responsive Tasarım */
         @media (max-width: 768px) {
             .create-buttons {
                 padding: var(--spacing-xs);
             }
             
             .primary-actions {
                 grid-template-columns: 1fr;
                 gap: var(--spacing-xs);
             }
             
             .secondary-actions {
                 grid-template-columns: 1fr;
                 gap: var(--spacing-xs);
             }
             
             .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
                 padding: var(--spacing-xs) var(--spacing-sm);
                 font-size: var(--font-size-xs);
                 min-height: 28px;
             }
             
             .create-group-btn svg, .create-layer-btn svg, .expand-all-btn svg, .collapse-all-btn svg {
                 width: 12px;
                 height: 12px;
             }
         }

         /* Küçük Ekranlar için */
         @media (max-width: 480px) {
             .create-buttons {
                 margin-bottom: var(--spacing-sm);
             }
             
             .create-group-btn, .create-layer-btn, .expand-all-btn, .collapse-all-btn {
                 font-size: var(--font-size-xs);
                 padding: 6px var(--spacing-xs);
                 min-height: 24px;
             }
         }

        /* Seçili Katman Vurguları - Yuvarlak Nokta */
        .layer-item.selected-highlight {
            background: rgba(255, 230, 230, 0.4) !important;
            color: #333 !important;
        }

        .layer-item.selected-highlight::after {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
        }
        
        .layer-item.selected-highlight .layer-name {
            font-weight: 500 !important;
        }
        
        /* Grup Header Yeniden Tasarım */
        .group-header {
            display: flex;
            align-items: center;
            background: #e9ecef;
            border-radius: 6px 6px 0 0;
        }

        /* Görünürlük Alanı - Sol */
        .group-visibility-area {
            padding: 2px 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            border-radius: 6px 0 0 0;
            border-right: 1px solid #dee2e6;
            background: #f1f3f5;
        }

        .group-visibility-area:hover {
            background: #e9ecef;
        }

        .group-visibility-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .group-visibility-checkbox:hover {
            transform: scale(1.3);
        }

        /* Seçim Alanı - Orta */
        .group-select-area {
            padding: 2px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            background: #e9ecef;
        }

        .group-select-area:hover {
            background: #dee2e6;
        }

        /* Toggle Alanı - Sağ */
        .group-toggle-area {
            padding: 2px 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            border-radius: 0 6px 0 0;
            border-left: 1px solid #dee2e6;
            background: #f1f3f5;
        }

        .group-toggle-area:hover {
            background: #e9ecef;
        }

        .group-icon {
            font-size: 14px;
            transition: transform 0.2s ease;
            font-weight: bold;
        }



        /* Modern Grup Seçimi - Yuvarlak Nokta */
        .group-header.selected {
            background: rgba(255, 235, 235, 0.6);
            position: relative;
        }

        .group-header.selected::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            z-index: 2;
        }

        .group-header.selected .group-name {
            font-weight: 500;
            color: #a91e2c;
        }

        .group-header.selected + .group-items {
            background: rgba(255, 245, 245, 0.4);
        }

        /* Grup Animasyonu */
        .group-header {
            transition: background-color 0.2s ease;
            border-radius: 6px 6px 0 0;
        }
        
        /* Seçili Bilgi Paneli - Kırmızı Tonlar */
        .selected-info-panel {
            border-bottom: 1px solid #dee2e6;
        }
        
        .selected-group-info {
            background: rgba(255, 240, 240, 0.6) !important;
            border: 1px solid rgba(220, 53, 69, 0.3) !important;
            border-radius: 8px;
            margin: 4px;
        }
        
        .selected-group-info > div {
            padding: 8px 10px !important;
            background: transparent !important;
            border: none !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            color: #721c24 !important;
        }
        
        .selected-layer-info {
            background: rgba(255, 240, 240, 0.6) !important;
            border: 1px solid rgba(255, 150, 150, 0.3) !important;
            border-radius: 8px;
            margin: 4px;
        }
        
        .selected-layer-info > div {
            padding: 8px 10px !important;
            background: transparent !important;
            border: none !important;
            font-weight: 600 !important;
            font-size: 12px !important;
            color: #a91e2c !important;
        }
        
        .selected-group-info button,
        .selected-layer-info button {
            background: rgba(0,0,0,0.1) !important;
            border: 1px solid rgba(0,0,0,0.2) !important;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .selected-group-info button:hover,
        .selected-layer-info button:hover {
            background: rgba(0,0,0,0.2) !important;
            transform: scale(1.1);
        }

        /* İkon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
        }

        /* Responsive Tasarım */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                order: 2;
            }
            
            .map-container {
                width: 100%;
                height: 60vh;
                order: 1;
            }
            
            .map-tools-container {
                top: 10px;
                right: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .tool-group {
                min-width: auto;
                flex: 0 0 auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                max-height: 250px;
            }
            
            .map-container {
                height: 50vh;
            }
            
            .map-tools-container {
                top: 5px;
                right: 5px;
                gap: 4px;
            }
            
            .tool-group {
                margin-bottom: 0;
            }
            
            .tool-group-title {
                font-size: 10px;
                padding: 2px 4px;
            }
            
            .tool-btn {
                width: 32px;
                height: 32px;
                padding: 6px;
            }
            
            .tool-btn svg {
                width: 14px;
                height: 14px;
            }
            
            .legend-container {
                max-width: 90vw;
                max-height: 70vh;
                bottom: 10px;
                left: 10px;
            }
            
            .layer-panel {
                padding: 8px;
            }
            
            .layer-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .group-header {
                padding: 4px 6px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .map-container {
                height: 45vh;
            }
            
            .sidebar {
                max-height: 200px;
            }
            
            .tool-group-title {
                display: none; /* Küçük ekranlarda başlıkları gizle */
            }
            
            .tool-buttons {
                gap: 2px;
            }
            
            .tool-btn {
                width: 28px;
                height: 28px;
                padding: 4px;
            }
            
            .tool-btn svg {
                width: 12px;
                height: 12px;
            }
            
            .legend-container {
                max-width: 95vw;
                max-height: 60vh;
                font-size: 12px;
                bottom: 5px;
                left: 5px;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 4px;
                padding: 4px 8px;
                font-size: 11px;
            }
            
                         .status-item {
                 min-width: auto;
             }
         }

        .icon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .icon-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .icon-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .icon-option img {
            width: 24px;
            height: 24px;
        }

        /* Etiket Stilleri */
        .feature-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-weight: bold !important;
            white-space: nowrap !important;
            pointer-events: none !important;
        }

        .feature-label::before {
            display: none !important;
        }

        /* ===== MESAJ KONSOLU ===== */
        .message-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 280px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            font-family: var(--font-mono);
            display: none;
            cursor: move;
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 150px;
        }

        .message-console.docked-bottom {
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-height: 200px;
            border-radius: 0;
            border-left: none;
            border-right: none;
            border-bottom: none;
            cursor: default;
            resize: vertical;
        }

        .message-console.show {
            display: flex;
            flex-direction: column;
        }

        .console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            border-radius: var(--radius-large) var(--radius-large) 0 0;
            border-bottom: 1px solid var(--border-light);
            cursor: move;
            user-select: none;
        }
        
        .message-console.docked-bottom .console-header {
            cursor: default;
        }

        .console-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .message-counter {
            background: rgba(255,255,255,0.2);
            color: var(--text-inverse);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: var(--spacing-xs);
            min-width: 20px;
            text-align: center;
        }

        .console-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .console-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-inverse);
            padding: 4px;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .console-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .console-filters {
            display: flex;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
        }

        .filter-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .filter-label input[type="checkbox"] {
            display: none;
        }

        .filter-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all var(--transition-base);
            opacity: 0.5;
        }

        .filter-label input[type="checkbox"]:checked + .filter-badge {
            opacity: 1;
        }

        .filter-badge.info {
            background: var(--info-color);
            color: var(--text-inverse);
        }

        .filter-badge.success {
            background: var(--success-color);
            color: var(--text-inverse);
        }

        .filter-badge.warning {
            background: var(--warning-color);
            color: var(--text-dark);
        }

        .filter-badge.error {
            background: var(--error-color);
            color: var(--text-inverse);
        }

        .console-content {
            flex: 1;
            overflow: hidden;
            border-radius: 0 0 var(--radius-large) var(--radius-large);
        }

        .console-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: var(--spacing-xs);
        }

        .console-messages::-webkit-scrollbar {
            width: 6px;
        }

        .console-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .console-messages::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }

        .console-message {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs);
            border-radius: var(--radius-small);
            margin-bottom: 2px;
            font-size: var(--font-size-xs);
            line-height: 1.4;
            transition: all var(--transition-base);
        }

        .console-message:hover {
            background: var(--bg-secondary);
        }

        .console-message.hidden {
            display: none;
        }

        .message-time {
            color: var(--text-muted);
            font-size: 10px;
            min-width: 45px;
            font-family: var(--font-mono);
        }

        .message-type {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 1px;
            flex-shrink: 0;
        }

        .message-type.info {
            background: var(--info-color);
        }

        .message-type.success {
            background: var(--success-color);
        }

        .message-type.warning {
            background: var(--warning-color);
        }

        .message-type.error {
            background: var(--error-color);
        }

        .message-text {
            flex: 1;
            color: var(--text-primary);
            word-break: normal;
            white-space: normal;
        }

        .console-minimized .console-content,
        .console-minimized .console-filters {
            display: none;
        }

        /* Console Toggle Button (Bottom Right) */
        .console-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1976d2 100%);
            color: var(--text-inverse);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }

        /* Konsol açıkken buton konumunu değiştir */
        .message-console.show:not(.docked-bottom) ~ .console-toggle-btn {
            right: 420px;
        }
        
        /* Docked modda buton gizle */
        .message-console.docked-bottom ~ .console-toggle-btn {
            display: none;
        }

        .console-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.5);
        }

        .console-toggle-btn.has-messages {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.8); }
            100% { box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .message-console:not(.docked-bottom) {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
                max-height: 50vh;
            }
            
            .message-console.docked-bottom {
                max-height: 40vh;
            }
        }


    </style>
</head>
<body>
    <!-- Mobile Header (visible only on mobile) -->
    <header class="mobile-header hidden" id="mobileHeader">
        <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menüyü aç">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-lg font-semibold">GIS Katman Yönetimi</h1>
        <div></div> <!-- Spacer for centering -->
    </header>

    <div class="app-container">
        <!-- Sidebar Overlay (mobile only) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">GIS Katman Yönetimi</h1>
                <p class="sidebar-subtitle">Harita katmanlarınızı kolayca yönetin</p>
            </div>

            <div class="sidebar-content">

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <div class="primary-actions">
                        <button class="btn btn-primary" id="addGroupBtn" aria-label="Yeni grup ekle">
                            <i class="fas fa-folder-plus"></i>
                            <span>Yeni Grup</span>
                        </button>
                        <button class="btn btn-secondary" id="addLayerBtn" aria-label="Yeni katman ekle">
                            <i class="fas fa-layer-group"></i>
                            <span>Yeni Katman</span>
                        </button>
                    </div>
                    
                    <div class="action-divider"></div>
                    
                    <div class="secondary-actions">
                        <button class="btn btn-sm btn-secondary" id="expandAllBtn" aria-label="Tümünü genişlet">
                            <i class="fas fa-expand-alt"></i>
                            <span>Genişlet</span>
                        </button>
                        <button class="btn btn-sm btn-secondary" id="collapseAllBtn" aria-label="Tümünü daralt">
                            <i class="fas fa-compress-alt"></i>
                            <span>Daralt</span>
                        </button>
                    </div>
                    
                    <div class="action-divider"></div>
                    
                    <div class="secondary-actions">
                        <button class="btn btn-sm btn-success" id="saveDataBtn" aria-label="Verileri kaydet">
                            <i class="fas fa-save"></i>
                            <span>Kaydet</span>
                        </button>
                        <button class="btn btn-sm btn-danger" id="resetDataBtn" aria-label="Verileri sıfırla">
                            <i class="fas fa-trash-alt"></i>
                            <span>Sıfırla</span>
                        </button>
                    </div>
                </div>
                <!-- Groups Container -->
                <div class="groups-container" id="groupsContainer">
                    <!-- Empty state will be shown here initially -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h3 class="empty-state-title">Henüz hiç grup yok</h3>
                        <p class="empty-state-description">
                            Başlamak için yukarıdaki "Yeni Grup" butonunu kullanarak ilk grubunuzu oluşturun.
                        </p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <main class="map-container">
            <div id="map" role="application" aria-label="Interaktif harita"></div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-left">
                    <span class="text-sm font-medium">Zoom: <span id="zoomLevel">6</span></span>
                </div>
                <div class="status-right">
                    <div class="coordinate-display">
                        <div class="coordinate-item">
                            <span>Lat: <span id="currentLat">39.9334</span></span>
                        </div>
                        <div class="coordinate-item">
                            <span>Lng: <span id="currentLng">32.8597</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Group Modal -->
    <div class="modal-overlay" id="groupModal" role="dialog" aria-labelledby="groupModalTitle" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="groupModalTitle">Yeni Grup Ekle</h2>
                <button class="modal-close" id="closeGroupModal" aria-label="Modalı kapat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupName" class="form-label">Grup Adı *</label>
                    <input type="text" id="groupName" class="form-input" placeholder="Grup adını girin" required aria-describedby="groupNameHelp">
                    <p id="groupNameHelp" class="text-xs text-muted mt-1">Grup için açıklayıcı bir isim girin</p>
                </div>
                <div class="form-group">
                    <label for="groupDescription" class="form-label">Açıklama</label>
                    <input type="text" id="groupDescription" class="form-input" placeholder="Grup açıklaması (isteğe bağlı)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelGroupBtn">İptal</button>
                <button class="btn btn-primary" id="saveGroupBtn">
                    <i class="fas fa-plus"></i>
                    <span>Grup Oluştur</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Layer Modal -->
    <div class="modal-overlay" id="layerModal" role="dialog" aria-labelledby="layerModalTitle" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="layerModalTitle">Yeni Katman Ekle</h2>
                <button class="modal-close" id="closeLayerModal" aria-label="Modalı kapat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="layerGroup" class="form-label">Grup Seçin *</label>
                    <select id="layerGroup" class="form-select" required aria-describedby="layerGroupHelp">
                        <option value="">Grup seçin...</option>
                    </select>
                    <p id="layerGroupHelp" class="text-xs text-muted mt-1">Bu katmanın hangi grupta olacağını seçin</p>
                </div>
                <div class="form-group">
                    <label for="layerName" class="form-label">Katman Adı *</label>
                    <input type="text" id="layerName" class="form-input" placeholder="Katman adını girin" required>
                </div>
                <div class="form-group">
                    <label for="layerType" class="form-label">Katman Tipi *</label>
                    <select id="layerType" class="form-select" required>
                        <option value="">Tip seçin...</option>
                        <option value="point">Nokta</option>
                        <option value="line">Çizgi</option>
                        <option value="polygon">Poligon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="layerColor" class="form-label">Renk</label>
                    <input type="color" id="layerColor" class="form-input" value="#3b82f6">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLayerBtn">İptal</button>
                <button class="btn btn-primary" id="saveLayerBtn">
                    <i class="fas fa-plus"></i>
                    <span>Katman Oluştur</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Style Modal -->
    <div class="modal-overlay" id="styleModal" role="dialog" aria-labelledby="styleModalTitle" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="styleModalTitle">Katman Stili Düzenle</h2>
                <button class="modal-close" id="closeStyleModal" aria-label="Modalı kapat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Stil Modu</label>
                    <div class="flex gap-3">
                        <button class="btn btn-primary" id="defaultStyleBtn" aria-label="Varsayılan stil">
                            <i class="fas fa-palette"></i>
                            <span>Varsayılan</span>
                        </button>
                        <button class="btn btn-secondary" id="customStyleBtn" aria-label="Özel stil">
                            <i class="fas fa-paint-brush"></i>
                            <span>Özel</span>
                        </button>
                    </div>
                </div>
                
                <div id="styleSettings" class="mt-4">
                    <div class="form-group">
                        <label for="styleColor" class="form-label">Renk</label>
                        <input type="color" id="styleColor" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="styleOpacity" class="form-label">Şeffaflık: <span id="opacityValue">1.0</span></label>
                        <input type="range" id="styleOpacity" class="form-input" min="0" max="1" step="0.1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="styleWeight" class="form-label">Kalınlık: <span id="weightValue">3</span>px</label>
                        <input type="range" id="styleWeight" class="form-input" min="1" max="10" value="3">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelStyleBtn">İptal</button>
                <button class="btn btn-primary" id="saveStyleBtn">
                    <i class="fas fa-check"></i>
                    <span>Stili Uygula</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Modern JavaScript Application -->
    <script>
        // === GLOBAL VARIABLES ===
        let map;
        let groups = [];
        let layers = [];
        let currentStyleMode = 'default';
        let selectedLayer = null;
        let isMobile = window.innerWidth <= 768;
        
        // Eksik global değişkenler (sadece eksik olanlar)
        let drawnItems = L.featureGroup();
        let isDrawingMode = false;
        let activeLayerId = null;
        let activeGroupId = null;
        let layerFeatures = {};
        let drawnLayers = [];

        // === APPLICATION INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 GIS Layer Management - Modern UI initialized');
            initializeMap();
            initializeEventListeners();
            initializeMobileSupport();
            loadData();
            updateCoordinateDisplay();
        });

        // Global functions for onclick handlers
        window.toggleGroup = function(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.expanded = !group.expanded;
                saveData();
                renderGroups();
            }
        };

        // Measurement functions
        window.startMeasurement = function(type) {
            console.log('startMeasurement çağrıldı:', type);
            
            if (!measurementTools) {
                console.error('MeasurementTools henüz başlatılmadı!');
                showNotification('Ölçüm araçları henüz hazır değil, lütfen bekleyin...', 'warning');
                return;
            }
            
            // Aktif çizim araçlarını durdur
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'distance') {
                measurementTools.startDistance();
                document.getElementById('distanceBtn')?.classList.add('active');
            } else if (type === 'area') {
                measurementTools.startArea();
                document.getElementById('areaBtn')?.classList.add('active');
            }
        };

        window.clearMeasurements = function() {
            console.log('clearMeasurements çağrıldı');
            if (measurementTools) {
                measurementTools.clearAll();
                showNotification('Tüm ölçümler temizlendi', 'success');
            }
        };

        window.openMeasurementSettings = function() {
            console.log('openMeasurementSettings çağrıldı');
            const modal = document.getElementById('measurementSettingsModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                showNotification('Ölçüm ayarları modal bulunamadı', 'warning');
            }
        };

        window.deleteGroup = function(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const groupLayers = layers.filter(l => l.groupId === groupId);
            const message = groupLayers.length > 0 
                ? `"${group.name}" grubunu ve içindeki ${groupLayers.length} katmanı silmek istediğinizden emin misiniz?`
                : `"${group.name}" grubunu silmek istediğinizden emin misiniz?`;
            
            if (confirm(message)) {
                groups = groups.filter(g => g.id !== groupId);
                layers = layers.filter(l => l.groupId !== groupId);
                saveData();
                renderGroups();
                showToast(`"${group.name}" grubu silindi`, 'success');
            }
        };

        window.showStyleModal = function(layerId) {
            selectedLayer = layers.find(l => l.id === layerId);
            if (!selectedLayer) return;
            
            currentStyleMode = selectedLayer.styleMode || 'default';
            updateStyleModeButtons();
            loadStyleSettings();
            
            const modal = document.getElementById('styleModal');
            if (modal) {
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
        };

        // Other placeholder functions to prevent errors
        window.toggleLayerVisibility = function(layerId) { console.log('Toggle visibility:', layerId); };
        window.editLayer = function(layerId) { console.log('Edit layer:', layerId); };
        window.deleteLayer = function(layerId) { console.log('Delete layer:', layerId); };
        window.closeToast = function(toastId) { console.log('Close toast:', toastId); };

        // Eksik yardımcı fonksiyonlar
        window.calculateDashArray = function(lineType, lineWidth) {
            switch (lineType) {
                case 'dashed':
                    return `${lineWidth * 4}, ${lineWidth * 2}`;
                case 'dotted':
                    return `${lineWidth}, ${lineWidth}`;
                case 'dashDot':
                    return `${lineWidth * 4}, ${lineWidth}, ${lineWidth}, ${lineWidth}`;
                default:
                    return null;
            }
        };

        window.getDrawButtonIcon = function(title) {
            const iconMap = {
                'Add a marker': '📍',
                'Draw a polyline': '📏',
                'Draw a polygon': '⬟',
                'Draw a rectangle': '⬜',
                'Draw a circle': '⭕'
            };
            return iconMap[title] || '🔧';
        };

        window.setupCoordinateDisplay = function() {
            if (map) {
                map.on('mousemove', function(e) {
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    
                    const coordX = document.getElementById('coordinateX');
                    const coordY = document.getElementById('coordinateY');
                    
                    if (coordX) coordX.textContent = `X: ${lng}`;
                    if (coordY) coordY.textContent = `Y: ${lat}`;
                });
            }
        };

        window.setupScaleDisplay = function() {
            if (map) {
                map.on('zoomend', function() {
                    const zoom = map.getZoom();
                    const scale = Math.round(591657527.591555 / Math.pow(2, zoom));
                    const scaleText = document.getElementById('scaleText');
                    if (scaleText) {
                        scaleText.textContent = `1:${scale.toLocaleString()}`;
                    }
                });
            }
        };

        window.setupProjectionSystem = function() {
            console.log('Projeksiyon sistemi kuruldu');
        };

        window.changeProjection = function() {
            const select = document.getElementById('projectionSelect');
            if (select) {
                showNotification(`Projeksiyon değiştirildi: ${select.value}`, 'info');
            }
        };

        window.setupContextMenu = function() {
            console.log('Context menu kuruldu');
        };

        window.setupKeyboardShortcuts = function() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // ESC tuşu ile işlemleri iptal et
                    if (measurementTools && measurementTools.isActive) {
                        measurementTools.stopMeasurement();
                    }
                    
                    // Aktif çizim araçlarını durdur
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Modalları kapat
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    
                    showNotification('İşlem iptal edildi', 'info');
                }
            });
        };

        window.setupSearchAndFilter = function() {
            console.log('Arama ve filtre sistemi kuruldu');
        };

        // Modal sürükleme sistemi
        window.initModalDragging = function() {
            const modals = document.querySelectorAll('.modal .modal-content');
            modals.forEach(modal => {
                const header = modal.querySelector('.modal-header');
                if (header) {
                    let isDragging = false;
                    let currentX = 0;
                    let currentY = 0;
                    let initialX = 0;
                    let initialY = 0;
                    
                    header.addEventListener('mousedown', dragStart);
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('mouseup', dragEnd);
                    
                    function dragStart(e) {
                        initialX = e.clientX - currentX;
                        initialY = e.clientY - currentY;
                        
                        if (e.target === header || header.contains(e.target)) {
                            isDragging = true;
                            header.style.cursor = 'grabbing';
                        }
                    }
                    
                    function drag(e) {
                        if (isDragging) {
                            e.preventDefault();
                            currentX = e.clientX - initialX;
                            currentY = e.clientY - initialY;
                            
                            modal.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                        }
                    }
                    
                    function dragEnd() {
                        isDragging = false;
                        header.style.cursor = 'move';
                    }
                }
            });
        };

        // Nokta stil tipi değiştirme
        window.initPointStyleTypeToggle = function() {
            const pointStyleType = document.getElementById('pointStyleType');
            if (pointStyleType) {
                pointStyleType.addEventListener('change', function() {
                    const customOptions = document.getElementById('customPointOptions');
                    const iconOptions = document.getElementById('iconPointOptions');
                    
                    if (this.value === 'custom') {
                        if (customOptions) customOptions.style.display = 'block';
                        if (iconOptions) iconOptions.style.display = 'none';
                    } else {
                        if (customOptions) customOptions.style.display = 'none';
                        if (iconOptions) iconOptions.style.display = 'block';
                    }
                });
            }
        };

        // Eksik grup fonksiyonları
        window.updateAllGroupCounts = function() {
            try {
                document.querySelectorAll('.layer-group').forEach(group => {
                    const groupItems = group.querySelector('.group-items');
                    const count = groupItems.querySelectorAll('.layer-item').length;
                    const countElement = group.querySelector('.group-count');
                    if (countElement) {
                        countElement.textContent = count;
                    }
                });
            } catch (error) {
                console.error('updateAllGroupCounts error:', error);
            }
        };

        window.updateAllGroupVisibilityButtons = function() {
            try {
                document.querySelectorAll('.layer-group').forEach(group => {
                    const layerCheckboxes = group.querySelectorAll('.layer-visibility');
                    const visibilityCheckbox = group.querySelector('.group-visibility-checkbox');
                    
                    if (visibilityCheckbox && layerCheckboxes.length > 0) {
                        const anyVisible = Array.from(layerCheckboxes).some(cb => cb.checked);
                        visibilityCheckbox.checked = anyVisible;
                    }
                });
            } catch (error) {
                console.error('updateAllGroupVisibilityButtons error:', error);
            }
        };

        window.updateAllLayerStyleModeIndicators = function() {
            try {
                const savedModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
                document.querySelectorAll('[data-layer-id].layer-style-mode-indicator').forEach(indicator => {
                    const layerId = indicator.getAttribute('data-layer-id');
                    const mode = savedModes[layerId] || 'default';
                    
                    indicator.classList.remove('default-mode', 'custom-mode');
                    
                    if (mode === 'custom') {
                        indicator.classList.add('custom-mode');
                        indicator.innerHTML = '👤';
                        indicator.title = 'Kullanıcı Özel Ayarları';
                    } else {
                        indicator.classList.add('default-mode');
                        indicator.innerHTML = '🏢';
                        indicator.title = 'Varsayılan Kurumsal Ayarlar';
                    }
                });
            } catch (error) {
                console.error('updateAllLayerStyleModeIndicators error:', error);
            }
        };

        // Katman seçim fonksiyonları
        window.clearLayerSelection = function() {
            try {
                if (isDrawingMode) {
                    console.log('Çizim modu aktif, katman seçimi korunuyor');
                    return;
                }
                
                document.querySelectorAll('.layer-item').forEach(item => {
                    item.classList.remove('selected-highlight', 'selected');
                });
                
                activeLayerId = null;
                window.activeLayerId = null;
                
                if (typeof updateSelectedInfo === 'function') {
                    updateSelectedInfo();
                }
            } catch (error) {
                console.error('clearLayerSelection error:', error);
            }
        };

        window.clearGroupSelection = function() {
            try {
                if (isDrawingMode) {
                    console.log('Çizim modu aktif, grup seçimi korunuyor');
                    return;
                }
                
                document.querySelectorAll('.group-header').forEach(h => {
                    h.classList.remove('selected');
                });
                
                activeGroupId = null;
                window.activeGroupId = null;
                
                if (typeof updateSelectedInfo === 'function') {
                    updateSelectedInfo();
                }
            } catch (error) {
                console.error('clearGroupSelection error:', error);
            }
        };

        // Initialize basic functions
        function initializeMap() { 
            console.log('Map initialized');
            if (typeof map !== 'undefined' && map) {
                setupCoordinateDisplay();
                setupScaleDisplay();
            }
        }
        
        function initializeEventListeners() { 
            console.log('Event listeners initialized');
            setupKeyboardShortcuts();
            setupContextMenu();
            setupSearchAndFilter();
            initModalDragging();
            initPointStyleTypeToggle();
        }
        
        function initializeMobileSupport() { 
            console.log('Mobile support initialized');
            // Mobil cihazlar için dokunma olayları
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }
        }
        
        function loadData() { 
            console.log('Data loaded'); 
            renderGroups(); 
        }
        
        function updateCoordinateDisplay() { 
            console.log('Coordinates updated');
            setupCoordinateDisplay();
        }
        
        function saveData() { 
            console.log('Data saved');
            if (typeof DataPersistence !== 'undefined') {
                DataPersistence.autoSave();
            }
        }
        
        function renderGroups() { 
            console.log('Groups rendered');
            updateAllGroupCounts();
            updateAllGroupVisibilityButtons();
            updateAllLayerStyleModeIndicators();
        }
        
        function updateStyleModeButtons() { 
            console.log('Style buttons updated');
            updateAllLayerStyleModeIndicators();
        }
        
        function loadStyleSettings() { 
            console.log('Style settings loaded');
        }
        
        function showToast(message, type) { 
            console.log('Toast:', message, type);
            if (typeof MessageConsole !== 'undefined') {
                MessageConsole.addMessage(message, type);
            }
        }
    </script>
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Harita altlığı">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">OpenStreetMap</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="osm-layer" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Özellikler" onclick="showLayerProperties(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 8V12M12 16H12.01" stroke="white" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="satellite-layer">
                            <input type="checkbox" class="layer-visibility">
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Uydu görüntüsü">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Uydu Görüntüsü</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="satellite-layer" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Özellikler" onclick="showLayerProperties(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 8V12M12 16H12.01" stroke="white" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vektör Veri Grubu -->
                <div class="layer-group" data-group-id="group-2">
                    <div class="group-header">
                        <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                            <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                        </div>
                        <div class="group-select-area" onclick="selectGroup(this)">
                            <span class="group-name">Vektör Veriler</span>
                            <span class="group-count">3</span>
                        </div>
                        <div class="group-toggle-area" onclick="toggleGroup(this)">
                            <span class="group-icon">▼</span>
                        </div>
                    </div>
                    <div class="group-items">
                        <div class="layer-item" draggable="true" data-layer-id="province-boundaries">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Poligon verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">İl Sınırları</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="province-boundaries" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21L16.65 16.65"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('polygon')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="8"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21L16.65 16.65"/>
                                        <path d="M11 8V14M8 11H14"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 6L18 18M6 18L18 6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="road-network">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-line" title="Çizgi verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M2 8L8 8L12 16L16 16L22 8"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda poligon veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Yol Ağı</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="road-network" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('line')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="city-centers">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon active icon-point" title="Nokta verisi aktif">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda poligon veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Şehir Merkezleri</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="city-centers" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('point')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nesne Tabanlı Veriler -->
                <div class="layer-group" data-group-id="group-3">
                    <div class="group-header">
                        <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                            <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                        </div>
                        <div class="group-select-area" onclick="selectGroup(this)">
                            <span class="group-name">Nesne Verileri</span>
                            <span class="group-count">2</span>
                        </div>
                        <div class="group-toggle-area" onclick="toggleGroup(this)">
                            <span class="group-icon">▼</span>
                        </div>
                    </div>
                    <div class="group-items">
                        <div class="layer-item" draggable="true" data-layer-id="buildings">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon active icon-point" title="Bina noktaları">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Bina poligonları">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="18" height="18"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Binalar</span>
                                <span class="layer-style-mode-indicator default-mode" data-layer-id="buildings" title="Stil Modu: Sistem Varsayılanları">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="layer-item" draggable="true" data-layer-id="land-use">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Arazi kullanımı">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Arazi Kullanımı</span>
                                <span class="layer-style-mode-indicator custom-mode" data-layer-id="land-use" title="Stil Modu: Özelleştirilmiş">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Çim Alanları Katmanı -->
                        <div class="layer-item" draggable="true" data-layer-id="grass-layer">
                            <input type="checkbox" class="layer-visibility" checked>
                            <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Bu katmanda nokta veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="6"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Bu katmanda çizgi veri yok">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 12L20 12"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon active icon-polygon" title="Çim alanları" style="color: #77cc33;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">Çim Alanları</span>
                                <span class="layer-style-mode-indicator custom-mode" data-layer-id="grass-layer" title="Stil Modu: Özelleştirilmiş">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="layer-actions">
                                <button class="layer-action-btn" title="Sorgu" onclick="openQueryModal(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Harita Alanı -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Status Bar - Koordinat ve Ölçek -->
            <div class="status-bar">
                <div class="status-left">
                    <div class="coordinate-display">
                        <span class="status-label">Koordinat:</span>
                        <div class="coordinate-item" id="coordinateX">X: -</div>
                        <div class="coordinate-item" id="coordinateY">Y: -</div>
                    </div>
                    <div class="scale-display">
                        <span class="status-label">Ölçek:</span>
                        <div class="scale-bar" id="scaleBar"></div>
                        <span class="scale-text" id="scaleText" onclick="toggleScaleSelector(event)" ondblclick="switchToDynamicScale()" title="Tek tık: ölçek seç, Çift tık: dinamik moda geç">1:1,000,000</span>
                        <div class="scale-selector" id="scaleSelector">
                            <div class="scale-option" onclick="setFixedScale(1000)">1:1,000</div>
                            <div class="scale-option" onclick="setFixedScale(2500)">1:2,500</div>
                            <div class="scale-option" onclick="setFixedScale(5000)">1:5,000</div>
                            <div class="scale-option" onclick="setFixedScale(10000)">1:10,000</div>
                            <div class="scale-option" onclick="setFixedScale(25000)">1:25,000</div>
                            <div class="scale-option" onclick="setFixedScale(50000)">1:50,000</div>
                            <div class="scale-option" onclick="setFixedScale(100000)">1:100,000</div>
                            <div class="scale-option" onclick="setFixedScale(250000)">1:250,000</div>
                            <div class="scale-option" onclick="setFixedScale(500000)">1:500,000</div>
                            <div class="scale-option" onclick="setFixedScale(1000000)">1:1,000,000</div>
                            <div class="scale-option" onclick="setDynamicScale()" style="border-top: 1px solid #dee2e6; margin-top: 4px; padding-top: 8px;">
                                <strong>Dinamik Ölçek</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-right">
                    <div class="active-layer-display" id="activeLayerDisplay" style="margin-right: 15px;">
                        <span class="status-label">Aktif Katman:</span>
                        <span id="activeLayerInfo" style="font-weight: 500; color: var(--primary-color);">-</span>
                    </div>
                    <div class="projection-selector">
                        <span class="status-label">Projeksiyon:</span>
                        <select class="projection-select" id="projectionSelect" onchange="changeProjection()">
                            <option value="EPSG:4326">WGS84 (EPSG:4326)</option>
                            <option value="EPSG:3857">Web Mercator (EPSG:3857)</option>
                            <option value="EPSG:5254">ITRF96 / UTM 35N (EPSG:5254)</option>
                            <option value="EPSG:2320">ED50 / TM30 (EPSG:2320)</option>
                            <option value="EPSG:32635">WGS84 / UTM 35N (EPSG:32635)</option>
                            <option value="EPSG:32636">WGS84 / UTM 36N (EPSG:32636)</option>
                        </select>
                    </div>
                </div>
            </div>



            <!-- Context Menu -->
            <div class="context-menu" id="contextMenu">
                <div class="menu-item" onclick="contextMenuAction('zoom')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                    </svg>
                    Zoom
                </div>
                <div class="menu-item" onclick="contextMenuAction('style')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    Stil
                </div>
                <div class="menu-item" onclick="contextMenuAction('properties')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Özellikler
                </div>
                <div class="menu-item" onclick="contextMenuAction('delete')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                    </svg>
                    Sil
                </div>
            </div>
            
            <!-- Lejant Toggle Butonu - Artık çizim araçları ile birlikte -->

            <!-- Lejant Container -->
            <div class="legend-container" id="legendContainer">
                <div class="legend-header" id="legendHeader">
                    <div class="legend-title">Katman Lejantı</div>
                    <div class="legend-controls">
                        <button class="legend-btn" onclick="toggleLegendSettings()" title="Ayarlar" id="legendSettingsBtn">⚙</button>
                        <button class="legend-btn" onclick="toggleLegendContent()" title="Daralt/Genişlet" id="legendCollapseBtn">−</button>
                        <button class="legend-btn" onclick="closeLegend()" title="Kapat">×</button>
                    </div>
                </div>
                <div class="legend-settings" id="legendSettings" style="display: none;">
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showEmptyLayers" onchange="updateLegendContent()">
                        <label for="showEmptyLayers">Boş katmanları göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showTypeLabels" onchange="updateLegendContent()">
                        <label for="showTypeLabels">Çizim tiplerini göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showOnlyVisible" checked onchange="updateLegendContent()">
                        <label for="showOnlyVisible">Sadece görünür katmanları göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <input type="checkbox" id="showSelectedOnly" onchange="updateLegendContent()">
                        <label for="showSelectedOnly">Sadece seçili katmanı göster</label>
                    </div>
                    <div class="legend-setting-item">
                        <label for="legendSymbolSize">Sembol boyutu:</label>
                        <input type="range" id="legendSymbolSize" min="0.5" max="2" step="0.1" value="1" onchange="updateLegendContent(); updateLegendSymbolSizeDisplay()">
                        <span class="value-display" id="legendSymbolSizeDisplay">1x</span>
                    </div>
                </div>
                <div class="legend-content" id="legendContent">
                    <div id="legendItems">
                        <!-- Lejant öğeleri buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Ölçüm Ayarları Modalı -->
            <div class="modal" id="measurementSettingsModal">
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>
                            <span style="font-size: 18px; margin-right: 8px;">📏</span>
                            Ölçüm Ayarları
                        </h3>
                        <button class="close-btn" onclick="closeMeasurementSettings()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Etiket Pozisyonu Ayarları -->
                        <div class="style-section">
                            <h4>📍 Etiket Pozisyonu</h4>
                            <div class="control-row">
                                <label>Mesafe Etiketleri:</label>
                                <select id="distanceLabelPosition" onchange="updateMeasurementSettings()">
                                    <option value="center">Çizginin Ortası</option>
                                    <option value="above">Çizginin Üstü</option>
                                    <option value="below">Çizginin Altı</option>
                                    <option value="segments">Her Segment Üzerinde</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Alan Etiketleri:</label>
                                <select id="areaLabelPosition" onchange="updateMeasurementSettings()">
                                    <option value="center">Poligonun Ortası</option>
                                    <option value="centroid">Ağırlık Merkezi</option>
                                    <option value="bounds">Sınır Ortası</option>
                                </select>
                            </div>
                        </div>

                        <!-- Etiket Sıklığı Ayarları -->
                        <div class="style-section">
                            <h4>📊 Etiket Sıklığı</h4>
                            <div class="control-row">
                                <label>Segment Etiket Sıklığı:</label>
                                <input type="range" id="segmentLabelFrequency" min="1" max="10" value="3" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="segmentFrequencyValue">3</span>
                            </div>
                            <div class="control-row">
                                <label>Minimum Segment Uzunluğu (m):</label>
                                <input type="range" id="minSegmentLength" min="10" max="1000" value="100" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="minSegmentValue">100</span>
                            </div>
                        </div>

                        <!-- Görünüm Ayarları -->
                        <div class="style-section">
                            <h4>🎨 Görünüm</h4>
                            <div class="control-row">
                                <label>Etiket Boyutu:</label>
                                <input type="range" id="labelSize" min="8" max="18" value="12" onchange="updateMeasurementSettings()">
                                <span class="value-display" id="labelSizeValue">12px</span>
                            </div>
                            <div class="control-row">
                                <label>Etiket Arka Plan:</label>
                                <input type="checkbox" id="labelBackground" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Arka plan göster</span>
                            </div>
                            <div class="control-row">
                                <label>Etiket Rengi:</label>
                                <input type="color" id="labelColor" value="#ffffff" onchange="updateMeasurementSettings()">
                            </div>
                            <div class="control-row">
                                <label>Arka Plan Rengi:</label>
                                <input type="color" id="labelBackgroundColor" value="#000000" onchange="updateMeasurementSettings()">
                            </div>
                        </div>

                        <!-- Birim Ayarları -->
                        <div class="style-section">
                            <h4>📐 Birimler</h4>
                            <div class="control-row">
                                <label>Mesafe Birimi:</label>
                                <select id="distanceUnit" onchange="updateMeasurementSettings()">
                                    <option value="auto">Otomatik (m/km)</option>
                                    <option value="m">Metre (m)</option>
                                    <option value="km">Kilometre (km)</option>
                                    <option value="ft">Feet (ft)</option>
                                    <option value="mi">Mil (mi)</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Alan Birimi:</label>
                                <select id="areaUnit" onchange="updateMeasurementSettings()">
                                    <option value="auto">Otomatik (m²/ha)</option>
                                    <option value="m2">Metrekare (m²)</option>
                                    <option value="ha">Hektar (ha)</option>
                                    <option value="km2">Kilometrekare (km²)</option>
                                    <option value="ac">Acre (ac)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Özel Ayarlar -->
                        <div class="style-section">
                            <h4>⚡ Özel Ayarlar</h4>
                            <div class="control-row">
                                <label>Anlık Güncelleme:</label>
                                <input type="checkbox" id="liveUpdate" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Çizim sırasında etiketleri güncelle</span>
                            </div>
                            <div class="control-row">
                                <label>Toplam Mesafe:</label>
                                <input type="checkbox" id="showTotal" checked onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Toplam mesafeyi göster</span>
                            </div>
                            <div class="control-row">
                                <label>Kısmi Mesafeler:</label>
                                <input type="checkbox" id="showPartial" onchange="updateMeasurementSettings()">
                                <span style="margin-left: 10px;">Her segment mesafesini göster</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="resetMeasurementSettings()">Varsayılan</button>
                        <button class="btn btn-primary" onclick="closeMeasurementSettings()">Tamam</button>
                    </div>
                </div>
            </div>

            <!-- Mesaj Konsolu -->
            <div class="message-console" id="messageConsole">
                <div class="console-header">
                    <div class="console-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                            <path d="M19,3H5C3.9,3 3,3.9 3,5V9H5V5H19V19H5V15H3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.9 20.1,3 19,3Z"/>
                            <path d="M10.08,15.58L11.5,17L16.5,12L11.5,7L10.08,8.41L12.67,11H3V13H12.67L10.08,15.58Z"/>
                        </svg>
                        Mesaj Konsolu
                        <span class="message-counter" id="messageCounter">0</span>
                    </div>
                                         <div class="console-controls">
                         <button class="console-btn" onclick="toggleConsoleDock()" title="Alt bara kilitle/Serbest bırak" id="dockBtn">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M16,20H20V16H16M16,14H20V10H16M4,8V4H8V8M10,20H14V16H10M16,8V4H20V8M4,20H8V16H4M4,14H8V10H4M10,8V4H14V8M10,14H14V10H10V14Z"/>
                             </svg>
                         </button>
                         <button class="console-btn" onclick="clearMessageConsole()" title="Temizle">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                 <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                             </svg>
                         </button>
                         <button class="console-btn" onclick="toggleConsoleMinimize()" title="Daralt/Genişlet" id="consoleMinimizeBtn">−</button>
                         <button class="console-btn" onclick="toggleMessageConsole()" title="Kapat">×</button>
                     </div>
                </div>
                <div class="console-filters">
                    <label class="filter-label">
                        <input type="checkbox" id="showInfoMessages" checked onchange="filterMessages()">
                        <span class="filter-badge info">Info</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showSuccessMessages" checked onchange="filterMessages()">
                        <span class="filter-badge success">Success</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showWarningMessages" checked onchange="filterMessages()">
                        <span class="filter-badge warning">Warning</span>
                    </label>
                    <label class="filter-label">
                        <input type="checkbox" id="showErrorMessages" checked onchange="filterMessages()">
                        <span class="filter-badge error">Error</span>
                    </label>
                </div>
                <div class="console-content" id="consoleContent">
                    <div class="console-messages" id="consoleMessages">
                        <!-- Mesajlar buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Birleşik Araç Kontrolleri -->
            <div class="map-tools-container">
                <!-- Ölçüm Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Ölçüm</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="startMeasurement('distance')" title="Mesafe Ölç" id="distanceBtn">
                            <span style="font-size: 16px; color: #2ecc71;">📏</span>
                        </button>
                        <button class="tool-btn" onclick="startMeasurement('area')" title="Alan Ölç" id="areaBtn">
                            <span style="font-size: 16px; color: #3498db;">⬟</span>
                        </button>
                        <button class="tool-btn" onclick="clearMeasurements()" title="Ölçümleri Temizle">
                            <span style="font-size: 16px; color: #e74c3c;">🗑️</span>
                        </button>
                        <button class="tool-btn" onclick="openMeasurementSettings()" title="Ölçüm Ayarları">
                            <span style="font-size: 16px; color: #9b59b6;">⚙️</span>
                        </button>
                    </div>
                </div>
                
                <!-- Çizim Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Çizim</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="startDrawing('marker')" title="Nokta Çiz" id="pointBtn">
                            <span style="font-size: 16px; color: #e74c3c;">📍</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('polyline')" title="Çizgi Çiz" id="lineBtn">
                            <span style="font-size: 16px; color: #f39c12;">📏</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('polygon')" title="Poligon Çiz" id="polygonBtn">
                            <span style="font-size: 16px; color: #3498db;">⬟</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('rectangle')" title="Dikdörtgen Çiz" id="rectangleBtn">
                            <span style="font-size: 16px; color: #9b59b6;">⬜</span>
                        </button>
                        <button class="tool-btn" onclick="startDrawing('circle')" title="Daire Çiz" id="circleBtn">
                            <span style="font-size: 16px; color: #e67e22;">⭕</span>
                        </button>
                    </div>
                </div>
                
                <!-- Düzenleme Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Düzenleme</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="toggleEditMode()" title="Düzenle" id="editBtn">
                            <span style="font-size: 16px; color: #9b59b6;">✏️</span>
                        </button>
                        <button class="tool-btn" onclick="toggleDeleteMode()" title="Sil" id="deleteBtn">
                            <span style="font-size: 16px; color: #e74c3c;">🗑️</span>
                        </button>
                    </div>
                </div>
                
                <!-- Görünüm Araçları -->
                <div class="tool-group">
                    <div class="tool-group-title">Görünüm</div>
                    <div class="tool-buttons">
                        <button class="tool-btn" onclick="toggleLegend()" title="Lejant Aç/Kapat" id="legendBtn">
                            <span style="font-size: 16px; color: #7f8c8d;">📋</span>
                        </button>
                        <button class="tool-btn" onclick="zoomToExtent()" title="Tümüne Zoom" id="zoomExtentBtn">
                            <span style="font-size: 16px; color: #2ecc71;">🔍</span>
                        </button>
                        <button class="tool-btn" onclick="toggleFullscreen()" title="Tam Ekran" id="fullscreenBtn">
                            <span style="font-size: 16px; color: #34495e;">⛶</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <!-- Grup/Katman Oluşturma Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3 id="createModalTitle">Yeni Oluştur</h3>
                <button class="close-btn" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="style-section">
                    <h4 id="createModalSubtitle">Ad</h4>
                    <div class="control-row">
                        <input type="text" id="createNameInput" placeholder="Ad giriniz..." style="width: 100%; padding: 10px; border: 2px solid #2196f3; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div class="control-row" id="groupSelectRow" style="display: none; margin-top: 10px;">
                        <label>Hedef Grup:</label>
                        <select id="targetGroupSelect" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">İptal</button>
                <button class="btn btn-primary" id="createModalConfirm" onclick="confirmCreate()">Oluştur</button>
            </div>
        </div>
    </div>

    <!-- Stil Ayarları Modal -->
    <div class="modal" id="styleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Stil Ayarları</h3>
                <button class="close-btn" onclick="closeStyleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Ayar Modu Seçici -->
                <div class="style-section" style="border-bottom: 2px solid #dee2e6; margin-bottom: 15px; padding-bottom: 10px;">
                    <div class="control-row">
                        <label style="font-weight: 600; color: #495057;">Ayar Modu:</label>
                        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
                        <select id="styleMode" style="flex: 1; padding: 5px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="default">Varsayılan Değerler</option>
                            <option value="custom">Kullanıcı Özel Ayarları</option>
                        </select>
                            <button id="styleModeToggle" 
                                    class="style-mode-toggle" 
                                    onclick="toggleStyleMode()" 
                                    title="Stil Modunu Değiştir">
                                <span id="styleModeIcon">🏢</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="style-tabs">
                    <button class="style-tab active" onclick="switchTab('style')">Stil</button>
                    <button class="style-tab" onclick="switchTab('label')">Etiket</button>
                    <button class="style-tab" onclick="switchTab('theme')">Tema</button>
                </div>

                <div id="styleContent">
                    <!-- Nokta Stili -->
                    <div class="style-section" id="pointStyle">
                        <h4>Nokta Görünümü</h4>
                        <div class="control-row">
                            <label>Stil Tipi:</label>
                            <select id="pointStyleType">
                                <option value="custom">Özel Tasarım</option>
                                <option value="icon">Hazır İkon</option>
                            </select>
                        </div>
                        
                        <!-- Özel Tasarım Seçenekleri -->
                        <div id="customPointOptions">
                            <div class="control-row">
                                <label>Renk:</label>
                                <input type="color" id="pointColor" value="#ff0000">
                            </div>
                            <div class="control-row">
                                <label>Boyut:</label>
                                <input type="range" id="pointSize" min="4" max="20" value="8">
                                <span class="value-display">8px</span>
                            </div>
                            <div class="control-row">
                                <label>Şekil:</label>
                                <select id="pointShape">
                                    <option value="circle">Daire</option>
                                    <option value="square">Kare</option>
                                    <option value="triangle">Üçgen</option>
                                    <option value="star">Yıldız</option>
                                    <option value="diamond">Elmas</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>Saydamlık:</label>
                                <input type="range" id="pointOpacity" min="0" max="100" value="100">
                                <span class="value-display">100%</span>
                            </div>
                        </div>
                        
                        <!-- Hazır İkon Seçenekleri -->
                        <div id="iconPointOptions" style="display: none;">
                            <div class="control-row">
                                <label>İkon Kategorisi:</label>
                                <select id="iconCategory">
                                    <option value="location">Konum</option>
                                    <option value="transport">Ulaşım</option>
                                    <option value="service">Hizmet</option>
                                    <option value="nature">Doğa</option>
                                    <option value="building">Yapı</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label>İkon Seçimi:</label>
                                <div class="icon-grid" id="iconGrid">
                                    <!-- İkonlar dinamik olarak buraya eklenecek -->
                                </div>
                            </div>
                            <div class="control-row">
                                <label>İkon Boyutu:</label>
                                <input type="range" id="iconSize" min="16" max="48" value="24">
                                <span class="value-display">24px</span>
                            </div>
                        </div>
                    </div>

                    <!-- Çizgi Stili -->
                    <div class="style-section" id="lineStyle">
                        <h4>Çizgi Görünümü</h4>
                        <div class="control-row">
                            <label>Renk:</label>
                            <input type="color" id="lineColor" value="#ff7800">
                        </div>
                        <div class="control-row">
                            <label>Kalınlık:</label>
                            <input type="range" id="lineWidth" min="1" max="10" value="3">
                            <span class="value-display">3px</span>
                        </div>
                        <div class="control-row">
                            <label>Saydamlık:</label>
                            <input type="range" id="lineOpacity" min="0" max="100" value="100">
                            <span class="value-display">100%</span>
                        </div>
                        <div class="control-row">
                            <label>Çizgi Tipi:</label>
                            <select id="lineType">
                                <option value="solid">Düz</option>
                                <option value="dashed">Kesikli</option>
                                <option value="dotted">Noktalı</option>
                                <option value="dashDot">Kesik-Nokta</option>
                            </select>
                        </div>
                    </div>

                    <!-- Poligon Stili -->
                    <div class="style-section" id="polygonStyle">
                        <h4>Poligon Görünümü</h4>
                        <div class="control-row">
                            <label>Dolgu Rengi:</label>
                            <input type="color" id="fillColor" value="#3388ff">
                        </div>
                        <div class="control-row">
                            <label>Dolgu Saydamlık:</label>
                            <input type="range" id="fillOpacity" min="0" max="100" value="50">
                            <span class="value-display">50%</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Rengi:</label>
                            <input type="color" id="strokeColor" value="#000000">
                        </div>
                        <div class="control-row">
                            <label>Kenar Kalınlığı:</label>
                            <input type="range" id="strokeWidth" min="0" max="5" value="1">
                            <span class="value-display">1px</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Saydamlık:</label>
                            <input type="range" id="strokeOpacity" min="0" max="100" value="100">
                            <span class="value-display">100%</span>
                        </div>
                        <div class="control-row">
                            <label>Kenar Tipi:</label>
                            <select id="strokeType">
                                <option value="solid">Düz</option>
                                <option value="dashed">Kesikli</option>
                                <option value="dotted">Noktalı</option>
                            </select>
                        </div>
                    </div>
                    
                    
                </div>

                <div id="labelContent" style="display: none;">
                    <div class="style-section">
                        <h4>Etiket Ayarları</h4>
                        <div class="control-row">
                            <label>Etiket Göster:</label>
                            <input type="checkbox" id="showLabels" style="margin-left: 10px;">
                        </div>
                        <div class="control-row">
                            <label>Etiket Alanı:</label>
                            <select id="labelField">
                                <option value="">Seçiniz</option>
                                <option value="name">İsim</option>
                                <option value="id">ID</option>
                                <option value="type">Tip</option>
                                <option value="area">Alan (m²)</option>
                                <option value="length">Uzunluk (m)</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Font Boyutu:</label>
                            <input type="range" id="fontSize" min="8" max="24" value="12">
                            <span class="value-display">12px</span>
                        </div>
                        <div class="control-row">
                            <label>Font Rengi:</label>
                            <input type="color" id="fontColor" value="#000000">
                        </div>
                        <div class="control-row">
                            <label>Halo Rengi:</label>
                            <input type="color" id="haloColor" value="#ffffff">
                        </div>
                        <div class="control-row">
                            <label>Halo Kalınlığı:</label>
                            <input type="range" id="haloWidth" min="0" max="5" value="1">
                            <span class="value-display">1px</span>
                        </div>
                        <div class="control-row">
                            <label>Etiket Konumu:</label>
                            <select id="labelPosition">
                                <option value="center">Merkez</option>
                                <option value="top">Üst</option>
                                <option value="bottom">Alt</option>
                                <option value="left">Sol</option>
                                <option value="right">Sağ</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <button class="btn btn-secondary" onclick="generateRandomNames()" style="margin-top: 10px;">
                                🎲 Rastgele İsimler Ata
                            </button>
                        </div>
                    </div>
                </div>

                <div id="themeContent" style="display: none;">
                    <div class="style-section">
                        <h4>Tematik Harita Ayarları</h4>
                        <div class="control-row">
                            <label>Sınıflandırma Alanı:</label>
                            <select id="classField">
                                <option value="">Seçiniz</option>
                                <option value="population">Nüfus</option>
                                <option value="area">Alan</option>
                                <option value="density">Yoğunluk</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Sınıflandırma Metodu:</label>
                            <select id="classMethod">
                                <option value="equal">Eşit Aralık</option>
                                <option value="quantile">Kantil</option>
                                <option value="natural">Doğal Kırılımlar</option>
                                <option value="manual">Manuel</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Sınıf Sayısı:</label>
                            <input type="range" id="classCount" min="3" max="9" value="5">
                            <span class="value-display">5</span>
                        </div>
                        <div class="control-row">
                            <label>Renk Paleti:</label>
                            <select id="colorPalette">
                                <option value="sequential">Ardışık</option>
                                <option value="diverging">Ayrılan</option>
                                <option value="qualitative">Niteliksel</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStyleModal()">İptal</button>
                <button class="btn btn-primary" onclick="saveAndCloseStyle()">Kaydet & Kapat</button>
            </div>
        </div>
    </div>

    <!-- Sorgu Modal -->
    <div class="modal" id="queryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sorgu</h3>
                <button class="close-btn" onclick="closeQueryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="style-tabs">
                    <button class="style-tab active" onclick="switchQueryTab('basic')">Temel</button>
                    <button class="style-tab" onclick="switchQueryTab('advanced')">Gelişmiş</button>
                </div>
                
                <div id="basicQueryContent">
                    <div class="style-section">
                        <h4>Temel Sorgu</h4>
                        <div class="control-row">
                            <label>Alan:</label>
                            <select id="queryField">
                                <option value="">Seçiniz</option>
                                <option value="name">Ad</option>
                                <option value="type">Tip</option>
                                <option value="area">Alan</option>
                                <option value="population">Nüfus</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Operatör:</label>
                            <select id="queryOperator">
                                <option value="equals">Eşittir</option>
                                <option value="notEquals">Eşit Değildir</option>
                                <option value="contains">İçerir</option>
                                <option value="startsWith">İle Başlar</option>
                                <option value="endsWith">İle Biter</option>
                                <option value="greaterThan">Büyüktür</option>
                                <option value="lessThan">Küçüktür</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>Değer:</label>
                            <input type="text" id="queryValue" placeholder="Değer giriniz">
                        </div>
                    </div>
                </div>
                
                <div id="advancedQueryContent" style="display: none;">
                    <div class="style-section">
                        <h4>Gelişmiş Sorgu</h4>
                        <div class="control-row">
                            <label>SQL İfadesi:</label>
                        </div>
                        <div class="control-row">
                            <textarea id="sqlQuery" rows="5" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace;" placeholder="Örnek: alan > 1000 AND tip = 'Konut'"></textarea>
                        </div>
                        <div class="control-row">
                            <small style="color: #6c757d;">Desteklenen operatörler: AND, OR, =, !=, >, <, >=, <=, LIKE</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQueryModal()">İptal</button>
                <button class="btn btn-primary" onclick="applyQuery()">Sorgula</button>
            </div>
        </div>
    </div>

    <!-- Katman Detayları Modal -->
    <div class="layer-details-modal" id="layerDetailsModal">
        <div class="layer-details-content">
            <div class="layer-details-header">
                <h3>Katman Detayları: <span id="layerDetailName"></span></h3>
                <button class="close-btn" onclick="closeLayerDetailsModal()">&times;</button>
            </div>
            <div class="layer-details-body">
                <div id="featuresContainer">
                    <!-- Çizim detayları burada listelenecek -->
                </div>
            </div>
            <div class="layer-details-footer">
                <button class="btn btn-secondary" onclick="closeLayerDetailsModal()">Kapat</button>
                <button class="btn btn-primary" onclick="addFeatureToLayer()">Yeni Çizim Ekle</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // =================================
        // 1. CONSTANTS & CONFIGURATION
        // =================================
        const CONFIG = {
            MAP_CENTER: [41.0082, 28.9784],
            DEFAULT_ZOOM: 10,
            MAX_ZOOM: 19,
            DEBOUNCE_DELAY: 150,
            THROTTLE_DELAY: 100,
            TOAST_DURATION: 3000,
            AUTOSAVE_INTERVAL: 30000
        };

        const SYSTEM_DEFAULTS = {
            point: { color: "#ff0000", size: 8, shape: "circle", opacity: 100 },
            line: { color: "#ff7800", width: 3, opacity: 100, type: "solid" },
            polygon: { fillColor: "#3388ff", fillOpacity: 50, strokeColor: "#000000", strokeWidth: 1 }
        };

        // =================================
        // 3. ICON LIBRARY SYSTEM
        // =================================
        const ICON_LIBRARY = {
            // Geometri tipleri
            point: { unicode: "📍", name: "Nokta", color: "#e74c3c" },
            line: { unicode: "📏", name: "Çizgi", color: "#f39c12" },
            polygon: { unicode: "⬟", name: "Poligon", color: "#3498db" },
            rectangle: { unicode: "⬜", name: "Dikdörtgen", color: "#9b59b6" },
            circle: { unicode: "⭕", name: "Daire", color: "#e67e22" },
            
            // Araçlar - Ölçüm
            measureDistance: { unicode: "📏", name: "Mesafe Ölç", color: "#2ecc71" },
            measureArea: { unicode: "⬟", name: "Alan Ölç", color: "#3498db" },
            clearMeasurements: { unicode: "🗑️", name: "Ölçümleri Temizle", color: "#e74c3c" },
            
            // Araçlar - Düzenleme
            edit: { unicode: "✏️", name: "Düzenle", color: "#9b59b6" },
            delete: { unicode: "🗑️", name: "Sil", color: "#e74c3c" },
            settings: { unicode: "⚙️", name: "Ayarlar", color: "#34495e" },
            
            // Araçlar - Görünüm
            zoom: { unicode: "🔍", name: "Zoom", color: "#2ecc71" },
            zoomExtent: { unicode: "🔍", name: "Tümüne Zoom", color: "#2ecc71" },
            fullscreen: { unicode: "⛶", name: "Tam Ekran", color: "#34495e" },
            legend: { unicode: "📋", name: "Lejant", color: "#7f8c8d" },
            
            // Durum göstergeleri
            visible: { unicode: "👁️", name: "Görünür", color: "#2ecc71" },
            hidden: { unicode: "👁️‍🗨️", name: "Gizli", color: "#95a5a6" },
            locked: { unicode: "🔒", name: "Kilitli", color: "#e67e22" },
            unlocked: { unicode: "🔓", name: "Açık", color: "#2ecc71" },
            
            // Panel ve yönetim
            layers: { unicode: "🗂️", name: "Katmanlar", color: "#7f8c8d" },
            group: { unicode: "📁", name: "Grup", color: "#f39c12" },
            layer: { unicode: "📋", name: "Katman", color: "#3498db" },
            save: { unicode: "💾", name: "Kaydet", color: "#2ecc71" },
            download: { unicode: "📥", name: "İndir", color: "#3498db" },
            upload: { unicode: "📤", name: "Yükle", color: "#e67e22" },
            close: { unicode: "✕", name: "Kapat", color: "#e74c3c" },
            
            // Kategoriler
            mixed: { unicode: "🗂️", name: "Karma", color: "#7f8c8d" }
        };

        // Icon helper functions
        const IconUtils = {
            getIcon(type) {
                return ICON_LIBRARY[type] || ICON_LIBRARY.mixed;
            },

            createIconElement(type, size = '14px', extraClass = '') {
                const iconData = this.getIcon(type);
                const span = document.createElement('span');
                span.textContent = iconData.unicode;
                span.style.fontSize = size;
                span.style.color = iconData.color;
                span.title = iconData.name;
                if (extraClass) span.className = extraClass;
                return span;
            },

            createIconHtml(type, size = '14px') {
                const iconData = this.getIcon(type);
                return `<span style="font-size: ${size}; color: ${iconData.color};" title="${iconData.name}">${iconData.unicode}</span>`;
            }
        };

        // =================================
        // 2. UTILITY FUNCTIONS
        // =================================
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            },

            safeExecute(fn, errorContext = 'Operation') {
                try {
                    return fn();
                } catch (error) {
                    ErrorManager.handle(error, errorContext);
                    return null;
                }
            },

            generateId(prefix = 'item') {
                return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            },

            validateInput: {
                layerName(name) {
                    if (!name || typeof name !== 'string') {
                        throw new Error('Katman adı geçersiz');
                    }
                    const trimmed = name.trim();
                    if (trimmed.length < 1 || trimmed.length > 50) {
                        throw new Error('Katman adı 1-50 karakter arasında olmalı');
                    }
                    return trimmed;
                },
                
                color(color) {
                    const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                    if (!colorRegex.test(color)) {
                        throw new Error('Geçersiz renk formatı');
                    }
                    return color;
                }
            },

            formatCoordinate(value, decimals = 6) {
                return parseFloat(value).toFixed(decimals);
            }
        };

        // =================================
        // 3. ERROR MANAGEMENT
        // =================================
        const ErrorManager = {
            handle(error, context = '') {
                console.error(`[${context}]`, error);
                const userMessage = this.getUserFriendlyMessage(error);
                showToast(userMessage, 'error');
            },

            getUserFriendlyMessage(error) {
                const errorMap = {
                    'Katman adı geçersiz': 'Katman adı geçersiz',
                    'Katman bulunamadı': 'Seçili katman bulunamadı',
                    'Stil yüklenirken hata': 'Stil ayarları yüklenirken hata oluştu',
                    'Çizim hatası': 'Çizim işlemi başarısız'
                };
                
                const message = error.message || error.toString();
                return errorMap[message] || 'Beklenmeyen bir hata oluştu. Lütfen tekrar deneyin.';
            }
        };

        // =================================
        // 4. STATE MANAGEMENT
        // =================================
        const AppState = {
            data: {
                activeLayerId: null,
                activeGroupId: null,
                isDrawingMode: false,
                layerFeatures: {},
                drawnLayers: [],
                measurementMode: null
            },

            get(key) {
                return this.data[key];
            },

            set(key, value) {
                const oldValue = this.data[key];
                this.data[key] = value;
                this.notifyChange(key, value, oldValue);
            },

            update(updates) {
                Object.keys(updates).forEach(key => {
                    this.set(key, updates[key]);
                });
            },

            notifyChange(key, newValue, oldValue) {
                document.dispatchEvent(new CustomEvent('state:changed', {
                    detail: { key, newValue, oldValue }
                }));
            }
        };

        // =================================
        // 5. MEASUREMENT UTILITIES (Enhanced)
        // =================================
        
        // Ölçüm Ayarları Objesi
        const MeasurementSettings = {
            distance: {
                labelPosition: 'center', // center, above, below, segments
                showTotal: true,
                showPartial: false,
                unit: 'auto' // auto, m, km, ft, mi
            },
            area: {
                labelPosition: 'center', // center, centroid, bounds
                unit: 'auto' // auto, m2, ha, km2, ac
            },
            labels: {
                size: 12,
                color: '#ffffff',
                backgroundColor: '#000000',
                showBackground: true,
                frequency: 3, // segment etiket sıklığı
                minSegmentLength: 100 // minimum segment uzunluğu (metre)
            },
            general: {
                liveUpdate: true // çizim sırasında etiketleri güncelle
            }
        };

        class MeasurementTools {
            constructor(map) {
                this.map = map;
                this.measurementLayers = L.layerGroup().addTo(map);
                this.currentTool = null;
                this.isActive = false;
                this.pointMarkers = []; // Ölçüm noktalarını saklamak için
                this.segmentLabels = []; // Segment etiketlerini saklamak için
            }
            
            startDistance() {
                console.log('startDistance method çağrıldı');
                this.stopMeasurement(); // Önceki ölçümü durdur
                this.currentTool = 'distance';
                this.isActive = true;
                this.map.getContainer().style.cursor = 'crosshair';
                
                console.log('Harita event listener\'ları ekleniyor...');
                // Event listener'ları en yüksek öncelikle ekle
                this.map.off('click', this.onMapClick, this); // Önce kaldır
                this.map.off('dblclick', this.onMapDoubleClick, this); // Önce kaldır
                this.map.on('click', this.onMapClick, this);
                this.map.on('dblclick', this.onMapDoubleClick, this);
                
                // Diğer event listener'ları devre dışı bırak
                this.disableMapInteraction();
                
                this.currentPoints = [];
                this.currentLine = null;
                this.pointMarkers = [];
                
                console.log('Mesafe ölçümü aktif, haritaya tıklayabilirsiniz');
                // Kullanıcıya bilgi ver
                showNotification('Mesafe ölçümü başladı - Çift tıklayın veya ESC ile çıkın', 'info');
            }
            
            startArea() {
                console.log('startArea method çağrıldı');
                this.stopMeasurement(); // Önceki ölçümü durdur
                this.currentTool = 'area';
                this.isActive = true;
                this.map.getContainer().style.cursor = 'crosshair';
                
                console.log('Harita event listener\'ları ekleniyor...');
                // Event listener'ları en yüksek öncelikle ekle
                this.map.off('click', this.onMapClick, this); // Önce kaldır
                this.map.off('dblclick', this.onMapDoubleClick, this); // Önce kaldır
                this.map.on('click', this.onMapClick, this);
                this.map.on('dblclick', this.onMapDoubleClick, this);
                
                // Diğer event listener'ları devre dışı bırak
                this.disableMapInteraction();
                
                this.currentPoints = [];
                this.currentPolygon = null;
                this.pointMarkers = [];
                
                console.log('Alan ölçümü aktif, haritaya tıklayabilirsiniz');
                // Kullanıcıya bilgi ver
                showNotification('Alan ölçümü başladı - Çift tıklayın veya ESC ile çıkın', 'info');
            }
            
            onMapClick(e) {
                console.log('MeasurementTools onMapClick çağrıldı:', e.latlng);
                console.log('isActive:', this.isActive);
                console.log('currentTool:', this.currentTool);
                
                // Event'i durdur ki diğer listener'lar çalışmasın
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                    e.originalEvent.preventDefault();
                }
                
                if (!this.isActive) {
                    console.log('Ölçüm aktif değil, çıkılıyor...');
                    return;
                }
                
                this.currentPoints.push(e.latlng);
                console.log('Toplam nokta sayısı:', this.currentPoints.length);
                
                // Tıklanan noktayı işaretle
                this.addPointMarker(e.latlng);
                
                if (this.currentTool === 'distance') {
                    console.log('Mesafe ölçümü güncelleniyor...');
                    this.updateDistanceMeasurement();
                } else if (this.currentTool === 'area') {
                    console.log('Alan ölçümü güncelleniyor...');
                    this.updateAreaMeasurement();
                }
            }
            
            addPointMarker(latlng) {
                const pointMarker = L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: '#ff4444',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1,
                    className: 'measurement-point'
                });
                
                this.pointMarkers.push(pointMarker);
                this.measurementLayers.addLayer(pointMarker);
            }
            
            onMapDoubleClick(e) {
                if (!this.isActive) return;
                
                // Çift tıklama ile ölçümü sonlandır
                this.stopMeasurement();
            }
            
            updateDistanceMeasurement() {
                if (this.currentPoints.length >= 2) {
                    // Önceki çizgiyi ve etiketleri temizle
                    if (this.currentLine) {
                        this.measurementLayers.removeLayer(this.currentLine);
                    }
                    this.clearSegmentLabels();
                    
                    this.currentLine = L.polyline(this.currentPoints, {
                        color: '#ff4444',
                        weight: 3,
                        dashArray: '5, 5',
                        opacity: 0.8
                    });
                    
                    // Toplam mesafeyi hesapla
                    const totalDistance = this.calculateDistance(this.currentPoints);
                    const formattedDistance = this.formatDistance(totalDistance);
                    
                    // Ayarlara göre etiketleri ekle
                    this.addDistanceLabels(this.currentLine, totalDistance, formattedDistance);
                    
                    this.measurementLayers.addLayer(this.currentLine);
                } else if (this.currentPoints.length === 1) {
                    console.log('İlk nokta eklendi, ikinci nokta bekleniyor...');
                }
            }
            
            updateAreaMeasurement() {
                if (this.currentPoints.length >= 3) {
                    // Önceki poligonu temizle
                    if (this.currentPolygon) {
                        this.measurementLayers.removeLayer(this.currentPolygon);
                    }
                    
                    this.currentPolygon = L.polygon(this.currentPoints, {
                        color: '#4444ff',
                        weight: 2,
                        fillColor: '#4444ff',
                        fillOpacity: 0.2,
                        opacity: 0.8
                    });
                    
                    // Alanı hesapla
                    const area = this.calculateArea(this.currentPoints);
                    const formattedArea = this.formatArea(area);
                    
                    // Ayarlara göre etiket ekle
                    this.addAreaLabel(this.currentPolygon, area, formattedArea);
                    
                    this.measurementLayers.addLayer(this.currentPolygon);
                } else if (this.currentPoints.length >= 1) {
                    console.log(`Alan ölçümü için ${this.currentPoints.length} nokta eklendi, en az 3 nokta gerekli`);
                }
            }
            
            calculateDistance(latlngs) {
                let totalDistance = 0;
                for (let i = 0; i < latlngs.length - 1; i++) {
                    totalDistance += latlngs[i].distanceTo(latlngs[i + 1]);
                }
                return totalDistance;
            }
            
            calculateArea(latlngs) {
                // Basit alan hesaplama (yaklaşık)
                if (latlngs.length < 3) return 0;
                
                let area = 0;
                const n = latlngs.length;
                
                for (let i = 0; i < n; i++) {
                    const j = (i + 1) % n;
                    area += latlngs[i].lat * latlngs[j].lng;
                    area -= latlngs[j].lat * latlngs[i].lng;
                }
                
                area = Math.abs(area) / 2;
                // Derece cinsinden alanı metrekareye çevir (yaklaşık)
                return area * 111320 * 111320 * Math.cos(latlngs[0].lat * Math.PI / 180);
            }
            
            disableMapInteraction() {
                // Harita drag ve zoom'u geçici olarak devre dışı bırak
                this.map.dragging.disable();
                this.map.doubleClickZoom.disable();
                this.map.scrollWheelZoom.disable();
                this.map.touchZoom.disable();
                this.map.keyboard.disable();
                console.log('Harita interaksiyonları devre dışı bırakıldı');
            }
            
            enableMapInteraction() {
                // Harita drag ve zoom'u tekrar etkinleştir
                this.map.dragging.enable();
                this.map.doubleClickZoom.enable();
                this.map.scrollWheelZoom.enable();
                this.map.touchZoom.enable();
                this.map.keyboard.enable();
                console.log('Harita interaksiyonları etkinleştirildi');
            }

            stopMeasurement() {
                console.log('Ölçüm aracı durduruluyor...');
                this.isActive = false;
                this.currentTool = null;
                
                // Remove all event listeners
                this.map.off('click', this.onMapClick, this);
                this.map.off('dblclick', this.onMapDoubleClick, this);
                this.map.off('mousemove', this.onMapMouseMove, this);
                this.map.getContainer().style.cursor = '';
                
                // Harita interaksiyonlarını yeniden etkinleştir
                this.enableMapInteraction();
                
                // Clear measurement data
                this.currentPoints = [];
                this.currentLine = null;
                this.currentPolygon = null;
                this.pointMarkers = [];
                this.clearSegmentLabels();
                
                // Buton durumlarını sıfırla
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                console.log('Ölçüm aracı başarıyla durduruldu');
            }
            
            // Segment etiketlerini temizle
            clearSegmentLabels() {
                this.segmentLabels.forEach(label => {
                    if (this.measurementLayers.hasLayer(label)) {
                        this.measurementLayers.removeLayer(label);
                    }
                });
                this.segmentLabels = [];
            }
            
            // Mesafe etiketlerini ekle
            addDistanceLabels(polyline, totalDistance, formattedDistance) {
                const settings = MeasurementSettings;
                
                if (settings.distance.showTotal) {
                    // Toplam mesafe etiketi
                    const labelPosition = this.getDistanceLabelPosition(polyline);
                    const tooltip = this.createCustomTooltip(
                        `Toplam: ${formattedDistance}`,
                        labelPosition,
                        'distance-total'
                    );
                    this.segmentLabels.push(tooltip);
                    this.measurementLayers.addLayer(tooltip);
                }
                
                // Segment etiketleri (eğer ayar açıksa)
                if (settings.distance.labelPosition === 'segments' || settings.distance.showPartial) {
                    this.addSegmentLabels();
                }
            }
            
            // Alan etiketi ekle
            addAreaLabel(polygon, area, formattedArea) {
                const labelPosition = this.getAreaLabelPosition(polygon);
                const tooltip = this.createCustomTooltip(
                    `Alan: ${formattedArea}`,
                    labelPosition,
                    'area-label'
                );
                this.segmentLabels.push(tooltip);
                this.measurementLayers.addLayer(tooltip);
            }
            
            // Mesafe label pozisyonunu belirle
            getDistanceLabelPosition(polyline) {
                const points = polyline.getLatLngs();
                const settings = MeasurementSettings.distance;
                
                switch (settings.labelPosition) {
                    case 'center':
                        return this.getLineCenter(points);
                    case 'above':
                        return this.getLineCenterWithOffset(points, 'above');
                    case 'below':
                        return this.getLineCenterWithOffset(points, 'below');
                    default:
                        return this.getLineCenter(points);
                }
            }
            
            // Alan label pozisyonunu belirle
            getAreaLabelPosition(polygon) {
                const settings = MeasurementSettings.area;
                const bounds = polygon.getBounds();
                
                switch (settings.labelPosition) {
                    case 'center':
                    case 'centroid':
                        return bounds.getCenter();
                    case 'bounds':
                        return bounds.getCenter();
                    default:
                        return bounds.getCenter();
                }
            }
            
            // Segment etiketlerini ekle
            addSegmentLabels() {
                const settings = MeasurementSettings;
                if (this.currentPoints.length < 2) return;
                
                for (let i = 0; i < this.currentPoints.length - 1; i++) {
                    const start = this.currentPoints[i];
                    const end = this.currentPoints[i + 1];
                    const segmentDistance = start.distanceTo(end);
                    
                    // Minimum segment uzunluğu kontrolü
                    if (segmentDistance < settings.labels.minSegmentLength) continue;
                    
                    // Sıklık kontrolü
                    if ((i + 1) % settings.labels.frequency !== 0) continue;
                    
                    const segmentCenter = L.latLng(
                        (start.lat + end.lat) / 2,
                        (start.lng + end.lng) / 2
                    );
                    
                    const formattedSegmentDistance = this.formatDistance(segmentDistance);
                    const tooltip = this.createCustomTooltip(
                        formattedSegmentDistance,
                        segmentCenter,
                        'distance-segment'
                    );
                    
                    this.segmentLabels.push(tooltip);
                    this.measurementLayers.addLayer(tooltip);
                }
            }
            
            // Özel tooltip oluştur
            createCustomTooltip(text, position, className) {
                const settings = MeasurementSettings.labels;
                const style = `
                    background: ${settings.showBackground ? settings.backgroundColor : 'transparent'} !important;
                    color: ${settings.color} !important;
                    border: none !important;
                    border-radius: 4px !important;
                    padding: 4px 8px !important;
                    font-weight: bold !important;
                    font-size: ${settings.size}px !important;
                    box-shadow: ${settings.showBackground ? '0 2px 4px rgba(0,0,0,0.3)' : 'none'} !important;
                    white-space: nowrap !important;
                    pointer-events: none !important;
                `;
                
                return L.marker(position, {
                    icon: L.divIcon({
                        html: `<div style="${style}">${text}</div>`,
                        className: `measurement-tooltip ${className}`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                });
            }
            
            // Çizgi merkezi hesapla
            getLineCenter(points) {
                if (points.length === 0) return null;
                if (points.length === 1) return points[0];
                
                let totalDistance = 0;
                const distances = [];
                
                for (let i = 0; i < points.length - 1; i++) {
                    const dist = points[i].distanceTo(points[i + 1]);
                    distances.push(dist);
                    totalDistance += dist;
                }
                
                const halfDistance = totalDistance / 2;
                let currentDistance = 0;
                
                for (let i = 0; i < distances.length; i++) {
                    if (currentDistance + distances[i] >= halfDistance) {
                        const ratio = (halfDistance - currentDistance) / distances[i];
                        return L.latLng(
                            points[i].lat + (points[i + 1].lat - points[i].lat) * ratio,
                            points[i].lng + (points[i + 1].lng - points[i].lng) * ratio
                        );
                    }
                    currentDistance += distances[i];
                }
                
                return points[Math.floor(points.length / 2)];
            }
            
            // Offset ile çizgi merkezi
            getLineCenterWithOffset(points, direction) {
                const center = this.getLineCenter(points);
                if (!center) return center;
                
                const offsetLat = direction === 'above' ? 0.0001 : -0.0001;
                return L.latLng(center.lat + offsetLat, center.lng);
            }
            
            // Mesafe formatla
            formatDistance(distance) {
                const unit = MeasurementSettings.distance.unit;
                
                switch (unit) {
                    case 'm':
                        return `${distance.toFixed(0)} m`;
                    case 'km':
                        return `${(distance / 1000).toFixed(2)} km`;
                    case 'ft':
                        return `${(distance * 3.28084).toFixed(0)} ft`;
                    case 'mi':
                        return `${(distance / 1609.34).toFixed(2)} mi`;
                    case 'auto':
                    default:
                        return distance > 1000 ? 
                            `${(distance / 1000).toFixed(2)} km` : 
                            `${distance.toFixed(0)} m`;
                }
            }
            
            // Alan formatla
            formatArea(area) {
                const unit = MeasurementSettings.area.unit;
                
                switch (unit) {
                    case 'm2':
                        return `${area.toFixed(0)} m²`;
                    case 'ha':
                        return `${(area / 10000).toFixed(2)} ha`;
                    case 'km2':
                        return `${(area / 1000000).toFixed(4)} km²`;
                    case 'ac':
                        return `${(area / 4047).toFixed(2)} ac`;
                    case 'auto':
                    default:
                        return area > 10000 ? 
                            `${(area / 10000).toFixed(2)} ha` : 
                            `${area.toFixed(0)} m²`;
                }
            }

            clearAll() {
                this.measurementLayers.clearLayers();
                this.stopMeasurement();
            }
        }
        
        // ===== MESAJ KONSOLU SİSTEMİ =====
        const MessageConsole = {
            messages: [],
            maxMessages: 100,
            isVisible: false,
            isDocked: false,
            dragData: { isDragging: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 },
            
            init() {
                // Konsol varsayılan açık gelsin
                const console = document.getElementById('messageConsole');
                const toggleBtn = document.getElementById('consoleToggleBtn');
                
                this.isVisible = true;
                if (console) {
                    console.classList.add('show');
                }
                
                // Drag & drop sistemi kurulumu
                this.setupDragAndDrop();
                
                // İlk mesajları ekle
                this.addMessage('Mesaj konsolu hazır! 🎉', 'info');
                this.addMessage('Sistem mesajları burada görüntülenir', 'info');
                this.addMessage('Konsol taşınabilir - sürükleyerek konumlandırabilirsiniz', 'info');
            },
            
            addMessage(message, type = 'info') {
                const timestamp = new Date();
                const messageObj = {
                    id: Date.now() + Math.random(),
                    message,
                    type,
                    timestamp,
                    time: timestamp.toLocaleTimeString('tr-TR', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    })
                };
                
                this.messages.unshift(messageObj);
                
                // Maksimum mesaj sayısını aş
                if (this.messages.length > this.maxMessages) {
                    this.messages = this.messages.slice(0, this.maxMessages);
                }
                
                this.updateConsole();
                this.updateToggleButton();
                
                // Console.log için de çıktı ver
                console.log(`[${type.toUpperCase()}] ${message}`);
            },
            
            updateConsole() {
                const messagesContainer = document.getElementById('consoleMessages');
                const messageCounter = document.getElementById('messageCounter');
                
                if (!messagesContainer) return;
                
                // Mesaj sayısını güncelle
                if (messageCounter) {
                    messageCounter.textContent = this.messages.length;
                }
                
                // Mesajları render et
                messagesContainer.innerHTML = this.messages
                    .map(msg => this.renderMessage(msg))
                    .join('');
                
                // Filtre uygula
                this.applyFilters();
                
                // En son mesaja scroll
                if (messagesContainer.scrollTop === 0) {
                    messagesContainer.scrollTop = 0;
                }
            },
            
            renderMessage(messageObj) {
                return `
                    <div class="console-message" data-type="${messageObj.type}" data-id="${messageObj.id}">
                        <span class="message-time">${messageObj.time}</span>
                        <div class="message-type ${messageObj.type}"></div>
                        <span class="message-text">${this.escapeHtml(messageObj.message)}</span>
                    </div>
                `;
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            applyFilters() {
                const showInfo = document.getElementById('showInfoMessages')?.checked ?? true;
                const showSuccess = document.getElementById('showSuccessMessages')?.checked ?? true;
                const showWarning = document.getElementById('showWarningMessages')?.checked ?? true;
                const showError = document.getElementById('showErrorMessages')?.checked ?? true;
                
                const messages = document.querySelectorAll('.console-message');
                messages.forEach(msg => {
                    const type = msg.getAttribute('data-type');
                    const shouldShow = (
                        (type === 'info' && showInfo) ||
                        (type === 'success' && showSuccess) ||
                        (type === 'warning' && showWarning) ||
                        (type === 'error' && showError)
                    );
                    
                    msg.classList.toggle('hidden', !shouldShow);
                });
            },
            
            updateToggleButton() {
                const toggleBtn = document.getElementById('consoleToggleBtn');
                if (toggleBtn) {
                    toggleBtn.classList.toggle('has-messages', this.messages.length > 0);
                }
            },
            
            clear() {
                this.messages = [];
                this.updateConsole();
                this.updateToggleButton();
                this.addMessage('Mesaj konsolu temizlendi', 'info');
            },
            
            toggle() {
                const console = document.getElementById('messageConsole');
                if (!console) return;
                
                this.isVisible = !this.isVisible;
                console.classList.toggle('show', this.isVisible);
                
                if (this.isVisible) {
                    this.updateConsole();
                }
            },
            
            minimize() {
                const console = document.getElementById('messageConsole');
                const toggleBtn = document.getElementById('consoleMinimizeBtn');
                
                if (console) {
                    console.classList.toggle('console-minimized');
                    const isMinimized = console.classList.contains('console-minimized');
                    
                    if (toggleBtn) {
                        toggleBtn.textContent = isMinimized ? '+' : '−';
                    }
                }
            },
            
            setupDragAndDrop() {
                const console = document.getElementById('messageConsole');
                const header = console?.querySelector('.console-header');
                
                if (!console || !header) return;
                
                header.addEventListener('mousedown', (e) => {
                    if (this.isDocked) return; // Docked iken taşınmaz
                    
                    this.dragData.isDragging = true;
                    this.dragData.startX = e.clientX;
                    this.dragData.startY = e.clientY;
                    
                    const rect = console.getBoundingClientRect();
                    this.dragData.startLeft = rect.left;
                    this.dragData.startTop = rect.top;
                    
                    header.style.cursor = 'grabbing';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!this.dragData.isDragging || this.isDocked) return;
                    
                    const deltaX = e.clientX - this.dragData.startX;
                    const deltaY = e.clientY - this.dragData.startY;
                    
                    const newLeft = Math.max(0, Math.min(window.innerWidth - console.offsetWidth, this.dragData.startLeft + deltaX));
                    const newTop = Math.max(0, Math.min(window.innerHeight - console.offsetHeight, this.dragData.startTop + deltaY));
                    
                    console.style.left = newLeft + 'px';
                    console.style.top = newTop + 'px';
                    console.style.right = 'auto';
                    console.style.bottom = 'auto';
                });
                
                document.addEventListener('mouseup', () => {
                    if (this.dragData.isDragging) {
                        this.dragData.isDragging = false;
                        header.style.cursor = 'move';
                    }
                });
            },
            
            toggleDock() {
                const console = document.getElementById('messageConsole');
                const dockBtn = document.getElementById('dockBtn');
                
                if (!console) return;
                
                this.isDocked = !this.isDocked;
                console.classList.toggle('docked-bottom', this.isDocked);
                
                if (this.isDocked) {
                    // Alt bara kilitle
                    console.style.left = '';
                    console.style.top = '';
                    console.style.right = '';
                    console.style.bottom = '';
                    
                    if (dockBtn) {
                        dockBtn.title = 'Serbest bırak';
                        dockBtn.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16,4V2H8V4H2V6H22V4H16M20,8H4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8Z"/>
                            </svg>
                        `;
                    }
                    
                    this.addMessage('Konsol alt bara kilitlendi', 'info');
                } else {
                    // Serbest konuma al
                    console.style.bottom = '20px';
                    console.style.right = '20px';
                    console.style.left = 'auto';
                    console.style.top = 'auto';
                    
                    if (dockBtn) {
                        dockBtn.title = 'Alt bara kilitle';
                        dockBtn.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16,20H20V16H16M16,14H20V10H16M4,8V4H8V8M10,20H14V16H10M16,8V4H20V8M4,20H8V16H4M4,14H8V10H4M10,8V4H14V8M10,14H14V10H10V14Z"/>
                            </svg>
                        `;
                    }
                    
                    this.addMessage('Konsol serbest konuma alındı', 'info');
                }
            }
        };
        
        // Sadece konsol sistemi - notification'lar kaldırıldı
        function showNotification(message, type = 'info', duration = 0) {
            // Sadece mesaj konsoluna ekle
            MessageConsole.addMessage(message, type);
        }
        

        
        // Konsol fonksiyonları
        function toggleMessageConsole() {
            MessageConsole.toggle();
        }
        
        function clearMessageConsole() {
            MessageConsole.clear();
        }
        
        function toggleConsoleMinimize() {
            MessageConsole.minimize();
        }
        
        function filterMessages() {
            MessageConsole.applyFilters();
        }
        
        function toggleConsoleDock() {
            MessageConsole.toggleDock();
        }
        
        // showToast fonksiyonu - geliştirilmiş versiyon
        function showToast(message, type = 'info') {
            try {
                // Önce MessageConsole'u dene
                if (typeof MessageConsole !== 'undefined' && MessageConsole.addMessage) {
                    MessageConsole.addMessage(message, type);
                    return;
                }
                
                // Fallback: Basit toast sistemi
                let toast = document.getElementById('toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = 'toast';
                    document.body.appendChild(toast);
                }
                
                toast.textContent = message;
                toast.className = `toast toast-${type} show`;
                
                // Auto hide
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('Toast error:', error);
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // Tüm seçimleri temizle - geliştirilmiş versiyon
        function clearAllSelections() {
            try {
                console.log('clearAllSelections çağrıldı');
                
                // Çizim modundayken seçimleri temizleme
                if (isDrawingMode) {
                    console.log('Çizim modu aktif, seçimler korunuyor');
                    return;
                }
                
                // Katman seçimlerini temizle
                document.querySelectorAll('.layer-item').forEach(item => {
                    item.classList.remove('selected-highlight', 'selected');
                });
                
                // Grup seçimlerini temizle
                document.querySelectorAll('.group-header').forEach(header => {
                    header.classList.remove('selected');
                });
                
                // Global değişkenleri temizle
                activeLayerId = null;
                activeGroupId = null;
                window.activeLayerId = null;
                window.activeGroupId = null;
                
                // Seçili bilgi panelini güncelle
                if (typeof updateSelectedInfo === 'function') {
                    updateSelectedInfo();
                }
                
            } catch (error) {
                console.error('clearAllSelections error:', error);
            }
        }

        // Seçili bilgi panelini güncelle - geliştirilmiş versiyon
        function updateSelectedInfo() {
            try {
                console.log('updateSelectedInfo çağrıldı - activeLayerId:', activeLayerId, 'activeGroupId:', activeGroupId);
                
                // Status bar'daki aktif katman bilgisini güncelle
                const activeLayerInfo = document.getElementById('activeLayerInfo');
                if (activeLayerInfo) {
                    if (activeLayerId) {
                        const layerElement = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
                        if (layerElement) {
                            const layerName = layerElement.querySelector('.layer-name')?.textContent || activeLayerId;
                            activeLayerInfo.textContent = layerName;
                            activeLayerInfo.style.color = 'var(--success-color)';
                        } else {
                            activeLayerInfo.textContent = 'Hatalı Katman';
                            activeLayerInfo.style.color = 'var(--danger-color)';
                        }
                    } else {
                        activeLayerInfo.textContent = 'Seçili Değil';
                        activeLayerInfo.style.color = 'var(--text-muted)';
                    }
                }
                
                // Seçili bilgi paneli varsa güncelle
                const infoPanel = document.getElementById('selectedInfoPanel');
                if (infoPanel) {
                    const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                    const selectedGroup = document.querySelector('.group-header.selected');
                    
                    if (selectedLayer || selectedGroup) {
                        let infoHtml = '';
                        
                        if (selectedLayer) {
                            const layerName = selectedLayer.querySelector('.layer-name').textContent;
                            const layerId = selectedLayer.getAttribute('data-layer-id');
                            
                            infoHtml += `
                                <div class="selected-layer-info">
                                    <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #a91e2c; display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 12px;">📋</span>
                                        Seçili Katman: ${layerName} (${layerId})
                                        <button onclick="clearLayerSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (selectedGroup) {
                            const groupName = selectedGroup.querySelector('.group-name').textContent;
                            const groupId = selectedGroup.closest('.layer-group').getAttribute('data-group-id');
                            
                            infoHtml += `
                                <div class="selected-group-info">
                                    <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #721c24; display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 12px;">📁</span>
                                        Seçili Grup: ${groupName} (${groupId})
                                        <button onclick="clearGroupSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        infoPanel.innerHTML = infoHtml;
                        infoPanel.style.display = 'block';
                    } else {
                        infoPanel.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('updateSelectedInfo error:', error);
            }
        }

        // Katman seçimini temizle
        function clearLayerSelection() {
            console.log('clearLayerSelection çağrıldı');
            
            // Çizim modundayken katman seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, katman seçimi korunuyor - clearLayerSelection iptal edildi');
                return;
            }
            
            // Tüm katman seçimlerini kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Aktif katmanı temizle
            activeLayerId = null;
            window.activeLayerId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }

        // Tüm modalları kapat
        function closeAllModals() {
            console.log('closeAllModals çağrıldı');
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Sürekli nokta çizim modunu durdur
        function stopContinuousPointMode() {
            if (window.continuousPointMode) {
                console.log('Sürekli nokta çizim modu durduruluyor...');
                window.continuousPointMode = false;
                
                // Aktif çizim araçlarını durdur
                if (window.drawControl && window.drawControl._toolbars.draw._modes.marker) {
                    const markerHandler = window.drawControl._toolbars.draw._modes.marker;
                    if (markerHandler.handler && markerHandler.handler.enabled && markerHandler.handler.enabled()) {
                        markerHandler.handler.disable();
                    }
                }
                
                // Tool butonlarının active class'ını temizle
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                showNotification('Nokta ekleme modu durduruldu', 'success');
            }
        }

        // Çizim fonksiyonları
        function startDrawing(type) {
            try {
                console.log('startDrawing çağrıldı:', type);
                
                // CRITICAL FIX: Stop measurement tools to prevent conflicts
                if (measurementTools && measurementTools.isActive) {
                    console.log('startDrawing: Ölçüm aracı durdurulıyor...');
                    measurementTools.stopMeasurement();
                }
                
                // Sürekli nokta çizim modu flag'ini set et
                if (type === 'marker') {
                    window.continuousPointMode = true;
                    console.log('Sürekli nokta çizim modu etkinleştirildi');
                } else {
                    window.continuousPointMode = false;
                }
                
                // Clear any active tools
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                // Activate current tool
                const toolBtn = document.getElementById(type + 'Btn') || 
                               document.querySelector(`[onclick*="${type}"]`);
                if (toolBtn) {
                    toolBtn.classList.add('active');
                }
                
                // Check if there's a selected layer - daha esnek kontrol
                if (!window.activeLayerId) {
                    const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                    if (selectedLayer) {
                        window.activeLayerId = selectedLayer.getAttribute('data-layer-id');
                        activeLayerId = window.activeLayerId;
                    } else {
                        // Varsayılan grup oluşturma devre dışı - artık localStorage sistemini kullanıyoruz
                        const hasLayers = document.querySelectorAll('.layer-item').length > 0;
                        if (!hasLayers) {
                            // createDefaultGroup(); // Devre dışı
                            showNotification('Çizim için önce bir grup ve katman oluşturun', 'warning');
                        } else {
                            showNotification('Çizim için bir katman seçin veya yeni katman oluşturun', 'warning');
                            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                            return;
                        }
                    }
                }
                
                // Double check that we have a valid layer
                const targetLayer = document.querySelector(`[data-layer-id="${window.activeLayerId}"]`);
                if (!targetLayer) {
                    showNotification('Seçili katman bulunamadı! Lütfen tekrar bir katman seçin.', 'error');
                    window.activeLayerId = null;
                    activeLayerId = null;
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    return;
                }
                
                // Store the active layer ID for drawing
                window.drawingActiveLayerId = window.activeLayerId;
                
                // Map the type to Leaflet Draw actions
                const drawHandlers = {
                    'marker': window.drawControl._toolbars.draw._modes.marker,
                    'polyline': window.drawControl._toolbars.draw._modes.polyline,
                    'polygon': window.drawControl._toolbars.draw._modes.polygon,
                    'rectangle': window.drawControl._toolbars.draw._modes.rectangle,
                    'circle': window.drawControl._toolbars.draw._modes.circle
                };
                
                // Get the appropriate handler
                const handler = drawHandlers[type];
                if (handler && handler.handler) {
                    // Stop any currently active drawing
                    Object.values(drawHandlers).forEach(mode => {
                        if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                            mode.handler.disable();
                        }
                    });
                    
                    // Ensure map interactions are enabled for polygon double-click finishing
                    if (type === 'polygon') {
                        console.log('Poligon çizimi - harita interaksiyonları kontrol ediliyor...');
                        // Make sure double-click is enabled for polygon finishing
                        if (map.doubleClickZoom && !map.doubleClickZoom.enabled()) {
                            map.doubleClickZoom.enable();
                            console.log('Double-click zoom etkinleştirildi');
                        }
                    }
                    
                    // Start the new drawing mode
                    handler.handler.enable();
                    
                    // Add visual feedback
                    const iconData = ICON_LIBRARY[type] || { name: type };
                    const layerName = targetLayer.querySelector('.layer-name')?.textContent || window.drawingActiveLayerId;
                    
                    if (type === 'marker') {
                        showNotification(`${iconData.name} sürekli ekleme modu - "${layerName}" katmanına çizilecek (ESC veya sağ tık ile durdurun)`, 'info');
                    } else {
                        showNotification(`${iconData.name} çizim modu aktif - "${layerName}" katmanına çizilecek${type === 'polygon' ? ' (Çift tıklayarak bitirebilirsiniz)' : ''}`, 'info');
                    }
                    
                    console.log(`Drawing started: ${type} on layer: ${window.drawingActiveLayerId}`);
                } else {
                    throw new Error(`Drawing handler not found for type: ${type}`);
                }
                
            } catch (error) {
                console.error('startDrawing error:', error);
                showNotification('Çizim başlatılamadı: ' + error.message, 'error');
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            }
        }

        // Düzenleme modu
        function toggleEditMode() {
            console.log('toggleEditMode çağrıldı');
            try {
                if (window.drawControl && window.drawControl._toolbars.edit) {
                    const editMode = window.drawControl._toolbars.edit._modes.edit;
                    if (editMode && editMode.handler) {
                        if (editMode.handler.enabled()) {
                            editMode.handler.disable();
                            document.getElementById('editBtn').classList.remove('active');
                            showNotification('Düzenleme modu kapatıldı', 'info');
                        } else {
                            editMode.handler.enable();
                            document.getElementById('editBtn').classList.add('active');
                            showNotification('Düzenleme modu açıldı', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error('toggleEditMode error:', error);
                showNotification('Düzenleme modu hatası: ' + error.message, 'error');
            }
        }

        // Silme modu
        function toggleDeleteMode() {
            console.log('toggleDeleteMode çağrıldı');
            try {
                if (window.drawControl && window.drawControl._toolbars.edit) {
                    const deleteMode = window.drawControl._toolbars.edit._modes.remove;
                    if (deleteMode && deleteMode.handler) {
                        if (deleteMode.handler.enabled()) {
                            deleteMode.handler.disable();
                            document.getElementById('deleteBtn').classList.remove('active');
                            showNotification('Silme modu kapatıldı', 'info');
                        } else {
                            deleteMode.handler.enable();
                            document.getElementById('deleteBtn').classList.add('active');
                            showNotification('Silme modu açıldı - çizimlere tıklayarak silin', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error('toggleDeleteMode error:', error);
                showNotification('Silme modu hatası: ' + error.message, 'error');
            }
        }

        // Lejant toggle
        function toggleLegend() {
            console.log('toggleLegend çağrıldı');
            const legend = document.getElementById('legend');
            if (legend) {
                if (legend.style.display === 'none' || legend.style.display === '') {
                    legend.style.display = 'block';
                    showNotification('Lejant açıldı', 'info');
                } else {
                    legend.style.display = 'none';
                    showNotification('Lejant kapatıldı', 'info');
                }
            }
        }

        // Zoom to extent
        function zoomToExtent() {
            console.log('zoomToExtent çağrıldı');
            try {
                if (drawnItems.getLayers().length > 0) {
                    map.fitBounds(drawnItems.getBounds());
                    showNotification('Tüm çizimlere zoom yapıldı', 'success');
                } else {
                    showNotification('Zoom yapılacak çizim bulunamadı', 'warning');
                }
            } catch (error) {
                console.error('zoomToExtent error:', error);
                showNotification('Zoom hatası: ' + error.message, 'error');
            }
        }

        // Tam ekran
        function toggleFullscreen() {
            console.log('toggleFullscreen çağrıldı');
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    showNotification('Tam ekran modu açıldı', 'info');
                } else {
                    document.exitFullscreen();
                    showNotification('Tam ekran modundan çıkıldı', 'info');
                }
            } catch (error) {
                console.error('toggleFullscreen error:', error);
                showNotification('Tam ekran hatası: ' + error.message, 'error');
            }
        }

        // Modal ve Layer yönetim fonksiyonları
        function showCreateGroupModal() {
            console.log('showCreateGroupModal çağrıldı');
            showNotification('Grup oluşturma modal fonksiyonu henüz tamamlanmadı', 'info');
        }

        function showCreateLayerModal() {
            console.log('showCreateLayerModal çağrıldı');
            showNotification('Katman oluşturma modal fonksiyonu henüz tamamlanmadı', 'info');
        }

        function toggleLayerFilter() {
            console.log('toggleLayerFilter çağrıldı');
            const panel = document.getElementById('searchFilterPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } else {
                showNotification('Filtre paneli bulunamadı', 'warning');
            }
        }

        function expandAllGroups() {
            console.log('expandAllGroups çağrıldı');
            document.querySelectorAll('.group-items').forEach(group => {
                group.style.display = 'block';
            });
            document.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.textContent = '▼';
            });
            showNotification('Tüm gruplar açıldı', 'info');
        }

        function collapseAllGroups() {
            console.log('collapseAllGroups çağrıldı');
            document.querySelectorAll('.group-items').forEach(group => {
                group.style.display = 'none';
            });
            document.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.textContent = '▶';
            });
            showNotification('Tüm gruplar kapatıldı', 'info');
        }

        function toggleGroup(groupId) {
            console.log('toggleGroup çağrıldı:', groupId);
            const groupItems = document.getElementById(`group-${groupId}`);
            const groupToggle = document.querySelector(`[onclick="toggleGroup('${groupId}')"]`);
            
            if (groupItems) {
                if (groupItems.style.display === 'none') {
                    groupItems.style.display = 'block';
                    if (groupToggle) groupToggle.textContent = '▼';
                } else {
                    groupItems.style.display = 'none';
                    if (groupToggle) groupToggle.textContent = '▶';
                }
            }
        }

        function toggleAllLayersInGroup(event, checkbox) {
            console.log('toggleAllLayersInGroup çağrıldı');
            event.stopPropagation();
            const group = checkbox.closest('.layer-group');
            const layerCheckboxes = group.querySelectorAll('.layer-item input[type="checkbox"]');
            
            layerCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                // Trigger visibility change
                cb.dispatchEvent(new Event('change'));
            });
            
            showNotification(`Grup katmanları ${checkbox.checked ? 'gösterildi' : 'gizlendi'}`, 'info');
        }

        function showLayerProperties(button) {
            console.log('showLayerProperties çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katman özellikleri: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function openStyleModal(type) {
            console.log('openStyleModal çağrıldı:', type);
            const modal = document.getElementById('styleModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                showNotification('Stil modal bulunamadı', 'warning');
            }
        }

        function openLayerDetails(button) {
            console.log('openLayerDetails çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katman detayları: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function deleteLayer(button) {
            console.log('deleteLayer çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            const layerName = layerItem?.querySelector('.layer-name')?.textContent;
            
            if (confirm(`"${layerName}" katmanını silmek istediğinizden emin misiniz?`)) {
                layerItem?.remove();
                showNotification(`Katman "${layerName}" silindi`, 'success');
            }
        }

        function zoomToLayer(button) {
            console.log('zoomToLayer çağrıldı');
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem?.getAttribute('data-layer-id');
            showNotification(`Katmana zoom: ${layerId || 'Bilinmeyen'}`, 'info');
        }

        function openQueryModal(button) {
            console.log('openQueryModal çağrıldı');
            const modal = document.getElementById('queryModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                showNotification('Sorgu modal bulunamadı', 'warning');
            }
        }

        // Ölçek fonksiyonları
        function toggleScaleSelector(event) {
            console.log('toggleScaleSelector çağrıldı');
            event.stopPropagation();
            const selector = document.querySelector('.scale-selector');
            if (selector) {
                selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
            }
        }

        function setFixedScale(scale) {
            console.log('setFixedScale çağrıldı:', scale);
            const scaleText = document.getElementById('scaleText');
            if (scaleText) {
                scaleText.textContent = `1:${scale.toLocaleString()}`;
            }
            // Hide selector
            const selector = document.querySelector('.scale-selector');
            if (selector) selector.style.display = 'none';
            showNotification(`Ölçek 1:${scale.toLocaleString()} olarak ayarlandı`, 'info');
        }

        function setDynamicScale() {
            console.log('setDynamicScale çağrıldı');
            const selector = document.querySelector('.scale-selector');
            if (selector) selector.style.display = 'none';
            showNotification('Dinamik ölçek moduna geçildi', 'info');
        }

        function switchToDynamicScale() {
            console.log('switchToDynamicScale çağrıldı');
            setDynamicScale();
        }

        // Lejant fonksiyonları
        function toggleLegendSettings() {
            console.log('toggleLegendSettings çağrıldı');
            showNotification('Lejant ayarları henüz tamamlanmadı', 'info');
        }

        function toggleLegendContent() {
            console.log('toggleLegendContent çağrıldı');
            const legend = document.getElementById('legend');
            const content = legend?.querySelector('.legend-content');
            if (content) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            }
        }

        function closeLegend() {
            console.log('closeLegend çağrıldı');
            const legend = document.getElementById('legend');
            if (legend) {
                legend.style.display = 'none';
            }
        }

        // Context menu
        function contextMenuAction(action) {
            console.log('contextMenuAction çağrıldı:', action);
            showNotification(`Context menu action: ${action}`, 'info');
        }

        // Otomatik grup ve katman oluştur
        // createDefaultGroup - Devre Dışı (localStorage sistemi kullanılıyor)
        function createDefaultGroup() {
            console.log('🚫 createDefaultGroup çağrıldı ama localStorage sistemi aktif - hiçbir şey yapılmıyor');
            // Bu fonksiyon artık localStorage sistemi aktif olduğu için kullanılmıyor
            return null;
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function toggleLayerFilter() {
            const panel = document.getElementById('searchFilterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // === VERİ KALILCILIKİ SİSTEMİ ===
        const DataPersistence = {
            STORAGE_KEYS: {
                APP_DATA: 'gis_app_data',
                FIRST_LAUNCH: 'gis_first_launch'
            },

            // Uygulamanın tüm verilerini kaydet
            saveAppData() {
                try {
                    console.log('💾 Veri kaydetme başlatılıyor...');
                    
                    const groups = this.serializeGroups();
                    const layers = this.serializeLayers();
                    const features = this.serializeFeatures();
                    const settings = this.serializeSettings();
                    
                    console.log('📊 Kaydedilecek veriler:', {
                        groups: groups.length + ' grup',
                        layers: layers.length + ' katman',
                        features: Object.keys(features).length + ' çizim',
                        settings: Object.keys(settings).length + ' ayar'
                    });
                    
                    const appData = {
                        groups: groups,
                        layers: layers,
                        features: features,
                        settings: settings,
                        timestamp: Date.now()
                    };

                    localStorage.setItem(this.STORAGE_KEYS.APP_DATA, JSON.stringify(appData));
                    console.log('✅ Uygulama verileri başarıyla kaydedildi');
                    return true;
                } catch (error) {
                    console.error('❌ Veri kaydetme hatası:', error);
                    return false;
                }
            },

            // Grupları serialize et
            serializeGroups() {
                const groups = [];
                document.querySelectorAll('.layer-group').forEach(groupEl => {
                    const groupId = groupEl.getAttribute('data-group-id');
                    const groupName = groupEl.querySelector('.group-name').textContent;
                    const isExpanded = !groupEl.querySelector('.group-items').style.display || 
                                     groupEl.querySelector('.group-items').style.display !== 'none';
                    
                    // Farklı checkbox yapıları için kontrol
                    const visibilityCheckbox = groupEl.querySelector('.group-visibility-checkbox input') || 
                                              groupEl.querySelector('input.group-visibility-checkbox') ||
                                              groupEl.querySelector('.group-visibility-checkbox');
                    const isVisible = visibilityCheckbox ? visibilityCheckbox.checked : true;
                    
                    groups.push({
                        id: groupId,
                        name: groupName,
                        expanded: isExpanded,
                        visible: isVisible,
                        order: groups.length
                    });
                });
                return groups;
            },

            // Katmanları serialize et
            serializeLayers() {
                const layers = [];
                document.querySelectorAll('.layer-item').forEach(layerEl => {
                    const layerId = layerEl.getAttribute('data-layer-id');
                    const layerName = layerEl.querySelector('.layer-name').textContent;
                    const groupEl = layerEl.closest('.layer-group');
                    const groupId = groupEl ? groupEl.getAttribute('data-group-id') : null;
                    
                    // Katman görünürlük checkbox'ını bul
                    const visibilityCheckbox = layerEl.querySelector('input.layer-visibility') ||
                                              layerEl.querySelector('.layer-visibility-checkbox input') ||
                                              layerEl.querySelector('input[type="checkbox"]');
                    const isVisible = visibilityCheckbox ? visibilityCheckbox.checked : true;
                    
                    // Style mode bilgisini al
                    const styleModeIndicator = layerEl.querySelector('.layer-style-mode-indicator');
                    const styleMode = styleModeIndicator ? 
                        (styleModeIndicator.classList.contains('custom-mode') ? 'custom' : 'default') : 
                        'default';

                    layers.push({
                        id: layerId,
                        name: layerName,
                        groupId: groupId,
                        visible: isVisible,
                        styleMode: styleMode,
                        order: layers.length
                    });
                });
                return layers;
            },

            // Çizim verilerini serialize et
            serializeFeatures() {
                const features = {};
                
                // drawnLayers array'ından verileri al
                if (window.drawnLayers && Array.isArray(window.drawnLayers)) {
                    window.drawnLayers.forEach(layerData => {
                        if (layerData.layerId && layerData.layer) {
                            const geoJSON = layerData.layer.toGeoJSON();
                            features[layerData.layerId] = {
                                geoJSON: geoJSON,
                                style: layerData.style || {},
                                properties: layerData.properties || {},
                                type: layerData.type || 'unknown'
                            };
                        }
                    });
                }

                // layerFeatures global object'inden de al
                if (window.layerFeatures) {
                    Object.keys(window.layerFeatures).forEach(layerId => {
                        if (!features[layerId]) {
                            features[layerId] = [];
                        }
                        if (Array.isArray(window.layerFeatures[layerId])) {
                            features[layerId] = window.layerFeatures[layerId].map(feature => {
                                return {
                                    geoJSON: feature.toGeoJSON ? feature.toGeoJSON() : feature,
                                    style: feature.options || {},
                                    properties: feature.properties || {}
                                };
                            });
                        }
                    });
                }

                return features;
            },

            // Ayarları serialize et
            serializeSettings() {
                const settings = {};
                
                // Stil ayarlarını al
                const styleInputs = [
                    'pointColor', 'pointSize', 'pointShape', 'pointOpacity',
                    'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                    'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType'
                ];
                
                styleInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        settings[inputId] = input.value;
                    }
                });

                // Aktif seçimleri kaydet
                settings.activeLayerId = window.activeLayerId;
                settings.activeGroupId = window.activeGroupId;
                
                return settings;
            },

            // Kaydedilmiş verileri yükle
            loadAppData() {
                try {
                    console.log('🔍 localStorage\'dan veri yükleme başlatılıyor...');
                    const savedData = localStorage.getItem(this.STORAGE_KEYS.APP_DATA);
                    if (!savedData) {
                        console.log('💡 Kaydedilmiş veri bulunamadı - boş başlatılıyor');
                        return false;
                    }

                    const appData = JSON.parse(savedData);
                    console.log('📂 Kaydedilmiş veriler yükleniyor...', appData);

                    // Önce mevcut verileri temizle
                    console.log('🧹 Mevcut veriler temizleniyor...');
                    this.clearExistingData();

                    // Verileri yükle
                    console.log('📁 Gruplar yükleniyor:', appData.groups || []);
                    this.loadGroups(appData.groups || []);
                    
                    console.log('📄 Katmanlar yükleniyor:', appData.layers || []);
                    this.loadLayers(appData.layers || []);
                    
                    console.log('✏️ Çizimler yükleniyor:', Object.keys(appData.features || {}));
                    this.loadFeatures(appData.features || {});
                    
                    console.log('⚙️ Ayarlar yükleniyor:', appData.settings || {});
                    this.loadSettings(appData.settings || {});

                    console.log('✅ Veriler başarıyla yüklendi');
                    return true;
                } catch (error) {
                    console.error('❌ Veri yükleme hatası:', error);
                    return false;
                }
            },

            // Mevcut verileri temizle
            clearExistingData() {
                console.log('🧹 Tüm mevcut veriler temizleniyor...');
                
                // Layer listini tamamen temizle (statik katmanlar dahil)
                const layerList = document.getElementById('layerList');
                if (layerList) {
                    layerList.innerHTML = '<!-- Dinamik grup ve katmanlar localStorage\'dan yüklenecek -->';
                    console.log('✓ Layer list temizlendi');
                }

                // Global değişkenleri sıfırla
                if (window.drawnLayers) {
                    console.log(`✓ ${window.drawnLayers.length} çizim verisi temizlendi`);
                    window.drawnLayers = [];
                }
                if (window.layerFeatures) {
                    const featureCount = Object.keys(window.layerFeatures).length;
                    console.log(`✓ ${featureCount} katman feature verisi temizlendi`);
                    window.layerFeatures = {};
                }
                
                // Aktif seçimleri temizle
                window.activeLayerId = null;
                window.activeGroupId = null;
                console.log('✓ Aktif seçimler temizlendi');

                // Haritadaki çizimleri temizle
                if (window.drawnItems) {
                    const layerCount = window.drawnItems.getLayers().length;
                    window.drawnItems.clearLayers();
                    console.log(`✓ Haritadan ${layerCount} çizim kaldırıldı`);
                }
                
                // Seçili element vurgulamalarını temizle
                document.querySelectorAll('.selected, .selected-highlight').forEach(el => {
                    el.classList.remove('selected', 'selected-highlight');
                });
                
                console.log('🎯 Tüm veriler başarıyla temizlendi');
            },

            // Grupları yükle
            loadGroups(groups) {
                const layerListContainer = document.getElementById('layerList');
                if (!layerListContainer) {
                    console.error('❌ LayerList container bulunamadı!');
                    return;
                }

                if (!groups || groups.length === 0) {
                    console.log('📭 Yüklenecek grup yok');
                    return;
                }

                console.log(`📁 ${groups.length} grup yükleniyor...`);
                
                groups.forEach((group, index) => {
                    try {
                        console.log(`  ➤ Grup ${index + 1}: "${group.name}" (${group.id})`);
                        
                const groupHTML = `
                            <div class="layer-group" data-group-id="${group.id}">
                        <div class="group-header">
                                    <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                                        <input type="checkbox" class="group-visibility-checkbox" ${group.visible ? 'checked' : ''} onclick="toggleAllLayersInGroup(event, this)">
                            </div>
                                    <div class="group-select-area" onclick="selectGroup(this)">
                                        <span class="group-name">${group.name}</span>
                                <span class="group-count">0</span>
                            </div>
                                    <div class="group-toggle-area" onclick="toggleGroup(this)">
                                        <span class="group-icon">${group.expanded ? '▼' : '▶'}</span>
                            </div>
                        </div>
                                <div class="group-items" style="display: ${group.expanded ? 'block' : 'none'}">
                                    <!-- Katmanlar buraya eklenecek -->
                                </div>
                    </div>
                `;
                layerListContainer.insertAdjacentHTML('beforeend', groupHTML);
                        console.log(`    ✓ Grup "${group.name}" başarıyla eklendi`);
                    } catch (error) {
                        console.error(`❌ Grup "${group.name}" yüklenirken hata:`, error);
                    }
                });
                
                console.log(`✅ ${groups.length} grup başarıyla yüklendi`);
            },

            // Katmanları yükle
            loadLayers(layers) {
                if (!layers || layers.length === 0) {
                    console.log('📭 Yüklenecek katman yok');
                    return;
                }

                console.log(`📄 ${layers.length} katman yükleniyor...`);
                
                layers.forEach((layer, index) => {
                    try {
                        console.log(`  ➤ Katman ${index + 1}: "${layer.name}" (${layer.id}) → Grup: ${layer.groupId}`);
                        
                        const targetGroup = document.querySelector(`[data-group-id="${layer.groupId}"]`);
                        if (!targetGroup) {
                            console.error(`❌ Grup bulunamadı: ${layer.groupId}`);
                            return;
                        }

                        const groupItems = targetGroup.querySelector('.group-items');
                        if (!groupItems) {
                            console.error(`❌ Grup items container bulunamadı: ${layer.groupId}`);
                            return;
                        }

                    const styleModeClass = layer.styleMode === 'custom' ? 'custom-mode' : 'default-mode';
                    const styleModeIcon = layer.styleMode === 'custom' ? '👤' : '🏢';
                    const styleModeTitle = layer.styleMode === 'custom' ? 'Kullanıcı Özel Ayarları' : 'Varsayılan Kurumsal Ayarlar';
                
                const layerHTML = `
                        <div class="layer-item" data-layer-id="${layer.id}" draggable="true">
                            <input type="checkbox" class="layer-visibility" ${layer.visible ? 'checked' : ''}>
                        <div class="layer-selectable-area">
                                <div class="layer-icons">
                                    <div class="layer-icon inactive" title="Nokta verisi">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                            <circle cx="12" cy="12" r="8"/>
                                        </svg>
                            </div>
                                    <div class="layer-icon inactive" title="Çizgi verisi">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path d="M2 8 L8 8 L12 16 L16 16 L22 8" fill="none" stroke="currentColor" stroke-width="3"/>
                                        </svg>
                                    </div>
                                    <div class="layer-icon inactive" title="Poligon verisi">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor" stroke="#000000" stroke-width="1"/>
                                        </svg>
                                    </div>
                                </div>
                                <span class="layer-name">${layer.name}</span>
                                <span class="layer-style-mode-indicator ${styleModeClass}" data-layer-id="${layer.id}" title="${styleModeTitle}" onclick="toggleLayerStyleMode('${layer.id}', event)">
                                    ${styleModeIcon}
                                </span>
                        </div>
                        <div class="layer-actions">
                                <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M13,7H11V5H13M13,17H11V9H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                                    </svg>
                                </button>
                                <button class="layer-action-btn delete" title="Sil" onclick="deleteLayer(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                </button>
                        </div>
                    </div>
                `;
                    groupItems.insertAdjacentHTML('beforeend', layerHTML);
                    console.log(`    ✓ Katman "${layer.name}" başarıyla eklendi`);
                    
                    } catch (error) {
                        console.error(`❌ Katman "${layer.name}" yüklenirken hata:`, error);
                    }
                });

                // Grup sayılarını güncelle
                console.log('🔢 Grup sayıları güncelleniyor...');
                this.updateGroupCounts();
                console.log(`✅ ${layers.length} katman başarıyla yüklendi`);
            },

            // Çizim verilerini yükle
            loadFeatures(features) {
                Object.keys(features).forEach(layerId => {
                    const featureData = features[layerId];
                    
                    if (Array.isArray(featureData)) {
                        // Array formatındaki veriler (layerFeatures)
                        featureData.forEach(feature => {
                            this.addFeatureToMap(layerId, feature);
                        });
                    } else if (featureData.geoJSON) {
                        // Tek feature formatındaki veriler (drawnLayers)
                        this.addFeatureToMap(layerId, featureData);
                    }
                });
            },

            // Haritaya feature ekle
            addFeatureToMap(layerId, featureData) {
                try {
                    const layer = L.geoJSON(featureData.geoJSON, {
                        style: featureData.style || {},
                        onEachFeature: function(feature, layer) {
                            if (featureData.properties) {
                                layer.properties = featureData.properties;
                            }
                        }
                    });

                    // Haritaya ekle
                    if (window.drawnItems) {
                        window.drawnItems.addLayer(layer);
                    }

                    // Global arrays'e ekle
                    if (!window.layerFeatures[layerId]) {
                        window.layerFeatures[layerId] = [];
                    }
                    window.layerFeatures[layerId].push(layer);

                    if (!window.drawnLayers) {
                        window.drawnLayers = [];
                    }
                    window.drawnLayers.push({
                        layerId: layerId,
                        layer: layer,
                        style: featureData.style || {},
                        properties: featureData.properties || {},
                        type: featureData.type || 'unknown'
                    });
                
            } catch (error) {
                    console.error('Feature ekleme hatası:', error, featureData);
                }
            },

            // Ayarları yükle
            loadSettings(settings) {
                Object.keys(settings).forEach(key => {
                    if (key === 'activeLayerId') {
                        window.activeLayerId = settings[key];
                    } else if (key === 'activeGroupId') {
                        window.activeGroupId = settings[key];
                    } else {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = settings[key];
                        }
                    }
                });
            },

            // Grup sayılarını güncelle
            updateGroupCounts() {
                document.querySelectorAll('.layer-group').forEach(groupEl => {
                    const groupId = groupEl.getAttribute('data-group-id');
                    const layerCount = groupEl.querySelectorAll('.layer-item').length;
                    const countEl = groupEl.querySelector('.group-count');
                    if (countEl) {
                        countEl.textContent = layerCount;
                    }
                });
            },

            // İlk açılış kontrolü
            isFirstLaunch() {
                return !localStorage.getItem(this.STORAGE_KEYS.APP_DATA);
            },

            // Veri değişikliklerini otomatik kaydet
            autoSave() {
                // Debounced save function
                if (this.saveTimeout) {
                    clearTimeout(this.saveTimeout);
                }
                this.saveTimeout = setTimeout(() => {
                    this.saveAppData();
                }, 1000); // 1 saniye gecikmeli kaydetme
                         }
         };

                 // DataPersistence'ı global olarak erişilebilir yap
        window.DataPersistence = DataPersistence;

        // Manuel kaydetme fonksiyonu
        function manualSaveData() {
            const success = DataPersistence.saveAppData();
            if (success) {
                showToast('Veriler başarıyla kaydedildi! 💾', 'success');
            } else {
                showToast('Veri kaydetme hatası! ❌', 'error');
            }
        }
        
        // Global erişim için
        window.manualSaveData = manualSaveData;

        // Tüm verileri sıfırlama fonksiyonu
        function resetAllData() {
            if (confirm('⚠️ Bu işlem tüm grupları, katmanları ve çizimleri silecek!\n\nDevam etmek istediğinizden emin misiniz?')) {
                // localStorage'ı temizle
                localStorage.removeItem(DataPersistence.STORAGE_KEYS.APP_DATA);
                
                // Mevcut verileri temizle
                DataPersistence.clearExistingData();
                
                // Başarı mesajı göster
                showToast('Tüm veriler sıfırlandı! 🗑️', 'success');
                
                console.log('🧹 Tüm uygulama verileri sıfırlandı');
            }
        }
        
        // Global erişim için
        window.resetAllData = resetAllData;

        // === VERİ KALILCILIKİ EVENT LİSTENERS ===
        
        // Veri değişikliği algılamaları
        function setupDataPersistenceListeners() {
            // DOM değişikliklerini izle (grup/katman ekleme/silme)
            const observer = new MutationObserver(function(mutations) {
                let shouldSave = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // Grup veya katman eklendi/silindi
                        const addedNodes = Array.from(mutation.addedNodes);
                        const removedNodes = Array.from(mutation.removedNodes);
                        
                        if (addedNodes.some(node => node.classList && (node.classList.contains('layer-group') || node.classList.contains('layer-item'))) ||
                            removedNodes.some(node => node.classList && (node.classList.contains('layer-group') || node.classList.contains('layer-item')))) {
                            shouldSave = true;
                        }
                    }
                });
                
                if (shouldSave) {
                    DataPersistence.autoSave();
                }
            });

            // Layer list container'ı izle
            const layerList = document.getElementById('layerList');
            if (layerList) {
                observer.observe(layerList, { 
                    childList: true, 
                    subtree: true 
                });
            }

            // Harita çizim olaylarını izle (harita hazır olduğunda)
            function setupMapEventListeners() {
                if (window.map) {
                    window.map.on('draw:created', function(e) {
                        DataPersistence.autoSave();
                    });
                    
                    window.map.on('draw:deleted', function(e) {
                        DataPersistence.autoSave();
                    });
                    
                    window.map.on('draw:edited', function(e) {
                        DataPersistence.autoSave();
                    });
                    
                    console.log('🗺️ Harita event listener\'ları başarıyla bağlandı');
                } else {
                    // Harita henüz hazır değil, 100ms sonra tekrar dene
                    setTimeout(setupMapEventListeners, 100);
                }
            }
            
            // Harita event listener'larını başlat
            setupMapEventListeners();
        }
        
        // === ESKI KODLAR TEMİZLENDİ ===
        
        var measurementTools = null;
        

        
        document.addEventListener('DOMContentLoaded', function() {
            // Modal taşıma işlevselliğini başlat
            initModalDragging();
            
            // Nokta stil tipi değişikliğini dinle
            initPointStyleTypeToggle();
            
            // Haritayı başlat
            map = L.map('map').setView([41.0082, 28.9784], 10);
            
            // Temel harita katmanını ekle
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Çizim katmanını haritaya ekle
            map.addLayer(drawnItems);
            
            // Measurement tools'u başlat
            measurementTools = new MeasurementTools(map);
            
            // Mesaj konsolunu başlat
            MessageConsole.init();
            
            // Context menu event listener
            setupContextMenu();
            
            // Keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Search functionality
            setupSearchAndFilter();
            
            // Koordinat ve ölçek işlevselliğini başlat
            setupCoordinateDisplay();
            setupScaleDisplay();
            setupProjectionSystem();
            
            // === VERİ YÜKLEME SİSTEMİ ===
            // Kaydedilmiş verileri yükle, yoksa boş başlat
            setTimeout(() => {
                const dataLoaded = DataPersistence.loadAppData();
                
                if (!dataLoaded) {
                    console.log('🎯 İlk açılış - boş başlatılıyor');
                    showToast('Hoş geldiniz! İlk defa açılıyor.', 'info');
                } else {
                    console.log('🔄 Kaydedilmiş veriler yüklendi');
                    showToast('Kaydedilmiş verileriniz yüklendi.', 'success');
                }
                
                // Veri değişikliği izleyicilerini başlat
                setupDataPersistenceListeners();
            }, 500);
            
            // Çizim araçlarını tanımla ve mevcut stil ayarlarına göre yapılandır
            function getDrawControl() {
                // Mevcut stil ayarlarını al
                const pointColor = document.getElementById('pointColor').value || "#ff0000";
                const lineColor = document.getElementById('lineColor').value || "#ff7800";
                const lineWidth = parseInt(document.getElementById('lineWidth').value || 3);
                const fillColor = document.getElementById('fillColor').value || "#3388ff";
                const fillOpacity = (document.getElementById('fillOpacity').value || 50) / 100;
                const strokeColor = document.getElementById('strokeColor').value || "#000000";
                const strokeWidth = parseInt(document.getElementById('strokeWidth').value || 1);
                
                // Çizgi stili için dashArray tanımla
                const lineType = document.getElementById('lineType').value || "solid";
                const lineDashArray = calculateDashArray(lineType, lineWidth);
                
                // Poligon stili için dashArray tanımla
                const strokeType = document.getElementById('strokeType').value || "solid";
                const strokeDashArray = calculateDashArray(strokeType, strokeWidth);
                
                return new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polyline: {
                            shapeOptions: {
                                color: lineColor,
                                weight: lineWidth,
                                dashArray: lineDashArray
                            }
                        },
                        polygon: {
                            allowIntersection: false,
                            showArea: true,
                            metric: true,
                            feet: false,
                            nautic: false,
                            precision: 2,
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        circle: {
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        rectangle: {
                            shapeOptions: {
                                color: strokeColor,
                                weight: strokeWidth,
                                dashArray: strokeDashArray,
                                fillColor: fillColor,
                                fillOpacity: fillOpacity
                            }
                        },
                        marker: true
                    },
                    edit: {
                        featureGroup: drawnItems,
                        remove: true
                    }
                });
            }
            
            // Çizim araçlarını oluştur ve haritaya ekle
            window.drawControl = getDrawControl();
            map.addControl(window.drawControl);
            
            // Çizim kontrolünü özel konuma taşı
            setTimeout(() => {
                const drawControl = document.querySelector('.leaflet-draw');
                const placeholder = document.getElementById('drawing-tools-placeholder');
                if (drawControl && placeholder) {
                    // Leaflet Draw kontrolünü özel tasarıma uyarla
                    drawControl.style.position = 'static';
                    drawControl.style.margin = '0';
                    
                    // Temel Geometri grubu oluştur
                    const geometryGroup = document.createElement('div');
                    geometryGroup.className = 'tool-group';
                    
                    const geometryTitle = document.createElement('div');
                    geometryTitle.className = 'tool-group-title';
                    geometryTitle.textContent = 'Temel Geometri';
                    
                    const geometryButtons = document.createElement('div');
                    geometryButtons.className = 'tool-buttons';
                    
                    // Şekil Çizimi grubu oluştur
                    const shapeGroup = document.createElement('div');
                    shapeGroup.className = 'tool-group';
                    
                    const shapeTitle = document.createElement('div');
                    shapeTitle.className = 'tool-group-title';
                    shapeTitle.textContent = 'Şekil Çizimi';
                    
                    const shapeButtons = document.createElement('div');
                    shapeButtons.className = 'tool-buttons';
                    
                    // Leaflet Draw butonlarını kategorilere ayır
                    const drawButtons = drawControl.querySelectorAll('a');
                    drawButtons.forEach(btn => {
                        const newBtn = document.createElement('button');
                        newBtn.className = 'tool-btn';
                        newBtn.title = btn.title;
                        newBtn.innerHTML = getDrawButtonIcon(btn.title);
                        newBtn.onclick = () => {
                            console.log('Çizim butonu tıklandı');
                            console.log('Buton tıklandığında aktif katman:', activeLayerId);
                            console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                            
                            // Seçili katman kontrolü
                            const activeLayer = getActiveLayer();
                            if (!activeLayer) {
                                alert('Çizim yapmak için önce bir katman seçmelisiniz!');
                                return;
                            }
                            
                            // Aktif katman ID'sini kaydet (çizim sırasında korunması için)
                            window.drawingActiveLayerId = activeLayerId;
                            console.log('Çizim başlatılıyor, aktif katman kaydedildi:', window.drawingActiveLayerId);
                            
                            // Leaflet Draw butonuna tıklamadan önce son kontrol
                            console.log('Leaflet Draw butonuna tıklamadan önce seçili katman:', document.querySelector('.layer-item.selected-highlight'));
                            
                            btn.click();
                            
                            // Leaflet Draw butonuna tıkladıktan sonra kontrol
                            setTimeout(() => {
                                console.log('Leaflet Draw butonuna tıkladıktan sonra seçili katman:', document.querySelector('.layer-item.selected-highlight'));
                            }, 100);
                        };
                        
                        // Butonları kategorilere göre ayır
                        if (btn.title.includes('marker') || btn.title.includes('Marker') || 
                            btn.title.includes('polyline') || btn.title.includes('line') || 
                            btn.title.includes('polygon')) {
                            geometryButtons.appendChild(newBtn);
                        } else if (btn.title.includes('circle') || btn.title.includes('Circle') ||
                                  btn.title.includes('rectangle') || btn.title.includes('Rectangle')) {
                            // Circle ve Rectangle butonlarını şekil grubuna ekle (eğer varsa)
                            shapeButtons.appendChild(newBtn);
                        } else {
                            // Edit ve Delete butonları için ayrı bir grup oluşturabiliriz
                            geometryButtons.appendChild(newBtn);
                        }
                    });
                    

                    
                    geometryGroup.appendChild(geometryTitle);
                    geometryGroup.appendChild(geometryButtons);
                    
                    shapeGroup.appendChild(shapeTitle);
                    shapeGroup.appendChild(shapeButtons);
                    
                    placeholder.appendChild(geometryGroup);
                    placeholder.appendChild(shapeGroup);
                    
                    // Orijinal kontrolü gizle
                    drawControl.style.display = 'none';
                }
            }, 100);
            
            // Stil değiştiğinde çizim kontrolünü güncelle
            function updateDrawControl() {
                // Eski kontrol kaldır
                if (window.drawControl) {
                    try {
                        map.removeControl(window.drawControl);
                    } catch(e) {
                        // Control yoksa hata vermesin
                    }
                }
                // Yeni kontrol oluştur ve haritaya ekle
                window.drawControl = getDrawControl();
                map.addControl(window.drawControl);
                
                // Çizim kontrolünü özel konuma taşı
                setTimeout(() => {
                    const drawControl = document.querySelector('.leaflet-draw');
                    const placeholder = document.getElementById('drawing-tools-placeholder');
                    if (drawControl && placeholder) {
                        // Leaflet Draw kontrolünü gizle (özel butonlar kullanıyoruz)
                        drawControl.style.display = 'none';
                    }
                }, 100);
            }
            
            // Çizim başladığında
            map.on('draw:drawstart', function(e) {
                isDrawingMode = true;
                window.drawingCompleted = false; // Flag'i sıfırla
                console.log('Çizim modu başladı, seçimler korunacak');
                console.log('Çizim başladığında aktif katman:', activeLayerId);
                console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                
                // CRITICAL FIX: Stop measurement tools to prevent event conflicts
                if (measurementTools && measurementTools.isActive) {
                    console.log('Ölçüm aracı aktif - devre dışı bırakılıyor...');
                    measurementTools.stopMeasurement();
                    showNotification('Çizim başlatıldı - ölçüm aracı durduruldu', 'info');
                }
                
                // Seçimleri backup'la
                window.backupActiveLayerId = activeLayerId;
                window.backupActiveGroupId = activeGroupId;
                
                // Seçili katman ve grup elementlerini backup'la
                const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                const selectedGroup = document.querySelector('.group-header.selected');
                window.backupSelectedLayer = selectedLayer;
                window.backupSelectedGroup = selectedGroup;
                
                console.log('Seçimler backup\'landı:', {
                    layerId: window.backupActiveLayerId,
                    groupId: window.backupActiveGroupId,
                    layerElement: window.backupSelectedLayer,
                    groupElement: window.backupSelectedGroup
                });
                
                // Çizim sırasında seçimleri koruma timer'ı başlat
                window.selectionProtectionTimer = setInterval(function() {
                    if (isDrawingMode && window.backupSelectedLayer && window.backupSelectedGroup) {
                        // Seçili katman kaybolmuşsa geri yükle
                        if (!window.backupSelectedLayer.classList.contains('selected-highlight')) {
                            console.log('Seçili katman kaybedildi, geri yükleniyor...');
                            // Önce tüm seçimleri kaldır
                            document.querySelectorAll('.layer-item').forEach(item => {
                                item.classList.remove('selected-highlight', 'selected');
                            });
                            // Backup'tan geri yükle
                            window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                            activeLayerId = window.backupActiveLayerId;
                        }
                        
                        // Seçili grup kaybolmuşsa geri yükle
                        if (!window.backupSelectedGroup.classList.contains('selected')) {
                            console.log('Seçili grup kaybedildi, geri yükleniyor...');
                            // Önce tüm grup seçimlerini kaldır
                            document.querySelectorAll('.group-header').forEach(h => {
                                h.classList.remove('selected');
                            });
                            // Backup'tan geri yükle
                            window.backupSelectedGroup.classList.add('selected');
                            activeGroupId = window.backupActiveGroupId;
                        }
                    }
                }, 50); // Her 50ms'de kontrol et (daha hızlı)
            });
            
            // Çizim iptal edildiğinde veya bittiğinde
            map.on('draw:drawstop', function(e) {
                // Çizim tamamlandıysa (draw:created event'i çalıştıysa) seçimi koruma işlemi orada yapılacak
                // Burada sadece timer'ı durdur, seçimi koruma
                console.log('Çizim durdu - timer durduruluyor, seçim korunuyor');
                
                // Clear active drawing tool buttons
                setTimeout(() => {
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Show cancellation message only if drawing was actually cancelled (not completed)
                    if (!window.drawingCompleted) {
                        showNotification('Çizim iptal edildi', 'info');
                    }
                }, 50);
                
                // Seçim koruma timer'ını durdur
                if (window.selectionProtectionTimer) {
                    clearInterval(window.selectionProtectionTimer);
                    window.selectionProtectionTimer = null;
                }
                
                // isDrawingMode'u biraz gecikme ile false yap ki draw:created event'i önce çalışsın
                setTimeout(() => {
                    isDrawingMode = false;
                    console.log('isDrawingMode false yapıldı');
                }, 100);
                
                // Eğer çizim tamamlanmadıysa (sadece iptal edildiyse) seçimi geri yükle
                setTimeout(() => {
                    if (!window.drawingCompleted && window.backupSelectedLayer && window.backupSelectedGroup) {
                        // Çizim iptal edildi, seçimi geri yükle
                        window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                        window.backupSelectedGroup.classList.add('selected');
                        activeLayerId = window.backupActiveLayerId;
                        activeGroupId = window.backupActiveGroupId;
                        console.log('Çizim iptal edildi, seçim geri yüklendi:', activeLayerId);
                        
                        // Backup'ları temizle
                        delete window.backupActiveLayerId;
                        delete window.backupActiveGroupId;
                        delete window.backupSelectedLayer;
                        delete window.backupSelectedGroup;
                    }
                    
                    // Flag'i sıfırla
                    window.drawingCompleted = false;
                }, 150);
            });
            
            // Çizim yapıldığında olayı dinle
            map.on('draw:created', function(e) {
                window.drawingCompleted = true; // Çizim tamamlandı flag'i
                console.log('Çizim tamamlandı, seçimler normale döndü');
                console.log('Çizim tamamlandığında aktif katman:', activeLayerId);
                console.log('Seçili katman elementi:', document.querySelector('.layer-item.selected-highlight'));
                console.log('Kaydedilen çizim katmanı:', window.drawingActiveLayerId);
                
                var type = e.layerType;
                var layer = e.layer;
                
                // Sürekli nokta çizim modu kontrolü
                const isContinuousPointMode = window.continuousPointMode && type === 'marker';
                
                if (!isContinuousPointMode) {
                    // Normal mod: çizim araçlarını temizle
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                }
                
                // Show completion notification
                const typeNames = {
                    'marker': 'Nokta',
                    'polyline': 'Çizgi', 
                    'polygon': 'Poligon',
                    'rectangle': 'Dikdörtgen',
                    'circle': 'Daire'
                };
                const typeName = typeNames[type] || type;
                
                // Stil ayarlarını uygula
                if (type === 'marker') {
                    // Nokta stilini uygula
                    const pointColor = document.getElementById('pointColor').value || "#ff0000";
                    const pointSize = parseInt(document.getElementById('pointSize').value || 8);
                    const pointOpacity = (document.getElementById('pointOpacity').value || 100) / 100;
                    const pointShape = document.getElementById('pointShape').value || "circle";
                    const pointStyleType = document.getElementById('pointStyleType').value || "custom";
                    
                    // Custom icon oluştur
                    let iconHtml = '';
                    const rgbaColor = hexToRgba(pointColor, pointOpacity);
                    
                    if (pointStyleType === 'custom') {
                        if (pointShape === 'circle') {
                            iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                        } else if (pointShape === 'square') {
                            iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                        } else if (pointShape === 'triangle') {
                            iconHtml = `<div style="width: 0; height: 0; border-left: ${pointSize/2}px solid transparent; border-right: ${pointSize/2}px solid transparent; border-bottom: ${pointSize}px solid ${rgbaColor};"></div>`;
                        } else if (pointShape === 'star') {
                            iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>`;
                        } else if (pointShape === 'diamond') {
                            iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 22,12 12,22 2,12"/></svg>`;
                        }
                    } else {
                        // İkon modunda varsayılan bir ikon kullan - bu daha sonra geliştirilebilir
                        iconHtml = `<div style="color: ${rgbaColor}; font-size: ${pointSize}px;">📍</div>`;
                    }
                    
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-div-icon',
                        iconSize: [pointSize, pointSize],
                        iconAnchor: [pointSize/2, pointSize/2]
                    });
                    
                    layer.setIcon(customIcon);
                    
                    // Stil bilgilerini sakla
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'point',
                        color: pointColor,
                        size: pointSize,
                        opacity: pointOpacity,
                        shape: pointShape,
                        styleType: pointStyleType
                    };
                    
                    layer.bindPopup(`<div style="color:${pointColor}"><strong>Nokta</strong><br>Şekil: ${pointShape}<br>Boyut: ${pointSize}px<br>Saydamlık: ${Math.round(pointOpacity * 100)}%</div>`);
                } else if (type === 'polyline') {
                    // Çizgi stilini uygula
                    const lineColor = document.getElementById('lineColor').value || "#ff7800";
                    const lineWidth = parseInt(document.getElementById('lineWidth').value || 3);
                    const lineOpacity = (document.getElementById('lineOpacity').value || 100) / 100;
                    const lineType = document.getElementById('lineType').value || "solid";
                    
                    const dashArray = calculateDashArray(lineType, lineWidth);
                    
                    layer.setStyle({
                        color: lineColor,
                        weight: lineWidth,
                        opacity: lineOpacity,
                        dashArray: dashArray
                    });
                    
                    // Stil bilgilerini sakla
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'line',
                        color: lineColor,
                        width: lineWidth,
                        opacity: lineOpacity,
                        lineType: lineType
                    };
                    
                    layer.bindPopup(`<div style="color:${lineColor}"><strong>Çizgi</strong><br>Kalınlık: ${lineWidth}px<br>Saydamlık: ${Math.round(lineOpacity * 100)}%<br>Tip: ${lineType}</div>`);
                } else if (type === 'polygon' || type === 'rectangle' || type === 'circle') {
                    // Poligon, dikdörtgen ve daire için aynı stil ayarlarını uygula
                    const fillColor = document.getElementById('fillColor').value || "#3388ff";
                    const fillOpacity = (document.getElementById('fillOpacity').value || 50) / 100;
                    const strokeColor = document.getElementById('strokeColor').value || "#000000";
                    const strokeWidth = parseInt(document.getElementById('strokeWidth').value || 1);
                    const strokeOpacity = (document.getElementById('strokeOpacity').value || 100) / 100;
                    const strokeType = document.getElementById('strokeType').value || "solid";
                    
                    const dashArray = calculateDashArray(strokeType, strokeWidth);
                    
                    layer.setStyle({
                        fillColor: fillColor,
                        fillOpacity: fillOpacity,
                        color: strokeColor,
                        weight: strokeWidth,
                        opacity: strokeOpacity,
                        dashArray: dashArray
                    });
                    
                    // Stil bilgilerini sakla - hepsini 'polygon' olarak kaydet
                    if (!layer.options) layer.options = {};
                    layer.options.styleInfo = {
                        type: 'polygon', // Hepsini polygon olarak kaydet
                        originalType: type, // Orijinal tipi de sakla
                        fillColor: fillColor,
                        fillOpacity: fillOpacity,
                        strokeColor: strokeColor,
                        strokeWidth: strokeWidth,
                        strokeOpacity: strokeOpacity,
                        strokeType: strokeType
                    };
                    
                    // Popup'ta orijinal tip adını göster
                    let shapeDisplayName = 'Poligon';
                    if (type === 'rectangle') shapeDisplayName = 'Dikdörtgen';
                    else if (type === 'circle') shapeDisplayName = 'Daire';
                    
                    layer.bindPopup(`<div style="color:${fillColor}"><strong>${shapeDisplayName}</strong><br>Dolgu Saydamlık: ${Math.round(fillOpacity * 100)}%<br>Kenar Kalınlık: ${strokeWidth}px<br>Kenar Saydamlık: ${Math.round(strokeOpacity * 100)}%</div>`);
                }
                
                // Katmanı çizim katmanına ekle
                drawnItems.addLayer(layer);
                

                
                // Çizimi seçili katmana ekle
                addFeatureToActiveLayer(type, layer, typeName);
                
                // Sürekli nokta çizim modu: nokta eklendikten sonra tekrar başlat
                if (isContinuousPointMode) {
                    setTimeout(() => {
                        console.log('Sürekli nokta modu: tekrar başlatılıyor...');
                        // Marker çizim modunu tekrar başlat
                        const markerHandler = window.drawControl._toolbars.draw._modes.marker;
                        if (markerHandler && markerHandler.handler) {
                            markerHandler.handler.enable();
                            showNotification('Nokta eklendi, sürekli mod devam ediyor... (ESC veya sağ tık ile durdurun)', 'info');
                        }
                    }, 100);
                }
                
                // Seçimi koru - çizim tamamlandıktan sonra da seçim kalsın
                if (window.backupSelectedLayer && window.backupSelectedGroup) {
                    // Son kez seçimi geri yükle
                    window.backupSelectedLayer.classList.add('selected-highlight', 'selected');
                    window.backupSelectedGroup.classList.add('selected');
                    activeLayerId = window.backupActiveLayerId;
                    activeGroupId = window.backupActiveGroupId;
                    console.log('Çizim tamamlandı, seçim korundu:', activeLayerId);
                    
                    // Backup'ları temizle (draw:drawstop'tan önce)
                    setTimeout(() => {
                        delete window.backupActiveLayerId;
                        delete window.backupActiveGroupId;
                        delete window.backupSelectedLayer;
                        delete window.backupSelectedGroup;
                        console.log('Çizim tamamlandı - backup\'lar temizlendi');
                    }, 50);
                }
            });
            
            // Event delegation ile katman seçimi - düzeltilmiş versiyon
            document.addEventListener('click', function(e) {
                // Katman butonlarına tıklandığında
                if (e.target.closest('.layer-action-btn')) {
                    e.stopPropagation();
                    // Buton işlevini çalıştır ama katman seçimini engelle
                    return;
                }
                
                // Checkbox'a tıklandığında sadece checkbox işlevi çalışsın
                if (e.target.closest('.layer-visibility')) {
                    e.stopPropagation();
                    return;
                }
                
                // Grup checkbox'ına tıklandığında sadece checkbox işlevi çalışsın
                if (e.target.closest('.group-visibility-checkbox')) {
                    e.stopPropagation();
                    return;
                }
                
                // Grup toggle alanına tıklandığında
                if (e.target.closest('.group-toggle-area')) {
                    e.stopPropagation();
                    return;
                }
                
                // Katman seçimi - seçilebilir alana tıklandığında
                const selectableArea = e.target.closest('.layer-selectable-area');
                if (selectableArea) {
                    e.stopPropagation();
                    const layerItem = selectableArea.closest('.layer-item');
                    if (layerItem) {
                        selectLayer(layerItem);
                    }
                    return;
                }
                
                // Grup seçimi - seçilebilir alana tıklandığında
                const groupSelectArea = e.target.closest('.group-select-area');
                if (groupSelectArea) {
                    e.stopPropagation();
                    selectGroup(groupSelectArea);
                    return;
                }
                
                // Başka bir yere tıklandığında seçimleri kaldır (ama çizim yaparken değil)
                if (!e.target.closest('.layer-panel') && !e.target.closest('.leaflet-container') && !isDrawingMode) {
                    clearAllSelections();
                }
            });
            
            // Harita yeniden boyutlandırma - daha uzun bir gecikme ile
            setTimeout(function() {
                map.invalidateSize(true);
            }, 500);
            
            // Pencere boyutu değiştiğinde haritayı yeniden boyutlandır
            window.addEventListener('resize', function() {
                map.invalidateSize(true);
            });

            // Lejant sembol boyutu display'ini başlat
            updateLegendSymbolSizeDisplay();
            
            // Sayfa yüklendiğinde grup sayılarını güncelle
            updateAllGroupCounts();
            
            // Grup görünürlük butonlarını güncelle
            updateAllGroupVisibilityButtons();
            
            // Katman stil modu göstergelerini güncelle
            updateAllLayerStyleModeIndicators();
            
            // Lejant sürükleme işlevselliğini başlat
            initLegendDragging();

        });
        
        // Katman seçici oluşturma
        function createLayerSelector() {
            // Çizim kontrol paneli oluştur
            var drawingControl = document.createElement('div');
            drawingControl.className = 'drawing-control';
            drawingControl.style.cssText = 'position: absolute; top: 10px; right: 50px; background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.3); z-index: 400; max-width: 250px; font-size: 12px;';
            
            // Başlık
            var title = document.createElement('h5');
            title.textContent = 'Çizim Ayarları';
            title.style.cssText = 'margin: 0 0 8px 0;';
            drawingControl.appendChild(title);
            
            // Açıklama
            var description = document.createElement('p');
            description.textContent = 'Çizimlerin ekleneceği katman grubunu seçin:';
            description.style.cssText = 'margin-bottom: 8px;';
            drawingControl.appendChild(description);
            
            // Seçici dropdown
            var selector = document.createElement('select');
            selector.id = 'layerGroupSelector';
            selector.style.cssText = 'width: 100%; padding: 5px; margin-bottom: 10px;';
            
            // Grupları ekle
            const groups = document.querySelectorAll('.layer-group');
            groups.forEach(group => {
                const groupName = group.querySelector('.group-name').textContent;
                var option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                if (groupName === activeLayerGroup) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            // Değişiklik olayını dinle
            selector.addEventListener('change', function() {
                activeLayerGroup = this.value;
            });
            
            drawingControl.appendChild(selector);
            
            // Harita container'ına ekle
            document.querySelector('.map-container').appendChild(drawingControl);
        }
        
        // =================================
        // 6. ENHANCED LAYER MANAGEMENT
        // =================================
        const LayerManager = {
            // Grup oluşturma modal'ını aç (enhanced)
            showCreateGroupModal() {
                return Utils.safeExecute(() => {
                    const groupName = prompt('Yeni grup adı:');
                    if (groupName && groupName.trim()) {
                        this.createGroup(groupName.trim());
                    }
                }, 'Group Modal Creation');
            },
            
            // Katman oluşturma modal'ını aç (enhanced)
            showCreateLayerModal() {
                return Utils.safeExecute(() => {
                    const layerName = prompt('Yeni katman adı:');
                    if (!layerName || !layerName.trim()) {
                        return;
                    }
                    
                    // Grup seçimi için basit prompt
                    const groups = Array.from(document.querySelectorAll('.layer-group')).map(group => {
                        return {
                            id: group.getAttribute('data-group-id'),
                            name: group.querySelector('.group-name').textContent
                        };
                    });
                    
                    if (groups.length === 0) {
                        showToast('Önce bir grup oluşturun!', 'error');
                        return;
                    }
                    
                    let targetGroupId = activeGroupId;
                    if (groups.length > 1) {
                        const groupList = groups.map((g, i) => `${i + 1}. ${g.name}`).join('\n');
                        const selection = prompt(`Hangi gruba eklensin?\n${groupList}\n\nNumara girin:`);
                        const index = parseInt(selection) - 1;
                        if (index >= 0 && index < groups.length) {
                            targetGroupId = groups[index].id;
                        } else {
                            targetGroupId = groups[0].id;
                        }
                    } else {
                        targetGroupId = groups[0].id;
                    }
                    
                    this.createLayer(layerName.trim(), targetGroupId);
                }, 'Layer Modal Creation');
            },

            createGroup(groupName) {
                return Utils.safeExecute(() => {
                    const validName = Utils.validateInput.layerName(groupName);
                    return createGroup(validName);
                }, 'Group Creation');
            },

            createLayer(layerName, targetGroupId) {
                return Utils.safeExecute(() => {
                    const validName = Utils.validateInput.layerName(layerName);
                    return createLayer(validName, targetGroupId);
                }, 'Layer Creation');
            }
        };

        // =================================
        // 7. ENHANCED STYLE MANAGEMENT
        // =================================
        const StyleManager = {
            applyStyle() {
                return Utils.safeExecute(() => {
                    return applyStyle();
                }, 'Style Application');
            },

            applyToLayer(layerElement, layerId, layerType) {
                return Utils.safeExecute(() => {
                    return applyStyleToLayer(layerElement, layerId, layerType);
                }, 'Layer Style Application');
            }
        };

        // =================================
        // 8. ENHANCED EVENT MANAGEMENT
        // =================================
        const EventManager = {
            setupDebouncedStyleUpdates() {
                const debouncedStyleUpdate = Utils.debounce(() => {
                    StyleManager.applyStyle();
                }, CONFIG.DEBOUNCE_DELAY);

                const styleInputs = [
                    'pointColor', 'pointSize', 'pointShape', 'pointOpacity',
                    'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                    'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType'
                ];

                styleInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', debouncedStyleUpdate);
                        input.addEventListener('change', debouncedStyleUpdate);
                    }
                });
            },

            setupThrottledCoordinateUpdates() {
                const throttledCoordUpdate = Utils.throttle((e) => {
                    updateCoordinateDisplay(e.latlng);
                }, CONFIG.THROTTLE_DELAY);

                if (map) {
                    map.on('mousemove', throttledCoordUpdate);
                }
            }
        };

        // =================================
        // 9. BACKWARD COMPATIBILITY WRAPPERS
        // =================================
        
        // Grup oluşturma modal'ını aç (basitleştirilmiş)
        function showCreateGroupModal() {
            return LayerManager.showCreateGroupModal();
        }
        
        // Katman oluşturma modal'ını aç (basitleştirilmiş)
        function showCreateLayerModal() {
            return LayerManager.showCreateLayerModal();
        }

        // Enhanced toast function
        function showToast(message, type = 'success') {
            return Utils.safeExecute(() => {
                const toast = document.getElementById('toast');
                if (!toast) return;
                
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, CONFIG.TOAST_DURATION);
            }, 'Toast Display');
        }

        // Enhanced functions with error handling
        function deleteLayer(button) {
            return Utils.safeExecute(() => {
                return LayerManager.deleteLayer ? LayerManager.deleteLayer(button) : originalDeleteLayer(button);
            }, 'Layer Deletion');
        }

        function applyStyle() {
            return Utils.safeExecute(() => {
                return StyleManager.applyStyle();
            }, 'Style Application');
        }

        // =================================
        // 10. INITIALIZATION & SETUP
        // =================================
        const CBSApp = {
            init() {
                try {
                    // Setup enhanced event management
                    EventManager.setupDebouncedStyleUpdates();
                    EventManager.setupThrottledCoordinateUpdates();
                    
                    // =================================
        // 14. PERFORMANCE OPTIMIZATIONS
        // =================================
        
        // Virtual scrolling for large layer lists
        const VirtualScroll = {
            itemHeight: 40,
            buffer: 5,
            renderVisibleOnly: true,
            
            init(container, items) {
                if (items.length < 50) return; // Only for large lists
                
                const viewport = container.querySelector('.layer-list');
                const scrollableHeight = items.length * this.itemHeight;
                viewport.style.height = scrollableHeight + 'px';
                
                const renderVisibleItems = Utils.throttle(() => {
                    const scrollTop = viewport.scrollTop;
                    const visibleStart = Math.floor(scrollTop / this.itemHeight);
                    const visibleEnd = Math.min(visibleStart + Math.ceil(viewport.clientHeight / this.itemHeight) + this.buffer, items.length);
                    
                    // Render only visible items
                    this.renderItems(viewport, items, visibleStart, visibleEnd);
                }, CONFIG.THROTTLE_DELAY);
                
                viewport.addEventListener('scroll', renderVisibleItems);
                renderVisibleItems();
            },
            
            renderItems(viewport, items, start, end) {
                // Implementation would go here for virtual scrolling
                // This is a placeholder for the concept
            }
        };
        
        // Debounced search and filter
        const LayerSearch = {
            debounceTimer: null,
            
            init() {
                const searchInput = document.getElementById('layerSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', this.debouncedSearch.bind(this));
                }
            },
            
            debouncedSearch: Utils.debounce(function(event) {
                const searchTerm = event.target.value.toLowerCase();
                this.filterLayers(searchTerm);
            }, 300),
            
            filterLayers(searchTerm) {
                const layerItems = document.querySelectorAll('.layer-item, .group-header');
                
                layerItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const shouldShow = searchTerm === '' || text.includes(searchTerm);
                    
                    if (shouldShow) {
                        item.style.display = '';
                        item.classList.remove('hidden-by-search');
                    } else {
                        item.style.display = 'none';
                        item.classList.add('hidden-by-search');
                    }
                });
            }
        };
        
        // Memory management
        const MemoryManager = {
            eventListeners: new Map(),
            timers: new Set(),
            
            addEventListener(element, event, handler, options = {}) {
                element.addEventListener(event, handler, options);
                
                if (!this.eventListeners.has(element)) {
                    this.eventListeners.set(element, []);
                }
                this.eventListeners.get(element).push({ event, handler, options });
            },
            
            removeAllEventListeners(element) {
                const listeners = this.eventListeners.get(element);
                if (listeners) {
                    listeners.forEach(({ event, handler, options }) => {
                        element.removeEventListener(event, handler, options);
                    });
                    this.eventListeners.delete(element);
                }
            },
            
            addTimer(timerId) {
                this.timers.add(timerId);
            },
            
            clearAllTimers() {
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                    clearInterval(timerId);
                });
                this.timers.clear();
            },
            
            cleanup() {
                this.eventListeners.forEach((listeners, element) => {
                    this.removeAllEventListeners(element);
                });
                this.clearAllTimers();
            }
        };
        
        // Geometry simplification for complex geometries
        const GeometryOptimizer = {
            simplifyOnZoomOut: true,
            levelOfDetail: true,
            maxFeatures: 1000,
            
            shouldSimplify(zoomLevel, featureCount) {
                return this.simplifyOnZoomOut && 
                       zoomLevel < 10 && 
                       featureCount > this.maxFeatures;
            },
            
            simplifyGeometry(geometry, tolerance = 0.001) {
                // Placeholder for geometry simplification
                // Would implement Douglas-Peucker or similar algorithm
                return geometry;
            }
        };
        
        // =================================
        // 15. UI ENHANCEMENT FUNCTIONS
        // =================================
        
        // Enhanced drawing functions - SECOND IMPLEMENTATION
        function startDrawing(type) {
            try {
                // Sürekli nokta çizim modu flag'ini set et
                if (type === 'marker') {
                    window.continuousPointMode = true;
                    console.log('Sürekli nokta çizim modu etkinleştirildi (enhanced function)');
                } else {
                    window.continuousPointMode = false;
                }
                
                // Clear any active tools
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                // Activate current tool
                const toolBtn = document.getElementById(type + 'Btn') || 
                               document.querySelector(`[onclick*="${type}"]`);
                if (toolBtn) {
                    toolBtn.classList.add('active');
                }
                
                // Check if there's a selected layer - daha esnek kontrol
                if (!window.activeLayerId) {
                    const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                    if (selectedLayer) {
                        window.activeLayerId = selectedLayer.getAttribute('data-layer-id');
                        activeLayerId = window.activeLayerId; // Sync local variable
                    } else {
                        // Varsayılan grup oluşturma devre dışı - artık localStorage sistemini kullanıyoruz
                        const hasLayers = document.querySelectorAll('.layer-item').length > 0;
                        if (!hasLayers) {
                            // // Otomatik grup ve katman oluştur
                            // createDefaultGroup(); // Devre dışı
                            showNotification('Çizim için önce bir grup ve katman oluşturun', 'warning');
                        } else {
                            showNotification('Çizim için bir katman seçin veya yeni katman oluşturun', 'warning');
                            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                            return;
                        }
                    }
                }
                
                // Double check that we have a valid layer
                const targetLayer = document.querySelector(`[data-layer-id="${window.activeLayerId}"]`);
                if (!targetLayer) {
                    showNotification('Seçili katman bulunamadı! Lütfen tekrar bir katman seçin.', 'error');
                    window.activeLayerId = null;
                    activeLayerId = null;
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    return;
                }
                
                // Store the active layer ID for drawing
                window.drawingActiveLayerId = window.activeLayerId;
                
                // Map the type to Leaflet Draw actions
                const drawHandlers = {
                    'marker': window.drawControl._toolbars.draw._modes.marker,
                    'polyline': window.drawControl._toolbars.draw._modes.polyline,
                    'polygon': window.drawControl._toolbars.draw._modes.polygon,
                    'rectangle': window.drawControl._toolbars.draw._modes.rectangle,
                    'circle': window.drawControl._toolbars.draw._modes.circle
                };
                
                // Get the appropriate handler
                const handler = drawHandlers[type];
                if (handler && handler.handler) {
                    // Stop any currently active drawing
                    Object.values(drawHandlers).forEach(mode => {
                        if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                            mode.handler.disable();
                        }
                    });
                    
                    // Ensure map interactions are enabled for polygon double-click finishing
                    if (type === 'polygon') {
                        console.log('Poligon çizimi - harita interaksiyonları kontrol ediliyor...');
                        // Make sure double-click is enabled for polygon finishing
                        if (map.doubleClickZoom && !map.doubleClickZoom.enabled()) {
                            map.doubleClickZoom.enable();
                            console.log('Double-click zoom etkinleştirildi');
                        }
                    }
                    
                    // Start the new drawing mode
                    handler.handler.enable();
                    
                    // Add visual feedback
                    const iconData = ICON_LIBRARY[type] || { name: type };
                    const layerName = targetLayer.querySelector('.layer-name')?.textContent || window.drawingActiveLayerId;
                    
                    if (type === 'marker') {
                        showNotification(`${iconData.name} sürekli ekleme modu - "${layerName}" katmanına çizilecek (ESC veya sağ tık ile durdurun)`, 'info');
                    } else {
                        showNotification(`${iconData.name} çizim modu aktif - "${layerName}" katmanına çizilecek${type === 'polygon' ? ' (Çift tıklayarak bitirebilirsiniz)' : ''}`, 'info');
                    }
                    
                    console.log(`Drawing started: ${type} on layer: ${window.drawingActiveLayerId}`);
                } else {
                    throw new Error(`Drawing handler not found for type: ${type}`);
                }
                
            } catch (error) {
                console.error('Drawing start error:', error);
                showNotification(`Çizim başlatılamadı: ${error.message}`, 'error');
                
                // Reset tool button
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            }
        }
        
        // Enhanced edit mode toggle
        function toggleEditMode() {
            try {
                const editBtn = document.getElementById('editBtn');
                const isActive = editBtn.classList.contains('active');
                
                if (isActive) {
                    // Disable edit mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.edit.handler) {
                        window.drawControl._toolbars.edit._modes.edit.handler.disable();
                    }
                    editBtn.classList.remove('active');
                    showNotification('Düzenleme modu kapatıldı', 'info');
                } else {
                    // Clear other active tools
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Stop any drawing modes
                    if (window.drawControl && window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Enable edit mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.edit.handler) {
                        window.drawControl._toolbars.edit._modes.edit.handler.enable();
                        editBtn.classList.add('active');
                        showNotification('Düzenleme modu aktif - çizimleri sürükleyerek düzenleyin', 'info');
                    } else {
                        throw new Error('Edit handler not found');
                    }
                }
            } catch (error) {
                console.error('Edit mode toggle error:', error);
                showNotification('Düzenleme modu değiştirilemedi', 'error');
            }
        }
        
        // Enhanced delete mode toggle
        function toggleDeleteMode() {
            try {
                const deleteBtn = document.getElementById('deleteBtn');
                const isActive = deleteBtn.classList.contains('active');
                
                if (isActive) {
                    // Disable delete mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.remove.handler) {
                        window.drawControl._toolbars.edit._modes.remove.handler.disable();
                    }
                    deleteBtn.classList.remove('active');
                    showNotification('Silme modu kapatıldı', 'info');
                } else {
                    // Clear other active tools
                    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Stop any drawing modes
                    if (window.drawControl && window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Enable delete mode
                    if (window.drawControl && window.drawControl._toolbars.edit._modes.remove.handler) {
                        window.drawControl._toolbars.edit._modes.remove.handler.enable();
                        deleteBtn.classList.add('active');
                        showNotification('Silme modu aktif - çizimlere tıklayarak silin', 'warning');
                    } else {
                        throw new Error('Remove handler not found');
                    }
                }
            } catch (error) {
                console.error('Delete mode toggle error:', error);
                showNotification('Silme modu değiştirilemedi', 'error');
            }
        }
        
        // Zoom to extent function
        function zoomToExtent() {
            if (window.map && window.allLayersGroup) {
                try {
                    const bounds = window.allLayersGroup.getBounds();
                    if (bounds.isValid()) {
                        window.map.fitBounds(bounds, { padding: [20, 20] });
                        showNotification('Tüm katmanlara zoom yapıldı', 'success');
                    } else {
                        showNotification('Zoom yapılacak katman bulunamadı', 'warning');
                    }
                } catch (error) {
                    console.error('Zoom to extent error:', error);
                    showNotification('Zoom işleminde hata oluştu', 'error');
                }
            }
        }
        
        // Fullscreen toggle
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenBtn.classList.add('active');
                    showNotification('Tam ekran modu aktif', 'info');
                }).catch(() => {
                    showNotification('Tam ekran modu desteklenmiyor', 'error');
                });
            } else {
                document.exitFullscreen().then(() => {
                    fullscreenBtn.classList.remove('active');
                    showNotification('Tam ekran modundan çıkıldı', 'info');
                });
            }
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
            const toast = document.getElementById('toast') || createToastElement();
            
            // Set content and style
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            // Auto hide
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function createToastElement() {
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            document.body.appendChild(toast);
            return toast;
        }
        
        // Update selected info panel
        function updateSelectedInfo() {
            const infoPanel = document.getElementById('selectedInfoPanel');
            if (!infoPanel) return;
            
            const selectedLayer = document.querySelector('.layer-item.selected-highlight');
            const selectedGroup = document.querySelector('.group-header.selected');
            
            // Update status bar active layer info
            updateActiveLayerDisplay();
            
            if (selectedLayer || selectedGroup) {
                let infoHtml = '';
                
                if (selectedLayer) {
                    const layerName = selectedLayer.querySelector('.layer-name').textContent;
                    const layerId = selectedLayer.getAttribute('data-layer-id');
                    
                    infoHtml += `
                        <div class="selected-layer-info">
                            <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #a91e2c; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 12px;">📋</span>
                                Seçili Katman: ${layerName} (${layerId})
                                <button onclick="clearLayerSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                            </div>
                        </div>
                    `;
                }
                
                if (selectedGroup) {
                    const groupName = selectedGroup.querySelector('.group-name').textContent;
                    const groupId = selectedGroup.closest('.layer-group').getAttribute('data-group-id');
                    
                    infoHtml += `
                        <div class="selected-group-info">
                            <div style="padding: 6px 8px; font-weight: 600; font-size: 11px; color: #721c24; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 12px;">📁</span>
                                Seçili Grup: ${groupName} (${groupId})
                                <button onclick="clearGroupSelection()" style="background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; margin-left: auto;" title="Seçimi Temizle">×</button>
                            </div>
                        </div>
                    `;
                }
                
                infoPanel.innerHTML = infoHtml;
                infoPanel.style.display = 'block';
            } else {
                infoPanel.style.display = 'none';
            }
        }

        // Update active layer display in status bar
        function updateActiveLayerDisplay() {
            const activeLayerInfo = document.getElementById('activeLayerInfo');
            if (!activeLayerInfo) return;
            
            if (window.activeLayerId) {
                const layerElement = document.querySelector(`[data-layer-id="${window.activeLayerId}"]`);
                if (layerElement) {
                    const layerName = layerElement.querySelector('.layer-name')?.textContent || window.activeLayerId;
                    activeLayerInfo.textContent = layerName;
                    activeLayerInfo.style.color = 'var(--success-color)';
                } else {
                    activeLayerInfo.textContent = 'Hatalı Katman';
                    activeLayerInfo.style.color = 'var(--danger-color)';
                }
            } else {
                activeLayerInfo.textContent = 'Seçili Değil';
                activeLayerInfo.style.color = 'var(--text-muted)';
            }
        }

        // Initialize UI enhancements
        function initializeUIEnhancements() {
            // Initialize search
            LayerSearch.init();
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Add accessibility attributes
            addAccessibilityAttributes();
            
            // Add skip link
            addSkipLink();
            
            // Initialize selected info panel
            updateSelectedInfo();
            
            console.log('✅ UI Enhancements initialized');
        }
        
        function handleKeyboardNavigation(event) {
            // ESC key - close modals and cancel drawing
            if (event.key === 'Escape') {
                // Close modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                
                // Cancel measurement tools first (highest priority)
                if (measurementTools && measurementTools.isActive) {
                    console.log('ESC - Ölçüm aracı durduruluyor...');
                    measurementTools.stopMeasurement();
                    showNotification('Ölçüm iptal edildi', 'info');
                    return; // ESC ile ölçüm iptal edildiğinde diğer işlemleri yapma
                }
                
                // Cancel any active drawing/editing modes
                if (window.drawControl) {
                    // Cancel drawing modes
                    if (window.drawControl._toolbars.draw) {
                        Object.values(window.drawControl._toolbars.draw._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                    
                    // Cancel editing modes
                    if (window.drawControl._toolbars.edit) {
                        Object.values(window.drawControl._toolbars.edit._modes).forEach(mode => {
                            if (mode && mode.handler && mode.handler.enabled && mode.handler.enabled()) {
                                mode.handler.disable();
                            }
                        });
                    }
                }
                
                // Clear active tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                
                showNotification('İşlem iptal edildi', 'info');
            }
            
            // Enter key on focused elements
            if (event.key === 'Enter') {
                const focused = document.activeElement;
                if (focused.classList.contains('layer-item') || focused.classList.contains('group-header')) {
                    focused.click();
                }
            }
        }
        
        function addAccessibilityAttributes() {
            // Add ARIA labels and roles
            const layerPanel = document.querySelector('.layer-panel');
            if (layerPanel) {
                layerPanel.setAttribute('role', 'navigation');
                layerPanel.setAttribute('aria-label', 'Katman yönetimi paneli');
            }
            
            const toolContainer = document.querySelector('.map-tools-container');
            if (toolContainer) {
                toolContainer.setAttribute('role', 'toolbar');
                toolContainer.setAttribute('aria-label', 'Harita araçları');
            }
            
            // Make tool buttons focusable
            document.querySelectorAll('.tool-btn').forEach((btn, index) => {
                btn.setAttribute('tabindex', '0');
                btn.setAttribute('role', 'button');
            });
            
            // Make layer items focusable
            document.querySelectorAll('.layer-item, .group-header').forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'treeitem');
            });
        }
        
        function addSkipLink() {
            const skipLink = document.createElement('a');
            skipLink.href = '#map';
            skipLink.className = 'skip-link';
            skipLink.textContent = 'Haritaya atla';
            document.body.insertBefore(skipLink, document.body.firstChild);
        }
        
        // Window cleanup
        window.addEventListener('beforeunload', () => {
            MemoryManager.cleanup();
        });
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initializeUIEnhancements();
        });
        
        console.log('✅ CBS System enhanced with modern JavaScript patterns and UI improvements v3.0');
                } catch (error) {
                    ErrorManager.handle(error, 'System Enhancement');
                }
            }
        };

        // Initialize enhanced features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                CBSApp.init();
            }, 1000); // Wait for original initialization
        });

        // Enhanced global functions for backwards compatibility
        window.LayerManager = LayerManager;
        window.StyleManager = StyleManager;
        window.EventManager = EventManager;
        window.Utils = Utils;
        window.ErrorManager = ErrorManager;
        window.AppState = AppState;
        window.CBSApp = CBSApp;

        // Continue with original code below...
        
        // Modal'ı kapat
        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createNameInput').value = '';
        }
        
        // Oluşturma işlemini onayla
        function confirmCreate() {
            const name = document.getElementById('createNameInput').value.trim();
            const type = document.getElementById('createModal').dataset.type;
            
            if (!name) {
                showToast('Ad boş bırakılamaz!', 'error');
                return;
            }
            
            if (type === 'group') {
                createGroup(name);
            } else if (type === 'layer') {
                const targetGroupId = document.getElementById('targetGroupSelect').value;
                createLayer(name, targetGroupId);
            }
            
            closeCreateModal();
        }
        
        // Grup oluştur (yeni modal ile)
        function createGroup(groupName) {
            // Grup oluştur
            const groupContainer = document.querySelector('#layerList');
            
            const layerGroup = document.createElement('div');
            layerGroup.className = 'layer-group';
            
            const groupId = 'group-' + Date.now();
            layerGroup.setAttribute('data-group-id', groupId);
            
            layerGroup.innerHTML = `
                <div class="group-header">
                    <div class="group-visibility-area" title="Tüm katmanları aç/kapat">
                        <input type="checkbox" class="group-visibility-checkbox" checked onclick="toggleAllLayersInGroup(event, this)">
                    </div>
                    <div class="group-select-area" onclick="selectGroup(this)">
                        <span class="group-name">${groupName}</span>
                        <span class="group-count">0</span>
                    </div>
                    <div class="group-toggle-area" onclick="toggleGroup(this)">
                        <span class="group-icon">▼</span>
                    </div>
                </div>
                <div class="group-items">
                    <!-- Katmanlar buraya eklenecek -->
                </div>
            `;
            
            groupContainer.appendChild(layerGroup);
            
            // Yeni oluşturulan grubu seç
            selectGroup(layerGroup.querySelector('.group-select-area'));
            
            // Toast bildirimi göster
            showToast(`"${groupName}" grubu oluşturuldu`, 'success');
            
            // Verileri otomatik kaydet
            if (window.DataPersistence) {
                DataPersistence.autoSave();
            }
        }
        
        // Grup seçme (sadece seçim, açma/kapama değil)
        function selectGroup(selectArea) {
            // event.stopPropagation(); // Checkbox tıklamasını engelle
            
            // Tüm grup seçimlerini kaldır
            document.querySelectorAll('.group-header').forEach(h => {
                h.classList.remove('selected');
            });
            
            // Katman seçimini kaldır
            clearLayerSelection();
            
            // Bu grubu seç
            const header = selectArea.closest('.group-header');
            header.classList.add('selected');
            
            // Aktif grup ID'sini güncelle
            activeGroupId = header.closest('.layer-group').getAttribute('data-group-id');
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }
        
        // Seçili grup bilgisini güncelle - kaldırıldı
        
        // Grup seçimini temizle
        function clearGroupSelection() {
            // Çizim modundayken grup seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, grup seçimi korunuyor - clearGroupSelection iptal edildi');
                return;
            }
            
            console.log('clearGroupSelection çalışıyor');
            // Tüm grup seçimlerini kaldır
            document.querySelectorAll('.group-header').forEach(h => {
                h.classList.remove('selected');
            });
            
            // Aktif grubu temizle
            activeGroupId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }
        
        // Katman oluştur (yeni modal ile)
        function createLayer(layerName, targetGroupId) {
            
            // Katmanı ekleyeceğimiz grubu belirle
            let targetGroup = null;
            
            // Modal'dan gelen targetGroupId'yi kullan
            if (targetGroupId) {
                targetGroup = document.querySelector(`[data-group-id="${targetGroupId}"]`);
            }
            
            // Hedef grup bulunamazsa hata ver
            if (!targetGroup) {
                showToast('Hedef grup bulunamadı!', 'error');
                return;
            }
            
            // Katman oluştur
            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            layerItem.draggable = true;
            
            // Katman ID'si oluştur
            const layerId = 'layer-' + Date.now();
            layerItem.setAttribute('data-layer-id', layerId);
            
            // Katman içeriğini oluştur
            layerItem.innerHTML = `
                <input type="checkbox" class="layer-visibility" checked>
                <div class="layer-selectable-area">
                    <div class="layer-icons">
                        <div class="layer-icon inactive" title="Nokta verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="8"/>
                            </svg>
                        </div>
                        <div class="layer-icon inactive" title="Çizgi verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M2 8 L8 8 L12 16 L16 16 L22 8" fill="none" stroke="currentColor" stroke-width="3"/>
                            </svg>
                        </div>
                        <div class="layer-icon inactive" title="Poligon verisi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor" stroke="#000000" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <span class="layer-name">${layerName}</span>
                    <span class="layer-style-mode-indicator default-mode" data-layer-id="${layerId}" title="Varsayılan Kurumsal Ayarlar" onclick="toggleLayerStyleMode('${layerId}', event)">
                        🏢
                </span>
                </div>
                <div class="layer-actions">
                    <button class="layer-action-btn" title="Zoom" onclick="zoomToLayer(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Detaylar" onclick="openLayerDetails(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13,7H11V5H13M13,17H11V9H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                    </button>
                    <button class="layer-action-btn" title="Sil" onclick="deleteLayer(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Katmanı gruba ekle
            const groupItems = targetGroup.querySelector('.group-items');
            groupItems.appendChild(layerItem);
            
            // Grup sayısını güncelle
            updateGroupLayerCount(targetGroup);
            
            // Drag and drop işlevselliğini ekle (sadece düzenleme modundaysa)
            setupDragAndDrop(layerItem);
            

            
            // Katman seçme işlemini ekle - event delegation ile hallediliyor artık
            
            // Bu katmana ait çizim listesini oluştur
            layerFeatures[layerId] = [];
            
            // Yeni oluşturulan katmanı seç
            selectLayer(layerItem);
            
            // Toast bildirimi göster
            showToast(`"${layerName}" katmanı oluşturuldu`, 'success');
            
            // Verileri otomatik kaydet
            if (window.DataPersistence) {
                DataPersistence.autoSave();
            }
        }
        
        // Katman seçme
        function selectLayer(layerItem) {
            console.log('selectLayer çağrıldı:', layerItem);
            
            // Tüm seçimleri kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Bu katmanı seç (hem görsel hem de mantıksal seçim için)
            layerItem.classList.add('selected-highlight', 'selected');
            
            // Aktif katmanı güncelle
            activeLayerId = layerItem.getAttribute('data-layer-id');
            window.activeLayerId = activeLayerId; // Global erişim için güncelle
            console.log(`Katman seçildi: ${activeLayerId}`);
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
            
            // Katmanın grubunu da otomatik seç
            const parentGroup = layerItem.closest('.layer-group');
            if (parentGroup) {
                // Tüm grup seçimlerini kaldır
                document.querySelectorAll('.group-header').forEach(h => {
                    h.classList.remove('selected');
                });
                
                // Bu grubu seç
                const groupHeader = parentGroup.querySelector('.group-header');
                groupHeader.classList.add('selected');
                activeGroupId = parentGroup.getAttribute('data-group-id');
                console.log(`Grup da seçildi: ${activeGroupId}`);
            }
        }
        
        // Katman seçimini temizle
        function clearLayerSelection() {
            // Çizim modundayken katman seçimini temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, katman seçimi korunuyor - clearLayerSelection iptal edildi');
                return;
            }
            
            console.log('clearLayerSelection çalışıyor');
            // Tüm seçimleri kaldır
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('selected-highlight', 'selected');
            });
            
            // Aktif katmanı temizle
            activeLayerId = null;
            window.activeLayerId = null;
            
            // Seçili bilgi panelini güncelle
            updateSelectedInfo();
        }
        
        // Tüm seçimleri temizle
        function clearAllSelections() {
            // Çizim modundayken seçimleri temizleme
            if (isDrawingMode) {
                console.log('Çizim modu aktif, seçimler korunuyor - clearAllSelections iptal edildi');
                return;
            }
            console.log('clearAllSelections çalışıyor');
            clearLayerSelection();
            clearGroupSelection();
        }
        
        // Aktif katmanı al
        function getActiveLayer() {
            if (!activeLayerId) {
                console.log('getActiveLayer: activeLayerId yok');
                return null;
            }
            
            const layerElement = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
            if (!layerElement) {
                console.log('getActiveLayer: katman elementi bulunamadı:', activeLayerId);
                return null;
            }
            
            // Katmanın seçili olup olmadığını kontrol et
            const isSelected = layerElement.classList.contains('selected-highlight');
            console.log('getActiveLayer:', {
                layerId: activeLayerId,
                element: layerElement,
                isSelected: isSelected
            });
            
            return isSelected ? layerElement : null;
        }
        

        
        // Grup katman sayısını güncelle
        function updateGroupLayerCount(groupElement) {
            const groupItems = groupElement.querySelector('.group-items');
            const count = groupItems.querySelectorAll('.layer-item').length;
            const countElement = groupElement.querySelector('.group-count');
            countElement.textContent = count;
            
            // Grup görünürlük butonunu da güncelle
            updateGroupVisibilityButton(groupElement);
        }
        
        // Tüm grup sayılarını güncelle
        function updateAllGroupCounts() {
            document.querySelectorAll('.layer-group').forEach(group => {
                updateGroupLayerCount(group);
            });
        }
        
        // Tüm grup görünürlük butonlarını güncelle
        function updateAllGroupVisibilityButtons() {
            document.querySelectorAll('.layer-group').forEach(group => {
                updateGroupVisibilityButton(group);
            });
        }
        
        // Tek grup görünürlük checkbox'ını güncelle
        function updateGroupVisibilityButton(group) {
            const layerCheckboxes = group.querySelectorAll('.layer-visibility');
            const visibilityCheckbox = group.querySelector('.group-visibility-checkbox');
            
            if (visibilityCheckbox && layerCheckboxes.length > 0) {
                const anyVisible = Array.from(layerCheckboxes).some(cb => cb.checked);
                visibilityCheckbox.checked = anyVisible;
            }
        }
        
        // Katman detaylarını açma
        function openLayerDetails(button) {
            console.log('openLayerDetails fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem.getAttribute('data-layer-id');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            // Modal başlığını güncelle
            document.getElementById('layerDetailName').textContent = layerName;
            
            // Çizim listesini temizle
            const featuresContainer = document.getElementById('featuresContainer');
            featuresContainer.innerHTML = '';
            
            // Katmana ait çizimleri liste
            if (layerFeatures[layerId] && layerFeatures[layerId].length > 0) {
                layerFeatures[layerId].forEach((feature, index) => {
                    const featureRow = document.createElement('div');
                    featureRow.className = 'feature-row';
                    featureRow.setAttribute('data-feature-id', feature.id);
                    
                    let iconType = '';
                    let featureTypeName = '';
                    
                    if (feature.type === 'point') {
                        iconType = 'icon-point';
                        featureTypeName = 'Nokta';
                    } else if (feature.type === 'line') {
                        iconType = 'icon-line';
                        featureTypeName = 'Çizgi';
                    } else if (feature.type === 'polygon') {
                        iconType = 'icon-polygon';
                        featureTypeName = 'Poligon';
                    }
                    
                    featureRow.innerHTML = `
                        <div class="feature-icon layer-icon ${iconType}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                ${feature.type === 'point' ? '<circle cx="12" cy="12" r="6"/>' : 
                                  feature.type === 'line' ? '<path d="M2 8L8 8L12 16L16 16L22 8" fill="none" stroke="currentColor" stroke-width="2"/>' : 
                                  '<polygon points="12,2 2,10 5,21 19,21 22,10" fill="currentColor"/>'}
                            </svg>
                        </div>
                        <div class="feature-name">${featureTypeName} ${index + 1}</div>
                        <div class="feature-actions">
                            <button class="layer-action-btn" title="Stil Ayarları" onclick="openStyleModal('${feature.type}', '${feature.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                </svg>
                            </button>
                            <button class="layer-action-btn" title="Zoom" onclick="zoomToFeature('${feature.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5,14H20.5L19,15.5L21.5,18L20,19.5L17.5,17L16,18.5V13.5H15.5M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20,19.29L18.71,20.58L13.15,15C12,15.83 10.61,16.36 9.5,16.36A6.5,6.5 0 0,1 3,9.86A6.5,6.5 0 0,1 9.5,3.36V3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                </svg>
                            </button>
                            <button class="layer-action-btn" title="Sil" onclick="deleteFeature('${feature.id}', '${layerId}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    featuresContainer.appendChild(featureRow);
                });
            } else {
                featuresContainer.innerHTML = '<p>Bu katmanda henüz çizim bulunmuyor.</p>';
            }
            
            // Modal'ı açılan katmanı belirle
            const modal = document.getElementById('layerDetailsModal');
            modal.setAttribute('data-layer-id', layerId);
            
            // Modal'ı aç
            modal.style.display = 'block';
        }
        
        // Katman detayları modal'ını kapatma
        function closeLayerDetailsModal() {
            document.getElementById('layerDetailsModal').style.display = 'none';
        }
        
        // Yeni bir çizim ekle
        function addFeatureToLayer() {
            const modal = document.getElementById('layerDetailsModal');
            const layerId = modal.getAttribute('data-layer-id');
            
            // Modal'ı kapat
            closeLayerDetailsModal();
            
            // Bu katmanı aktif yap
            activeLayerId = layerId;
            
            // Katmanı vurgula
            const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
            selectLayer(layerItem);
        }
        
        // Çizimi aktif katmana ekle
        function addFeatureToActiveLayer(type, layer, typeName) {
            console.log(`addFeatureToActiveLayer çağrıldı: type=${type}, mevcut activeLayerId=${activeLayerId}`);
            
            // TypeName fallback
            if (!typeName) {
                const typeNames = {
                    'marker': 'Nokta',
                    'polyline': 'Çizgi', 
                    'polygon': 'Poligon',
                    'rectangle': 'Dikdörtgen',
                    'circle': 'Daire'
                };
                typeName = typeNames[type] || type;
            }
            
            // Çizim sırasında kaydedilen aktif katman ID'sini kullan
            if (window.drawingActiveLayerId) {
                activeLayerId = window.drawingActiveLayerId;
                console.log(`Çizim için kaydedilen aktif katman kullanılıyor: ${activeLayerId}`);
                
                // Kaydedilen ID'yi temizle
                delete window.drawingActiveLayerId;
            }
            
            // Eğer hala aktif katman yoksa veya seçili katman görsel olarak seçili değilse
            if (!activeLayerId || !document.querySelector('.layer-item.selected-highlight')) {
                console.log('Aktif katman yok veya seçim kaybedilmiş, son seçili katmanı geri yüklüyor...');
                
                // Önce son seçili katmanı bulmaya çalış
                const selectedLayer = document.querySelector('.layer-item.selected-highlight');
                if (selectedLayer) {
                    activeLayerId = selectedLayer.getAttribute('data-layer-id');
                    console.log(`Seçili katman bulundu: ${activeLayerId}`);
                } else {
                    // Hiç seçili katman yoksa ilk katmanı seç
                    const firstLayer = document.querySelector('.layer-item[data-layer-id]');
                    if (firstLayer) {
                        selectLayer(firstLayer);
                        console.log(`İlk katman seçildi: ${activeLayerId}`);
                    } else {
                        // Hiç katman yoksa yeni bir katman oluştur
                        console.log('Hiç katman yok, yeni katman oluşturuluyor...');
                        createLayer('Yeni Katman', 'group-1');
                        const newLayer = document.querySelector('.layer-item[data-layer-id]:last-child');
                        if (newLayer) {
                            selectLayer(newLayer);
                            console.log(`Yeni katman oluşturuldu ve seçildi: ${activeLayerId}`);
                        }
                    }
                }
            }
            
            if (!layerFeatures[activeLayerId]) {
                layerFeatures[activeLayerId] = [];
            }
            
            console.log(`Çizim aktif katmana ekleniyor: type=${type}, katman=${activeLayerId}`);
            
            let iconType;
            
            // Katman tipine göre ayarlar - dikdörtgen ve daire de poligon olarak işle
            if (type === 'marker') {
                iconType = 'point';
            } else if (type === 'polyline') {
                iconType = 'line';
            } else if (type === 'polygon' || type === 'rectangle' || type === 'circle') {
                iconType = 'polygon';
            }
            
            // Çizim için benzersiz ID oluştur
            const featureId = 'feature-' + Date.now();
            
            // Çizimi katmana ekle
            layerFeatures[activeLayerId].push({
                id: featureId,
                type: iconType,
                layer: layer
            });
            
            // Çizimi referans listesine ekle
            drawnLayers.push({
                id: featureId,
                layer: layer,
                type: iconType,
                layerId: activeLayerId
            });
            
            console.log(`Çizim eklendi: id=${featureId}, type=${iconType}, katman=${activeLayerId}`);
            
            // Katman ikonlarını güncelle
            updateLayerIcons(activeLayerId);
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
            
            // Başarı mesajı göster
            const layerName = document.querySelector(`[data-layer-id="${activeLayerId}"] .layer-name`).textContent;
            showToast(`${typeName} "${layerName}" katmanına başarıyla eklendi`, 'success');
            
            // Yeni çizim eklendiğinde stil modu göstergesini güncelle (custom moda geç)
            updateLayerStyleModeIndicator(activeLayerId, 'custom');
            
            return featureId; // Oluşturulan ID'yi döndür
        }
        
        // Katman ikonlarını güncelle
        function updateLayerIcons(layerId) {
            const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
            if (!layerItem) return;
            
            const features = layerFeatures[layerId] || [];
            
            // Her bir ikon tipini kontrol et
            const hasPoint = features.some(f => f.type === 'point');
            const hasLine = features.some(f => f.type === 'line');
            const hasPolygon = features.some(f => f.type === 'polygon');
            
            // İkonları güncelle
            const pointIcon = layerItem.querySelector('.layer-icon:nth-child(1)');
            const lineIcon = layerItem.querySelector('.layer-icon:nth-child(2)');
            const polygonIcon = layerItem.querySelector('.layer-icon:nth-child(3)');
            
            if (hasPoint) {
                pointIcon.classList.remove('inactive');
                pointIcon.classList.add('active', 'icon-point');
            } else {
                pointIcon.classList.remove('active', 'icon-point');
                pointIcon.classList.add('inactive');
            }
            
            if (hasLine) {
                lineIcon.classList.remove('inactive');
                lineIcon.classList.add('active', 'icon-line');
            } else {
                lineIcon.classList.remove('active', 'icon-line');
                lineIcon.classList.add('inactive');
            }
            
            if (hasPolygon) {
                polygonIcon.classList.remove('inactive');
                polygonIcon.classList.add('active', 'icon-polygon');
            } else {
                polygonIcon.classList.remove('active', 'icon-polygon');
                polygonIcon.classList.add('inactive');
            }
        }
        
        // Çizimi silme
        function deleteFeature(featureId, layerId) {
            if (confirm('Bu çizimi silmek istediğinizden emin misiniz?')) {
                // Çizimi referans listesinden bul ve sil
                const featureIndex = drawnLayers.findIndex(l => l.id === featureId);
                if (featureIndex !== -1) {
                    // Haritadan kaldır
                    drawnItems.removeLayer(drawnLayers[featureIndex].layer);
                    // Listeden kaldır
                    drawnLayers.splice(featureIndex, 1);
                }
                
                // Katmandan kaldır
                if (layerFeatures[layerId]) {
                    layerFeatures[layerId] = layerFeatures[layerId].filter(f => f.id !== featureId);
                    
                    // Katman ikonlarını güncelle
                    updateLayerIcons(layerId);
                    
                    // Lejant açıksa güncelle
                    if (legendVisible) {
                        updateLegendContent();
                    }
                }
                
                // Detay modalını güncelle
                openLayerDetails(document.querySelector(`[data-layer-id="${layerId}"]`).querySelector('.layer-action-btn[title="Ayarlar"]'));
            }
        }
        
        // Çizime zoom yap
        function zoomToFeature(featureId) {
            const layerInfo = drawnLayers.find(l => l.id === featureId);
            if (layerInfo) {
                const layer = layerInfo.layer;
                // Poligon veya çizgi ise sınırlarına zoom
                if (layer.getBounds) {
                    map.fitBounds(layer.getBounds());
                } 
                // Nokta ise konumuna zoom
                else if (layer.getLatLng) {
                    map.setView(layer.getLatLng(), 15);
                }
            }
        }
        
        // Katmana zoom yap - tüm çizimlere birden
        function zoomToLayer(button) {
            console.log('zoomToLayer fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerId = layerItem.getAttribute('data-layer-id');
            
            if (!layerFeatures[layerId] || layerFeatures[layerId].length === 0) {
                return;
            }
            
            // Tüm çizimleri içeren sınırları hesapla
            const bounds = L.latLngBounds([]);
            
            layerFeatures[layerId].forEach(feature => {
                const layer = feature.layer;
                
                if (layer.getBounds) {
                    // Poligon veya çizgi
                    bounds.extend(layer.getBounds());
                } else if (layer.getLatLng) {
                    // Nokta
                    bounds.extend(layer.getLatLng());
                }
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds);
            } else {
                console.log('Zoom yapılacak geçerli sınır bulunamadı');
            }
        }
        
        // Katman görünürlüğü değiştirme
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('layer-visibility')) {
                const layerItem = e.target.closest('.layer-item');
                const layerId = layerItem.getAttribute('data-layer-id');
                const isVisible = e.target.checked;
                
                toggleLayerFeatures(layerId, isVisible);
                
                // Grup görünürlük butonunu güncelle
                const group = layerItem.closest('.layer-group');
                updateGroupVisibilityButton(group);
            }
        });
        
        // Katman içindeki çizimlerin görünürlüğünü ayarla
        function toggleLayerFeatures(layerId, isVisible) {
            if (!layerFeatures[layerId]) return;
            
            layerFeatures[layerId].forEach(feature => {
                // Çizim referansını bul
                const layerInfo = drawnLayers.find(l => l.id === feature.id);
                if (layerInfo) {
                    if (isVisible) {
                        if (!map.hasLayer(layerInfo.layer)) {
                            drawnItems.addLayer(layerInfo.layer);
                        }
                    } else {
                        if (map.hasLayer(layerInfo.layer)) {
                            drawnItems.removeLayer(layerInfo.layer);
                        }
                    }
                }
            });
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
        }
        
        // Grup içindeki tüm katmanları toplu aç/kapat
        function toggleAllLayersInGroup(event, checkbox) {
            event.stopPropagation();
            
            const group = checkbox.closest('.layer-group');
            const items = group.querySelector('.group-items');
            const layerCheckboxes = items.querySelectorAll('.layer-visibility');
            
            // Checkbox'ın durumunu kullan
            const newVisibility = checkbox.checked;
            
            layerCheckboxes.forEach(cb => {
                cb.checked = newVisibility;
                // Katman ID'sini al
                const layerId = cb.closest('.layer-item').getAttribute('data-layer-id');
                // Katman içeriğinin görünürlüğünü ayarla
                toggleLayerFeatures(layerId, newVisibility);
            });
            
            // Toast mesajı
            const groupName = group.querySelector('.group-name').textContent;
            const action = newVisibility ? 'açıldı' : 'kapatıldı';
            showToast(`"${groupName}" grubundaki tüm katmanlar ${action}`, 'success');
            
            // Lejant açıksa güncelle
            if (legendVisible) {
                updateLegendContent();
            }
        }
        
        // Çizim katmanlarını sakla (orijinal açık kalsın)
        var originalAddNewLayerToGroup = addNewLayerToGroup;
        // Bu fonksiyonun tanımını kaldır, artık kullanmıyoruz
        function addNewLayerToGroup() {}

        // Bu fonksiyon artık kullanılmıyor - createNewLayer() kullanılıyor

        // Grup açma/kapama (sadece açma/kapama)
        function toggleGroup(toggleArea) {
            const header = toggleArea.closest('.group-header');
            const icon = toggleArea.querySelector('.group-icon');
            const items = header.nextElementSibling;
            
            if (items.classList.contains('collapsed')) {
                items.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                items.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            }
        }
        
        // Tüm grupları aç
        function expandAllGroups() {
            document.querySelectorAll('.layer-group').forEach(group => {
                const items = group.querySelector('.group-items');
                const icon = group.querySelector('.group-icon');
                
                items.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            });
            showToast('Tüm gruplar açıldı', 'success');
        }
        
        // Tüm grupları kapat
        function collapseAllGroups() {
            document.querySelectorAll('.layer-group').forEach(group => {
                const items = group.querySelector('.group-items');
                const icon = group.querySelector('.group-icon');
                
                items.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            });
            showToast('Tüm gruplar kapatıldı', 'success');
        }

        // Sorgu modalı açma
        function openQueryModal(button) {
            console.log('openQueryModal fonksiyonu çağrıldı', button);
            const modal = document.getElementById('queryModal');
            const layerItem = button.closest('.layer-item');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            modal.dataset.layerName = layerName;
            modal.style.display = 'block';
        }

        // Sorgu modalı kapama
        function closeQueryModal() {
            const modal = document.getElementById('queryModal');
            modal.style.display = 'none';
        }

        // Sorgu tab değiştirme
        function switchQueryTab(tabName) {
            const tabs = document.querySelectorAll('#queryModal .style-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('basicQueryContent').style.display = tabName === 'basic' ? 'block' : 'none';
            document.getElementById('advancedQueryContent').style.display = tabName === 'advanced' ? 'block' : 'none';
        }

        // Sorgu uygulama
        function applyQuery() {
            const modal = document.getElementById('queryModal');
            const layerName = modal.dataset.layerName;
            const activeTab = document.querySelector('#queryModal .style-tab.active').textContent;
            
            if (activeTab === 'Temel') {
                const field = document.getElementById('queryField').value;
                const operator = document.getElementById('queryOperator').value;
                const value = document.getElementById('queryValue').value;
                
                console.log(`Temel sorgu: ${field} ${operator} ${value}`);
            } else {
                const sqlQuery = document.getElementById('sqlQuery').value;
                console.log(`SQL sorgu: ${sqlQuery}`);
            }
            
            closeQueryModal();
        }

        // Tab değiştirme
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.style-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('styleContent').style.display = tabName === 'style' ? 'block' : 'none';
            document.getElementById('labelContent').style.display = tabName === 'label' ? 'block' : 'none';
            document.getElementById('themeContent').style.display = tabName === 'theme' ? 'block' : 'none';
        }

        // RGB'den HEX'e dönüşüm fonksiyonu
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            
            const result = rgb.match(/\d+/g);
            if (!result) return '#000000';
            
            const r = parseInt(result[0]);
            const g = parseInt(result[1]);
            const b = parseInt(result[2]);
            
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // HEX'den RGBA'ya dönüşüm fonksiyonu
        function hexToRgba(hex, opacity) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return `rgba(0, 0, 0, ${opacity})`;
            
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        
        // Modal dışına tıklama kontrolü
        window.onclick = function(event) {
            const styleModal = document.getElementById('styleModal');
            const queryModal = document.getElementById('queryModal');
            
            if (event.target == styleModal) {
                styleModal.style.display = 'none';
            }
            if (event.target == queryModal) {
                queryModal.style.display = 'none';
            }
        }

        // Katman özellikleri gösterme
        function showLayerProperties(button) {
            console.log('Katman özellikleri gösteriliyor');
        }

        // Stil modalı kapama
        function closeStyleModal() {
            const modal = document.getElementById('styleModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Modal'ı gizle
            modal.style.display = 'none';
            
            // Modal pozisyonunu sıfırla (sürükleme sonrası eski konumuna dönmesi için)
            if (modalContent) {
                modalContent.style.transform = 'translate(-50%, -50%)';
            }
            
            // Pending timeout'ları temizle
            if (window.styleUpdateTimeout) {
                clearTimeout(window.styleUpdateTimeout);
                window.styleUpdateTimeout = null;
            }
            if (window.labelUpdateTimeout) {
                clearTimeout(window.labelUpdateTimeout);
                window.labelUpdateTimeout = null;
            }
        }

        // Katman silme - normal katmanlar için
        function deleteLayer(button) {
            console.log('deleteLayer fonksiyonu çağrıldı', button);
            const layerItem = button.closest('.layer-item');
            const layerName = layerItem.querySelector('.layer-name').textContent;
            
            if (confirm(`"${layerName}" katmanını silmek istediğinizden emin misiniz?`)) {
                const layerId = layerItem.getAttribute('data-layer-id');
                
                // Eğer seçili katman siliniyorsa seçimi temizle
                if (activeLayerId === layerId) {
                    clearLayerSelection();
                }
                
                // Katmanı DOM'dan kaldır
                layerItem.remove();
                
                // Katmana ait çizimleri temizle
                if (layerFeatures[layerId]) {
                    layerFeatures[layerId].forEach(feature => {
                        const layerInfo = drawnLayers.find(l => l.id === feature.id);
                        if (layerInfo) {
                            drawnItems.removeLayer(layerInfo.layer);
                        }
                    });
                    delete layerFeatures[layerId];
                }
                
                // Çizim listesinden kaldır
                drawnLayers = drawnLayers.filter(l => l.layerId !== layerId);
                
                // Grup sayısını güncelle
                const group = button.closest('.layer-group');
                updateGroupLayerCount(group);
                
                // Toast bildirimi göster
                showToast(`"${layerName}" katmanı silindi`, 'success');
                
                // Verileri otomatik kaydet
                if (window.DataPersistence) {
                    DataPersistence.autoSave();
                }
            }
        }

        // Range input değer güncellemeleri
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', function() {
                const valueDisplay = this.nextElementSibling;
                if (valueDisplay && valueDisplay.classList.contains('value-display')) {
                    let value = this.value;
                    if (this.id.includes('Opacity')) {
                        value += '%';
                    } else {
                        value += 'px';
                    }
                    valueDisplay.textContent = value;
                }
            });
        });

        // Yeni katman için drag and drop işlevselliği
        function setupDragAndDrop(item) {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                // Tüm grup sayılarını güncelle (katman taşındıktan sonra)
                updateAllGroupCounts();
                draggedItem = null;
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedItem !== this) {
                    this.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedItem !== this) {
                    const parent = this.parentNode;
                    const dropIndex = Array.from(parent.children).indexOf(this);
                    const dragIndex = Array.from(parent.children).indexOf(draggedItem);
                    
                    if (dragIndex < dropIndex) {
                        this.after(draggedItem);
                    } else {
                        this.before(draggedItem);
                    }
                    
                    // Taşıma işlemi sonrası grup sayılarını güncelle
                    updateAllGroupCounts();
                }
            });
        }

        // Drag and Drop işlemleri - mevcut katmanlar için
        let draggedItem = null;

        document.querySelectorAll('.layer-item').forEach(item => {
            setupDragAndDrop(item);
        });

        // Stil modalı açma - layerId parametresi ekledik
        function openStyleModal(type, featureId) {
            const modal = document.getElementById('styleModal');
            
            // Tab'ı sıfırla
            switchTab('style');
            
            // Stil bölümlerini her zaman göster
            document.getElementById('pointStyle').style.display = 'block';
            document.getElementById('lineStyle').style.display = 'block';
            document.getElementById('polygonStyle').style.display = 'block';
            
            // Daha önce seçilen stil modunu yükle
            let layerId = featureId;
            
            // Eğer featureId yoksa, event target'dan veya aktif katmandan al
            if (!layerId && event && event.target) {
                const layerItem = event.target.closest('.layer-item');
                if (layerItem) {
                    layerId = layerItem.getAttribute('data-layer-id');
                }
            }
            
            // Son çare olarak aktif katmanı kullan
            if (!layerId) {
                layerId = activeLayerId;
            }
            
            console.log('OpenStyleModal - Belirlenen layerId:', layerId);
            
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            const savedMode = savedStyleModes[layerId] || 'custom';
            
            console.log('OpenStyleModal - Kayıtlı mod:', savedMode);
            
            // Stil modunu kayıtlı değere ayarla
            document.getElementById('styleMode').value = savedMode;
            
            // Kayıtlı modu başlat
            handleStyleModeChange(savedMode);
            
            // Etiket event listener'larını başlat
            initLabelEventListeners();
            
            // Anında güncelleme event listener'larını başlat
            initRealTimeStyleUpdates();
            
            // Kullanıcıya anında güncelleme özelliği hakkında bilgi ver
            setTimeout(() => {
                showToast('💡 Stil değişiklikleri anında haritaya yansıtılacak', 'info');
            }, 300);
            
            // Katman türüne göre başlığı ayarla
            let title = 'Stil Ayarları';
            if (type === 'point') title = 'Nokta Stil Ayarları';
            else if (type === 'line') title = 'Çizgi Stil Ayarları';
            else if (type === 'polygon') title = 'Poligon Stil Ayarları';
            else if (type === 'landuse') title = 'Arazi Kullanım Stil Ayarları';
            
            document.querySelector('#styleModal .modal-header h3').textContent = title;
            
            // Tip ve diğer verileri temizle (önceki değerlerden etkilenmemesi için)
            modal.dataset.layerType = '';
            modal.dataset.layerId = '';
            modal.dataset.layerName = '';
            
            console.log(`Stil modal açılıyor: type=${type}, featureId=${featureId}`);
            
            // Stil modal'ına veri kaydet
            if (type) {
                modal.dataset.layerType = type;
            }
            
            // LayerId'yi modal'a kaydet
            modal.dataset.layerId = layerId;
            
            console.log('Modal layerId ayarlandı:', layerId);
            
            // Layer name'i de kaydet (varsa)
            if (layerId && !featureId) {
                const layerItem = document.querySelector(`[data-layer-id="${layerId}"]`);
                if (layerItem) {
                    const layerName = layerItem.querySelector('.layer-name')?.textContent || '';
                    modal.dataset.layerName = layerName;
                    console.log(`Katman için stil modal açıldı: ${layerId} (${layerName})`);
                }
            } else if (featureId) {
                console.log(`Çizim için stil modal açıldı: ${featureId}`);
            }
            
            console.log('Modal dataset değerleri:', {
                layerId: modal.dataset.layerId,
                layerType: modal.dataset.layerType,
                layerName: modal.dataset.layerName
            });
            
            // Mevcut stilleri yükle
            loadCurrentStyles(type, featureId);
            
            // Modal'ı aç
            modal.style.display = 'block';
        }
        
        // Mevcut stilleri yükle
        function loadCurrentStyles(type, featureId) {
            // Stil modalı açıldığında stillerle ilgili işlemler yapalım
            const modal = document.getElementById('styleModal');
            
            // Seçili modu kontrol et
            const selectedMode = document.getElementById('styleMode').value;
            
            if (selectedMode === 'default') {
                // Varsayılan mod: sistem varsayılanlarını yükle
                resetDefaultStyles();
                return;
            } else if (selectedMode === 'custom') {
                // Kullanıcı özel mod: önce varsayılanları yükle, sonra özel ayarları
                resetDefaultStyles();
                
                // Eğer kayıtlı kullanıcı özel ayarları varsa yükle
                const savedUserStyles = JSON.parse(localStorage.getItem('userCustomStyles') || '{}');
                if (Object.keys(savedUserStyles).length > 0) {
                    loadUserCustomValues();
                    return;
                }
            }
            
            // Kayıtlı stilleri localStorage'dan yükle (eski sistem için backward compatibility)
            const savedStyles = JSON.parse(localStorage.getItem('mapStyles') || '{}');
            let styles = null;
            
            // Eğer featureId varsa, ilgili çizimin stilini yükle
            if (featureId) {
                const layerInfo = drawnLayers.find(l => l.id === featureId);
                if (layerInfo && layerInfo.layer && layerInfo.layer.options && layerInfo.layer.options.styleInfo) {
                    const styleInfo = layerInfo.layer.options.styleInfo;
                    
                    if (type === 'point' && styleInfo.type === 'point') {
                        document.getElementById('pointColor').value = styleInfo.color || "#ff0000";
                        document.getElementById('pointSize').value = styleInfo.size || 8;
                        document.getElementById('pointShape').value = styleInfo.shape || "circle";
                    }
                    else if (type === 'line' && styleInfo.type === 'line') {
                        document.getElementById('lineColor').value = styleInfo.color || "#ff7800";
                        document.getElementById('lineWidth').value = styleInfo.width || 3;
                        document.getElementById('lineType').value = styleInfo.lineType || "solid";
                    }
                    else if (type === 'polygon' && styleInfo.type === 'polygon') {
                        document.getElementById('fillColor').value = styleInfo.fillColor || "#3388ff";
                        document.getElementById('fillOpacity').value = parseInt((styleInfo.fillOpacity || 0.5) * 100);
                        document.getElementById('strokeColor').value = styleInfo.strokeColor || "#000000";
                        document.getElementById('strokeWidth').value = styleInfo.strokeWidth || 1;
                        document.getElementById('strokeType').value = styleInfo.strokeType || "solid";
                    }
                } else if (layerInfo && layerInfo.layer && layerInfo.layer.options) {
                    // Doğrudan katman özelliklerinden stil al
                    if (type === 'line') {
                        document.getElementById('lineColor').value = layerInfo.layer.options.color || '#ff7800';
                        document.getElementById('lineWidth').value = layerInfo.layer.options.weight || 3;
                        
                        const lineType = detectLineTypeFromDashArray(layerInfo.layer.options.dashArray);
                        document.getElementById('lineType').value = lineType;
                    }
                    else if (type === 'polygon') {
                        document.getElementById('fillColor').value = layerInfo.layer.options.fillColor || '#3388ff';
                        document.getElementById('fillOpacity').value = parseInt((layerInfo.layer.options.fillOpacity || 0.5) * 100);
                        document.getElementById('strokeColor').value = layerInfo.layer.options.color || '#000000';
                        document.getElementById('strokeWidth').value = layerInfo.layer.options.weight || 1;
                        
                        const strokeType = detectLineTypeFromDashArray(layerInfo.layer.options.dashArray);
                        document.getElementById('strokeType').value = strokeType;
                    }
                }
                
                // localStorage'dan stil kontrolü yapılabilir
                if (savedStyles[featureId] && savedStyles[featureId][type]) {
                    styles = savedStyles[featureId][type];
                }
            } 
            // Katman seçilmişse, katmanın stillerini kontrol et
            else if (modal.dataset.layerId) {
                const layerId = modal.dataset.layerId;
                if (savedStyles[layerId] && savedStyles[layerId][type]) {
                    styles = savedStyles[layerId][type];
                }
            }
            
            // Eğer kayıtlı stiller bulunduysa, input alanlarını güncelle
            if (styles) {
                if (type === 'point') {
                    document.getElementById('pointColor').value = styles.pointColor || "#ff0000";
                    document.getElementById('pointSize').value = styles.pointSize || 8;
                    document.getElementById('pointShape').value = styles.pointShape || "circle";
                } 
                else if (type === 'line') {
                    document.getElementById('lineColor').value = styles.lineColor || "#ff7800";
                    document.getElementById('lineWidth').value = styles.lineWidth || 3;
                    document.getElementById('lineType').value = styles.lineType || "solid";
                }
                else if (type === 'polygon') {
                    document.getElementById('fillColor').value = styles.fillColor || "#3388ff";
                    document.getElementById('fillOpacity').value = styles.fillOpacity || 50;
                    document.getElementById('strokeColor').value = styles.strokeColor || "#000000";
                    document.getElementById('strokeWidth').value = styles.strokeWidth || 1;
                    document.getElementById('strokeType').value = styles.strokeType || "solid";
                }
            }
            
            // Range input değerlerini güncelle
            updateRangeDisplays();
        }
        
        // Sistem varsayılan stilleri
        const systemDefaultStyles = {
            point: { color: "#ff0000", size: 8, shape: "circle", opacity: 100, styleType: "custom" },
            line: { color: "#ff7800", width: 3, opacity: 100, lineType: "solid" },
            polygon: { fillColor: "#3388ff", fillOpacity: 50, strokeColor: "#000000", strokeWidth: 1, strokeOpacity: 100, strokeType: "solid" }
        };

        // Rastgele isim listeleri
        const randomNames = {
            points: [
                "İstanbul Üniversitesi", "Galata Kulesi", "Topkapı Sarayı", "Ayasofya", "Kapalıçarşı",
                "Dolmabahçe Sarayı", "Beyazıt Kulesi", "Şişli Merkez", "Kadıköy İskelesi", "Üsküdar Meydanı",
                "Beşiktaş Merkezi", "Taksim Meydanı", "Eminönü İskelesi", "Bakırköy Merkez", "Kartal Meydanı"
            ],
            lines: [
                "Boğaziçi Köprüsü", "Fatih Sultan Mehmet Köprüsü", "Yavuz Sultan Selim Köprüsü", 
                "D-100 Karayolu", "TEM Otoyolu", "Sahil Yolu", "İstiklal Caddesi", "Bağdat Caddesi",
                "Barbaros Bulvarı", "Atatürk Bulvarı", "Kennedy Caddesi", "Büyükdere Caddesi",
                "Maslak Yolu", "E-5 Karayolu", "Çevre Yolu"
            ],
            polygons: [
                "Gülhane Parkı", "Emirgan Korusu", "Yıldız Parkı", "Maçka Parkı", "Fenerbahçe Parkı",
                "Sultanahmet Meydanı", "Taksim Gezi Parkı", "Büyükada", "Heybeliada", "Kınalıada",
                "Florya Sahili", "Caddebostan Sahili", "Yeşilköy Sahili", "Kilyos Sahili", "Şile Sahili"
            ]
        };

        // Stil alanlarını varsayılan değerlerine ayarla
        function resetDefaultStyles() {
            // Sistem varsayılan değerlerini uygula
            applySystemDefaults();
        }

        // Sistem varsayılan değerlerini uygula
        function applySystemDefaults() {
            // Nokta stil değerleri
            document.getElementById('pointColor').value = systemDefaultStyles.point.color;
            document.getElementById('pointSize').value = systemDefaultStyles.point.size;
            document.getElementById('pointShape').value = systemDefaultStyles.point.shape;
            document.getElementById('pointOpacity').value = systemDefaultStyles.point.opacity;
            document.getElementById('pointStyleType').value = systemDefaultStyles.point.styleType;
            
            // Çizgi stil değerleri
            document.getElementById('lineColor').value = systemDefaultStyles.line.color;
            document.getElementById('lineWidth').value = systemDefaultStyles.line.width;
            document.getElementById('lineOpacity').value = systemDefaultStyles.line.opacity;
            document.getElementById('lineType').value = systemDefaultStyles.line.lineType;
            
            // Poligon stil değerleri
            document.getElementById('fillColor').value = systemDefaultStyles.polygon.fillColor;
            document.getElementById('fillOpacity').value = systemDefaultStyles.polygon.fillOpacity;
            document.getElementById('strokeColor').value = systemDefaultStyles.polygon.strokeColor;
            document.getElementById('strokeWidth').value = systemDefaultStyles.polygon.strokeWidth;
            document.getElementById('strokeOpacity').value = systemDefaultStyles.polygon.strokeOpacity;
            document.getElementById('strokeType').value = systemDefaultStyles.polygon.strokeType;
            
            // Range display'leri güncelle
            updateRangeDisplays();
        }

        // Tüm çizimlere etiket uygula
        function applyLabelsToAllFeatures() {
            const showLabels = document.getElementById('showLabels').checked;
            const labelField = document.getElementById('labelField').value;
            const fontSize = document.getElementById('fontSize').value;
            const fontColor = document.getElementById('fontColor').value;
            const haloColor = document.getElementById('haloColor').value;
            const haloWidth = document.getElementById('haloWidth').value;
            const labelPosition = document.getElementById('labelPosition').value;
            
            if (!showLabels || !labelField) {
                // Etiketleri gizle
                drawnLayers.forEach(layerInfo => {
                    const layer = layerInfo.layer;
                    if (layer.closeTooltip) layer.closeTooltip();
                    if (layer.unbindTooltip) layer.unbindTooltip();
                });
                return;
            }
            
            // Tüm çizimlere etiket ekle
            drawnLayers.forEach(layerInfo => {
                const layer = layerInfo.layer;
                const properties = layer.feature ? layer.feature.properties : {};
                
                let labelText = '';
                if (labelField === 'name' && properties.name) {
                    labelText = properties.name;
                } else if (labelField === 'type' && properties.type) {
                    labelText = properties.type === 'point' ? 'Nokta' : 
                               properties.type === 'line' ? 'Çizgi' : 'Poligon';
                } else if (labelField === 'id' && properties.id) {
                    labelText = properties.id;
                } else if (labelField === 'area' && properties.area) {
                    labelText = `${properties.area} m²`;
                } else if (labelField === 'length' && properties.length) {
                    labelText = `${properties.length} m`;
                }
                
                if (labelText) {
                    const tooltipOptions = {
                        permanent: true,
                        direction: labelPosition === 'center' ? 'center' : labelPosition,
                        className: 'feature-label',
                        offset: labelPosition === 'center' ? [0, 0] : [0, -10]
                    };
                    
                    // Önceki tooltip'i kaldır
                    if (layer.getTooltip) layer.closeTooltip();
                    if (layer.unbindTooltip) layer.unbindTooltip();
                    
                    // Yeni tooltip ekle
                    layer.bindTooltip(labelText, tooltipOptions);
                    
                    // CSS stilini uygula
                    setTimeout(() => {
                        const tooltipElement = layer.getTooltip() ? layer.getTooltip()._container : null;
                        if (tooltipElement) {
                            tooltipElement.style.fontSize = fontSize + 'px';
                            tooltipElement.style.color = fontColor;
                            tooltipElement.style.textShadow = `1px 1px ${haloWidth}px ${haloColor}, -1px -1px ${haloWidth}px ${haloColor}, 1px -1px ${haloWidth}px ${haloColor}, -1px 1px ${haloWidth}px ${haloColor}`;
                            tooltipElement.style.fontWeight = 'bold';
                            tooltipElement.style.backgroundColor = 'transparent';
                            tooltipElement.style.border = 'none';
                            tooltipElement.style.boxShadow = 'none';
                        }
                    }, 100);
                }
            });
        }

        // Anında stil güncellemesi için event listener'ları başlat
        function initRealTimeStyleUpdates() {
            // Tüm stil input'larına event listener ekle
            const styleInputs = [
                // Nokta stil input'ları
                'pointColor', 'pointSize', 'pointShape', 'pointOpacity', 'pointStyleType',
                // Çizgi stil input'ları
                'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                // Poligon stil input'ları
                'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType',
                // İkon input'ları
                'iconSize'
            ];

            styleInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Hem input hem de change eventlerini dinle
                    input.addEventListener('input', handleRealTimeStyleUpdate);
                    input.addEventListener('change', handleRealTimeStyleUpdate);
                }
            });

            // Stil modu değişikliğini dinle
            const styleModeSelect = document.getElementById('styleMode');
            if (styleModeSelect) {
                styleModeSelect.addEventListener('change', function() {
                    // Önce modu değiştir, sonra anında güncelle
                    handleStyleModeChange(this.value);
                });
            }

            // İkon grid seçimlerini dinle
            setupIconGridListener();
        }

        // Gerçek zamanlı stil güncellemesi
        function handleRealTimeStyleUpdate() {
            // Kısa bir gecikme ekleyerek performansı artır
            if (window.styleUpdateTimeout) {
                clearTimeout(window.styleUpdateTimeout);
            }
            
            window.styleUpdateTimeout = setTimeout(() => {
                try {
                    // Range display'leri güncelle
                    updateRangeDisplays();
                    
                    // Modal açıksa normal applyStyle kullan
                    const modal = document.getElementById('styleModal');
                    if (modal && modal.style.display !== 'none' && modal.dataset.layerId) {
                        applyStyle();
                    } else {
                        // Modal açık değilse aktif katmana stil uygula
                        if (activeLayerId) {
                            applyStyleToActiveLayer();
                        }
                    }
                    
                    // Etiket ayarları aktifse onları da güncelle
                    if (document.querySelector('#labelContent') && document.querySelector('#labelContent').style.display !== 'none') {
                        if (typeof applyLabelsToAllFeatures === 'function') {
                            applyLabelsToAllFeatures();
                        }
                    }
                    
                    // Custom modda ise ayarları otomatik kaydet (debounced)
                    const currentMode = document.getElementById('styleMode')?.value;
                    if (currentMode === 'custom') {
                        if (window.saveUserStylesTimeout) {
                            clearTimeout(window.saveUserStylesTimeout);
                        }
                        window.saveUserStylesTimeout = setTimeout(() => {
                            saveUserCustomStyles();
                        }, 500); // 500ms sonra kaydet
                    }
                } catch (error) {
                    console.warn('Gerçek zamanlı stil güncellemesi sırasında hata:', error);
                }
            }, 50); // 50ms gecikme (daha hızlı)
        }

        // İkon grid listener'ı kurma
        function setupIconGridListener() {
            const iconGrid = document.getElementById('iconGrid');
            if (iconGrid) {
                iconGrid.addEventListener('click', function(e) {
                    const iconOption = e.target.closest('.icon-option');
                    if (iconOption) {
                        // İkon seçiminden sonra stil güncelle
                        setTimeout(handleRealTimeStyleUpdate, 25);
                    }
                });
            }
        }

        // Katman stil modu göstergesini güncelle
        function updateLayerStyleModeIndicator(layerId, mode) {
            if (!layerId) {
                console.warn('updateLayerStyleModeIndicator: layerId bulunamadı');
                return;
            }
            
            const indicator = document.querySelector(`[data-layer-id="${layerId}"].layer-style-mode-indicator`);
            console.log('Gösterge güncellemesi:', { layerId, mode, indicator: !!indicator });
            
            if (indicator) {
                // CSS sınıflarını temizle
                indicator.classList.remove('default-mode', 'custom-mode');
                
                if (mode === 'default') {
                    indicator.textContent = '🏢';
                    indicator.title = 'Varsayılan Kurumsal Ayarlar (Kişiselleştir)';
                    indicator.classList.add('default-mode');
                    console.log(`Gösterge güncellendi: ${layerId} -> varsayılan mod`);
                } else if (mode === 'custom') {
                    indicator.textContent = '👤';
                    indicator.title = 'Kullanıcıya Özel Ayarlar (Varsayılana Geç)';
                    indicator.classList.add('custom-mode');
                    console.log(`Gösterge güncellendi: ${layerId} -> özel mod`);
                }
            } else {
                console.warn(`Gösterge bulunamadı: [data-layer-id="${layerId}"].layer-style-mode-indicator`);
            }
        }

        // Tüm katman stil modu göstergelerini güncelle
        function updateAllLayerStyleModeIndicators() {
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            
            document.querySelectorAll('.layer-style-mode-indicator').forEach(indicator => {
                const layerId = indicator.getAttribute('data-layer-id');
                if (layerId) {
                    const mode = savedStyleModes[layerId] || 'default';
                    updateLayerStyleModeIndicator(layerId, mode);
                    
                    // Tıklama event'ini ekle (eğer yoksa)
                    if (!indicator.hasAttribute('onclick')) {
                        indicator.setAttribute('onclick', `toggleLayerStyleMode('${layerId}', event)`);
                    }
                }
            });
        }

        // Yeni kaydet ve kapat fonksiyonu
        function saveAndCloseStyle() {
            try {
                console.log('saveAndCloseStyle başlatıldı');
                
                // Modal'dan katman bilgilerini al
                const modal = document.getElementById('styleModal');
                const layerId = modal.dataset.layerId;
                const layerType = modal.dataset.layerType;
                
                console.log('Modal verileri:', { layerId, layerType });
                
                if (!layerId) {
                    console.error('LayerId bulunamadı, modal veri kontrolü yapılıyor...');
                    showToast('Katman bilgisi bulunamadı', 'error');
                    return;
                }
                
                // Seçili stil modunu kontrol et ve gerekli ayarları kaydet
                const styleMode = document.getElementById('styleMode').value;
                console.log('Seçili stil modu:', styleMode);
                
                if (styleMode === 'custom') {
                    // Kullanıcı özel modunda: özel ayarları global olarak kaydet
                    console.log('Kullanıcı özel ayarları kaydediliyor...');
                    saveUserCustomStyles();
                } else if (styleMode === 'default') {
                    // Varsayılan modunda: sistem varsayılan değerlerini kullan
                    console.log('Varsayılan mod kullanılıyor - özel kayıt yapılmıyor');
                }
                
                // Her iki durumda da stil değişikliklerini uygula
                console.log('Stil değişiklikleri uygulanıyor...');
                applyStyle();
                
                // Etiket ayarlarını da uygula
                if (document.querySelector('#labelContent').style.display !== 'none') {
                    if (typeof applyLabelsToAllFeatures === 'function') {
                        console.log('Etiket ayarları uygulanıyor...');
                        applyLabelsToAllFeatures();
                    }
                }
                
                // Katman göstergesini güncelle
                console.log('Katman göstergesi güncelleniyor...', layerId, styleMode);
                updateLayerStyleModeIndicator(layerId, styleMode);
                
                // Başarı mesajı
                const modeText = styleMode === 'custom' ? 'Özel ayarlar' : 'Varsayılan ayarlar';
                showToast(`${modeText} kaydedildi ve uygulandı`, 'success');
                console.log('saveAndCloseStyle başarıyla tamamlandı');
                
            } catch (error) {
                console.error('Stil kaydedilirken hata oluştu:', error);
                console.error('Hata detayları:', error.stack);
                showToast(`Stil ayarları kaydedilirken hata: ${error.message}`, 'error');
            } finally {
                // Her durumda modal'ı kapat
                console.log('Modal kapatılıyor...');
                closeStyleModal();
            }
        }
        
        // Kalınlığa göre dash array hesapla
        function calculateDashArray(type, width) {
            if (!type || type === 'solid') return null;
            
            // Minimum kalınlık 1, maksimum ölçekleme faktörü
            const scaleFactor = Math.max(1, width / 2);
            
            if (type === 'dashed') {
                const dash = Math.round(8 * scaleFactor);
                const gap = Math.round(4 * scaleFactor);
                return `${dash}, ${gap}`;
            } else if (type === 'dotted') {
                const dot = Math.round(2 * scaleFactor);
                const gap = Math.round(4 * scaleFactor);
                return `${dot}, ${gap}`;
            } else if (type === 'dashDot') {
                const dash = Math.round(8 * scaleFactor);
                const gap1 = Math.round(4 * scaleFactor);
                const dot = Math.round(2 * scaleFactor);
                const gap2 = Math.round(4 * scaleFactor);
                return `${dash}, ${gap1}, ${dot}, ${gap2}`;
            }
            
            return null;
        }

        // Dash array'den line type'ı tespit et
        function detectLineTypeFromDashArray(dashArray) {
            if (!dashArray) return 'solid';
            
            // Dash array'i parse et
            const parts = dashArray.split(',').map(p => parseInt(p.trim()));
            if (parts.length < 2) return 'solid';
            
            // Oranları kontrol et (kalınlık bağımsız)
            const ratio1 = parts[0] / parts[1]; // İlk dash/gap oranı
            
            if (parts.length === 2) {
                // İki parça: dash, gap
                if (ratio1 >= 1.5 && ratio1 <= 2.5) return 'dashed'; // ~2:1 oranı
                if (ratio1 >= 0.3 && ratio1 <= 0.7) return 'dotted'; // ~1:2 oranı
            } else if (parts.length === 4) {
                // Dört parça: dash, gap, dot, gap - dashDot pattern
                const ratio2 = parts[2] / parts[3]; // Dot/gap oranı
                if (ratio1 >= 1.5 && ratio2 >= 0.3 && ratio2 <= 0.7) return 'dashDot';
            }
            
            return 'solid';
        }

        // Kullanıcı özel stillerini kaydet
        function saveUserCustomStyles() {
            try {
                const userStyles = {
                    point: {
                        color: document.getElementById('pointColor')?.value || "#ff0000",
                        size: parseInt(document.getElementById('pointSize')?.value || 8),
                        shape: document.getElementById('pointShape')?.value || "circle",
                        opacity: parseInt(document.getElementById('pointOpacity')?.value || 100),
                        styleType: document.getElementById('pointStyleType')?.value || "custom"
                    },
                    line: {
                        color: document.getElementById('lineColor')?.value || "#ff7800",
                        width: parseInt(document.getElementById('lineWidth')?.value || 3),
                        opacity: parseInt(document.getElementById('lineOpacity')?.value || 100),
                        lineType: document.getElementById('lineType')?.value || "solid"
                    },
                    polygon: {
                        fillColor: document.getElementById('fillColor')?.value || "#3388ff",
                        fillOpacity: parseInt(document.getElementById('fillOpacity')?.value || 50),
                        strokeColor: document.getElementById('strokeColor')?.value || "#000000",
                        strokeWidth: parseInt(document.getElementById('strokeWidth')?.value || 1),
                        strokeOpacity: parseInt(document.getElementById('strokeOpacity')?.value || 100),
                        strokeType: document.getElementById('strokeType')?.value || "solid"
                    }
                };
                
                localStorage.setItem('userCustomStyles', JSON.stringify(userStyles));
                console.log('Kullanıcı özel ayarları kaydedildi:', userStyles);
            } catch (error) {
                console.error('Kullanıcı ayarları kaydedilemedi:', error);
            }
        }

        // Aktif katmana stil uygula (modal olmadan)
        function applyStyleToActiveLayer() {
            if (!activeLayerId) {
                console.warn("Aktif katman bulunamadı");
                return;
            }
            
            console.log("=== Aktif katmana stil uygulanıyor ===");
            console.log("Aktif katman ID:", activeLayerId);
            
            const targetLayer = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
            if (!targetLayer) {
                console.error("Aktif katman DOM'da bulunamadı:", activeLayerId);
                return;
            }
            
            // Katmandaki çizim tiplerini kontrol et ve hepsine stil uygula
            const features = layerFeatures[activeLayerId] || [];
            console.log("layerFeatures[activeLayerId]:", features);
            console.log("Tüm layerFeatures:", layerFeatures);
            
            const hasPoint = features.some(f => f.type === 'point');
            const hasLine = features.some(f => f.type === 'line');
            const hasPolygon = features.some(f => f.type === 'polygon');
            
            console.log("Katman çizim tipleri kontrolü:", { 
                hasPoint, 
                hasLine, 
                hasPolygon, 
                featureCount: features.length,
                features: features.map(f => ({ id: f.id, type: f.type }))
            });
            
            // Alternatif olarak drawnLayers'dan da kontrol edelim
            const drawnLayersForThisLayer = drawnLayers.filter(dl => {
                // drawnLayers'daki her item'in katman bilgisini kontrol et
                return dl.layerId === activeLayerId;
            });
            
            console.log("drawnLayers'dan bulunan çizimler:", drawnLayersForThisLayer.map(dl => ({ 
                id: dl.id, 
                type: dl.type, 
                layerId: dl.layerId 
            })));
            
            if (hasPoint) {
                console.log("✅ Point stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'point');
            }
            if (hasLine) {
                console.log("✅ Line stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'line');
            }
            if (hasPolygon) {
                console.log("✅ Polygon stilini uyguluyorum...");
                applyStyleToLayer(targetLayer, activeLayerId, 'polygon');
            }
            
            // Eğer hiçbir tip bulunamazsa, drawnLayers'dan dene
            if (!hasPoint && !hasLine && !hasPolygon && drawnLayersForThisLayer.length > 0) {
                console.log("⚠️ layerFeatures'da bulunamadı, drawnLayers'dan uyguluyorum...");
                drawnLayersForThisLayer.forEach(dl => {
                    console.log(`${dl.type} stilini uyguluyorum (drawnLayers'dan):`, dl.id);
                    applyStyleToFeature(dl.id, dl.type);
                });
            }
            
            console.log("=== Aktif katman stili güncelleme tamamlandı ===");
            
            // Stil modu göstergesini güncelle (kullanıcı değişiklik yaptığında custom moda geç)
            const currentMode = document.getElementById('styleMode')?.value || 'custom';
            updateLayerStyleModeIndicator(activeLayerId, currentMode);
        }

        // Stil uygulama
        function applyStyle() {
            try {
                const modal = document.getElementById('styleModal');
                const layerType = modal.dataset.layerType;
                const layerId = modal.dataset.layerId;
                
                console.log("Stil uygulanıyor:", { layerType, layerId });
                
                if (!layerId) {
                    console.error("LayerId bulunamadı, stil uygulanamıyor");
                    throw new Error("Katman ID'si bulunamadı");
                }
            
            // Sayfa üzerindeki stil ayarlarını oku
            const styleSettings = {
                point: {
                    color: document.getElementById('pointColor').value,
                    size: parseInt(document.getElementById('pointSize').value),
                    shape: document.getElementById('pointShape').value,
                    opacity: parseInt(document.getElementById('pointOpacity').value) / 100,
                    styleType: document.getElementById('pointStyleType').value
                },
                line: {
                    color: document.getElementById('lineColor').value,
                    width: parseInt(document.getElementById('lineWidth').value),
                    opacity: parseInt(document.getElementById('lineOpacity').value) / 100,
                    lineType: document.getElementById('lineType').value
                },
                polygon: {
                    fillColor: document.getElementById('fillColor').value,
                    fillOpacity: parseInt(document.getElementById('fillOpacity').value) / 100,
                    strokeColor: document.getElementById('strokeColor').value,
                    strokeWidth: parseInt(document.getElementById('strokeWidth').value),
                    strokeOpacity: parseInt(document.getElementById('strokeOpacity').value) / 100,
                    strokeType: document.getElementById('strokeType').value
                }
            };
            
            // Stil uygulanacak hedefi belirle
            if (layerId) {
                if (layerId.startsWith('feature-')) {
                    // Tek bir çizim öğesine stil uygula
                    if (layerType) {
                        applyStyleToFeature(layerId, layerType);
                        console.log(`${layerType} stilini çizim öğesine uygulandı: ${layerId}`);
                    } else {
                        // Çizim tipine göre stil uygula
                        const layerInfo = drawnLayers.find(l => l.id === layerId);
                        if (layerInfo) {
                            const type = layerInfo.type;
                            applyStyleToFeature(layerId, type);
                            console.log(`${type} stilini çizim öğesine uygulandı: ${layerId}`);
                        } else {
                            console.error("Çizim bulunamadı:", layerId);
                        }
                    }
                } else {
                    // Bir katmana ait tüm çizimlere stil uygula
                    const targetLayer = document.querySelector(`[data-layer-id="${layerId}"]`);
                    if (targetLayer) {
                        console.log("Katman bulundu, stil uygulanıyor:", layerId);
                        // Geçerli olan her stil tipini uygula
                        if (layerType) {
                            // Belirli bir stil tipi seçilmişse sadece onu uygula
                            applyStyleToLayer(targetLayer, layerId, layerType);
                        } else {
                            // Tüm stil tiplerini kontrol et ve katmanda kullanılanları uygula
                            const features = layerFeatures[layerId] || [];
                            const hasPoint = features.some(f => f.type === 'point');
                            const hasLine = features.some(f => f.type === 'line');
                            const hasPolygon = features.some(f => f.type === 'polygon');
                            
                            if (hasPoint) applyStyleToLayer(targetLayer, layerId, 'point');
                            if (hasLine) applyStyleToLayer(targetLayer, layerId, 'line');
                            if (hasPolygon) applyStyleToLayer(targetLayer, layerId, 'polygon');
                        }
                    } else {
                        console.error("Katman bulunamadı:", layerId);
                    }
                }
            } else {
                console.error("Stil uygulanacak katman veya çizim belirtilmemiş");
                // Aktif katmanı kullanmayı dene
                if (activeLayerId) {
                    const targetLayer = document.querySelector(`[data-layer-id="${activeLayerId}"]`);
                    if (targetLayer) {
                        if (layerType) {
                            applyStyleToLayer(targetLayer, activeLayerId, layerType);
                            console.log(`${layerType} stilini aktif katmana uygulandı: ${activeLayerId}`);
                        } else {
                            // Aktif katmanda varolan tüm geometri tiplerine uygula
                            const features = layerFeatures[activeLayerId] || [];
                            const hasPoint = features.some(f => f.type === 'point');
                            const hasLine = features.some(f => f.type === 'line');
                            const hasPolygon = features.some(f => f.type === 'polygon');
                            
                            if (hasPoint) applyStyleToLayer(targetLayer, activeLayerId, 'point');
                            if (hasLine) applyStyleToLayer(targetLayer, activeLayerId, 'line');
                            if (hasPolygon) applyStyleToLayer(targetLayer, activeLayerId, 'polygon');
                        }
                    }
                }
            }
            
                // Stil ayarlarını kaydet
                saveStyles(layerId || activeLayerId, layerType);
                
                // Çizim kontrolünü güncelle
                if (typeof updateDrawControl === 'function') {
                    updateDrawControl();
                }
                
                console.log("Stil başarıyla uygulandı");
                
                // Stil modu göstergesini güncelle
                const targetLayerId = layerId || activeLayerId;
                if (targetLayerId) {
                    const currentMode = document.getElementById('styleMode')?.value || 'custom';
                    updateLayerStyleModeIndicator(targetLayerId, currentMode);
                }
                
            } catch (error) {
                console.error("Stil uygulama hatası:", error);
                throw error; // Hatayı üst seviyeye geçir
            }
        }
        
        
        
        // Stilleri kaydet
        function saveStyles(layerId, layerType) {
            if (!layerId) {
                console.warn("saveStyles: Kaydedilecek katman ID'si bulunamadı");
                return;
            }
            
            console.log(`Stiller kaydediliyor: layerId=${layerId}, layerType=${layerType}`);
            
            // Seçili stil modunu al
            const selectedMode = document.getElementById('styleMode').value;
            
            // Ayarları yerel depolama alanına kaydet
            const styleSettings = {
                pointColor: document.getElementById('pointColor').value,
                pointSize: document.getElementById('pointSize').value,
                pointShape: document.getElementById('pointShape').value,
                
                lineColor: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value, 
                lineType: document.getElementById('lineType').value,
                
                fillColor: document.getElementById('fillColor').value,
                fillOpacity: document.getElementById('fillOpacity').value,
                strokeColor: document.getElementById('strokeColor').value,
                strokeWidth: document.getElementById('strokeWidth').value,
                strokeType: document.getElementById('strokeType').value
            };
            
            // Katman-stil ilişkisini kaydet
            const savedStyles = JSON.parse(localStorage.getItem('mapStyles') || '{}');
            
            if (layerId) {
                savedStyles[layerId] = {
                    ...savedStyles[layerId],
                    [layerType]: styleSettings
                };
            }
            
            localStorage.setItem('mapStyles', JSON.stringify(savedStyles));
            
            // Katman için seçilen stil modunu da kaydet
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            savedStyleModes[layerId] = selectedMode;
            localStorage.setItem('layerStyleModes', JSON.stringify(savedStyleModes));
            
            // Kullanıcıya stil değişikliklerinin kaydedildiğini bildir
            console.log('Stil değişiklikleri kaydedildi - Mod:', selectedMode);
        }

        // Range inputların görüntüsünü güncelle
        function updateRangeDisplays() {
            document.querySelectorAll('input[type="range"]').forEach(input => {
                const valueDisplay = input.nextElementSibling;
                if (valueDisplay && valueDisplay.classList.contains('value-display')) {
                    let value = input.value;
                    if (input.id.includes('Opacity')) {
                        value += '%';
                    } else if (input.id.includes('Density') || input.id.includes('Height')) {
                        value = value; // Birim eklemeden göster
                    } else {
                        value += 'px';
                    }
                    valueDisplay.textContent = value;
                }
            });
        }

        // Tek bir çizime stil uygula
        function applyStyleToFeature(featureId, type) {
            const layerInfo = drawnLayers.find(l => l.id === featureId);
            if (!layerInfo) return;
            
            const layer = layerInfo.layer;
            
            if (type === 'point') {
                const pointColor = document.getElementById('pointColor').value;
                const pointSize = parseInt(document.getElementById('pointSize').value);
                const pointOpacity = parseInt(document.getElementById('pointOpacity').value) / 100;
                const pointShape = document.getElementById('pointShape').value;
                const pointStyleType = document.getElementById('pointStyleType').value;
                
                // Marker stili için custom icon oluştur
                let iconHtml = '';
                const rgbaColor = hexToRgba(pointColor, pointOpacity);
                
                if (pointStyleType === 'custom') {
                    if (pointShape === 'circle') {
                        iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                    } else if (pointShape === 'square') {
                        iconHtml = `<div style="background-color: ${rgbaColor}; width: ${pointSize}px; height: ${pointSize}px; border: 1px solid rgba(0,0,0,0.3);"></div>`;
                    } else if (pointShape === 'triangle') {
                        iconHtml = `<div style="width: 0; height: 0; border-left: ${pointSize/2}px solid transparent; border-right: ${pointSize/2}px solid transparent; border-bottom: ${pointSize}px solid ${rgbaColor};"></div>`;
                    } else if (pointShape === 'star') {
                        iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>`;
                    } else if (pointShape === 'diamond') {
                        iconHtml = `<svg width="${pointSize}" height="${pointSize}" viewBox="0 0 24 24"><polygon fill="${rgbaColor}" stroke="rgba(0,0,0,0.3)" stroke-width="1" points="12,2 22,12 12,22 2,12"/></svg>`;
                    }
                } else {
                    // İkon modunda seçilen ikonu kullan
                    const iconGrid = document.getElementById('iconGrid');
                    const selectedIcon = iconGrid ? iconGrid.dataset.selectedIcon : '📍';
                    iconHtml = `<div style="font-size: ${pointSize}px; opacity: ${pointOpacity};">${selectedIcon || '📍'}</div>`;
                }
                
                // DivIcon oluştur
                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-div-icon',
                    iconSize: [pointSize, pointSize],
                    iconAnchor: [pointSize/2, pointSize/2]
                });
                
                // Icon'u uygula
                if (layer.setIcon) {
                    layer.setIcon(customIcon);
                }
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${pointColor}"><strong>Nokta</strong><br>Şekil: ${pointShape}<br>Boyut: ${pointSize}px<br>Saydamlık: ${Math.round(pointOpacity * 100)}%</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            else if (type === 'line') {
                const lineColor = document.getElementById('lineColor').value;
                const lineWidth = parseInt(document.getElementById('lineWidth').value);
                const lineOpacity = parseInt(document.getElementById('lineOpacity').value) / 100;
                const lineType = document.getElementById('lineType').value;
                
                // Çizgi stili için dashArray tanımla
                const dashArray = calculateDashArray(lineType, lineWidth);
                
                // Stili uygula
                layer.setStyle({
                    color: lineColor,
                    weight: lineWidth,
                    opacity: lineOpacity,
                    dashArray: dashArray
                });
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${lineColor}"><strong>Çizgi</strong><br>Kalınlık: ${lineWidth}px<br>Saydamlık: ${Math.round(lineOpacity * 100)}%<br>Tip: ${lineType}</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            else if (type === 'polygon') {
                const fillColor = document.getElementById('fillColor').value;
                const fillOpacity = document.getElementById('fillOpacity').value / 100;
                const strokeColor = document.getElementById('strokeColor').value;
                const strokeWidth = parseInt(document.getElementById('strokeWidth').value);
                const strokeOpacity = parseInt(document.getElementById('strokeOpacity').value) / 100;
                const strokeType = document.getElementById('strokeType').value;
                
                // Kenar stili için dashArray tanımla
                const dashArray = calculateDashArray(strokeType, strokeWidth);
                
                // Stili uygula
                layer.setStyle({
                    fillColor: fillColor,
                    fillOpacity: fillOpacity,
                    color: strokeColor,
                    weight: strokeWidth,
                    opacity: strokeOpacity,
                    dashArray: dashArray
                });
                
                // Popup bilgisi ekle veya güncelle
                const popupContent = `<div style="color:${fillColor}"><strong>Poligon</strong><br>Dolgu Saydamlık: ${Math.round(fillOpacity * 100)}%<br>Kenar Kalınlık: ${strokeWidth}px<br>Kenar Saydamlık: ${Math.round(strokeOpacity * 100)}%</div>`;
                if (layer.getPopup()) {
                    layer.setPopupContent(popupContent);
                } else {
                    layer.bindPopup(popupContent);
                }
            }
            
            // Stil özelliklerini katmanda sakla
            if (!layer.options) layer.options = {};
            layer.options.styleInfo = {
                type: type,
                timestamp: new Date().getTime()
            };
            
            if (type === 'point') {
                layer.options.styleInfo.color = document.getElementById('pointColor').value;
                layer.options.styleInfo.size = document.getElementById('pointSize').value;
                layer.options.styleInfo.opacity = document.getElementById('pointOpacity').value / 100;
                layer.options.styleInfo.shape = document.getElementById('pointShape').value;
                layer.options.styleInfo.styleType = document.getElementById('pointStyleType').value;
            } else if (type === 'line') {
                layer.options.styleInfo.color = document.getElementById('lineColor').value;
                layer.options.styleInfo.width = document.getElementById('lineWidth').value;
                layer.options.styleInfo.opacity = document.getElementById('lineOpacity').value / 100;
                layer.options.styleInfo.lineType = document.getElementById('lineType').value;
            } else if (type === 'polygon') {
                layer.options.styleInfo.fillColor = document.getElementById('fillColor').value;
                layer.options.styleInfo.fillOpacity = document.getElementById('fillOpacity').value / 100;
                layer.options.styleInfo.strokeColor = document.getElementById('strokeColor').value;
                layer.options.styleInfo.strokeWidth = document.getElementById('strokeWidth').value;
                layer.options.styleInfo.strokeOpacity = document.getElementById('strokeOpacity').value / 100;
                layer.options.styleInfo.strokeType = document.getElementById('strokeType').value;
            }
        }
        
        // Katmandaki tüm çizimlere stil uygula
        function applyStyleToLayer(layerItem, layerId, layerType) {
            if (!layerItem || !layerId) {
                console.error("applyStyleToLayer: Katman öğesi veya ID'si eksik");
                return;
            }
            
            console.log(`Katman stilini uygulama başladı: layerId=${layerId}, layerType=${layerType}`);
            
            // SVG ikonları güncelle
            if (layerType === 'point') {
                const pointColor = document.getElementById('pointColor').value;
                const pointSize = document.getElementById('pointSize').value;
                const pointShape = document.getElementById('pointShape').value;
                const pointIcons = layerItem.querySelectorAll('.layer-icon:nth-child(1)');
                
                pointIcons.forEach(icon => {
                    // Rengi güncelle
                    icon.style.color = pointColor;
                    
                    // Şekil tipini de yansıtabiliriz
                    const svgEl = icon.querySelector('svg');
                    if (svgEl) {
                        let pathContent = '';
                        if (pointShape === 'circle') {
                            pathContent = '<circle cx="12" cy="12" r="6" fill="currentColor"/>';
                        } else if (pointShape === 'square') {
                            pathContent = '<rect x="4" y="4" width="16" height="16" fill="currentColor"/>';
                        } else if (pointShape === 'triangle') {
                            pathContent = '<polygon points="12,4 4,20 20,20" fill="currentColor"/>';
                        } else if (pointShape === 'star') {
                            pathContent = '<polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" fill="currentColor"/>';
                        }
                        svgEl.innerHTML = pathContent;
                    }
                });
                
                // İkon durumunu aktif yap
                pointIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-point');
                });
            }
            else if (layerType === 'line') {
                const lineColor = document.getElementById('lineColor').value;
                const lineWidth = document.getElementById('lineWidth').value;
                const lineType = document.getElementById('lineType').value;
                const lineIcons = layerItem.querySelectorAll('.layer-icon:nth-child(2)');
                
                lineIcons.forEach(icon => {
                    icon.style.color = lineColor;
                    
                    // Çizgi tipi görsel olarak yansıtılıyor
                    const paths = icon.querySelectorAll('path');
                    paths.forEach(path => {
                        path.setAttribute('stroke-width', lineWidth);
                        
                        const svgDashArray = calculateDashArray(lineType, lineWidth);
                        if (svgDashArray) {
                            path.setAttribute('stroke-dasharray', svgDashArray);
                        } else {
                            path.removeAttribute('stroke-dasharray');
                        }
                    });
                });
                
                // İkon durumunu aktif yap
                lineIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-line');
                });
            }
            else if (layerType === 'polygon') {
                const fillColor = document.getElementById('fillColor').value;
                const fillOpacity = document.getElementById('fillOpacity').value / 100;
                const strokeColor = document.getElementById('strokeColor').value;
                const strokeWidth = document.getElementById('strokeWidth').value;
                const strokeType = document.getElementById('strokeType').value;
                
                const polygonIcons = layerItem.querySelectorAll('.layer-icon:nth-child(3)');
                
                polygonIcons.forEach(icon => {
                    // Poligon rengini değiştir
                    icon.style.color = fillColor;
                    
                    // Poligon rengini ve kenar stilini güncelle
                    const shapes = icon.querySelectorAll('rect, polygon, path');
                    shapes.forEach(shape => {
                        shape.setAttribute('fill', fillColor);
                        shape.setAttribute('fill-opacity', fillOpacity);
                        shape.setAttribute('stroke', strokeColor);
                        shape.setAttribute('stroke-width', strokeWidth);
                        
                        // Kenar tipi
                        const svgStrokeDashArray = calculateDashArray(strokeType, strokeWidth);
                        if (svgStrokeDashArray) {
                            shape.setAttribute('stroke-dasharray', svgStrokeDashArray);
                        } else {
                            shape.removeAttribute('stroke-dasharray');
                        }
                    });
                });
                
                // İkon durumunu aktif yap
                polygonIcons.forEach(icon => {
                    icon.classList.remove('inactive');
                    icon.classList.add('active', 'icon-polygon');
                });
            }
            
            // Katmandaki çizimleri güncelle
            if (layerFeatures[layerId]) {
                console.log(`Katmandaki ${layerFeatures[layerId].length} çizim güncelleniyor`);
                
                // Seçilen tipe göre filtrele
                const filteredFeatures = layerType 
                    ? layerFeatures[layerId].filter(f => f.type === layerType)
                    : layerFeatures[layerId];
                
                filteredFeatures.forEach(feature => {
                    applyStyleToFeature(feature.id, feature.type);
                });
                
                console.log(`${filteredFeatures.length} çizim güncellendi`);
            } else {
                console.log(`Katmanda (${layerId}) çizim bulunamadı`);
            }
        }

        // Stil modalını kapat
        function closeStyleModal() {
            document.getElementById('styleModal').style.display = 'none';
        }
        
        // === YENİ FONKSİYONLAR ===
        
        // Context Menu Setup
        function setupContextMenu() {
            let contextTarget = null;
            
            // Katman üzerinde sağ tık
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.layer-item')) {
                    e.preventDefault();
                    contextTarget = e.target.closest('.layer-item');
                    showContextMenu(e.pageX, e.pageY);
                } else if (window.continuousPointMode && e.target.closest('#map')) {
                    // Harita üzerinde sağ tık - sürekli nokta modunu durdur
                    e.preventDefault();
                    stopContinuousPointMode();
                }
            });
            
            // Context menu'yu gizle
            document.addEventListener('click', function() {
                hideContextMenu();
            });
        }
        
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }
        
        function contextMenuAction(action) {
            const contextTarget = document.querySelector('.layer-item'); // Bu düzeltilmeli
            // Context menu actions here
            hideContextMenu();
        }
        
        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                    closeAllModals();
                    clearAllSelections();
                }
            });
        }
        
        // Search and Filter
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('layerSearch');
            // typeFilter kaldırıldı
            searchInput.addEventListener('input', function() {
                filterLayers();
            });
        }
        
        function filterLayers() {
            const searchTerm = document.getElementById('layerSearch').value.toLowerCase();
            document.querySelectorAll('.layer-item').forEach(item => {
                const layerName = item.querySelector('.layer-name').textContent.toLowerCase();
                const matchesSearch = searchTerm === '' || layerName.includes(searchTerm);
                item.style.display = matchesSearch ? 'flex' : 'none';
            });
            // Grup sayılarını güncelle
            document.querySelectorAll('.layer-group').forEach(group => {
                const groupItems = group.querySelector('.group-items');
                const visibleCount = groupItems.querySelectorAll('.layer-item:not([style*="display: none"])').length;
                const countElement = group.querySelector('.group-count');
                countElement.textContent = visibleCount;
            });
        }
        
        // Çizim buton ikonları
        function getDrawButtonIcon(title) {
            if (title.includes('marker') || title.includes('Marker')) return '📍';
            if (title.includes('polyline') || title.includes('line')) return '📏';
            if (title.includes('polygon')) return '⬟';
            if (title.includes('circle') || title.includes('Circle')) return '⭕';
            if (title.includes('rectangle') || title.includes('Rectangle')) return '⬜';
            if (title.includes('Edit')) return '✏️';
            if (title.includes('Delete')) return '🗑️';
            return '🔧';
        }

        // Dikdörtgen çizim fonksiyonu
        function startRectangleDrawing() {
            console.log('Dikdörtgen çizimi başlatılıyor...');
            window.drawingActiveLayerId = activeLayerId;
            
            // Leaflet Draw'ın rectangle özelliğini kullan
            if (window.drawControl && window.drawControl._toolbars && window.drawControl._toolbars.draw) {
                const rectangleTool = window.drawControl._toolbars.draw._modes.rectangle;
                if (rectangleTool && rectangleTool.handler) {
                    rectangleTool.handler.enable();
                } else {
                    console.error('Rectangle tool bulunamadı');
                }
            } else {
                console.error('Draw control bulunamadı');
            }
        }

        // Daire çizim fonksiyonu
        function startCircleDrawing() {
            console.log('Daire çizimi başlatılıyor...');
            window.drawingActiveLayerId = activeLayerId;
            
            // Leaflet Draw'ın circle özelliğini kullan
            if (window.drawControl && window.drawControl._toolbars && window.drawControl._toolbars.draw) {
                const circleTool = window.drawControl._toolbars.draw._modes.circle;
                if (circleTool && circleTool.handler) {
                    circleTool.handler.enable();
                } else {
                    console.error('Circle tool bulunamadı');
                }
            } else {
                console.error('Draw control bulunamadı');
            }
        }

        // Measurement Functions
        function startMeasurement(type) {
            console.log('startMeasurement çağrıldı:', type);
            console.log('measurementTools:', measurementTools);
            
            if (measurementTools) {
                // Tüm ölçüm butonlarını normal duruma çevir
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (type === 'distance') {
                    console.log('Mesafe ölçümü başlatılıyor...');
                    measurementTools.startDistance();
                    // Mesafe butonunu aktif yap
                    const distanceBtn = document.getElementById('distanceBtn');
                    if (distanceBtn) {
                        distanceBtn.classList.add('active');
                        console.log('Mesafe butonu aktif edildi');
                    }
                } else if (type === 'area') {
                    console.log('Alan ölçümü başlatılıyor...');
                    measurementTools.startArea();
                    // Alan butonunu aktif yap
                    const areaBtn = document.getElementById('areaBtn');
                    if (areaBtn) {
                        areaBtn.classList.add('active');
                        console.log('Alan butonu aktif edildi');
                    }
                }
            } else {
                console.error('measurementTools tanımlanmamış!');
                showNotification('Ölçüm sistemi yüklenemedi', 'error');
            }
        }
        
        function clearMeasurements() {
            if (measurementTools) {
                measurementTools.clearAll();
                
                // Tüm ölçüm butonlarını normal duruma çevir
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        }
        
        // Modal taşıma işlevselliği
        function initModalDragging() {
            const modal = document.getElementById('styleModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalHeader = modal.querySelector('.modal-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            modalHeader.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('close-btn')) return;
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === modalHeader || modalHeader.contains(e.target)) {
                    isDragging = true;
                    modalContent.style.transform = `translate(calc(-50% + ${xOffset}px), calc(-50% + ${yOffset}px))`;
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    modalContent.style.transform = `translate(calc(-50% + ${xOffset}px), calc(-50% + ${yOffset}px))`;
                }
            });
            
            document.addEventListener('mouseup', function() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            });
            
            // Modal kapandığında pozisyonu sıfırla
            modal.addEventListener('hide', function() {
                xOffset = 0;
                yOffset = 0;
                modalContent.style.transform = 'translate(-50%, -50%)';
            });
        }
        
        // Nokta stil tipi değişikliği
        function initPointStyleTypeToggle() {
            const pointStyleType = document.getElementById('pointStyleType');
            const customOptions = document.getElementById('customPointOptions');
            const iconOptions = document.getElementById('iconPointOptions');
            const iconCategory = document.getElementById('iconCategory');
            const styleMode = document.getElementById('styleMode');
            
            if (pointStyleType) {
                pointStyleType.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customOptions.style.display = 'block';
                        iconOptions.style.display = 'none';
                    } else {
                        customOptions.style.display = 'none';
                        iconOptions.style.display = 'block';
                        loadIconGrid();
                    }
                });
            }
            
            // İkon kategorisi değişikliğini dinle
            if (iconCategory) {
                iconCategory.addEventListener('change', function() {
                    loadIconGrid();
                });
            }
            
            // Stil modu değişikliğini dinle
            if (styleMode) {
                styleMode.addEventListener('change', function() {
                    handleStyleModeChange(this.value);
                });
            }
            
            // Stil modu toggle butonunu başlat
            initStyleModeToggle();
        }
        
        // Stil modu değişikliği handler'ı
        function handleStyleModeChange(mode) {
            console.log("=== Stil modu değişikliği başlıyor ===");
            console.log("Yeni mod:", mode);
            console.log("Aktif katman:", activeLayerId);
            
            if (mode === 'default') {
                // Varsayılan değerleri yükle ve kontrolları devre dışı bırak
                console.log("Varsayılan mod yükleniyor...");
                loadDefaultValues();
                setStyleControlsEnabled(false);
            } else {
                // Kullanıcı özel ayarları - kontrolları etkinleştir
                console.log("Kullanıcı özel mod yükleniyor...");
                setStyleControlsEnabled(true);
                console.log("Kontroller enable edildi");
                loadUserCustomValues();
                console.log("Kullanıcı özel değerler yüklendi");
                
                // Custom moda geçildiğinde mevcut değerleri kaydet
                setTimeout(() => {
                    saveUserCustomStyles();
                }, 100);
            }
            
            // Toggle butonunun görünümünü güncelle
            updateStyleModeToggleButton(mode);
            
            // Mod değişikliğinden sonra anında stil güncellemesi
            setTimeout(() => {
                try {
                    console.log("Stil modu değişikliği sonrası güncelleme başlıyor...");
                    
                    // Range display'leri güncelle
                    updateRangeDisplays();
                    
                    // Modal açıksa normal applyStyle kullan
                    const modal = document.getElementById('styleModal');
                    const isModalOpen = modal && modal.style.display !== 'none';
                    const hasModalLayerId = modal && modal.dataset.layerId;
                    
                    console.log("Modal durumu:", { isModalOpen, hasModalLayerId, activeLayerId });
                    
                    if (isModalOpen && hasModalLayerId) {
                        console.log("Modal açık, applyStyle kullanılıyor...");
                        applyStyle();
                    } else {
                        // Modal açık değilse aktif katmana stil uygula
                        if (activeLayerId) {
                            console.log("Modal açık değil, aktif katmana stil uygulanıyor...");
                            applyStyleToActiveLayer();
                        } else {
                            console.warn("Aktif katman bulunamadı, stil uygulanamıyor");
                        }
                    }
                    
                    // Etiket ayarları aktifse onları da güncelle
                    if (document.querySelector('#labelContent') && document.querySelector('#labelContent').style.display !== 'none') {
                        if (typeof applyLabelsToAllFeatures === 'function') {
                            applyLabelsToAllFeatures();
                        }
                    }
                    
                    // CRITICAL: Stil ayar modu göstergesini güncelle
                    if (activeLayerId) {
                        console.log(`Stil ayar modu göstergesi güncelleniyor: ${activeLayerId} -> ${mode}`);
                        updateLayerStyleModeIndicator(activeLayerId, mode);
                        showToast(`Stil ayar modu: ${mode === 'default' ? 'Sistem Varsayılanları' : 'Özelleştirilmiş'}`, 'info');
                    }
                } catch (error) {
                    console.error('Stil modu değişikliği sırasında hata:', error);
                }
            }, 100);
        }

        // Stil modu toggle butonu fonksiyonu
        function toggleStyleMode() {
            const styleModeSelect = document.getElementById('styleMode');
            if (!styleModeSelect) return;
            
            const currentMode = styleModeSelect.value;
            const newMode = currentMode === 'default' ? 'custom' : 'default';
            
            // Dropdown'ı güncelle
            styleModeSelect.value = newMode;
            
            // Mode değişikliğini işle
            handleStyleModeChange(newMode);
            
            // Animasyon efekti ekle
            const toggleButton = document.getElementById('styleModeToggle');
            if (toggleButton) {
                toggleButton.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    toggleButton.style.transform = 'scale(1)';
                }, 150);
            }
        }

        // Toggle butonunun görünümünü güncelleme fonksiyonu
        function updateStyleModeToggleButton(mode) {
            const toggleButton = document.getElementById('styleModeToggle');
            const iconElement = document.getElementById('styleModeIcon');
            
            if (!toggleButton || !iconElement) return;
            
            if (mode === 'custom') {
                // Kullanıcıya özel mod - personal ikonu
                iconElement.textContent = '👤';
                toggleButton.classList.add('custom-mode');
                toggleButton.title = 'Kullanıcıya Özel Ayarlar (Varsayılana Geç)';
            } else {
                // Varsayılan mod - kurumsal ikonu
                iconElement.textContent = '🏢';
                toggleButton.classList.remove('custom-mode');
                toggleButton.title = 'Varsayılan Kurumsal Ayarlar (Kişiselleştir)';
            }
        }

        // Sayfa yüklendiğinde toggle butonunu başlat
        function initStyleModeToggle() {
            const styleModeSelect = document.getElementById('styleMode');
            if (styleModeSelect) {
                // Başlangıç durumunu ayarla
                updateStyleModeToggleButton(styleModeSelect.value);
            }
        }

        // Katman stil modu göstergesine tıklama işlevi
        function toggleLayerStyleMode(layerId, event) {
            if (event) {
                event.stopPropagation(); // Katman seçimini engelle
            }
            
            const savedStyleModes = JSON.parse(localStorage.getItem('layerStyleModes') || '{}');
            const currentMode = savedStyleModes[layerId] || 'default';
            const newMode = currentMode === 'default' ? 'custom' : 'default';
            
            // Yeni modu kaydet
            savedStyleModes[layerId] = newMode;
            localStorage.setItem('layerStyleModes', JSON.stringify(savedStyleModes));
            
            // Göstergeyi güncelle
            updateLayerStyleModeIndicator(layerId, newMode);
            
            // Modal açıksa ve bu katman aktifse, modal'daki dropdown'ı da güncelle
            const modal = document.getElementById('styleModal');
            if (modal && modal.style.display !== 'none' && modal.dataset.layerId === layerId) {
                const styleModeSelect = document.getElementById('styleMode');
                if (styleModeSelect) {
                    styleModeSelect.value = newMode;
                    updateStyleModeToggleButton(newMode);
                    handleStyleModeChange(newMode);
                }
            }
            
            // Bildirim göster
            showNotification(`Stil modu: ${newMode === 'default' ? 'Kurumsal Ayarlar' : 'Kişisel Ayarlar'}`, 'info');
        }
        
                 // Varsayılan değerleri yükle
         function loadDefaultValues() {
             // Sistem varsayılan değerlerini uygula
             applySystemDefaults();
             showToast('Sistem varsayılan değerleri yüklendi', 'info');
         }
        
        // Kullanıcı özel değerlerini yükle
        function loadUserCustomValues() {
            console.log("=== loadUserCustomValues çağrıldı ===");
            
            // Kayıtlı kullanıcı ayarları varsa yükle, yoksa varsayılanları kullan
            const savedUserStyles = JSON.parse(localStorage.getItem('userCustomStyles') || '{}');
            
            console.log("Kayıtlı kullanıcı stilleri:", savedUserStyles);
            console.log("localStorage'da userCustomStyles:", localStorage.getItem('userCustomStyles'));
            
            if (Object.keys(savedUserStyles).length > 0) {
                // Kayıtlı ayarları yükle
                if (savedUserStyles.point) {
                    document.getElementById('pointColor').value = savedUserStyles.point.color || "#ff0000";
                    document.getElementById('pointSize').value = savedUserStyles.point.size || 8;
                    document.getElementById('pointShape').value = savedUserStyles.point.shape || "circle";
                    document.getElementById('pointOpacity').value = savedUserStyles.point.opacity || 100;
                    document.getElementById('pointStyleType').value = savedUserStyles.point.styleType || "custom";
                }
                
                if (savedUserStyles.line) {
                    document.getElementById('lineColor').value = savedUserStyles.line.color || "#ff7800";
                    document.getElementById('lineWidth').value = savedUserStyles.line.width || 3;
                    document.getElementById('lineOpacity').value = savedUserStyles.line.opacity || 100;
                    document.getElementById('lineType').value = savedUserStyles.line.lineType || "solid";
                }
                
                if (savedUserStyles.polygon) {
                    document.getElementById('fillColor').value = savedUserStyles.polygon.fillColor || "#3388ff";
                    document.getElementById('fillOpacity').value = savedUserStyles.polygon.fillOpacity || 50;
                    document.getElementById('strokeColor').value = savedUserStyles.polygon.strokeColor || "#000000";
                    document.getElementById('strokeWidth').value = savedUserStyles.polygon.strokeWidth || 1;
                    document.getElementById('strokeOpacity').value = savedUserStyles.polygon.strokeOpacity || 100;
                    document.getElementById('strokeType').value = savedUserStyles.polygon.strokeType || "solid";
                }
                
                updateRangeDisplays();
                showToast('Kayıtlı özel ayarlarınız yüklendi', 'success');
            } else {
                // İlk kez kullanıyorsa varsayılan değerleri yükle
                applySystemDefaults();
                showToast('Özel ayar modu etkinleştirildi', 'info');
            }
            
            // Değerler yüklendikten sonra stil güncellemesi yap
            setTimeout(() => {
                updateRangeDisplays();
            }, 50);
        }
        
        // Stil kontrollerini etkin/devre dışı bırak
        function setStyleControlsEnabled(enabled) {
            console.log("=== setStyleControlsEnabled çağrıldı ===");
            console.log("Enabled:", enabled);
            
            const controls = [
                'pointColor', 'pointSize', 'pointShape', 'pointOpacity', 'pointStyleType',
                'lineColor', 'lineWidth', 'lineOpacity', 'lineType',
                'fillColor', 'fillOpacity', 'strokeColor', 'strokeWidth', 'strokeOpacity', 'strokeType'
            ];
            
            let foundControls = 0;
            let missingControls = [];
            
            controls.forEach(controlId => {
                const control = document.getElementById(controlId);
                if (control) {
                    control.disabled = !enabled;
                    control.style.opacity = enabled ? '1' : '0.6';
                    foundControls++;
                } else {
                    missingControls.push(controlId);
                }
            });
            
            console.log(`Bulunan kontroller: ${foundControls}/${controls.length}`);
            if (missingControls.length > 0) {
                console.warn("Eksik kontroller:", missingControls);
            }
            
            // Icon grid kontrollerini de dahil et
            const iconControls = document.querySelectorAll('#iconPointOptions input, #iconPointOptions select');
            iconControls.forEach(control => {
                control.disabled = !enabled;
                control.style.opacity = enabled ? '1' : '0.6';
            });
        }
        
        // Rastgele isimler ata
        function generateRandomNames() {
            let assignedCount = 0;
            
            // Tüm çizilmiş öğelere rastgele isimler ata
            drawnLayers.forEach(layerInfo => {
                const layer = layerInfo.layer;
                const type = layerInfo.type;
                
                let randomName = '';
                if (type === 'point') {
                    randomName = randomNames.points[Math.floor(Math.random() * randomNames.points.length)];
                } else if (type === 'line') {
                    randomName = randomNames.lines[Math.floor(Math.random() * randomNames.lines.length)];
                } else if (type === 'polygon') {
                    randomName = randomNames.polygons[Math.floor(Math.random() * randomNames.polygons.length)];
                }
                
                // Özellik olarak sakla
                if (!layer.feature) layer.feature = {};
                if (!layer.feature.properties) layer.feature.properties = {};
                
                layer.feature.properties.name = randomName;
                layer.feature.properties.type = type;
                layer.feature.properties.id = layerInfo.id;
                
                // Alan ve uzunluk hesapla
                if (type === 'polygon' && layer.getLatLngs) {
                    const area = L.GeometryUtil ? L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) : 0;
                    layer.feature.properties.area = Math.round(area);
                } else if (type === 'line' && layer.getLatLngs) {
                    let length = 0;
                    const points = layer.getLatLngs();
                    for (let i = 0; i < points.length - 1; i++) {
                        length += points[i].distanceTo(points[i + 1]);
                    }
                    layer.feature.properties.length = Math.round(length);
                }
                
                assignedCount++;
            });
            
            showToast(`${assignedCount} çizime rastgele isim atandı`, 'success');
            
            // Etiket alanını "name" olarak ayarla
            document.getElementById('labelField').value = 'name';
            
            // Etiketleri göster
            if (document.getElementById('showLabels').checked) {
                applyLabelsToAllFeatures();
            }
        }
        
        // İkon gridi yükleme
        function loadIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            const category = document.getElementById('iconCategory').value;
            
            // Basit emoji ikonları kategoriler halinde
            const icons = {
                location: ['📍', '📌', '🗺️', '🎯', '🏠', '🏢'],
                transport: ['🚗', '🚌', '🚂', '✈️', '🚲', '⛵'],
                service: ['🏥', '🏪', '🏫', '🏛️', '⛽', '🏦'],
                nature: ['🌳', '🌲', '🏔️', '🏞️', '🌊', '🏜️'],
                building: ['🏠', '🏢', '🏭', '🏗️', '🏰', '⛪']
            };
            
            iconGrid.innerHTML = '';
            
            if (icons[category]) {
                icons[category].forEach(icon => {
                    const iconOption = document.createElement('div');
                    iconOption.className = 'icon-option';
                    iconOption.innerHTML = `<span style="font-size: 20px;">${icon}</span>`;
                    iconOption.addEventListener('click', function() {
                        // Tüm seçimleri kaldır
                        document.querySelectorAll('.icon-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Bu ikonu seç
                        this.classList.add('selected');
                        // Seçilen ikonu sakla
                        iconGrid.dataset.selectedIcon = icon;
                    });
                    iconGrid.appendChild(iconOption);
                });
                         }
         }
         
         // Etiket event listener'larını başlat
         function initLabelEventListeners() {
             const showLabels = document.getElementById('showLabels');
             const labelField = document.getElementById('labelField');
             const fontSize = document.getElementById('fontSize');
             const fontColor = document.getElementById('fontColor');
             const haloColor = document.getElementById('haloColor');
             const haloWidth = document.getElementById('haloWidth');
             const labelPosition = document.getElementById('labelPosition');
             
             // Event listener'ları sadece bir kez ekle
             if (!showLabels.hasAttribute('data-listeners-added')) {
                 // Anında güncelleme için wrapper fonksiyon
                 function handleLabelUpdate() {
                     if (window.labelUpdateTimeout) {
                         clearTimeout(window.labelUpdateTimeout);
                     }
                     window.labelUpdateTimeout = setTimeout(() => {
                         if (typeof applyLabelsToAllFeatures === 'function') {
                             applyLabelsToAllFeatures();
                         }
                     }, 100);
                 }
                 
                 showLabels.addEventListener('change', handleLabelUpdate);
                 labelField.addEventListener('change', handleLabelUpdate);
                 fontSize.addEventListener('input', handleLabelUpdate);
                 fontColor.addEventListener('change', handleLabelUpdate);
                 haloColor.addEventListener('change', handleLabelUpdate);
                 haloWidth.addEventListener('input', handleLabelUpdate);
                 labelPosition.addEventListener('change', handleLabelUpdate);
                 
                 // İşaretleme
                 showLabels.setAttribute('data-listeners-added', 'true');
             }
         }
         
 

         
 

                 

        
        function closeAllModals() {
            document.getElementById('styleModal').style.display = 'none';
            document.getElementById('queryModal').style.display = 'none';
            document.getElementById('layerDetailsModal').style.display = 'none';
            document.getElementById('createModal').style.display = 'none';
        }
        
        // Keyboard event handlers
        document.addEventListener('keydown', function(e) {
            // Enter tuşu ile modal onaylama
            if (e.key === 'Enter' && document.getElementById('createModal').style.display === 'block') {
                e.preventDefault();
                confirmCreate();
            }
            
            // ESC tuşu ile sürekli nokta çizim modunu durdur
            if (e.key === 'Escape' && window.continuousPointMode) {
                e.preventDefault();
                stopContinuousPointMode();
            }
        });
        
        // === KOORDİNAT VE ÖLÇEK SİSTEMİ ===
        
        // Mevcut projeksiyon sistemi
        let currentProjection = 'EPSG:4326';
        
        // Ölçek her zaman dinamik olarak hesaplanır
        
        // Koordinat gösterimi
        function setupCoordinateDisplay() {
            map.on('mousemove', function(e) {
                updateCoordinateDisplay(e.latlng);
            });
            
            map.on('click', function(e) {
                // Ölçüm modu aktifse koordinat güncellemesini yapma
                if (measurementTools && measurementTools.isActive) {
                    console.log('Ölçüm modu aktif, koordinat güncellemesi atlandı');
                    return;
                }
                updateCoordinateDisplay(e.latlng);
            });
        }
        
        // Koordinatları güncelle
        function updateCoordinateDisplay(latlng) {
            const coords = convertCoordinates(latlng, currentProjection);
            
            document.getElementById('coordinateX').textContent = `X: ${coords.x}`;
            document.getElementById('coordinateY').textContent = `Y: ${coords.y}`;
        }
        
        // Koordinat dönüştürme
        function convertCoordinates(latlng, targetProjection) {
            let x, y;
            
            switch(targetProjection) {
                case 'EPSG:4326': // WGS84
                    x = latlng.lng.toFixed(6);
                    y = latlng.lat.toFixed(6);
                    break;
                    
                case 'EPSG:3857': // Web Mercator
                    const webMercator = proj4('EPSG:4326', 'EPSG:3857', [latlng.lng, latlng.lat]);
                    x = webMercator[0].toFixed(2);
                    y = webMercator[1].toFixed(2);
                    break;
                    
                case 'EPSG:5254': // ITRF96 / UTM 35N
                    const itrf96 = proj4('EPSG:4326', 'EPSG:5254', [latlng.lng, latlng.lat]);
                    x = itrf96[0].toFixed(2);
                    y = itrf96[1].toFixed(2);
                    break;
                    
                case 'EPSG:2320': // ED50 / TM30
                    const ed50 = proj4('EPSG:4326', 'EPSG:2320', [latlng.lng, latlng.lat]);
                    x = ed50[0].toFixed(2);
                    y = ed50[1].toFixed(2);
                    break;
                    
                case 'EPSG:32635': // WGS84 / UTM 35N
                    const utm35n = proj4('EPSG:4326', 'EPSG:32635', [latlng.lng, latlng.lat]);
                    x = utm35n[0].toFixed(2);
                    y = utm35n[1].toFixed(2);
                    break;
                    
                case 'EPSG:32636': // WGS84 / UTM 36N
                    const utm36n = proj4('EPSG:4326', 'EPSG:32636', [latlng.lng, latlng.lat]);
                    x = utm36n[0].toFixed(2);
                    y = utm36n[1].toFixed(2);
                    break;
                    
                default:
                    x = latlng.lng.toFixed(6);
                    y = latlng.lat.toFixed(6);
            }
            
            return { x, y };
        }
        
        // Ölçek gösterimi
        function setupScaleDisplay() {
            map.on('zoomend', function() {
                // Her zoom değişikliğinde ölçeği güncelle
                updateScaleDisplay();
            });
            
            map.on('moveend', updateScaleDisplay);
            
            // İlk yükleme
            updateScaleDisplay();
        }
        
        // Ölçeği güncelle
        function updateScaleDisplay() {
            const zoom = map.getZoom();
            const center = map.getCenter();
            const scale = getScaleFromZoom(zoom, center.lat);
            
            document.getElementById('scaleText').textContent = `1:${Math.round(scale).toLocaleString()}`;
            updateScaleBar(Math.round(scale));
        }
        
        // Zoom seviyesinden ölçek hesaplama
        function getScaleFromZoom(zoom, latitude) {
            // Leaflet'in kullandığı gerçek formül
            const earthCircumference = 40075016.686; // metre
            const latRad = latitude * Math.PI / 180;
            
            // Zoom seviyesinde 1 pikselin karşılık geldiği metre
            const metersPerPixel = earthCircumference * Math.cos(latRad) / Math.pow(2, zoom + 8);
            
            // Ölçek hesaplama (96 DPI)
            const scale = metersPerPixel * 96 / 0.0254;
            
            return scale;
        }
        
        // Ölçek çubuğunu güncelle
        function updateScaleBar(scale) {
            const scaleBar = document.getElementById('scaleBar');
            
            // Ölçek çubuğu için uygun mesafe hesapla
            let distance, unit;
            
            if (scale > 1000000) {
                distance = Math.round(scale / 1000000);
                unit = 'km';
            } else if (scale > 1000) {
                distance = Math.round(scale / 1000);
                unit = 'km';
            } else {
                distance = Math.round(scale);
                unit = 'm';
            }
            
            // Çubuğun genişliğini ayarla (100px sabit)
            scaleBar.style.width = '100px';
            
            // Çubuk üzerine mesafe bilgisini ekle
            scaleBar.title = `${distance} ${unit}`;
        }
        
        // Projeksiyon sistemi kurulumu
        function setupProjectionSystem() {
            // Proj4 tanımlamaları
            if (typeof proj4 !== 'undefined') {
                // Türkiye için yaygın projeksiyon sistemleri
                proj4.defs('EPSG:5254', '+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
                proj4.defs('EPSG:2320', '+proj=tmerc +lat_0=0 +lon_0=30 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs');
                proj4.defs('EPSG:32635', '+proj=utm +zone=35 +datum=WGS84 +units=m +no_defs');
                proj4.defs('EPSG:32636', '+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs');
            }
            
            // Varsayılan projeksiyon seç
            document.getElementById('projectionSelect').value = currentProjection;
        }
        
        // Projeksiyon değiştirme
        function changeProjection() {
            const newProjection = document.getElementById('projectionSelect').value;
            currentProjection = newProjection;
            
            // Mevcut mouse pozisyonunu güncelle
            const center = map.getCenter();
            updateCoordinateDisplay(center);
            
            showToast(`Projeksiyon sistemi ${newProjection} olarak değiştirildi`, 'info');
        }
        
        // Çift tıklama (artık gereksiz)
        function switchToDynamicScale() {
            showToast('Ölçek zaten dinamik olarak hesaplanıyor', 'info');
        }
        
        // === ÖLÇEK SEÇİCİ FONKSİYONLARI ===
        
        // Ölçek seçiciyi aç/kapat
        function toggleScaleSelector(event) {
            const selector = document.getElementById('scaleSelector');
            const scaleText = document.getElementById('scaleText');
            
            if (selector.classList.contains('show')) {
                selector.classList.remove('show');
            } else {
                // Önce menüyü göster ki boyutlarını alabilelim
                selector.style.display = 'block';
                selector.style.visibility = 'hidden';
                
                // Tıklanan elementin pozisyonunu al
                const rect = scaleText.getBoundingClientRect();
                
                // Menü boyutlarını al
                const selectorWidth = selector.offsetWidth;
                const selectorHeight = selector.offsetHeight;
                
                // Başlangıç pozisyonu: tıklanan yerin altı
                let left = rect.left;
                let top = rect.bottom + 5;
                
                // Ekran sınırlarını kontrol et
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // Sağ taraftan taşıyorsa sola kaydır
                if (left + selectorWidth > windowWidth) {
                    left = windowWidth - selectorWidth - 10;
                }
                
                // Sol taraftan taşıyorsa sağa kaydır
                if (left < 10) {
                    left = 10;
                }
                
                // Alt taraftan taşıyorsa üste aç
                if (top + selectorHeight > windowHeight) {
                    top = rect.top - selectorHeight - 5;
                }
                
                // Üst taraftan da taşıyorsa en üstte aç
                if (top < 10) {
                    top = 10;
                }
                
                // Pozisyonu ayarla
                selector.style.left = left + 'px';
                selector.style.top = top + 'px';
                
                // Görünür yap
                selector.style.visibility = 'visible';
                selector.classList.add('show');
                
                // Mevcut ölçeği işaretle
                updateCurrentScaleOption();
            }
            
            // Event'in yayılmasını engelle
            if (event) {
                event.stopPropagation();
            }
        }
        
        // Mevcut ölçek seçeneğini işaretle
        function updateCurrentScaleOption() {
            const options = document.querySelectorAll('.scale-option');
            options.forEach(option => option.classList.remove('current'));
            
            // Dinamik ölçek seçeneğini işaretle
            const dynamicOption = document.querySelector('.scale-option strong');
            if (dynamicOption) {
                dynamicOption.parentElement.classList.add('current');
            }
        }
        
        // Sabit ölçek ayarla
        function setFixedScale(scaleValue) {
            const center = map.getCenter();
            
            // Hedef ölçeğe tam karşılık gelen ondalık zoom seviyesini hesapla
            const exactZoom = getZoomFromScale(scaleValue, center.lat);
            
            console.log(`Hedef ölçek: 1:${scaleValue.toLocaleString()}`);
            console.log(`Hesaplanan zoom: ${exactZoom.toFixed(3)}`);
            console.log(`Enlem: ${center.lat.toFixed(4)}`);
            
            // Leaflet ondalık zoom destekliyor, direkt kullan
            map.setZoom(exactZoom);
            
            // Zoom ayarlandıktan sonra gerçek ölçeği kontrol et
            setTimeout(() => {
                const actualZoom = map.getZoom();
                const actualScale = getScaleFromZoom(actualZoom, center.lat);
                const difference = Math.abs(actualScale - scaleValue);
                const percentDiff = ((difference / scaleValue) * 100).toFixed(1);
                
                console.log(`Gerçek zoom: ${actualZoom.toFixed(3)}`);
                console.log(`Gerçek ölçek: 1:${Math.round(actualScale).toLocaleString()}`);
                console.log(`Fark: %${percentDiff}`);
                
                if (percentDiff > 5) {
                    showToast(`Ölçek ayarlandı: 1:${Math.round(actualScale).toLocaleString()} (hedef: 1:${scaleValue.toLocaleString()})`, 'warning');
                } else {
                    showToast(`Ölçek başarıyla ayarlandı: 1:${Math.round(actualScale).toLocaleString()}`, 'success');
                }
            }, 200);
            
            // Seçiciyi kapat
            const selector = document.getElementById('scaleSelector');
            selector.classList.remove('show');
            selector.style.display = 'none';
        }
        
        // Dinamik ölçek (artık her zaman dinamik)
        function setDynamicScale() {
            // Seçiciyi kapat
            const selector = document.getElementById('scaleSelector');
            selector.classList.remove('show');
            selector.style.display = 'none';
            
            // Toast mesajı
            showToast('Ölçek dinamik olarak hesaplanıyor', 'info');
        }
        
        // Ölçekten zoom seviyesi hesapla
        function getZoomFromScale(targetScale, latitude) {
            // Hedef ölçekten metre/piksel hesaplama
            const targetMetersPerPixel = targetScale * 0.0254 / 96;
            
            // Leaflet'in kullandığı formül
            const earthCircumference = 40075016.686; // metre
            const latRad = latitude * Math.PI / 180;
            
            // Zoom = log2(earthCircumference * cos(lat) / metre/piksel) - 8
            const zoom = Math.log2(earthCircumference * Math.cos(latRad) / targetMetersPerPixel) - 8;
            
            // Zoom seviyesini Leaflet'in desteklediği aralığa sınırla
            return Math.max(1, Math.min(18, zoom));
        }
        
        // Dışarı tıklandığında ölçek seçiciyi kapat
        document.addEventListener('click', function(e) {
            const scaleSelector = document.getElementById('scaleSelector');
            const scaleText = document.getElementById('scaleText');
            
            if (scaleSelector && !scaleSelector.contains(e.target) && e.target !== scaleText) {
                scaleSelector.classList.remove('show');
                scaleSelector.style.display = 'none';
            }
        });

        // === LEJANT FONKSİYONLARI ===
        
        let legendVisible = false;
        let legendCollapsed = false;
        let legendDragData = null;

        // Lejantı aç/kapat
        function toggleLegend() {
            const legendContainer = document.getElementById('legendContainer');
            const legendBtn = document.getElementById('legendBtn');
            
            legendVisible = !legendVisible;
            
            if (legendVisible) {
                legendContainer.style.display = 'block';
                legendBtn.classList.add('active');
                legendBtn.title = 'Lejant Kapat';
                updateLegendContent();
            } else {
                legendContainer.style.display = 'none';
                legendBtn.classList.remove('active');
                legendBtn.title = 'Lejant Aç';
            }
        }

        // Lejantı kapat
        function closeLegend() {
            legendVisible = false;
            document.getElementById('legendContainer').style.display = 'none';
            const legendBtn = document.getElementById('legendBtn');
            if (legendBtn) {
                legendBtn.classList.remove('active');
                legendBtn.title = 'Lejant Aç';
            }
        }

        // Lejant içeriğini daralt/genişlet
        function toggleLegendContent() {
            const legendContent = document.getElementById('legendContent');
            const collapseBtn = document.getElementById('legendCollapseBtn');
            
            legendCollapsed = !legendCollapsed;
            
            if (legendCollapsed) {
                legendContent.classList.add('collapsed');
                collapseBtn.textContent = '+';
            } else {
                legendContent.classList.remove('collapsed');
                collapseBtn.textContent = '−';
            }
        }

        // Lejant ayarlarını aç/kapat
        function toggleLegendSettings() {
            const legendSettings = document.getElementById('legendSettings');
            const settingsBtn = document.getElementById('legendSettingsBtn');
            
            if (legendSettings.style.display === 'none') {
                legendSettings.style.display = 'block';
                settingsBtn.style.background = 'rgba(255,255,255,0.3)';
            } else {
                legendSettings.style.display = 'none';
                settingsBtn.style.background = 'none';
            }
        }

        // Lejant sembol boyutu display'ini güncelle
        function updateLegendSymbolSizeDisplay() {
            const sizeInput = document.getElementById('legendSymbolSize');
            const sizeDisplay = document.getElementById('legendSymbolSizeDisplay');
            if (sizeInput && sizeDisplay) {
                sizeDisplay.textContent = sizeInput.value + 'x';
            }
        }

        // Katmandaki gerçek stilleri al
        function getLayerActualStyles(layerId) {
            const features = layerFeatures[layerId] || [];
            const styles = {
                point: { color: '#3388ff', size: 8, shape: 'circle', opacity: 1 },
                line: { color: '#ff7800', width: 3, opacity: 1, type: 'solid' },
                polygon: { fillColor: '#3388ff', fillOpacity: 0.5, strokeColor: '#000000', strokeWidth: 1, strokeOpacity: 1, strokeType: 'solid' }
            };
            
            // İlk çizimden stil bilgilerini al
            features.forEach(feature => {
                if (feature.layer && feature.layer.options && feature.layer.options.styleInfo) {
                    const styleInfo = feature.layer.options.styleInfo;
                    
                    if (feature.type === 'point' && styleInfo.type === 'point') {
                        styles.point = {
                            color: styleInfo.color || styles.point.color,
                            size: styleInfo.size || styles.point.size,
                            shape: styleInfo.shape || styles.point.shape,
                            opacity: styleInfo.opacity || styles.point.opacity
                        };
                    } else if (feature.type === 'line' && styleInfo.type === 'line') {
                        styles.line = {
                            color: styleInfo.color || styles.line.color,
                            width: styleInfo.width || styles.line.width,
                            opacity: styleInfo.opacity || styles.line.opacity,
                            type: styleInfo.lineType || styles.line.type
                        };
                    } else if (feature.type === 'polygon' && styleInfo.type === 'polygon') {
                        styles.polygon = {
                            fillColor: styleInfo.fillColor || styles.polygon.fillColor,
                            fillOpacity: styleInfo.fillOpacity || styles.polygon.fillOpacity,
                            strokeColor: styleInfo.strokeColor || styles.polygon.strokeColor,
                            strokeWidth: styleInfo.strokeWidth || styles.polygon.strokeWidth,
                            strokeOpacity: styleInfo.strokeOpacity || styles.polygon.strokeOpacity,
                            strokeType: styleInfo.strokeType || styles.polygon.strokeType
                        };
                    }
                } else if (feature.layer) {
                    // Doğrudan layer özelliklerinden al
                    if (feature.type === 'line' && feature.layer.options) {
                        styles.line = {
                            color: feature.layer.options.color || styles.line.color,
                            width: feature.layer.options.weight || styles.line.width,
                            opacity: feature.layer.options.opacity || styles.line.opacity,
                            type: detectLineTypeFromDashArray(feature.layer.options.dashArray)
                        };
                    } else if (feature.type === 'polygon' && feature.layer.options) {
                        styles.polygon = {
                            fillColor: feature.layer.options.fillColor || styles.polygon.fillColor,
                            fillOpacity: feature.layer.options.fillOpacity || styles.polygon.fillOpacity,
                            strokeColor: feature.layer.options.color || styles.polygon.strokeColor,
                            strokeWidth: feature.layer.options.weight || styles.polygon.strokeWidth,
                            strokeOpacity: feature.layer.options.opacity || styles.polygon.strokeOpacity,
                            strokeType: detectLineTypeFromDashArray(feature.layer.options.dashArray)
                        };
                    }
                }
            });
            
            return styles;
        }

        // Lejant içeriğini güncelle
        function updateLegendContent() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            // Ayarları al
            const showEmptyLayers = document.getElementById('showEmptyLayers').checked;
            const showTypeLabels = document.getElementById('showTypeLabels').checked;
            const showOnlyVisible = document.getElementById('showOnlyVisible').checked;
            const showSelectedOnly = document.getElementById('showSelectedOnly').checked;
            const symbolScale = parseFloat(document.getElementById('legendSymbolSize').value);

            // Görünür katmanları topla
            const visibleLayers = [];
            
            // DOM'dan katmanları al
            const layerItems = document.querySelectorAll('.layer-item');
            layerItems.forEach(layerItem => {
                const checkbox = layerItem.querySelector('.layer-visibility');
                const groupElement = layerItem.closest('.layer-group');
                const isSelected = layerItem.classList.contains('selected-highlight');
                
                // Filtre koşulları
                let shouldShow = true;
                
                // Sadece seçili katmanı göster ayarı
                if (showSelectedOnly && !isSelected) {
                    shouldShow = false;
                }
                
                // Sadece görünür katmanları göster ayarı
                if (showOnlyVisible && (!checkbox || !checkbox.checked)) {
                    shouldShow = false;
                }
                
                if (shouldShow) {
                    const layerId = layerItem.getAttribute('data-layer-id');
                    const layerName = layerItem.querySelector('.layer-name').textContent;
                    const groupName = groupElement.querySelector('.group-name').textContent;
                    
                    // Katmandaki çizim tiplerini kontrol et
                    const features = layerFeatures[layerId] || [];
                    const hasPoint = features.some(f => f.type === 'point');
                    const hasLine = features.some(f => f.type === 'line');
                    const hasPolygon = features.some(f => f.type === 'polygon');
                    const isEmpty = features.length === 0;
                    
                    // Boş katmanları gösterme ayarına göre filtrele
                    if (!isEmpty || showEmptyLayers) {
                        const actualStyles = getLayerActualStyles(layerId);
                        visibleLayers.push({
                            name: layerName,
                            group: groupName,
                            hasPoint,
                            hasLine,
                            hasPolygon,
                            features: features,
                            isEmpty: isEmpty,
                            isVisible: checkbox && checkbox.checked,
                            isSelected: isSelected,
                            layerId: layerId,
                            styles: actualStyles
                        });
                    }
                }
            });

            if (visibleLayers.length === 0) {
                legendItems.innerHTML = '<div style="text-align: center; color: #666; font-style: italic; padding: 20px;">Görünür katman yok</div>';
                return;
            }

            // Gruplara göre organize et
            const groupedLayers = {};
            visibleLayers.forEach(layer => {
                if (!groupedLayers[layer.group]) {
                    groupedLayers[layer.group] = [];
                }
                groupedLayers[layer.group].push(layer);
            });

            // Lejant öğelerini oluştur
            Object.keys(groupedLayers).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'legend-group';
                
                const groupTitle = document.createElement('div');
                groupTitle.className = 'legend-group-title';
                groupTitle.textContent = groupName;
                groupDiv.appendChild(groupTitle);

                groupedLayers[groupName].forEach(layer => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'legend-item';
                    
                    // Seçili katman vurgusu
                    if (layer.isSelected) {
                        itemDiv.style.backgroundColor = '#e3f2fd';
                        itemDiv.style.border = '1px solid #2196f3';
                        itemDiv.style.borderRadius = '4px';
                        itemDiv.style.padding = '4px';
                    }
                    
                    // Görünür olmayan katman için soluk görünüm
                    if (!layer.isVisible) {
                        itemDiv.style.opacity = '0.5';
                    }
                    
                    // Katman adı ve semboller
                    const headerDiv = document.createElement('div');
                    headerDiv.style.display = 'flex';
                    headerDiv.style.alignItems = 'center';
                    headerDiv.style.marginBottom = showTypeLabels ? '4px' : '0';
                    
                    // Semboller (sadece görsel, yazı yok)
                    if (!layer.isEmpty) {
                        const symbolsDiv = document.createElement('div');
                        symbolsDiv.style.display = 'flex';
                        symbolsDiv.style.gap = '4px';
                        symbolsDiv.style.marginRight = '8px';
                        
                        if (layer.hasPoint) {
                            const pointStyle = layer.styles.point;
                            const pointSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const pointColor = pointStyle.color;
                            const pointSize = Math.round(pointStyle.size * symbolScale * 0.8); // Lejant için biraz küçült
                            const pointOpacity = pointStyle.opacity;
                            
                            pointSymbol.style.backgroundColor = pointColor;
                            pointSymbol.style.opacity = pointOpacity;
                            pointSymbol.style.width = pointSize + 'px';
                            pointSymbol.style.height = pointSize + 'px';
                            
                            // Şekle göre stil
                            if (pointStyle.shape === 'circle') {
                                pointSymbol.style.borderRadius = '50%';
                            } else if (pointStyle.shape === 'square') {
                                pointSymbol.style.borderRadius = '0';
                            } else if (pointStyle.shape === 'triangle') {
                                // Üçgen için özel CSS
                                pointSymbol.style.width = '0';
                                pointSymbol.style.height = '0';
                                pointSymbol.style.backgroundColor = 'transparent';
                                pointSymbol.style.borderLeft = `${pointSize/2}px solid transparent`;
                                pointSymbol.style.borderRight = `${pointSize/2}px solid transparent`;
                                pointSymbol.style.borderBottom = `${pointSize}px solid ${pointColor}`;
                            }
                            
                            symbolsDiv.appendChild(pointSymbol);
                        }
                        
                        if (layer.hasLine) {
                            const lineStyle = layer.styles.line;
                            const lineSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const lineColor = lineStyle.color;
                            const lineWidth = Math.max(1, Math.round(lineStyle.width * symbolScale * 0.5)); // Lejant için küçült
                            const lineOpacity = lineStyle.opacity;
                            const lineType = lineStyle.type;
                            
                            lineSymbol.style.backgroundColor = lineColor;
                            lineSymbol.style.opacity = lineOpacity;
                            lineSymbol.style.height = lineWidth + 'px';
                            lineSymbol.style.width = Math.round(12 * symbolScale) + 'px';
                            lineSymbol.style.marginTop = '3px';
                            
                            // Çizgi tipine göre border pattern
                            if (lineType === 'dashed') {
                                lineSymbol.style.background = `repeating-linear-gradient(to right, ${lineColor} 0px, ${lineColor} 4px, transparent 4px, transparent 6px)`;
                            } else if (lineType === 'dotted') {
                                lineSymbol.style.background = `repeating-linear-gradient(to right, ${lineColor} 0px, ${lineColor} 2px, transparent 2px, transparent 4px)`;
                            }
                            
                            symbolsDiv.appendChild(lineSymbol);
                        }
                        
                        if (layer.hasPolygon) {
                            const polygonStyle = layer.styles.polygon;
                            const polygonSymbol = document.createElement('div');
                            
                            // Gerçek stil değerlerini kullan
                            const fillColor = polygonStyle.fillColor;
                            const fillOpacity = polygonStyle.fillOpacity;
                            const strokeColor = polygonStyle.strokeColor;
                            const strokeWidth = Math.max(1, Math.round(polygonStyle.strokeWidth * symbolScale));
                            const strokeOpacity = polygonStyle.strokeOpacity;
                            const strokeType = polygonStyle.strokeType;
                            
                            const rgba = hexToRgba(fillColor, fillOpacity);
                            polygonSymbol.style.backgroundColor = rgba;
                            polygonSymbol.style.border = `${strokeWidth}px solid ${strokeColor}`;
                            polygonSymbol.style.width = Math.round(10 * symbolScale) + 'px';
                            polygonSymbol.style.height = Math.round(8 * symbolScale) + 'px';
                            
                            // Kenar tipine göre border style
                            if (strokeType === 'dashed') {
                                polygonSymbol.style.borderStyle = 'dashed';
                            } else if (strokeType === 'dotted') {
                                polygonSymbol.style.borderStyle = 'dotted';
                            }
                            
                            symbolsDiv.appendChild(polygonSymbol);
                        }
                        
                        headerDiv.appendChild(symbolsDiv);
                    }
                    
                    // Katman adı
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'legend-label';
                    labelDiv.textContent = layer.name;
                    labelDiv.style.fontWeight = '400';
                    labelDiv.style.fontSize = '12px';
                    labelDiv.style.flex = '1';
                    headerDiv.appendChild(labelDiv);
                    
                    itemDiv.appendChild(headerDiv);
                    
                    // Boş katman kontrolü
                    if (layer.isEmpty) {
                        const emptyItem = document.createElement('div');
                        emptyItem.style.marginLeft = '10px';
                        emptyItem.style.fontSize = '11px';
                        emptyItem.style.color = '#999';
                        emptyItem.style.fontStyle = 'italic';
                        emptyItem.textContent = 'Henüz çizim yok';
                        itemDiv.appendChild(emptyItem);
                    } else if (showTypeLabels) {
                        // Çizim tiplerini yazı ile göster (sadece ayar açıksa)
                        if (layer.hasPoint) {
                            const pointItem = document.createElement('div');
                            pointItem.style.display = 'flex';
                            pointItem.style.alignItems = 'center';
                            pointItem.style.marginBottom = '2px';
                            pointItem.style.marginLeft = '10px';
                            
                            const pointSymbol = document.createElement('div');
                            pointSymbol.style.backgroundColor = '#3388ff';
                            pointSymbol.style.borderRadius = '50%';
                            pointSymbol.style.width = '8px';
                            pointSymbol.style.height = '8px';
                            pointSymbol.style.marginRight = '6px';
                            
                            const pointLabel = document.createElement('span');
                            pointLabel.textContent = 'Nokta';
                            pointLabel.style.fontSize = '11px';
                            pointLabel.style.color = '#666';
                            
                            pointItem.appendChild(pointSymbol);
                            pointItem.appendChild(pointLabel);
                            itemDiv.appendChild(pointItem);
                        }
                        
                        if (layer.hasLine) {
                            const lineItem = document.createElement('div');
                            lineItem.style.display = 'flex';
                            lineItem.style.alignItems = 'center';
                            lineItem.style.marginBottom = '2px';
                            lineItem.style.marginLeft = '10px';
                            
                            const lineSymbol = document.createElement('div');
                            lineSymbol.style.backgroundColor = '#ff7800';
                            lineSymbol.style.height = '2px';
                            lineSymbol.style.width = '12px';
                            lineSymbol.style.marginRight = '6px';
                            lineSymbol.style.marginTop = '0';
                            
                            const lineLabel = document.createElement('span');
                            lineLabel.textContent = 'Çizgi';
                            lineLabel.style.fontSize = '11px';
                            lineLabel.style.color = '#666';
                            
                            lineItem.appendChild(lineSymbol);
                            lineItem.appendChild(lineLabel);
                            itemDiv.appendChild(lineItem);
                        }
                        
                        if (layer.hasPolygon) {
                            const polygonItem = document.createElement('div');
                            polygonItem.style.display = 'flex';
                            polygonItem.style.alignItems = 'center';
                            polygonItem.style.marginBottom = '2px';
                            polygonItem.style.marginLeft = '10px';
                            
                            const polygonSymbol = document.createElement('div');
                            polygonSymbol.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                            polygonSymbol.style.border = '1px solid #ff0000';
                            polygonSymbol.style.width = '12px';
                            polygonSymbol.style.height = '8px';
                            polygonSymbol.style.marginRight = '6px';
                            
                            const polygonLabel = document.createElement('span');
                            polygonLabel.textContent = 'Alan';
                            polygonLabel.style.fontSize = '11px';
                            polygonLabel.style.color = '#666';
                            
                            polygonItem.appendChild(polygonSymbol);
                            polygonItem.appendChild(polygonLabel);
                            itemDiv.appendChild(polygonItem);
                        }
                    }

                    groupDiv.appendChild(itemDiv);
                });

                legendItems.appendChild(groupDiv);
            });
        }

        // Varsayılan stil al
        function getDefaultStyle(layerType) {
            const defaultStyles = {
                point: { color: '#3388ff', fillColor: '#3388ff' },
                line: { color: '#3388ff' },
                polygon: { color: '#3388ff', fillColor: '#3388ff' }
            };
            return defaultStyles[layerType] || defaultStyles.point;
        }

        // Lejant sürükleme işlevselliği
        function initLegendDragging() {
            const legendHeader = document.getElementById('legendHeader');
            const legendContainer = document.getElementById('legendContainer');
            
            legendHeader.addEventListener('mousedown', function(e) {
                legendDragData = {
                    isDragging: true,
                    startX: e.clientX,
                    startY: e.clientY,
                    startLeft: legendContainer.offsetLeft,
                    startTop: legendContainer.offsetTop
                };
                
                document.addEventListener('mousemove', handleLegendDrag);
                document.addEventListener('mouseup', handleLegendDragEnd);
                
                e.preventDefault();
            });
        }

        function handleLegendDrag(e) {
            if (!legendDragData || !legendDragData.isDragging) return;
            
            const deltaX = e.clientX - legendDragData.startX;
            const deltaY = e.clientY - legendDragData.startY;
            
            const newLeft = legendDragData.startLeft + deltaX;
            const newTop = legendDragData.startTop + deltaY;
            
            const legendContainer = document.getElementById('legendContainer');
            const maxLeft = window.innerWidth - legendContainer.offsetWidth;
            const maxTop = window.innerHeight - legendContainer.offsetHeight;
            
            legendContainer.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + 'px';
            legendContainer.style.top = Math.max(0, Math.min(maxTop, newTop)) + 'px';
        }

        function handleLegendDragEnd() {
            legendDragData = null;
            document.removeEventListener('mousemove', handleLegendDrag);
            document.removeEventListener('mouseup', handleLegendDragEnd);
        }

        // ===== ÖLÇÜM AYARLARI FONKSİYONLARI =====
        
        // Ölçüm ayarları modalını aç
        function openMeasurementSettings() {
            const modal = document.getElementById('measurementSettingsModal');
            if (modal) {
                modal.style.display = 'block';
                // Mevcut ayarları modal elementlerine yükle
                loadMeasurementSettingsToModal();
                showNotification('Ölçüm ayarları açıldı', 'info');
            }
        }
        
        // Ölçüm ayarları modalını kapat
        function closeMeasurementSettings() {
            const modal = document.getElementById('measurementSettingsModal');
            if (modal) {
                modal.style.display = 'none';
                showNotification('Ölçüm ayarları kaydedildi', 'success');
            }
        }
        
        // Mevcut ayarları modal'a yükle
        function loadMeasurementSettingsToModal() {
            // Mesafe etiket pozisyonu
            const distancePosSelect = document.getElementById('distanceLabelPosition');
            if (distancePosSelect) {
                distancePosSelect.value = MeasurementSettings.distance.labelPosition;
            }
            
            // Alan etiket pozisyonu
            const areaPosSelect = document.getElementById('areaLabelPosition');
            if (areaPosSelect) {
                areaPosSelect.value = MeasurementSettings.area.labelPosition;
            }
            
            // Segment sıklığı
            const segmentFreq = document.getElementById('segmentLabelFrequency');
            const segmentFreqValue = document.getElementById('segmentFrequencyValue');
            if (segmentFreq && segmentFreqValue) {
                segmentFreq.value = MeasurementSettings.labels.frequency;
                segmentFreqValue.textContent = MeasurementSettings.labels.frequency;
            }
            
            // Minimum segment uzunluğu
            const minSegment = document.getElementById('minSegmentLength');
            const minSegmentValue = document.getElementById('minSegmentValue');
            if (minSegment && minSegmentValue) {
                minSegment.value = MeasurementSettings.labels.minSegmentLength;
                minSegmentValue.textContent = MeasurementSettings.labels.minSegmentLength;
            }
            
            // Etiket boyutu
            const labelSize = document.getElementById('labelSize');
            const labelSizeValue = document.getElementById('labelSizeValue');
            if (labelSize && labelSizeValue) {
                labelSize.value = MeasurementSettings.labels.size;
                labelSizeValue.textContent = MeasurementSettings.labels.size + 'px';
            }
            
            // Arka plan göster
            const labelBg = document.getElementById('labelBackground');
            if (labelBg) {
                labelBg.checked = MeasurementSettings.labels.showBackground;
            }
            
            // Etiket rengi
            const labelColor = document.getElementById('labelColor');
            if (labelColor) {
                labelColor.value = MeasurementSettings.labels.color;
            }
            
            // Arka plan rengi
            const labelBgColor = document.getElementById('labelBackgroundColor');
            if (labelBgColor) {
                labelBgColor.value = MeasurementSettings.labels.backgroundColor;
            }
            
            // Mesafe birimi
            const distanceUnit = document.getElementById('distanceUnit');
            if (distanceUnit) {
                distanceUnit.value = MeasurementSettings.distance.unit;
            }
            
            // Alan birimi
            const areaUnit = document.getElementById('areaUnit');
            if (areaUnit) {
                areaUnit.value = MeasurementSettings.area.unit;
            }
            
            // Anlık güncelleme
            const liveUpdate = document.getElementById('liveUpdate');
            if (liveUpdate) {
                liveUpdate.checked = MeasurementSettings.general.liveUpdate;
            }
            
            // Toplam mesafe göster
            const showTotal = document.getElementById('showTotal');
            if (showTotal) {
                showTotal.checked = MeasurementSettings.distance.showTotal;
            }
            
            // Kısmi mesafeler göster
            const showPartial = document.getElementById('showPartial');
            if (showPartial) {
                showPartial.checked = MeasurementSettings.distance.showPartial;
            }
        }
        
        // Ölçüm ayarlarını güncelle
        function updateMeasurementSettings() {
            // Mesafe etiket pozisyonu
            const distancePosSelect = document.getElementById('distanceLabelPosition');
            if (distancePosSelect) {
                MeasurementSettings.distance.labelPosition = distancePosSelect.value;
            }
            
            // Alan etiket pozisyonu
            const areaPosSelect = document.getElementById('areaLabelPosition');
            if (areaPosSelect) {
                MeasurementSettings.area.labelPosition = areaPosSelect.value;
            }
            
            // Segment sıklığı
            const segmentFreq = document.getElementById('segmentLabelFrequency');
            const segmentFreqValue = document.getElementById('segmentFrequencyValue');
            if (segmentFreq && segmentFreqValue) {
                MeasurementSettings.labels.frequency = parseInt(segmentFreq.value);
                segmentFreqValue.textContent = segmentFreq.value;
            }
            
            // Minimum segment uzunluğu
            const minSegment = document.getElementById('minSegmentLength');
            const minSegmentValue = document.getElementById('minSegmentValue');
            if (minSegment && minSegmentValue) {
                MeasurementSettings.labels.minSegmentLength = parseInt(minSegment.value);
                minSegmentValue.textContent = minSegment.value;
            }
            
            // Etiket boyutu
            const labelSize = document.getElementById('labelSize');
            const labelSizeValue = document.getElementById('labelSizeValue');
            if (labelSize && labelSizeValue) {
                MeasurementSettings.labels.size = parseInt(labelSize.value);
                labelSizeValue.textContent = labelSize.value + 'px';
            }
            
            // Arka plan göster
            const labelBg = document.getElementById('labelBackground');
            if (labelBg) {
                MeasurementSettings.labels.showBackground = labelBg.checked;
            }
            
            // Etiket rengi
            const labelColor = document.getElementById('labelColor');
            if (labelColor) {
                MeasurementSettings.labels.color = labelColor.value;
            }
            
            // Arka plan rengi
            const labelBgColor = document.getElementById('labelBackgroundColor');
            if (labelBgColor) {
                MeasurementSettings.labels.backgroundColor = labelBgColor.value;
            }
            
            // Mesafe birimi
            const distanceUnit = document.getElementById('distanceUnit');
            if (distanceUnit) {
                MeasurementSettings.distance.unit = distanceUnit.value;
            }
            
            // Alan birimi
            const areaUnit = document.getElementById('areaUnit');
            if (areaUnit) {
                MeasurementSettings.area.unit = areaUnit.value;
            }
            
            // Anlık güncelleme
            const liveUpdate = document.getElementById('liveUpdate');
            if (liveUpdate) {
                MeasurementSettings.general.liveUpdate = liveUpdate.checked;
            }
            
            // Toplam mesafe göster
            const showTotal = document.getElementById('showTotal');
            if (showTotal) {
                MeasurementSettings.distance.showTotal = showTotal.checked;
            }
            
            // Kısmi mesafeler göster
            const showPartial = document.getElementById('showPartial');
            if (showPartial) {
                MeasurementSettings.distance.showPartial = showPartial.checked;
            }
            
            // Eğer aktif bir ölçüm varsa yeniden çiz
            if (measurementTool && measurementTool.isActive) {
                if (measurementTool.currentTool === 'distance' && measurementTool.currentPoints.length >= 2) {
                    measurementTool.updateDistanceMeasurement();
                } else if (measurementTool.currentTool === 'area' && measurementTool.currentPoints.length >= 3) {
                    measurementTool.updateAreaMeasurement();
                }
                showNotification('Ölçüm etiketleri güncellendi', 'info');
            }
        }
        
        // Varsayılan ayarlara döndür
        function resetMeasurementSettings() {
            // Varsayılan değerleri ayarla
            MeasurementSettings.distance.labelPosition = 'center';
            MeasurementSettings.distance.showTotal = true;
            MeasurementSettings.distance.showPartial = false;
            MeasurementSettings.distance.unit = 'auto';
            
            MeasurementSettings.area.labelPosition = 'center';
            MeasurementSettings.area.unit = 'auto';
            
            MeasurementSettings.labels.size = 12;
            MeasurementSettings.labels.color = '#ffffff';
            MeasurementSettings.labels.backgroundColor = '#000000';
            MeasurementSettings.labels.showBackground = true;
            MeasurementSettings.labels.frequency = 3;
            MeasurementSettings.labels.minSegmentLength = 100;
            
            MeasurementSettings.general.liveUpdate = true;
            
            // Modal'ı güncelle
            loadMeasurementSettingsToModal();
            
            // Aktif ölçümü güncelle
            updateMeasurementSettings();
            
            showNotification('Ayarlar varsayılan değerlere döndürüldü', 'success');
        }

        // Modal kapama - ESC tuşu
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const measurementModal = document.getElementById('measurementSettingsModal');
                if (measurementModal && measurementModal.style.display === 'block') {
                    closeMeasurementSettings();
                }
            }
        });

        // Modal dışına tıklama ile kapama
        document.addEventListener('click', function(e) {
            const measurementModal = document.getElementById('measurementSettingsModal');
            if (measurementModal && e.target === measurementModal) {
                closeMeasurementSettings();
            }
        });
        
    </script>
</body>
</html>
